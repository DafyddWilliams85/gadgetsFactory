[{"id":"a2b40f09.d18fd8","type":"tab","label":"SystemFlows / cron jobs","disabled":false,"info":""},{"id":"508957a1.dd5398","type":"tab","label":"Local app API","disabled":true,"info":""},{"id":"22428f45.8ab","type":"tab","label":"API","disabled":false,"info":""},{"id":"aec22158.fe4e38","type":"tab","label":"User oAuth flows","disabled":false,"info":""},{"id":"2294209a.0c95b","type":"tab","label":"users","disabled":false,"info":""},{"id":"e5822137.be45d","type":"tab","label":"Organization","disabled":false,"info":""},{"id":"d8703926.e2eca","type":"tab","label":"Generic","disabled":false,"info":""},{"id":"9921cbf1.f82328","type":"tab","label":"A-Z gadgets","disabled":false,"info":""},{"id":"45759581.11da84","type":"subflow","name":"Topbar","info":"","category":"","in":[{"x":1520,"y":1620,"wires":[{"id":"704d4000.20aee"}]}],"out":[{"x":1800,"y":1620,"wires":[{"id":"704d4000.20aee","port":0}]}],"env":[]},{"id":"39834eee.0dd5a2","type":"subflow","name":"Flow session mgt ","info":"","category":"System flows","in":[{"x":20,"y":80,"wires":[{"id":"a16ff674.24bb78"}]}],"out":[{"x":280,"y":80,"wires":[{"id":"a16ff674.24bb78","port":0}]}],"env":[],"color":"#DDAA99"},{"id":"5e9b9c1d.bbe4a4","type":"subflow","name":"Redirect","info":"","category":"System flows","in":[{"x":340,"y":260,"wires":[{"id":"c84e6b09.3e90f8"}]}],"out":[],"env":[],"color":"#DDAA99"},{"id":"a55f7aee.572be","type":"subflow","name":"Prepair flow","info":"","category":"System flows","in":[{"x":40,"y":80,"wires":[{"id":"2927f5ef.05639a"}]}],"out":[{"x":540,"y":80,"wires":[{"id":"4e19b9ea.51eff8","port":0}]},{"x":540,"y":140,"wires":[{"id":"4e19b9ea.51eff8","port":1}]},{"x":560,"y":200,"wires":[{"id":"4e19b9ea.51eff8","port":2}]}],"env":[]},{"id":"152aab03.7a806d","type":"subflow","name":"menu call","info":"","category":"System flows","in":[{"x":320,"y":380,"wires":[{"id":"b4440fc5.ad787"}]}],"out":[{"x":1060,"y":520,"wires":[{"id":"f4360e46.6f855","port":2}]}],"env":[]},{"id":"3170c4ab.fadb9c","type":"subflow","name":"Form call","info":"","category":"System flows","in":[{"x":420,"y":260,"wires":[{"id":"301d64c9.14362c"}]}],"out":[{"x":1140,"y":360,"wires":[{"id":"3ca50242.9fc416","port":1}]}],"env":[]},{"id":"4cbbc60.828563c","type":"subflow","name":"Global context","info":"","category":"System flows","in":[{"x":220,"y":140,"wires":[{"id":"ce4931e.2eadfd"},{"id":"4468c444.53ac84"}]}],"out":[],"env":[],"color":"#DDAA99"},{"id":"e25f5e2d.45871","type":"subflow","name":"Generate response Object","info":"","category":"System flows","in":[{"x":160,"y":840,"wires":[{"id":"e0bfa97f.699338"}]}],"out":[{"x":1160,"y":680,"wires":[{"id":"ef1059a8.d05948","port":0}]}],"env":[],"color":"#DDAA99"},{"id":"2ef93158.ae5276","type":"subflow","name":"TB design","info":"","category":"System flows","in":[{"x":-20,"y":80,"wires":[{"id":"2780dc99.05adfc"}]}],"out":[{"x":400,"y":80,"wires":[{"id":"2780dc99.05adfc","port":0}]}],"env":[]},{"id":"19457c3b.7f3ba4","type":"subflow","name":"Generic breadcrumb post","info":"","category":"","in":[{"x":-20,"y":80,"wires":[{"id":"75a214b5.1247dc"}]}],"out":[],"env":[],"color":"#DDAA99"},{"id":"73dff3ad.4e7f84","type":"subflow","name":"convert IDs","info":"","category":"","in":[{"x":40,"y":80,"wires":[{"id":"820eb5ef.100fd8"}]}],"out":[{"x":340,"y":80,"wires":[{"id":"820eb5ef.100fd8","port":0}]}],"env":[],"color":"#DDAA99"},{"id":"5c6b8786.2f63d","type":"subflow","name":"Init org level","info":"","category":"","in":[{"x":40,"y":80,"wires":[{"id":"c456991.34d5368"}]}],"out":[{"x":340,"y":80,"wires":[{"id":"c456991.34d5368","port":0}]}],"env":[],"color":"#DDAA99"},{"id":"8db3b81a.693fd","type":"subflow","name":"BreadCrumbsAction","info":"","category":"","in":[{"x":0,"y":80,"wires":[{"id":"e4b702f8.2026a"}]}],"out":[{"x":460,"y":40,"wires":[{"id":"e4b702f8.2026a","port":0}]},{"x":640,"y":180,"wires":[{"id":"f2f17cd0.7f59a8","port":0},{"id":"e4b702f8.2026a","port":2}]}],"env":[],"color":"#DDAA99"},{"id":"53926ffd.c5a74","type":"subflow","name":"Validate token","info":"","category":"","in":[{"x":60,"y":80,"wires":[{"id":"3eaaac4f.be9de4"}]}],"out":[{"x":340,"y":80,"wires":[{"id":"3eaaac4f.be9de4","port":0}]}],"env":[],"color":"#DDAA99"},{"id":"8e853889.7b4f78","type":"subflow","name":"prepair redirect","info":"","category":"","in":[{"x":40,"y":80,"wires":[{"id":"2968cd86.c7a2e2"}]}],"out":[{"x":360,"y":80,"wires":[{"id":"2968cd86.c7a2e2","port":0}]}],"env":[],"color":"#DDAA99"},{"id":"d237f7f5.48aae8","type":"subflow","name":"Google Translate","info":"Pre conditions:\n\nmsg.payload ={\n    data : [], // REQUIRED ARRAY of objects with the to be translated data \n    translateVar: 'label', //REQUIRED  STRING the translateVar KEY on the data \n    translateDestinationVar: 'label', //REQUIRED STRING the translateVar KEY on the data object\n    languageSource: 'en' // STRING the language of the souce value, (default = 'en')\n    languageDestination: 'nl', // REQUIRED STRING the language that is to be translated to\n    \n}\n","category":"","in":[{"x":40,"y":100,"wires":[{"id":"4d81e47d.d8780c"}]}],"out":[{"x":600,"y":80,"wires":[{"id":"7a7fc4.02c9e03c","port":0}]}],"env":[],"color":"#DDAA99"},{"id":"ab79407.ded3ec","type":"subflow","name":"Logout user","info":"","category":"","in":[{"x":20,"y":80,"wires":[{"id":"cc51476b.f74068"}]}],"out":[],"env":[],"color":"#DDAA99"},{"id":"be61da9a.8b3cd8","type":"subflow","name":"Error handeling","info":"","category":"System flows","in":[{"x":140,"y":180,"wires":[{"id":"dd5ad5f8.cf8828"}]}],"out":[{"x":580,"y":180,"wires":[{"id":"c2d92f7a.f4f5e","port":0},{"id":"e3d59bbe.0b2068","port":0}]}],"env":[],"color":"#DDAA99"},{"id":"594fbb51.16039c","type":"catch","z":"e5822137.be45d","name":"","scope":null,"x":60,"y":160,"wires":[["ae14566f.c06d9"]]},{"id":"ae14566f.c06d9","type":"debug","z":"e5822137.be45d","name":"ERROR","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"true","targetType":"full","x":178.33332443237305,"y":159.99999618530273,"wires":[]},{"id":"90b9b2bb.71e9","type":"catch","z":"aec22158.fe4e38","name":"","scope":null,"x":60,"y":20,"wires":[["968e2324.e80b"]]},{"id":"968e2324.e80b","type":"debug","z":"aec22158.fe4e38","name":"ERROR","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"true","targetType":"full","x":160,"y":20,"wires":[]},{"id":"a86d336c.1e032","type":"comment","z":"aec22158.fe4e38","name":"User authentication","info":"","x":90,"y":153.99999618530273,"wires":[]},{"id":"bc6ac440.7a7d78","type":"comment","z":"aec22158.fe4e38","name":"User authentication gagdet actions","info":"","x":1155,"y":219.99999618530273,"wires":[]},{"id":"d92220ce.df2c7","type":"comment","z":"aec22158.fe4e38","name":"User authentication gadgets","info":"","x":781.166748046875,"y":212.49999618530273,"wires":[]},{"id":"3fb52bc8.66088c","type":"debug","z":"aec22158.fe4e38","name":"debug - User authentication INIT","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":395,"y":339.99999618530273,"wires":[]},{"id":"ffb8ad05.fe04","type":"link in","z":"aec22158.fe4e38","name":"UserAuthentication INIT","links":["ad478a5b.bb35a","a46d6d89.0ff6a8","e130563c.567048"],"x":250,"y":379.99999618530273,"wires":[["3fb52bc8.66088c","e80a67d5.4cc398"]]},{"id":"dd911c3e.69ac98","type":"comment","z":"aec22158.fe4e38","name":"User account activation","info":"","x":95,"y":719.9999961853027,"wires":[]},{"id":"603f053d.277bd4","type":"comment","z":"aec22158.fe4e38","name":"User account activation gagdet actions","info":"","x":2385,"y":799.9999961853027,"wires":[]},{"id":"9fde6397.653cf8","type":"comment","z":"aec22158.fe4e38","name":"User account activation gadgets","info":"","x":1365,"y":799.9999961853027,"wires":[]},{"id":"dd631978.387b18","type":"debug","z":"aec22158.fe4e38","name":"debug - User account activation INIT","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":345,"y":919.9999961853027,"wires":[]},{"id":"f08a12de.bf0fd","type":"link in","z":"aec22158.fe4e38","name":"UserAccountActivation INIT","links":["75463c50.ea35e4","9b9de128.140c3","6537bec2.9226e8"],"x":130,"y":979.9999961853027,"wires":[["dd631978.387b18","cb573448.22b968"]]},{"id":"4f5a2540.8fc0c4","type":"debug","z":"aec22158.fe4e38","name":"debug - User account activation Gadget Post","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"RevotioData.PostData","targetType":"msg","x":2635,"y":899.9999961853027,"wires":[]},{"id":"cb573448.22b968","type":"link out","z":"aec22158.fe4e38","name":"","links":["28fbb602.bac6a2"],"x":548.5000076293945,"y":978.0000095367432,"wires":[]},{"id":"986822a8.580788","type":"comment","z":"aec22158.fe4e38","name":"two step authentication","info":"","x":100,"y":1177.9999961853027,"wires":[]},{"id":"f23132e9.5e6e58","type":"comment","z":"aec22158.fe4e38","name":"two step authentication gagdet actions","info":"","x":2085,"y":1279.9999961853027,"wires":[]},{"id":"ac4fc122.89ea9","type":"comment","z":"aec22158.fe4e38","name":"two step authentication gadgets","info":"","x":1085,"y":1239.9999961853027,"wires":[]},{"id":"4ddc1f0b.3d3f68","type":"function","z":"aec22158.fe4e38","name":"Trigger email","func":"\nvar emailTemplate = '<!DOCTYPE html PUBLIC \"-//W3C//DTD XHTML 1.0 Transitional//EN\" \"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd\"> <html xmlns=\"http://www.w3.org/1999/xhtml\"> <head> <meta name=\"viewport\" content=\"width=device-width\"/> <meta http-equiv=\"Content-Type\" content=\"text/html; charset=UTF-8\"/> <title>Academic Projects User invitation</title> <style type=\"text/css\"> *{margin:0; padding:0;}*{font-family: Roboto-Regular,Helvetica,Arial,sans-serif;}body{-webkit-font-smoothing:antialiased; -webkit-text-size-adjust:none; width: 100%!important; height: 100%;}a{color: #2BA6CB;}. btn{text-decoration:none; color: #FFF; background-color: #1991EB; margin-top: 5px; padding:10px 16px; font-weight:bold; margin-right:10px; text-align:center; cursor:pointer; display: inline-block; border-radius: 2px;}table.body- wrap{width: 100%;}h2{font-size: 24px; line-height: 28px; margin-bottom:15px; color:#000;}h2 small{color: #6f6f6f; text-transform:none; font-size: 20px;}p{margin-bottom: 10px; font-weight: normal; font-size:14px; line-height:1.4;}p small{font-size: 13px; line-height: 24px;}p.lead{font-size:17px;}. container{display:block!important; max-width:600px!important; margin:0 auto!important; clear:both!important;}.content{padding: 35px 20px; max-width:600px; margin:0 auto; display:block;}.content table{width: 100%;}@media only creen and (max-width: 600px){a[class=\"btn\"]{display:block!important; margin-bottom:10px!important; background-image:none!important; margin-right:0!important;}}</style> </head> <body bgcolor=\"#FFFFFF\"> <table class=\"body-wrap\"> <tr> <td></td><td class=\"container\" bgcolor=\"#FFFFFF\"> <div class=\"content\"> <table> <tr> <td> <h2><small>Hi,</small> msg.payload.firstname msg.payload.lastname </h2> <br/> <p class=\"lead\">Welcome to the project management application for the University of Leiden!</p><br/> <p class=\"lead\">Cheerfully yours,<br/>Team Academic projects.</p><br/> <p><small>You can activate your account by clicking on this link:</small></p><a class=\"btn\" href=\" currentDomain /api/app/#/confirmation?activate=msg.payload.user_id \">Click Me to Activate!</a> <br/> <br/> </td></tr></table> </div></td><td></td></tr></table> </body> </html>';\n\nmsg.payload = {\n                   \"apiKey\": global.get(\"mailgun.apiKey\"),\n                   \"domain\":global.get(\"mailgun.domain\"), \n                   \"emailHeaders\":{\n                      \"from\":global.get(\"mailgun.from\"),\n                      \"to\":msg.RevotioData.session.userData.email,\n                      \"subject\":\"Two step authentication\",\n                      \"body\":\"\",\n                   },\n                   \"emailData\":{\n                      \"optional key-one\":\"some value\",\n                      \"optional key-two\":\"some other value !!!\"\n                   },\n                   \"emailTemplate\":\"Hi \" + msg.RevotioData.session.userData.firstname +  \", please enter this token : \" + msg.RevotioData.FlowData.Token + \" into the app. Thanks!!!\"\n                };\n                \n                \n              \n                \n                \nreturn msg;","outputs":1,"noerr":0,"x":1190,"y":1320,"wires":[[]]},{"id":"8eda4890.cca5e8","type":"catch","z":"d8703926.e2eca","name":"","scope":null,"x":118.75,"y":33.75,"wires":[["b2e8d966.2f42b"]]},{"id":"b2e8d966.2f42b","type":"debug","z":"d8703926.e2eca","name":"ERROR","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"true","targetType":"full","x":260,"y":40,"wires":[]},{"id":"3ab682ae.10e656","type":"link in","z":"aec22158.fe4e38","name":"UserAuthentication ACTION","links":["88cb22fd.2938c","6dbb7fd6.2f51d","82e73790.6bba78"],"x":1070,"y":299.99999618530273,"wires":[["cde0b321.b9d5c","aed8c006.3bdf3"]]},{"id":"579313d7.2430dc","type":"link in","z":"aec22158.fe4e38","name":"UserAccountActivation ACTION","links":["28cd6ef4.fc46fa","60f9add0.f0070c","e8682458.5b8fb"],"x":2370,"y":859.9999961853027,"wires":[["4f5a2540.8fc0c4","a6610d0a.93f8e"]]},{"id":"a06272bd.e32538","type":"comment","z":"aec22158.fe4e38","name":"***************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************","info":"","x":2425,"y":759.9999961853027,"wires":[]},{"id":"be1f9240.8525","type":"comment","z":"aec22158.fe4e38","name":"***************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************","info":"","x":2430,"y":1207.9999961853027,"wires":[]},{"id":"fb87369c.23e","type":"comment","z":"aec22158.fe4e38","name":"***************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************","info":"","x":2430,"y":180,"wires":[]},{"id":"cd8c7f3.154188","type":"link out","z":"aec22158.fe4e38","name":"","links":["fdeb0a33.b80658","ac130025.b78d4","8f317f74.8f0218","7063f25b.94df04"],"x":490,"y":379.99999618530273,"wires":[]},{"id":"fdeb0a33.b80658","type":"link in","z":"aec22158.fe4e38","name":"user authentication - Custom login form Gadget","links":["cd8c7f3.154188"],"x":650,"y":259.99999618530273,"wires":[["f6cfd796.ef5268"]]},{"id":"f6cfd796.ef5268","type":"function","z":"aec22158.fe4e38","name":"Login user Form","func":"\n    \ngadgetsList =[{\n            \"gadgetId\":  \"349a509d-e145-33a6-7888-e8906915b223\",\n            \"gadgetName\":  \"Login form\",\n            \"gadgetType\": \"custom-form\",\n            \"gadgetData\": {\n      id: 'Login',\n      canceled: false, // false\n      submitButtonText: 'Login',\n    //   prevButtonText: 'Previous',\n      nextButtonText: 'Next',\n      showPrevious: false, //false\n      title: 'Login',\n      steps: [\n        {\n          title: '',\n          subtitle: '',\n          fields: [\n              {\n              name: 'username',\n              htmlTag: 'input',  // button | select | textarea\n              options: {\n                value: '',\n                label: 'Email address',\n                placeholder: 'John',\n                type: 'email', // default: text | button | checkbox | date | email | number | password | radio | submit\n                required: true // false by default\n              }\n            },\n              {\n              name: 'password',\n              htmlTag: 'input',  // button | select | textarea\n              options: {\n                value: '',\n                label: 'Password',\n                type: 'password', // default: text | button | checkbox | date | email | number | password | radio | submit\n                placeholder: '',\n                required: true, // false by default\n                maxlength: 50\n              }\n            },\n        //  {\n        //               name: 'twostep',\n        //               htmlTag: 'input',  // button | select | textarea\n        //               options: {\n        //                 value: 'yes',\n        //                 label: 'twostep',\n        //                 type: 'text', // default: text | button | checkbox | date | email | number | password | radio | submit\n        //                 placeholder: '',\n        //                 required: true, // false by default\n        //                 maxlength: 50\n        //               }\n        //             },\n\n        ]}\n      ]\n    }},\n    // {\n    //         \"gadgetId\":  \"e54b2885-1a8e-3e58-0314-c2a388e2b8bc\",\n    //         \"gadgetName\": \"dashboard - involvement\",\n    //         \"gadgetType\": \"dynamic-modal\",\n    //         \"gadgetData\": {\"modalStatus\":'show'}}\n            ]\n\nmsg.payload = {gadgetsList:gadgetsList};\n\n\nreturn msg;","outputs":1,"noerr":0,"x":735,"y":259.99999618530273,"wires":[["ad59d764.8f538"]]},{"id":"cde0b321.b9d5c","type":"debug","z":"aec22158.fe4e38","name":"debug - User authentication Gagdet Post","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1475,"y":399.99999618530273,"wires":[]},{"id":"ad59d764.8f538","type":"link out","z":"aec22158.fe4e38","name":"","links":["1766e26.2df601e","15f8aeef.16f7d1","ec6395bb.05eb08","6510415f.c64d6","14c789ed.fd90f6","172bf3ee.b9865c","e6548cdd.b0501","43e1a714.c877a8","228b07a6.f5d6a8","101c6a60.58ca1e","b0f61403.73aa18","d6cfe34e.7be1d","2f3e87cf.a0111","5171869d.c0b8a8","ffc46262.694388","3356ae90.b06682","1f447df2.f79d1a","84cfac4f.42a868","3a82fd2b.90627a","4809e15c.231538","4675a1ec.757c6","82336b76.b7c958","b824f5cf.104838","6a1ab5fc.dff14c","692c6501.32656c","14264b85.6baf9c","e358d072.f3562","6cc00ce9.6960a4"],"x":830,"y":259.99999618530273,"wires":[]},{"id":"aed8c006.3bdf3","type":"function","z":"aec22158.fe4e38","name":"Route POST ","func":"// Get libraries\nvar moment = global.get('moment');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\n\n\n// delair output var's\nvar  Menu , LoginForm,ResetPassword ;\nvar PostData    = msg.RevotioData.PostData;\nvar Page        = msg.RevotioData.session.Page;\n\n\n// Check if it is a Gadget action\nif ( PostData.hasOwnProperty('gadgetType')) {\n        // Check if it was a menu action\n\n        if (PostData.gadgetType === \"Menu\") {\n            Menu = msg;\n        }\n\n         else if (PostData.gadgetName === \"Login form\"){\n            LoginForm = msg;\n        }\n  \n     else if (PostData.gadgetName === \"reset password\"){\n            ResetPassword = msg;\n        }\n}\n\n\nreturn [ Menu, LoginForm, ResetPassword ];","outputs":3,"noerr":0,"x":1145,"y":299.99999618530273,"wires":[["a4311a51.a3b6d"],["2fafffb5.4b7cf8"],["e9d1128b.31c918"]],"outputLabels":["Menu","LoginForm","ResetPassword"]},{"id":"a4311a51.a3b6d","type":"link out","z":"aec22158.fe4e38","name":"","links":["8e48eec2.dcffb","47fe9e1a.f0bb9","f1a071ae.735c6","cd80bf04.26b1c","14418773.9dfa29"],"x":1270,"y":259.99999618530273,"wires":[]},{"id":"fa86daf5.84f458","type":"comment","z":"aec22158.fe4e38","name":"Menu","info":"","x":1350,"y":220,"wires":[]},{"id":"2fafffb5.4b7cf8","type":"function","z":"aec22158.fe4e38","name":"check if user exists","func":"// Get libraries\nconst Moment = global.get('moment');\nconst MomentRange = global.get('momentrange');\nconst moment = MomentRange.extendMoment(Moment)\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting'); \nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\n\nif (msg.RevotioData.PostData.gadgetData.formData.hasOwnProperty('username')){\n    msg.RevotioData.PostData.gadgetData.formData.username = msg.RevotioData.PostData.gadgetData.formData.username.toLowerCase()\n}\n\naggregateObj = {\n       query: { query : [ { \n            \"$match\" : {\n                username : msg.RevotioData.PostData.gadgetData.formData.username\n            }\n        }, \n        { \n            \"$lookup\" : {\n                \"from\" : \"user_accounts\", \n                \"localField\" : \"_id\", \n                \"foreignField\" : \"user\", \n                \"as\" : \"UserAccountData\"\n            }\n        }, \n        \n        \n         {    $lookup: {\n            from: \"user_permissions\",\n            localField: \"_id\",\n            foreignField: \"user\",\n            as: \"AppUserPermissionInfo\"\n        }},\n                ],},\n        connection:global.get(\"DB_data.connection\"),\n        database:global.get(\"DB_data.appDB\"),\n        collection:'users',\n        operation:'aggregate',\n        }\n        \nmongodbTools.resolveAsync(aggregateObj, node, function(res){\n        msg.payload = res\n        node.send(msg) \n}) \n            \n            \n// msg.payload =  [\n       \n//         //   { \n//         //     \"$unwind\" : {\n//         //         \"path\" : \"$UserAccountData\", \n//         //         \"preserveNullAndEmptyArrays\" : false\n//         //     }\n//         // },    \n\n//     ]; \n\n\n// msg.operation = 'aggregate.toArray';\n\n\n\n\n\n// return msg;\n\n\n\n","outputs":1,"noerr":0,"x":1405,"y":319.99999618530273,"wires":[["d99c562c.a79378"]]},{"id":"d99c562c.a79378","type":"function","z":"aec22158.fe4e38","name":"Check if user exists","func":"var NoUser, User;\n// msg.RevotioData.userData = msg.payload[0];\n\n\n\nif (typeof msg.payload[0] === 'object' && msg.payload[0]._id){\n    \n    user_accounts = msg.payload[0].user_accounts\n    payload =   msg.payload[0]\n    \n    payload.user_accounts = user_accounts;\n    \n    msg.payload = payload\n     User = msg;\n}else{\n    NoUser = msg;\n}\n\nreturn [NoUser, User];","outputs":2,"noerr":0,"x":1705,"y":319.99999618530273,"wires":[["19945af0.650975"],["c260b609.a9b02"]],"outputLabels":["NoUser, ","User"]},{"id":"19945af0.650975","type":"function","z":"aec22158.fe4e38","name":"Prepair error response","func":"\nmsg.RevotioData.PostData.gadgetData.formObj.steps[0].fields[0].error =  {\n                                                                    msg: \"user does not exists\"\n                                                                    };\n\nmsg.payload = {\n    \n    gadgetsList : [{\n            \"gadgetId\":  \"349a509d-e145-33a6-7888-e8906915b223\",\n            \"gadgetName\":  \"Login form\",\n            \"gadgetType\": \"custom-form\",\n            \"gadgetData\": msg.RevotioData.PostData.gadgetData.formObj}]\n    };\n\nreturn msg;","outputs":1,"noerr":0,"x":1935,"y":299.99999618530273,"wires":[["237dc0d6.55ce58"]]},{"id":"237dc0d6.55ce58","type":"link out","z":"aec22158.fe4e38","name":"","links":["e158a3eb.e1806","4ac73054.2df2a","1766e26.2df601e","15f8aeef.16f7d1","ec6395bb.05eb08","6510415f.c64d6","14c789ed.fd90f6","172bf3ee.b9865c","e6548cdd.b0501","43e1a714.c877a8","228b07a6.f5d6a8","101c6a60.58ca1e","b0f61403.73aa18","d6cfe34e.7be1d","2f3e87cf.a0111","5171869d.c0b8a8","ffc46262.694388","3356ae90.b06682","1f447df2.f79d1a","84cfac4f.42a868","3a82fd2b.90627a","4809e15c.231538","4675a1ec.757c6","82336b76.b7c958","b824f5cf.104838","6a1ab5fc.dff14c","692c6501.32656c","14264b85.6baf9c","e358d072.f3562","6cc00ce9.6960a4"],"x":2050,"y":299.99999618530273,"wires":[]},{"id":"c260b609.a9b02","type":"function","z":"aec22158.fe4e38","name":"Check if password is correct","func":"// var crypto = require('crypto');\n\nvar invalid, valid;\nvar crypto = global.get('crypto');\nvar password = String(msg.RevotioData.PostData.gadgetData.formData.password)\n\nvar dhash = crypto.pbkdf2Sync(password, msg.payload.salt, 1000, 64, 'sha1').toString('hex');\n\nif(msg.payload.hash === dhash){\n\n   valid = msg;\n}\nelse{\n   invalid =  msg;\n}\n\n\n\nreturn [invalid, valid];","outputs":2,"noerr":0,"x":1955,"y":339.99999618530273,"wires":[["2f69da72.60f79e"],["115dbd4f.d83e53"]],"outputLabels":["invalid, ","valid"]},{"id":"2f69da72.60f79e","type":"function","z":"aec22158.fe4e38","name":"Prepair error response","func":"// Get libraries\nconst Moment = global.get('moment');\nconst MomentRange = global.get('momentrange');\nconst moment = MomentRange.extendMoment(Moment)\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting'); \nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\n\n\n\npayload = msg.payload;\n\nif (payload.hasOwnProperty(\"loginAttempts\") && isNaN(payload.loginAttempts) === false ){\n    payload.loginAttempts = payload.loginAttempts + 1\n} else {\n    payload.loginAttempts =  1\n}\n// payload.loginAttempts = payload.loginAttempts + 1\n\n\nif (payload.loginAttempts  < 4 ){\nmsg.RevotioData.PostData.gadgetData.formObj.steps[0].fields[1].error =  {\n                                                                    msg: \"Incorrect password, you have \" + ( 3 -  payload.loginAttempts ) + \" attempts left\"\n                                                                    };\nmsg.query = [\n    {_id: new ObjectID(payload._id)},\n    {\"$set\": {loginAttempts: payload.loginAttempts},},\n    {upsert: true}\n    ]\n} else {\n  msg.RevotioData.PostData.gadgetData.formObj.steps[0].fields[0].error =  {\n                                                                    msg: \"Incorrect password, this account is blocked, please contact your administrator\"\n                                                                    };\n  msg.query = [\n    {_id: new ObjectID(payload._id)},\n    {\"$set\": {blockAccount:true}},\n    {upsert: true}\n    ]\n}\n\n\n\n\nmsg.payload = {\n    \n    gadgetsList : [{\n            \"gadgetId\": \"349a509d-e145-33a6-7888-e8906915b223\",\n            \"gadgetName\":  \"Login form\",\n            \"gadgetType\": \"custom-form\",\n            \"gadgetData\": msg.RevotioData.PostData.gadgetData.formObj}]\n    };\n    \n    \n\nreturn msg;","outputs":1,"noerr":0,"x":2195,"y":299.99999618530273,"wires":[["6b7d9d4c.4f7de4","ff257da5.7a778"]]},{"id":"6b7d9d4c.4f7de4","type":"link out","z":"aec22158.fe4e38","name":"","links":["e158a3eb.e1806","4ac73054.2df2a","1766e26.2df601e","15f8aeef.16f7d1","ec6395bb.05eb08","6510415f.c64d6","14c789ed.fd90f6","172bf3ee.b9865c","e6548cdd.b0501","43e1a714.c877a8","228b07a6.f5d6a8","101c6a60.58ca1e","b0f61403.73aa18","d6cfe34e.7be1d","2f3e87cf.a0111","5171869d.c0b8a8","ffc46262.694388","3356ae90.b06682","1f447df2.f79d1a","84cfac4f.42a868","3a82fd2b.90627a","4809e15c.231538","4675a1ec.757c6","82336b76.b7c958","b824f5cf.104838","6a1ab5fc.dff14c","692c6501.32656c","14264b85.6baf9c","e358d072.f3562","6cc00ce9.6960a4"],"x":2330,"y":299.99999618530273,"wires":[]},{"id":"e954696c.c9cc1","type":"comment","z":"aec22158.fe4e38","name":"ERROR","info":"","x":1985,"y":259.99999618530273,"wires":[]},{"id":"49ad2fe3.46de68","type":"comment","z":"aec22158.fe4e38","name":"ERROR","info":"","x":2430,"y":280,"wires":[]},{"id":"c8628eb6.6a32a8","type":"function","z":"aec22158.fe4e38","name":"Activate user Form","func":"msg.RevotioData.FlowData.Data.UserData = msg.payload\ngadgetsList =[{\n            \"gadgetId\":  \"2041a5fe-e808-6a23-da7b-5421d34c4bbf\",\n            \"gadgetName\":  \"activate account form\",\n            \"gadgetType\": \"custom-form\",\n            \"gadgetData\": {\n                  id: 'Login',\n                  canceled: true, // false\n                  submitButtonText: 'Submit',\n                  prevButtonText: 'Previous',\n                  nextButtonText: 'Next',\n                  showPrevious: true, //false\n                  title: 'Account activation',\n                  steps: [\n                    {\n                      title: '',\n                      subtitle: '',\n                      fields: [\n                          {\n                          name: 'first_name',\n                          htmlTag: 'input',  // button | select | textarea\n                          options: {\n                            value: msg.RevotioData.FlowData.Data.UserData.first_name,\n                            label: 'First name',\n                            placeholder: '',\n                            type: 'text', // default: text | button | checkbox | date | email | number | password | radio | submit\n                            required: true, // false by default\n                            editable: true\n                          }\n                        },\n                         {\n                          name: 'last_name',\n                          htmlTag: 'input',  // button | select | textarea\n                          options: {\n                            value: msg.RevotioData.FlowData.Data.UserData.last_name,\n                            label: 'Last name',\n                            placeholder: '',\n                            type: 'text', // default: text | button | checkbox | date | email | number | password | radio | submit\n                            required: true, // false by default\n                            editable: true\n                          }\n                        },\n                        {\n                          name: 'username',\n                          htmlTag: 'input',  // button | select | textarea\n                          options: {\n                            value: msg.RevotioData.FlowData.Data.UserData.username,\n                            label: 'User name',\n                            placeholder: '',\n                            type: 'text', // default: text | button | checkbox | date | email | number | password | radio | submit\n                            required: true, // false by default\n                            editable: false\n                          }\n                        },\n                        {\n                          name: 'passwordOne',\n                          htmlTag: 'input',  // button | select | textarea\n                          options: {\n                            value: '',\n                            label: 'Password',\n                            placeholder: '',\n                            type: 'password', // default: text | button | checkbox | date | email | number | password | radio | submit\n                            required: true, // false by default\n                            // editable: false\n                          }\n                        }, \n                        {\n                          name: 'passwordTwo',\n                          htmlTag: 'input',  // button | select | textarea\n                          options: {\n                            value: '',\n                            label: 'Password again',\n                            placeholder: '',\n                            type: 'password', // default: text | button | checkbox | date | email | number | password | radio | submit\n                            required: true, // false by default\n                            // editable: false\n                          }\n                        },\n                        {\n                          name: 'phone_number',\n                          htmlTag: 'input',  // button | select | textarea\n                          options: {\n                            value: '',\n                            label: 'Phone number',\n                            placeholder: '',\n                            type: 'number', // default: text | button | checkbox | date | email | number | password | radio | submit\n                            required: false, // false by default\n                            editable: true\n                          }\n                        },\n                        {\n                          name: 'email',\n                          htmlTag: 'input',  // button | select | textarea\n                          options: {\n                            value: msg.RevotioData.FlowData.Data.UserData.email,\n                            label: 'Email address',\n                            placeholder: '',\n                            type: 'email', // default: text | button | checkbox | date | email | number | password | radio | submit\n                            editable: false // false by default\n                          }\n                        },\n                        {\n                            name: 'avatar',\n                            label: 'Avatar',\n                            htmlTag: 'button',\n                            options: {\n                                type: 'upload',\n                                folder: global.get(\"DomainProperties.filesFolder\")+ \"users/\"+msg.RevotioData.FlowData.Data.UserData._id  ,\n                                classes: 'md-icon-button md-primary',\n                                preview: 'inside', // inside , outside\n                                previewPosition: 'right',\n                                icon: 'fas fa-upload',\n                                // previewUrl: global.get(\"DomainProperties.url\") + msg.RevotioData.FlowData.Data.UserData.avatar,\n                                editable: true\n                            }\n                        },\n                    ]}\n                  ]\n                }},\n            ]\n\nmsg.payload = {gadgetsList:gadgetsList};\n\n\nreturn msg;","outputs":1,"noerr":0,"x":1745,"y":879.9999961853027,"wires":[["22600218.5f17ce"]]},{"id":"28fbb602.bac6a2","type":"link in","z":"aec22158.fe4e38","name":"user account activation form","links":["cb573448.22b968"],"x":910,"y":839.9999961853027,"wires":[["f3baa581.b4119"]]},{"id":"48979864.699d78","type":"function","z":"aec22158.fe4e38","name":"Create error msg","func":"msg.payload = \"Error - token generation issue\"\nreturn msg;","outputs":1,"noerr":0,"x":4525,"y":359.99999618530273,"wires":[["2d570acc.402cee"]]},{"id":"2d570acc.402cee","type":"link out","z":"aec22158.fe4e38","name":"","links":["e158a3eb.e1806","4ac73054.2df2a","1766e26.2df601e","15f8aeef.16f7d1","6510415f.c64d6","14c789ed.fd90f6","172bf3ee.b9865c","e6548cdd.b0501","43e1a714.c877a8","228b07a6.f5d6a8","101c6a60.58ca1e","b0f61403.73aa18","d6cfe34e.7be1d","2f3e87cf.a0111","5171869d.c0b8a8","ffc46262.694388","3356ae90.b06682","1f447df2.f79d1a","84cfac4f.42a868","3a82fd2b.90627a","4809e15c.231538","4675a1ec.757c6","82336b76.b7c958","b824f5cf.104838","6a1ab5fc.dff14c","692c6501.32656c","14264b85.6baf9c","e358d072.f3562","6cc00ce9.6960a4"],"x":4630,"y":359.99999618530273,"wires":[]},{"id":"7d4e09a6.9a835","type":"function","z":"aec22158.fe4e38","name":"Check if BrowserId is present **TwoStep**","func":"var present, notPresent; \n\nif (msg.RevotioData.SessionData.BrowserId && typeof msg.RevotioData.SessionData.BrowserId === 'object'){\n    present = msg;\n} else {\n    notPresent = msg;\n}\n\nreturn [present, notPresent];","outputs":2,"noerr":0,"x":3855,"y":379.99999618530273,"wires":[["124f6b5b.e9925d"],["f2fc87a2.44bf68"]],"outputLabels":["present","notPresent"]},{"id":"5e088157.862158","type":"function","z":"aec22158.fe4e38","name":"Create error msg","func":"msg.payload = \"Error - token generation issue\"\nreturn msg;","outputs":1,"noerr":0,"x":4525,"y":439.99999618530273,"wires":[["4d2f5f49.74d588"]]},{"id":"4d2f5f49.74d588","type":"link out","z":"aec22158.fe4e38","name":"","links":["e158a3eb.e1806","4ac73054.2df2a","1766e26.2df601e","15f8aeef.16f7d1","6510415f.c64d6","14c789ed.fd90f6","172bf3ee.b9865c","e6548cdd.b0501","43e1a714.c877a8","228b07a6.f5d6a8","101c6a60.58ca1e","b0f61403.73aa18","d6cfe34e.7be1d","2f3e87cf.a0111","5171869d.c0b8a8","ffc46262.694388","3356ae90.b06682","1f447df2.f79d1a","84cfac4f.42a868","3a82fd2b.90627a","4809e15c.231538","4675a1ec.757c6","82336b76.b7c958","b824f5cf.104838","6a1ab5fc.dff14c","692c6501.32656c","14264b85.6baf9c","e358d072.f3562","6cc00ce9.6960a4"],"x":4630,"y":439.99999618530273,"wires":[]},{"id":"a27da0ef.7fe0c8","type":"link in","z":"aec22158.fe4e38","name":"two step authentication - INIT","links":["f9c11c94.800ed","aa063ab.0c16648","839b0669.2a35d"],"x":150,"y":1439.9999961853027,"wires":[["ff593a75.391dc8","459f52fa.fc087c"]]},{"id":"e8c424c8.a91d3","type":"link in","z":"aec22158.fe4e38","name":"two step authentication - Action","links":["d366fdbc.eb5658","756461b6.504a38","e84a1d06.e6f258"],"x":1990,"y":1359.9999961853027,"wires":[["b7f1c28a.2b2b2","144a230b.917dfd"]]},{"id":"ff593a75.391dc8","type":"debug","z":"aec22158.fe4e38","name":"debug -two step authentication INIT","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"RevotioData","targetType":"msg","x":345,"y":1399.9999961853027,"wires":[]},{"id":"b7f1c28a.2b2b2","type":"debug","z":"aec22158.fe4e38","name":"debug - INIT two step action","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"RevotioData.PostData","targetType":"msg","x":2095,"y":1319.9999961853027,"wires":[]},{"id":"f2fc87a2.44bf68","type":"function","z":"aec22158.fe4e38","name":"Generate new token && prepair update query","func":"var jsonwebtoken = global.get('jsonwebtoken');\nvar OK, NOK;\n\nif (msg.token !== \"Error\"){\n// create new token string\ntokenString = {\n    hash : msg.payload.hash,\n    user_id :msg.RevotioData.session.UserData._id,\n    deviceId : msg.RevotioData.session.deviceId,\n    key:new ObjectID(),\n    type : \"unauthorized\"}\nmsg.RevotioData.session.token =  jsonwebtoken.sign(tokenString, global.get(\"SystemVars.secret\"))\n\n// msg.RevotioData.session.userData = msg.payload;\n\nmsg.payload = [{\n        deviceId: msg.RevotioData.session.deviceId\n        },\n        {\"$set\": {token: msg.RevotioData.session.token, UserData:  msg.RevotioData.session.UserData }},\n        {upsert:1}]\n\nmsg.operation = \"updateMany\"\nOK = msg;\n}else {\nNOK = msg;\n}\nreturn [OK, NOK];","outputs":2,"noerr":0,"initialize":"","finalize":"","x":4225,"y":399.99999618530273,"wires":[["ab3ed11a.d5793"],["5e088157.862158"]],"outputLabels":["OK","NOK"]},{"id":"124f6b5b.e9925d","type":"function","z":"aec22158.fe4e38","name":"Generate new token && prepair update query","func":"var jsonwebtoken = global.get('jsonwebtoken');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\n\nvar OK, NOK;\n\nif (msg.token !== \"Error\"){\n// create new token string\ntokenString = {\n    BrowserId : msg.RevotioData.SessionData.BrowserId,\n    hash : msg.payload.hash,\n    key:new ObjectID(),\n    user_id :msg.RevotioData.session.UserData._id,\n    deviceId : msg.RevotioData.session.deviceId,\n    type : \"authorized\"}\nmsg.RevotioData.session.token =  jsonwebtoken.sign(tokenString, global.get(\"SystemVars.secret\"))\n\n// msg.RevotioData.session.userData = msg.payload;\n\nmsg.payload = [{\n        deviceId: msg.RevotioData.session.deviceId\n        },\n        {\"$set\": {token: msg.RevotioData.session.token, UserData:  msg.RevotioData.session.UserData }},\n        {upsert:true}]\n\nmsg.operation = \"updateMany\"\nmsg.RevotioData.session.user_id = new ObjectID(msg.RevotioData.session.UserData._id)\nOK = msg;\n}else {\nNOK = msg;\n}\nreturn [OK, NOK];","outputs":2,"noerr":0,"initialize":"","finalize":"","x":4225,"y":359.99999618530273,"wires":[["2df202d2.7f9f2e","2c8a0c62.86d694"],["48979864.699d78"]],"outputLabels":["OK","NOK"]},{"id":"ed52f54.32f3488","type":"function","z":"aec22158.fe4e38","name":"Activate user Form","func":"\n    \ngadgetsList =[{\n            \"gadgetId\":  \"2a6f80a3-790b-cbd6-01cd-ea9bbf222993\",\n            \"gadgetName\":  \"two step authentication form\",\n            \"gadgetType\": \"custom-form\",\n            \"gadgetData\": {\n                  id: 'Login',\n                  canceled: true, // false\n                  submitButtonText: 'Submit',\n                  prevButtonText: 'Previous',\n                  nextButtonText: 'Next',\n                  showPrevious: true, //false\n                  title: 'Two step authentication',\n                  steps: [\n                    {\n                      title: '',\n                      subtitle: '',\n                      fields: [\n                        {\n                          name: 'token',\n                          htmlTag: 'input',  // button | select | textarea\n                          options: {\n                            value:\"\" ,\n                            label: 'Enter token',\n                            placeholder: '',\n                            type: 'text', // default: text | button | checkbox | date | email | number | password | radio | submit\n                            editable: true ,// false by default\n                           required: true\n                            \n                          }\n                        },\n                    ]}\n                  ]\n                }},\n            ]\n\nmsg.payload = {gadgetsList:gadgetsList};\n\n\nreturn msg;","outputs":1,"noerr":0,"x":1125,"y":1279.9999961853027,"wires":[["7bd715c1.48678c"]]},{"id":"61a146dd.2d076","type":"link out","z":"aec22158.fe4e38","name":"TwoStepAuthentication INIT - out","links":["fadf22a9.e1d53","fff10a71.935b1","7335c039.8347a8"],"x":350,"y":1439.9999961853027,"wires":[]},{"id":"fadf22a9.e1d53","type":"link in","z":"aec22158.fe4e38","name":"TwoStepAuthentication form","links":["61a146dd.2d076"],"x":1030,"y":1279.9999961853027,"wires":[["ed52f54.32f3488"]]},{"id":"22600218.5f17ce","type":"link out","z":"aec22158.fe4e38","name":"","links":["1766e26.2df601e","15f8aeef.16f7d1","ec6395bb.05eb08","6510415f.c64d6","14c789ed.fd90f6","172bf3ee.b9865c","e6548cdd.b0501","43e1a714.c877a8","228b07a6.f5d6a8","101c6a60.58ca1e","b0f61403.73aa18","d6cfe34e.7be1d","2f3e87cf.a0111","5171869d.c0b8a8","ffc46262.694388","3356ae90.b06682","1f447df2.f79d1a","84cfac4f.42a868","3a82fd2b.90627a","4809e15c.231538","4675a1ec.757c6","82336b76.b7c958","b824f5cf.104838","6a1ab5fc.dff14c","692c6501.32656c","14264b85.6baf9c","e358d072.f3562","6cc00ce9.6960a4"],"x":1850,"y":879.9999961853027,"wires":[]},{"id":"7bd715c1.48678c","type":"link out","z":"aec22158.fe4e38","name":"","links":["1766e26.2df601e","15f8aeef.16f7d1","6510415f.c64d6","14c789ed.fd90f6","172bf3ee.b9865c","e6548cdd.b0501","43e1a714.c877a8","228b07a6.f5d6a8","101c6a60.58ca1e","b0f61403.73aa18","d6cfe34e.7be1d","2f3e87cf.a0111","5171869d.c0b8a8","ffc46262.694388","3356ae90.b06682","1f447df2.f79d1a","84cfac4f.42a868","3a82fd2b.90627a","4809e15c.231538","4675a1ec.757c6","82336b76.b7c958","b824f5cf.104838","6a1ab5fc.dff14c","692c6501.32656c","14264b85.6baf9c","e358d072.f3562","6cc00ce9.6960a4"],"x":1230,"y":1279.9999961853027,"wires":[]},{"id":"459f52fa.fc087c","type":"function","z":"aec22158.fe4e38","name":"generate first token","func":"var crypto = global.get('crypto');\n\nmsg.RevotioData.FlowData.Token = crypto.randomBytes(10).toString('hex');\nmsg.RevotioData.FlowData.TokenAttempts = 0\nreturn msg;","outputs":1,"noerr":0,"x":245,"y":1439.9999961853027,"wires":[["61a146dd.2d076"]]},{"id":"fff10a71.935b1","type":"link in","z":"aec22158.fe4e38","name":"TwoStepAuthentication Email trigger","links":["61a146dd.2d076"],"x":1030,"y":1319.9999961853027,"wires":[["4d7aeb07.6c37fc"]]},{"id":"144a230b.917dfd","type":"function","z":"aec22158.fe4e38","name":"Route POST ","func":"// Get libraries\nvar moment = global.get('moment');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\n\n\n// delair output var's\nvar  Menu , LoginForm;\nvar PostData    = msg.RevotioData.PostData;\nvar Page        = msg.RevotioData.session.Page;\n\n\n// Check if it is a Gadget action\nif ( PostData.hasOwnProperty('gadgetType')) {\n        // Check if it was a menu action\n\n        if (PostData.gadgetType === \"Menu\") {\n            Menu = msg;\n        }\n\n         else if (PostData.gadgetName === \"two step authentication form\"){\n            LoginForm = msg;\n        }\n  \n}\n\n\nreturn [ Menu, LoginForm ];","outputs":2,"noerr":0,"x":2085,"y":1359.9999961853027,"wires":[["3c2ea246.1ea72e"],["fc29b32.594fc5"]],"outputLabels":["Menu","LoginForm"]},{"id":"3c2ea246.1ea72e","type":"link out","z":"aec22158.fe4e38","name":"","links":["8e48eec2.dcffb","47fe9e1a.f0bb9","f1a071ae.735c6","cd80bf04.26b1c","14418773.9dfa29"],"x":2210,"y":1339.9999961853027,"wires":[]},{"id":"aa56ecbf.9881d","type":"comment","z":"aec22158.fe4e38","name":"Menu","info":"","x":2265,"y":1339.9999961853027,"wires":[]},{"id":"fc29b32.594fc5","type":"function","z":"aec22158.fe4e38","name":"Form post check","func":"var validToken, invalidToken, TokenAttemptsExceeded  ;\n\n// update token attempts\n\nmsg.RevotioData.FlowData.TokenAttempts = msg.RevotioData.FlowData.TokenAttempts + 1;\n\n\n\nif (msg.RevotioData.PostData.gadgetData.formData.token === msg.RevotioData.FlowData.Token ) {\n    validToken = msg;\n} else {\n    \n    if (msg.RevotioData.FlowData.TokenAttempts > 3){\n        TokenAttemptsExceeded = msg;\n    } else {\n        invalidToken = msg;\n    }\n    \n}\nreturn [validToken, invalidToken, TokenAttemptsExceeded ];","outputs":3,"noerr":0,"x":2285,"y":1399.9999961853027,"wires":[["2730383.453ef48"],["7ca740d.fc825c"],[]],"outputLabels":["validToken, ","invalidToken","TokenAttemptsExceeded"]},{"id":"2730383.453ef48","type":"function","z":"aec22158.fe4e38","name":"Generate new token && prepair redirect","func":"var request = global.get('request');\nvar Moment = global.get('moment');\nvar MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar crypto = global.get('crypto');\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\n// create new token string\ntokenString = {\n    hash : msg.RevotioData.session.UserData.hash,\n    user_id : msg.RevotioData.session.UserData._id,\n    deviceId : msg.RevotioData.session.deviceId,\n    key:new ObjectID(),\n    type : \"authorized\"}\nmsg.RevotioData.session.token =  jsonwebtoken.sign(tokenString, global.get(\"SystemVars.secret\"))\n\n msg.payload = {\n        setToken : true,\n    };\n\n    if (msg.RevotioData.UserData.UserAccountData[0].user_type && msg.RevotioData.UserData.UserAccountData[0].user_type === \"Client_User\" ){\n        msg.payload.Page =  global.get(\"DomainProperties.ClientDefaultPage\");\n        msg.payload.RevotioData = {organization_id : new ObjectID(msg.RevotioData.UserData.organization_id)}\n    }else {\n        msg.payload.Page =  global.get(\"DomainProperties.PNODefaultPage\");\n    }\n\n\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":2615,"y":1339.9999961853027,"wires":[["4a4fa343.c95144"]]},{"id":"7ca740d.fc825c","type":"function","z":"aec22158.fe4e38","name":"Prepair error response && gen new token","func":"var crypto = global.get('crypto');\n\n    \n    \nmsg.RevotioData.FlowData.Token = crypto.randomBytes(10).toString('hex');\n\nmsg.RevotioData.PostData.gadgetData.formObj.steps[0].fields[0].error =  {\n                                                                    msg: \"Incorrect token\"\n                                                                    };\nmsg.RevotioData.PostData.gadgetData.formObj.steps[0].fields[0].options.value =    msg.RevotioData.FlowData.Token ;\nmsg.payload = {\n    \n    gadgetsList : [{\n            \"gadgetId\":  \"f858890a-1caf-8900-8279-7add8451c3c7\",\n            \"gadgetName\":  \"Login form\",\n            \"gadgetType\": \"custom-form\",\n            \"gadgetData\": msg.RevotioData.PostData.gadgetData.formObj}]\n    };\n    \n    \n    \n\nreturn msg;","outputs":1,"noerr":0,"x":2615,"y":1419.9999961853027,"wires":[["4f069602.986148","ef7031df.f8f2b"]]},{"id":"4f069602.986148","type":"link out","z":"aec22158.fe4e38","name":"","links":["e158a3eb.e1806","4ac73054.2df2a","1766e26.2df601e","15f8aeef.16f7d1","6510415f.c64d6","14c789ed.fd90f6","172bf3ee.b9865c","e6548cdd.b0501","43e1a714.c877a8","228b07a6.f5d6a8","101c6a60.58ca1e","b0f61403.73aa18","d6cfe34e.7be1d","2f3e87cf.a0111","5171869d.c0b8a8","ffc46262.694388","3356ae90.b06682","1f447df2.f79d1a","84cfac4f.42a868","3a82fd2b.90627a","4809e15c.231538","4675a1ec.757c6","82336b76.b7c958","b824f5cf.104838","6a1ab5fc.dff14c","692c6501.32656c","14264b85.6baf9c","e358d072.f3562","6cc00ce9.6960a4"],"x":2870,"y":1439.9999961853027,"wires":[]},{"id":"3d53ecc3.d23364","type":"comment","z":"aec22158.fe4e38","name":"ERROR","info":"","x":2925,"y":1439.9999961853027,"wires":[]},{"id":"42b3aebc.e049d","type":"function","z":"aec22158.fe4e38","name":"Check if password has correct syntax","func":"// var crypto = require('crypto');\n\nvar invalid, valid;\nvar crypto = global.get('crypto');\n\nvar strongRegex = new RegExp(\"^(?=.*[a-z])(?=.*[A-Z])(?=.*[0-9])(?=.*[!@#\\$%\\^&\\*])(?=.{8,})\");\n\n\n// msg.test = strongRegex.test(msg.RevotioData.PostData.gadgetData.formData.password)\n\n\nif(String(strongRegex.test(msg.RevotioData.PostData.gadgetData.formData.password))){\n\n  valid = msg;\n}\nelse{\n  invalid =  msg;\n}\n\nreturn [invalid, valid];","outputs":2,"noerr":0,"x":3225,"y":899.9999961853027,"wires":[["3314d296.d3a246"],["5a96f6f0.517e4"]],"outputLabels":["invalid, ","valid"]},{"id":"a6610d0a.93f8e","type":"function","z":"aec22158.fe4e38","name":"Route POST ","func":"// Get libraries\nvar moment = global.get('moment');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\n\n\n// delair output var's\nvar  Menu , Form;\nvar PostData    = msg.RevotioData.PostData;\nvar Page        = msg.RevotioData.session.Page;\n\n\n// Check if it is a Gadget action\nif ( PostData.hasOwnProperty('gadgetType')) {\n        // Check if it was a menu action\n\n        if (PostData.gadgetType === \"Menu\") {\n            Menu = msg;\n        }\n\n         else if (PostData.gadgetName === \"activate account form\"){\n            Form = msg;\n        }\n  \n}\n\n\nreturn [ Menu, Form ];","outputs":2,"noerr":0,"x":2525,"y":859.9999961853027,"wires":[["c17c74ab.5523f8"],["30a67121.5f2ade"]],"outputLabels":["Menu","Form"]},{"id":"c17c74ab.5523f8","type":"link out","z":"aec22158.fe4e38","name":"","links":["8e48eec2.dcffb","47fe9e1a.f0bb9","f1a071ae.735c6","cd80bf04.26b1c","14418773.9dfa29"],"x":2710,"y":819.9999961853027,"wires":[]},{"id":"a42d5ed4.a7045","type":"comment","z":"aec22158.fe4e38","name":"Menu","info":"","x":2773.333297729492,"y":818.3333034515381,"wires":[]},{"id":"5a96f6f0.517e4","type":"function","z":"aec22158.fe4e38","name":"finalize user account","func":"var BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar crypto = global.get('crypto');\n\n// var atararchange, NoAvatarChange\nvar hash = crypto.pbkdf2Sync(String(msg.RevotioData.PostData.gadgetData.formData.passwordOne), msg.RevotioData.FlowData.Data.UserData.salt, 1000, 64, 'sha1').toString('hex');\n\nmsg.RevotioData.FlowData.Data.UserData.hash = hash\n\n\nObj = {\n    hash : hash,\n    active : true,\n    activationToken: \"\",\n    first_name: msg.RevotioData.PostData.gadgetData.formData.first_name,\n    last_name: msg.RevotioData.PostData.gadgetData.formData.last_name,\n}\n\nif ( msg.RevotioData.PostData.gadgetData.formData.hasOwnProperty(\"avatar\")){\n  Obj.avatar=  msg.RevotioData.PostData.gadgetData.formData.avatar.path  \n}\n\n\n\nmsg.payload = [{_id: new ObjectID(msg.RevotioData.FlowData.Data.UserData._id)},\n               {\"$set\" : Obj},\n               {upsert:true}\n               \n               ];\nmsg.operation = \"update\"\n\n\nmsg.RevotioData.FlowData.UserObj = Obj\n\nreturn msg;","outputs":1,"noerr":0,"x":3535,"y":919.9999961853027,"wires":[["2329b1df.ff9cde"]],"outputLabels":["invalid, "]},{"id":"3314d296.d3a246","type":"function","z":"aec22158.fe4e38","name":"Prepair error response","func":"\nmsg.RevotioData.PostData.gadgetData.formObj.steps[0].fields[3].error =  {\n                                                                    msg: \"Minimum eight characters, at least one uppercase letter, one lowercase letter, one number and one special character (@$!%*?&)\"\n                                                                    };\n\nmsg.payload = {\n    \n    gadgetsList : [{\n            \"gadgetId\":  \"2041a5fe-e808-6a23-da7b-5421d34c4bbf\",\n            \"gadgetName\":  \"activate account form\",\n            \"gadgetType\": \"custom-form\",\n            \"gadgetData\": msg.RevotioData.PostData.gadgetData.formObj}]\n    };\n\nreturn msg;","outputs":1,"noerr":0,"x":3495,"y":879.9999961853027,"wires":[["fb679d51.f23358"]]},{"id":"fb679d51.f23358","type":"link out","z":"aec22158.fe4e38","name":"","links":["e158a3eb.e1806","4ac73054.2df2a","1766e26.2df601e","15f8aeef.16f7d1","6510415f.c64d6","14c789ed.fd90f6","172bf3ee.b9865c","e6548cdd.b0501","43e1a714.c877a8","228b07a6.f5d6a8","101c6a60.58ca1e","b0f61403.73aa18","d6cfe34e.7be1d","2f3e87cf.a0111","5171869d.c0b8a8","ffc46262.694388","3356ae90.b06682","1f447df2.f79d1a","84cfac4f.42a868","3a82fd2b.90627a","4809e15c.231538","4675a1ec.757c6","82336b76.b7c958","b824f5cf.104838","6a1ab5fc.dff14c","692c6501.32656c","14264b85.6baf9c","e358d072.f3562","6cc00ce9.6960a4"],"x":3630,"y":879.9999961853027,"wires":[]},{"id":"87f911f9.4f5a7","type":"comment","z":"aec22158.fe4e38","name":"ERROR","info":"","x":3685,"y":879.9999961853027,"wires":[]},{"id":"c8100bdd.6522b8","type":"comment","z":"aec22158.fe4e38","name":"Reset password","info":"","x":95,"y":1979.9999961853027,"wires":[]},{"id":"eb91fac0.295fd8","type":"comment","z":"aec22158.fe4e38","name":"Reset password gagdet actions","info":"","x":1945,"y":2039.9999961853027,"wires":[]},{"id":"52faac69.11c514","type":"comment","z":"aec22158.fe4e38","name":"Reset password","info":"","x":95,"y":2039.9999961853027,"wires":[]},{"id":"480f6e06.8ebe5","type":"comment","z":"aec22158.fe4e38","name":"***************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************","info":"","x":2445,"y":2009.9999961853027,"wires":[]},{"id":"201c5cde.9b6f44","type":"comment","z":"aec22158.fe4e38","name":"***************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************","info":"","x":2425,"y":2439.9999961853027,"wires":[]},{"id":"d431a2e4.6d283","type":"link in","z":"aec22158.fe4e38","name":"reset password - INIT","links":["8a3da463.b1e34","7ac9b7b9.35adf8","8b9609e7.cfa4c8"],"x":110,"y":2239.9999961853027,"wires":[["249a8713.6784","5b61eb52.bcc75c"]]},{"id":"249a8713.6784","type":"debug","z":"aec22158.fe4e38","name":"debug - Reset password INIT","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":245,"y":2199.9999961853027,"wires":[]},{"id":"25e60b9d.f35b14","type":"function","z":"aec22158.fe4e38","name":"Get username form","func":"if (msg.RevotioData.FlowData.user){\n    \n   userName = {\n                          name: 'username',\n                          htmlTag: 'input',  // button | select | textarea\n                          options: {\n                            value:msg.payload.username ,\n                            label: 'Email address',\n                            placeholder: '',\n                            type: 'text', // default: text | button | checkbox | date | email | number | password | radio | submit\n                            editable: true ,// false by default\n                           required: true,\n                          disabled : true\n                            \n                          }\n                        };\n    \n} else {\n    userName = {\n                          name: 'username',\n                          htmlTag: 'input',  // button | select | textarea\n                          options: {\n                            value:\"\",\n                            label: 'User name',\n                            placeholder: '',\n                            type: 'text', // default: text | button | checkbox | date | email | number | password | radio | submit\n                            // editable: true ,// false by default\n                           required: true,\n                        //   disabled : true\n                            \n                          }\n                        };\n}\n    \ngadgetsList =[{\n            \"gadgetId\":  \"e947591f-f70b-84c4-c2f7-5a78178ad897\",\n            \"gadgetName\":  \"username\",\n            \"gadgetType\": \"custom-form\",\n            \"gadgetData\": {\n                  id: 'Login',\n                  canceled: false, // false\n                  submitButtonText: 'Submit',\n                  prevButtonText: 'Previous',\n                  nextButtonText: 'Next',\n                  showPrevious: true, //false\n                  title: 'Step 1 password reset',\n                  steps: [\n                    {\n                      title: '',\n                      subtitle: '',\n                      fields: [\n                         userName,\n                    ]}\n                  ]\n                }},\n            ]\n\nmsg.payload = {gadgetsList:gadgetsList};\n\n\nreturn msg;","outputs":1,"noerr":0,"x":670,"y":2260,"wires":[["6b8fb4fa.663c8c"]]},{"id":"6b8fb4fa.663c8c","type":"link out","z":"aec22158.fe4e38","name":"","links":["1766e26.2df601e","15f8aeef.16f7d1","6510415f.c64d6","14c789ed.fd90f6","172bf3ee.b9865c","e6548cdd.b0501","43e1a714.c877a8","228b07a6.f5d6a8","101c6a60.58ca1e","b0f61403.73aa18","d6cfe34e.7be1d","2f3e87cf.a0111","5171869d.c0b8a8","ffc46262.694388","3356ae90.b06682","1f447df2.f79d1a","84cfac4f.42a868","3a82fd2b.90627a","4809e15c.231538","4675a1ec.757c6","82336b76.b7c958","b824f5cf.104838","6a1ab5fc.dff14c","692c6501.32656c","14264b85.6baf9c","e358d072.f3562","6cc00ce9.6960a4"],"x":775,"y":2260,"wires":[]},{"id":"5d5b80cb.b815c","type":"function","z":"aec22158.fe4e38","name":"Reset password BTN","func":"// Admin buttons\n\nmsg.payload = {\n    gadgetsList : [{            \n       \"gadgetId\": \"56c483a5-735e-9f55-c7a6-4a92bd67ebcd\",\n            \"gadgetName\":\"reset password\",\n            \"gadgetType\":\"dynamic-btn\",\n            \"gadgetOptions\":\n                {\"types\":\"\",\n                \"styles\":[\"btn-success\"],\n                \"buttonalign\":\"right\",\n                \"textcolor\":\"black\",\n                \"buttonlabel\":\"Reset password\"},\n                // \"gadgetData\":\"create_project\"\n       \n   }]\n}\n\n\n\n\nreturn msg;","outputs":1,"noerr":0,"x":755,"y":339.99999618530273,"wires":[["ba29073e.8adb"]]},{"id":"ac130025.b78d4","type":"link in","z":"aec22158.fe4e38","name":"user authentication - Custom login form Gadget","links":["cd8c7f3.154188"],"x":650,"y":339.99999618530273,"wires":[["5d5b80cb.b815c"]]},{"id":"ba29073e.8adb","type":"link out","z":"aec22158.fe4e38","name":"","links":["1766e26.2df601e","15f8aeef.16f7d1","6510415f.c64d6","14c789ed.fd90f6","172bf3ee.b9865c","e6548cdd.b0501","43e1a714.c877a8","228b07a6.f5d6a8","101c6a60.58ca1e","b0f61403.73aa18","d6cfe34e.7be1d","2f3e87cf.a0111","5171869d.c0b8a8","ffc46262.694388","3356ae90.b06682","1f447df2.f79d1a","84cfac4f.42a868","3a82fd2b.90627a","4809e15c.231538","4675a1ec.757c6","82336b76.b7c958","b824f5cf.104838","6a1ab5fc.dff14c","692c6501.32656c","14264b85.6baf9c","e358d072.f3562","6cc00ce9.6960a4"],"x":870,"y":339.99999618530273,"wires":[]},{"id":"e9d1128b.31c918","type":"function","z":"aec22158.fe4e38","name":"Redirect to reset password","func":"// Prepair redirect to chosen project\n\n           msg.payload = { \n               Page:'reset password', \n               RevotioData:{\n                   \n               } \n            };\n        \n\n\nreturn msg;","outputs":1,"noerr":0,"x":1435,"y":359.99999618530273,"wires":[["aee578b.d1a4a88"]]},{"id":"e298dd8d.cbd328","type":"link in","z":"aec22158.fe4e38","name":"reset password - Action","links":["d366fdbc.eb5658","a95f9492.bf8098","756461b6.504a38","b0dce74d.09db9","32198700.e5b5b8"],"x":1830,"y":2159.9999961853027,"wires":[["d9bcd251.2ea468","4aa2d425.db2074"]]},{"id":"d9bcd251.2ea468","type":"debug","z":"aec22158.fe4e38","name":"debug - Reset password action","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"RevotioData.PostData","targetType":"msg","x":2000,"y":2081.9999961853027,"wires":[]},{"id":"2e14c717.416758","type":"function","z":"aec22158.fe4e38","name":"Check if password has correct syntax","func":"// var crypto = require('crypto');\n\nvar invalid, valid;\nvar crypto = global.get('crypto');\n// Minimum eight characters, at least one uppercase letter, one lowercase letter, one number and one special character\nvar strongRegex = new RegExp(\"^(?=.*[a-z])(?=.*[A-Z])(?=.*[0-9])(?=.*[!@#\\$%\\^&\\*])(?=.{8,})\");\n\n// msg.test = strongRegex.test(msg.RevotioData.PostData.gadgetData.formData.passwordOne)\n\nif(String(strongRegex.test(msg.RevotioData.PostData.gadgetData.formData.passwordOne))){\n\n\n  valid = msg;\n}\nelse{\n  invalid =  msg;\n}\n\nreturn [invalid, valid];","outputs":2,"noerr":0,"x":2565,"y":2319.9999961853027,"wires":[["d43d088f.c70298"],["86f7d2bb.4375f8"]],"outputLabels":["invalid, ","valid"]},{"id":"4aa2d425.db2074","type":"function","z":"aec22158.fe4e38","name":"Route POST ","func":"// Get libraries\nvar moment = global.get('moment');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\n\n\n// delair output var's\nvar  Menu, UsernameForm,  PasswordForm , CancelReset;\nvar PostData    = msg.RevotioData.PostData;\nvar Page        = msg.RevotioData.session.Page;\n\n\n// Check if it is a Gadget action\nif ( PostData.hasOwnProperty('gadgetType')) {\n        // Check if it was a menu action\n\n        if (PostData.gadgetType === \"Menu\") {\n            Menu = msg;\n        }\n\n         else if (PostData.gadgetName ===  \"Reset password form\"){\n            PasswordForm = msg;\n        }\n         else if (PostData.gadgetName ===   \"username\"){\n            UsernameForm = msg;\n        }\n        else if (PostData.gadgetType ===   \"CancelReset\"){\n            CancelReset = msg;\n        }\n  \n}\n\n\nreturn [ Menu, UsernameForm,  PasswordForm, CancelReset];","outputs":4,"noerr":0,"x":1930,"y":2157.9999961853027,"wires":[["7bc8a353.17418c"],["b3153c28.f9eb78"],["166d34e4.0920ab"],["ba5ecdcd.97009"]],"outputLabels":["Menu","UsernameForm","PasswordForm","CancelReset"]},{"id":"86f7d2bb.4375f8","type":"function","z":"aec22158.fe4e38","name":"finalize user account","func":"var request = global.get('request');\nvar Moment = global.get('moment');var MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar crypto = global.get('crypto');\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\nvar hash = crypto.pbkdf2Sync(String(msg.RevotioData.PostData.gadgetData.formData.passwordOne), msg.RevotioData.FlowData.Data.UserData.salt, 1000, 64, 'sha1').toString('hex');\n\nmsg.payload.hash = hash\n               \n               \n// update    \n    updateObj = {\n                    query : {\n                            query :{_id: new ObjectID(msg.RevotioData.FlowData.Data.UserData._id)}, \n                            update :  {\"$set\" : {\n                                                   hash : hash,\n                                                   resetPassword : false,\n                                                  resetToken: \"\"\n                                               }},\n                            options : {upsert: true}\n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'users',\n                    operation:'update', // updateMany , updateOne\n                    }\n\n            mongodbTools.resolveAsync(updateObj, node, function(res){\n                    msg.result = res\n                     msg.payload = {\n                                    Page :  global.get(\"DomainProperties.NonAuthDefaultPage\"),\n                                    // setToken : true,\n                                    RevotioData: {\n                                    }\n                                };\n                    node.send(msg) \n            })  \n            \n","outputs":1,"noerr":0,"x":2855,"y":2359.9999961853027,"wires":[["74c995c2.07940c"]],"outputLabels":["invalid, "]},{"id":"d43d088f.c70298","type":"function","z":"aec22158.fe4e38","name":"Prepair error response","func":"\nmsg.RevotioData.PostData.gadgetData.formObj.steps[0].fields[1].error =  {\n                                                                    msg: \"Minimum eight characters, at least one uppercase letter, one lowercase letter, one number and one special character (@$!%*?&)\"\n                                                                    };\nmsg.RevotioData.PostData.gadgetData.formObj.steps[0].fields[2].error =  {\n                                                                    msg: \"Minimum eight characters, at least one uppercase letter, one lowercase letter, one number and one special character (@$!%*?&)\"\n                                                                    };\n\nmsg.payload = {\n    \n    gadgetsList : [{\n            \"gadgetId\":  \"e947591f-f70b-84c4-c2f7-5a78178ad897\",\n            \"gadgetName\":  \"Reset password form\",\n            \"gadgetType\": \"custom-form\",\n            \"gadgetData\": msg.RevotioData.PostData.gadgetData.formObj}]\n    };\n\nreturn msg;","outputs":1,"noerr":0,"x":2855,"y":2279.9999961853027,"wires":[["98c425c5.4b0328"]]},{"id":"98c425c5.4b0328","type":"link out","z":"aec22158.fe4e38","name":"","links":["e158a3eb.e1806","4ac73054.2df2a","1766e26.2df601e","15f8aeef.16f7d1","6510415f.c64d6","14c789ed.fd90f6","172bf3ee.b9865c","e6548cdd.b0501","43e1a714.c877a8","228b07a6.f5d6a8","101c6a60.58ca1e","b0f61403.73aa18","d6cfe34e.7be1d","2f3e87cf.a0111","5171869d.c0b8a8","ffc46262.694388","3356ae90.b06682","1f447df2.f79d1a","84cfac4f.42a868","3a82fd2b.90627a","4809e15c.231538","4675a1ec.757c6","82336b76.b7c958","b824f5cf.104838","6a1ab5fc.dff14c","692c6501.32656c","14264b85.6baf9c","e358d072.f3562","6cc00ce9.6960a4"],"x":2970,"y":2279.9999961853027,"wires":[]},{"id":"e585444.02f5db8","type":"comment","z":"aec22158.fe4e38","name":"ERROR","info":"","x":3025,"y":2279.9999961853027,"wires":[]},{"id":"7bc8a353.17418c","type":"link out","z":"aec22158.fe4e38","name":"","links":["8e48eec2.dcffb","47fe9e1a.f0bb9","f1a071ae.735c6","cd80bf04.26b1c","14418773.9dfa29"],"x":2130,"y":2099.9999961853027,"wires":[]},{"id":"e91706b2.256508","type":"comment","z":"aec22158.fe4e38","name":"Menu","info":"","x":2193.333297729492,"y":2098.333303451538,"wires":[]},{"id":"166d34e4.0920ab","type":"function","z":"aec22158.fe4e38","name":"Check if passwords match","func":"var invalid, valid;\n\nif(String(msg.RevotioData.PostData.gadgetData.formData.passwordOne) === String(msg.RevotioData.PostData.gadgetData.formData.passwordTwo)  ){\n\n  valid = msg;\n}\nelse{\n  invalid =  msg;\n}\n\nreturn [invalid, valid];","outputs":2,"noerr":0,"x":2215,"y":2259.9999961853027,"wires":[["343505e.c6a70fa"],["2e14c717.416758"]],"outputLabels":["invalid, ","valid"]},{"id":"343505e.c6a70fa","type":"function","z":"aec22158.fe4e38","name":"Prepair error response","func":"\nmsg.RevotioData.PostData.gadgetData.formObj.steps[0].fields[1].error =  {\n                                                                    msg: \"Passwords dont match\"\n                                                                    };\nmsg.RevotioData.PostData.gadgetData.formObj.steps[0].fields[2].error =  {\n                                                                    msg: \"Passwords dont match\"\n                                                                    };\nmsg.payload = {\n    \n    gadgetsList : [{\n            \"gadgetId\":  \"e947591f-f70b-84c4-c2f7-5a78178ad897\",\n            \"gadgetName\":  \"Reset password form\",\n            \"gadgetType\": \"custom-form\",\n            \"gadgetData\": msg.RevotioData.PostData.gadgetData.formObj}]\n    };\n\nreturn msg;","outputs":1,"noerr":0,"x":2515,"y":2219.9999961853027,"wires":[["7d81d17c.aaecb8"]]},{"id":"7d81d17c.aaecb8","type":"link out","z":"aec22158.fe4e38","name":"","links":["e158a3eb.e1806","4ac73054.2df2a","1766e26.2df601e","15f8aeef.16f7d1","6510415f.c64d6","14c789ed.fd90f6","172bf3ee.b9865c","e6548cdd.b0501","43e1a714.c877a8","228b07a6.f5d6a8","101c6a60.58ca1e","b0f61403.73aa18","d6cfe34e.7be1d","2f3e87cf.a0111","5171869d.c0b8a8","ffc46262.694388","3356ae90.b06682","1f447df2.f79d1a","84cfac4f.42a868","3a82fd2b.90627a","4809e15c.231538","4675a1ec.757c6","82336b76.b7c958","b824f5cf.104838","6a1ab5fc.dff14c","692c6501.32656c","14264b85.6baf9c","e358d072.f3562","6cc00ce9.6960a4"],"x":2630,"y":2219.9999961853027,"wires":[]},{"id":"46b860cf.93db28","type":"comment","z":"aec22158.fe4e38","name":"ERROR","info":"","x":2685,"y":2219.9999961853027,"wires":[]},{"id":"85f2e522.8b14d","type":"function","z":"aec22158.fe4e38","name":"Prepair error response","func":"\nmsg.RevotioData.PostData.gadgetData.formObj.steps[0].fields[0].error =  {\n                                                                    msg: \"User does not exist\"\n                                                                    };\n\nmsg.payload = {\n    \n    gadgetsList : [{\n            \"gadgetId\":  \"e947591f-f70b-84c4-c2f7-5a78178ad897\",\n            \"gadgetName\":  \"username\",\n            \"gadgetType\": \"custom-form\",\n            \"gadgetData\": msg.RevotioData.PostData.gadgetData.formObj}]\n    };\n\nreturn msg;","outputs":1,"noerr":0,"x":2860,"y":2120,"wires":[["a9e514e2.43afa8"]]},{"id":"a9e514e2.43afa8","type":"link out","z":"aec22158.fe4e38","name":"","links":["e158a3eb.e1806","4ac73054.2df2a","1766e26.2df601e","15f8aeef.16f7d1","6510415f.c64d6","14c789ed.fd90f6","172bf3ee.b9865c","e6548cdd.b0501","43e1a714.c877a8","228b07a6.f5d6a8","101c6a60.58ca1e","b0f61403.73aa18","d6cfe34e.7be1d","2f3e87cf.a0111","5171869d.c0b8a8","ffc46262.694388","3356ae90.b06682","1f447df2.f79d1a","84cfac4f.42a868","3a82fd2b.90627a","4809e15c.231538","4675a1ec.757c6","82336b76.b7c958","b824f5cf.104838","6a1ab5fc.dff14c","692c6501.32656c","14264b85.6baf9c","e358d072.f3562","6cc00ce9.6960a4"],"x":2975,"y":2120,"wires":[]},{"id":"ef4632a4.8742c8","type":"comment","z":"aec22158.fe4e38","name":"ERROR","info":"","x":2425,"y":2199.9999961853027,"wires":[]},{"id":"b3153c28.f9eb78","type":"function","z":"aec22158.fe4e38","name":"check if user exists","func":"var request = global.get('request');\nvar Moment = global.get('moment');var MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\nif (msg.RevotioData.PostData.gadgetData.formData.hasOwnProperty('username')){\n    msg.RevotioData.PostData.gadgetData.formData.username = msg.RevotioData.PostData.gadgetData.formData.username.toLowerCase()\n}\n\n// aggregate\n\n\n            aggregateObj = {\n                    query : { query : [ { \n                                        \"$match\" : {\n                                            username : msg.RevotioData.PostData.gadgetData.formData.username\n                                        }\n                                    }, \n                                    { \n                                        \"$lookup\" : {\n                                            \"from\" : \"user_accounts\", \n                                            \"localField\" : \"_id\", \n                                            \"foreignField\" : \"user\", \n                                            \"as\" : \"user_accounts\"\n                                        }\n                                    }, \n                                    { \n                                        \"$unwind\" : {\n                                            \"path\" : \"$user_accounts\", \n                                            \"preserveNullAndEmptyArrays\" : false\n                                        }\n                                    },\n                         \n                            ],},\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'users',\n                    operation:'aggregate',\n                    }\n                    \n            mongodbTools.resolveAsync(aggregateObj, node, function(res){\n                    msg.payload = res\n                    node.send(msg) \n            })  \n            \n            \n       \n\n// return msg;","outputs":1,"noerr":0,"x":2305,"y":2139.9999961853027,"wires":[["2f1a3e82.d43b12"]]},{"id":"2f1a3e82.d43b12","type":"function","z":"aec22158.fe4e38","name":"Check if user exists","func":"var NoUser, User;\n// msg.RevotioData.userData = msg.payload[0];\n\n\n\nif (typeof msg.payload[0] === 'object' && msg.payload[0]._id){\n    \n    user_accounts = msg.payload[0].user_accounts\n    payload =   msg.payload[0]\n    \n    payload.user_accounts = user_accounts;\n    \n    msg.payload = payload\n    \n    msg.RevotioData.FlowData.Data.UserData = payload\n     User = msg;\n}else{\n    NoUser = msg;\n}\n\nreturn [NoUser, User];","outputs":2,"noerr":0,"x":2605,"y":2139.9999961853027,"wires":[["85f2e522.8b14d"],["3311b64e.a40e82"]],"outputLabels":["NoUser, ","User"]},{"id":"e54d16bc.54e4f","type":"function","z":"aec22158.fe4e38","name":"check if account is active === true","func":"var accountActive,accountInactive, LinkExpired;\n\nif (typeof msg.payload !== 'object' || msg.payload === null){\n    LinkExpired = msg;\n} else {\n    if (msg.payload.active === true){\n    accountActive = msg;\n    } else {\n         accountInactive = msg;\n    }\n}\n\n\nreturn [accountActive,accountInactive, LinkExpired];","outputs":3,"noerr":0,"x":1435,"y":859.9999961853027,"wires":[["a98198f0.0c996"],["c8628eb6.6a32a8"],["494991a.a3d73f"]],"outputLabels":["accountActive","accountInactive","LinkExpired"]},{"id":"a98198f0.0c996","type":"function","z":"aec22158.fe4e38","name":"redirect user","func":"\n msg.payload = {\n            Page :  global.get(\"DomainProperties.NonAuthDefaultPage\"),\n            RevotioData: {\n            }\n        };\n\n\n\nreturn msg;","outputs":1,"noerr":0,"x":1725,"y":839.9999961853027,"wires":[["c374e685.14751"]]},{"id":"af88346b.2dfd","type":"function","z":"aec22158.fe4e38","name":"Reset password form Form","func":"\n    \ngadgetsList =[{\n            \"gadgetId\":  \"e947591f-f70b-84c4-c2f7-5a78178ad897\",\n            \"gadgetName\":  \"Reset password form\",\n            \"gadgetType\": \"custom-form\",\n            \"gadgetData\": {\n                  id: 'Login',\n                  canceled: false, // false\n                  submitButtonText: 'Submit',\n                  prevButtonText: 'Previous',\n                  nextButtonText: 'Next',\n                  showPrevious: false, //false\n                  title: 'Reset password',\n                  steps: [\n                    {\n                      title: '',\n                      subtitle: '',\n                      fields: [\n                          {\n                          name: 'username',\n                          htmlTag: 'input',  // button | select | textarea\n                          options: {\n                            value:msg.RevotioData.FlowData.Data.UserData.username ,\n                            label: 'Email address',\n                            placeholder: '',\n                            type: 'text', // default: text | button | checkbox | date | email | number | password | radio | submit\n                            editable: false ,// false by default\n                           required: true,\n                           disabled:true\n                            \n                          }\n                        },\n                        {\n                          name: 'passwordOne',\n                          htmlTag: 'input',  // button | select | textarea\n                          options: {\n                            value:\"\" ,\n                            label: 'New password',\n                            placeholder: '',\n                            type: 'password', // default: text | button | checkbox | date | email | number | password | radio | submit\n                            editable: true ,// false by default\n                           required: true\n                            \n                          }\n                        },\n                        {\n                          name: 'passwordTwo',\n                          htmlTag: 'input',  // button | select | textarea\n                          options: {\n                            value:\"\" ,\n                            label: 'New password (again)',\n                            placeholder: '',\n                            type: 'password', // default: text | button | checkbox | date | email | number | password | radio | submit\n                            editable: true ,// false by default\n                           required: true\n                            \n                          }\n                        },\n                    ]}\n                  ]\n                }},\n            ]\n\nmsg.payload = {gadgetsList:gadgetsList};\n\n\nreturn msg;","outputs":1,"noerr":0,"x":1100,"y":2200,"wires":[["881d9107.af00e"]]},{"id":"881d9107.af00e","type":"link out","z":"aec22158.fe4e38","name":"","links":["1766e26.2df601e","15f8aeef.16f7d1","6510415f.c64d6","14c789ed.fd90f6","172bf3ee.b9865c","e6548cdd.b0501","43e1a714.c877a8","228b07a6.f5d6a8","101c6a60.58ca1e","b0f61403.73aa18","d6cfe34e.7be1d","2f3e87cf.a0111","5171869d.c0b8a8","ffc46262.694388","3356ae90.b06682","1f447df2.f79d1a","84cfac4f.42a868","3a82fd2b.90627a","4809e15c.231538","4675a1ec.757c6","82336b76.b7c958","b824f5cf.104838","6a1ab5fc.dff14c","692c6501.32656c","14264b85.6baf9c","e358d072.f3562","6cc00ce9.6960a4"],"x":1235,"y":2200,"wires":[]},{"id":"3311b64e.a40e82","type":"function","z":"aec22158.fe4e38","name":"Generate and update appusers","func":"var request = global.get('request');\nvar Moment = global.get('moment');\nvar MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar crypto = global.get('crypto');\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\nmsg.RevotioData.FlowData.Data.UserData.resetToken = crypto.randomBytes(25).toString('hex');\n\n// update    \n    updateObj = {\n                    query : {\n                            query : { _id : new ObjectID(msg.RevotioData.FlowData.Data.UserData._id)}, \n                            update :  { \"$set\" :{resetToken : msg.RevotioData.FlowData.Data.UserData.resetToken}},\n                            options : {upsert: true}\n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'users',\n                    operation:'update', // updateMany , updateOne\n                    }\n\n            mongodbTools.resolveAsync(updateObj, node, function(res){\n                    msg.result = res\n                    node.send(msg) \n            })  \n            ","outputs":1,"noerr":0,"x":2890,"y":2160,"wires":[["16731a52.126fe6","78e9ce03.4f11c"]]},{"id":"5b61eb52.bcc75c","type":"function","z":"aec22158.fe4e38","name":"check if resetToken is present","func":"var present, notPresent; \n\nif (msg.RevotioData.FlowData.resetToken){\n    present = msg;\n} else {\n    notPresent = msg;\n}\nreturn [present, notPresent];","outputs":2,"noerr":0,"x":245,"y":2239.9999961853027,"wires":[["d554894d.135478","249a8713.6784"],["fbfb1b97.df21f8"]],"outputLabels":["present","notPresent"]},{"id":"8f35e986.f06c78","type":"function","z":"aec22158.fe4e38","name":"Check if user is found and if resetToken is valid","func":"var ValidToken, InvalidToken;\n\nif (typeof msg.payload === 'object' || msg.payload === null){\n    msg.RevotioData.FlowData.Data = {UserData : msg.payload}\n    ValidToken = msg;\n} else {\n    InvalidToken = msg;\n}\n\nreturn [ValidToken, InvalidToken];","outputs":2,"noerr":0,"x":760,"y":2220,"wires":[["af88346b.2dfd","71332273.c1870c"],["d97eeec5.bf9518"]],"outputLabels":["ValidToken, ","InvalidToken"]},{"id":"494991a.a3d73f","type":"function","z":"aec22158.fe4e38","name":"prepair redirect to NonAuthDefaultPage","func":"msg.payload  = {\n    Page :global.get(\"DomainProperties.NonAuthDefaultPage\"),\n}\nreturn msg;","outputs":1,"noerr":0,"x":1815,"y":919.9999961853027,"wires":[["fa60834f.7ab0f"]]},{"id":"d97eeec5.bf9518","type":"function","z":"aec22158.fe4e38","name":"prepair redirect to NonAuthDefaultPage","func":"msg.payload  = {\n    Page :global.get(\"DomainProperties.NonAuthDefaultPage\"),\n}\nreturn msg;","outputs":1,"noerr":0,"x":1140,"y":2240,"wires":[["5e3c68e9.35887"]]},{"id":"6bba7999.73091","type":"comment","z":"e5822137.be45d","name":"organizations global","info":"","x":90,"y":240,"wires":[]},{"id":"4c98a046.12853","type":"comment","z":"e5822137.be45d","name":"Organization global gadgets","info":"","x":1420,"y":240,"wires":[]},{"id":"ad43cd91.431cc8","type":"comment","z":"e5822137.be45d","name":"Organization global gagdet actions","info":"","x":3280,"y":240,"wires":[]},{"id":"2593799.dd12e06","type":"comment","z":"e5822137.be45d","name":"***************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************","info":"","x":2430,"y":200,"wires":[]},{"id":"90f055d0.958ee8","type":"link in","z":"e5822137.be45d","name":"organization global - INIT FLOW","links":["5d57bad4.0cdff4","9a050e9a.e90288","3b858951.2c8d86","febed477.696398","e6c8f68c.3a8fd"],"x":735,"y":420,"wires":[["2cc71536.88996a","c7460c54.ee33b"]]},{"id":"5ff89a19.327a54","type":"function","z":"e5822137.be45d","name":"Route userAction","func":"var CreateOrganizationTrigger, FormAction, OpenOrganization, MenuAction ,RevotioBreadCrumbs\nvar PostData    = msg.RevotioData.PostData;\nvar Page        = msg.RevotioData.session.Page;\n\n\nif (PostData.gadgetType=== \"dynamic-btn\"&& PostData.gadgetName === \"create organization\"){\n    CreateOrganizationTrigger = msg;\n} else if (PostData.gadgetType=== \"custom-form\"){\n    FormAction = msg;\n} else if (PostData.gadgetType=== \"data-table\"){\n    \n    if (PostData.gadgetData.hasOwnProperty(\"buttonData\") === true){\n        CreateOrganizationTrigger = msg;\n    } else {\n         OpenOrganization = msg;\n    }\n} else if (PostData.gadgetType=== \"Menu\"){\n    MenuAction = msg;\n} else if (PostData.gadgetType=== \"revotio-breadcrumbs\"){\n    RevotioBreadCrumbs  = msg;\n}\n\n\n\nreturn [CreateOrganizationTrigger, FormAction, OpenOrganization, MenuAction, RevotioBreadCrumbs];","outputs":"5","noerr":0,"x":3270,"y":340,"wires":[["42ba8494.e47aec"],["62533240.e8b54c"],["4d3d3f17.7ceb2"],["b4232b59.fc3c9"],["860d2caf.36873"]],"outputLabels":["CreateOrganizationTrigger","FormAction","OpenOrganization","MenuAction","RevotioBreadCrumbs"]},{"id":"a3d15c2e.a18008","type":"debug","z":"e5822137.be45d","name":"Organiozation Global Gadget post","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":3320,"y":280,"wires":[]},{"id":"2cc71536.88996a","type":"link out","z":"e5822137.be45d","name":"Trigger gadgets","links":["1198ab94.12521c","76bbdec4.14e998","58327abd.8edce4","a04c82ab.77936","e714ad41.62fe18","a00aba6e.69bb58","26c29dda.6daf62","cd9f1d1b.bf34"],"x":1115,"y":420,"wires":[]},{"id":"73fab343.93d92c","type":"comment","z":"e5822137.be45d","name":"INIT FLOW","info":"","x":700,"y":380,"wires":[]},{"id":"a04c82ab.77936","type":"link in","z":"e5822137.be45d","name":"** Gadget Name **","links":["2cc71536.88996a"],"x":1375,"y":280,"wires":[["41fcbe10.63615"]]},{"id":"c7460c54.ee33b","type":"debug","z":"e5822137.be45d","name":"Organiozation Global INIT post","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":910,"y":380,"wires":[]},{"id":"41fcbe10.63615","type":"function","z":"e5822137.be45d","name":"Get org records","func":"var request = global.get('request');\nvar Moment = global.get('moment');\nvar MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar crypto = global.get('crypto');\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\n\n\n\nvar OrgIds = [];\nindex = -1\n_.each(msg.RevotioData.session.UserData.AppUserPermissionInfo, function(Item, Index ){\n    // if (Item.type_id === global.get(\"MasterOrganizationData._id\")){\n  if (String(Item.type_id) === String(global.get(\"MasterOrganizationData._id\")) ){\n//   if (new ObjectID(Item.type_id) === new ObjectID(global.get(\"MasterOrganizationData._id\")) ){\n       index =  Index\n    }\n})\nif (index > -1 || msg.RevotioData.session.UserData.UserAccountData.user_type === \"Admin_Users\" ){\n//   match = {\"_id\": {\"$ne\": new ObjectID(global.get(\"MasterOrganizationData._id\"))}};\n    // msg.operation = \"find.toArray\";\n    \n    msg.payload = { parent_id: { $exists: false} , _id: {\"$ne\": new ObjectID(global.get(\"MasterOrganizationData._id\"))}};\n    msg.operation = \"find.toArray\";\n} else {\n    // get organization ID's\n    \n    var ids = [];\n    \n    _.each(msg.RevotioData.session.UserData.AppUserPermissionInfo, function(Item, Index){\n        if (Item.type === \"organization\"){\n            ids.push(Item.type_id)\n        }\n        msg.payload = { parent_id: { $exists: false} , _id: {\"$in\": ids}};\n        msg.operation = \"find.toArray\";\n    })\n    \n}\n\n// find  \nfindObj = {\n                    query : {\n                            query : msg.payload, \n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'organizations',\n                    operation:'find',\n                    }\n\n            mongodbTools.resolveAsync(findObj, node, function(res){\n                    msg.payload = res\n                    node.send(msg) \n            })   \n\n\n\n// return msg;","outputs":1,"noerr":0,"x":1460,"y":280,"wires":[["2505354a.38e0ca","a7691843.e08928","e1288258.b5e2a"]]},{"id":"4d3d3f17.7ceb2","type":"function","z":"e5822137.be45d","name":"Open org.","func":"msg.payload = {\n    Page :   'organization overview',\n    RevotioData: {\n        organization_id : msg.RevotioData.PostData.gadgetData.data._id\n    }\n};\nreturn msg;","outputs":1,"noerr":0,"x":3640,"y":360,"wires":[["6f35ce9c.ca2728"]]},{"id":"42ba8494.e47aec","type":"function","z":"e5822137.be45d","name":"Set Form Data","func":"    msg.RevotioData.FlowData.Form = {\n        FormType : \"Organization\",\n        FormActionType : \"Create\",\n        // Type : \"Create\",\n    };\nreturn msg;","outputs":1,"noerr":0,"x":3620,"y":260,"wires":[["229e849a.2b771c"]]},{"id":"62533240.e8b54c","type":"function","z":"e5822137.be45d","name":"Set Form Data","func":"// if (msg.RevotioData.FlowData.Form.hasOnwFormActionType)\n    // msg.RevotioData.FlowData.Form.Type = msg.RevotioData.FlowData.Form.FormActionType\nmsg.RevotioData.FlowData.Form.FormActionType = \"Post\";\n\nreturn msg;","outputs":1,"noerr":0,"x":3620,"y":320,"wires":[["229e849a.2b771c"]]},{"id":"a7691843.e08928","type":"function","z":"e5822137.be45d","name":"Count Organizations Card","func":"\n\n\nvar cardData = { \"cardType\":\"success\", \"cardTitle\":\"Organizations : \" , cardContentValue:  msg.payload.length,\"cardBottonValue\":\"\" } ;\n\n// Create GadgetList message\nmsg.payload = {gadgetsList:[{\n\n            \"gadgetId\":  \"448ba930-0610-ddc3-f8d7-bd9050e475aa\",\n            \"gadgetName\": \"Count Organizations\",\n            \"gadgetType\": \"data-card\",\n            \"gadgetData\": cardData\n            \n                     \n}]};\n\nreturn msg;","outputs":1,"noerr":0,"x":1690,"y":280,"wires":[["4ae71785.1c5fc"]]},{"id":"2505354a.38e0ca","type":"function","z":"e5822137.be45d","name":"Create Organizations DT","func":"var _ = global.get('underscore');\nvar lodash = global.get('lodash');\nvar columnStyles = [] ;\nvar headerStyles = [] ;\n\nvar tableColumnData  =  {\n         columnHead : [\n                  {\n                    \"title\": \"Name\",\n                    \"allowSort\": true,\n                    \"headKey\": \"Name\",\n                    \"hidden\": false,\n                    \"editable\": false\n                  },\n                            {\n                    \"title\": \"Legal entity\",\n                    \"allowSort\": true,\n                    \"headKey\": \"Legal entity\",\n                    \"hidden\": false,\n                    \"editable\": false\n                  },\n                  {\n                    \"title\": \"Type\",\n                    \"allowSort\": true,\n                    \"headKey\": \"Type\",\n                    \"hidden\": false,\n                    \"editable\": false\n                  },\n                //   {\n                //     \"title\": \"Multiple entity\",\n                //     \"allowSort\": true,\n                //     \"headKey\": \"Multiple entity\",\n                //     \"hidden\": false,\n                //     \"editable\": false\n                //   }\n                ],\n          \"columnOptions\": {\n            \"columnStyle\": {\n              \"width\": \"30%\"\n            },\n            \"cellStyle\": {\n            //   \"color\": \"red\"\n            },\n            \"allowSort\": true\n          }\n        };\n\n// var columns = [\n//                   {\n//                     \"title\": \"Name\",\n//                     \"allowSort\": true,\n//                     \"headKey\": \"name\",\n//                     \"hidden\": false,\n//                     \"editable\": false\n//                   },\n//                             {\n//                     \"title\": \"Legal entity\",\n//                     \"allowSort\": true,\n//                     \"headKey\": \"legal_entity\",\n//                     \"hidden\": false,\n//                     \"editable\": false\n//                   },\n//                   {\n//                     \"title\": \"Type\",\n//                     \"allowSort\": true,\n//                     \"headKey\": \"type\",\n//                     \"hidden\": false,\n//                     \"editable\": false\n//                   },\n//                   {\n//                     \"title\": \"Multiple entity\",\n//                     \"allowSort\": true,\n//                     \"headKey\": \"multiple_entity\",\n//                     \"hidden\": false,\n//                     \"editable\": false\n//                   },\n//                   {\n//                     \"title\": \"_id\",\n//                     \"allowSort\": true,\n//                     \"headKey\": \"_id\",\n//                     \"hidden\": true,\n//                     \"editable\": false\n//                   }\n                  \n//                 ]\n// commen buttons\n// var buttons = [ 'export'];  \nvar tableRowData = [];\n_.each(lodash.orderBy(msg.payload, [\"name\"],[\"asc\"]),function(orgItem, orgItemIndex){\n\n    obj = {\n            \"rowData\":[\n                  {\n                  \n              \n                            \"data\":  orgItem.name,\n                             \"type\": \"string\",\n                           \n                            \"headKey\":\"Name\",\n                            \"hidden\": false,\n                            \"editable\": false\n                          },\n                            {\n                            \"data\":  orgItem.legal_entity,\n                            \"type\": \"string\",\n                            \"headKey\": \"Legal entity\",\n                            \"hidden\": false,\n                            \"editable\": false\n                          },\n                            {\n                            \"data\": orgItem.type,\n                            \"type\": \"string\",\n                            \"headKey\":\"Type\",  \n                            \"hidden\": false,\n                            \"editable\": false\n                          },\n                            {\n                            \"data\": orgItem.multiple_entity,\n                             \"type\": \"string\",\n                            \"headKey\": \"Multiple entity\", \n                            \"hidden\": false,\n                            \"editable\": false\n                          },\n                          {\n                            \"data\":  orgItem._id,\n                            \"type\": \"string\",\n                            \"headKey\": \"_id\",\n                            \"hidden\": false,\n                            \"editable\": false\n                          },\n                        ],\n                    \"rowOptions\": {\n                    //   \"state\": \"warning\",\n                      \"globalClick\": true,\n                      \"style\": {\n                        \"width\": \"20%\"\n                      }\n                    },\n                    \"rowSourceData\":orgItem\n            }\n    \n    tableRowData.push(obj);\n})\n\ntableButton = [\n    {\n       \"buttonData\":\n          {\n           \"title\": \"Create\",\n            \"design\": {\n               \"file\": \"\",\n                \"icon\":global.get(\"icons.fas.create\") ,\n                // \"width\": \"\",\n                size :\"small\",\n                \"embossed\": true,\n                \"linebox\": true,\n                \"gradient\": false,\n                // \"color\": \"green\",\n                // padding : \"10px\"\n              },\n          \n              \"disabled\": false,\n            // \"type\": \"success\",\n                action: 'create',\n\n          },\n        \"buttonOptions\": {\n            \"dataType\": \"single\",\n            \"displayType\": \"text\",\n            \"selectionType\": \"global\"\n          }\n         }\n      \n      ]\n\n\n \nmsg.payload = {\n     gadgetsList :[ {\n        \"gadgetId\": \"5682828f-6f71-730f-6058-a1bd588add37\",\n        \"gadgetName\": \"Organizations DT\",\n        \"gadgetType\": \"data-table\",\n            \n    \"gadgetOptions\": {\n      \"allowSearch\": true,\n      \"maxItems\": tableRowData.length,\n      \"striped\": true,\n      \"export\": true\n    },\n    \"gadgetData\": {\n      \"tableColumnData\": tableColumnData,\n      \"tableTitle\": \"Organizations\",\n      \"tableRowData\": tableRowData ,\n      \"tableButton\": tableButton,\n      \"tableOptions\": {\n        \"mainOption\": \"global\"\n      }\n    }\n  }]}\n  \n  \n// msg.payload = {\n//      gadgetsList : [global.get(\"functions.dataTableObject\")(GadgetObject, columns, msg.payload)] \n\n//  } \nreturn msg;\n","outputs":1,"noerr":0,"x":1690,"y":240,"wires":[["5002c494.80c03c"]]},{"id":"91850e71.061e1","type":"link in","z":"e5822137.be45d","name":"organization global - GadgetAction","links":["ca484bde.d6efc8","b636d429.212c48","c44b4bde.0df218"],"x":2935,"y":320,"wires":[["a3d15c2e.a18008","5ff89a19.327a54"]]},{"id":"4ae71785.1c5fc","type":"link out","z":"e5822137.be45d","name":"","links":["e840ddd7.11a94","b4124e7e.13a8c8","f08dbd30.19106","ade0a880.e9e3","8ad43811.fd07d","74cebd07.0f68ec","ca494f41.c9ae08","c0a93485.127778","9c22e19d.5d8b4","8b5b3ea9.8d95d","a290aa5e.2d5bd8","62cd4701.1412e8","ec762598.4c2af8","9f7a0e6d.1758e8","c26c7f96.20094","3284eff1.d8cd78","d5c0b170.80cb78","11b5fac2.b2221d","4c93583.818b628","283ed720.02f7a","8414ff77.fcbb8","eefe6ecb.492078","33d6d74c.25aeb8","aba290c9.ab162","c37dfc7e.43b73","df85e4a9.ff02f8","527cdfb6.14653","7f33fea0.9165c","a23ff887.2048e8","4fdab1fb.c42528","ded62554.44e988"],"x":1815,"y":280,"wires":[]},{"id":"5002c494.80c03c","type":"link out","z":"e5822137.be45d","name":"","links":["e840ddd7.11a94","b4124e7e.13a8c8","f08dbd30.19106","ade0a880.e9e3","8ad43811.fd07d","74cebd07.0f68ec","ca494f41.c9ae08","c0a93485.127778","9c22e19d.5d8b4","8b5b3ea9.8d95d","a290aa5e.2d5bd8","62cd4701.1412e8","ec762598.4c2af8","9f7a0e6d.1758e8","c26c7f96.20094","3284eff1.d8cd78","d5c0b170.80cb78","11b5fac2.b2221d","4c93583.818b628","283ed720.02f7a","8414ff77.fcbb8","eefe6ecb.492078","33d6d74c.25aeb8","aba290c9.ab162","c37dfc7e.43b73","df85e4a9.ff02f8","527cdfb6.14653","7f33fea0.9165c","a23ff887.2048e8","4fdab1fb.c42528","ded62554.44e988"],"x":1835,"y":240,"wires":[]},{"id":"b7978fa4.f54cb","type":"function","z":"e5822137.be45d","name":"create organization btn","func":"msg.payload = \n    {\n   \"gadgetsList\":[{            \n       \"gadgetId\": \"092dc49e-14ce-a387-f97b-e65d303faf86\",\n            \"gadgetName\":\"create organization\",\n            \"gadgetType\":\"dynamic-btn\",\n            \"gadgetOptions\":\n                {\n                //  url:   \"http://localhost:1881/#/pageBuilder/5bacdd9fb9bf1c120bef1088/page/5bc987181e040202e7b74589\",\n                //  target: \"_blank\",\n                \"types\":\"\",\n                \"styles\":[\"btn-embossed\",\n                \"btn-success\",\"btn-square\"],\n                \"buttonalign\":\"right\",\n                \"textcolor\":\"black\",\n                \"buttonlabel\":\"Create new organization\"},\n                \"gadgetData\":{}\n       \n   }]\n\n                // \"gadgetData\":{\"DropdownData\":[{\"label\":\"Employee based\",\"action\":\"Employee\"},{\"label\":\"Project based\",\"action\":\"Project\"}]}}]\n\n} ;   \nreturn msg;","outputs":1,"noerr":0,"x":1500,"y":360,"wires":[["fb03028f.7d0f4"]]},{"id":"fb03028f.7d0f4","type":"link out","z":"e5822137.be45d","name":"","links":["e840ddd7.11a94","b4124e7e.13a8c8","f08dbd30.19106","ade0a880.e9e3","8ad43811.fd07d","74cebd07.0f68ec","ca494f41.c9ae08","c0a93485.127778","9c22e19d.5d8b4","8b5b3ea9.8d95d","a290aa5e.2d5bd8","62cd4701.1412e8","ec762598.4c2af8","9f7a0e6d.1758e8","c26c7f96.20094","3284eff1.d8cd78","d5c0b170.80cb78","11b5fac2.b2221d","4c93583.818b628","283ed720.02f7a","8414ff77.fcbb8","eefe6ecb.492078","33d6d74c.25aeb8","aba290c9.ab162","c37dfc7e.43b73","df85e4a9.ff02f8","527cdfb6.14653","7f33fea0.9165c","a23ff887.2048e8","4fdab1fb.c42528","ded62554.44e988"],"x":1835,"y":360,"wires":[]},{"id":"76bbdec4.14e998","type":"link in","z":"e5822137.be45d","name":"** Gadget Name **","links":["2cc71536.88996a"],"x":1375,"y":360,"wires":[["b7978fa4.f54cb"]]},{"id":"62867a86.49ad5c","type":"function","z":"aec22158.fe4e38","name":"Prepair redirect","func":"// Get libraries\nconst Moment = global.get('moment');\nconst MomentRange = global.get('momentrange');\nconst moment = MomentRange.extendMoment(Moment)\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting'); \nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\n\n\nvar PNO , Client, update;\n\nmsg.RevotioData.session.UserData =  msg.payload;\n\n// set login Date info\n\nmsg.RevotioData.session.UserData.previousLogin = new Date(msg.RevotioData.session.UserData.login)\nmsg.RevotioData.session.UserData.login = new Date()\n\nupdate = msg;\nmsg.RevotioData.session.UserData.type = \"NonPNOAdmin\"\n\n_.each(msg.RevotioData.session.UserData.AppUserPermissionInfo, function(Item, Index){\n    \n    if (Item.type === \"organization\"){\n        \n        if (String(Item.type_id) === String(global.get(\"MasterOrganizationData._id\")) && Item.permission === 0){\n            msg.RevotioData.session.UserData.type = \"PNOAdmin\"\n        }\n        \n        \n    }\n    \n})\n\n\nif (msg.RevotioData.FlowData.hasOwnProperty(\"Page\") === false){\n    // check if user is a PNO user\n    \n    if (msg.RevotioData.session.UserData.UserAccountData.user_type === \"Admin_Users\"){\n    msg.RevotioData.FlowData.Page = global.get(\"DomainProperties.PNODefaultPage\")\n    msg.payload = {\n                Page  :   msg.RevotioData.FlowData.Page\n    }\nPNO = msg;\n    } else {\n        \n\n        \n Client = msg\n        \n    }\n   \n}\n\n\nreturn [PNO , Client, update];","outputs":3,"noerr":0,"x":2715,"y":379.99999618530273,"wires":[["7d4e09a6.9a835"],["1bf31fd6.55c3a8"],["7951c57e.e01884"]],"outputLabels":["PNO","Client","update"]},{"id":"1bf31fd6.55c3a8","type":"function","z":"aec22158.fe4e38","name":"Get participants && projects","func":"var request = global.get('request');\nvar Moment = global.get('moment');var MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\n\nUserOrgPermissionObj = lodash.find(msg.RevotioData.session.UserData.AppUserPermissionInfo,{type: \"organization\"} );\n\n\n\n// find  \nfindObj = {\n                    query : {\n                            query :{organization_id:new ObjectID(UserOrgPermissionObj.type_id), contact_person_organization:new ObjectID(msg.RevotioData.session.UserData._id) }, \n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'participants',\n                    operation:'find',\n                    }\n\n            mongodbTools.resolveAsync(findObj, node, function(res){\n   \n                msg.RevotioData.session.UserData.OrgRepresentativeProjects = res\n\n                // find  \n                    findObj = {\n                                        query : {\n                                                query :{ project_leader : new ObjectID(msg.RevotioData.session.UserData._id)} , \n                                                },\n                                        connection:global.get(\"DB_data.connection\"),\n                                        database:global.get(\"DB_data.appDB\"),\n                                        collection:'projects',\n                                        operation:'find',\n                                        }\n                    \n                                        mongodbTools.resolveAsync(findObj, node, function(res){\n                               \n                                            // msg.RevotioData.session.UserData.OrgRepresentativeProjects = res\n                            \n                                            msg.RevotioData.session.UserData.ProjectLeaderProjects= res;\n                            \n                            \n                                                node.send(msg) \n                                        })\n            })   \n\n// return msg;\n\n","outputs":1,"noerr":0,"x":3060,"y":440,"wires":[["7ab33dc3.9bebac"]]},{"id":"7ab33dc3.9bebac","type":"function","z":"aec22158.fe4e38","name":"Permission check ","func":"// Get libraries\nconst Moment = global.get('moment');\nconst MomentRange = global.get('momentrange');\nconst moment = MomentRange.extendMoment(Moment);\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\n\n\nOrgObj = lodash.find(msg.RevotioData.session.UserData.AppUserPermissionInfo, {type: \"organization\"})\n\nif (msg.RevotioData.session.UserData.ProjectLeaderProjects.length === 0 && msg.RevotioData.session.UserData.OrgRepresentativeProjects.length === 0){\n    \n            msg.RevotioData.FlowData.Page = global.get(\"DomainProperties.PNODefaultPage\")\n            msg.RevotioData.OrganzationId = OrgObj.type_id;\n            msg.RevotioData.FlowData.organization_id = OrgObj.type_id;\n        \n       \n} else {\n        \n                msg.RevotioData.FlowData.Page = global.get(\"DomainProperties.ClientDefaultPage\")\n                msg.RevotioData.OrganzationId = OrgObj.type_id;\n                msg.RevotioData.FlowData.organization_id = OrgObj.type_id;\n         \n         \n\n}\n\n            msg.payload = {\n                    Page                 :   msg.RevotioData.FlowData.Page,\n                    RevotioData         : {\n                        organization_id : OrgObj.type_id\n                    }\n                }\n\n\nreturn msg;","outputs":1,"noerr":0,"x":3290,"y":440,"wires":[["7d4e09a6.9a835"]]},{"id":"bf863fcb.3b803","type":"subflow:45759581.11da84","z":"e5822137.be45d","name":"","env":[],"x":1430,"y":400,"wires":[["c36f0764.45994"]]},{"id":"58327abd.8edce4","type":"link in","z":"e5822137.be45d","name":"** Gadget Name **","links":["2cc71536.88996a"],"x":1375,"y":400,"wires":[["bf863fcb.3b803"]]},{"id":"b4a3b5aa.487f6","type":"link out","z":"e5822137.be45d","name":"","links":["e840ddd7.11a94","b4124e7e.13a8c8","f08dbd30.19106","ade0a880.e9e3","8ad43811.fd07d","74cebd07.0f68ec","ca494f41.c9ae08","c0a93485.127778","9c22e19d.5d8b4","8b5b3ea9.8d95d","a290aa5e.2d5bd8","62cd4701.1412e8","ec762598.4c2af8","9f7a0e6d.1758e8","c26c7f96.20094","3284eff1.d8cd78","d5c0b170.80cb78","11b5fac2.b2221d","4c93583.818b628","283ed720.02f7a","8414ff77.fcbb8","eefe6ecb.492078","33d6d74c.25aeb8","aba290c9.ab162","c37dfc7e.43b73","df85e4a9.ff02f8","527cdfb6.14653","7f33fea0.9165c","a23ff887.2048e8","4fdab1fb.c42528","ded62554.44e988"],"x":1695,"y":400,"wires":[]},{"id":"e1288258.b5e2a","type":"function","z":"e5822137.be45d","name":"Breadcrumb organizations","func":"// Get libraries\nconst Moment = global.get('moment');\nconst MomentRange = global.get('momentrange');\nconst moment = MomentRange.extendMoment(Moment);\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting'); \nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\n\nOrgKeysOptions = [];\n\n_.each(msg.payload, function(Item, Index){\n    \n    if (String(Item._id) === String(msg.RevotioData.FlowData.organization_id)){\n        selected = true\n    } else {\n        selected = false\n    }\n    \n    OrgKeysOptions.push({\n              \"title\": Item.name,\n              selected:selected,\n              \"design\": {\n                \"icon\": global.get(\"icons.fas.organization\")\n              },\n              \"action\": {\n                Page : 'organization overview',\n                organization_id: Item._id,\n                icon: global.get(\"icons.fas.organization\"),\n                key: \"organization\",\n                value: Item.name \n              }\n            })\n})\n\n\nvar data = [\n    {\n        \"buttonData\": {\n                      \"title\": \"Organizations\",\n                      \"allowsearch\": true,\n                      titleDisplayType: \"selected\",\n                      \"design\": {\n                        \"icon\": global.get(\"icons.fas.organization\")\n                      },\n                      subButton:[{\n                            icons : global.get(\"icons.fas.create\"),\n                            action : {\n                                                FormType : \"Organization\",\n                                                FormActionType : \"Create\",\n                                                // FormData: msg.RevotioData.FlowData.Data.OrganizationData,\n                                                // organization_id : msg.RevotioData.FlowData.Data.OrganizationData._id\n                                            },\n                            color : \"green\" ,\n                            tooltip: \"Create a new organization\"\n                      }],\n                      \"options\":OrgKeysOptions,\n                    //   \"action\": {}\n                    },\n        \"buttonOptions\": {\n          \"dataType\": \"multiple\",\n          \"displayType\": \"text\"\n        }\n      }]\n\n    \nmsg.payload = {\n    gadgetsList: [{\n                \"gadgetId\": \"593e0f9b-f4f2-d2e3-fc56-2aa3eb9ccfc6\",\n              \"gadgetName\": \"scope breadcrumb\",\n              \"gadgetType\": \"revotio-breadcrumbs\",\n                gadgetData: data,\n                gadgetOptions: {\n                    disabled:false,\n                    separatorIcon: 'fas fa-angle-right',\n                }\n              }]}\n\nreturn msg;","outputs":1,"noerr":0,"x":1700,"y":320,"wires":[["f10a8582.df74b"]]},{"id":"f10a8582.df74b","type":"link out","z":"e5822137.be45d","name":"","links":["e840ddd7.11a94","b4124e7e.13a8c8","f08dbd30.19106","ade0a880.e9e3","8ad43811.fd07d","74cebd07.0f68ec","ca494f41.c9ae08","c0a93485.127778","9c22e19d.5d8b4","8b5b3ea9.8d95d","a290aa5e.2d5bd8","62cd4701.1412e8","ec762598.4c2af8","9f7a0e6d.1758e8","c26c7f96.20094","3284eff1.d8cd78","d5c0b170.80cb78","11b5fac2.b2221d","4c93583.818b628","283ed720.02f7a","8414ff77.fcbb8","eefe6ecb.492078","33d6d74c.25aeb8","aba290c9.ab162","c37dfc7e.43b73","df85e4a9.ff02f8","527cdfb6.14653","7f33fea0.9165c","a23ff887.2048e8","4fdab1fb.c42528","ded62554.44e988"],"x":1835,"y":320,"wires":[]},{"id":"ab10a2d5.fc6ad","type":"catch","z":"2294209a.0c95b","name":"","scope":null,"x":60,"y":240,"wires":[["58ea0e0c.87eda"]]},{"id":"58ea0e0c.87eda","type":"debug","z":"2294209a.0c95b","name":"ERROR","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"true","targetType":"full","x":178.33332443237305,"y":239.99999618530273,"wires":[]},{"id":"777db7e9.fd3678","type":"comment","z":"2294209a.0c95b","name":"users global","info":"","x":70,"y":320,"wires":[]},{"id":"96263bd.b412fc8","type":"debug","z":"2294209a.0c95b","name":"users global INIT POST  ","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"RevotioData","targetType":"msg","x":1070,"y":560,"wires":[]},{"id":"8c63f461.7ede2","type":"debug","z":"2294209a.0c95b","name":"users global action ","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"RevotioData.PostData","targetType":"msg","x":2650,"y":440,"wires":[]},{"id":"dfb51746.eb5818","type":"comment","z":"2294209a.0c95b","name":"users global action ","info":"","x":2650,"y":320,"wires":[]},{"id":"a3a4efb5.82b6a8","type":"function","z":"2294209a.0c95b","name":"Route userAction","func":"var BtnAction, FormAction, OpenOrganization, MenuAction ,RevotioBreadCrumbs, sliderAction, tabsSelect\nvar PostData    = msg.RevotioData.PostData;\nvar Page        = msg.RevotioData.session.Page;\n\n\nif (PostData.gadgetType=== \"dynamic-btn\"){\n    BtnAction = msg;\n} else if (PostData.gadgetType=== \"custom-form\"){\n    FormAction = msg;\n} else if (PostData.gadgetType=== \"data-table\"){\n    \n    if (PostData.gadgetData.hasOwnProperty(\"buttonData\") === true){\n        CreateOrganizationTrigger = msg;\n    } else {\n         OpenOrganization = msg;\n    }\n} else if (PostData.gadgetType=== \"Menu\"){\n    MenuAction = msg;\n} else if (PostData.gadgetType=== \"revotio-breadcrumbs\"){\n    RevotioBreadCrumbs  = msg;\n} else if (PostData.gadgetType=== \"user-slider\"){\n    sliderAction  = msg;\n} else if (PostData.gadgetType === \"revotio-tabs-select\"){\n            tabsSelect = msg\n\n    }\n\n\n\nreturn [BtnAction, FormAction, OpenOrganization, MenuAction, RevotioBreadCrumbs, sliderAction, tabsSelect];","outputs":7,"noerr":0,"x":2650,"y":540,"wires":[["5df13deb.3acd8c"],["52927150.b34eb8"],[],["de32b4e0.6e0cb"],["de0a486c.213f5"],["36833fec.f99c5"],[]],"outputLabels":["BtnAction","FormAction","OpenOrganization","MenuAction","RevotioBreadCrumbs","sliderAction","tabsSelect"]},{"id":"52927150.b34eb8","type":"function","z":"2294209a.0c95b","name":"Set Form Data","func":"\nmsg.RevotioData.FlowData.Form.Type = msg.RevotioData.FlowData.Form.FormActionType\nmsg.RevotioData.FlowData.Form.FormActionType = \"Post\";\n\nreturn msg;","outputs":1,"noerr":0,"x":2980,"y":540,"wires":[["6db87728.a54d58"]]},{"id":"b4ce0864.df5ff8","type":"function","z":"2294209a.0c95b","name":"Set Form Data","func":"    msg.RevotioData.FlowData.Form = {\n        FormType : \"User\",\n        FormActionType : \"Create\",\n        // FormData :{\n            organization_id: msg.RevotioData.FlowData.organization_id\n        // }\n    };\nreturn msg;","outputs":1,"noerr":0,"x":3400,"y":400,"wires":[["a59768fe.a6a258"]]},{"id":"b09f7e8.6839d8","type":"comment","z":"2294209a.0c95b","name":"***************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************","info":"","x":2430,"y":280,"wires":[]},{"id":"32bc6eb7.c073aa","type":"link in","z":"2294209a.0c95b","name":"users global INIT ","links":["c5aa2d02.8f412","f366e4ef.12135","b0ae31e0.11c9e8"],"x":915,"y":600,"wires":[["96263bd.b412fc8","12877cee.3216e3"]]},{"id":"3a23c4b4.bdc8a4","type":"link in","z":"2294209a.0c95b","name":"users global action ","links":["a73b1515.e10af","c01419a1.2a769","be4224db.bfd728"],"x":2495,"y":540,"wires":[["a3a4efb5.82b6a8","8c63f461.7ede2"]]},{"id":"aea25a8a.fa4a58","type":"link out","z":"2294209a.0c95b","name":"","links":["b99d146e.edaab","4c702830.810f","bad52f95.bf573","5db440a.6f3ea4","77ece62a.01347","c114b448.029c4","449e3134.053a68"],"x":1195,"y":600,"wires":[]},{"id":"b99d146e.edaab","type":"link in","z":"2294209a.0c95b","name":"users global = slider Gagdet","links":["aea25a8a.fa4a58"],"x":1415,"y":520,"wires":[["54bebd9c.e00f24"]]},{"id":"4c702830.810f","type":"link in","z":"2294209a.0c95b","name":"users global = BTN Gagdet","links":["aea25a8a.fa4a58"],"x":1415,"y":560,"wires":[["5fe4db8e.07be7c"]]},{"id":"bad52f95.bf573","type":"link in","z":"2294209a.0c95b","name":"users global = ACC Gagdet","links":["aea25a8a.fa4a58"],"x":1375,"y":600,"wires":[[]]},{"id":"54bebd9c.e00f24","type":"function","z":"2294209a.0c95b","name":"\"users slider\"","func":"// Get libraries\nconst Moment = global.get('moment');\nconst MomentRange = global.get('momentrange');\nconst moment = MomentRange.extendMoment(Moment)\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting'); \nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\n\n\n\n// aggregate\n                   aggregateObj = {\n                    query : { query : [{\n                                $match: {\n                                  \"type_id\": new ObjectID(msg.RevotioData.FlowData.organization_id),\n                                  \"type\": \"organization\"\n                                }\n                              },\n                              {\n                                $lookup: {\n                                  \"from\": \"user_accounts\",\n                                  \"localField\": \"user\",\n                                  \"foreignField\": \"user\",\n                                  \"as\": \"user_accounts\"\n                                }\n                              },\n                               {\n                                $lookup: {\n                                  \"from\": \"users\",\n                                  \"localField\": \"user\",\n                                  \"foreignField\": \"_id\",\n                                  \"as\": \"users\"\n                                }\n                              },\n                            //   {\n                            //     $project: {\n                            //       \"permission\": 1.0,\n                            //       \"projectData.name\": 1.0\n                            //     }\n                            //   },\n                              {\n                                $unwind: {\n                                  \"path\": \"$user_accounts\",\n                                  \"includeArrayIndex\": \"arrayIndex\",\n                                  \"preserveNullAndEmptyArrays\": false\n                                }\n                              },\n                              {\n                                $unwind: {\n                                  \"path\": \"$users\",\n                                  \"includeArrayIndex\": \"arrayIndex\",\n                                  \"preserveNullAndEmptyArrays\": false\n                                }\n                              }\n                            ],},\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'user_permissions',\n                    operation:'aggregate',\n                    }\n                    \n            mongodbTools.resolveAsync(aggregateObj, node, function(res){\n                    \n                    data = [];\n                    \n                    // if (res.length > 0){\n                    _.each(res, function(item, index ){\n                        \n                        \n                        // if (String(item.user_accounts.user) ===  )\n                        data.push(\n                               {\n                                  \"name\": item.user_accounts.first_name + \"  \" + item.user_accounts.last_name,\n                                  \"src\": global.get(\"functions.fileManagement\")(global.get(\"DomainProperties.rootPath\") +  item.user_accounts.avatar, item.user_accounts.avatar ,msg.RevotioData.session._id, \"copySync\"), // source, destination, operation global.get(\"DomainProperties.url\") + msg.RevotioData.session.UserData.avatar,\n                                filePath: item.user_accounts.avatar,\n                                //   global.get(\"functions.fileManagement\")(global.get(\"DomainProperties.rootPath\") +  item.user_accounts.avatar, item.user_accounts.avatar ,msg.RevotioData.session._id, \"copySync\"), // source, destination, operation global.get(\"DomainProperties.url\") + msg.RevotioData.session.UserData.avatar,\n                            \n                                  \"status\": \"inactive\",\n                                  appUserId : item.user\n                                })\n                    \n                    \n\n\n                  \n            })  \n                   \n                    \n                    msg.payload = {gadgetsList: [{\n                           \"gadgetId\": \"556e2104-bc36-30ba-a12b-6e90c899c5ab\",\n                          \"gadgetName\": \"users slider\",\n                          \"gadgetType\": \"user-slider\",\n                              \"gadgetData\":data\n                            }\n                   ]}\n\n              node.send(msg) \n            })\n\n\n\n","outputs":1,"noerr":0,"x":1490,"y":520,"wires":[["1c021baa.41b07c"]]},{"id":"5fe4db8e.07be7c","type":"function","z":"2294209a.0c95b","name":"Create user BTN GADGET","func":"msg.payload = \n    {\n   \"gadgetsList\":[{            \n       \"gadgetId\": \"d2a4ccdb-bf9f-dcf4-2795-aa95f99e2ec3\",\n            \"gadgetName\":\"Create user BTN\",\n            \"gadgetType\":\"dynamic-btn\",\n            \"gadgetOptions\":\n                {\n                //  url:   \"http://localhost:1881/#/pageBuilder/5bacdd9fb9bf1c120bef1088/page/5bc987181e040202e7b74589\",\n                //  target: \"_blank\",\n                \"types\":\"\",\n                \"styles\":[\"btn-embossed\",\n                \"btn-success\",\"btn-square\"],\n                \"buttonalign\":\"right\",\n                \"textcolor\":\"black\",\n                \"buttonlabel\":\"Create new user\"},\n                \"gadgetData\":{type: \"createUser\"}\n       \n   }]\n\n                // \"gadgetData\":{\"DropdownData\":[{\"label\":\"Employee based\",\"action\":\"Employee\"},{\"label\":\"Project based\",\"action\":\"Project\"}]}}]\n\n} ; \n\nreturn msg ;","outputs":1,"noerr":0,"x":1540,"y":560,"wires":[["df9e1699.b208d8"]]},{"id":"c1a8050f.064128","type":"function","z":"2294209a.0c95b","name":"users acc","func":"// Get libraries\nconst Moment = global.get('moment');\nconst MomentRange = global.get('momentrange');\nconst moment = MomentRange.extendMoment(Moment)\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting'); \nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\n\n\n\n// aggregate\n            aggregateObj = {\n                    query : { query : [{\n                                $match: {\n                                  \"type_id\": new ObjectID(msg.RevotioData.FlowData.organization_id),\n                                  \"type\": \"organization\"\n                                }\n                              },\n                              {\n                                $lookup: {\n                                  \"from\": \"user_accounts\",\n                                  \"localField\": \"user\",\n                                  \"foreignField\": \"user\",\n                                  \"as\": \"user_accounts\"\n                                }\n                              },\n                            //   {\n                            //     $project: {\n                            //       \"permission\": 1.0,\n                            //       \"projectData.name\": 1.0\n                            //     }\n                            //   },\n                              {\n                                $unwind: {\n                                  \"path\": \"$user_accounts\",\n                                  \"includeArrayIndex\": \"arrayIndex\",\n                                  \"preserveNullAndEmptyArrays\": false\n                                }\n                              }\n                            ],},\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'user_permissions',\n                    operation:'aggregate',\n                    }\n                    \n            mongodbTools.resolveAsync(aggregateObj, node, function(res){\n                    \n                    data = [];\n                    \n                    _.each(res, function(item, index ){\n                        \n                        data.push(\n                            {\n                                  \"state\": \"info\",\n                                  \"title\": item.user_accounts.first_name + \" \" + item.user_accounts.last_name,\n                                  \"rowState\": item.user_accounts.state ,\n                                  \"Avatar\": item.user_accounts.avatar,\n                                  \"buttons\": [\n                                    {\n                                      \"name\": \"\",\n                                      \"type\": \"\",\n                                      \"icon\": \"fas fa-angle-double-right\",\n                                      \"label\": \"\",\n                                      \"color\": \"blue\",\n                                      \"tooltip\": \"tooltip string\",\n                                      \"state\": \"inactive or active\"\n                                    }\n                                  ],\n                                  \"ButtonName\": \"fas fa-angle-double-right\",\n                                  \"keys\": [\n                                    {\n                                      \"state\": \"info\",\n                                      \"title\": \"key title\",\n                                      \"values\": {\n                                        \"prop1\": \"val1\",\n                                        \"prop2\": \"val2\",\n                                        \"prop3\": \"val3\"\n                                      }\n                                    }\n                                  ]\n                                }\n                        )\n                        \n                    })\n                    \n                    msg.payload = {gadgetsList: [{\n                              \"gadgetId\": \"808e98a2-1725-cb8c-5d47-ef95e2e28751\",\n                              \"gadgetName\": \"users acc\",\n                              \"gadgetType\": \"infinite-accordion\",\n                              \"gadgetOptions\": {\n                                \"navigateAll\": false,\n                                \"stickyTree\": false,\n                                \"alignKeys\": false\n                              },\n                              \"gadgetData\":data\n                            }\n                            ]}\n\n\n\n                    node.send(msg) \n            })  \n\n\n\n\n\nreturn msg;","outputs":1,"noerr":0,"x":1480,"y":600,"wires":[["f19484dd.a1fe48"]]},{"id":"1c021baa.41b07c","type":"link out","z":"2294209a.0c95b","name":"","links":["e158a3eb.e1806","4ac73054.2df2a","1766e26.2df601e","15f8aeef.16f7d1","6510415f.c64d6","14c789ed.fd90f6","172bf3ee.b9865c","e6548cdd.b0501","43e1a714.c877a8","228b07a6.f5d6a8","101c6a60.58ca1e","b0f61403.73aa18","d6cfe34e.7be1d","2f3e87cf.a0111","5171869d.c0b8a8","ffc46262.694388","3356ae90.b06682","1f447df2.f79d1a","84cfac4f.42a868","3a82fd2b.90627a","480dae32.8a339","4675a1ec.757c6","82336b76.b7c958","b824f5cf.104838","6a1ab5fc.dff14c","692c6501.32656c","14264b85.6baf9c","e358d072.f3562","6cc00ce9.6960a4"],"x":1735,"y":520,"wires":[]},{"id":"df9e1699.b208d8","type":"link out","z":"2294209a.0c95b","name":"","links":["e158a3eb.e1806","4ac73054.2df2a","1766e26.2df601e","15f8aeef.16f7d1","6510415f.c64d6","14c789ed.fd90f6","172bf3ee.b9865c","e6548cdd.b0501","43e1a714.c877a8","228b07a6.f5d6a8","101c6a60.58ca1e","b0f61403.73aa18","d6cfe34e.7be1d","2f3e87cf.a0111","5171869d.c0b8a8","ffc46262.694388","3356ae90.b06682","1f447df2.f79d1a","84cfac4f.42a868","3a82fd2b.90627a","480dae32.8a339","4675a1ec.757c6","82336b76.b7c958","b824f5cf.104838","6a1ab5fc.dff14c","692c6501.32656c","14264b85.6baf9c","e358d072.f3562","6cc00ce9.6960a4"],"x":1735,"y":560,"wires":[]},{"id":"f19484dd.a1fe48","type":"link out","z":"2294209a.0c95b","name":"","links":["e158a3eb.e1806","4ac73054.2df2a","1766e26.2df601e","15f8aeef.16f7d1","6510415f.c64d6","14c789ed.fd90f6","172bf3ee.b9865c","e6548cdd.b0501","43e1a714.c877a8","228b07a6.f5d6a8","101c6a60.58ca1e","b0f61403.73aa18","d6cfe34e.7be1d","2f3e87cf.a0111","5171869d.c0b8a8","ffc46262.694388","3356ae90.b06682","1f447df2.f79d1a","84cfac4f.42a868","3a82fd2b.90627a","480dae32.8a339","4675a1ec.757c6","82336b76.b7c958","b824f5cf.104838","6a1ab5fc.dff14c","692c6501.32656c","14264b85.6baf9c","e358d072.f3562","6cc00ce9.6960a4"],"x":1735,"y":600,"wires":[]},{"id":"dc858fa9.f74248","type":"function","z":"2294209a.0c95b","name":"items gadget","func":"// Get libraries\nconst Moment = global.get('moment');\nconst MomentRange = global.get('momentrange');\nconst moment = MomentRange.extendMoment(Moment)\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting'); \nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\n\n\n\n// aggregate\n            aggregateObj = {\n                    query : { query : [{\n                                $match: {\n                                  \"type_id\": new ObjectID(msg.RevotioData.FlowData.organization_id),\n                                  \"type\": \"organization\"\n                                }\n                              },\n                              {\n                                $lookup: {\n                                  \"from\": \"user_accounts\",\n                                  \"localField\": \"user\",\n                                  \"foreignField\": \"user\",\n                                  \"as\": \"user_accounts\"\n                                }\n                              },\n                               {\n                                $lookup: {\n                                  \"from\": \"users\",\n                                  \"localField\": \"user\",\n                                  \"foreignField\": \"_id\",\n                                  \"as\": \"users\"\n                                }\n                              },\n                            //   {\n                            //     $project: {\n                            //       \"permission\": 1.0,\n                            //       \"projectData.name\": 1.0\n                            //     }\n                            //   },\n                              {\n                                $unwind: {\n                                  \"path\": \"$user_accounts\",\n                                  \"includeArrayIndex\": \"arrayIndex\",\n                                  \"preserveNullAndEmptyArrays\": false\n                                }\n                              },\n                              {\n                                $unwind: {\n                                  \"path\": \"$users\",\n                                  \"includeArrayIndex\": \"arrayIndex\",\n                                  \"preserveNullAndEmptyArrays\": false\n                                }\n                              }\n                            ],},\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'user_permissions',\n                    operation:'aggregate',\n                    }\n                    \n            mongodbTools.resolveAsync(aggregateObj, node, function(res){\n                    \n                    data = [];\n                    \n                    _.each(res, function(item, index ){\n                        \n                        var color = \"btn-info\"\n                         if (item.users.hasOwnProperty(\"resetPassword\") && item.users.resetPassword === true){\n                              resetPassword = \"Reset required\"\n                              color = \"btn-warning\"\n                          } else {\n                               resetPassword = \"No reset required\"\n                          }\n                          \n                        if (item.users.hasOwnProperty(\"blockAccount\") && item.users.blockAccount === true){\n                               blockAccountName = \"Account blocked\"\n                               blockAccountLabel = \"Unblock account\"\n                                blockAccount = \"unBlockAccount\"\n                               color = \"btn-danger\" \n                          } else {\n                               blockAccountName = \"Account not blocked\"\n                                blockAccountLabel = \"Block account\"\n                                blockAccount = \"blockAccount\"\n                          }\n                          \n                          \n                            var AvatarBtn =   {\n                                        gadgetId: \"b12c4750-6084-2361-cc12-8e3bd4ef54f0\",\n                                        \"gadgetName\":\"user avatar btn\",\n                                        \"gadgetType\":\"dynamic-btn\",\n                        // \"gadgetOptions\": {\n                        //     types:['dropdown'],\n                        //     styles:['btn-embossed', 'btn-success', 'btn-square', ], \n                        //     buttonalign:'left', \n                        //     textcolor:'black', \n                        //     buttonlabel:'Department - ' + ButtonLabel,\n                        // },// icon:{type:'fa fa-plus', align:'left'}                        \n                        \"gadgetOptions\": {\n                            types:['image'],\n                            // imageUrl: global.get(\"DomainProperties.url\") + item.user_accounts.avatar, // \"https;//academicprojects.eu/\" + msg.loopData.payload.avatar,\n                            \n                            imageUrl : global.get(\"functions.fileManagement\")(global.get(\"DomainProperties.rootPath\") +  item.user_accounts.avatar, item.user_accounts.avatar ,msg.RevotioData.session._id, \"copySync\"), // source, destination, operation global.get(\"DomainProperties.url\") + msg.RevotioData.session.UserData.avatar,\n                            filePath : item.user_accounts.avatar,\n                            styles:['img-md', 'img-circle'], // img-circle , img-rounded, img-thumbnail, img-sm, img-md, img-lg\n                            buttonalign:'right', \n                            textcolor:'black', \n                            buttonlabel:'Uploadsy', \n                            action:{type: \"userClick\",  data : {organization_id : msg.RevotioData.FlowData.organization_id, appUserId: item.user}} // starts under app-academicprojects\n                            \n                        },// icon:{type:'fa fa-plus', align:'left'}\n                        \"gadgetData\": {\n                            // \"DropdownData\":[\n                            //                     {label:\"All\", action: 'All'},\n                            //                     {label:\"Conservation Biology\", action: 'ConservationBiology'}, \n                            //                     {label:\"Industrial Ecology\", action:'IndustrialEcology'},\n                            //                     {label:\"Central\", action:'Central'},\n                            //                 ]\n                        }\n                    };\n                          \n                          \n                         \n                            var optionsBtn =   {\n                                        gadgetId: \"c184650b-3842-4533-5c53-f74b098856db\",\n                                        \"gadgetName\":\"user options btn\",\n                                        \"gadgetType\":\"dynamic-btn\",\n                                        \"gadgetOptions\": {\n                                            types:['dropdown'],\n                                            styles:['btn-embossed', color, 'btn-square', ], \n                                            buttonalign:'left', \n                                            textcolor:'black', \n                                            buttonlabel:\"Options\",\n                                        },// icon:{type:'fa fa-plus', align:'left'}                        \n                                        // \"gadgetOptions\": {\n                                        //     types:['image'],\n                                        //     imageUrl: item.user_accounts.avatar, // \"https;//academicprojects.eu/\" + msg.loopData.payload.avatar,\n                                        //     styles:['img-md', 'img-circle'], // img-circle , img-rounded, img-thumbnail, img-sm, img-md, img-lg\n                                        //     buttonalign:'right', \n                                        //     textcolor:'black', \n                                        //     buttonlabel:'Uploadsy', \n                                        //     action:{type: \"userClick\",  data : {organization_id : msg.loopData.payload.organization_id, appUserId: item.user}} // starts under app-academicprojects\n                                            \n                                        // },// icon:{type:'fa fa-plus', align:'left'}\n                                        \"gadgetData\": {\n                                            \"DropdownData\":[    {label:\"Edit user\", action:{type: \"editUser\",  data : {organization_id : msg.RevotioData.FlowData.organization_id, appUserId: item.user}}},\n                                                                {label:\"Reset password\", action: {type: \"resetPassword\",  data : {organization_id : msg.RevotioData.FlowData.organization_id, appUserId: item.user}}},\n                                                                {label:blockAccountLabel, action: {type: blockAccount,  data : {organization_id : msg.RevotioData.FlowData.organization_id, appUserId: item.user}}}, \n                                                                {label:\"Close user session\", action:{type: \"closeUserSessions\",  data : {organization_id : msg.RevotioData.FlowData.organization_id, appUserId: item.user}}},\n                                                                 {label:\"Remove user\", action:{type: \"removeUser\",  data : {organization_id : msg.RevotioData.FlowData.organization_id, appUserId: item.user}}},\n                                                         \n                                                            ]\n                                        }\n                                    };\n                            \n                            var userInfo = {\n                                        gadgetId: '64d99fe2-5cae-ae62-5e81-2ccd8153fb06',\n                                        gadgetName: 'user information text',\n                                        gadgetType: 'dynamic-text-area',\n                                        gadgetData: {\n                                        data: [{\n                                            label: \"User\",\n                                            value: item.user_accounts.first_name + \" \" + item.user_accounts.last_name,\n                                            // options: textFieldOptions\n                                            },\n                                            {\n                                            label:  \"E-mail address\",\n                                            value: item.user_accounts.username ,\n                                            // options: textFieldOptions\n                                            },\n                                            {\n                                            label:  \"Password\",\n                                            value: resetPassword ,\n                                            // options: textFieldOptions\n                                            },\n                                            {\n                                            label:  \"Account\",\n                                            value: blockAccountName,\n                                            // options: textFieldOptions\n                                            },\n                                            {\n                                            label:  \"Last login\",\n                                            value: moment(item.users.login).format(\"dddd, MMMM Do YYYY, h:mm:ss a\") ,\n                                            // options: textFieldOptions\n                                            },\n                                            // {\n                                            // label:  \"\",\n                                            // value: msg.settings[lodash.findIndex(msg.settings, {_id:new ObjectID(msg.loopData.payload.department) })].Name,\n                                            // options: textFieldOptions}\n                                            ],\n                                        options:global.get(\"gadgetObjects['dynamic-text-area'].options\")\n                                        }\n                                    };\n                                    \n                             data.push([AvatarBtn,optionsBtn,userInfo])       \n                                    })\n                    \n                msg.payload = { gadgetsList : [{            \n                   \"gadgetId\": \"100b298e-fa30-fab6-5324-677228e86103\",\n                    \"gadgetType\":\"revotio-custom-item-container\",\n                    \"gadgetData\": data,\n                    \"gadgetOptions\" :{\n                        display:\"row\",\n                        totalGroup:2,\n                        padding : 5,\n                       }\n                    },]}\n                    \n                    node.send(msg) \n            })  \n","outputs":1,"noerr":0,"x":1490,"y":640,"wires":[["5d648f99.e116b8","54978e5a.104c68"]]},{"id":"5db440a.6f3ea4","type":"link in","z":"2294209a.0c95b","name":"users global = items Gagdet","links":["aea25a8a.fa4a58","1dea56ab.df6ad9"],"x":1415,"y":640,"wires":[["dc858fa9.f74248"]]},{"id":"5d648f99.e116b8","type":"link out","z":"2294209a.0c95b","name":"","links":["e158a3eb.e1806","4ac73054.2df2a","1766e26.2df601e","15f8aeef.16f7d1","6510415f.c64d6","14c789ed.fd90f6","172bf3ee.b9865c","e6548cdd.b0501","43e1a714.c877a8","228b07a6.f5d6a8","101c6a60.58ca1e","b0f61403.73aa18","d6cfe34e.7be1d","2f3e87cf.a0111","5171869d.c0b8a8","ffc46262.694388","3356ae90.b06682","1f447df2.f79d1a","84cfac4f.42a868","3a82fd2b.90627a","480dae32.8a339","4675a1ec.757c6","82336b76.b7c958","b824f5cf.104838","6a1ab5fc.dff14c","692c6501.32656c","14264b85.6baf9c","e358d072.f3562","6cc00ce9.6960a4"],"x":1735,"y":640,"wires":[]},{"id":"5df13deb.3acd8c","type":"function","z":"2294209a.0c95b","name":"Route btn action","func":"var createUser, editUser,other;\n\n\nif (msg.RevotioData.PostData.hasOwnProperty(\"actionType\") === false  || typeof msg.RevotioData.PostData.actionType  === 'object'){\n    \n\n    if (msg.RevotioData.PostData.actionType.type === \"editUser\"){\n        editUser = msg;\n    }  else { // blockUser, cancelSession, resetPassword\n        other = msg\n    } \n\n}\nelse if (msg.RevotioData.PostData.gadgetData.type === \"createUser\"){\n    createUser = msg;\n}\n\nreturn [createUser, editUser,other];","outputs":3,"noerr":0,"x":2990,"y":480,"wires":[["b4ce0864.df5ff8"],["83d98346.a867"],["f6529164.ebcee"]],"outputLabels":["createUser","editUser","other"]},{"id":"83d98346.a867","type":"function","z":"2294209a.0c95b","name":"Set Form Data","func":"// Get libraries\nconst Moment = global.get('moment');\nconst MomentRange = global.get('momentrange');\nconst moment = MomentRange.extendMoment(Moment)\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting'); \nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\n\nfindObj = {\n                    query : {\n                            query :{user:new ObjectID(msg.RevotioData.PostData.actionType.data.appUserId) }, \n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'user_accounts',\n                    operation:'findOne',\n                    }\n\n            mongodbTools.resolveAsync(findObj, node, function(res){\n                   msg.RevotioData.FlowData.Form = {\n                        FormType : \"User\",\n                        FormActionType : \"Edit\",\n                        FormData:res\n                    };\n                    node.send(msg) \n            })   \n","outputs":1,"noerr":0,"x":3400,"y":440,"wires":[["a59768fe.a6a258"]]},{"id":"f6529164.ebcee","type":"function","z":"2294209a.0c95b","name":"update appuseraccounts && remove user sessions of user","func":"// Get libraries\nconst Moment = global.get('moment');\nconst MomentRange = global.get('momentrange');\nconst moment = MomentRange.extendMoment(Moment)\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting'); \nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\n\n    updateSessions = {\n                   query : {\n                            query : {\"UserData._id\": new ObjectID(msg.RevotioData.PostData.actionType.data.appUserId)},\n                            // update: {\"$set\": {blockAccount: true}},\n                            // options: {upsert: true}\n                        },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'sessions',\n                    operation:'deleteMany',\n                    }\n\n            mongodbTools.resolveAsync(updateSessions, node, function(res){\n\n                node.send(msg);\n\n                    \n            }) \n","outputs":1,"noerr":0,"x":3540,"y":520,"wires":[["8479f9e2.fa6c9"]]},{"id":"1dea56ab.df6ad9","type":"link out","z":"2294209a.0c95b","name":"","links":["5db440a.6f3ea4"],"x":4355,"y":480,"wires":[]},{"id":"8479f9e2.fa6c9","type":"function","z":"2294209a.0c95b","name":"Update appusers collection","func":"// Get libraries\nconst Moment = global.get('moment');\nconst MomentRange = global.get('momentrange');\nconst moment = MomentRange.extendMoment(Moment)\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting'); \nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\n\n               \nvar query , noQuery, removeUser;\n\n\nif (msg.RevotioData.PostData.actionType.type === \"resetPassword\"){\n    \n    \n    msg.operation = 'updateOne'\n    msg.payload = [{_id: new ObjectID(msg.RevotioData.PostData.actionType.data.appUserId)},\n                   {\"$set\": {\"resetPassword\": true}},\n                   {upsert: true}\n                   ]\n    \n    msg.resetPassword = true\n                                // updateQuery = {\n                                //       query : {\n                                //                 query : {_id: new ObjectID(msg.RevotioData.PostData.actionType.data.appUserId)},\n                                //                 update: {\"$set\": {\"resetPassword\": true}},\n                                //                 options: {upsert: true}\n                                //             },\n                                //         connection:global.get(\"DB_data.connection\"),\n                                //         database:global.get(\"DB_data.appDB\"),\n                                //         collection:'users',\n                                //         moperation:'updateOne',\n                                //         }\n                    \n                                // mongodbTools.resolveAsync(updateQuery, node, function(res){\n                                       \n                                       \n                                // })   \n                       query = msg\n} else if (msg.RevotioData.PostData.actionType.type === \"blockAccount\"){\n    \n    msg.operation = 'updateOne'\n    msg.payload = [{_id: new ObjectID(msg.RevotioData.PostData.actionType.data.appUserId)},\n                   {\"$set\": {\"blockAccount\": true}},\n                   {upsert: true}\n                   ]\n    \n    // updateQuery = {\n    //               query : {\n    //                         query : {_id: new ObjectID(msg.RevotioData.PostData.actionType.data.appUserId)},\n    //                         update: {\"$set\": {blockAccount: true}},\n    //                         options: {upsert: true}\n    //                     },\n    //                 connection:global.get(\"DB_data.connection\"),\n    //                 database:global.get(\"DB_data.appDB\"),\n    //                 collection:'users',\n    //                 operation:'update',\n    //                 }\n\n    //         mongodbTools.resolveAsync(updateQuery, node, function(res){\n                   \n    //                 node.send(msg) \n    //         })   \n    \n    query = msg\n} else if (msg.RevotioData.PostData.actionType.type === \"unBlockAccount\"){\n    \n    msg.operation = 'updateOne'\n    msg.payload = [{_id: new ObjectID(msg.RevotioData.PostData.actionType.data.appUserId)},\n                   {\"$set\": {\"blockAccount\": false, loginAttempts : 0}},\n                   {upsert: true}\n                   ]\n    \n    // updateQuery = {\n    //               query : {\n    //                         query : {_id: new ObjectID(msg.RevotioData.PostData.actionType.data.appUserId)},\n    //                         update: {\"$set\": {blockAccount: true}},\n    //                         options: {upsert: true}\n    //                     },\n    //                 connection:global.get(\"DB_data.connection\"),\n    //                 database:global.get(\"DB_data.appDB\"),\n    //                 collection:'users',\n    //                 operation:'update',\n    //                 }\n\n    //         mongodbTools.resolveAsync(updateQuery, node, function(res){\n                   \n    //                 node.send(msg) \n    //         })   \n    \n    query = msg\n}else if (msg.RevotioData.PostData.actionType.type === \"closeUserSessions\"){\n    noQuery = msg\n            // node.send(msg) \n} else if (msg.RevotioData.PostData.actionType.type === \"removeUser\"){\n    removeUser = msg\n            // node.send(msg) \n} \n// msg.type = msg.RevotioData.PostData.actionType.type\n\n\nreturn [query , noQuery, removeUser];","outputs":3,"noerr":0,"x":3880,"y":520,"wires":[["35b3b956.affe26"],["1dea56ab.df6ad9"],["6535b938.767ac8"]],"outputLabels":["query , ","noQuery","removeUser"]},{"id":"115dbd4f.d83e53","type":"function","z":"aec22158.fe4e38","name":"Check if account is blocked / password reset is needed","func":"// var crypto = require('crypto');\n\nvar blocked, passwordReset, valid;\n\n\nif (msg.payload.hasOwnProperty(\"blockAccount\") && msg.payload.blockAccount === true ){\n\n   blocked = msg;\n} else if (msg.payload.hasOwnProperty(\"resetPassword\") && msg.payload.resetPassword === true ){\n\n   passwordReset = msg;\n}\nelse {\n    valid = msg;\n}\n\n\n\nreturn [blocked, passwordReset, valid];","outputs":3,"noerr":0,"x":2305,"y":359.99999618530273,"wires":[["5a842d37.e1cabc"],["e2aed4fb.2ddab8"],["62867a86.49ad5c"]],"outputLabels":["blocked","passwordReset","valid"]},{"id":"bdf7ba4.ba0e548","type":"link out","z":"aec22158.fe4e38","name":"","links":["e158a3eb.e1806","4ac73054.2df2a","1766e26.2df601e","15f8aeef.16f7d1","ec6395bb.05eb08","6510415f.c64d6","14c789ed.fd90f6","172bf3ee.b9865c","e6548cdd.b0501","43e1a714.c877a8","228b07a6.f5d6a8","101c6a60.58ca1e","b0f61403.73aa18","d6cfe34e.7be1d","2f3e87cf.a0111","5171869d.c0b8a8","ffc46262.694388","3356ae90.b06682","1f447df2.f79d1a","84cfac4f.42a868","3a82fd2b.90627a","4809e15c.231538","4675a1ec.757c6","82336b76.b7c958","b824f5cf.104838","6a1ab5fc.dff14c","692c6501.32656c","14264b85.6baf9c","e358d072.f3562","6cc00ce9.6960a4"],"x":2870,"y":279.99999618530273,"wires":[]},{"id":"40baac37.1b872c","type":"comment","z":"aec22158.fe4e38","name":"ERROR","info":"","x":2910,"y":240,"wires":[]},{"id":"e2aed4fb.2ddab8","type":"function","z":"aec22158.fe4e38","name":"Redirect to reset password","func":"// Prepair redirect to chosen project\n\n           msg.payload = { \n               Page:'reset password', \n               RevotioData:{\n                   user: msg.payload._id\n               } \n            };\n        \n\n\nreturn msg;","outputs":1,"noerr":0,"x":2775,"y":319.99999618530273,"wires":[["b42e2891.03848"]]},{"id":"5a842d37.e1cabc","type":"function","z":"aec22158.fe4e38","name":"Prepair error response","func":"\nmsg.RevotioData.PostData.gadgetData.formObj.steps[0].fields[0].error =  {\n                                                                    msg: \"This account is blocked, please contact your administrator\"\n                                                                    };\n\nmsg.payload = {\n    \n    gadgetsList : [{\n            \"gadgetId\":  \"349a509d-e145-33a6-7888-e8906915b223\",\n            \"gadgetName\":  \"Login form\",\n            \"gadgetType\": \"custom-form\",\n            \"gadgetData\": msg.RevotioData.PostData.gadgetData.formObj}]\n    };\n\nreturn msg;","outputs":1,"noerr":0,"x":2755,"y":279.99999618530273,"wires":[["bdf7ba4.ba0e548"]]},{"id":"e80a67d5.4cc398","type":"function","z":"aec22158.fe4e38","name":"Set login attempt vars ","func":"msg.RevotioData.FlowData.Data.GadgetsSettings = {\n    loginAttempts : 0,\n    sessionTime: new Date()\n}\n\n\nreturn msg;","outputs":1,"noerr":0,"x":355,"y":379.99999618530273,"wires":[["cd8c7f3.154188"]]},{"id":"ff257da5.7a778","type":"function","z":"aec22158.fe4e38","name":"update appusers","func":"var request = global.get('request');\nvar Moment = global.get('moment');var MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\n// update    \n    updateObj = {\n                    query : {\n                            query :msg.query[0], \n                            update : msg.query[1],\n                            options : msg.query[2]\n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'users',\n                    operation:'update', // updateMany , updateOne\n                    }\n\n            mongodbTools.resolveAsync(updateObj, node, function(res){\n                    \n            })  \n            \n","outputs":1,"noerr":0,"x":2405,"y":259.99999618530273,"wires":[[]]},{"id":"30a67121.5f2ade","type":"function","z":"aec22158.fe4e38","name":"Check if passwords match","func":"var invalid, valid;\n\nif(String(msg.RevotioData.PostData.gadgetData.formData.passwordOne) === String(msg.RevotioData.PostData.gadgetData.formData.passwordTwo)  ){\n\n  valid = msg;\n}\nelse{\n  invalid =  msg;\n}\n\nreturn [invalid, valid];","outputs":2,"noerr":0,"x":2915,"y":839.9999961853027,"wires":[["40f939cd.5da32"],["42b3aebc.e049d"]],"outputLabels":["invalid, ","valid"]},{"id":"40f939cd.5da32","type":"function","z":"aec22158.fe4e38","name":"Prepair error response","func":"\nmsg.RevotioData.PostData.gadgetData.formObj.steps[0].fields[4].error =  {\n                                                                    msg: \"Passwords dont match\"\n                                                                    };\nmsg.RevotioData.PostData.gadgetData.formObj.steps[0].fields[5].error =  {\n                                                                    msg: \"Passwords dont match\"\n                                                                    };\nmsg.payload = {\n    \n    gadgetsList : [{\n            \"gadgetId\":  \"e947591f-f70b-84c4-c2f7-5a78178ad897\",\n            \"gadgetName\":  \"Reset password form\",\n            \"gadgetType\": \"custom-form\",\n            \"gadgetData\": msg.RevotioData.PostData.gadgetData.formObj}]\n    };\n\nreturn msg;","outputs":1,"noerr":0,"x":3215,"y":799.9999961853027,"wires":[["54156eec.b14a88"]]},{"id":"54156eec.b14a88","type":"link out","z":"aec22158.fe4e38","name":"","links":["e158a3eb.e1806","4ac73054.2df2a","1766e26.2df601e","15f8aeef.16f7d1","6510415f.c64d6","14c789ed.fd90f6","172bf3ee.b9865c","e6548cdd.b0501","43e1a714.c877a8","228b07a6.f5d6a8","101c6a60.58ca1e","b0f61403.73aa18","d6cfe34e.7be1d","2f3e87cf.a0111","5171869d.c0b8a8","ffc46262.694388","3356ae90.b06682","1f447df2.f79d1a","84cfac4f.42a868","3a82fd2b.90627a","4809e15c.231538","4675a1ec.757c6","82336b76.b7c958","b824f5cf.104838","6a1ab5fc.dff14c","692c6501.32656c","14264b85.6baf9c","e358d072.f3562","6cc00ce9.6960a4"],"x":3330,"y":799.9999961853027,"wires":[]},{"id":"9e3872b.987979","type":"comment","z":"aec22158.fe4e38","name":"ERROR","info":"","x":3385,"y":799.9999961853027,"wires":[]},{"id":"2e2842dc.490bae","type":"function","z":"aec22158.fe4e38","name":"Trigger disclamer modal","func":"msg.payload = { gadgetsList  : [ {\n            \"gadgetId\":  \"8a3a24ef-ccca-adbd-1cfb-4ab4f0283040\",\n            \"gadgetName\": \"disclamer modal\",\n            \"gadgetType\": \"dynamic-modal\",\n            \"gadgetData\": {\n                                \"modalStatus\":\"show\",\n                                \"displayTime\" : 5\n                                \n            },\n    gadgetOptions: {clickOutsideToClose : true}\n},\n            {\n                                        gadgetId: '296015e1-21c9-b349-ef7a-89cf44d02114',\n                                        gadgetName: 'general disclaimer info',\n                                        gadgetType: 'dynamic-text-area',\n                                        gadgetData: {\n                                        data: [{\n                                            label: \"Disclamer\",\n                                            value: \"Voorafgaand aan het aanmelden wordt aan de gebruiker een melding getoond dat alleen geautoriseerd gebruik is toegestaan voor expliciet door de organisatie vastgestelde doeleinden.\",\n                                            // options: textFieldOptions\n                                            },\n                                            // {\n                                            // label:  \"Password\",\n                                            // value: resetPassword ,\n                                            // // options: textFieldOptions\n                                            // },\n                                            // {\n                                            // label:  \"Account\",\n                                            // value: blockAccountName,\n                                            // // options: textFieldOptions\n                                            // },\n                                            // {\n                                            // label:  \"Last login\",\n                                            // value: moment(item.login).format(\"dddd, MMMM Do YYYY, h:mm:ss a\") ,\n                                            // // options: textFieldOptions\n                                            // },\n                                            // {\n                                            // label:  \"\",\n                                            // value: msg.settings[lodash.findIndex(msg.settings, {_id:new ObjectID(msg.loopData.payload.department) })].Name,\n                                            // options: textFieldOptions}\n                                            ],\n                                        options:global.get(\"gadgetObjects['dynamic-text-area'].options\")\n                                        }\n                                    }]};\n\n\nreturn msg;","outputs":1,"noerr":0,"x":765,"y":299.99999618530273,"wires":[["af92a9f3.f2eab"]]},{"id":"7063f25b.94df04","type":"link in","z":"aec22158.fe4e38","name":"user authentication - Custom login form Gadget","links":["cd8c7f3.154188"],"x":650,"y":299.99999618530273,"wires":[["2e2842dc.490bae"]]},{"id":"af92a9f3.f2eab","type":"link out","z":"aec22158.fe4e38","name":"","links":["1766e26.2df601e","15f8aeef.16f7d1","ec6395bb.05eb08","6510415f.c64d6","14c789ed.fd90f6","172bf3ee.b9865c","e6548cdd.b0501","43e1a714.c877a8","228b07a6.f5d6a8","101c6a60.58ca1e","b0f61403.73aa18","d6cfe34e.7be1d","2f3e87cf.a0111","5171869d.c0b8a8","ffc46262.694388","3356ae90.b06682","1f447df2.f79d1a","84cfac4f.42a868","3a82fd2b.90627a","4809e15c.231538","4675a1ec.757c6","82336b76.b7c958","b824f5cf.104838","6a1ab5fc.dff14c","692c6501.32656c","14264b85.6baf9c","e358d072.f3562","6cc00ce9.6960a4","44daecc2.e5b2f4"],"x":890,"y":299.99999618530273,"wires":[]},{"id":"704d4000.20aee","type":"function","z":"45759581.11da84","name":"create element list","func":"// Get libraries\nconst Moment = global.get('moment');\nconst MomentRange = global.get('momentrange');\nconst moment = MomentRange.extendMoment(Moment);\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting'); \nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar fs = global.get('fsextra');\n\n\nif (msg.RevotioData.session.UserData.hasOwnProperty(\"avatar\") && fs.existsSync( msg.RevotioData.session.UserData.avatar)){\n    avatar = msg.RevotioData.session.UserData.avatar\n\n} else {\n    avatar = global.get(\"DomainProperties.filesFolder\") +   \"SystemFiles/icons/user.png\"\n\n}\n\nAvatarBTN =  {\n            \"gadgetId\": \"487c2730-43f3-3870-dd7d-60464b992f19\",\n            \"gadgetName\":\"Settings btn\",\n            \"gadgetType\":\"dynamic-btn\",\n            'gadgetData' :\"topbarBTN_action\",\n            \"gadgetOptions\": {\n                            types:['image'],\n                            imageUrl:  global.get(\"functions.fileManagement\")( avatar, avatar ,msg.RevotioData.session._id, \"copySync\"), // source, destination, operation global.get(\"DomainProperties.url\") + msg.RevotioData.session.UserData.avatar,\n                            filePath :avatar,\n                            styles:[' img-small' ,'img-circle' ], //'img-rounded'\n                            buttonalign:'left', \n                            textcolor:'black', \n                            buttonlabel:msg.RevotioData.session.UserData.first_name + \" \" + msg.RevotioData.session.UserData.last_name + \" settings\", \n                            action:\"topbarBTN_action\" // starts under app-academicprojects\n                        },// icon:{type:'fa fa-plus', align:'left'}\n                    };\n// var btn =   {            \n//                   \"gadgetId\": \"487c2730-43f3-3870-dd7d-60464b992f19\",\n//                     \"gadgetName\":\"Settings btn\",\n//                     \"gadgetType\":\"dynamic-btn\",\n//                     \"gadgetOptions\":\n//                         {\"types\":\"\",\n//                         \"styles\":[\"btn-embossed\",\n//                          \"btn-square\",'btn-success' ],\n//                         \"buttonalign\":\"right\",\n//                         \"textcolor\":\"black\",\n//                         \"buttonlabel\":msg.RevotioData.session.UserData.first_name + \" \" + msg.RevotioData.session.UserData.last_name + \" settings\"},\n//                         \"gadgetData\":{_id : msg.RevotioData.session.UserData._id}\n                               \n//             } \n\nvar textOptions = {}\n_.each(global.get(\"gadgetObjects['dynamic-text-area'].options\"), function(value, key){\n    textOptions[key] = value\n})\n\n\ntextOptions[\"label-position\"] = 'left' ;\ntextOptions[\"value-margin-right\"] = '30px' ;\ntextOptions[\"value-font-size\"] = '12px' ;\n \n \ntextOptions[\"label-margin-right\"] = '5px' ;\ntextOptions[\"label-font-size\"] = '12px' ;\n\ntextOptions[\"font-size\"] = '20px' ;\n \n \ntextOptions[\"label-margin-bottom\"] = 0 ;\n\ntextOptions[\"display\"] = 'left' ;\n\nvar text = {\n                                        gadgetId: '3bb9eb3b-f65b-055b-5172-2939d7900ee1',\n                                        gadgetName: 'topbar text',\n                                        gadgetType: 'dynamic-text-area',\n                                        gadgetData: {\n                                        data: [{\n                                            label: \"Last login\",\n                                            value: moment(msg.RevotioData.session.UserData.previousLogin).format(\"dddd, MMMM Do YYYY, h:mm:ss a\") ,\n                                            options: textOptions //{}\n                                            },\n                                            // {\n                                            // label:  \"Password\",\n                                            // value: resetPassword ,\n                                            // // options: textFieldOptions\n                                            // },\n                                            // {\n                                            // label:  \"Account\",\n                                            // value: blockAccountName,\n                                            // // options: textFieldOptions\n                                            // },\n                                            // {\n                                            // label:  \"Last login\",\n                                            // value: moment(item.login).format(\"dddd, MMMM Do YYYY, h:mm:ss a\") ,\n                                            // // options: textFieldOptions\n                                            // },\n                                            // {\n                                            // label:  \"\",\n                                            // value: msg.settings[lodash.findIndex(msg.settings, {_id:new ObjectID(msg.loopData.payload.department) })].Name,\n                                            // options: textFieldOptions}\n                                            ],\n                                        options:textOptions\n                                        }}\n\nvar design = {\n    // '01c6230e-6316-840f-76d7-967523d89e1e': { \n    //         'background-color': '#1D2531',\n    //     // 'background-image': 'url(\"https://img.freepik.com/free-vector/grey-linen-texture-background_1053-253.jpg?size=338c&ext=jpg\")',\n    //     // 'background-repeat': 'repeat',\n    //       'position': '-webkit-sticky',  /* Safari */\n    //         'position': 'sticky',\n    //       'top': 0,\n    //       'z-index': 1,\n    //     },\n    // \"96d3bda5-ec96-00c3-d10e-7ce43b9b92a0\" : { \n    //         // 'background-color': '#f1f1f1',\n    //         'border': '1px solid rgba(0, 0, 0, 0.05)',\n    //         'margin-bottom': '10px',\n    //         'box-shadow': '0 6px 20px 0 rgba(0, 0, 0, 0.19)',\n    //         // \"background-image\" : 'url(\"http://wtctwente.nl/wp-content/uploads/2015/03/WTCTwente_PNO_Consultants_logo2.png\")',\n    //         'background-repeat': 'no-repeat',\n    //         'background-image': 'url(\"https://upload.wikimedia.org/wikipedia/commons/d/d1/Xmas_tree.svg\")',\n    //         // 'transform': 'scale(0.8)'\n    //     },\n    // // \"01c6230e-6316-840f-76d7-967523d89e1e\":{\n    // //     'background-color': '#1D2531',\n    // //     // 'background-image': 'url(\"https://img.freepik.com/free-vector/grey-linen-texture-background_1053-253.jpg?size=338c&ext=jpg\")',\n    // //     // 'background-repeat': 'repeat',\n    // //       'position': '-webkit-sticky',  /* Safari */\n    // //         'position': 'sticky',\n    // //       'top': 0,\n    // //       'z-index': 1,\n    // // }\n}\n// var designObj = \n   \nmsg.topbar  =  [text, design, AvatarBTN, ]\n                                    \nreturn msg;","outputs":1,"noerr":0,"x":1630,"y":1620,"wires":[[]]},{"id":"c36f0764.45994","type":"function","z":"e5822137.be45d","name":"Topbar item container","func":"msg.payload = { gadgetsList : [{            \n                   \"gadgetId\": \"43e53616-0ad3-eacd-e865-1342e2b07000\",\n                   \"gadgetName\": \"topbar\",\n                    \"gadgetType\":\"revotio-custom-item-container\",\n                    \"gadgetData\": msg.topbar,\n                    \"gadgetOptions\" :{\n                        // Type: \"multip\" , // \"multiple\"\n                        // SubType :\"horizontal\" , // }\n                                    }\n                    },]}\n                    \n                    \nreturn msg;","outputs":1,"noerr":0,"x":1580,"y":400,"wires":[["b4a3b5aa.487f6"]]},{"id":"31c0c3b7.aaf214","type":"function","z":"2294209a.0c95b","name":"Topbar item container","func":"msg.payload = { gadgetsList : [{            \n                   \"gadgetId\": \"a2d41bb0-afa1-ad0d-af63-b5443df2fc7a\",\n                   \"gadgetName\": \"topbar\",\n                    \"gadgetType\":\"revotio-custom-item-container\",\n                    \"gadgetData\": msg.topbar,\n                    \"gadgetOptions\" :{\n                        // Type: \"multip\" , // \"multiple\"\n                        // SubType :\"horizontal\" , // }\n                                    }\n                    },]}\n                    \n                    \nreturn msg;","outputs":1,"noerr":0,"x":1620,"y":680,"wires":[["1bc869a3.7eb996"]]},{"id":"38d35469.c1aa9c","type":"subflow:45759581.11da84","z":"2294209a.0c95b","name":"","env":[],"x":1470,"y":680,"wires":[["31c0c3b7.aaf214"]]},{"id":"1bc869a3.7eb996","type":"link out","z":"2294209a.0c95b","name":"","links":["5185c631.530a58","cb87250c.966108","112320ff.7cff6f","d230180f.f3d19","e7f2e3d2.30705","ebf87699.c97f08","98813d9e.bcf0d","90045e69.ebd138","dd373359.040c4","ecd0ecf2.99d41","93aa962f.3144d","e5823b9b.d200f","dda61270.476b9","f0eeb60f.091b78","359e3b04.860634","dc6abb7.ed83248","ff0e6248.29e22","1cff0ac1.dc8705","147f3fb7.690568","f42bf06.8974d1","ef55a0fd.6d311","552f5d9b.570784","498662dd.42a45c","81c0cf07.5ef198","44daecc2.e5b2f4","cb902343.5f03a","e34f6cc2.af5ad8","480dae32.8a339"],"x":1735,"y":680,"wires":[]},{"id":"77ece62a.01347","type":"link in","z":"2294209a.0c95b","name":"users global = ACC Gagdet","links":["aea25a8a.fa4a58"],"x":1415,"y":680,"wires":[["38d35469.c1aa9c"]]},{"id":"4468c444.53ac84","type":"function","z":"4cbbc60.828563c","name":"Set application parameters","func":"// Get libraries\nconst Moment = global.get('moment');\nconst MomentRange = global.get('momentrange');\nconst moment = MomentRange.extendMoment(Moment);\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar fs = global.get('fsextra');\n\n//  global.set(\"INIT\", false);\nmsg.INIT = {\n    APP_ID : env.get(\"APP_ID\"),\n    TYPE   : env.get(\"TYPE\"),\n        APP_ID2 : env.get(\"-APP_ID\"),\n    TYPE2   : env.get(\"-TYPE\")\n};\nmsg.INIT.contextState = global.get(\"INIT\")\n\n// if (msg.INIT.hasOwnProperty(\"contextState\") === false || msg.INIT.contextState !== true){\n\n        global.set(\"applicationId\",  env.get(\"APP_ID\"));\n        global.set(\"env\",  {APP_ID:  env.get(\"APP_ID\"), TYPE:  env.get(\"TYPE\")});\n        var globalContextData  =  fs.readdirSync(\"./projects/gadgetsFactory/globalContextData\");\n        _.each(globalContextData, function(Item , index){\n            if (Item === 'generic.json' ||Item === env.get(\"TYPE\")+'.json'){\n                _.each(JSON.parse(fs.readFileSync(\"./projects/gadgetsFactory/globalContextData/\" + Item)), function(globalContextItem, globalContextItemKey){\n                    global.set(globalContextItemKey, globalContextItem);\n                });\n            }\n        });\n        \n        global.set(\"INIT\", true);\n        msg.payload = \"CONTEXT <<<< \" + env.get(\"TYPE\") + \" >>> done\";\n\n// }\n\n\nreturn msg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":480,"y":180,"wires":[[]]},{"id":"ce4931e.2eadfd","type":"function","z":"4cbbc60.828563c","name":"Global context functions","func":"// Get libraries\nconst Moment = global.get('moment');\nconst MomentRange = global.get('momentrange');\nconst moment = MomentRange.extendMoment(Moment)\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting'); \nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\n\nglobal.set(\"functions\" ,{lastChange : new Date()})\n\nnumberToAlphabet = function(val) {\n\n    return (val + 9).toString(36).toUpperCase()\n};\nglobal.set(\"functions.numberToAlphabet\" ,numberToAlphabet)\n\n// get Data\n// global.get(\"functions.dataTableObject\")(dataTableObject, columns, data, buttons) \ndataTableObject =  function(dataTableObject, columns, data, buttons) {\n    // Get libraries\n    const Moment = global.get('moment');\n    const MomentRange = global.get('momentrange');\n    const moment = MomentRange.extendMoment(Moment)\n    var momentTimezone = global.get('moment_timezone');\n    var lodash = global.get('lodash');\n    var _ = global.get('underscore');\n    var BSON = global.get('bson');\n    var ObjectID = BSON.ObjectID;\n    var accounting = global.get('accounting'); \n    var accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\n  \n    \n    // validate inputs\n    \n    if ( typeof dataTableObject !== 'object'                ||\n            dataTableObject.hasOwnProperty(\"gadgetId\")      ||\n            dataTableObject.hasOwnProperty(\"gadgetName\")    ||\n            dataTableObject.hasOwnProperty(\"gadgetType\")    ||\n            dataTableObject.hasOwnProperty(\"gadgetData\")    ||\n            dataTableObject.hasOwnProperty(\"gadgetOptions\") ){\n        return dataTableObject\n    }\n    else if ( Array.isArray(columns) === false){\n        return dataTableObject\n    }\n    else if ( Array.isArray(data) === false ){\n        return dataTableObject\n    }\n    else {\n    var tableColumnData  =  { \n         \"columnHead\" : columns,\n          \"columnOptions\": {\n            \"columnStyle\": {\n              \"width\": \"30%\"\n            },\n            \"cellStyle\": {\n            //   \"color\": \"red\"\n            },\n            \"allowSort\": true\n          }\n        };\n    \n    // generate rows\n    var tableRowData = []\n            _.each(data, function(dataItem, dataIndex){\n                \n                obj = {\n                       \"rowData\" :[],\n                               \"rowOptions\": {\n                               //   \"state\": \"warning\",\n                                 \"globalClick\": true,\n                                 \"style\": {\n                                   \"width\": \"20%\"\n                                 }\n                               },\n                       }\n                 _.each(columns, function(columnsItem, columnsIndex){\n                        if ( columnsItem.hasOwnProperty('headKey') && dataItem.hasOwnProperty(columnsItem.headKey)\n                            ){\n                              obj.rowData.push({\n                                   \"data\"    : dataItem[columnsItem.headKey],\n                                   \"type\"    : typeof(dataItem[headKey]),\n                                   \"headKey\" : columnsItem.headKey,\n                                   \"hidden\"  : false,\n                                   \"editable\": false\n                              })\n                            }\n            })\n            \n            tableRowData.push(obj)\n        })\n        \n    // define paged value\n    if (tableRowData.length > 10 ){\n        paged = 10;\n    } else {\n        paged = tableRowData.length;\n    }\n    \n    dataTableObject.gadgetOptions = {\n                                          \"allowSearch\": true,\n                                          \"maxItems\": paged,\n                                          \"striped\": true,\n                                          \"export\": true\n                                        };\n    dataTableObject.gadgetData.tableColumnData  =  tableColumnData;\n    dataTableObject.gadgetData.tableRowData     =  tableRowData;\n    // dataTableObject.gadgetData.tableButton =  tableButton;\n    \n    \n    return dataTableObject\n  }\n    \n    }\nglobal.set(\"functions.dataTableObject\" ,dataTableObject)\n\n\nis_dir = function(path) {\n     var fs = global.get('fsextra');\n                            try {\n                                var stat = fs.lstatSync(path);\n                                return stat.isDirectory();\n                            } catch (e) {\n                                // lstatSync throws an error if path doesn't exist\n                                return false;\n                            }\n                        }\nglobal.set(\"functions.is_dir\" ,is_dir)\n\n\nsyncDirlist = function(path) {\n            \n            if (path.substr(path.length - 1) !== \"/\" ){\n                path = path +\"/\"\n            }\n            \n            var _ = global.get('underscore');\n            var fs = global.get('fsextra');\n            var responseObj = { \n                                    path : path,\n                                    parent:{\n                                        filePath : path,\n                                        absolutePath : path,\n                                        isDirectory : global.get(\"functions.is_dir\")(path)\n                                    },\n                                }\n            if (!responseObj.parent.isDirectory){\n                  responseObj.parent.isFile = true\n                 responseObj.parent.type = \"file\" \n            } else if ( responseObj.parent.isDirectory){\n                responseObj.parent.type = \"dir\" \n            }\n           \n        \n        \n        if (responseObj.parent.isDirectory){\n            responseObj.child = []\n            _.each(fs.readdirSync(responseObj.parent.absolutePath), function(item, index){\n                if (item.substr(0,1) !== \".\"){\n                    \n                \n                Obj ={\n                    filePath : item,\n                    absolutePath : responseObj.parent.absolutePath+item +\"/\",\n                    isDirectory : global.get(\"functions.is_dir\")(responseObj.parent.absolutePath+item +\"/\"),\n                }\n                \n                if (!Obj.isDirectory){\n                     Obj.isFile = true\n                     Obj.type = \"file\" \n                } else if ( Obj.isDirectory){\n                    Obj.type = \"dir\" \n                    // Obj.child = global.get(\"functions.syncDirlist\")(Obj.absolutePath)\n                }\n                \n                responseObj.child.push(Obj)\n                   \n                }\n            })\n        } \n        return responseObj;\n}\n\nglobal.set(\"functions.syncDirlist\" ,syncDirlist)\n\n//es5\ncapitalize = function capitalize(string) {\n    return string.slice(0,1).toUpperCase() + string.slice(1).toLowerCase();\n}\nglobal.set(\"functions.capitalize\" ,capitalize)\n\n// get file extention function\n\ngetExtension = function(filename) {\n    var i = filename.lastIndexOf('.');\n    return (i < 0) ? '' : filename.substr(i);\n}\nglobal.set(\"functions.getExtension\" ,getExtension)\n\n\n// get Data\ndaysYear =  function(year) {\n  return global.get(\"functions.isLeapYear\")(year) ? 366 : 365;\n}\nglobal.set(\"functions.daysYear\" ,daysYear)\n\nisLeapYear = function (year) {\n     return year % 400 === 0 || (year % 100 !== 0 && year % 4 === 0);\n}\nglobal.set(\"functions.isLeapYear\" ,isLeapYear)\n\nformatFunction = function(inner){\n    if (inner.length > -1 ){\n        var i;\n        for (i = 0; i < inner.length; i++) {\n             if (inner[i].inner.length > -1){\n                        inner[i].inner = global.get(\"functions.formatFunction\")(inner[i].inner)\n                    } \n            if (inner[i].keys.length > -1){\n                var x;\n                for (x = 0; x < inner[i].keys.length; x++) {\n                            var ObjectKeys = Object.keys(inner[i].keys[x].values)\n                            var y;\n                            for (y = 0; y < ObjectKeys.length; y++) {\n                                 if (\n                                     ObjectKeys[y] !== \"Amount\" && \n                                     ObjectKeys[y] !== \"Number\" &&\n                                     ObjectKeys[y] !== \"Transactions\" &&\n                                     ObjectKeys[y] !== \"Categories\" &&\n                                     ObjectKeys[y] !== \"Work packages\" &&\n                                     ObjectKeys[y] !== \"Projects\" &&\n                                     ObjectKeys[y] !== \"Project\" &&\n                                     ObjectKeys[y] !== \"Memberships\" &&\n                                     ObjectKeys[y] !== \"Employee's\" &&\n                                     ObjectKeys[y] !== \"Users\" &&\n                                     ObjectKeys[y] !== \"Events\" &&\n                                     ObjectKeys[y] !== \"To do\" &&\n                                     ObjectKeys[y] !== \"Processed\" &&\n                                     ObjectKeys[y] !== \"FTE\" &&\n                                     isNaN(inner[i].keys[x].values[ObjectKeys[y]]) === false){\n                                   inner[i].keys[x].values[ObjectKeys[y]] = accounting.formatMoney(inner[i].keys[x].values[ObjectKeys[y]], accountingoptions );\n                                } else  if ((ObjectKeys[y] === \"Amount\" || ObjectKeys[y] === \"Number\") && isNaN(inner[i].keys[x].values[ObjectKeys[y]]) === false){\n                                    inner[i].keys[x].values[ObjectKeys[y]] = Math.round(Number(inner[i].keys[x].values[ObjectKeys[y]])*100)/100;\n                                }\n                            }\n                }\n            } \n        }\n    }\n    return inner;\n};\n\nglobal.set(\"functions.formatFunction\" ,formatFunction)\n\n\ndepartmentConversion =  function(value, type, departments) {\n        \n        var lodash = global.get('lodash');\n        var _ = global.get('underscore');\n        var BSON = global.get('bson');\n        var ObjectID = BSON.ObjectID;\n        \n        if (type === \"id\"){\n         if (value === \"ConservationBiology\" || value === \"Conservation biology\" || value === \"CB\"){\n                    return lodash.find(departments,{name: \"Conservation biology\"})._id\n                   \n                }\n         else if (value === \"EnvironmentalBiology\" || value === \"Environmental Biology\" || value === \"EB\"){\n                    return lodash.find(departments,{name: \"Environmental Biology\"})._id\n                   \n                }\n        else if (value === \"Central\"){\n                    return lodash.find(departments,{name: \"Central\"})._id\n                   \n                    \n         } else  if (value === \"IndustrialEcology\" || value === \"Industrial Ecology\"|| value === \"IE\"){\n                        return lodash.find(departments,{name: \"Industrial Ecology\"})._id\n                       \n                }\n                \n                // return DepartmentObj._id\n        } else if (type === \"name\"){\n            \n            Dept = lodash.find(departments,{_id: new ObjectID(value)})\n            if (Dept){\n                return Dept.name\n            } else {\n                 return \"No department found\"\n            }\n            \n            \n            \n            // _.each(departments, function(Item, Index){\n            //     return {value:value, type:type, departments:departments, Item:Item,Index:Index }\n            //         if (String(Item._id) === String(value) ){\n            //               return Item.Name\n            //         }\n            // })\n            \n        }\n\n    \n}\nglobal.set(\"functions.departmentConversion\" ,departmentConversion)\n\n\nformOptions =  function(array, key, value, type, groupKey,  groupKeyArray, groupKeyArrayKey, groupKeyArrayValue) { \n    \n        var lodash = global.get('lodash');\n        var _ = global.get('underscore');\n        var Moment = global.get('moment');\n        var MomentRange = global.get('momentrange');\n        var moment = MomentRange.extendMoment(Moment);\n        \n        if (Array.isArray(array) === false ||  array.length <= 0){\n          output =  \"array is not an array or has no elements\";  \n        }\n           \n        else if (key === undefined || typeof key !== 'string'){\n               output =  \"key must be present and a string\";\n        }\n        else if (value === undefined || typeof value !== 'string'){\n               output = \"value must be present and a string\";\n           }\n        else if (type === undefined || typeof type !== 'string' || (type !== 'select' &&  type !== 'opt-group')){\n               output = \"type must be present and a string && === select || === opt-group\";} \n        else {\n            \n               \n              if (type === 'select'){\n                   output = {};\n                   \n                   _.each(array, function(Item, Index){\n                       \n                        if (Item.hasOwnProperty(key) && Item.hasOwnProperty(value) ){\n                          output[Item[key]] = Item[value];\n                        } else {\n                            output[\"ERROR \" + Index] = Item\n                        }\n                   })\n                   return output;\n              } \n              else if (type === 'opt-group') {\n                    \n                    if (Array.isArray(groupKeyArray) ){\n                        \n                        if ((groupKeyArrayKey === undefined || typeof groupKeyArrayKey !== 'string') || (groupKeyArrayValue === undefined || typeof groupKeyArrayValue !== 'string')  ){\n                             output =  \"If groupKeyArray presented, groupKeyArrayKey & groupKeyArrayValue is needed and should be type STRING\";\n                        } else {\n                            \n                            groupedArray = lodash.groupBy(array, groupKeyArrayKey);\n                            output = {};\n                            _.each(array , function(Item, Index){\n                                \n                                if (output.hasOwnProperty(groupedArray[Item[groupKey][0][groupKeyArrayValue]]) === false){\n                                    output[groupedArray[Item[groupKey][0][groupKeyArrayValue]]] = {};\n                                }\n                                \n                                output[groupedArray[Item[groupKey][0][groupKeyArrayValue]]][Item.key] = Item.value;\n                            });\n                        }\n               }\n           }\n        }\n    \n}\nglobal.set(\"functions.formOptions\" ,formOptions)\n    \nfileManagement =  function(source, destination, sessionId, operation) {\n        \n        var fs = global.get('fsextra');\n        var _ = global.get('underscore');\n        \n        if (!sessionId ){\n            return \"Required data not present (sessionId)\"\n        }\n        \n        // check if file exists\n        else if (!fs.existsSync(source)){\n            return \"Invalid source\"\n        }\n        \n        \n        else if (!operation || operation === \"copySync\"){\n                \n                if (!source||!destination){\n                     return \"Required data not present (source OR destination) \"\n                } \n                else {\n                            if (destination.slice(0,1) === \"/\"){\n                                newDestination = destination.slice(1)\n                                destination = newDestination\n                            }\n                            destinationFolder = \"\"\n                            _.each(destination.split(\"/\"), function(item , Index){\n                                if (Index +1 !== destination.split(\"/\").length ){\n                                    destinationFolder =  destinationFolder + \"/\" + item\n                                }\n                            })\n                      \n                           \n                            fs.mkdirsSync(String(global.get(\"DomainProperties.rootFolder\") + global.get(\"DomainProperties.filesFolder\") +  sessionId +  \"/TEMP/\" + destinationFolder).replace(/\\/{2}/g, \"/\"));\n                            \n                            fs.copySync(source, String(global.get(\"DomainProperties.rootFolder\") + global.get(\"DomainProperties.filesFolder\") +  sessionId +  \"/TEMP/\" + destination).replace(/\\/{2}/g, \"/\"))\n                    \n                            return global.get(\"DomainProperties.RootDomain\") +    String(global.get(\"DomainProperties.filesFolder\") +  sessionId +  \"/TEMP/\" + destination).replace(/\\/{2}/g, \"/\")\n                                                                              \n                } \n            \n        }\n                else if (!operation || operation === \"copySyncCore\"){\n                \n                if (!source||!destination){\n                     return \"Required data not present (source OR destination) \"\n                } \n                else {\n                            if (destination.slice(0,1) === \"/\"){\n                                newDestination = destination.slice(1)\n                                destination = newDestination\n                            }\n                            \n                      \n                            \n                            fs.copySync(source, global.get(\"DomainProperties.publicFolder\") + global.get(\"DomainProperties.filesFolder\") +  sessionId +  \"/TEMP/\" + destination)\n                    \n                            return global.get(\"DomainProperties.filesFolder\") +  sessionId +  \"/TEMP/\" + destination\n                    \n                }\n            \n        }\n        \n        else if (operation === \"emptyDirSync\")\n                {\n                    fs.emptyDirSync(global.get(\"DomainProperties.publicFolder\") + global.get(\"DomainProperties.filesFolder\") +sessionId + \"/TEMP\")\n                     return {state : 'success', message: \"emptyDirSync - \" + global.get(\"DomainProperties.publicFolder\") + global.get(\"DomainProperties.filesFolder\") +sessionId + \"/TEMP\"+ \" - Success\"}\n                   }\n        else if (operation === \"removeSync\")\n                {\n                    fs.removeSync(global.get(\"DomainProperties.publicFolder\") + global.get(\"DomainProperties.filesFolder\") +sessionId)\n                    return {state : 'success', message: \"removeSync - \" + global.get(\"DomainProperties.publicFolder\") + global.get(\"DomainProperties.filesFolder\") +sessionId + \"/TEMP\"+ \" - Success\"}\n                \n                }\n                \n    \n        else if (operation === \"initSessionFolder\"){\n            \n            fs.ensureDirSync(global.get(\"DomainProperties.publicFolder\") + global.get(\"DomainProperties.filesFolder\") )\n            fs.ensureDirSync(global.get(\"DomainProperties.publicFolder\") + global.get(\"DomainProperties.filesFolder\") + sessionId)\n            // fs.ensureDirSync(global.get(\"DomainProperties.publicFolder\") + sessionId + \"/SystemFiles\" )\n            fs.ensureDirSync(global.get(\"DomainProperties.publicFolder\") + global.get(\"DomainProperties.filesFolder\") + sessionId+ \"/TEMP\" )\n            \n            fs.copySync(global.get(\"DomainProperties.rootPath\") + \"/SystemFiles\" , global.get(\"DomainProperties.publicFolder\") +global.get(\"DomainProperties.filesFolder\") + \"/SystemFiles\" )\n            \n        }\n                \n       \n    \n}\nglobal.set(\"functions.fileManagement\" ,fileManagement)\n\n       \nformatTime = function (time) {\n    var _ = global.get('underscore');\n    //split startTime on \":\"\n    arr = time.split(\":\");\n    \n    newTime = \"\"\n    \n    _.each(arr, function(Item, index){\n        if (Item.length === 1){\n            newTime = newTime + \"0\"+Item\n        } else (\n            newTime = newTime +Item\n        )\n        \n        if (index === 0){\n           newTime = newTime + \":\" \n        }\n    \n    })\n    \n     return newTime;\n}\n\nglobal.set(\"functions.formatTime\" ,formatTime)\nglobal.set(\"functions.lastUpdate\" ,moment().format())\n// global.get(\"functions.fileManagement\")( source, destination, msg.RevotioData, operation) // source, destination, RevotioData, operation\nreturn msg;","outputs":1,"noerr":0,"x":470,"y":140,"wires":[[]]},{"id":"a206fa2f.9bb658","type":"link in","z":"aec22158.fe4e38","name":"User authentication design","links":["84671937.4d3118","e1c31a15.098aa8","c199e887.a6da4"],"x":90,"y":299.99999618530273,"wires":[["827557d5.fcca3"]]},{"id":"a836c292.d3afe","type":"http response","z":"aec22158.fe4e38","name":"","statusCode":"","headers":{},"x":545,"y":299.99999618530273,"wires":[]},{"id":"1c72090c.42333f","type":"function","z":"aec22158.fe4e38","name":"User authentication design","func":"msg.payload.design = \n{\n    \"0b8c4e59-5cc1-f8fe-7714-8d27013939ca\": {\n        \"flex\": \"1 1 0%\",\n        \"box-sizing\": \"border-box\"\n    },\n    \"429ffeb5-0560-0dbe-f639-19662ec25d8c\": {\n        \"width\": \"100%\",\n        \"padding\": \"0px 0px 0px 0px\",\n        \"margin\": \"0px\",\n        \"text-align\": \"left\",\n        \"flex-direction\": \"row\",\n        \"box-sizing\": \"border-box\",\n        \"overflow\": \"hidden\",\n        \"background\": \"url('https://images.unsplash.com/photo-1472289065668-ce650ac443d2?ixlib=rb-1.2.1&ixid=eyJhcHBfaWQiOjEyMDd9&auto=format&fit=crop&w=1350&q=80')\",\n        \"background-size\": \"cover\"\n    },\n    \"8a4f3f00-a4f7-0402-cf9d-05c293268ff0\": {\n        \"width\": \"400px\",\n        \"min-width\": \"400px\",\n        \"max-width\": \"400px\",\n        \"overflow\": \"hidden !important\",\n        \"overflow-anchor\": \"none\",\n        \"box-shadow\": \"0px 8px 10px -5px rgba(0, 0, 0, 0.2), 0px 16px 24px 2px rgba(0, 0, 0, 0.14), 0px 6px 30px 5px rgba(0, 0, 0, 0.12)\",\n        \"background-color\": \"#fff\",\n        \"padding\": \"33px\"\n    },\n    \"c952a30e-7d40-387c-26b3-dd231a2cdca3\": {\n        \"display\": \"none\"\n\n    },\n    \"100ab4f9-91ac-67ff-61d3-35c02540cdaa\": {\n        \"display\": \"none\"\n    }\n}\n// {\n//     // '9e859d4a-16d7-fcf7-9c79-b828bbf1d262': global.get('topbar_design') \n// //     '8a4f3f00-a4f7-0402-cf9d-05c293268ff0': {\n// // 'background-image': 'url(\"https://images.unsplash.com/photo-1472289065668-ce650ac443d2?ixlib=rb-1.2.1&ixid=eyJhcHBfaWQiOjEyMDd9&auto=format&fit=crop&w=1350&q=80\")',\n// //         // 'background-image': 'url(\"https://www.pnoconsultants.com/nl/wp-content/themes/pno/images/PNO-ouroffice.png\")',\n        \n// //         'background-repeat': 'no-repeat',\n// //         'background-size': 'cover',\n// //         'background-position': 'center center',\n// //         'border': '2px solid #6abf6b'\n// //     },\n//     \"0b8c4e59-5cc1-f8fe-7714-8d27013939ca\":{\n//         'background-image': 'url(\"https://images.unsplash.com/photo-1472289065668-ce650ac443d2?ixlib=rb-1.2.1&ixid=eyJhcHBfaWQiOjEyMDd9&auto=format&fit=crop&w=1350&q=80\")',\n//         // 'background-image': 'url(\"https://www.pnoconsultants.com/nl/wp-content/themes/pno/images/PNO-ouroffice.png\")',\n        \n//         'background-repeat': 'no-repeat',\n//         'background-size': 'cover',\n//         'background-position': 'center center',\n//     //     'border': '2px solid #6abf6b'\n//     },\n// }\n\n\nreturn msg;","outputs":1,"noerr":0,"x":395,"y":299.99999618530273,"wires":[["a836c292.d3afe"]]},{"id":"dd573c4c.643968","type":"link in","z":"aec22158.fe4e38","name":"User account activation - design","links":["b12e289c.d6ecc8","6d0913e4.ac8bbc","18c634ff.b1dad3"],"x":90,"y":859.9999961853027,"wires":[["c78d53d2.e65ff"]]},{"id":"3ae4ab64.9e2994","type":"http response","z":"aec22158.fe4e38","name":"","statusCode":"","headers":{},"x":625,"y":859.9999961853027,"wires":[]},{"id":"35a2a99e.50eb36","type":"function","z":"aec22158.fe4e38","name":"User account activation -  design","func":"msg.payload.design = \n{\n    \"117f1957-0ced-b87a-9f9e-950419047d14\": { // image \n        \"flex\": \"1 1 0%\",\n        \"box-sizing\": \"border-box\"\n    },\n    \"f9392e7b-875b-15d8-9a16-49c82081707b\": { // container \n        \"width\": \"100%\",\n        \"padding\": \"0px 0px 0px 0px\",\n        \"margin\": \"0px\",\n        \"text-align\": \"left\",\n        \"flex-direction\": \"row\",\n        \"box-sizing\": \"border-box\",\n        \"overflow\": \"hidden\",\n        \"background\": \"url('https://images.unsplash.com/photo-1472289065668-ce650ac443d2?ixlib=rb-1.2.1&ixid=eyJhcHBfaWQiOjEyMDd9&auto=format&fit=crop&w=1350&q=80')\",\n        \"background-size\": \"cover\"\n    },\n    \"fb9f31b6-9fc2-1a97-3c5e-eeb00e1edd5b\": { // form\n        \"width\": \"400px\",\n        \"min-width\": \"400px\",\n        \"max-width\": \"400px\",\n        \"overflow\": \"hidden !important\",\n        \"overflow-anchor\": \"none\",\n        \"box-shadow\": \"0px 8px 10px -5px rgba(0, 0, 0, 0.2), 0px 16px 24px 2px rgba(0, 0, 0, 0.14), 0px 6px 30px 5px rgba(0, 0, 0, 0.12)\",\n        \"background-color\": \"#fff\",\n        \"padding\": \"33px\"\n    },\n    \"c952a30e-7d40-387c-26b3-dd231a2cdca3\": {\n        \"display\": \"none\"\n\n    },\n    \"100ab4f9-91ac-67ff-61d3-35c02540cdaa\": {\n        \"display\": \"none\"\n    }\n}\n// {\n//     // '9e859d4a-16d7-fcf7-9c79-b828bbf1d262': global.get('topbar_design') \n// //     '8a4f3f00-a4f7-0402-cf9d-05c293268ff0': {\n// // 'background-image': 'url(\"https://images.unsplash.com/photo-1472289065668-ce650ac443d2?ixlib=rb-1.2.1&ixid=eyJhcHBfaWQiOjEyMDd9&auto=format&fit=crop&w=1350&q=80\")',\n// //         // 'background-image': 'url(\"https://www.pnoconsultants.com/nl/wp-content/themes/pno/images/PNO-ouroffice.png\")',\n        \n// //         'background-repeat': 'no-repeat',\n// //         'background-size': 'cover',\n// //         'background-position': 'center center',\n// //         'border': '2px solid #6abf6b'\n// //     },\n//     \"0b8c4e59-5cc1-f8fe-7714-8d27013939ca\":{\n//         'background-image': 'url(\"https://images.unsplash.com/photo-1472289065668-ce650ac443d2?ixlib=rb-1.2.1&ixid=eyJhcHBfaWQiOjEyMDd9&auto=format&fit=crop&w=1350&q=80\")',\n//         // 'background-image': 'url(\"https://www.pnoconsultants.com/nl/wp-content/themes/pno/images/PNO-ouroffice.png\")',\n        \n//         'background-repeat': 'no-repeat',\n//         'background-size': 'cover',\n//         'background-position': 'center center',\n//     //     'border': '2px solid #6abf6b'\n//     },\n// }\nreturn msg;","outputs":1,"noerr":0,"x":465,"y":859.9999961853027,"wires":[["3ae4ab64.9e2994"]]},{"id":"ce9cd56d.b714d","type":"link in","z":"aec22158.fe4e38","name":"two step authentication - design","links":["e16c485c.ea1fd8","f01f2b5d.c7323","c42395c9.e7a698"],"x":90,"y":1319.9999961853027,"wires":[["cb673224.c23b78"]]},{"id":"a8584b7c.1c2768","type":"http response","z":"aec22158.fe4e38","name":"","statusCode":"","headers":{},"x":605,"y":1319.9999961853027,"wires":[]},{"id":"1121a4d9.54acc3","type":"function","z":"aec22158.fe4e38","name":"two step authentication -  design","func":"\nreturn msg;","outputs":1,"noerr":0,"x":425,"y":1319.9999961853027,"wires":[["a8584b7c.1c2768"]]},{"id":"a885e943.ebfb1","type":"link in","z":"aec22158.fe4e38","name":"Reset password - design","links":["1eeb4e54.0acdd2","32d05b4.8adeca4","e98e6ae3.ce1128"],"x":90,"y":2119.9999961853027,"wires":[["c4b9da22.c433d8"]]},{"id":"42c09172.2ae508","type":"http response","z":"aec22158.fe4e38","name":"","statusCode":"","headers":{},"x":565,"y":2119.9999961853027,"wires":[]},{"id":"777344ad.7bee8c","type":"function","z":"aec22158.fe4e38","name":"Reset password -  design","func":"\nreturn msg;","outputs":1,"noerr":0,"x":405,"y":2119.9999961853027,"wires":[["42c09172.2ae508"]]},{"id":"ec952e8b.ee99","type":"link in","z":"e5822137.be45d","name":"organization global - design","links":["c98c548a.95f4b","ead712f3.5bdef8","5a5da070.ff4398"],"x":695,"y":320,"wires":[["c14b21e1.bdb88"]]},{"id":"df6d2863.899c68","type":"http response","z":"e5822137.be45d","name":"","statusCode":"","headers":{},"x":1270,"y":320,"wires":[]},{"id":"6953bde2.d417fc","type":"function","z":"e5822137.be45d","name":"organization global -  design","func":"msg.topbarContanerId =  \"9e859d4a-16d7-fcf7-9c79-b828bbf1d262\"\n// msg.payload.design = {}\n\n\nreturn msg;","outputs":1,"noerr":0,"x":1000,"y":320,"wires":[["bf03eb39.4bf4a8"]]},{"id":"7d1a67c6.b7534","type":"link in","z":"2294209a.0c95b","name":"users global - design","links":["bd06a339.36197","6860d9bc.c5f048","ff290d23.18df18"],"x":895,"y":380,"wires":[["d7e5d821.5a91a8"]]},{"id":"225467fa.c7f1f","type":"http response","z":"2294209a.0c95b","name":"","statusCode":"","headers":{},"x":1630,"y":380,"wires":[]},{"id":"693f75d0.9e78f4","type":"function","z":"2294209a.0c95b","name":"users global  -  design","func":"msg.topbarContanerId =  \"e9cfb98b-de00-838f-b1f4-570ced8d0504\";\n\nreturn msg;","outputs":1,"noerr":0,"x":1200,"y":380,"wires":[["9293b380.aed2b"]]},{"id":"b59ec926.10591","type":"comment","z":"2294209a.0c95b","name":"DESIGN","info":"","x":880,"y":340,"wires":[]},{"id":"ea7a914b.d9859","type":"comment","z":"2294209a.0c95b","name":"INIT","info":"","x":890,"y":560,"wires":[]},{"id":"7cdd4e0a.69bdb8","type":"comment","z":"e5822137.be45d","name":"DESIGN","info":"","x":700,"y":280,"wires":[]},{"id":"37ab5a6c.a90106","type":"comment","z":"aec22158.fe4e38","name":"DESIGN","info":"","x":135,"y":819.9999961853027,"wires":[]},{"id":"650cfae5.573e4c","type":"comment","z":"aec22158.fe4e38","name":"INIT","info":"","x":105,"y":939.9999961853027,"wires":[]},{"id":"efaa6686.80c558","type":"comment","z":"aec22158.fe4e38","name":"DESIGN","info":"","x":75,"y":259.99999618530273,"wires":[]},{"id":"f79fd07b.c1e458","type":"comment","z":"aec22158.fe4e38","name":"INIT","info":"","x":205,"y":339.99999618530273,"wires":[]},{"id":"d569a771.280e","type":"comment","z":"aec22158.fe4e38","name":"DESIGN","info":"","x":115,"y":1279.9999961853027,"wires":[]},{"id":"18b10abd.bd5515","type":"comment","z":"aec22158.fe4e38","name":"INIT","info":"","x":125,"y":1399.9999961853027,"wires":[]},{"id":"7c65cd91.67188c","type":"comment","z":"aec22158.fe4e38","name":"DESIGN","info":"","x":95,"y":2079.9999961853027,"wires":[]},{"id":"3a71e54.a77a89a","type":"comment","z":"aec22158.fe4e38","name":"INIT","info":"","x":85,"y":2199.9999961853027,"wires":[]},{"id":"2e99f46b.4490ec","type":"function","z":"aec22158.fe4e38","name":"finalize user account","func":"var BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar crypto = global.get('crypto');\n\n\n\ndelete msg.RevotioData.FlowData.UserObj.hash\ndelete msg.RevotioData.FlowData.UserObj.active\ndelete msg.RevotioData.FlowData.UserObj.activationToken\n\nmsg.payload = [{user: new ObjectID(msg.RevotioData.FlowData.Data.UserData._id)},\n               {\"$set\" : msg.RevotioData.FlowData.UserObj},\n               {upsert:true}\n               \n               ];\nmsg.operation = \"update\"\n\n\n\n\nreturn msg;","outputs":1,"noerr":0,"x":3960,"y":920,"wires":[["62ed20f0.1e896"]],"outputLabels":["invalid, "]},{"id":"36833fec.f99c5","type":"function","z":"2294209a.0c95b","name":"Set Form Data","func":"// Get libraries\nconst Moment = global.get('moment');\nconst MomentRange = global.get('momentrange');\nconst moment = MomentRange.extendMoment(Moment)\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting'); \nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\n\nfindObj = {\n                    query : {\n                            query :{user:new ObjectID(msg.RevotioData.PostData.gadgetData.appUserId) }, \n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'user_accounts',\n                    operation:'findOne',\n                    }\n\n            mongodbTools.resolveAsync(findObj, node, function(res){\n                   msg.RevotioData.FlowData.Form = {\n                        FormType : \"User\",\n                        FormActionType : \"Edit\",\n                        FormData:res\n                    };\n                    node.send(msg) \n            })   \n","outputs":1,"noerr":0,"x":2960,"y":760,"wires":[["b0ed4707.f5ac"]]},{"id":"f347dd79.54981","type":"comment","z":"4cbbc60.828563c","name":"Functions","info":"","x":200,"y":80,"wires":[]},{"id":"1c4c9d0e.1060fb","type":"comment","z":"4cbbc60.828563c","name":"settings","info":"","x":190,"y":180,"wires":[]},{"id":"6535b938.767ac8","type":"function","z":"2294209a.0c95b","name":"Prepair delete queries","func":"// Get libraries\nconst Moment = global.get('moment');\nconst MomentRange = global.get('momentrange');\nconst moment = MomentRange.extendMoment(Moment)\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting'); \nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\n\n\nvar user, other;\n \n \nother = {   payload : {user_id: new ObjectID(msg.RevotioData.PostData.actionType.data.appUserId)},\n            operation : \"remove\"\n}\n\nmsg.payload = {_id: new ObjectID(msg.RevotioData.PostData.actionType.data.appUserId)}\nmsg.operation = \"remove\"\nuser= msg;\n\nreturn [user, other];","outputs":2,"noerr":0,"x":4120,"y":600,"wires":[["35b3b956.affe26"],["8b08f368.889138"]]},{"id":"a00aba6e.69bb58","type":"link in","z":"e5822137.be45d","name":"** Gadget Name **","links":["2cc71536.88996a"],"x":1395,"y":440,"wires":[["3e910553.3e65aa"]]},{"id":"1bb649ce.6a1376","type":"function","z":"508957a1.dd5398","name":"Get Page object","func":"// Get libraries\nconst Moment = global.get('moment');\nconst MomentRange = global.get('momentrange');\nconst moment = MomentRange.extendMoment(Moment)\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting'); \nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\n\n\n\n// set all response data\nmsg.responseObj                     = msg.payload;\nmsg.responseObj.deviceId            = msg.RevotioData.session.deviceId ;\nmsg.responseObj.revotioSessionId    = msg.RevotioData.session.revotioSessionId ;\nmsg.responseObj.user_id             = msg.RevotioData.session.user_id ;\nmsg.responseObj.applicationId       = new ObjectID(global.get(\"applicationId\"));\nmsg.responseObj.token               = msg.RevotioData.session.token;\nmsg.responseObj.Page                = msg.payload.Page.toLowerCase().trim();//.replace(/^\\s*|\\s*$/g, '');\n// msg.payload.Page                    = msg.responseObj.Page;\n\nmsg.headers = {};\nmsg.rejectUnauthorized =  false;\n\nif (    msg.responseObj.Page === \"project overview\" && \n        msg.responseObj.hasOwnProperty(\"RevotioData\") &&\n        msg.responseObj.RevotioData.hasOwnProperty(\"project_id\") ){\n    \n    // get funding_scheme object\n    \n    // aggregate\n            aggregateObj = {\n                    query : { query : [{\n                                $match: {\n                                  \"_id\": new ObjectID(msg.responseObj.RevotioData.project_id),\n                                \n                                }\n                              },\n                              {\n                                $lookup: {\n                                  \"from\": \"settings\",\n                                  \"localField\": \"funding_scheme\",\n                                  \"foreignField\": \"_id\",\n                                  \"as\": \"funding_scheme_data\"\n                                }\n                              },\n                 \n                              {\n                                $unwind: {\n                                  \"path\": \"$funding_scheme_data\",\n                                  \"includeArrayIndex\": \"arrayIndex\",\n                                  \"preserveNullAndEmptyArrays\": false\n                                }\n                              }\n                            ],},\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'projects',\n                    operation:'aggregate',\n                    }\n                    \n            mongodbTools.resolveAsync(aggregateObj, node, function(res){\n                    // if (Array.isArray(res)=== true && res.length>0 && res[0].funding_scheme_data.hasOwnProperty(\"project_template\")){\n                \n               \n                        \n                    //     msg.responseObj.Page = res[0].funding_scheme_data.project_template + \" \" + msg.responseObj.Page\n                    //     url = \"https://new-services.revotio.com/pages?\" +  \"applicationId=\"  + msg.responseObj.applicationId + \"&pageName=\"+  msg.responseObj.Page ;\n                        \n                    // } else {\n                         msg.responseObj.Page = \"default \" + msg.responseObj.Page.trim()\n                        url = \"https://new-services.revotio.com/pages?\" +  \"applicationId=\"  + msg.responseObj.applicationId + \"&pageName=\"+  msg.responseObj.Page.trim() ;\n                     \n                    // }\n                   \n                    // url = \"https://new-services.revotio.com/pages?\" +  \"applicationId=\"  + msg.responseObj.applicationId + \"&pageName=\"+  msg.responseObj.Page ;\n                    res = encodeURI(url);\n                    \n                    msg.url = res\n\n                    node.send(msg) \n            })\n    \n       \n        \n        \n} else {\n  \n        url = global.get(\"innonation_api\")+ \"/pages?\" +  \"applicationId=\"  + msg.responseObj.applicationId + \"&pageName=\"+  msg.responseObj.Page ;\n        res = encodeURI(url);\n        \n        msg.url = res\n        node.send(msg)\n\n}\n\n\n\n\n\n\n// return msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":400,"y":900,"wires":[["5ddd0309.2d77fc","3199acdc.5d559c"]]},{"id":"9ceaac27.f3dc2","type":"comment","z":"508957a1.dd5398","name":"Redirect","info":"Expected object :\n\n msg.payload = {\n        DeviceId: ** From publised app **,\n        RevotioSessionId : ** From publised app **,\n        Page:  ** defigned in the Node-Red API **,\n        timestamp :  ** Last update of DB session object **,\n        user_id:  ** suplied by publeshed app **,\n        applicationId : ** applicationId Defigned in global context of the server **,\n    }","x":100,"y":920,"wires":[]},{"id":"bbdc3383.cf54c8","type":"function","z":"508957a1.dd5398","name":"Setup msg.RevotioData obj","func":"var request = global.get('request');\nvar Moment = global.get('moment');var MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar crypto = global.get('crypto');\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\nvar unauth, auth,activate, reset,   error; \nmsg.RevotioData =\n{\n    session : JSON.parse(msg.dataResult.dataContent.SessionData),\n    type : msg.dataResult.dataContent.payload,\n    BrowserFP : JSON.parse(msg.dataResult.dataContent.PostData)\n}\n\n\n\n        \nif (msg.RevotioData.session.entranceType === \"activate\"){\n    activate = msg;\n} else if (msg.RevotioData.session.entranceType === \"reset\"){\n    reset = msg;\n} \nelse {\n    \n \n  \n    if (typeof msg.tokenResult.TokenContent  === \"object\" &&  msg.tokenResult.TokenContent.type === \"authorized\"){\n        msg.RevotioData.tokenInfo ={\n            deviceId: msg.tokenResult.TokenContent.deviceId,\n            revotioSessionId: msg.tokenResult.TokenContent.revotioSessionId,\n            tokenCreated:  moment.unix(msg.tokenResult.TokenContent.iat),\n            tokenDateNow: moment(),\n            tokenCreatedDiffDays : moment().diff(moment.unix(msg.tokenResult.TokenContent.iat), 'days'),// (msg.RevotioData.tokenCreatedDiff / (1000 * 60 * 60)).toFixed(1);\n            currentTimeZone: msg.RevotioData.session.timezone,\n            tokenData:msg.tokenResult.TokenContent\n        }\n        \n        \n        auth = msg;\n    } else if (typeof msg.tokenResult.TokenContent  === \"object\" && msg.tokenResult.TokenContent.type === \"unauthorized\") {\n        \n        unauth = msg;\n    } \n    else {\n        \n        // msg.tokenData = tokenData;\n        error = msg;\n    }\n    \n}\n\nreturn [unauth, auth , activate ,reset,  error];","outputs":5,"noerr":0,"initialize":"","finalize":"","x":380,"y":340,"wires":[["92449c5.fd42de"],["10e1e3b.d1d519c"],["15c4a8bb.5b28af"],["84c26a9f.683b7"],[]],"outputLabels":["unauth","auth","activate","reset","error"]},{"id":"a6ecac2e.964a9","type":"function","z":"508957a1.dd5398","name":"Check if session exists and is valid or create new one & INIT FS","func":"var request = global.get('request');\nvar Moment = global.get('moment');var MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\nif ( msg.payload && msg.payload.hasOwnProperty(\"UserData\") ){\n    \n    msg.SessionObj = msg.payload ;\n\n    Obj =  {\n        _id: new ObjectID(msg.SessionObj._id),\n        token: msg.SessionObj.token,\n        deviceId: msg.SessionObj.deviceId,\n        revotioSessionId :msg.SessionObj.revotioSessionId,\n        Page: msg.SessionObj.Page,\n        timestamp : new Date(),\n        user_id: new ObjectID(msg.RevotioData.session.user_id),\n        applicationId : new ObjectID(global.get(\"applicationId\")),\n        UserData : msg.RevotioData.userData,\n        timezone: msg.RevotioData.session.timezone,\n        currentUserTime: msg.RevotioData.session.currentUserTime ,\n        gmtTime: msg.RevotioData.session.gmtTime\n    }\n\n    operation = 'update'\n    \n} else {\n    \n    Obj = {\n         _id: new ObjectID(),\n        token: msg.RevotioData.session.token,\n        deviceId: msg.RevotioData.session.deviceId,\n        revotioSessionId :msg.RevotioData.session.revotioSessionId,\n        timestamp : new Date(),\n        user_id: new ObjectID(msg.RevotioData.session.user_id),\n        applicationId : new ObjectID(global.get(\"applicationId\")),\n        UserData : msg.RevotioData.session.UserData,\n        timezone: msg.RevotioData.session.timezone,\n        currentUserTime: msg.RevotioData.session.currentUserTime ,\n        gmtTime: msg.RevotioData.session.gmtTime\n    };\n\n    if (msg.RevotioData.session.UserData.UserAccountData.user_type && msg.RevotioData.session.UserData.UserAccountData.user_type === \"Client_User\" ){\n        Obj.Page =  global.get(\"DomainProperties.ClientDefaultPage\");\n        Obj.RevotioData = {organization_id : new ObjectID(msg.RevotioData.session.UserData.organization_id)}\n    }else {\n        Obj.Page =  global.get(\"DomainProperties.PNODefaultPage\");\n    }\n    operation = 'update'\n\n}\n    msg.payload = Obj ; \n// update    \n    updateObj = {\n                    query : {\n                            query :{_id:new ObjectID(Obj._id)}, \n                            update : { \"$set\" : Obj},\n                            options : {upsert: true}\n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'sessions',\n                    operation:'update', // updateMany , updateOne\n                    }\n\n            mongodbTools.resolveAsync(updateObj, node, function(res){\n                    msg.result = res\n                    node.send(msg) \n            })  \n\n\n\n// return msg;","outputs":1,"noerr":0,"x":2670,"y":340,"wires":[["c8fb96e2.82848"]]},{"id":"4a28c697.d7c878","type":"function","z":"508957a1.dd5398","name":"Prepair msg.RevotioData Obj","func":"\nif (typeof msg.payload.FlowData === 'object' ){\n    FlowData = msg.payload.FlowData\n    delete msg.payload.FlowData\n} else {\n     FlowData = {Data : {}}\n}\n\n\nmsg.RevotioData = {\n    init:msg.INIT,\n    entity: \"INIT\",\n    session : msg.payload,\n    FlowData: FlowData\n    };\nreturn msg;","outputs":1,"noerr":0,"x":620,"y":600,"wires":[["e0a7d33c.5622b"]]},{"id":"65cb1ffa.0f19d","type":"function","z":"508957a1.dd5398","name":"Prepair session lookup","func":"var request = global.get('request');\nvar Moment = global.get('moment');var MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\n//  get session\n\nvar query = {\n    deviceId: msg.RevotioData.session.deviceId,\n    revotioSessionId :msg.RevotioData.session.revotioSessionId,\n};\n\n// find  \nfindObj = {\n                    query : {\n                            query :query, \n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'sessions',\n                    operation:'find',\n                    }\n\n            mongodbTools.resolveAsync(findObj, node, function(res){\n                if (res.length > 0){\n                    msg.payload = res[0]\n                } else {\n                    msg.payload = {}\n                }\n                    \n                    node.send(msg) \n            })   \n\n// return msg;","outputs":1,"noerr":0,"x":2320,"y":340,"wires":[["a6ecac2e.964a9"]]},{"id":"a6e28b45.2c7798","type":"catch","z":"508957a1.dd5398","name":"","scope":null,"x":100,"y":40,"wires":[["8a7161b7.e34dd"]]},{"id":"8a7161b7.e34dd","type":"debug","z":"508957a1.dd5398","name":"ERROR","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"true","targetType":"full","x":220,"y":40,"wires":[]},{"id":"1a7afd51.7ed1e3","type":"function","z":"508957a1.dd5398","name":"Update Session to match location user","func":"var request = global.get('request');\nvar Moment = global.get('moment');var MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\nresponseObj = msg.responseObj;\n\nObj =  {timestamp : new Date(),\n        applicationId: new ObjectID(global.get(\"applicationId\")),\n        // session : msg.RevotioData.session\n}\n\nif (responseObj.deviceId){\n    Obj.deviceId =  responseObj.deviceId;\n}\n\nif (responseObj.revotioSessionId){\n    Obj.revotioSessionId =  responseObj.revotioSessionId;\n}\n\nif (responseObj.user_id){\n    Obj.user_id =  responseObj.user_id;\n}\n\nif (msg.RevotioData.userData){\n    Obj.userData =  msg.RevotioData.userData;\n}\n\nif (responseObj.Page){\n    Obj.Page =  responseObj.Page;\n}\n\nif (typeof msg.responseObj.RevotioData === 'object'){\n    Obj.FlowData = msg.responseObj.RevotioData\n    Obj.FlowData.Data  = {}\n} else {\n     Obj.FlowData = {Data:{}}\n}\n\nif (responseObj.presentationLayer && responseObj.presentationLayer.container && responseObj.presentationLayer.container !== null){\n    Obj.container =  responseObj.presentationLayer.container;\n}\n\nupdateObj = {\n                    query : {\n                            query :{deviceId: responseObj.deviceId, revotioSessionId: responseObj.revotioSessionId}, \n                            update : {\"$set\" : Obj},\n                            options : {upsert: true, returnOriginal: false}\n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'sessions',\n                    operation:'findOneAndUpdate', // updateMany , updateOne\n                    }\n\n            mongodbTools.resolveAsync(updateObj, node, function(res){\n                \n                if (typeof res === 'object' && res.hasOwnProperty(\"value\")){\n                    \n                     msg.payload = res.value\n                     \n                } else {\n                    msg.payload = {};\n                }\n                \n                node.send(msg)\n            })\n                     \n    // // update    \n    // updateObj = {\n    //                 query : {\n    //                         query :{deviceId: responseObj.deviceId, revotioSessionId: responseObj.revotioSessionId}, \n    //                         update : {\"$set\" : Obj},\n    //                         options : {upsert: true}\n    //                         },\n    //                 connection:global.get(\"DB_data.connection\"),\n    //                 database:global.get(\"DB_data.appDB\"),\n    //                 collection:'sessions',\n    //                 operation:'update', // updateMany , updateOne\n    //                 }\n\n    //                         mongodbTools.resolveAsync(updateObj, node, function(res){\n                                \n    //                             findObj = {\n    //                                 query : {\n    //                                         query :{deviceId: responseObj.deviceId, revotioSessionId: responseObj.revotioSessionId}, \n    //                                         },\n    //                                 connection:global.get(\"DB_data.connection\"),\n    //                                 database:global.get(\"DB_data.appDB\"),\n    //                                 collection:'sessions',\n    //                                 operation:'find', // updateMany , updateOne\n    //                                 }\n                \n    //                         mongodbTools.resolveAsync(findObj, node, function(res){\n    //                                 msg.payload  = res[0]\n    //                                 node.send(msg) \n    //                         })  \n    //         })  \n            \n            \n  \n// return msg;","outputs":1,"noerr":0,"x":930,"y":900,"wires":[["107e8b58.7328f5"]]},{"id":"301e688d.349888","type":"comment","z":"508957a1.dd5398","name":"Initialize post","info":"Expected object :\n\n msg.payload = {\n        DeviceId: ** From publised app **,\n        RevotioSessionId : ** From publised app **,\n   }","x":130,"y":560,"wires":[]},{"id":"7e2e45e5.66251c","type":"function","z":"508957a1.dd5398","name":"Prepair msg.RevotioData Obj","func":"\n\nmsg.RevotioData.session = msg.payload \nmsg.RevotioData.entity = msg.RevotioData.PostData.gadgetId\n\nif (typeof msg.payload.FlowData === 'object' ){\n    msg.RevotioData.FlowData = msg.payload.FlowData\n    delete msg.payload.FlowData\n} else {\n     msg.RevotioData.FlowData = {Data : {}}\n}\n\nmsg.RevotioData.session = msg.payload \n    \nreturn msg;","outputs":1,"noerr":0,"x":800,"y":760,"wires":[["40d072f4.03fce4"]]},{"id":"92449c5.fd42de","type":"function","z":"508957a1.dd5398","name":"prepair redirect to user authentication && update session object","func":"var request = global.get('request');\nvar Moment = global.get('moment');var MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar crypto = global.get('crypto');\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\nmsg.payload  = {\n    Page :global.get(\"DomainProperties.NonAuthDefaultPage\")\n}\n\n// update    \n\n    updateObj = {\n                    query : {\n                            query :{\n                                    revotioSessionId:msg.RevotioData.session.revotioSessionId, \n                                    deviceId : msg.RevotioData.session.deviceId\n                            }, \n                            update : { \"$set\" : msg.RevotioData.session},\n                            options : {upsert: true}\n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'sessions',\n                    operation:'update', // updateMany , updateOne\n                    }\n\n            mongodbTools.resolveAsync(updateObj, node, function(res){\n                   \n                    node.send(msg) \n            })  \n\n","outputs":1,"noerr":0,"x":1470,"y":280,"wires":[["3d5d3142.cf1206"]]},{"id":"8ebf17ec.2f4a48","type":"function","z":"508957a1.dd5398","name":"check token content","func":"var jsonwebtoken = global.get('jsonwebtoken');\n\n\nmsg.RevotioData =\n{\n    session : JSON.parse(msg.payload.SessionData),\n    type : msg.payload.payload,\n    BrowserFP : JSON.parse(msg.payload.PostData)\n}\n\n jsonwebtoken.verify(msg.RevotioData.session.token, global.get(\"SystemVars.secret\"), function(err, decoded) {\n          if (decoded !== undefined){\n              tokenState = \"valid\"\n              msg.tokenData = decoded\n          }\n        });\n       \n\n\nreturn msg;","outputs":1,"noerr":0,"x":360,"y":280,"wires":[[]]},{"id":"6b3b5ad8.614bac","type":"function","z":"508957a1.dd5398","name":"check token content","func":"var jsonwebtoken = global.get('jsonwebtoken');\n\n\npayload = JSON.parse(msg.payload.RevotioData)\n\n jsonwebtoken.verify(payload.token , global.get(\"SystemVars.secret\"), function(err, decoded) {\n          if (decoded !== undefined){\n              tokenState = \"valid\"\n              msg.tokenData = decoded\n          }\n        });\n       \n\n\nreturn msg;","outputs":1,"noerr":0,"x":381.6666450500488,"y":561.0833415985107,"wires":[[]]},{"id":"15c4a8bb.5b28af","type":"function","z":"508957a1.dd5398","name":"prepair redirect to user authentication","func":"msg.payload  = {\n    Page :\"user account activation\",\n    RevotioData: {\n        activationToken :  msg.RevotioData.session.activationToken\n    }\n}\nreturn msg;","outputs":1,"noerr":0,"x":730,"y":380,"wires":[["5fba24de.5173fc"]]},{"id":"c964af3e.013ae8","type":"function","z":"508957a1.dd5398","name":"Check if token is valid - Action","func":"var jsonwebtoken = global.get('jsonwebtoken');\nvar secret = global.get(\"SystemVars.secret\");\n\nvar valid, invalid;\n\n\n// verify a token symmetric\njsonwebtoken.verify(msg.RevotioData.session.token, global.get(\"SystemVars.secret\"), function(err, decoded) {\n      if (decoded !== undefined){\n        valid = msg;\n      } else {\n          invalid = msg;\n      }\n    });\n    \n  \n    \n    \nreturn [valid, invalid];","outputs":2,"noerr":0,"x":530,"y":780,"wires":[["7e2e45e5.66251c"],["e39b5dab.d5db78"]],"outputLabels":["valid","invalid"]},{"id":"e39b5dab.d5db78","type":"function","z":"508957a1.dd5398","name":"Redirect to user authentication","func":"msg.payload  = {\n    Page :\"user authentication\"\n}\nreturn msg;","outputs":1,"noerr":0,"x":810,"y":800,"wires":[["7167ce92.3c59c"]]},{"id":"8cd48535.9010d8","type":"function","z":"508957a1.dd5398","name":"Check if token is valid - INIT","func":"var jsonwebtoken = global.get('jsonwebtoken');\nvar secret = global.get(\"SystemVars.secret\");\nvar request = global.get('request');\nvar Moment = global.get('moment');var MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\nvar valid, invalid;\n//  get session\nmsg.starttime = new Date()\n\n\nmsg.INIT = JSON.parse(msg.dataResult.dataContent.RevotioData);\nvar query =\n    {deviceId : msg.payload.deviceId, \n    revotioSessionId:msg.payload.revotioSessionId}\n\n// msg.operation = 'findOne'\n\n// find  \nfindObj = {\n                    query : {\n                            query :query, \n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'sessions',\n                    operation:'find',\n                    }\n\n            mongodbTools.resolveAsync(findObj, node, function(res){\n                if (res.length > 0){\n                     msg.payload = res[0]\n                } else {\n                    msg.payload  = {}\n                }\n                    node.send(msg) \n            })   \n\n\n\n// // verify a token symmetric\n// jsonwebtoken.verify(msg.INIT.token, global.get(\"SystemVars.secret\"), function(err, decoded) {\n//       if (decoded !== undefined){\n//         valid = msg;\n//       } else {\n//           invalid = msg;\n//       }\n//     });\n    \n  \n    \n    \n// return [valid, invalid];","outputs":1,"noerr":0,"initialize":"","finalize":"","x":360,"y":600,"wires":[["4a28c697.d7c878"]],"outputLabels":["valid"]},{"id":"84c26a9f.683b7","type":"function","z":"508957a1.dd5398","name":"prepair redirect to reset ","func":"msg.payload  = {\n    Page :'reset password',\n    RevotioData:{\n        resetToken : msg.RevotioData.session.resetToken\n    }\n}\nreturn msg;","outputs":1,"noerr":0,"x":690,"y":420,"wires":[["5fba24de.5173fc"]]},{"id":"2c492795.625c38","type":"function","z":"508957a1.dd5398","name":"Create msg.RevotioData and get UserData","func":"var request = global.get('request');\nvar Moment = global.get('moment');var MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\n// Get UserData\n\n// aggregate\n\n\n            aggregateObj = {\n                    query : { query : [\n                                        {$match : { _id : new ObjectID(msg.RevotioData.session.user_id)}},\n                                        \n                                        {    $lookup: {\n                                                from: \"user_accounts\",\n                                                localField: \"_id\",\n                                                foreignField: \"user\",\n                                                as: \"UserAccountData\"\n                                            }},\n                                        {    $lookup: {\n                                            from: \"user_permissions\",\n                                            localField: \"_id\",\n                                            foreignField: \"user\",\n                                            as: \"AppUserPermissionInfo\"\n                                        }},\n                                        {\n                                          $unwind:\"$UserAccountData\"\n                                        },\n                                                ],},\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'users',\n                    operation:'aggregate',\n                    }\n                    \n            mongodbTools.resolveAsync(aggregateObj, node, function(res){\n                if (res.length > 0){\n                     msg.payload = res[0]\n                } else {\n                     msg.payload = {}\n                }\n                   \n                    node.send(msg) \n            }) \n ","outputs":1,"noerr":0,"x":930,"y":340,"wires":[["a45c0a9e.4de0e"]]},{"id":"10e1e3b.d1d519c","type":"function","z":"508957a1.dd5398","name":"Decrypt token","func":"var jsonwebtoken = global.get('jsonwebtoken');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\n\nvar tokenState\n\n// Decrypt token\n    jsonwebtoken.verify(msg.RevotioData.session.token, global.get(\"SystemVars.secret\"), function(err, decoded) {\n      if (decoded !== undefined){\n          tokenState = \"valid\"\n          TokenContent = decoded\n      }\n    });\n                \nmsg.RevotioData.session.user_id = new ObjectID(TokenContent.user_id);\n\nmsg.RevotioData.applicationId = new ObjectID(global.get(\"applicationId\"));\n\nmsg.payload = {\n    deviceId: msg.RevotioData.session.deviceId,\n    revotioSessionId :msg.RevotioData.session.revotioSessionId,\n};\n\nmsg.operation = 'findOne'\n\nreturn msg;","outputs":1,"noerr":0,"x":660,"y":340,"wires":[["2c492795.625c38"]]},{"id":"a45c0a9e.4de0e","type":"function","z":"508957a1.dd5398","name":"Prepair redirect","func":"// Get libraries\nconst Moment = global.get('moment');\nconst MomentRange = global.get('momentrange');\nconst moment = MomentRange.extendMoment(Moment)\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting'); \nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\n\nvar PNO , Client, none;\n\n\n// delete msg.RevotioData.SessionData\n// if (msg.payload.length > 0){\nmsg.RevotioData.session.UserData =  msg.payload;\n\nmsg.RevotioData.session.UserData.type = \"NonPNOAdmin\"\n\n_.each(msg.RevotioData.session.UserData.AppUserPermissionInfo, function(Item, Index){\n    \n    if (Item.type === \"organization\"){\n        \n        if (String(Item.type_id) === String(global.get(\"MasterOrganizationData._id\")) && Item.permission === 0){\n            msg.RevotioData.session.UserData.type = \"PNOAdmin\"\n        }\n        \n        \n    }\n    \n})\n\nif (msg.RevotioData.session.UserData.type === \"PNOAdmin\"){\n\nPNO = msg;\n\n} else {\n        \nClient = msg\n        \n}\n\n   \n\n\n\nreturn [PNO , Client, none];","outputs":3,"noerr":0,"x":1180,"y":340,"wires":[["65cb1ffa.0f19d"],["414c3d6c.df3964"],["92449c5.fd42de"]],"outputLabels":["PNO","Client","none"]},{"id":"414c3d6c.df3964","type":"function","z":"508957a1.dd5398","name":"Check user inv","func":"var request = global.get('request');\nvar Moment = global.get('moment');var MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\nvar resume, login;\n\nUserOrgPermissionObjIndex = lodash.findIndex(msg.RevotioData.session.UserData.AppUserPermissionInfo,{type: \"organization\"} );\n\nif (UserOrgPermissionObjIndex === -1){\n    login = msg;\n}else {\n    UserOrgPermissionObj = msg.RevotioData.session.UserData.AppUserPermissionInfo[UserOrgPermissionObjIndex]\n\nresume = msg \n}\n\n\nreturn [resume, login ];","outputs":2,"noerr":0,"x":1360,"y":400,"wires":[["b0299765.306ab"],["c4762256.4d3218"]],"outputLabels":["resume, ","login"]},{"id":"cd09b08b.c1c3d","type":"function","z":"508957a1.dd5398","name":"Permission check 2/3","func":"var request = global.get('request');\nvar Moment = global.get('moment');var MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\nmsg.RevotioData.session.UserData.OrgRepresentativeProjects = msg.payload;\n\nvar query = { project_leader : new ObjectID(msg.RevotioData.session.UserData._id)} ;\n\nfindObj = {\n                    query : {\n                            query :query, \n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'projects',\n                    operation:'find',\n                    }\n\n            mongodbTools.resolveAsync(findObj, node, function(res){\n                    msg.payload = res\n                    node.send(msg) \n            })   \n\n// return msg;","outputs":1,"noerr":0,"x":1900,"y":380,"wires":[["d4d30d3a.b0fd78"]]},{"id":"d4d30d3a.b0fd78","type":"function","z":"508957a1.dd5398","name":"Permission check 3/3","func":"// Get libraries\nconst Moment = global.get('moment');\nconst MomentRange = global.get('momentrange');\nconst moment = MomentRange.extendMoment(Moment);\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\n\nmsg.RevotioData.session.UserData.ProjectLeaderProjects = msg.payload;\n\nOrgObj = lodash.find(msg.RevotioData.session.UserData.AppUserPermissionInfo, {type: \"organization\"})\n\nif (msg.RevotioData.hasOwnProperty(\"FlowData\") === false){\n    msg.RevotioData.FlowData = {}\n}\n\nif (msg.RevotioData.session.UserData.ProjectLeaderProjects.length === 0 && msg.RevotioData.session.UserData.OrgRepresentativeProjects.length === 0){\n    \n            msg.RevotioData.FlowData.Page = global.get(\"DomainProperties.ClientDefaultPage\")\n            msg.RevotioData.OrganzationId = OrgObj.type_id;\n            msg.RevotioData.FlowData.organization_id = OrgObj.type_id;\n        \n       \n} else {\n        \n                msg.RevotioData.FlowData.Page = global.get(\"DomainProperties.ClientDefaultPage\")\n                msg.RevotioData.OrganzationId = OrgObj.type_id;\n                msg.RevotioData.FlowData.organization_id = OrgObj.type_id;\n         \n         \n\n}\n\n            msg.payload = {\n                    Page :   msg.RevotioData.FlowData.Page,\n                    RevotioData         : {\n                        organization_id : OrgObj.type_id\n                    }\n                }\n\n\nreturn msg;","outputs":1,"noerr":0,"x":2100,"y":380,"wires":[["65cb1ffa.0f19d"]]},{"id":"a37d665a.27b8c8","type":"function","z":"508957a1.dd5398","name":"Parse object","func":"// Get libraries\nconst Moment = global.get('moment');\nconst MomentRange = global.get('momentrange');\nconst moment = MomentRange.extendMoment(Moment);\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting'); \nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\n\n\nmsg.responseObj.presentationLayer = JSON.parse(msg.payload).pages[0];\nmsg.appObj = JSON.parse(msg.payload);\n\n\n\nreturn msg;","outputs":1,"noerr":0,"x":710,"y":960,"wires":[["af5c8a5f.64c24"]],"outputLabels":["Items, "]},{"id":"5ddd0309.2d77fc","type":"http request","z":"508957a1.dd5398","name":"","method":"GET","ret":"txt","paytoqs":false,"url":"","tls":"","proxy":"","x":550,"y":960,"wires":[["a37d665a.27b8c8"]]},{"id":"107e8b58.7328f5","type":"function","z":"508957a1.dd5398","name":"manage file system - Manage FS","func":"if (msg.payload.hasOwnProperty(\"value\") && msg.payload.value !== null){\n\nmsg.RevotioData.session._id = msg.payload.value._id\nmsg.RevotioData.session.container = msg.payload.value.container\n\nresult = global.get(\"functions.fileManagement\")( '', '',msg.RevotioData.session._id, \"initSessionFolder\") // source, destination, operation\n\nresult = global.get(\"functions.fileManagement\")( '', '',msg.RevotioData.session._id, \"emptyDirSync\") // source, destination, operation\n\n\nif (result.state === \"success\"){\n    \n} else {\n    \n}\n}\n\nmsg.payload = msg.responseObj;\nmsg.payload.Type = \"Redirect\";\nmsg.headers = {\n    'Access-Control-Allow-Origin': '*',\n    'Access-Control-Allow-Methods': 'PUT,GET,POST,DELETE,OPTIONS',\n    'Access-Control-Allow-Headers': 'Content-Type',\n    'content-type': 'application/json',\n};\n\nreturn msg;","outputs":1,"noerr":0,"x":1260,"y":940,"wires":[["dee52d4e.18fdb"]]},{"id":"28095b53.fd6c2c","type":"comment","z":"508957a1.dd5398","name":"Action post","info":"Expected object :\n\n msg.payload = {\n        DeviceId: ** From publised app **,\n        RevotioSessionId : ** From publised app **,\n   }","x":110,"y":740,"wires":[]},{"id":"e0a7d33c.5622b","type":"function","z":"508957a1.dd5398","name":"create request ****TEMP FIX**** INIT","func":"// Get libraries\nconst Moment = global.get('moment');\nconst MomentRange = global.get('momentrange');\nconst moment = MomentRange.extendMoment(Moment)\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting'); \nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\n\nmessage = {\n    \n    RevotioData: msg.RevotioData,\n    payload : msg.payload,\n    starttime : msg.starttime\n}\nid = new ObjectID()\n// msg = {}\n\nmsg.payload = [{ _id: id},\n    {requestData : message},\n    {upsert : true}\n]\n\nmsg.operation = \"updateOne\"\n\n\nfunction capitalizeFirstLetter(str) {\n  return str.charAt(0).toUpperCase() + str.slice(1);\n}\n\n\nif (msg.RevotioData.session.container && msg.RevotioData.session.container !== null && global.get(\"DomainProperties.routing\") &&  global.get(\"DomainProperties.routing\") !== \"local\"){\n// ******************************************************************\n    msg.url =  msg.RevotioData.session.container + \"/\"\n    // msg.url = global.get(\"DomainProperties.url\")\n// ******************************************************************\n} else {\n    msg.url = global.get(\"DomainProperties.url\")\n}\n\n_.each(message.RevotioData.session.Page.replace(/[^\\w\\s]/gi,\"\").split(\" \"), function(value, index){\n    msg.url = msg.url + capitalizeFirstLetter(value);\n})\n\n\n// msg.url = message.RevotioData.session.Page.replace(/ /g, '');\n\n\n\n\nmsg.requestPayload = {id:id, type :\"init\", data :message}\n\nreturn msg;","outputs":1,"noerr":0,"x":890,"y":600,"wires":[["1aa3f57a.f7d443"]]},{"id":"efdc3569.8d19","type":"http request","z":"508957a1.dd5398","name":"","method":"POST","ret":"txt","paytoqs":false,"url":"","tls":"","proxy":"","authType":"basic","x":1270,"y":600,"wires":[["4912f95d.e12f"]]},{"id":"1aa3f57a.f7d443","type":"function","z":"508957a1.dd5398","name":"create request","func":"// Get libraries\nconst Moment = global.get('moment');\nconst MomentRange = global.get('momentrange');\nconst moment = MomentRange.extendMoment(Moment)\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting'); \nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\n\n\nmsg.payload = msg.requestPayload\n\n\nreturn msg;","outputs":1,"noerr":0,"x":1120,"y":600,"wires":[["efdc3569.8d19"]]},{"id":"4912f95d.e12f","type":"json","z":"508957a1.dd5398","name":"","property":"payload","action":"","pretty":false,"x":1390,"y":600,"wires":[["96960c1b.0a5558"]]},{"id":"5a048ebe.6b364","type":"http in","z":"aec22158.fe4e38","name":"UserAuthentication","url":"/UserAuthentication","method":"post","upload":false,"swaggerDoc":"","x":145,"y":539.9999961853027,"wires":[["ecd2c396.4d9af"]]},{"id":"2927f5ef.05639a","type":"function","z":"a55f7aee.572be","name":"Prepair flow","func":"// Get libraries\nconst Moment = global.get('moment');\nconst MomentRange = global.get('momentrange');\nconst moment = MomentRange.extendMoment(Moment)\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting'); \nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\n\nmsg.communicationData = msg.payload\n\nif (msg.payload.hasOwnProperty(\"data\")){\n   _.each(msg.payload.data, function(value, key ){\n                        if (key !== \"_id\"){\n                            msg[key] = value\n                        }\n                    })\n    node.send(msg) \n} else {\n\n// find \n            findObj = {\n                    query : {\n                            query :{_id : new ObjectID(msg.payload.id)}, \n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'temp_sessions',\n                    operation:'find',\n                    }\n\n            mongodbTools.resolveAsync(findObj, node, function(res){\n                \n                if (Array.isArray(res)){\n                    temp  = res[0];\n                    res = temp\n                }\n                \n                \n                    _.each(res.requestData, function(value, key ){\n                        if (key !== \"_id\"){\n                            msg[key] = value\n                        }\n                    })\n                    \n                    \n                    \n                    node.send(msg) \n            }) \n}\n// return msg;","outputs":1,"noerr":0,"x":150,"y":80,"wires":[["4e19b9ea.51eff8"]]},{"id":"96960c1b.0a5558","type":"http response","z":"508957a1.dd5398","name":"","statusCode":"","headers":{},"x":1490,"y":600,"wires":[]},{"id":"d65791.a28bc07","type":"http in","z":"aec22158.fe4e38","name":"UserAccountActivation","url":"/UserAccountActivation","method":"post","upload":false,"swaggerDoc":"","x":155,"y":1059.9999961853027,"wires":[["f467989a.2c7b"]]},{"id":"c8f85a27.6c8cf","type":"http in","z":"aec22158.fe4e38","name":"TwoStepAuthentication","url":"/TwoStepAuthentication","method":"post","upload":false,"swaggerDoc":"","x":195,"y":1539.9999961853027,"wires":[["fc712911.f455d8"]]},{"id":"77af50e2.589c78","type":"http in","z":"aec22158.fe4e38","name":"ResetPassword","url":"/ResetPassword","method":"post","upload":false,"swaggerDoc":"","x":175,"y":2339.9999961853027,"wires":[["3f566bdd.bca52c"]]},{"id":"3e12189a.39eac","type":"http in","z":"2294209a.0c95b","name":"UsersGlobal","url":"/UsersGlobal","method":"post","upload":false,"swaggerDoc":"","x":90,"y":480,"wires":[["e5a5de01.a1ac3"]]},{"id":"c199e887.a6da4","type":"link out","z":"aec22158.fe4e38","name":"","links":["a206fa2f.9bb658"],"x":510,"y":499.99999618530273,"wires":[]},{"id":"e130563c.567048","type":"link out","z":"aec22158.fe4e38","name":"","links":["ffb8ad05.fe04"],"x":510,"y":539.9999961853027,"wires":[]},{"id":"82e73790.6bba78","type":"link out","z":"aec22158.fe4e38","name":"","links":["3ab682ae.10e656"],"x":510,"y":579.9999961853027,"wires":[]},{"id":"4e19b9ea.51eff8","type":"switch","z":"a55f7aee.572be","name":" Route","property":"communicationData.type","propertyType":"msg","rules":[{"t":"eq","v":"design","vt":"str"},{"t":"eq","v":"init","vt":"str"},{"t":"eq","v":"action","vt":"str"}],"checkall":"false","repair":false,"outputs":3,"x":310,"y":80,"wires":[[],[],[]],"outputLabels":["design","init","action"]},{"id":"c6521856.c46ec","type":"comment","z":"aec22158.fe4e38","name":"INIT","info":"","x":585,"y":539.9999961853027,"wires":[]},{"id":"ffbabbe8.5d0cb","type":"comment","z":"aec22158.fe4e38","name":"DESIGN","info":"","x":595,"y":499.99999618530273,"wires":[]},{"id":"215a6aa.6a2d296","type":"comment","z":"aec22158.fe4e38","name":"ROUTE","info":"","x":585,"y":579.9999961853027,"wires":[]},{"id":"18c634ff.b1dad3","type":"link out","z":"aec22158.fe4e38","name":"","links":["dd573c4c.643968"],"x":530,"y":1019.9999961853027,"wires":[]},{"id":"6537bec2.9226e8","type":"link out","z":"aec22158.fe4e38","name":"","links":["f08a12de.bf0fd"],"x":530,"y":1059.9999961853027,"wires":[]},{"id":"e8682458.5b8fb","type":"link out","z":"aec22158.fe4e38","name":"","links":["579313d7.2430dc"],"x":530,"y":1099.9999961853027,"wires":[]},{"id":"86aac31e.60e968","type":"comment","z":"aec22158.fe4e38","name":"INIT","info":"","x":605,"y":1059.9999961853027,"wires":[]},{"id":"d26e6d75.630648","type":"comment","z":"aec22158.fe4e38","name":"DESIGN","info":"","x":615,"y":1019.9999961853027,"wires":[]},{"id":"bbd839b4.9edf48","type":"comment","z":"aec22158.fe4e38","name":"ROUTE","info":"","x":605,"y":1099.9999961853027,"wires":[]},{"id":"c42395c9.e7a698","type":"link out","z":"aec22158.fe4e38","name":"","links":["ce9cd56d.b714d"],"x":570,"y":1499.9999961853027,"wires":[]},{"id":"839b0669.2a35d","type":"link out","z":"aec22158.fe4e38","name":"","links":["a27da0ef.7fe0c8"],"x":570,"y":1539.9999961853027,"wires":[]},{"id":"e84a1d06.e6f258","type":"link out","z":"aec22158.fe4e38","name":"","links":["e8c424c8.a91d3"],"x":570,"y":1579.9999961853027,"wires":[]},{"id":"77b5177.8cc3ae8","type":"comment","z":"aec22158.fe4e38","name":"INIT","info":"","x":645,"y":1539.9999961853027,"wires":[]},{"id":"7423e4f2.3972ec","type":"comment","z":"aec22158.fe4e38","name":"DESIGN","info":"","x":655,"y":1499.9999961853027,"wires":[]},{"id":"9304d6af.5a4b1","type":"comment","z":"aec22158.fe4e38","name":"ROUTE","info":"","x":645,"y":1579.9999961853027,"wires":[]},{"id":"e98e6ae3.ce1128","type":"link out","z":"aec22158.fe4e38","name":"","links":["a885e943.ebfb1"],"x":550,"y":2299.9999961853027,"wires":[]},{"id":"8b9609e7.cfa4c8","type":"link out","z":"aec22158.fe4e38","name":"","links":["d431a2e4.6d283","cae94cae.9e3458"],"x":550,"y":2339.9999961853027,"wires":[]},{"id":"32198700.e5b5b8","type":"link out","z":"aec22158.fe4e38","name":"","links":["e298dd8d.cbd328"],"x":550,"y":2379.9999961853027,"wires":[]},{"id":"29a350c1.e1c58","type":"comment","z":"aec22158.fe4e38","name":"INIT","info":"","x":625,"y":2339.9999961853027,"wires":[]},{"id":"a9ec6176.11b33","type":"comment","z":"aec22158.fe4e38","name":"DESIGN","info":"","x":635,"y":2299.9999961853027,"wires":[]},{"id":"63484a7a.f6eca4","type":"comment","z":"aec22158.fe4e38","name":"ROUTE","info":"","x":625,"y":2379.9999961853027,"wires":[]},{"id":"ff290d23.18df18","type":"link out","z":"2294209a.0c95b","name":"","links":["7d1a67c6.b7534"],"x":355,"y":440,"wires":[]},{"id":"b0ae31e0.11c9e8","type":"link out","z":"2294209a.0c95b","name":"","links":["32bc6eb7.c073aa"],"x":355,"y":480,"wires":[]},{"id":"be4224db.bfd728","type":"link out","z":"2294209a.0c95b","name":"","links":["3a23c4b4.bdc8a4"],"x":355,"y":520,"wires":[]},{"id":"e9eab74e.5cd3c","type":"comment","z":"2294209a.0c95b","name":"INIT","info":"","x":430,"y":480,"wires":[]},{"id":"354b4b47.56bff4","type":"comment","z":"2294209a.0c95b","name":"DESIGN","info":"","x":440,"y":440,"wires":[]},{"id":"b3b838e8.1d485","type":"comment","z":"2294209a.0c95b","name":"ROUTE","info":"","x":430,"y":520,"wires":[]},{"id":"ab8b9205.06cbe","type":"http request","z":"508957a1.dd5398","name":"","method":"POST","ret":"txt","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"basic","x":1910,"y":1000,"wires":[["917b5262.1f0b9"]]},{"id":"3f2e4a2d.25f27e","type":"function","z":"508957a1.dd5398","name":"create request","func":"// Get libraries\nconst Moment = global.get('moment');\nconst MomentRange = global.get('momentrange');\nconst moment = MomentRange.extendMoment(Moment)\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting'); \nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\n\n\nmsg.payload = msg.requestPayload\n\n\nreturn msg;","outputs":1,"noerr":0,"x":1820,"y":940,"wires":[["ab8b9205.06cbe","7300eaa0.fbf76c"]]},{"id":"917b5262.1f0b9","type":"json","z":"508957a1.dd5398","name":"","property":"payload","action":"","pretty":false,"x":2010,"y":1000,"wires":[["4c1b020f.633964"]]},{"id":"cf8d96f9.9c98d","type":"http response","z":"508957a1.dd5398","name":"","statusCode":"","headers":{},"x":2170,"y":960,"wires":[]},{"id":"975f47b0.683f3","type":"http request","z":"508957a1.dd5398","name":"","method":"POST","ret":"txt","paytoqs":false,"url":"","tls":"","proxy":"","authType":"basic","x":1470,"y":760,"wires":[["4d37f804.d37c5"]]},{"id":"6965c6fa.5073d8","type":"function","z":"508957a1.dd5398","name":"create request","func":"// Get libraries\nconst Moment = global.get('moment');\nconst MomentRange = global.get('momentrange');\nconst moment = MomentRange.extendMoment(Moment)\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting'); \nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\n\n\nmsg.payload = msg.requestPayload\n\n\nreturn msg;","outputs":1,"noerr":0,"x":1320,"y":760,"wires":[["975f47b0.683f3"]]},{"id":"4d37f804.d37c5","type":"json","z":"508957a1.dd5398","name":"","property":"payload","action":"","pretty":false,"x":1590,"y":760,"wires":[["a6042701.1dde"]]},{"id":"a6042701.1dde","type":"http response","z":"508957a1.dd5398","name":"","statusCode":"","headers":{},"x":1690,"y":760,"wires":[]},{"id":"40d072f4.03fce4","type":"function","z":"508957a1.dd5398","name":"create request ****TEMP FIX**** ACTION","func":"// Get libraries\nconst Moment = global.get('moment');\nconst MomentRange = global.get('momentrange');\nconst moment = MomentRange.extendMoment(Moment)\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting'); \nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\n\nmessage = {\n    RevotioData: msg.RevotioData,\n    payload : msg.payload,\n    starttime : msg.starttime\n}\nid = new ObjectID()\n// msg = {}\n\nmsg.payload = [{ _id: id},\n    {requestData : message},\n    {upsert : true}\n]\n\nmsg.operation = \"updateOne\"\n\n\nfunction capitalizeFirstLetter(str) {\n  return str.charAt(0).toUpperCase() + str.slice(1);\n}\n\n\nif (msg.RevotioData.session.container && msg.RevotioData.session.container !== null && global.get(\"DomainProperties.routing\") &&  global.get(\"DomainProperties.routing\") !== \"local\"){\n// ******************************************************************\n    msg.url = msg.RevotioData.session.container + \"/\"\n    // msg.url = global.get(\"DomainProperties.url\")\n// ******************************************************************\n} else {\n    msg.url = global.get(\"DomainProperties.url\")\n}\n\n_.each(message.payload.Page.replace(/[^\\w\\s]/gi,\"\").split(\" \"), function(value, index){\n    msg.url = msg.url + capitalizeFirstLetter(value);\n})\n\n\n// msg.url = message.RevotioData.session.Page.replace(/ /g, '');\n\n\n\n\nmsg.requestPayload = {id:id, type :\"action\", data :message}\n\nreturn msg;","outputs":1,"noerr":0,"x":1080,"y":760,"wires":[["6965c6fa.5073d8"]]},{"id":"dee52d4e.18fdb","type":"function","z":"508957a1.dd5398","name":"create request ****TEMP FIX**** REDIRECT","func":"// Get libraries\nconst Moment = global.get('moment');\nconst MomentRange = global.get('momentrange');\nconst moment = MomentRange.extendMoment(Moment)\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting'); \nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\n\n\nmessage = {\n    // RevotioData: msg.RevotioData,\n    payload : msg.payload\n}\n\n// _.each(msg.payload, function(Item, key){\n    \n//     if (typeof Item === \"object\"){\n//         message[key] = {}\n//     } else {\n//         message[key] = Item\n//     }\n// })\nid = new ObjectID()\n// msg = {}\n\n// msg.payload = [{ _id: id},\n//     {requestData : message},\n//     {upsert : true}\n// ]\n\n// msg.operation = \"updateOne\"\n\n\nfunction capitalizeFirstLetter(str) {\n  return str.charAt(0).toUpperCase() + str.slice(1);\n}\n\nif (msg.payload.hasOwnProperty(\"presentationLayer\") === true && msg.payload.presentationLayer.hasOwnProperty(\"container\") === true && msg.RevotioData.session.container !== null  && global.get(\"DomainProperties.routing\") &&  global.get(\"DomainProperties.routing\") !== \"local\"){\n// ******************************************************************\n    msg.url =message.payload.presentationLayer.container + \"/\"\n    // msg.url = global.get(\"DomainProperties.url\")\n// ******************************************************************\n} else {\n    msg.url = global.get(\"DomainProperties.url\")\n}\n\n\n// if (msg.payload.presentationLayer.hasOwnProperty(\"groupedObject\") === true ){\n//     message.payload.presentationLayer = {\n//         groupedObject : msg.payload.presentationLayer.groupedObject\n//     }\n//         // groupedObject = msg.payload.presentationLayer.groupedObject\n// // groupedObject = groupedObject\n//     // msg.url = global.get(\"DomainProperties.url\")\n// // ******************************************************************\n// } \n\n\n_.each(message.payload.Page.replace(/[^\\w\\s]/gi,\"\").split(\" \"), function(value, index){\n    msg.url = msg.url + capitalizeFirstLetter(value);\n})\n\n//  msg.url.replace(/-/, \"\")\n\n// msg.url = message.RevotioData.session.Page.replace(/ /g, '');\n\n\n\n\nmsg.requestPayload = {id:id, type :\"design\", data : message}\n\nreturn msg;","outputs":1,"noerr":0,"x":1570,"y":940,"wires":[["3f2e4a2d.25f27e"]]},{"id":"fb965307.f2bdc","type":"http in","z":"e5822137.be45d","name":"OrganizationsGlobal","url":"/OrganizationsGlobal","method":"post","upload":false,"swaggerDoc":"","x":110,"y":360,"wires":[["5ad96e17.a754f8"]]},{"id":"5a5da070.ff4398","type":"link out","z":"e5822137.be45d","name":"","links":["ec952e8b.ee99"],"x":495,"y":320,"wires":[]},{"id":"e6c8f68c.3a8fd","type":"link out","z":"e5822137.be45d","name":"","links":["90f055d0.958ee8"],"x":495,"y":360,"wires":[]},{"id":"c44b4bde.0df218","type":"link out","z":"e5822137.be45d","name":"","links":["91850e71.061e1"],"x":495,"y":400,"wires":[]},{"id":"3e417daa.0d1532","type":"comment","z":"e5822137.be45d","name":"INIT","info":"","x":570,"y":360,"wires":[]},{"id":"b90601a5.f77f68","type":"comment","z":"e5822137.be45d","name":"DESIGN","info":"","x":580,"y":320,"wires":[]},{"id":"2d03ba7a.8f386e","type":"comment","z":"e5822137.be45d","name":"ROUTE","info":"","x":570,"y":400,"wires":[]},{"id":"bc77063b.1d43c8","type":"comment","z":"2294209a.0c95b","name":"***************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************","info":"","x":2470,"y":860.9998779296875,"wires":[]},{"id":"827557d5.fcca3","type":"subflow:39834eee.0dd5a2","z":"aec22158.fe4e38","name":"","env":[],"x":195,"y":299.99999618530273,"wires":[["1c72090c.42333f"]]},{"id":"c78d53d2.e65ff","type":"subflow:39834eee.0dd5a2","z":"aec22158.fe4e38","name":"","x":195,"y":859.9999961853027,"wires":[["35a2a99e.50eb36"]]},{"id":"cb673224.c23b78","type":"subflow:39834eee.0dd5a2","z":"aec22158.fe4e38","name":"","x":215,"y":1319.9999961853027,"wires":[["1121a4d9.54acc3"]]},{"id":"c4b9da22.c433d8","type":"subflow:39834eee.0dd5a2","z":"aec22158.fe4e38","name":"","x":215,"y":2119.9999961853027,"wires":[["777344ad.7bee8c"]]},{"id":"d7e5d821.5a91a8","type":"subflow:39834eee.0dd5a2","z":"2294209a.0c95b","name":"","x":1000,"y":380,"wires":[["693f75d0.9e78f4"]]},{"id":"c14b21e1.bdb88","type":"subflow:39834eee.0dd5a2","z":"e5822137.be45d","name":"","env":[],"x":800,"y":320,"wires":[["6953bde2.d417fc"]]},{"id":"66ac4ed4.7ee12","type":"http in","z":"508957a1.dd5398","name":"redirect","url":"/redirect","method":"post","upload":false,"swaggerDoc":"","x":90,"y":960,"wires":[["da7d3a96.7d58e"]]},{"id":"da7d3a96.7d58e","type":"function","z":"508957a1.dd5398","name":"Setup msg object","func":"// Get libraries\nconst Moment = global.get('moment');\nconst MomentRange = global.get('momentrange');\nconst moment = MomentRange.extendMoment(Moment)\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting'); \nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\n\n\npayload = msg.payload ;\n\ndelete msg.payload ;\n\n_.each(payload, function(value, key){\n    // if (typeof value ===  'string'){\n    //     msg[key] = value.trim()\n    // } else {\n        msg[key] = value\n    // }\n})\nreturn msg;","outputs":1,"noerr":0,"x":230,"y":960,"wires":[["1bb649ce.6a1376"]]},{"id":"3d5d3142.cf1206","type":"subflow:5e9b9c1d.bbe4a4","z":"508957a1.dd5398","name":"","env":[],"x":1780,"y":280,"wires":[]},{"id":"c8fb96e2.82848","type":"subflow:5e9b9c1d.bbe4a4","z":"508957a1.dd5398","name":"","env":[],"x":3020,"y":340,"wires":[]},{"id":"5fba24de.5173fc","type":"subflow:5e9b9c1d.bbe4a4","z":"508957a1.dd5398","name":"","env":[],"x":1000,"y":420,"wires":[]},{"id":"7167ce92.3c59c","type":"subflow:5e9b9c1d.bbe4a4","z":"508957a1.dd5398","name":"","env":[],"x":1000,"y":800,"wires":[]},{"id":"aee578b.d1a4a88","type":"subflow:5e9b9c1d.bbe4a4","z":"aec22158.fe4e38","name":"","env":[],"x":1635,"y":359.99999618530273,"wires":[]},{"id":"c374e685.14751","type":"subflow:5e9b9c1d.bbe4a4","z":"aec22158.fe4e38","name":"","env":[],"x":1895,"y":839.9999961853027,"wires":[]},{"id":"fa60834f.7ab0f","type":"subflow:5e9b9c1d.bbe4a4","z":"aec22158.fe4e38","name":"","env":[],"x":2035,"y":919.9999961853027,"wires":[]},{"id":"50553c0.ca774c4","type":"subflow:5e9b9c1d.bbe4a4","z":"aec22158.fe4e38","name":"","env":[],"x":4380,"y":920,"wires":[]},{"id":"4a4fa343.c95144","type":"subflow:5e9b9c1d.bbe4a4","z":"aec22158.fe4e38","name":"","env":[],"x":2855,"y":1339.9999961853027,"wires":[]},{"id":"74c995c2.07940c","type":"subflow:5e9b9c1d.bbe4a4","z":"aec22158.fe4e38","name":"","env":[],"x":3000,"y":2360,"wires":[]},{"id":"85e06edd.f24208","type":"subflow:5e9b9c1d.bbe4a4","z":"aec22158.fe4e38","name":"","env":[],"x":4640,"y":400,"wires":[]},{"id":"c0f97a1f.81ffc8","type":"subflow:5e9b9c1d.bbe4a4","z":"aec22158.fe4e38","name":"","env":[],"x":4640,"y":320,"wires":[]},{"id":"b42e2891.03848","type":"subflow:5e9b9c1d.bbe4a4","z":"aec22158.fe4e38","name":"","env":[],"x":2955,"y":299.99999618530273,"wires":[]},{"id":"5e3c68e9.35887","type":"subflow:5e9b9c1d.bbe4a4","z":"aec22158.fe4e38","name":"","env":[],"x":1340,"y":2240,"wires":[]},{"id":"6f35ce9c.ca2728","type":"subflow:5e9b9c1d.bbe4a4","z":"e5822137.be45d","name":"","env":[],"x":3760,"y":360,"wires":[]},{"id":"6e95417b.0deff","type":"subflow:5e9b9c1d.bbe4a4","z":"e5822137.be45d","name":"","env":[],"x":3880,"y":420,"wires":[]},{"id":"ecd2c396.4d9af","type":"subflow:a55f7aee.572be","z":"aec22158.fe4e38","name":"","env":[],"x":305,"y":539.9999961853027,"wires":[["c199e887.a6da4"],["e130563c.567048"],["82e73790.6bba78"]],"outputLabels":["DESIGN ","INIT","ACTION"]},{"id":"f467989a.2c7b","type":"subflow:a55f7aee.572be","z":"aec22158.fe4e38","name":"","env":[],"x":345,"y":1059.9999961853027,"wires":[["18c634ff.b1dad3"],["6537bec2.9226e8"],["e8682458.5b8fb"]],"outputLabels":["DESIGN ","INIT","ACTION"]},{"id":"fc712911.f455d8","type":"subflow:a55f7aee.572be","z":"aec22158.fe4e38","name":"","env":[],"x":445,"y":1539.9999961853027,"wires":[["c42395c9.e7a698"],["839b0669.2a35d"],["e84a1d06.e6f258"]],"outputLabels":["DESIGN ","INIT","ACTION"]},{"id":"3f566bdd.bca52c","type":"subflow:a55f7aee.572be","z":"aec22158.fe4e38","name":"","env":[],"x":385,"y":2339.9999961853027,"wires":[["e98e6ae3.ce1128"],["8b9609e7.cfa4c8"],["32198700.e5b5b8"]],"outputLabels":["DESIGN ","INIT","ACTION"]},{"id":"e5a5de01.a1ac3","type":"subflow:a55f7aee.572be","z":"2294209a.0c95b","name":"","env":[],"x":230,"y":480,"wires":[["ff290d23.18df18"],["b0ae31e0.11c9e8"],["be4224db.bfd728"]],"outputLabels":["DESIGN ","INIT","ACTION"]},{"id":"5ad96e17.a754f8","type":"subflow:a55f7aee.572be","z":"e5822137.be45d","name":"","env":[],"x":330,"y":360,"wires":[["5a5da070.ff4398"],["e6c8f68c.3a8fd"],["c44b4bde.0df218"]],"outputLabels":["DESIGN ","INIT","ACTION"]},{"id":"8a98de87.332c38","type":"comment","z":"508957a1.dd5398","name":"Global gadgets","info":"","x":160,"y":2000,"wires":[]},{"id":"a6bb1f75.b71ea","type":"function","z":"508957a1.dd5398","name":"Trigger remove actions per entity","func":"// Get libraries\nconst Moment = global.get('moment');\nconst MomentRange = global.get('momentrange');\nconst moment = MomentRange.extendMoment(Moment);\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\n\n\n// delete all sub entities first\n_.each(msg.payload,function(SubItem, SubIndex){\n    node.send({organization_id:new ObjectID(SubItem._id)})\n} )\n\n// continue with main entity removal\n\nreturn msg;","outputs":1,"noerr":0,"x":1220,"y":2060,"wires":[["e4a2cb6b.ee4418","b842fe40.90a778","9c1da85e.48053"]]},{"id":"9548cd04.dd18","type":"function","z":"508957a1.dd5398","name":"Trigger delete project data","func":"// Get libraries\nconst Moment = global.get('moment');\nconst MomentRange = global.get('momentrange');\nconst moment = MomentRange.extendMoment(Moment);\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\n\nif (msg.done === false ){\n    node.send(msg)\n}\n","outputs":1,"noerr":0,"x":1860,"y":2020,"wires":[["1b541ac0.d02bb5"]]},{"id":"772ffe54.54c5e8","type":"function","z":"508957a1.dd5398","name":"check if msg.organization_id is present and prepair child lookup","func":"var BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\n\n\nvar valid, invalid\nif (msg.payload.hasOwnProperty(\"organization_id\")){\n\n    payload = {\"$or\": [{parent_id : new ObjectID(msg.payload.organization_id)}, {_id : new ObjectID(msg.payload.organization_id)} ] }\n    msg.operation = 'find.toArray'\n    msg.payload = payload\n    valid = msg\n} else {\n    invalid = msg\n}\n\nreturn [valid, invalid]","outputs":2,"noerr":0,"x":650,"y":2080,"wires":[["49d18cf3.10bffc"],["84581731.46c528"]],"outputLabels":["valid, ","invalid"]},{"id":"5e3674f6.75785c","type":"comment","z":"508957a1.dd5398","name":"Delete all organization Data","info":"","x":280,"y":2040,"wires":[]},{"id":"96251a.42faa2e8","type":"link in","z":"508957a1.dd5398","name":"Delete all organization Data","links":["755fb71d.d2028","bfc74af8.6937b"],"x":415,"y":2040,"wires":[["772ffe54.54c5e8","92f7b82b.753758"]]},{"id":"95fbcc07.06d0d8","type":"function","z":"508957a1.dd5398","name":"Get all app pages ","func":"var request = global.get('request');\nvar Moment = global.get('moment');var MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\n\n// find  \nfindObj = {\n                    query : {\n                            query : {\tapplication_id : new ObjectID(msg.payload.application_id)},\n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'pages',\n                    operation:'find',\n                    }\n\n            mongodbTools.resolveAsync(findObj, node, function(res){\n                    msg.payload = res\n                    node.send(msg) \n            })  \n// return msg;","outputs":1,"noerr":0,"x":990,"y":2140,"wires":[["58489cdd.d68c94"]]},{"id":"470f9615.b75dc","type":"comment","z":"508957a1.dd5398","name":"Delete all application data","info":"","x":310,"y":2160,"wires":[]},{"id":"7a432a0c.79afbc","type":"link in","z":"508957a1.dd5398","name":"Delete all project data","links":["1b541ac0.d02bb5","b298aff4.badb78","e9fb6492.5b068"],"x":395,"y":2160,"wires":[["5991555.e1515ac","1ea0e68c.3991f9"]]},{"id":"6a22c9d1.d1b99","type":"function","z":"508957a1.dd5398","name":"Libs","func":"// Get libraries\nconst Moment = global.get('moment');\nconst MomentRange = global.get('momentrange');\nconst moment = MomentRange.extendMoment(Moment);\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\n\nif ( Array.isArray(msg.payload)){\n   _.each(msg.payload, function(Item, Index){\n    \n    msg.page_id = Item._id\n    node.send(msg);\n    \n    \n}); \n} else if (msg.payload.hasOwnProperty(\"page_id\")) {\n    msg.page_id = msg.payload.page_id\n    node.send(msg);\n} else{\n      msg.page_id = msg.payload._id\n    node.send(msg);\n}\n\n\n\n// return msg;","outputs":1,"noerr":0,"x":450,"y":2280,"wires":[["7ceb5cfd.26cd9c"]]},{"id":"cfb9798c.de63c8","type":"comment","z":"508957a1.dd5398","name":"Remove all page data","info":"","x":280,"y":2240,"wires":[]},{"id":"1c315256.30db66","type":"link in","z":"508957a1.dd5398","name":"Remove all wp data","links":["58489cdd.d68c94","5bc91a39.2b348c","cf312f50.45a118","148a291d.254577"],"x":375,"y":2240,"wires":[["6a22c9d1.d1b99","7af2cd05.9b0044"]]},{"id":"1b541ac0.d02bb5","type":"link out","z":"508957a1.dd5398","name":"","links":["7a432a0c.79afbc"],"x":1995,"y":2020,"wires":[]},{"id":"58489cdd.d68c94","type":"link out","z":"508957a1.dd5398","name":"","links":["1c315256.30db66"],"x":1115,"y":2140,"wires":[]},{"id":"73343394.a4587c","type":"http in","z":"508957a1.dd5398","name":"removeOrganization","url":"/removeOrganization","method":"post","upload":false,"swaggerDoc":"","x":310,"y":2080,"wires":[["772ffe54.54c5e8","92f7b82b.753758"]]},{"id":"834dea4d.06b3a8","type":"http in","z":"508957a1.dd5398","name":"removeApplication","url":"/removeApplication","method":"post","upload":false,"swaggerDoc":"","x":270,"y":2200,"wires":[["5991555.e1515ac","1ea0e68c.3991f9"]]},{"id":"9aa58cd7.cd31b","type":"http in","z":"508957a1.dd5398","name":"removePage","url":"/removePage","method":"post","upload":false,"swaggerDoc":"","x":270,"y":2280,"wires":[["6a22c9d1.d1b99","7af2cd05.9b0044"]]},{"id":"521fb03f.d3a258","type":"http response","z":"508957a1.dd5398","name":"","statusCode":"","headers":{},"x":770,"y":2280,"wires":[]},{"id":"84581731.46c528","type":"http response","z":"508957a1.dd5398","name":"","statusCode":"","headers":{},"x":950,"y":2100,"wires":[]},{"id":"5991555.e1515ac","type":"function","z":"508957a1.dd5398","name":"check if msg.application_id is present and prepair child lookup","func":"var BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\n\nvar valid, invalid\nif (msg.payload.hasOwnProperty(\"application_id\")){\n\n    // payload = {parent_id : new ObjectID(msg.payload.project_id)}\n    // msg.operation = 'find.toArray'\n    // msg.payload = payload\n    valid = msg\n} else {\n    invalid = msg\n}\n\nreturn [valid, invalid]","outputs":2,"noerr":0,"x":650,"y":2200,"wires":[["95fbcc07.06d0d8","6fd6f4e9.852dfc"],["71ca154d.fb77fc"]],"outputLabels":["valid, ","invalid"]},{"id":"71ca154d.fb77fc","type":"http response","z":"508957a1.dd5398","name":"","statusCode":"","headers":{},"x":950,"y":2220,"wires":[]},{"id":"b742db6e.8148f","type":"link out","z":"2294209a.0c95b","name":"Topbar  frontend post","links":["23272508.4d696a","2475f18f.18f84e","f85b9845.a955d","8b4ff2ec.3247b","bfe4a65b.e868c","68a613e1.7d23cc","a8407940.280928","cd2e935f.5b6348","c6ab18b6.cf792","915fe08d.d804b","839882ba.4c8cf8","4248f1d.8cffc1","fa74879d.d6538","dfb2e790.ced988","5152dc4f.eabc94","271f0775.5ac628","7b149429.0d56fc","7a011268.2223d4","26dc0660.b1e4ba","59afb9fb.3ba0c8","9c32caf9.c7e008","8be6a719.2a64e","6a41100.61cc07","480dae32.8a339"],"x":3035,"y":600,"wires":[]},{"id":"c6410018.e4f6e","type":"http request","z":"152aab03.7a806d","name":"","method":"POST","ret":"txt","paytoqs":false,"url":"","tls":"","proxy":"","authType":"basic","x":510,"y":380,"wires":[["58c085e7.5e88a4","8366c6b2.7951b8"]]},{"id":"b4440fc5.ad787","type":"function","z":"152aab03.7a806d","name":"menu call","func":"\npayload = {\n    payload : msg.payload,\n    RevotioData: msg.RevotioData\n}\n\nmsg.payload = payload\n\nmsg.url = global.get(\"DomainProperties.form-menu\")+ \"menu\"\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":400,"y":380,"wires":[["c6410018.e4f6e"]]},{"id":"de32b4e0.6e0cb","type":"subflow:152aab03.7a806d","z":"2294209a.0c95b","name":"","env":[],"x":2960,"y":600,"wires":[["b742db6e.8148f"]]},{"id":"301d64c9.14362c","type":"function","z":"3170c4ab.fadb9c","name":"Form call","func":"\npayload = {\n    payload : msg.payload,\n    RevotioData: msg.RevotioData\n}\nmsg.payload = payload\nmsg.url = global.get(\"DomainProperties.form-menu\")+ \"form\"\nreturn msg;","outputs":1,"noerr":0,"x":500,"y":260,"wires":[["9f77dd79.1dfd58"]]},{"id":"9f77dd79.1dfd58","type":"http request","z":"3170c4ab.fadb9c","name":"","method":"POST","ret":"txt","paytoqs":false,"url":"","tls":"","proxy":"","authType":"basic","x":630,"y":340,"wires":[["4cf371cf.b278d8"]]},{"id":"a59768fe.a6a258","type":"subflow:3170c4ab.fadb9c","z":"2294209a.0c95b","name":"","x":3560,"y":420,"wires":[["da96270c.50aa4"]]},{"id":"da96270c.50aa4","type":"link out","z":"2294209a.0c95b","name":"Topbar  frontend post","links":["23272508.4d696a","2475f18f.18f84e","f85b9845.a955d","8b4ff2ec.3247b","bfe4a65b.e868c","68a613e1.7d23cc","a8407940.280928","cd2e935f.5b6348","c6ab18b6.cf792","915fe08d.d804b","839882ba.4c8cf8","4248f1d.8cffc1","fa74879d.d6538","dfb2e790.ced988","5152dc4f.eabc94","271f0775.5ac628","7b149429.0d56fc","7a011268.2223d4","26dc0660.b1e4ba","59afb9fb.3ba0c8","9c32caf9.c7e008","8be6a719.2a64e","6a41100.61cc07","480dae32.8a339"],"x":3635,"y":420,"wires":[]},{"id":"6db87728.a54d58","type":"subflow:3170c4ab.fadb9c","z":"2294209a.0c95b","name":"","env":[],"x":3120,"y":540,"wires":[["2a3f6b04.a7f3bc"]]},{"id":"2a3f6b04.a7f3bc","type":"link out","z":"2294209a.0c95b","name":"Topbar  frontend post","links":["23272508.4d696a","2475f18f.18f84e","f85b9845.a955d","8b4ff2ec.3247b","bfe4a65b.e868c","68a613e1.7d23cc","a8407940.280928","cd2e935f.5b6348","c6ab18b6.cf792","915fe08d.d804b","839882ba.4c8cf8","4248f1d.8cffc1","fa74879d.d6538","dfb2e790.ced988","5152dc4f.eabc94","271f0775.5ac628","7b149429.0d56fc","7a011268.2223d4","26dc0660.b1e4ba","59afb9fb.3ba0c8","9c32caf9.c7e008","8be6a719.2a64e","6a41100.61cc07","480dae32.8a339"],"x":3195,"y":540,"wires":[]},{"id":"b0ed4707.f5ac","type":"subflow:3170c4ab.fadb9c","z":"2294209a.0c95b","name":"","env":[],"x":3100,"y":760,"wires":[["f438ead1.51c198"]]},{"id":"f438ead1.51c198","type":"link out","z":"2294209a.0c95b","name":"Topbar  frontend post","links":["23272508.4d696a","2475f18f.18f84e","f85b9845.a955d","8b4ff2ec.3247b","bfe4a65b.e868c","68a613e1.7d23cc","a8407940.280928","cd2e935f.5b6348","c6ab18b6.cf792","915fe08d.d804b","839882ba.4c8cf8","4248f1d.8cffc1","fa74879d.d6538","dfb2e790.ced988","5152dc4f.eabc94","271f0775.5ac628","7b149429.0d56fc","7a011268.2223d4","26dc0660.b1e4ba","59afb9fb.3ba0c8","9c32caf9.c7e008","8be6a719.2a64e","6a41100.61cc07","480dae32.8a339"],"x":3175,"y":760,"wires":[]},{"id":"e7a48cc8.cc60d8","type":"link out","z":"e5822137.be45d","name":"Topbar  frontend post","links":["23272508.4d696a","2475f18f.18f84e","f85b9845.a955d","8b4ff2ec.3247b","bfe4a65b.e868c","68a613e1.7d23cc","a8407940.280928","cd2e935f.5b6348","c6ab18b6.cf792","915fe08d.d804b","839882ba.4c8cf8","4248f1d.8cffc1","fa74879d.d6538","dfb2e790.ced988","5152dc4f.eabc94","271f0775.5ac628","7b149429.0d56fc","7a011268.2223d4","26dc0660.b1e4ba","59afb9fb.3ba0c8","9c32caf9.c7e008","8be6a719.2a64e","a6ee6331.070228","6a41100.61cc07","c76409e8.f61b3"],"x":3735,"y":400,"wires":[]},{"id":"b4232b59.fc3c9","type":"subflow:152aab03.7a806d","z":"e5822137.be45d","name":"","env":[],"x":3640,"y":400,"wires":[["e7a48cc8.cc60d8","783e2299.1db02c"]]},{"id":"229e849a.2b771c","type":"subflow:3170c4ab.fadb9c","z":"e5822137.be45d","name":"","env":[],"x":3800,"y":280,"wires":[["402f0b1e.b2f10c"]]},{"id":"402f0b1e.b2f10c","type":"link out","z":"e5822137.be45d","name":"Topbar  frontend post","links":["23272508.4d696a","2475f18f.18f84e","f85b9845.a955d","8b4ff2ec.3247b","bfe4a65b.e868c","68a613e1.7d23cc","a8407940.280928","cd2e935f.5b6348","c6ab18b6.cf792","915fe08d.d804b","839882ba.4c8cf8","4248f1d.8cffc1","fa74879d.d6538","dfb2e790.ced988","5152dc4f.eabc94","271f0775.5ac628","7b149429.0d56fc","7a011268.2223d4","26dc0660.b1e4ba","59afb9fb.3ba0c8","9c32caf9.c7e008","8be6a719.2a64e","a6ee6331.070228","6a41100.61cc07","c76409e8.f61b3"],"x":3915,"y":280,"wires":[]},{"id":"bcb372ba.8288e8","type":"subflow:3170c4ab.fadb9c","z":"e5822137.be45d","name":"","env":[],"x":3880,"y":460,"wires":[["4e30d34a.94d17c"]]},{"id":"4e30d34a.94d17c","type":"link out","z":"e5822137.be45d","name":"Topbar  frontend post","links":["23272508.4d696a","2475f18f.18f84e","f85b9845.a955d","8b4ff2ec.3247b","bfe4a65b.e868c","68a613e1.7d23cc","a8407940.280928","cd2e935f.5b6348","c6ab18b6.cf792","915fe08d.d804b","839882ba.4c8cf8","4248f1d.8cffc1","fa74879d.d6538","dfb2e790.ced988","5152dc4f.eabc94","271f0775.5ac628","7b149429.0d56fc","7a011268.2223d4","26dc0660.b1e4ba","59afb9fb.3ba0c8","9c32caf9.c7e008","8be6a719.2a64e","a6ee6331.070228","6a41100.61cc07","c76409e8.f61b3"],"x":3955,"y":460,"wires":[]},{"id":"3e910553.3e65aa","type":"subflow:152aab03.7a806d","z":"e5822137.be45d","name":"","env":[],"x":1480,"y":440,"wires":[["ec6b9f6a.c0a41"]]},{"id":"ec6b9f6a.c0a41","type":"link out","z":"e5822137.be45d","name":"Topbar  frontend post","links":["23272508.4d696a","2475f18f.18f84e","f85b9845.a955d","8b4ff2ec.3247b","bfe4a65b.e868c","68a613e1.7d23cc","a8407940.280928","cd2e935f.5b6348","c6ab18b6.cf792","915fe08d.d804b","839882ba.4c8cf8","4248f1d.8cffc1","fa74879d.d6538","dfb2e790.ced988","5152dc4f.eabc94","271f0775.5ac628","7b149429.0d56fc","7a011268.2223d4","26dc0660.b1e4ba","59afb9fb.3ba0c8","9c32caf9.c7e008","8be6a719.2a64e","a6ee6331.070228","6a41100.61cc07","c76409e8.f61b3"],"x":1735,"y":440,"wires":[]},{"id":"58c085e7.5e88a4","type":"json","z":"152aab03.7a806d","name":"","property":"payload","action":"","pretty":false,"x":630,"y":380,"wires":[["f4360e46.6f855","a8aa2565.f73818"]]},{"id":"4cf371cf.b278d8","type":"json","z":"3170c4ab.fadb9c","name":"","property":"payload","action":"","pretty":false,"x":750,"y":260,"wires":[["3ca50242.9fc416"]]},{"id":"4602b7fe.7067e8","type":"subflow:5e9b9c1d.bbe4a4","z":"152aab03.7a806d","name":"","x":1080,"y":260,"wires":[]},{"id":"a7b9f68.e4bd088","type":"http response","z":"152aab03.7a806d","name":"","statusCode":"","headers":{},"x":1090,"y":300,"wires":[]},{"id":"6fec3c3b.ef2c44","type":"function","z":"152aab03.7a806d","name":"Route response menu","func":"var redirect,logout, other;\n\nif (msg.payload.hasOwnProperty(\"payload\")){\n    payload = msg.payload.payload\n    msg.RevotioData = msg.payload.RevotioData\n    msg.payload = payload\n}\n\n\nif (msg.payload.hasOwnProperty(\"Page\")){\n    redirect = msg;\n} else if (msg.payload.hasOwnProperty(\"RevotioData\")  && msg.payload.RevotioData.hasOwnProperty(\"logout\")  &&msg.payload.RevotioData.logout === true){\n    logout = msg;\n} else {\n    other = msg;\n}\n\nreturn [redirect,logout, other];","outputs":3,"noerr":0,"x":860,"y":280,"wires":[["4602b7fe.7067e8"],["a7b9f68.e4bd088"],[]],"outputLabels":["redirect","logout","other"]},{"id":"3ca50242.9fc416","type":"function","z":"3170c4ab.fadb9c","name":"Route response form","func":"\nif (msg.payload.hasOwnProperty('Form')){\n    payload = msg.payload.payload\n    msg.RevotioData.FlowData.Form = msg.payload.Form\n    msg.payload = payload\n}\n\n\nvar redirect, other\nif (msg.payload.hasOwnProperty(\"presentationLayer\") || msg.payload.hasOwnProperty(\"data\") ){\n   redirect = msg; \n} else {\n    other = msg;\n}\nreturn [redirect, other];","outputs":2,"noerr":0,"initialize":"","finalize":"","x":920,"y":260,"wires":[["63027655.f17e48"],[]],"outputLabels":["redirect, ","other"]},{"id":"63027655.f17e48","type":"http response","z":"3170c4ab.fadb9c","name":"","statusCode":"","headers":{},"x":1150,"y":240,"wires":[]},{"id":"62aa0677.77b8f","type":"http response","z":"508957a1.dd5398","name":"","statusCode":"","headers":{},"x":1650,"y":1980,"wires":[]},{"id":"e4a2cb6b.ee4418","type":"function","z":"508957a1.dd5398","name":"Remove Organization","func":"var request = global.get('request');\nvar Moment = global.get('moment');var MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\n// remove \n            removeObj = {\n                    query : {\n                            query :{_id : new ObjectID(msg.organization_id)}, \n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'organizations',\n                    operation:'remove',\n                    }\n\n            mongodbTools.resolveAsync(removeObj, node, function(res){\n                    msg.result = res\n                    node.send(msg) \n            }) ","outputs":1,"noerr":0,"x":1500,"y":1980,"wires":[["62aa0677.77b8f"]]},{"id":"b5118d30.e7abd","type":"comment","z":"e25f5e2d.45871","name":"Push Gadgets to frontend","info":"","x":170,"y":160,"wires":[]},{"id":"242f58f1.b6c22","type":"function","z":"e25f5e2d.45871","name":"Get gadgetContainers Object","func":"var request = global.get('request');\nvar Moment = global.get('moment');var MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar crypto = global.get('crypto');\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\nvar response, sessionUpdate , timer ;\nvar totalNumberOfGadgets, currentNumberOfGadgets;\nvar deviceId = msg.session.deviceId;\nvar revotioSessionId = msg.session.revotioSessionId ;\nvar token = msg.session.token\n\nmsg.test = []\n\nmsg.endtime = new Date()\n\n\n// if ( msg.session.Gadgets.length === 0  ){\n//     timer = msg;\n// }\n\n// msg.test.push({level:1})\n// _.each(msg.payload.gadgetsList, function(item, Index){\n//     item.endtime = new Date()\n//     item.starttime = msg.starttime\n//     item.diff = new Date(item.endtime) - new Date(msg.starttime)\n//     // GadgetArray = global.get('gadgetGroups.' + deviceId + \".\" + revotioSessionId+\".Gadgets\")\n    \n//     msg.session.Gadgets.push(item)\n    \n//     // update    \n\n \n\n// })\n\n\n\n// *********************\n// msg.test.push({Gadgets :global.get('gadgetGroups.' + deviceId + \".\" + revotioSessionId+\".Gadgets\"), Type:\"stage 1\" })\n// *********************\n\ncurrentNumberOfGadgets = msg.session.Gadgets.length;\n\n// msg.test.push({level:2})\nif (msg.session.groupedObject.hasOwnProperty(msg.RevotioData.entity)){\n    msg.test.push({level:3.1})\n    totalNumberOfGadgets = msg.session.groupedObject[msg.RevotioData.entity].length\n    msg.test.push({level:3.2})\n    \n} else {\n     msg.test.push({level:4.1})\n    totalNumberOfGadgets = msg.session.groupedObject.INIT.length\n    // totalNumberOfGadgets = global.get('gadgetGroups.' + deviceId + \".\" + revotioSessionId+\".groupedObject.INIT\").length\n    msg.test.push({level:4.2})\n    \n}\n\n// *********************\n// msg.test.push({             Gadgets :global.get('gadgetGroups.' + deviceId + \".\" + revotioSessionId+\".Gadgets\"), \n//                             Type:\"stage 2\", \n//                             totalNumberOfGadgets:totalNumberOfGadgets, \n//                             currentNumberOfGadgets:currentNumberOfGadgets })\n// *********************\n\nif (  \n        (totalNumberOfGadgets <= currentNumberOfGadgets) ){\n    \n    msg.payload = {\n        deviceId: deviceId,\n        revotioSessionId: revotioSessionId,\n        token: token,\n        gadgetsList : msg.session.Gadgets,\n        Type: \"Update\"\n        \n    }\n    \n    msg.headers = {\n    'Access-Control-Allow-Origin': '*',\n    'Access-Control-Allow-Methods': 'PUT,GET,POST,DELETE,OPTIONS',\n    'Access-Control-Allow-Headers': 'Content-Type',\n    'content-type': 'application/json',\n};\n\n    response = msg; \n    \n\n    updateObj = {\n                    query : {\n                            query :{_id:new ObjectID(msg.session._id)}, \n                            update : { \"$set\" : {Gadgets : [],\n                                                timestamp: new Date(),\n                                                responseSend : false\n                            }},\n                            options : {upsert: true}\n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'sessions',\n                    operation:'update', // updateMany , updateOne\n                    }\n\n            mongodbTools.resolveAsync(updateObj, node, function(res){\n            \n                \n            })  \n\n\n\n \nresponse = {\n    req : msg.req,\n    res : msg.res,\n    payload : msg.payload,\n    headers : msg.headers,\n}\nsessionUpdate = {RevotioData : msg.RevotioData}\n\nreturn [response, sessionUpdate] } \n\nelse {\n    return [response, sessionUpdate,timer];\n}\n\n    \n\n","outputs":3,"noerr":0,"initialize":"","finalize":"","x":430,"y":220,"wires":[["54a1b615.985f98"],["c87843fd.57c39"],["20224679.81494a"]],"outputLabels":["response","sessionUpdate",""]},{"id":"9690ddef.823e3","type":"http response","z":"e25f5e2d.45871","name":"","statusCode":"","headers":{},"x":1570,"y":120,"wires":[]},{"id":"5d28c909.86bda","type":"comment","z":"e25f5e2d.45871","name":"Generate response Object","info":"","x":190,"y":80,"wires":[]},{"id":"c87843fd.57c39","type":"function","z":"e25f5e2d.45871","name":"Update DB Session object","func":"var request = global.get('request');\nvar Moment = global.get('moment');var MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\nObj =  {FlowData: msg.RevotioData.FlowData, timestamp : new Date()\n};\n// msg.payload = [{deviceId: msg.RevotioData.session.deviceId, revotioSessionId: msg.RevotioData.session.revotioSessionId},{\"$set\" : Obj},{upsert : true}];\n\n// msg.operation = 'updateOne';\n\n// update    \n    updateObj = {\n                    query : {\n                            query :{deviceId: msg.RevotioData.session.deviceId, revotioSessionId: msg.RevotioData.session.revotioSessionId}, \n                            update : {\"$set\" : Obj},\n                            options : {upsert: true}\n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'sessions',\n                    operation:'update', // updateMany , updateOne\n                    }\n\n            mongodbTools.resolveAsync(updateObj, node, function(res){\n                    // msg.result = res\n                    // node.send(msg) \n            })  \n            \n            \n// return msg;","outputs":1,"noerr":0,"x":1200,"y":240,"wires":[[]]},{"id":"20224679.81494a","type":"delay","z":"e25f5e2d.45871","name":"Variable delay || 5000 milliseconds","pauseType":"delayv","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":440,"y":280,"wires":[["6c4dc95f.5f22c"]]},{"id":"6267a6f2.146138","type":"function","z":"e25f5e2d.45871","name":"`check if response needs to be enforced","func":"// Get libraries\nconst Moment = global.get('moment');\nconst MomentRange = global.get('momentrange');\nconst moment = MomentRange.extendMoment(Moment);\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\n\nvar delay, response, sessionUpdate;\nvar deviceId = msg.sessionNew.deviceId ; \nvar revotioSessionId = msg.sessionNew.revotioSessionId ;\n\n\nif (        msg.sessionNew.hasOwnProperty(\"timestamp\") && \n        moment().diff(moment(msg.sessionNew.timestamp) > global.get(\"SystemVars.responseTimeout\"))){\n            \n       \n    \n        payload = {\n            deviceId: deviceId,\n            revotioSessionId: revotioSessionId,\n            gadgetsList :msg.sessionNew.Gadgets,\n            Type: \"Update\",\n            TimeOut : true\n            \n        }\n    \n        headers = {\n            'Access-Control-Allow-Origin': '*',\n            'Access-Control-Allow-Methods': 'PUT,GET,POST,DELETE,OPTIONS',\n            'Access-Control-Allow-Headers': 'Content-Type',\n            'content-type': 'application/json',\n        };\n\n       \n    updateObj = {\n                    query : {\n                            query :{_id:new ObjectID(msg.sessionNew._id)}, \n                            update : { \"$set\" : {Gadgets : [],\n                                                timestamp: new Date(),\n                                                responseSend : false\n                            }},\n                            options : {upsert: true}\n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'sessions',\n                    operation:'update', // updateMany , updateOne\n                    }\n\n            mongodbTools.resolveAsync(updateObj, node, function(res){\n            }) \n \n        response = {\n            req : msg.req,\n            res : msg.res,\n            payload : payload,\n            headers : headers,\n        }\n        \n        sessionUpdate = {RevotioData : msg.RevotioData}\n\n            \n        } else if (msg.sessionNew.hasOwnProperty(\"timestamp\")) {\n            msg.time = moment().diff(moment(msg.sessionNew.timestamp))\n            \n            if ( global.get(\"SystemVars\").hasOwnProperty(\"delaySize\") ){\n                 msg.delay = global.get(\"SystemVars.delaySize\") \n            }\n          \n            delay = msg;\n        }\n   \n   \nreturn [delay, response, sessionUpdate];","outputs":3,"noerr":0,"x":740,"y":380,"wires":[["20224679.81494a"],["54a1b615.985f98"],["c87843fd.57c39"]],"outputLabels":["delay","response","sessionUpdate"]},{"id":"d6bad25b.32468","type":"catch","z":"a2b40f09.d18fd8","name":"","scope":null,"x":180,"y":60,"wires":[["a33af86.64c9d08"]]},{"id":"a33af86.64c9d08","type":"debug","z":"a2b40f09.d18fd8","name":"ERROR","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"true","targetType":"full","x":300,"y":60,"wires":[]},{"id":"1a55a0c3.a8f35f","type":"link out","z":"508957a1.dd5398","name":"","links":["dc664b4f.0d82e","a1a4c9c0.c43b6"],"x":275,"y":400,"wires":[]},{"id":"9dfd3d8b.23a038","type":"comment","z":"508957a1.dd5398","name":"CHECK GC state","info":"","x":360,"y":400,"wires":[]},{"id":"d2a7b91c.174a08","type":"link out","z":"508957a1.dd5398","name":"","links":["dc664b4f.0d82e","a1a4c9c0.c43b6"],"x":295,"y":640,"wires":[]},{"id":"89012a78.5078c","type":"comment","z":"508957a1.dd5398","name":"CHECK GC state","info":"","x":400,"y":640,"wires":[]},{"id":"77a61ff7.3ac9d","type":"link out","z":"508957a1.dd5398","name":"","links":["dc664b4f.0d82e","a1a4c9c0.c43b6"],"x":235,"y":820,"wires":[]},{"id":"1212e3b2.f2f924","type":"comment","z":"508957a1.dd5398","name":"CHECK GC state","info":"","x":320,"y":820,"wires":[]},{"id":"f6d62ac3.629338","type":"function","z":"aec22158.fe4e38","name":"Cancel reset btn","func":"// Admin buttons\n\nmsg.payload = {\n    gadgetsList : [{            \n      \"gadgetId\": \"de786f35-541f-0e64-fc3f-089677920985\",\n      \"gadgetName\": \"Cancel reset btn\",\n      \"gadgetType\": \"dynamic-btn\",\n            \"gadgetOptions\":\n                {\"types\":\"\",\n                \"styles\":[\"btn-info\"],\n                \"buttonalign\":\"right\",\n                \"textcolor\":\"black\",\n                \"buttonlabel\":\"Cancel password reset\"},\n                // \"gadgetData\":\"create_project\"\n       \n   }]\n}\n\n\n\n\nreturn msg;","outputs":1,"noerr":0,"x":700,"y":2180,"wires":[["b62f16e5.5c7998"]]},{"id":"cae94cae.9e3458","type":"link in","z":"aec22158.fe4e38","name":"","links":["8b9609e7.cfa4c8"],"x":615,"y":2180,"wires":[["f6d62ac3.629338"]]},{"id":"b62f16e5.5c7998","type":"link out","z":"aec22158.fe4e38","name":"","links":["1766e26.2df601e","15f8aeef.16f7d1","6510415f.c64d6","14c789ed.fd90f6","172bf3ee.b9865c","e6548cdd.b0501","43e1a714.c877a8","228b07a6.f5d6a8","101c6a60.58ca1e","b0f61403.73aa18","d6cfe34e.7be1d","2f3e87cf.a0111","5171869d.c0b8a8","ffc46262.694388","3356ae90.b06682","1f447df2.f79d1a","84cfac4f.42a868","3a82fd2b.90627a","4809e15c.231538","4675a1ec.757c6","82336b76.b7c958","b824f5cf.104838","6a1ab5fc.dff14c","692c6501.32656c","14264b85.6baf9c","e358d072.f3562","6cc00ce9.6960a4"],"x":795,"y":2180,"wires":[]},{"id":"ba5ecdcd.97009","type":"function","z":"aec22158.fe4e38","name":"prepair redirect to NonAuthDefaultPage","func":"\nmsg.payload  = {\n    Page :global.get(\"DomainProperties.NonAuthDefaultPage\"),\n}\nreturn msg;","outputs":1,"noerr":0,"x":2240,"y":2380,"wires":[["f374ea1a.cac74"]]},{"id":"f374ea1a.cac74","type":"subflow:5e9b9c1d.bbe4a4","z":"aec22158.fe4e38","name":"","env":[],"x":2440,"y":2380,"wires":[]},{"id":"dc2349a8.d26158","type":"http in","z":"508957a1.dd5398","name":"entrance","url":"/entrance","method":"post","upload":false,"swaggerDoc":"","x":120,"y":340,"wires":[["1a55a0c3.a8f35f","f6b3771f.d41548"]]},{"id":"180d6542.0d51fb","type":"http in","z":"508957a1.dd5398","name":"initialize","url":"/initialize","method":"post","upload":false,"swaggerDoc":"","x":110,"y":600,"wires":[["d2a7b91c.174a08","13c4294b.23613f"]]},{"id":"f0e5ba26.618eb8","type":"http in","z":"508957a1.dd5398","name":"action","url":"/action","method":"post","upload":false,"swaggerDoc":"","x":90,"y":780,"wires":[["77a61ff7.3ac9d","1d0b4bad.c78bcc"]]},{"id":"2780dc99.05adfc","type":"function","z":"2ef93158.ae5276","name":"Generic topbar design settings","func":"// Get libraries\nconst Moment = global.get('moment');\nconst MomentRange = global.get('momentrange');\nconst moment = MomentRange.extendMoment(Moment)\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting'); \nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\n\nif (msg.payload.hasOwnProperty(\"design\") === false ){\n    msg.payload.design = {}\n}\n\n_.each(global.get('topbar_design') , function(value, key){\n    \n    if (key === \"pageSpecificContanerPlaceholder\"){\n        msg.payload.design[msg.topbarContanerId] = value\n    } else {\n       msg.payload.design[key] = value\n    }\n    \n})\n\n\nreturn msg;","outputs":1,"noerr":0,"x":190,"y":80,"wires":[[]]},{"id":"bf03eb39.4bf4a8","type":"subflow:2ef93158.ae5276","z":"e5822137.be45d","name":"","env":[],"x":1170,"y":320,"wires":[["df6d2863.899c68"]]},{"id":"9293b380.aed2b","type":"subflow:2ef93158.ae5276","z":"2294209a.0c95b","name":"","env":[],"x":1440,"y":380,"wires":[["225467fa.c7f1f"]]},{"id":"ef28ebcf.e11cc8","type":"function","z":"2294209a.0c95b","name":"Gadget payload","func":"msg.payload = {gadgetsList : [ {\n    \"gadgetId\":\"4c0935bb-b3da-51bd-8a74-c952f4272193\",\n      \"gadgetName\":\"Scope tabs\",\n      \"gadgetType\":\"revotio-tabs-select\",\n      \"gadgetData\":{\n         \"dropdown\":{\n            // \"value\": msg.RevotioData.FlowData.gadgetOptions.ReportingPeriod,\n            // \"options\":DropDown\n         },\n         \"tabs\":[ {\n               \"dropdownKey\":msg.RevotioData.session.Page,\n               \"fields\":\"\"\n         }],\n          \n      }}]};\n      \nmsg.tabsSettings = {\n    entity : \"organization\" ,\n    entityId : msg.RevotioData.FlowData.organization_id,\n}\n\n\nreturn msg;","outputs":1,"noerr":0,"x":1500,"y":760,"wires":[[]]},{"id":"56a2b4a6.6d588c","type":"link out","z":"2294209a.0c95b","name":"","links":["5185c631.530a58","cb87250c.966108","112320ff.7cff6f","d230180f.f3d19","e7f2e3d2.30705","ebf87699.c97f08","98813d9e.bcf0d","90045e69.ebd138","dd373359.040c4","ecd0ecf2.99d41","93aa962f.3144d","e5823b9b.d200f","dda61270.476b9","f0eeb60f.091b78","359e3b04.860634","dc6abb7.ed83248","ff0e6248.29e22","1cff0ac1.dc8705","147f3fb7.690568","f42bf06.8974d1","ef55a0fd.6d311","552f5d9b.570784","498662dd.42a45c","81c0cf07.5ef198","44daecc2.e5b2f4","cb902343.5f03a","e34f6cc2.af5ad8","480dae32.8a339"],"x":1775,"y":760,"wires":[]},{"id":"c114b448.029c4","type":"link in","z":"2294209a.0c95b","name":"users global = ACC Gagdet","links":["aea25a8a.fa4a58"],"x":1375,"y":760,"wires":[["ef28ebcf.e11cc8"]]},{"id":"54978e5a.104c68","type":"debug","z":"2294209a.0c95b","name":"Post Items gadgets","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":2100,"y":720,"wires":[]},{"id":"ca597086.b35f6","type":"function","z":"d8703926.e2eca","name":"INIT org overview flow","func":"// Get libraries\nconst Moment = global.get('moment');\nconst MomentRange = global.get('momentrange');\nconst moment = MomentRange.extendMoment(Moment)\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting'); \nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\n\n\n// aggregate\n            aggregateObj = {\n                    query : { query : [{\n                                $match: {\n                                  \"_id\": new ObjectID(\"5d9b21fe2f5aa895d791985f\"),\n                                 \n                                }\n                              },\n                                { \n                                    \"$lookup\" : {\n                                        \"from\" : \"organizations\", \n                                        \"localField\" : \"_id\", \n                                        \"foreignField\" : \"parent_id\", \n                                        \"as\" : \"childOrganizations\"\n                                    }\n                                }, \n                                { \n                                    \"$lookup\" : {\n                                        \"from\" : \"organizations\", \n                                        \"localField\" : \"parent_id\", \n                                        \"foreignField\" : \"_id\", \n                                        \"as\" : \"masterOrganizations\"\n                                    }\n                                }\n                            ],},\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'organizations',\n                    operation:'aggregate',\n                    }\n                    \n            mongodbTools.resolveAsync(aggregateObj, node, function(res){\n                    msg.result = res\n                    \n                    \n                    node.send(msg)\n                  })  \n","outputs":1,"noerr":0,"x":640,"y":80,"wires":[["148b695d.d56a1f"]]},{"id":"5ebca25f.80df2c","type":"inject","z":"d8703926.e2eca","name":"","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":380,"y":80,"wires":[["ca597086.b35f6"]]},{"id":"148b695d.d56a1f","type":"debug","z":"d8703926.e2eca","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":890,"y":100,"wires":[]},{"id":"85d38adc.97a99","type":"function","z":"2294209a.0c95b","name":"Breadcrumb organizations","func":"\n    \n    \nmsg.payload = {\n    gadgetsList: [{\n                gadgetId: 'd9a375f6-bdc7-f288-e831-6db2f4a76270',\n                gadgetName: 'Generic breadcrumb',\n                gadgetType: 'revotio-breadcrumbs',\n                gadgetData: {\n                  data: msg.data,\n                  options: {\n                    separatorIcon: 'fas fa-angle-right', // if null it will display \">\" by default\n                    // separatorIconColor: 'pink'\n                  }\n                }\n              }]}\n\nreturn msg;","outputs":1,"noerr":0,"x":1720,"y":820,"wires":[["e5361ca5.ccabf"]]},{"id":"449e3134.053a68","type":"link in","z":"2294209a.0c95b","name":"users global = ACC Gagdet","links":["aea25a8a.fa4a58"],"x":1355,"y":800,"wires":[[]]},{"id":"e5361ca5.ccabf","type":"link out","z":"2294209a.0c95b","name":"","links":["5185c631.530a58","cb87250c.966108","112320ff.7cff6f","d230180f.f3d19","e7f2e3d2.30705","ebf87699.c97f08","98813d9e.bcf0d","90045e69.ebd138","dd373359.040c4","ecd0ecf2.99d41","93aa962f.3144d","e5823b9b.d200f","dda61270.476b9","f0eeb60f.091b78","359e3b04.860634","dc6abb7.ed83248","ff0e6248.29e22","1cff0ac1.dc8705","147f3fb7.690568","f42bf06.8974d1","ef55a0fd.6d311","552f5d9b.570784","498662dd.42a45c","81c0cf07.5ef198","44daecc2.e5b2f4","cb902343.5f03a","e34f6cc2.af5ad8","480dae32.8a339"],"x":1975,"y":800,"wires":[]},{"id":"78e9ce03.4f11c","type":"function","z":"aec22158.fe4e38","name":"prepair redirect to NonAuthDefaultPage","func":"\nmsg.payload  = {\n    Page :global.get(\"DomainProperties.NonAuthDefaultPage\"),\n}\nreturn msg;","outputs":1,"noerr":0,"x":3200,"y":2140,"wires":[["df66ca95.228cd8"]]},{"id":"df66ca95.228cd8","type":"subflow:5e9b9c1d.bbe4a4","z":"aec22158.fe4e38","name":"","env":[],"x":3400,"y":2140,"wires":[]},{"id":"85b62822.f16cf8","type":"template","z":"aec22158.fe4e38","name":"","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"<!doctype html>\n<html>\n<head>\n<meta name=\"viewport\" content=\"width=device-width\">\n<meta http-equiv=\"Content-Type\" content=\"text/html; charset=UTF-8\">\n<title>{{payload.title}}</title>\n<style>\n@media  only screen and (max-width: 620px) {\ntable[class=body] h1 {\nfont-size: 28px !important;\nmargin-bottom: 10px !important;\n}\ntable[class=body] p,\ntable[class=body] ul,\ntable[class=body] ol,\ntable[class=body] td,\ntable[class=body] span,\ntable[class=body] a {\nfont-size: 16px !important;\n}\ntable[class=body] .wrapper,\ntable[class=body] .article {\npadding: 10px !important;\n}\ntable[class=body] .content {\npadding: 0 !important;\n}\ntable[class=body] .container {\npadding: 0 !important;\nwidth: 100% !important;\n}\ntable[class=body] .main {\nborder-left-width: 0 !important;\nborder-radius: 0 !important;\nborder-right-width: 0 !important;\n}\ntable[class=body] .btn table {\nwidth: 100% !important;\n}\ntable[class=body] .btn a {\nwidth: 100% !important;\n}\ntable[class=body] .img-responsive {\nheight: auto !important;\nmax-width: 100% !important;\nwidth: auto !important;\n}\n}\n@media  all {\n.ExternalClass {\nwidth: 100%;\n}\n.ExternalClass,\n.ExternalClass p,\n.ExternalClass span,\n.ExternalClass font,\n.ExternalClass td,\n.ExternalClass div {\nline-height: 100%;\n}\n.btn-primary table td:hover {\nbackground-color: #34495e !important;\n}\n.btn-primary a:hover {\nbackground-color: #34495e !important;\nborder-color: #34495e !important;\n}\n.button {\n  text-decoration: none;\n  background-color: #20a7db;\n  color: #333333;\n  padding: 2px 6px 2px 6px;\n  border: none;\n  border-radius: 2px;\n}\n}\n</style>\n</head>\n<body class=\"\" style=\"background-color: #f6f6f6; font-family: sans-serif; -webkit-font-smoothing: antialiased; font-size: 14px; line-height: 1.4; margin: 0; padding: 0; -ms-text-size-adjust: 100%; -webkit-text-size-adjust: 100%;\">\n<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" class=\"body\" style=\"border-collapse: separate; mso-table-lspace: 0pt; mso-table-rspace: 0pt; width: 100%; background-color: #f6f6f6;\">\n<tr>\n<td style=\"font-family: sans-serif; font-size: 14px; vertical-align: top;\">&nbsp;</td>\n<td class=\"container\" style=\"font-family: sans-serif; font-size: 14px; vertical-align: top; display: block; Margin: 0 auto; max-width: 580px; padding: 10px; width: 580px;\">\n<div class=\"content\" style=\"box-sizing: border-box; display: block; Margin: 0 auto; max-width: 580px; padding: 10px;\">\n\n<!-- START CENTERED WHITE CONTAINER -->\n<span class=\"preheader\" style=\"color: transparent; display: none; height: 0; max-height: 0; max-width: 0; opacity: 0; overflow: hidden; mso-hide: all; visibility: hidden; width: 0;\">{{payload.title}}</span>\n<table class=\"main\" style=\"border-collapse: separate; mso-table-lspace: 0pt; mso-table-rspace: 0pt; width: 100%; background: #ffffff; border-radius: 3px;\">\n\n<!-- START MAIN CONTENT AREA -->\n<tr>\n<td class=\"wrapper\" style=\"font-family: sans-serif; font-size: 14px; vertical-align: top; box-sizing: border-box; padding: 40px;\">\n<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" style=\"border-collapse: separate; mso-table-lspace: 0pt; mso-table-rspace: 0pt; width: 100%;\">\n<tr>\n<td style=\"font-family: sans-serif; vertical-align: top; padding-bottom: 40px;\">\n<a href={{payload.activation_link}} target=\"_blank\">\n<img style=\"display: block; margin: auto; width: 150px;\" width=\"150\" src=\"data:image/png;base64,{{payload.base64data}}\" alt=\"{{payload.title}}\">\n</a>\n</td>\n</tr>\n</table>\n<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" style=\"border-collapse: separate; mso-table-lspace: 0pt; mso-table-rspace: 0pt; width: 100%;\">\n<tr>\n<td style=\"font-family: sans-serif; font-size: 14px; vertical-align: top;\">\n\n<p>Hi {{payload.firstname}} {{payload.lastname}},</p>\n<p>{{payload.message}}</p>\n<p>{{payload.activate_text}} <a class=\"button\" href=\"{{payload.activation_link}}\">{{payload.activate_click}}</a></p>\n<p style=\"font-family: sans-serif; font-size: 14px; font-weight: normal; margin: 0; Margin-bottom: 15px;\">\n{{payload.closing}}\n</p>\n<p style=\"font-family: sans-serif; font-size: 14px; font-weight: normal; margin: 0; Margin-bottom: 15px;\">\n{{payload.signature}}\n</p>\n</td>\n</tr>\n</table>\n</td>\n</tr>\n\n<!-- END MAIN CONTENT AREA -->\n</table>\n\n<!-- START FOOTER -->\n<div class=\"footer\" style=\"clear: both; Margin-top: 10px; text-align: center; width: 100%;\">\n<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" style=\"border-collapse: separate; mso-table-lspace: 0pt; mso-table-rspace: 0pt; width: 100%;\">\n<tr>\n<td class=\"content-block\" style=\"font-family: sans-serif; vertical-align: top; padding-bottom: 10px; padding-top: 10px; font-size: 12px; color: #999999; text-align: center;\">\n<span style=\"color: #999999; font-size: 12px; text-align: center;\">{{payload.footer_text}}</span>\n<br> Don't like these emails? <a href=\"{{payload.settings_link}}\" style=\"text-decoration: underline; color: #999999; font-size: 12px; text-align: center;\">{{payload.settings_text}}</a>.\n</td>\n</tr>\n\n</table>\n</div>\n<!-- END FOOTER -->\n\n<!-- END CENTERED WHITE CONTAINER -->\n</div>\n</td>\n<td style=\"font-family: sans-serif; font-size: 14px; vertical-align: top;\">&nbsp;</td>\n</tr>\n</table>\n</body>\n</html>","output":"str","x":3240,"y":2180,"wires":[["80ee1d38.5041f8"]]},{"id":"16731a52.126fe6","type":"function","z":"aec22158.fe4e38","name":"Trigger email","func":"var request = global.get('request');\nvar Moment = global.get('moment');\nvar MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\n\nmsg.payload = {\n  \"title\":\"Password reset\",\n  \"logo\":\"logo.png\",\n  \"firstname\":msg.RevotioData.FlowData.Data.UserData.first_name,\n  \"lastname\":msg.RevotioData.FlowData.Data.UserData.last_name,\n//   \"attachment\" : global.get(\"DomainProperties.filesFolder\")+\"SystemFiles/logo.png\",\n  \"message\":\"Welcome to the project management application!\",\n  \"closing\":\"Cheerfully yours,\",\n  \"signature\":\"Team Grant tools projects.\",\n  \"activate_text\":\"You can reset your password by clicking on this link:\",\n  \"activation_link\":global.get(\"DomainProperties.RootDomain\")+ \"/reset=\" + msg.RevotioData.FlowData.Data.UserData.resetToken,\n  \"activate_click\":\"Reset!\",\n  \"footer_text\":\"Grant tools B.V. | Rijswijk, Netherlands\",\n  \"settings_link\":global.get(\"DomainProperties.prodUrl\"),\n  \"settings_text\":\"Reset your password\",\n//   data:fs.readFileSync(global.get(\"DomainProperties.filesFolder\")+\"SystemFiles/logo.png\"),\n  base64data : fs.readFileSync(global.get(\"DomainProperties.filesFolder\")+\"SystemFiles/logo.png\").toString('base64'),\n}\n\nmsg.data = msg.payload\nreturn msg;\n\n","outputs":1,"noerr":0,"x":3110,"y":2180,"wires":[["85b62822.f16cf8"]]},{"id":"80ee1d38.5041f8","type":"function","z":"aec22158.fe4e38","name":"nodemailer_mailgun_transport && nodemailer","func":"// var request = global.get('request'); \nvar Moment = global.get('moment');\nvar MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar request = global.get('request');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\n// This is your API key that you retrieve from www.mailgun.com/cp (free up to 10K monthly emails)\nconst auth = {\n  auth: {\n    api_key: global.get(\"mailgun.apiKey\"),\n    domain: global.get(\"mailgun.domain\")\n  },\n//   proxy: 'http://user:pass@localhost:8080' // optional proxy, default is false\n}\n \nconst nodemailerMailgun = nodemailer.createTransport(mg(auth));\n \n\n// base64Attachment =  msg.payload.data.toString('base64');\n\nnodemailerMailgun.sendMail({\n  from: global.get(\"mailgun.from\"),\n  to: msg.RevotioData.FlowData.Data.UserData.email, // An array if you have multiple recipients.\n//   cc:'second@domain.com',\n//   bcc:'secretagent@company.gov',\n  subject: msg.data.title,\n//   'h:Reply-To': 'reply2this@company.com',\n  //You can use \"html:\" to send HTML email content. It's magic!\n  html: msg.payload,\n  //You can use \"text:\" to send plain-text content. It's oldschool!\n//   text: 'Mailgun rocks, pow pow!',\n//   attachments: [\n//         {\n//             cid: 'logo.png',\n//             content: base64Attachment,\n//             encoding: 'base64'\n//         },]\n}, (err, info) => {\n  if (err) {\n    console.log(`Error: ${err}`);\n  }\n  else {\n    console.log(`Response: ${info}`);\n  }\n});\n\nreturn msg;","outputs":1,"noerr":0,"x":3480,"y":2180,"wires":[[]]},{"id":"5234ac38.c9d60c","type":"template","z":"aec22158.fe4e38","name":"","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"<!doctype html>\n<html>\n<head>\n<meta name=\"viewport\" content=\"width=device-width\">\n<meta http-equiv=\"Content-Type\" content=\"text/html; charset=UTF-8\">\n<title>{{data.title}}</title>\n<style>\n@media  only screen and (max-width: 620px) {\ntable[class=body] h1 {\nfont-size: 28px !important;\nmargin-bottom: 10px !important;\n}\ntable[class=body] p,\ntable[class=body] ul,\ntable[class=body] ol,\ntable[class=body] td,\ntable[class=body] span,\ntable[class=body] a {\nfont-size: 16px !important;\n}\ntable[class=body] .wrapper,\ntable[class=body] .article {\npadding: 10px !important;\n}\ntable[class=body] .content {\npadding: 0 !important;\n}\ntable[class=body] .container {\npadding: 0 !important;\nwidth: 100% !important;\n}\ntable[class=body] .main {\nborder-left-width: 0 !important;\nborder-radius: 0 !important;\nborder-right-width: 0 !important;\n}\ntable[class=body] .btn table {\nwidth: 100% !important;\n}\ntable[class=body] .btn a {\nwidth: 100% !important;\n}\ntable[class=body] .img-responsive {\nheight: auto !important;\nmax-width: 100% !important;\nwidth: auto !important;\n}\n}\n@media  all {\n.ExternalClass {\nwidth: 100%;\n}\n.ExternalClass,\n.ExternalClass p,\n.ExternalClass span,\n.ExternalClass font,\n.ExternalClass td,\n.ExternalClass div {\nline-height: 100%;\n}\n.btn-primary table td:hover {\nbackground-color: #34495e !important;\n}\n.btn-primary a:hover {\nbackground-color: #34495e !important;\nborder-color: #34495e !important;\n}\n.token_container {\n  padding: 5px; \n  width: 90%; \n  margin: auto; \n  border: 1px solid #ccc; \n  margin-bottom: 20px\n}\n.token_text {\n  text-align: center\n}\n.token {\n  background-color: #5eb7da; \n  text-align: center; \n  font-size: 30px; \n  width: 50%; \n  margin: auto;\n}\n}\n</style>\n</head>\n<body class=\"\" style=\"background-color: #f6f6f6; font-family: sans-serif; -webkit-font-smoothing: antialiased; font-size: 14px; line-height: 1.4; margin: 0; padding: 0; -ms-text-size-adjust: 100%; -webkit-text-size-adjust: 100%;\">\n<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" class=\"body\" style=\"border-collapse: separate; mso-table-lspace: 0pt; mso-table-rspace: 0pt; width: 100%; background-color: #f6f6f6;\">\n<tr>\n<td style=\"font-family: sans-serif; font-size: 14px; vertical-align: top;\">&nbsp;</td>\n<td class=\"container\" style=\"font-family: sans-serif; font-size: 14px; vertical-align: top; display: block; Margin: 0 auto; max-width: 580px; padding: 10px; width: 580px;\">\n<div class=\"content\" style=\"box-sizing: border-box; display: block; Margin: 0 auto; max-width: 580px; padding: 10px;\">\n\n<!-- START CENTERED WHITE CONTAINER -->\n<span class=\"preheader\" style=\"color: transparent; display: none; height: 0; max-height: 0; max-width: 0; opacity: 0; overflow: hidden; mso-hide: all; visibility: hidden; width: 0;\">{{data.title}}</span>\n<table class=\"main\" style=\"border-collapse: separate; mso-table-lspace: 0pt; mso-table-rspace: 0pt; width: 100%; background: #ffffff; border-radius: 3px;\">\n\n<!-- START MAIN CONTENT AREA -->\n<tr>\n<td class=\"wrapper\" style=\"font-family: sans-serif; font-size: 14px; vertical-align: top; box-sizing: border-box; padding: 40px;\">\n<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" style=\"border-collapse: separate; mso-table-lspace: 0pt; mso-table-rspace: 0pt; width: 100%;\">\n<tr>\n<td style=\"font-family: sans-serif; vertical-align: top; padding-bottom: 40px;\">\n<a href=\"http://revotio.com\" target=\"_blank\">\n<img style=\"display: block; margin: auto; width: 150px;\" width=\"150\" src=\"{{data.logo}}\" alt=\"{{data.title}}\">\n</a>\n</td>\n</tr>\n</table>\n<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" style=\"border-collapse: separate; mso-table-lspace: 0pt; mso-table-rspace: 0pt; width: 100%;\">\n<tr>\n<td style=\"font-family: sans-serif; font-size: 14px; vertical-align: top;\">\n\n<p>Hi {{data.firstname}} {{data.lastname}},</p>\n<p>{{data.message}}</p>\n<p>{{data.activate_text}}</p>\n<div class=\"token_container\">\n<p class=\"token_text\">Type an MFA token below for verification.</p>\n<p class=\"token\">\n\t{{data.token}}\n</p>\n<p class=\"token_text\">Use an MFA-enabled device with Google Authenticator<br>\n(Android or iPhone) or any two-factor authentication app.</p>\n</div>\n<p style=\"font-family: sans-serif; font-size: 14px; font-weight: normal; margin: 0; Margin-bottom: 15px;\">\n{{data.closing}}\n</p>\n<p style=\"font-family: sans-serif; font-size: 14px; font-weight: normal; margin: 0; Margin-bottom: 15px;\">\n{{data.signature}}\n</p>\n</td>\n</tr>\n</table>\n</td>\n</tr>\n\n<!-- END MAIN CONTENT AREA -->\n</table>\n\n<!-- START FOOTER -->\n<div class=\"footer\" style=\"clear: both; Margin-top: 10px; text-align: center; width: 100%;\">\n<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" style=\"border-collapse: separate; mso-table-lspace: 0pt; mso-table-rspace: 0pt; width: 100%;\">\n<tr>\n<td class=\"content-block\" style=\"font-family: sans-serif; vertical-align: top; padding-bottom: 10px; padding-top: 10px; font-size: 12px; color: #999999; text-align: center;\">\n<span style=\"color: #999999; font-size: 12px; text-align: center;\">{{data.footer_text}}</span>\n<br> Don't like these emails? <a href=\"{{data.settings_link}}\" style=\"text-decoration: underline; color: #999999; font-size: 12px; text-align: center;\">{{data.settings_text}}</a>.\n</td>\n</tr>\n\n</table>\n</div>\n<!-- END FOOTER -->\n\n<!-- END CENTERED WHITE CONTAINER -->\n</div>\n</td>\n<td style=\"font-family: sans-serif; font-size: 14px; vertical-align: top;\">&nbsp;</td>\n</tr>\n</table>\n</body>\n</html>","output":"str","x":3040,"y":1520,"wires":[["7f34ab1f.8cea44"]]},{"id":"ef7031df.f8f2b","type":"function","z":"aec22158.fe4e38","name":"Trigger email","func":"var request = global.get('request');\nvar Moment = global.get('moment');\nvar MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\n\nmsg.payload = {\n  \"title\":\"Two step authentication\",\n  \"logo\":\"logo.png\",\n  email : msg.RevotioData.session.userData.email,\n  \"firstname\":msg.RevotioData.session.userData.first_name,\n  token: msg.RevotioData.FlowData.Token,\n  \"lastname\":msg.RevotioData.session.userData.last_name,\n//   \"attachment\" : global.get(\"DomainProperties.filesFolder\")+\"SystemFiles/logo.png\",\n  \"message\":\"Welcome to the project management application!\",\n  \"closing\":\"Cheerfully yours,\",\n  \"signature\":\"Team Grant tools projects.\",\n  \"activate_text\":\"Please enter the this token: \" + msg.RevotioData.FlowData.Token ,\n  \"activation_link\":\"\",\n  \"activate_click\":\"\",\n  \"footer_text\":\"Grant tools B.V. | Rijswijk, Netherlands\",\n  \"settings_link\":global.get(\"DomainProperties.prodUrl\"),\n  \"settings_text\":\"Two step authentication\",\n//   data:fs.readFileSync(global.get(\"DomainProperties.filesFolder\")+\"SystemFiles/logo.png\"),\n  base64data : fs.readFileSync(global.get(\"DomainProperties.filesFolder\")+\"SystemFiles/logo.png\").toString('base64'),\n}\n\nmsg.data = msg.payload\nreturn msg;\n\n","outputs":1,"noerr":0,"x":2910,"y":1520,"wires":[["5234ac38.c9d60c"]]},{"id":"7f34ab1f.8cea44","type":"function","z":"aec22158.fe4e38","name":"nodemailer_mailgun_transport && nodemailer","func":"// var request = global.get('request'); \nvar Moment = global.get('moment');\nvar MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar request = global.get('request');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\n// This is your API key that you retrieve from www.mailgun.com/cp (free up to 10K monthly emails)\nconst auth = {\n  auth: {\n    api_key: global.get(\"mailgun.apiKey\"),\n    domain: global.get(\"mailgun.domain\")\n  },\n//   proxy: 'http://user:pass@localhost:8080' // optional proxy, default is false\n}\n \nconst nodemailerMailgun = nodemailer.createTransport(mg(auth));\n \n\n// base64Attachment =  msg.payload.data.toString('base64');\n\nnodemailerMailgun.sendMail({\n  from: global.get(\"mailgun.from\"),\n  to: msg.data.email, // An array if you have multiple recipients.\n//   cc:'second@domain.com',\n//   bcc:'secretagent@company.gov',\n  subject: msg.data.title,\n//   'h:Reply-To': 'reply2this@company.com',\n  //You can use \"html:\" to send HTML email content. It's magic!\n  html: msg.payload,\n  //You can use \"text:\" to send plain-text content. It's oldschool!\n//   text: 'Mailgun rocks, pow pow!',\n//   attachments: [\n//         {\n//             cid: 'logo.png',\n//             content: base64Attachment,\n//             encoding: 'base64'\n//         },]\n}, (err, info) => {\n  if (err) {\n    console.log(`Error: ${err}`);\n  }\n  else {\n    console.log(`Response: ${info}`);\n  }\n});\n\nreturn msg;","outputs":1,"noerr":0,"x":3280,"y":1520,"wires":[[]]},{"id":"7d86f895.37fe","type":"template","z":"aec22158.fe4e38","name":"","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"<!doctype html>\n<html>\n<head>\n<meta name=\"viewport\" content=\"width=device-width\">\n<meta http-equiv=\"Content-Type\" content=\"text/html; charset=UTF-8\">\n<title>{{payload.title}}</title>\n<style>\n@media  only screen and (max-width: 620px) {\ntable[class=body] h1 {\nfont-size: 28px !important;\nmargin-bottom: 10px !important;\n}\ntable[class=body] p,\ntable[class=body] ul,\ntable[class=body] ol,\ntable[class=body] td,\ntable[class=body] span,\ntable[class=body] a {\nfont-size: 16px !important;\n}\ntable[class=body] .wrapper,\ntable[class=body] .article {\npadding: 10px !important;\n}\ntable[class=body] .content {\npadding: 0 !important;\n}\ntable[class=body] .container {\npadding: 0 !important;\nwidth: 100% !important;\n}\ntable[class=body] .main {\nborder-left-width: 0 !important;\nborder-radius: 0 !important;\nborder-right-width: 0 !important;\n}\ntable[class=body] .btn table {\nwidth: 100% !important;\n}\ntable[class=body] .btn a {\nwidth: 100% !important;\n}\ntable[class=body] .img-responsive {\nheight: auto !important;\nmax-width: 100% !important;\nwidth: auto !important;\n}\n}\n@media  all {\n.ExternalClass {\nwidth: 100%;\n}\n.ExternalClass,\n.ExternalClass p,\n.ExternalClass span,\n.ExternalClass font,\n.ExternalClass td,\n.ExternalClass div {\nline-height: 100%;\n}\n.btn-primary table td:hover {\nbackground-color: #34495e !important;\n}\n.btn-primary a:hover {\nbackground-color: #34495e !important;\nborder-color: #34495e !important;\n}\n.button {\n  text-decoration: none;\n  background-color: #20a7db;\n  color: #333333;\n  padding: 2px 6px 2px 6px;\n  border: none;\n  border-radius: 2px;\n}\n}\n</style>\n</head>\n<body class=\"\" style=\"background-color: #f6f6f6; font-family: sans-serif; -webkit-font-smoothing: antialiased; font-size: 14px; line-height: 1.4; margin: 0; padding: 0; -ms-text-size-adjust: 100%; -webkit-text-size-adjust: 100%;\">\n<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" class=\"body\" style=\"border-collapse: separate; mso-table-lspace: 0pt; mso-table-rspace: 0pt; width: 100%; background-color: #f6f6f6;\">\n<tr>\n<td style=\"font-family: sans-serif; font-size: 14px; vertical-align: top;\">&nbsp;</td>\n<td class=\"container\" style=\"font-family: sans-serif; font-size: 14px; vertical-align: top; display: block; Margin: 0 auto; max-width: 580px; padding: 10px; width: 580px;\">\n<div class=\"content\" style=\"box-sizing: border-box; display: block; Margin: 0 auto; max-width: 580px; padding: 10px;\">\n\n<!-- START CENTERED WHITE CONTAINER -->\n<span class=\"preheader\" style=\"color: transparent; display: none; height: 0; max-height: 0; max-width: 0; opacity: 0; overflow: hidden; mso-hide: all; visibility: hidden; width: 0;\">{{payload.title}}</span>\n<table class=\"main\" style=\"border-collapse: separate; mso-table-lspace: 0pt; mso-table-rspace: 0pt; width: 100%; background: #ffffff; border-radius: 3px;\">\n\n<!-- START MAIN CONTENT AREA -->\n<tr>\n<td class=\"wrapper\" style=\"font-family: sans-serif; font-size: 14px; vertical-align: top; box-sizing: border-box; padding: 40px;\">\n<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" style=\"border-collapse: separate; mso-table-lspace: 0pt; mso-table-rspace: 0pt; width: 100%;\">\n<tr>\n<td style=\"font-family: sans-serif; vertical-align: top; padding-bottom: 40px;\">\n<a href={{payload.activation_link}} target=\"_blank\">\n<img style=\"display: block; margin: auto; width: 150px;\" width=\"150\" src=\"data:image/png;base64,{{payload.base64data}}\" alt=\"{{payload.title}}\">\n</a>\n</td>\n</tr>\n</table>\n<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" style=\"border-collapse: separate; mso-table-lspace: 0pt; mso-table-rspace: 0pt; width: 100%;\">\n<tr>\n<td style=\"font-family: sans-serif; font-size: 14px; vertical-align: top;\">\n\n<p>Hi {{payload.firstname}} {{payload.lastname}},</p>\n<p>{{payload.message}}</p>\n<p>{{payload.activate_text}} <a class=\"button\" href=\"{{payload.activation_link}}\">{{payload.activate_click}}</a></p>\n<p style=\"font-family: sans-serif; font-size: 14px; font-weight: normal; margin: 0; Margin-bottom: 15px;\">\n{{payload.closing}}\n</p>\n<p style=\"font-family: sans-serif; font-size: 14px; font-weight: normal; margin: 0; Margin-bottom: 15px;\">\n{{payload.signature}}\n</p>\n</td>\n</tr>\n</table>\n</td>\n</tr>\n\n<!-- END MAIN CONTENT AREA -->\n</table>\n\n<!-- START FOOTER -->\n<div class=\"footer\" style=\"clear: both; Margin-top: 10px; text-align: center; width: 100%;\">\n<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" style=\"border-collapse: separate; mso-table-lspace: 0pt; mso-table-rspace: 0pt; width: 100%;\">\n<tr>\n<td class=\"content-block\" style=\"font-family: sans-serif; vertical-align: top; padding-bottom: 10px; padding-top: 10px; font-size: 12px; color: #999999; text-align: center;\">\n<span style=\"color: #999999; font-size: 12px; text-align: center;\">{{payload.footer_text}}</span>\n<br> Don't like these emails? <a href=\"{{payload.settings_link}}\" style=\"text-decoration: underline; color: #999999; font-size: 12px; text-align: center;\">{{payload.settings_text}}</a>.\n</td>\n</tr>\n\n</table>\n</div>\n<!-- END FOOTER -->\n\n<!-- END CENTERED WHITE CONTAINER -->\n</div>\n</td>\n<td style=\"font-family: sans-serif; font-size: 14px; vertical-align: top;\">&nbsp;</td>\n</tr>\n</table>\n</body>\n</html>","output":"str","x":1400,"y":1380,"wires":[["57bfa1d.e37346"]]},{"id":"4d7aeb07.6c37fc","type":"function","z":"aec22158.fe4e38","name":"Trigger email","func":"var request = global.get('request');\nvar Moment = global.get('moment');\nvar MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\n\nmsg.payload = {\n  \"title\":\"Two step authentication\",\n  \"logo\":\"logo.png\",\n  email : msg.RevotioData.session.userData.email,\n  \"firstname\":msg.RevotioData.session.userData.first_name,\n  token: msg.RevotioData.FlowData.Token,\n  \"lastname\":msg.RevotioData.session.userData.last_name,\n//   \"attachment\" : global.get(\"DomainProperties.filesFolder\")+\"SystemFiles/logo.png\",\n  \"message\":\"Welcome to the project management application!\",\n  \"closing\":\"Cheerfully yours,\",\n  \"signature\":\"Team Grant tools projects.\",\n  \"activate_text\":\"Please enter the this token: \" + msg.RevotioData.FlowData.Token ,\n  \"activation_link\":\"\",\n  \"activate_click\":\"\",\n  \"footer_text\":\"Grant tools B.V. | Rijswijk, Netherlands\",\n  \"settings_link\":global.get(\"DomainProperties.prodUrl\"),\n  \"settings_text\":\"Two step authentication\",\n//   data:fs.readFileSync(global.get(\"DomainProperties.filesFolder\")+\"SystemFiles/logo.png\"),\n  base64data : fs.readFileSync(global.get(\"DomainProperties.filesFolder\")+\"SystemFiles/logo.png\").toString('base64'),\n}\n\nmsg.data = msg.payload\nreturn msg;\n\n","outputs":1,"noerr":0,"x":1270,"y":1380,"wires":[["7d86f895.37fe"]]},{"id":"57bfa1d.e37346","type":"function","z":"aec22158.fe4e38","name":"nodemailer_mailgun_transport && nodemailer","func":"// var request = global.get('request'); \nvar Moment = global.get('moment');\nvar MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar request = global.get('request');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\n// This is your API key that you retrieve from www.mailgun.com/cp (free up to 10K monthly emails)\nconst auth = {\n  auth: {\n    api_key: global.get(\"mailgun.apiKey\"),\n    domain: global.get(\"mailgun.domain\")\n  },\n//   proxy: 'http://user:pass@localhost:8080' // optional proxy, default is false\n}\n \nconst nodemailerMailgun = nodemailer.createTransport(mg(auth));\n \n\n// base64Attachment =  msg.payload.data.toString('base64');\n\nnodemailerMailgun.sendMail({\n  from: global.get(\"mailgun.from\"),\n  to: msg.data.email, // An array if you have multiple recipients.\n//   cc:'second@domain.com',\n//   bcc:'secretagent@company.gov',\n  subject: msg.data.title,\n//   'h:Reply-To': 'reply2this@company.com',\n  //You can use \"html:\" to send HTML email content. It's magic!\n  html: msg.payload,\n  //You can use \"text:\" to send plain-text content. It's oldschool!\n//   text: 'Mailgun rocks, pow pow!',\n//   attachments: [\n//         {\n//             cid: 'logo.png',\n//             content: base64Attachment,\n//             encoding: 'base64'\n//         },]\n}, (err, info) => {\n  if (err) {\n    console.log(`Error: ${err}`);\n  }\n  else {\n    console.log(`Response: ${info}`);\n  }\n});\n\nreturn msg;","outputs":1,"noerr":0,"x":1640,"y":1380,"wires":[[]]},{"id":"3f6e998d.3c36b6","type":"comment","z":"d8703926.e2eca","name":"***************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************","info":"","x":2450,"y":360,"wires":[]},{"id":"bb744419.3b4b","type":"function","z":"508957a1.dd5398","name":"Get session data ACTION","func":"var jsonwebtoken = global.get('jsonwebtoken');\nvar secret = global.get(\"SystemVars.secret\");\nvar request = global.get('request');\nvar Moment = global.get('moment');var MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\nvar valid, invalid;\nmsg.starttime = new Date()\n\n\nvar PostData = JSON.parse(msg.dataResult.dataContent.PostData);\n\n\n\nvar SessionData = JSON.parse(msg.dataResult.dataContent.SessionData);\n\nquery = {\n    deviceId : SessionData.deviceId,\n    revotioSessionId : SessionData.revotioSessionId,\n}\nmsg.RevotioData = {\n    SessionData:SessionData,\n    // startTime : new Date(),\n    PostData:PostData,\n    session : SessionData\n};\n// find  \nfindObj = {\n                    query : {\n                            query :query, \n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'sessions',\n                    operation:'find',\n                    }\n\n            mongodbTools.resolveAsync(findObj, node, function(res){\n                \n                if (res.length > 0 ){\n                    msg.payload = res[0]\n                } else {\n                    msg.payload = {}\n                }\n                    \n                    node.send(msg) \n            })  \n\n  \n    \n    \nreturn [valid, invalid];","outputs":1,"noerr":0,"initialize":"","finalize":"","x":310,"y":780,"wires":[["c964af3e.013ae8"]]},{"id":"49d18cf3.10bffc","type":"function","z":"508957a1.dd5398","name":"get organizations","func":"var request = global.get('request');\nvar Moment = global.get('moment');var MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\n    // query = {\"$or\": [{parent_id : new ObjectID(msg.payload.organization_id)}, {_id : new ObjectID(msg.payload.organization_id)} ] }\n    // msg.operation = 'find.toArray'\n                    \n                // find  \n                findObj = {\n                    query : {\n                            query :msg.payload, \n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'organizations',\n                    operation:'find',\n                    }\n\n            mongodbTools.resolveAsync(findObj, node, function(res){\n                    msg.payload = res\n                    node.send(msg) \n            })   \n\n   ","outputs":1,"noerr":0,"x":990,"y":2060,"wires":[["a6bb1f75.b71ea"]],"outputLabels":["valid, "]},{"id":"b842fe40.90a778","type":"function","z":"508957a1.dd5398","name":"Remove all users && users data","func":"var request = global.get('request');\nvar Moment = global.get('moment');var MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\n// find  \nfindObj = {\n                    query : {\n                            query :{organization_id: new ObjectID(msg.organization_id)}, \n                            projection:{_id :1}\n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'user_accounts',\n                    operation:'find',\n                    }\n\n            mongodbTools.resolveAsync(findObj, node, function(res){\n                \n                _.each(res, function(user, index){\n                    \n                    // removeusers \n                        removeusers = {\n                                query : {\n                                        query :{_id:user._id}, \n                                        },\n                                connection:global.get(\"DB_data.connection\"),\n                                database:global.get(\"DB_data.appDB\"),\n                                collection:'users',\n                                operation:'remove',\n                                }\n            \n                        mongodbTools.resolveAsync(removeusers, node, function(res){\n                                \n                        }) \n                        \n                        // removeuser_accounts \n                        removeuser_accounts = {\n                                query : {\n                                        query :{user:user._id}, \n                                        },\n                                connection:global.get(\"DB_data.connection\"),\n                                database:global.get(\"DB_data.appDB\"),\n                                collection:'user_accounts',\n                                operation:'remove',\n                                }\n            \n                        mongodbTools.resolveAsync(removeuser_accounts, node, function(res){\n                                \n                        }) \n                        \n                         // removeuser_permissions\n                        removeuser_permissions = {\n                                query : {\n                                        query :{user:user._id}, \n                                        },\n                                connection:global.get(\"DB_data.connection\"),\n                                database:global.get(\"DB_data.appDB\"),\n                                collection:'user_permissions',\n                                operation:'remove',\n                                }\n            \n                        mongodbTools.resolveAsync(removeuser_permissions, node, function(res){\n                                \n                        }) \n                        \n                       \n                      \n                })\n                \n                    // msg.payload = res\n                    node.send(msg) \n            }) \n            \n// return msg;\n","outputs":1,"noerr":0,"x":1530,"y":2020,"wires":[[]]},{"id":"6fd6f4e9.852dfc","type":"function","z":"508957a1.dd5398","name":"Remove all application records && files","func":"var request = global.get('request');\nvar Moment = global.get('moment');var MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\n // removequery\n            pages = {\n                    query : {\n                            query :{application_id : new ObjectID(msg.payload.application_id)}, \n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'pages',\n                    operation:'remove',\n                    }\n\n            mongodbTools.resolveAsync(pages, node, function(res){\n                   \n            })  \n            \n \n          \n // removequery\n            application = {\n                    query : {\n                            query :{_id : new ObjectID(msg.payload.application_id)}, \n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'applications',\n                    operation:'remove',\n                    }\n\n            mongodbTools.resolveAsync(application, node, function(res){\n                   \n            })  \n            \n            \n            \n    // remove all app files\n    fs.removeSync(global.get(\"DomainProperties.filesFolder\")+ \"applications/\" + msg.payload.application_id)\n\n\nreturn msg;\n","outputs":1,"noerr":0,"x":1050,"y":2180,"wires":[["30870895.0a2d28"]]},{"id":"30870895.0a2d28","type":"http response","z":"508957a1.dd5398","name":"","statusCode":"","headers":{},"x":1230,"y":2180,"wires":[]},{"id":"7ceb5cfd.26cd9c","type":"function","z":"508957a1.dd5398","name":"Remove all page records && files","func":"var request = global.get('request');\nvar Moment = global.get('moment');var MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n \n // get page obj\n  findOneObj = {\n                    query : {\n                            query :{_id : new ObjectID(msg.page_id) }\n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'pages',\n                    operation:'find',\n                    }\n\n            mongodbTools.resolveAsync(findOneObj, node, function(res){\n                if (res.length > 0){\n                    msg.page = res[0]\n                } else {\n                    msg.page = {}\n                }\n                    \n                // remove all app files\n                fs.removeSync(global.get(\"DomainProperties.filesFolder\")+ \"applications/\" + msg.page.application_id+\"/pages/\"+msg.page_id)\n\n                 // removequery\n                            pages = {\n                                    query : {\n                                            query :{_id : new ObjectID(msg.page_id)},\n                                            },\n                                    connection:global.get(\"DB_data.connection\"),\n                                    database:global.get(\"DB_data.appDB\"),\n                                    collection:'pages',\n                                    operation:'remove',\n                                    }\n                \n                            mongodbTools.resolveAsync(pages, node, function(res){\n                                   node.send(msg)\n                            })  \n            })  \n            ","outputs":1,"noerr":0,"x":640,"y":2280,"wires":[["521fb03f.d3a258"]]},{"id":"a1a4c9c0.c43b6","type":"link in","z":"508957a1.dd5398","name":"","links":["f6894ee3.d056c","1a55a0c3.a8f35f","d2a7b91c.174a08","97b5b868.e751e","77a61ff7.3ac9d","100e6adf.f1c21d","884fb8a9.ab74f","171e9659.88660a","ffa0792b.b11698"],"x":75,"y":100,"wires":[["811b099c.ef816"]]},{"id":"811b099c.ef816","type":"subflow:4cbbc60.828563c","z":"508957a1.dd5398","name":"","env":[],"x":240,"y":100,"wires":[]},{"id":"a433961e.6ba03","type":"comment","z":"508957a1.dd5398","name":"Entrance post","info":"Expected object :\n\n msg.payload = {\n        DeviceId: ** From publised app **,\n        RevotioSessionId : ** From publised app **,\n   }","x":130,"y":300,"wires":[]},{"id":"a69f99b5.f05038","type":"http in","z":"508957a1.dd5398","name":"","url":"/Exit","method":"post","upload":false,"swaggerDoc":"","x":80,"y":1300,"wires":[["ffa0792b.b11698","b5530b8c.66e958","728e249.bd3ca5c"]]},{"id":"733e9957.70c7b","type":"comment","z":"508957a1.dd5398","name":"Exit ","info":"","x":90,"y":1260,"wires":[]},{"id":"afec1277.c01c3","type":"http in","z":"508957a1.dd5398","name":"","url":"/token","method":"post","upload":false,"swaggerDoc":"","x":110,"y":1140,"wires":[["996a3cfa.05bf8"]]},{"id":"5a06a076.96d368","type":"comment","z":"508957a1.dd5398","name":"Token","info":"msg.payload = {\n    type: \n    content: { // start with DeviceId && RevotioSessionId\n        DeviceId: \"123456789\",\n        RevotioSessionId : \"123456789\"\n    }\n}","x":90,"y":1040,"wires":[]},{"id":"f6135ee3.d67718","type":"http response","z":"508957a1.dd5398","name":"","statusCode":"","headers":{},"x":450,"y":1420,"wires":[]},{"id":"52b73dc3.bb92a4","type":"http in","z":"508957a1.dd5398","name":"","url":"/upload","method":"post","upload":true,"swaggerDoc":"","x":90,"y":1400,"wires":[["ea54b5fe.1e48c"]]},{"id":"ea54b5fe.1e48c","type":"function","z":"508957a1.dd5398","name":"","func":"var Remove, Upload; \n\nif (msg.req.uploadData.fields.type === \"create\"){\n    Upload = msg;\n} else {\n    Remove = msg;\n}\nreturn [Remove, Upload];","outputs":2,"noerr":0,"x":230,"y":1400,"wires":[[],["77473f2e.d022e","ee2f7762.ef776"]],"outputLabels":["Remove, ","Upload"]},{"id":"77473f2e.d022e","type":"function","z":"508957a1.dd5398","name":"","func":"var fs = global.get('fsextra');\nconst Moment = global.get('moment');\nconst MomentRange = global.get('momentrange');\nconst moment = MomentRange.extendMoment(Moment)\n\n// fs.ensureDirSync(global.get(\"DomainProperties.filesFolder\")+ msg.req.uploadData.fields.appFolder)\n// fs.moveSync(msg.req.uploadData.fileData.path, global.get(\"DomainProperties.filesFolder\")+ msg.req.uploadData.fields.appFolder + msg.req.uploadData.fields.name , { overwrite: true })\n\n\nfs.ensureDirSync(msg.req.uploadData.fields.appFolder)\nfs.moveSync(msg.req.uploadData.fileData.path, msg.req.uploadData.fields.appFolder + msg.req.uploadData.fields.name , { overwrite: true })\n\n\n\n\n\n// msg.move = msg.req.uploadData.fields.appFolder + msg.req.uploadData.fields.name\n\n// date = moment().format(\"MM DD MM YYYY\")\n// msg.date = date\n\n// msg.source =  msg.req.uploadData.fields.appFolder + msg.req.uploadData.fields.name\n// msg.destination = global.get(\"DomainProperties.publicFolder\")+\"files/upload/\"+ date +\"/\"+ msg.req.uploadData.fields.name\n\n// fs.copySync(global.get(\"DomainProperties.filesFolder\")+ msg.req.uploadData.fields.appFolder + msg.req.uploadData.fields.name , global.get(\"DomainProperties.publicFolder\")+\"/files/upload/\"+ date +\"/\"+ msg.req.uploadData.fields.name )\n\n// msg.payload = global.get(\"DomainProperties.RootDomain\")+\"files/upload/\"+ date +\"/\"+ msg.req.uploadData.fields.name\nmsg.payload = {\n    // url     : global.get(\"DomainProperties.RootDomain\")+\"files/upload/\"+ date +\"/\"+ msg.req.uploadData.fields.name,\n    path    : msg.req.uploadData.fields.appFolder + msg.req.uploadData.fields.name,\n    size    : msg.req.uploadData.fileData.size,\n    name    : msg.req.uploadData.fileData.name,\n    uploadFileType : msg.req.uploadData.fileData.type,\n    type    : msg.req.uploadData.fileData.type\n}\n\n\n\nreturn msg;","outputs":1,"noerr":0,"x":350,"y":1420,"wires":[["f6135ee3.d67718"]]},{"id":"822b78e3.84827","type":"comment","z":"508957a1.dd5398","name":"Upload","info":"msg.payload = {\n    type: \n    content: { // start with DeviceId && RevotioSessionId\n        DeviceId: \"123456789\",\n        RevotioSessionId : \"123456789\"\n    }\n}","x":90,"y":1360,"wires":[]},{"id":"74516ee2.700d","type":"http in","z":"508957a1.dd5398","name":"fileToken","url":"/fileToken","method":"post","upload":false,"swaggerDoc":"","x":100,"y":1500,"wires":[["846d586a.608af8"]]},{"id":"846d586a.608af8","type":"function","z":"508957a1.dd5398","name":"","func":"\nreturn msg;","outputs":1,"noerr":0,"x":210,"y":1500,"wires":[["80e68dd7.0ac748"]]},{"id":"80e68dd7.0ac748","type":"http response","z":"508957a1.dd5398","name":"","statusCode":"","headers":{},"x":310,"y":1500,"wires":[]},{"id":"c679425d.2bf16","type":"comment","z":"508957a1.dd5398","name":"","info":"payload :{\n    fileToken   : STRING\n    RevotioToken: STRING,\n    fileName    : STRING,\n    filePath    : STRING,\n    \n}","x":100,"y":1460,"wires":[]},{"id":"4cb3a645.51e71","type":"http in","z":"508957a1.dd5398","name":"download","url":"/download","method":"get","upload":false,"swaggerDoc":"","x":100,"y":1600,"wires":[["b5c2646a.c43b78"]]},{"id":"b5c2646a.c43b78","type":"function","z":"508957a1.dd5398","name":"Get file","func":"// Get libraries\nconst Moment = global.get('moment');\nconst MomentRange = global.get('momentrange');\nconst moment = MomentRange.extendMoment(Moment)\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting'); \nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar fs = global.get('fsextra');\nvar mime = global.get('mime');\n\n\n// msg.payload.token = \"valid token\"\n\n msg.payload.tokenValid = false\n\nTokenContent = {};\n// verify a token symmetric\n    jsonwebtoken.verify(msg.payload[\"revotio-token\"], global.get(\"SystemVars.secret\"), function(err, decoded) {\n      if (decoded !== undefined){\n           msg.payload.tokenValid = true\n          TokenContent = decoded\n      }\n    });\n    \nif ( msg.payload.tokenValid === true ){\n\n        // check if file exists\n        var state = false\n        if (msg.payload.hasOwnProperty(\"file\") &&  fs.existsSync(msg.payload.file)) { \n            state = true\n        } \n        \n        if (state === true){\n            // msg.payload.fileExtension = msg.payload.file.split(\".\")[msg.payload.file.split(\".\").length - 1]\n            msg.payload.fileType = mime.getType(msg.payload.file); \n             msg.payload.fileExtension = mime.getExtension(msg.payload.fileType); \n            msg.payload.folder = \"\"\n            \n            _.each(msg.payload.file.split(\"/\"), function(string, index){\n                if (index === 0){\n                     msg.payload.folder = string\n                } else {\n                    if (msg.payload.file.split(\"/\").length > index + 1){\n                        msg.payload.folder = msg.payload.folder +\"/\"+ string\n                    }\n                }\n            })\n        \n                    if (msg.payload.type === \"thumbnail\"){\n                         data = fs.readFileSync(msg.payload.file);\n                            msg.payload.base64 =  data.toString('base64');\n                                  \n                                \n                                  fs.stat(msg.payload.file, function(err, stats) {\n                                     \n                                      msg.payload.stats = stats;\n                                        \n                                            node.send(msg);\n                                  })\n                       \n                    } else {\n                            data = fs.readFileSync(msg.payload.file);\n                            msg.payload.base64 =  data.toString('base64');\n                                  \n                                \n                                  fs.stat(msg.payload.file, function(err, stats) {\n                                     \n                                      msg.payload.stats = stats;\n                                       \n                                            node.send(msg);\n                                  })\n                    }\n        \n        } else {\n            msg.payload.error = \"file does not exists\"\n            node.send(msg)\n        }\n} \nelse {\n       msg.payload.error = \"Invalid token\"\n      node.send(msg) \n}\n\n\n\n// return msg;","outputs":1,"noerr":0,"x":210,"y":1600,"wires":[["4ae456b9.0c53b8"]]},{"id":"4ae456b9.0c53b8","type":"http response","z":"508957a1.dd5398","name":"","statusCode":"","headers":{},"x":320,"y":1600,"wires":[]},{"id":"bdb3ec6a.81d3c","type":"comment","z":"508957a1.dd5398","name":"","info":"payload :{\n    fileToken   : STRING\n    RevotioToken: STRING,\n    fileName    : STRING,\n    filePath    : STRING,\n    \n}","x":100,"y":1560,"wires":[]},{"id":"920da7ee.18772","type":"function","z":"508957a1.dd5398","name":"Remove Session","func":"var request = global.get('request');\nvar Moment = global.get('moment');var MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\nvar Data = msg.payload;\n\nmsg.headers = {\n    'Access-Control-Allow-Origin': '*',\n    'Access-Control-Allow-Methods': 'PUT,GET,POST,DELETE,OPTIONS',\n    'Access-Control-Allow-Headers': 'Content-Type',\n    'content-type': 'application/json',\n};\n\nif (Data.revotioSessionId){\n    query= {\n        deviceId : Data.deviceId,\n        revotioSessionId : Data.revotioSessionId,\n    }\n    \n   \n} else {\n    query = {\n        deviceId : Data.deviceId,\n    }\n} \n\n// remove \n            removeObj = {\n                    query : {\n                            query :query,\n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'session',\n                    operation:'remove',\n                    }\n\n            mongodbTools.resolveAsync(removeObj, node, function(res){\n                    // msg.result = res\n                    node.send(msg) \n            })   \n\n\n\n// return msg;","outputs":1,"noerr":0,"x":370,"y":1320,"wires":[["98d04544.eac7e"]]},{"id":"98d04544.eac7e","type":"http response","z":"508957a1.dd5398","name":"","statusCode":"","headers":{},"x":510,"y":1300,"wires":[]},{"id":"ffa0792b.b11698","type":"link out","z":"508957a1.dd5398","name":"","links":["dc664b4f.0d82e","a1a4c9c0.c43b6"],"x":175,"y":1340,"wires":[]},{"id":"c1f038ae.f7faa","type":"comment","z":"508957a1.dd5398","name":"CHECK GC state","info":"","x":260,"y":1340,"wires":[]},{"id":"7300eaa0.fbf76c","type":"debug","z":"508957a1.dd5398","name":"Pre Request","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":2060,"y":860,"wires":[]},{"id":"12a86303.f876ed","type":"debug","z":"508957a1.dd5398","name":"INIT post","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":920,"y":520,"wires":[]},{"id":"7951c57e.e01884","type":"function","z":"aec22158.fe4e38","name":"update appusers","func":"var request = global.get('request');\nvar Moment = global.get('moment');var MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\npayload = [{_id : new ObjectID(msg.RevotioData.session.UserData._id)},\n                {\"$set\": {\n                            previousLogin : msg.RevotioData.session.UserData.previousLogin,\n                            login           : msg.RevotioData.session.UserData.login\n                }},\n                {upsert : true}]\n// update    \n    updateObj = {\n                    query : {\n                            query :payload[0], \n                            update : payload[1],\n                            options : payload[2]\n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'users',\n                    operation:'update', // updateMany , updateOne\n                    }\n\n            mongodbTools.resolveAsync(updateObj, node, function(res){\n                    \n            })  \n            \n","outputs":1,"noerr":0,"x":2930,"y":580,"wires":[[]]},{"id":"2c8a0c62.86d694","type":"function","z":"aec22158.fe4e38","name":"update appusers","func":"var request = global.get('request');\nvar Moment = global.get('moment');var MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\npayload = [\n    {_id: new ObjectID(msg.RevotioData.session.UserData._id)},\n    {\"$set\": {loginAttempts:0}},\n    {upsert: true}\n    ]\n    \n// update    \n    updateObj = {\n                    query : {\n                            query :payload[0], \n                            update : payload[1],\n                            options : payload[2]\n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'users',\n                    operation:'update', // updateMany , updateOne\n                    }\n\n            mongodbTools.resolveAsync(updateObj, node, function(res){\n                    \n            })  \n            \n","outputs":1,"noerr":0,"x":4510,"y":280,"wires":[[]]},{"id":"2df202d2.7f9f2e","type":"function","z":"aec22158.fe4e38","name":"update sessions","func":"var request = global.get('request');\nvar Moment = global.get('moment');var MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\n// update    \n    updateObj = {\n                    query : {\n                            query :msg.payload[0], \n                            update : msg.payload[1],\n                            options : msg.payload[2]\n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'sessions',\n                    operation:'updateMany', // updateMany , updateOne\n                    }\n\n            mongodbTools.resolveAsync(updateObj, node, function(res){\n                 msg.payload = {\n                        setToken : true,\n                    };\n                \n                // get organization_id \n                \n                OrgPermossionOBJ = lodash.find(msg.RevotioData.session.UserData.AppUserPermissionInfo, {type: 'organization'})\n                \n                    if (msg.RevotioData.session.UserData.type === \"PNOAdmin\" ){\n                        msg.payload.Page =  global.get(\"DomainProperties.PNODefaultPage\"); \n                        msg.payload.RevotioData = {organization_id : new ObjectID(OrgPermossionOBJ.type_id), Type: \"justLogedIn\"}\n                        \n                        } else {\n                        \n                        \n                        \n                        msg.payload.Page =  global.get(\"DomainProperties.ClientDefaultPage\");\n                        msg.payload.RevotioData = {organization_id : new ObjectID(OrgPermossionOBJ.type_id), Type: \"justLogedIn\"}\n                    }\n                    node.send(msg)\n            })  \n            \n","outputs":1,"noerr":0,"x":4500,"y":320,"wires":[["c0f97a1f.81ffc8"]]},{"id":"ab3ed11a.d5793","type":"function","z":"aec22158.fe4e38","name":"update sessions","func":"var request = global.get('request');\nvar Moment = global.get('moment');var MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\n// update    \n    updateObj = {\n                    query : {\n                            query :msg.payload[0], \n                            update : msg.payload[1],\n                            options : msg.payload[2]\n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'sessions',\n                    operation:'update', // updateMany , updateOne\n                    }\n\n            mongodbTools.resolveAsync(updateObj, node, function(res){\n                 msg.payload = {\n                        Page :  \"two step authentication\",\n                        setToken : true,\n                        RevotioData: {\n                        }\n                    };\n        \n                    node.send(msg)\n            })  \n            \n","outputs":1,"noerr":0,"x":4500,"y":400,"wires":[["85e06edd.f24208"]]},{"id":"2329b1df.ff9cde","type":"function","z":"aec22158.fe4e38","name":"update appusers","func":"var request = global.get('request');\nvar Moment = global.get('moment');var MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\n    \n// update    \n    updateObj = {\n                    query : {\n                            query :msg.payload[0], \n                            update : msg.payload[1],\n                            options : msg.payload[2]\n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'users',\n                    operation:'update', // updateMany , updateOne\n                    }\n\n            mongodbTools.resolveAsync(updateObj, node, function(res){\n                node.send(msg)    \n            })  \n            \n","outputs":1,"noerr":0,"x":3730,"y":920,"wires":[["2e99f46b.4490ec"]]},{"id":"62ed20f0.1e896","type":"function","z":"aec22158.fe4e38","name":"update appuseraccounts","func":"var request = global.get('request');\nvar Moment = global.get('moment');var MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\n    \n// update    \n    updateObj = {\n                    query : {\n                            query :msg.payload[0], \n                            update : msg.payload[1],\n                            options : msg.payload[2]\n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'user_accounts',\n                    operation:'update', // updateMany , updateOne\n                    }\n\n            mongodbTools.resolveAsync(updateObj, node, function(res){\n                 msg.payload = {\n                        Page :  global.get(\"DomainProperties.NonAuthDefaultPage\"),\n                        // setToken : true,\n                        RevotioData: {\n                        }\n                    };\n                node.send(msg)    \n            })  \n            \n","outputs":1,"noerr":0,"x":4190,"y":920,"wires":[["50553c0.ca774c4"]]},{"id":"f3baa581.b4119","type":"function","z":"aec22158.fe4e38","name":"Get appusers","func":"var request = global.get('request');\nvar Moment = global.get('moment');var MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\n    \n    findOneObj = {\n                    query : {\n                            query :{activationToken :msg.RevotioData.FlowData.activationToken} \n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'users',\n                    operation:'find',\n                    }\n\n            mongodbTools.resolveAsync(findOneObj, node, function(res){\n                if (res.length > 0){\n                    msg.payload = res[0]\n                } else {\n                    msg.payload = {}\n                }\n                    \n                    node.send(msg) \n            })  \n            \n    \n            \n","outputs":1,"noerr":0,"x":1160,"y":860,"wires":[["e54d16bc.54e4f"]]},{"id":"d554894d.135478","type":"function","z":"aec22158.fe4e38","name":"Get appusers","func":"var request = global.get('request');\nvar Moment = global.get('moment');var MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\n    \n// findObj   \n\nfindOneObj = {\n                    query : {\n                            query :{resetToken : msg.RevotioData.FlowData.resetToken} \n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'users',\n                    operation:'find',\n                    }\n\n            mongodbTools.resolveAsync(findOneObj, node, function(res){\n                if (res.length > 0){\n                    msg.payload = res[0]\n                } else {\n                    msg.payload = {}\n                }\n                    \n                    node.send(msg) \n            })  \n\n            \n","outputs":1,"noerr":0,"x":500,"y":2220,"wires":[["8f35e986.f06c78"]]},{"id":"fbfb1b97.df21f8","type":"function","z":"aec22158.fe4e38","name":"Get appusers","func":"var request = global.get('request');\nvar Moment = global.get('moment');var MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\nif (msg.RevotioData.FlowData.user){\n    \n// findObj    \n\n\n\nfindOneObj = {\n                    query : {\n                            query :{_id : new ObjectID(msg.RevotioData.FlowData.user)} \n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'users',\n                    operation:'find',\n                    }\n\n            mongodbTools.resolveAsync(findOneObj, node, function(res){\n                if (res.length > 0){\n                    msg.payload = res[0]\n                } else {\n                    msg.payload = {}\n                }\n                    \n                    node.send(msg) \n            })  \n        \n            \n} else {\n     node.send(msg)  \n}\n            \n","outputs":1,"noerr":0,"x":500,"y":2260,"wires":[["25e60b9d.f35b14"]]},{"id":"35b3b956.affe26","type":"function","z":"2294209a.0c95b","name":"Update/ remove appusers","func":"var request = global.get('request');\nvar Moment = global.get('moment');var MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar crypto = global.get('crypto');\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\n\nif (msg.operation === \"update\"){\n// update    \n    updateObj = {\n                    query : {\n                            query :msg.payload[0], \n                            update : msg.payload[1],\n                            options : msg.payload[2]\n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'users',\n                    operation:'update', // updateMany , updateOne\n                    }\n\n            mongodbTools.resolveAsync(updateObj, node, function(res){\n                    msg.payload = res\n                    node.send(msg) \n            })  \n}\nelse if (msg.operation === \"remove\"){\n    \n\n// remove \n            removeObj = {\n                    query : {\n                            query :msg.payload, \n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'users',\n                    operation:'remove',\n                    }\n\n            mongodbTools.resolveAsync(removeObj, node, function(res){\n                    msg.payload = res\n                    node.send(msg) \n            }) \n            \n}","outputs":1,"noerr":0,"x":4190,"y":420,"wires":[["1dea56ab.df6ad9"]]},{"id":"8b08f368.889138","type":"function","z":"2294209a.0c95b","name":"Remove appuserpermissions && appuseraccounts","func":"var request = global.get('request');\nvar Moment = global.get('moment');var MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar crypto = global.get('crypto');\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\n\n\n    \n\n// remove \n            removeObj = {\n                    query : {\n                            query :msg.payload, \n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'user_accounts',\n                    operation:'remove',\n                    }\n\n            mongodbTools.resolveAsync(removeObj, node, function(res){\n                    // msg.payload = res\n                    // node.send(msg) \n            }) \n            \n// remove \n            removeObj = {\n                    query : {\n                            query :msg.payload, \n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'user_permissions',\n                    operation:'remove',\n                    }\n\n            mongodbTools.resolveAsync(removeObj, node, function(res){\n                    // msg.payload = res\n                    // node.send(msg) \n            }) \n            \n","outputs":1,"noerr":0,"x":4470,"y":640,"wires":[[]]},{"id":"ee2f7762.ef776","type":"debug","z":"508957a1.dd5398","name":"UPLOAD post","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":460,"y":1360,"wires":[]},{"id":"164710f3.bf3fef","type":"inject","z":"508957a1.dd5398","name":"","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":120,"y":200,"wires":[["811b099c.ef816"]]},{"id":"b0299765.306ab","type":"function","z":"508957a1.dd5398","name":"Check user inv","func":"var request = global.get('request');\nvar Moment = global.get('moment');var MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\nUserOrgPermissionObjIndex = lodash.findIndex(msg.RevotioData.session.UserData.AppUserPermissionInfo,{type: \"organization\"} );\n\nif (UserOrgPermissionObjIndex === -1){\n    \n}else {\n    UserOrgPermissionObj = msg.RevotioData.session.UserData.AppUserPermissionInfo[UserOrgPermissionObjIndex]\n\n    var query = {organization_id:new ObjectID(UserOrgPermissionObj.type_id), contact_person_organization:new ObjectID(msg.RevotioData.session.UserData._id) };\n// msg.operation = 'find.toArray';\n\n// find  \nfindObj = {\n                    query : {\n                            query :query, \n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'participants',\n                    operation:'find',\n                    }\n\n            mongodbTools.resolveAsync(findObj, node, function(res){\n                    msg.payload = res\n                    node.send(msg) \n            })   \n}\n\n\n// return msg;","outputs":1,"noerr":0,"x":1620,"y":380,"wires":[["cd09b08b.c1c3d"]]},{"id":"c4762256.4d3218","type":"function","z":"508957a1.dd5398","name":"Remove user sessions","func":"var request = global.get('request');\nvar Moment = global.get('moment');var MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar crypto = global.get('crypto');\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\n// remove \n            removeObj = {\n                    query : {\n                            query :{\n                                        deviceId : msg.RevotioData.session.deviceId ,\n                                        revotioSessionId: msg.RevotioData.session.revotioSessionId\n                                    }, \n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'sessions',\n                    operation:'remove',\n                    }\n\n            mongodbTools.resolveAsync(removeObj, node, function(res){\n                    // msg.payload = res\n                    node.send(msg) \n            })   ","outputs":1,"noerr":0,"x":1640,"y":460,"wires":[["5679a59d.ef0854"]]},{"id":"5679a59d.ef0854","type":"function","z":"508957a1.dd5398","name":"remove global comntext sessions","func":"global.set(\"gadgetGroups.\"+ msg.RevotioData.session.deviceId)\n\nmsg.payload = {\n    Page : global.get(\"DomainProperties.NonAuthDefaultPage\"),\n    RevotioData:{}\n    // revotioSessionId : msg.RevotioData.session.revotioSessionId\n}\n\nmsg.headers = {\n    'Access-Control-Allow-Origin': '*',\n    'Access-Control-Allow-Methods': 'PUT,GET,POST,DELETE,OPTIONS',\n    'Access-Control-Allow-Headers': 'Content-Type',\n    'content-type': 'application/json',\n};\nreturn msg;","outputs":1,"noerr":0,"x":1900,"y":460,"wires":[["7cd14cd3.6f2414"]]},{"id":"7cd14cd3.6f2414","type":"subflow:5e9b9c1d.bbe4a4","z":"508957a1.dd5398","name":"","env":[],"x":2120,"y":460,"wires":[]},{"id":"1feffcb9.f3a723","type":"comment","z":"d8703926.e2eca","name":"Menu actions","info":"","x":350,"y":600,"wires":[]},{"id":"14418773.9dfa29","type":"link in","z":"d8703926.e2eca","name":"menu gadget action","links":["6b04d965.f4ff08","251c3325.01a81c","6791272e.924708","d2b7e8de.99a408","2e80c09b.871748","e1b79af1.56d8e8","51dda61c.ac9718","f153a1c1.46c398","2506b5b0.53f782","60a2e26e.b6eb9c","ebd730b3.40708","20eae4f4.2bbcbc","44a83e5f.f1a268","544ff177.c49c88","54194603.a74dc","32c6796f.75544e","b8c3f06c.7e8c3","d2414ca5.fa2e3","7c0cf08e.f15c18","3d333da.6b8cec2","d6832ca6.6661a","5fd7688e.0e2548","c1e0ef09.006d6","49cbfa03.323154","a4311a51.a3b6d","3c2ea246.1ea72e","c17c74ab.5523f8","7b2a1b7c.b8e0e4","a87efb23.d267c8","7bc8a353.17418c","ab190608.5a8ee8","5466cf91.54dc2","4dbe6b41.f5a484","4c3324ec.47a1c4","dee478a9.de00b8","4a21c1a8.d17068","20f2669c.4040b2","4a10319.1c6b95","8578d779.0dafc8","359e3c32.9c6c9c","e182ab9b.75ab38","e78584f8.5f054","f017f314.5a372","67655cae.661fbc","28bb1cd1.a4b2fc","7197d7b9.7e3728","65df0a7c.9772ac","da3b3f79.6265e","714fa6a7.14b968","8fdad0c3.88b488","9dfabc7b.4c502","cc978341.da37b8","c60460c0.c24d08","d33781a5.20c05","644d78e.69a8e08"],"x":335,"y":640,"wires":[["5b7fb22f.8de844"]]},{"id":"5b7fb22f.8de844","type":"function","z":"d8703926.e2eca","name":"Menu Action","func":"var _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar lodash = global.get('lodash');\n\nvar Load , Redirect, Button,lazyload, LogOut ;\nvar PostData    = msg.RevotioData.PostData;\nvar Page        = msg.RevotioData.session.Page;\n\nif (msg.RevotioData.hasOwnProperty(\"PostData\")=== false){\n    Load = msg;\n} else {\n\n    if ( PostData.gadgetData.hasOwnProperty(\"redirect\") && PostData.gadgetData.redirect === true ){\n        \n       \n        RevotioData = {}\n        _.each(PostData.gadgetData, function(value, key ){\n            if (lodash.includes(key, \"id\") || lodash.includes(key, \"Id\") || lodash.includes(key, \"ID\" )){\n                RevotioData[key] = new ObjectID(value);\n            } else if (key === 'level'){\n                 RevotioData[key] = value;\n            }\n        })\n        \n        if (PostData.gadgetData.name === 'Log out'){\n            LogOut = msg;\n        } else {\n            msg.payload = {\n                Page :  PostData.gadgetData.Page,\n                RevotioData: RevotioData\n            };\n        Redirect = msg;\n        }\n    } else if (msg.RevotioData.PostData.gadgetData.hasOwnProperty(\"lazyload\")){\n        lazyload = msg;\n    } else  {\n        Button = msg;\n    }\n}\nreturn [Load , Redirect, Button,lazyload, LogOut ];","outputs":5,"noerr":0,"initialize":"","finalize":"","x":450,"y":700,"wires":[["4d6e8aaa.054e84"],["d95079f7.8dc1d8","582d3ca5.214004"],["7b9b867f.a3c968"],["d83737b2.6834a"],["679d95fb.063114"]],"outputLabels":["Load , , ,,  ","Redirect","Button","lazyload","LogOut"]},{"id":"7b9b867f.a3c968","type":"function","z":"d8703926.e2eca","name":"Route menu button action","func":"var CreateOrg, CreateProject, CreateEmployee, CreateWorkPackage, CreateUser \nvar PostData    = msg.RevotioData.PostData;\nvar Page        = msg.RevotioData.session.Page;\n\n\n\n msg.RevotioData.FlowData.Form = {\n        \n            participant_id: PostData.gadgetData.participant_id,\n            employee_id: PostData.gadgetData.employee_id,\n            user_id: PostData.gadgetData.user_id,\n            work_package_id: PostData.gadgetData.work_package_id,\n            project_id: PostData.gadgetData.project_id,\n            Page: PostData.gadgetData.Page,\n            organization_id:PostData.gadgetData.organization_id,\n            FormActionType  : \"Create\",\n    };\n    \n    \nvar label = PostData.gadgetData.label\n\nif (label === \"Create organization\"){\n    \n    msg.RevotioData.FlowData.Form.FormType  =  \"Organization\";\n    \n} else if (label === \"Create project\"){\n    msg.RevotioData.FlowData.Form.FormType  =  \"Project\";\n    \n} else if (label === \"Create employee\"){\n    msg.RevotioData.FlowData.Form.FormType  =  \"Employee\";\n   \n} else if (label === \"Create work package\"){\n    msg.RevotioData.FlowData.Form.FormType  =  \"WorkPackage\";\n  \n} else if (label === \"Create user\"){\n    msg.RevotioData.FlowData.Form.FormType  =  \"User\";\n    \n} else if (label === \"Create participant\"){\n    msg.RevotioData.FlowData.Form.FormType  =  \"Participant\";\n    \n}\n\n\n\n\n\n\n\n\nreturn msg;","outputs":1,"noerr":0,"x":710,"y":760,"wires":[["94ef6924.94c9"]]},{"id":"f4a4b08d.99226","type":"link out","z":"d8703926.e2eca","name":"Form action gadget trigger","links":["c3e01de.eb492e","8861694b.da87f8"],"x":635,"y":540,"wires":[]},{"id":"39ddf0ca.0692a","type":"comment","z":"d8703926.e2eca","name":"*************************************************************************************************************** MENU ***************************************************************************************************************","info":"","x":660,"y":380,"wires":[]},{"id":"7d24cd64.3083e4","type":"comment","z":"d8703926.e2eca","name":"***************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************","info":"","x":2510,"y":440,"wires":[]},{"id":"d83737b2.6834a","type":"function","z":"d8703926.e2eca","name":"Route lazyload actions","func":"var global , admin_users, organization, organization_users, sub_organizations;\n\nif (msg.RevotioData.PostData.gadgetData.lazyload === \"global\"){\n    global = msg;\n} else if (msg.RevotioData.PostData.gadgetData.lazyload === \"admin_users\"){\n    admin_users = msg;\n}else if (msg.RevotioData.PostData.gadgetData.lazyload === \"organizations\"){\n   organization = msg;\n} else if ( msg.RevotioData.PostData.gadgetData.lazyload === \"organization_users\"){\n    organization_users = msg;\n} else if ( msg.RevotioData.PostData.gadgetData.lazyload === \"sub_organizations\"){\n    sub_organizations = msg;\n}\n\n\n\n\nreturn [global,admin_users, organization, organization_users, sub_organizations];","outputs":5,"noerr":0,"x":760,"y":880,"wires":[["4d6e8aaa.054e84"],["386024ac.f579bc"],["fe6bd026.750e2"],["8c0473e0.6063c8"],["1dfc0e60.c5afa2"]],"outputLabels":["global","admin_users","organization","organization_users","sub_organization"]},{"id":"e7218436.a12638","type":"comment","z":"d8703926.e2eca","name":"Global","info":"","x":1570,"y":600,"wires":[]},{"id":"29ad9a18.baaabe","type":"comment","z":"d8703926.e2eca","name":"Projects","info":"","x":3480,"y":1020,"wires":[]},{"id":"1a66dda9.fedaaa","type":"comment","z":"d8703926.e2eca","name":"Employee","info":"","x":3480,"y":1100,"wires":[]},{"id":"d667451e.4184b","type":"comment","z":"d8703926.e2eca","name":"Work Packages","info":"","x":3460,"y":1140,"wires":[]},{"id":"932a0861.e7349","type":"comment","z":"d8703926.e2eca","name":"Participants","info":"","x":3470,"y":1180,"wires":[]},{"id":"6e83b2ce.9f7a8c","type":"comment","z":"d8703926.e2eca","name":"Users","info":"","x":1410,"y":860,"wires":[]},{"id":"8dfc63b7.761c88","type":"function","z":"d8703926.e2eca","name":"Get Employee's","func":"var request = global.get('request');\nvar Moment = global.get('moment');var MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar crypto = global.get('crypto');\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\n\nfindManyObj = {\n                    query : {\n                            query :{\n                                        organization_id : new ObjectID(msg.RevotioData.PostData.gadgetData.organization_id)\n                                    }, \n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'employee',\n                    operation:'find',\n                    }\n\n            mongodbTools.resolveAsync(findManyObj, node, function(res){\n                    msg.payload = res\n                    node.send(msg) \n            }) \n\n","outputs":1,"noerr":0,"x":3620,"y":1100,"wires":[["1835b72b.da7a11"]]},{"id":"a639db7a.2e08b8","type":"function","z":"d8703926.e2eca","name":"Get WorkPackages","func":"var request = global.get('request');\nvar Moment = global.get('moment');var MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar crypto = global.get('crypto');\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\n\nfindManyObj = {\n                    query : {\n                            query : {  \"project_id\" : new ObjectID(msg.RevotioData.PostData.gadgetData.project_id)          }\n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'work_packages',\n                    operation:'find',\n                    }\n\n            mongodbTools.resolveAsync(findManyObj, node, function(res){\n                    msg.payload = res\n                    node.send(msg) \n            }) \n\n\n\n       \n      \n\n","outputs":1,"noerr":0,"x":3630,"y":1140,"wires":[["e1090468.f206a8"]]},{"id":"63e1174.27fbce8","type":"function","z":"d8703926.e2eca","name":"Participants","func":"// Get libraries\nconst Moment = global.get('moment');\nconst MomentRange = global.get('momentrange');\nconst moment = MomentRange.extendMoment(Moment)\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting'); \nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\n\n\n\n            aggregateObj = {\n                    query : { \n                        query : [\n        { \n            \"$match\" : {\n                \"project_id\" : new ObjectID(msg.RevotioData.PostData.gadgetData.project_id),\n            //   \"project_id\" : new ObjectID(\"59b90b74bf96cb29b258ea30\"),\n               type: \"project\"\n            }\n        }, \n        { \n            \"$lookup\" : {\n                \"from\" : \"organizations\", \n                \"localField\" : \"organization_id\", \n                \"foreignField\" : \"_id\", \n                \"as\" : \"organizationData\"\n            }\n        }, \n        { \n            \"$unwind\" : {\n                \"path\" : \"$organizationData\",\n                includeArrayIndex : \"arrayIndex\", // optional\n                preserveNullAndEmptyArrays : false // optional\n            }\n        },\n    ],},\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'participants',\n                    operation:'aggregate',\n                    }\n                    \n            mongodbTools.resolveAsync(aggregateObj, node, function(res){\n                    msg.payload = res\n                    node.send(msg) \n            })  \n            \n            \n// msg.payload = \n//      , \n//     { \n//         \"allowDiskUse\" : false\n//     };\n    \n\n// msg.operation = \"aggregate.toArray\" ;\n// return msg;","outputs":1,"noerr":0,"x":3610,"y":1180,"wires":[["cb44a011.cc27e"]]},{"id":"abf7a14a.1f1fc","type":"function","z":"d8703926.e2eca","name":"Get org Participant projects","func":"// Get libraries\nconst Moment = global.get('moment');\nconst MomentRange = global.get('momentrange');\nconst moment = MomentRange.extendMoment(Moment);\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting'); \nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar mongodbTools = global.get('mongodbTools');\n\n\n// aggregate\n            aggregateObj = {\n                        query : {\n                            query : [\n                                { \n                                    \"$match\" : {\n                                        \"organization_id\" : new ObjectID(msg.RevotioData.PostData.gadgetData.organization_id), \n                                        \"type\" : \"project\"\n                                    }\n                                }, \n                                { \n                                    \"$lookup\" : {\n                                        \"from\" : \"projects\", \n                                        \"localField\" : \"project_id\", \n                                        \"foreignField\" : \"_id\", \n                                        \"as\" : \"projectData\"\n                                    }\n                                }, \n                               \n                             { \n                                    \"$lookup\" : {\n                                        \"from\" : \"participants\", \n                                        \"localField\" : \"project_id\", \n                                        \"foreignField\" : \"project_id\", \n                                        \"as\" : \"projectParticipants\"\n                                    }\n                                }, \n                                { \n                                    \"$lookup\" : {\n                                        \"from\" : \"work_packages\", \n                                        \"localField\" : \"project_id\", \n                                        \"foreignField\" : \"project_id\", \n                                        \"as\" : \"work_packages\"\n                                    }\n                                }, \n                                 { \n                                    \"$unwind\" : {\n                                        \"path\" : \"$projectData\", \n                                        \"includeArrayIndex\" : \"arrayIndex\", \n                                        \"preserveNullAndEmptyArrays\" : false\n                                    }\n                                },\n                                 { \n                                    \"$lookup\" : {\n                                        \"from\" : \"settings\", \n                                        \"localField\" : \"projectData.funding_scheme\", \n                                        \"foreignField\" : \"_id\", \n                                        \"as\" : \"projectData.funding_scheme_data\"\n                                    }\n                                }, \n                                 { \n                                    \"$unwind\" : {\n                                        \"path\" : \"$projectData.funding_scheme_data\", \n                                        \"includeArrayIndex\" : \"arrayIndex\", \n                                        \"preserveNullAndEmptyArrays\" : false\n                                    }\n                                },\n                                { $project : \n                                    {'projectData.funding_scheme_data' :1, 'projectData.name' : 1 ,'organization_id' : 1 ,'project_id' : 1 , 'projectData.Department' : 1,'projectData._id' : 1,   \"projectParticipants\" : { $size: \"$projectParticipants\" } , 'work_packages':  { $size: \"$work_packages\" }  } \n                                }\n                                \n                            ]},\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'participants',\n                    operation:'aggregate',\n                    }\n            \n            mongodbTools.resolveAsync(aggregateObj, node, function(res){\n                    msg.result = lodash.orderBy(res, ['projectData.name'] [\"asc\"])\n                    // msg.resultGrouped = lodash.groupBy(res, \"projectData.name\")\n                    settingsObj = {\n                        query : {\n                            query :\n                                {type : \"Department\",   \"organization_id\" : new ObjectID(msg.RevotioData.PostData.gadgetData.organization_id), }\n                                \n                                       },\n                                            connection:global.get(\"DB_data.connection\"),\n                                            database:global.get(\"DB_data.appDB\"),\n                                            collection:'settings',\n                                            operation:'find',\n                                            }\n                        mongodbTools.resolveAsync(settingsObj, node, function(res){\n                            msg.settings = res\n                            node.send(msg) \n                            \n                        })\n            })  ","outputs":1,"noerr":0,"x":3660,"y":1020,"wires":[["cf4f1007.433d38"]]},{"id":"5e9c7d87.c185c4","type":"inject","z":"d8703926.e2eca","name":"","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":1300,"y":580,"wires":[[]]},{"id":"cf4f1007.433d38","type":"function","z":"d8703926.e2eca","name":"Create response obj - Projects","func":"// Get libraries\nconst Moment = global.get('moment');\nconst MomentRange = global.get('momentrange');\nconst moment = MomentRange.extendMoment(Moment);\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting'); \nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar mongodbTools = global.get('mongodbTools');\n\n// msg.resultGrouped.test = []\n\nvar Childs = [ {\n                    name: \"Create project\",\n                    label: \"Create project\",\n                    button: true,\n                    group : false,\n                    buttonType: \"success\",\n                    iconName: global.get(\"icons.fas.create\"),\n                    // iconUrl: 'https://revotio.nl/webpages/images/icons/Add.svg',\n                    iconState: true,\n                    organization_id : new ObjectID(msg.RevotioData.PostData.gadgetData.organization_id),\n                    inner:[]\n                },\n               ]\nmsg.test = []\n\nif (msg.result.length > 0){\n    Childs.push({\n                        name: \"Projects\",\n                        label: \"Projects\",\n                        group : true,\n                        // iconName: global.get(\"icons.fas.project\"),\n                        iconState: true,\n                        iconUrl: global.get(\"DomainProperties.prodUrl\") + \"/files/SystemFiles/icons/icon_rocket.svg\",\n                        filePath :global.get(\"icons.images.project\") ,\n                        bubble: msg.payload.length,\n                        organization_id: new ObjectID(msg.RevotioData.PostData.gadgetData.organization_id),\n                        redirect : false,\n                        inner: []\n                })\n\n\n    // groupedProjects = lodash.groupBy(lodash.orderBy(msg.payload, [\"projectData.name\"], [\"asc\"]), \"projectData.Department\");\n\n    _.each(lodash.groupBy(lodash.orderBy(msg.result, [\"projectData.name\"], [\"asc\"]), \"projectData.Department\"), function(DepartmentItem, DepartmentItemID){\n\n                    settingsObj = {} ;\n                    _.each(msg.settings, function(settingsItem,settingsItemIndex ){\n                        if (String(settingsItem._id) === String(DepartmentItemID)){\n                           settingsObj =  settingsItem\n                        }\n                    })\n                    \n            if (Object.keys(settingsObj).length > 0 ){\n                \n                 if (lodash.findIndex(Childs[1].inner, {name: settingsObj.name}) < 0){\n                    \n                    Childs[1].inner.push({              \n                                    name: settingsObj.name,\n                                    label: settingsObj.name,\n                                    group : true,\n                                    iconName: global.get(\"icons.fas.open\"),\n                                    // iconUrl: 'https://revotio.nl/webpages/Icons/Plus.svg', \n                                    iconState: true,\n                                    bubble: DepartmentItem.length,\n                                    redirect : false,\n                                    // Page: 'project overview',\n                                    // organization_id : new ObjectID(Item.organization_id),\n                                    // project_id :  new ObjectID(Item.project_id),\n                                    inner: []})\n                    \n                }\n                \n                DeptIndex  = lodash.findIndex(Childs[1].inner, {name: settingsObj.name})\n\n\n                _.each(DepartmentItem, function(projectItem, projectItemIndex){\n                                \n                                if (projectItem.projectData.funding_scheme_data.hasOwnProperty(\"complexity_level\") === false  || projectItem.projectData.funding_scheme_data.complexity_level  === \"basic\"){\n                                    \n                                    Childs[1].inner[DeptIndex].inner.push({\n                                            name: projectItem.projectData.name,\n                                            label: projectItem.projectData.name,\n                                            group : true,\n                                            // iconName: global.get(\"icons.fas.project\"),\n                                            iconUrl: global.get(\"DomainProperties.prodUrl\") + \"/files/SystemFiles/icons/icon_rocket.svg\",\n                                             filePath :global.get(\"icons.images.project\") ,\n                                            // iconUrl: 'https://revotio.nl/webpages/Icons/Airplane.svg', \n                                            iconState: true,\n                                            bubble: '',\n                                            organization_id : new ObjectID(projectItem.organization_id),\n                                            project_id :  new ObjectID(projectItem.project_id),\n                                            redirect : false,\n                                            inner: [\n                                                  {              \n                                                    name: \"Open \" + projectItem.projectData.name,\n                                                    label: \"Open \" + projectItem.projectData.name,\n                                                    group : false,\n                                                    iconName: global.get(\"icons.fas.open\"),\n                                                    // iconUrl: 'https://revotio.nl/webpages/Icons/Plus.svg', \n                                                    iconState: true,\n                                                    bubble: '',\n                                                    redirect : true,\n                                                    Page: 'project overview',\n                                                    organization_id : new ObjectID(projectItem.organization_id),\n                                                    project_id :  new ObjectID(projectItem.project_id),\n                                                    inner: []},\n                                                {               \n                                                        State: \"Inactive\",\n                                                        name: \"Participants\",\n                                                        label: \"Participants\",\n                                                        group : true,\n                                                        iconName: global.get(\"icons.fas.participants\"),\n                                                        // iconUrl: 'https://revotio.nl/webpages/Icons/Flag.svg', \n                                                        iconState: true,\n                                                        bubble: projectItem.projectParticipants,\n                                                        redirect : false,\n                                                        lazyload:  \"participants\",\n                                                        organization_id : new ObjectID(projectItem.organization_id),\n                                                        project_id :  new ObjectID(projectItem.project_id),\n                                                        scope: '',\n                                                        inner: [],\n                                                        },\n                                                {    \n                                            name: \"Reporting period management\",\n                                            label: \"Reporting period management\",\n                                            group : true,\n                                            iconName: global.get(\"icons.fas.calendar\"),\n                                            // iconUrl: 'https://revotio.nl/webpages/Icons/Checklist.svg', \n                                            iconState: true,\n                                            bubble: '',\n                                            redirect : true,\n                                            Page: 'reporting_period',\n                                            organization_id : new ObjectID(projectItem.organization_id),\n                                            project_id :  new ObjectID(projectItem.project_id),\n                                            // level : 'project',\n                                            scope: '',\n                                            inner: [],\n                                                },\n                                                {    \n                                                    State: \"Inactive\",\n                                                    name: \"Work packages\",\n                                                    label: \"Work packages\",\n                                                    group : true,\n                                                    iconName: global.get(\"icons.fas.work_package\"),\n                                                    // iconUrl: 'https://revotio.nl/webpages/Icons/Checklist.svg', \n                                                    iconState: true,\n                                                    bubble: projectItem.work_packages,\n                                                    redirect : true,\n                                                    Page: 'work_package_management',\n                                                    // lazyload: \"work packages\",\n                                                    organization_id : new ObjectID(projectItem.organization_id),\n                                                    project_id :  new ObjectID(projectItem.project_id),\n                                                    scope: '',\n                                                    inner: [],\n                                                    },\n                                                    {    \n                                                    State: \"Inactive\",\n                                                    name: \"Dashboard\",\n                                                    label: \"Dashboard\",\n                                                    group : true,\n                                                    iconName: global.get(\"icons.fas.dashboard\"),\n                                                    // iconUrl: 'https://revotio.nl/webpages/Icons/Checklist.svg', \n                                                    iconState: true,\n                                                    bubble: 2,\n                                                    redirect : true,\n                                                    Page: 'project dashboard',\n                                                    organization_id : new ObjectID(projectItem.organization_id),\n                                                    project_id :  new ObjectID(projectItem.project_id),\n                                                    scope: '',\n                                                    inner: [\n                                                        \n                                                         {\n                                                            name: \"Transactions dashboard\",\n                                                            label: \"Transactions dashboard\",\n                                                            group : false,\n                                                            iconName: global.get(\"icons.fas.dashboard\"),\n                                                            iconState: true,\n                                                            bubble: '',\n                                                            Page: \"transactions dashboard\",\n                                                            organization_id : new ObjectID(projectItem.organization_id),\n                                                            project_id :  new ObjectID(projectItem.project_id),\n                                                            redirect : true,\n                                                            inner: []\n                                                    },\n                                                        {\n                                                            name: \"Project dashboard\",\n                                                            label: \"Project dashboard\",\n                                                            group : false,\n                                                            iconName: global.get(\"icons.fas.dashboard\"),\n                                                            iconState: true,\n                                                            bubble: '',\n                                                            Page: \"project dashboard\",\n                                                            organization_id : new ObjectID(projectItem.organization_id),\n                                                            project_id :  new ObjectID(projectItem.project_id),\n                                                            redirect : true,\n                                                            inner: []\n                                                    }],\n                        },\n                        {    \n                                                    State: 'Inactive',\n                                                    name: \"file management\",\n                                                    label: \"File management\",\n                                                    group : true,\n                                                    iconName: global.get(\"icons.fas.file_management\"),\n                                                    // iconUrl: 'https://revotio.nl/webpages/Icons/Checklist.svg', \n                                                    iconState: true,\n                                                    bubble: '',\n                                                    redirect : true,\n                                                    Page: 'file management',\n                                                    organization_id : new ObjectID(projectItem.organization_id),\n                                                    project_id :  new ObjectID(projectItem.project_id),\n                                                    level : 'project',\n                                                    scope: '',\n                                                    inner: [],\n                        },\n                        {    \n                                            name: \"Calendar\",\n                                            label: \"Calendar\",\n                                            group : true,\n                                            iconName: global.get(\"icons.fas.calendar\"),\n                                            // iconUrl: 'https://revotio.nl/webpages/Icons/Checklist.svg', \n                                            iconState: true,\n                                            bubble: '',\n                                            redirect : true,\n                                            Page: 'calendar',\n                                            organization_id : new ObjectID(projectItem.organization_id),\n                                            project_id :  new ObjectID(projectItem.project_id),\n                                            level : 'project',\n                                            scope: '',\n                                            inner: [],\n                },\n                     \n                \n                        ],\n                                \n                                \n                            })\n                                }\n                                if (projectItem.projectData.funding_scheme_data.hasOwnProperty(\"complexity_level\") === true  && projectItem.projectData.funding_scheme_data.complexity_level  === \"advanced\"){\n                              \n                                        //  _.each(DepartmentItem, function(projectItem, Index){\n                                                        Childs[1].inner[DeptIndex].inner.push({\n                                                                name: projectItem.projectData.name,\n                                                                label: projectItem.projectData.name,\n                                                                group : true,\n                                                                // iconName: global.get(\"icons.fas.project\"),\n                                                                iconUrl: global.get(\"DomainProperties.prodUrl\") + \"/files/SystemFiles/icons/icon_rocket.svg\",\n                                                                 filePath :global.get(\"icons.images.project\") ,\n                                                                // iconUrl: 'https://revotio.nl/webpages/Icons/Airplane.svg', \n                                                                iconState: true,\n                                                                bubble: '',\n                                                                organization_id : new ObjectID(projectItem.organization_id),\n                                                                project_id :  new ObjectID(projectItem.project_id),\n                                                                redirect : false,\n                                                                inner: [\n                                                                      {              \n                                                                        name: \"Open \" + projectItem.projectData.name,\n                                                                        label: \"Open \" + projectItem.projectData.name,\n                                                                        group : false,\n                                                                        iconName: global.get(\"icons.fas.open\"),\n                                                                        // iconUrl: 'https://revotio.nl/webpages/Icons/Plus.svg', \n                                                                        iconState: true,\n                                                                        bubble: '',\n                                                                        redirect : true,\n                                                                        Page: 'project overview',\n                                                                        organization_id : new ObjectID(projectItem.organization_id),\n                                                                        project_id :  new ObjectID(projectItem.project_id),\n                                                                        inner: []},\n                                                                         {               \n                                                                        State: \"Inactive\",\n                                                                        name: \"Participants\",\n                                                                        label: \"Participants\",\n                                                                        group : true,\n                                                                        iconName: global.get(\"icons.fas.participants\"),\n                                                                        // iconUrl: 'https://revotio.nl/webpages/Icons/Flag.svg', \n                                                                        iconState: true,\n                                                                        bubble: projectItem.projectParticipants,\n                                                                        redirect : false,\n                                                                        lazyload: \"participants\",\n                                                                        organization_id : new ObjectID(projectItem.organization_id),\n                                                                        project_id :  new ObjectID(projectItem.project_id),\n                                                                        scope: '',\n                                                                        inner: [],\n                                                                        },\n                                                                        {    \n                                                                        State: \"Inactive\",\n                                                                        name: \"Work packages\",\n                                                                        label: \"Work packages\",\n                                                                        group : true,\n                                                                        iconName: global.get(\"icons.fas.work_package\"),\n                                                                        // iconUrl: 'https://revotio.nl/webpages/Icons/Checklist.svg', \n                                                                        iconState: true,\n                                                                        bubble: projectItem.work_packages,\n                                                                        redirect : true,\n                                                                        Page: 'work_package_management',\n                                                                        // lazyload: \"work packages\",\n                                                                        organization_id : new ObjectID(projectItem.organization_id),\n                                                                        project_id :  new ObjectID(projectItem.project_id),\n                                                                        scope: '',\n                                                                        inner: [],\n                                                                        },\n                                                                        {    \n                                                                        State: \"Inactive\",\n                                                                        name: \"Dashboard\",\n                                                                        label: \"Dashboard\",\n                                                                        group : true,\n                                                                        iconName: global.get(\"icons.fas.dashboard\"),\n                                                                        // iconUrl: 'https://revotio.nl/webpages/Icons/Checklist.svg', \n                                                                        iconState: true,\n                                                                        bubble: 1,\n                                                                        redirect : true,\n                                                                        Page: 'project dashboard',\n                                                                        organization_id : new ObjectID(projectItem.organization_id),\n                                                                        project_id :  new ObjectID(projectItem.project_id),\n                                                                        scope: '',\n                                                                        inner: [{\n                                                                                name: \"Project dashboard\",\n                                                                                label: \"Project dashboard\",\n                                                                                group : false,\n                                                                                iconName: global.get(\"icons.fas.dashboard\"),\n                                                                                iconState: true,\n                                                                                bubble: '',\n                                                                                Page: \"project dashboard\",\n                                                                                organization_id : new ObjectID(projectItem.organization_id),\n                                                                                project_id :  new ObjectID(projectItem.project_id),\n                                                                                redirect : true,\n                                                                                inner: []\n                                                                        }],\n                                                                        },\n                                                                        {    \n                                                                        State: 'Inactive',\n                                                                        name: \"file management\",\n                                                                        label: \"File management\",\n                                                                        group : true,\n                                                                        iconName: global.get(\"icons.fas.file_management\"),\n                                                                        // iconUrl: 'https://revotio.nl/webpages/Icons/Checklist.svg', \n                                                                        iconState: true,\n                                                                        bubble: '',\n                                                                        redirect : true,\n                                                                        Page: 'file management',\n                                                                        organization_id : new ObjectID(projectItem.organization_id),\n                                                                        project_id :  new ObjectID(projectItem.project_id),\n                                                                        level : 'project',\n                                                                        scope: '',\n                                                                        inner: [],\n                                                                },\n                                                                {    \n                                                                name: \"Calendar\",\n                                                                label: \"Calendar\",\n                                                                group : true,\n                                                                iconName: global.get(\"icons.fas.calendar\"),\n                                                                // iconUrl: 'https://revotio.nl/webpages/Icons/Checklist.svg', \n                                                                iconState: true,\n                                                                bubble: '',\n                                                                redirect : true,\n                                                                Page: 'calendar',\n                                                                organization_id : new ObjectID(projectItem.organization_id),\n                                                                project_id :  new ObjectID(projectItem.project_id),\n                                                                level : 'project',\n                                                                scope: '',\n                                                                inner: [],\n                                                         }],\n                                                })\n                                // })\n                                }\n                \n                })\n                } \n                \n                \n            else {\n                \n                // get child index \n                \n                 _.each(DepartmentItem, function(projectItem, Index){\n                    Childs[1].inner.push({\n                            name: projectItem.projectData.name,\n                            label: projectItem.projectData.name,\n                            group : true,\n                            // iconName: global.get(\"icons.fas.project\"),\n                            iconUrl: global.get(\"DomainProperties.prodUrl\") + \"/files/SystemFiles/icons/icon_rocket.svg\",\n                             filePath :global.get(\"icons.images.project\") ,\n                            // iconUrl: 'https://revotio.nl/webpages/Icons/Airplane.svg', \n                            iconState: true,\n                            bubble: '',\n                            organization_id : new ObjectID(projectItem.organization_id),\n                            project_id :  new ObjectID(projectItem.project_id),\n                            redirect : false,\n                            inner: [\n                                  {              \n                                    name: \"Open \" + projectItem.projectData.name,\n                                    label: \"Open \" + projectItem.projectData.name,\n                                    group : false,\n                                    iconName: global.get(\"icons.fas.open\"),\n                                    // iconUrl: 'https://revotio.nl/webpages/Icons/Plus.svg', \n                                    iconState: true,\n                                    bubble: '',\n                                    redirect : true,\n                                    Page: 'project overview',\n                                    organization_id : new ObjectID(projectItem.organization_id),\n                                    project_id :  new ObjectID(projectItem.project_id),\n                                    inner: []},\n                                     {               \n                                    State: \"Inactive\",\n                                    name: \"Participants\",\n                                    label: \"Participants\",\n                                    group : true,\n                                    iconName: global.get(\"icons.fas.participants\"),\n                                    // iconUrl: 'https://revotio.nl/webpages/Icons/Flag.svg', \n                                    iconState: true,\n                                    bubble: projectItem.projectParticipants,\n                                    redirect : false,\n                                    lazyload: \"participants\",\n                                    organization_id : new ObjectID(projectItem.organization_id),\n                                    project_id :  new ObjectID(projectItem.project_id),\n                                    scope: '',\n                                    inner: [],\n                                    },\n                                    {    \n                                    State: \"Inactive\",\n                                    name: \"Work packages\",\n                                    label: \"Work packages\",\n                                    group : true,\n                                    Page: 'work_package_management',\n                                    iconName: global.get(\"icons.fas.work_package\"),\n                                    // iconUrl: 'https://revotio.nl/webpages/Icons/Checklist.svg', \n                                    iconState: true,\n                                    bubble: projectItem.work_packages,\n                                    redirect : true,\n                                    // lazyload: \"work packages\",\n                                    organization_id : new ObjectID(projectItem.organization_id),\n                                    project_id :  new ObjectID(projectItem.project_id),\n                                    scope: '',\n                                    inner: [],\n        },\n        {    \n                                    State: \"Inactive\",\n                                    name: \"Dashboard\",\n                                    label: \"Dashboard\",\n                                    group : true,\n                                    iconName: global.get(\"icons.fas.dashboard\"),\n                                    // iconUrl: 'https://revotio.nl/webpages/Icons/Checklist.svg', \n                                    iconState: true,\n                                    bubble: 1,\n                                    redirect : true,\n                                    Page: 'project dashboard',\n                                    organization_id : new ObjectID(projectItem.organization_id),\n                                    project_id :  new ObjectID(projectItem.project_id),\n                                    scope: '',\n                                    inner: [{\n                                            name: \"Project dashboard\",\n                                            label: \"Project dashboard\",\n                                            group : false,\n                                            iconName: global.get(\"icons.fas.dashboard\"),\n                                            iconState: true,\n                                            bubble: '',\n                                            Page: \"project dashboard\",\n                                            organization_id : new ObjectID(projectItem.organization_id),\n                                            project_id :  new ObjectID(projectItem.project_id),\n                                            redirect : true,\n                                            inner: []\n                                    }],\n        },\n        {    \n                                    State: 'Inactive',\n                                    name: \"file management\",\n                                    label: \"File management\",\n                                    group : true,\n                                    iconName: global.get(\"icons.fas.file_management\"),\n                                    // iconUrl: 'https://revotio.nl/webpages/Icons/Checklist.svg', \n                                    iconState: true,\n                                    bubble: '',\n                                    redirect : true,\n                                    Page: 'file management',\n                                    organization_id : new ObjectID(projectItem.organization_id),\n                                    project_id :  new ObjectID(projectItem.project_id),\n                                    level : 'project',\n                                    scope: '',\n                                    inner: [],\n        }\n        ],\n                \n                \n            })\n                })\n                \n            }\n            \n            \n        })\n}\n\nChilds.push({\n                            name: \"Dashboards\",\n                            label: \"Dashboards\",\n                            button: true,\n                           organization_id :new ObjectID(msg.RevotioData.PostData.gadgetData.organization_id),\n                            buttonType: \"success\",\n                            group : true,\n                            bubble : 2, \n                            iconName: global.get(\"icons.fas.dashboard\"),\n                            // iconUrl: 'https://revotio.nl/api/app/images/menu/icon_rocket.svg',\n                            iconState: true,\n                            inner:[ {    \n                                    name: \"Involvement dashboard\",\n                                    label: \"Involvement dashboard\",\n                                    group : true,\n                                    iconName: global.get(\"icons.fas.dashboard\"),\n                                    // iconUrl: 'https://revotio.nl/webpages/Icons/Checklist.svg', \n                                    iconState: true,\n                                    bubble: '',\n                                    redirect : true,\n                                    Page: 'dashboard - involvement',\n                                    organization_id :new ObjectID(msg.RevotioData.PostData.gadgetData.organization_id),\n                                    scope: '',\n                                    inner: [],\n                                },{    \n                                    name: \"organization cockpit dashboard\",\n                                    label: \"Organization cockpit dashboard\",\n                                    group : true,\n                                    iconName: global.get(\"icons.fas.dashboard\"),\n                                    // iconUrl: 'https://revotio.nl/webpages/Icons/Checklist.svg', \n                                    iconState: true,\n                                    bubble: '',\n                                    redirect : true,\n                                    Page: 'organization cockpit dashboard',\n                                    organization_id : new ObjectID(msg.RevotioData.PostData.gadgetData.organization_id),\n                                    scope: '',\n                                    inner: [],\n                                },]  \n            })   \n       \nmsg.payload = {\n    gadgetsList:[{\n        gadgetName: \"menu\",\n        gadgetType: \"Menu\",\n        gadgetId: \"menu\",\n        gadgetData : \n            {\n                parent :msg.RevotioData.PostData.gadgetData,\n                 child : Childs}\n        \n    }]\n}\n        \n        \nreturn msg;","outputs":1,"noerr":0,"x":4270,"y":1060,"wires":[["b8cba8eb.07bea8"]]},{"id":"cb44a011.cc27e","type":"function","z":"d8703926.e2eca","name":"Create response obj - Participants","func":"// Get libraries\nconst Moment = global.get('moment');\nconst MomentRange = global.get('momentrange');\nconst moment = MomentRange.extendMoment(Moment);\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting'); \nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\n\n\n\nvar Childs = [ ]\n\n\n\n_.each(lodash.orderBy(msg.payload, [\"organizationData.name\"], [\"asc\"]), function(Item, index){\n    \n    organizationData = Item.organizationData\n    projectData = Item.projectData\n    \n    if (index === 0){\n        Childs.push( {\n                        name: \"Create participant\",\n                        label: \"Create participant\",\n                        // ProjectName: projectData.name,\n                        button: true,\n                        group : false,\n                        buttonType: \"success\",\n                        Entity: \"project\",\n                        Level: \"project\",\n                        iconName: global.get(\"icons.fas.create\"),\n                        // iconUrl: 'https://revotio.nl/webpages/Icons/Plus.svg', \n                        iconState: true,\n                        // Page : \"participant overview\",\n                        // organization_id : Item.organization_id,\n                        project_id : Item.project_id,\n                        organization_id : Item.organization_id,\n                        inner:[]\n                        })\n    }\n    \n    \n    organizationObj = {    \n                            // State:State,\n                            name: organizationData.name,\n                            label: organizationData.name,\n                            group : false,\n                            // iconName: global.get(\"icons.fas.participants\"),\n                            // iconUrl: 'https://revotio.nl/webpages/Icons/Compas.svg', \n                            iconState: true,\n                            bubble: '',\n                            redirect : true,\n                            Page: 'participant overview',\n                            organization_id : Item.organization_id,\n                            project_id : Item.project_id,\n                            participant_id : Item._id,\n                            scope: '',\n                            inner: [],\n                            }\n            \n             if (Item.hasOwnProperty(\"logo\")){\n                    organizationObj.iconUrl =   global.get(\"functions.fileManagement\")(  Item.logo.url, Item.logo.url ,msg.RevotioData.session._id, \"copySync\"), \n                    organizationObj.filePath = Item.logo.url;\n                } else {\n                    organizationObj.iconName =  global.get(\"icons.fas.participants\");\n                }\n            Childs.push(organizationObj)\n    \n    \n})\n\n  \n\n    \n\n\n\n\n              \n\nmsg.payload = {\n    gadgetsList:[{\n        gadgetName: \"menu\",\n        gadgetType: \"Menu\",\n        gadgetId: \"menu\",\n        gadgetData : \n            {\n                parent :msg.RevotioData.PostData.gadgetData,\n                 child : Childs}\n        \n    }]\n}\n// node.send(msg)\n\n\n// msg.payload = {\n//     gadgetsList:[{\n//         gadgetName: \"menu\",\n//         gadgetType: \"Menu\",\n//         gadgetId: \"menu\",\n//         gadgetData : {\n//             parent: msg.RevotioData.PostData.gadgetData,\n//             childs : Childs\n//         }\n//     }]\n// }\n\nreturn msg;","outputs":1,"noerr":0,"x":4280,"y":1180,"wires":[["b8cba8eb.07bea8"]]},{"id":"e1090468.f206a8","type":"function","z":"d8703926.e2eca","name":"Create response obj - Work Packages","func":"// Get libraries\nconst Moment = global.get('moment');\nconst MomentRange = global.get('momentrange');\nconst moment = MomentRange.extendMoment(Moment);\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting'); \nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\n\n\n\nvar Childs = [ ]\n\nChilds.push( {\n                        name: \"Create work package\",\n                        label: \"Create work package\",\n                        button: true,\n                        group : false,\n                        buttonType: \"success\",\n                        iconName: global.get(\"icons.fas.create\"),\n                        // iconUrl: 'https://revotio.nl/webpages/Icons/Plus.svg', \n                        iconState: true,\n                        Page : \"work package overview\",\n                        organization_id : msg.RevotioData.PostData.gadgetData.organization_id,\n                        project_id : msg.RevotioData.PostData.gadgetData.project_id,\n                        inner:[]\n                        })\n\n_.each(lodash.orderBy(msg.payload, [\"organizationData.name\"], [\"asc\"]), function(Item, index){\n    \n    organizationData = Item.organizationData\n    projectData = Item.projectData\n\n    Childs.push( { \n                           \n                            name: Item.work_package_name,\n                            label: Item.work_package_name,\n                            group : true,\n                            iconName: global.get(\"icons.fas.work_package\"),\n                            // iconUrl: 'https://revotio.nl/webpages/Icons/Checklist.svg', \n                            iconState: true,\n                            bubble: '',\n                            redirect : false,\n                            work_package_id : Item._id,\n                            organization_id : msg.RevotioData.PostData.gadgetData.organization_id,\n                            project_id : msg.RevotioData.PostData.gadgetData.project_id,\n                            scope: '',\n                            inner: [\n                                {\n                               \n                                name: \"Open \" + Item.work_package_name,\n                                label: \"Open \" + Item.work_package_name,\n                                button: true,\n                                redirect : true,\n                                group : false,\n                                buttonType: \"success\",\n                                iconName: global.get(\"icons.fas.open\"),\n                                // iconUrl: 'https://revotio.nl/webpages/images/Icons/Airplane.svg',\n                                iconState: true,\n                                Page : \"work package overview\",\n                                work_package_id : Item._id,\n                                organization_id : msg.RevotioData.PostData.gadgetData.organization_id,\n                                project_id : msg.RevotioData.PostData.gadgetData.project_id,\n                                inner:[]\n                                },\n                                {    \n                               \n                                name:  Item.work_package_name + \" Participants\",\n                                label:  Item.work_package_name+ \" Participants\",\n                                group : true,\n                                buttonType: \"success\",\n                                iconName: global.get(\"icons.fas.participants\"),\n                                // iconUrl: 'https://revotio.nl/webpages/Icons/Compas.svg', \n                                iconState: true,\n                                bubble: '',\n                                redirect : false,\n                                lazyload: \"WP participant\",\n                                work_package_id : Item._id,\n                                organization_id : msg.RevotioData.PostData.gadgetData.organization_id,\n                                project_id : msg.RevotioData.PostData.gadgetData.project_id,\n                                scope: '',\n                                inner: [],\n                                },\n                                {    \n                          \n                            name: \"Dashboard\",\n                            label: \"Dashboard\",\n                            group : true,\n                            iconName: global.get(\"icons.fas.dashboard\"),\n                            // iconUrl: 'https://revotio.nl/webpages/Icons/Checklist.svg', \n                            iconState: true,\n                            bubble: '',\n                            redirect : true,\n                            Page: 'workpackage dashboard',\n                            work_package_id : Item._id,\n                            organization_id : msg.RevotioData.PostData.gadgetData.organization_id,\n                            project_id : msg.RevotioData.PostData.gadgetData.project_id,\n                            WorkPackageName: Item.work_package_name,\n                            scope: '',\n                            inner: [],\n},\n{    \n                           \n                            name: \"file management\",\n                            label: \"File management\",\n                            group : true,\n                            iconName: global.get(\"icons.fas.file_management\"),\n                            // iconUrl: 'https://revotio.nl/webpages/Icons/Checklist.svg', \n                            iconState: true,\n                            bubble: '',\n                            redirect : true,\n                            page: 'file management',\n                            work_package_id : Item._id,\n                            organization_id : msg.RevotioData.PostData.gadgetData.organization_id,\n                            project_id : msg.RevotioData.PostData.gadgetData.project_id,\n                            WorkPackageName: Item.work_package_name,\n                            level : 'work package',\n                            scope: '',\n                            inner: [],\n}\n],\n})\n    \n    \n})\n\n  \n\n    \n\n              \n\nmsg.payload = {\n    gadgetsList:[{\n        gadgetName: \"menu\",\n        gadgetType: \"Menu\",\n        gadgetId: \"menu\",\n        gadgetData : \n            {\n                parent :msg.RevotioData.PostData.gadgetData,\n                 child : Childs}\n        \n    }]\n}\n// node.send(msg)\n\n\n// msg.payload = {\n//     gadgetsList:[{\n//         gadgetName: \"menu\",\n//         gadgetType: \"Menu\",\n//         gadgetId: \"menu\",\n//         gadgetData : {\n//             parent: msg.RevotioData.PostData.gadgetData,\n//             childs : Childs\n//         }\n//     }]\n// }\n\nreturn msg;","outputs":1,"noerr":0,"x":4290,"y":1140,"wires":[["b8cba8eb.07bea8"]]},{"id":"1835b72b.da7a11","type":"function","z":"d8703926.e2eca","name":"Create response obj - Employee","func":"// Get libraries\nconst Moment = global.get('moment');\nconst MomentRange = global.get('momentrange');\nconst moment = MomentRange.extendMoment(Moment);\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting'); \nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\n\n\n\nvar Childs = [ ]\n\n Childs.push( {\n                name: 'Employee global',\n                label: 'Employee global',\n                group : false,\n                // iconName: global.get(\"icons.fas.users\"),\n                iconUrl: global.get(\"DomainProperties.prodUrl\") + \"/files/SystemFiles/icons/icon_user.svg\",\n                filePath :global.get(\"icons.images.user\") ,\n                iconState: true,\n                \n                bubble: '',\n                Page: \"employee global\",\n                organization_id: new ObjectID(msg.RevotioData.PostData.gadgetData.organization_id),\n                redirect : true,\n                inner: []\n        },\n        {\n                    name: \"Create employee\",\n                    label: \"Create employee\",\n                    button: true,\n                    group : false,\n                    buttonType: \"success\",\n                    iconName: global.get(\"icons.fas.create\"),\n                    // iconUrl: 'https://revotio.nl/webpages/images/icons/Add.svg',\n                    iconState: true,\n                    organization_id : new ObjectID(msg.RevotioData.PostData.gadgetData.organization_id),\n                    inner:[]\n                })  \n\n_.each(lodash.orderBy(msg.payload, [\"first_name\", \"last_name\"], [\"asc\", \"asc\"]), function(Item, index){\n    \n    // employees index\n    employeesIndex = lodash.findIndex(Childs, {name: \"Employee's\"})\n    \n    if (employeesIndex === -1){\n    \n    Childs.push({\n                name: \"Employee's\",\n                label: \"Employee's\",\n                group : true,\n                iconUrl: global.get(\"DomainProperties.prodUrl\") + \"/files/SystemFiles/icons/icon_user.svg\",\n                 filePath :global.get(\"icons.images.user\") ,\n                // iconName: global.get(\"icons.fas.users\"),\n                iconState: true,\n                bubble: '',\n                organization_id: new ObjectID(msg.RevotioData.PostData.gadgetData.organization_id),\n                redirect : false,\n                inner: []\n        })\n        employeesIndex = lodash.findIndex(Childs, {name: \"Employee's\"})\n    }\n    \n    \n    \n    \n    \n    \nChilds[employeesIndex].inner.push( {\n        // State:EmployeeOverview,\n        name: Item.first_name + \" \" +  Item.last_name ,\n        label: Item.first_name + \" \" +  Item.last_name ,\n        group : true,\n        iconUrl:  global.get(\"functions.fileManagement\")(  Item.avatar, Item.avatar ,msg.RevotioData.session._id, \"copySync\"), \n         filePath :Item.avatar ,\n       iconState: true,\n        bubble: '',\n        employee_id :Item._id,\n        organization_id: new ObjectID(Item.organization_id),\n        redirect : false,\n        inner: [\n                {\n                            // State:EmployeeOverview,\n                            name: \"Overview\",\n                            label: \"Overview\",\n                            group : false,\n                            iconName: global.get(\"icons.fas.open\"),\n                            iconState: true,\n                            bubble: '',\n                            employee_id :Item._id,\n                            organization_id:new ObjectID(Item.organization_id),\n                            Page: 'employee overview',\n                            redirect : true,\n                            inner: [],\n                            },\n                             {\n                            // State:EmployeeInvolvement,\n                            name: 'Involvement',\n                            label: 'Involvement',\n                            group : false,\n                            iconName: global.get(\"icons.fas.calendar\"),\n                            iconState: true,\n                            bubble: '',\n                            employee_id :Item._id,\n                            organization_id:new ObjectID(Item.organization_id),\n                            Page: 'employee involvement',\n                            redirect : true,\n                            inner: [],\n                            },\n                             {\n                            // State:EmployeeProjectsOverview,\n                            name: 'Projects',\n                            label:\"Projects\",\n                            group : false,\n                            iconName:  global.get(\"icons.fas.project\"),\n                            iconState: true,\n                            bubble: '',\n                            employee_id :Item._id,\n                            organization_id:new ObjectID(Item.organization_id),\n                            Page: 'employee projects overview',\n                            redirect : true,\n                            inner: [],\n                            },\n                             {\n                            // State:EmployeeFileManagement,\n                            name: 'File management',\n                            label:  'File management',\n                            group : false,\n                            iconName:   global.get(\"icons.fas.file_management\"),\n                            iconState: true,\n                            bubble: '',\n                            employee_id :Item._id,\n                            organization_id: new ObjectID(Item.organization_id),\n                            Page: 'file management',\n                            redirect : true,\n                            level : 'employee',\n                            inner: [],\n                            },\n                              {    \n                            name: \"Calendar\",\n                            label: \"Calendar\",\n                            group : true,\n                            iconName: global.get(\"icons.fas.calendar\"),\n                            // iconUrl: 'https://revotio.nl/webpages/Icons/Checklist.svg', \n                            iconState: true,\n                            bubble: '',\n                            redirect : true,\n                            Page: 'calendar',\n                            employee_id :Item._id,\n                            organization_id: new ObjectID(Item.organization_id),\n                            level : 'employee',\n                            scope: '',\n                            inner: [],\n}\n                           \n                    ]})\n    \n})\n    \n// orderedEmployees = lodash.orderBy(employees, [\"name\" ] , ['asc'])\n\n\n\nChilds.push({\n                name: \"Dashboards\",\n                label: \"Dashboards\",\n                group : true,\n                iconName: global.get(\"icons.fas.dashboard\"),\n                iconState: true,\n                bubble: '1',\n                // Page: \"dashboard - involvement\",\n                organization_id: new ObjectID(msg.RevotioData.PostData.gadgetData.organization_id),\n                redirect : false,\n                inner: [{\n                        name: \"Involvement dashboard\",\n                        label: \"Involvement dashboard\",\n                        group : false,\n                        iconName: global.get(\"icons.fas.dashboard\"),\n                        iconState: true,\n                        bubble: '',\n                        Page: \"dashboard - involvement\",\n                        organization_id: new ObjectID(msg.RevotioData.PostData.gadgetData.organization_id),\n                        redirect : true,\n                        inner: []\n                }]\n        })\n\n    \n\n              \n\nmsg.payload = {\n    gadgetsList:[{\n        gadgetName: \"menu\",\n        gadgetType: \"Menu\",\n        gadgetId: \"menu\",\n        gadgetData : \n            {\n                parent :msg.RevotioData.PostData.gadgetData,\n                 child : Childs}\n        \n    }]\n}\n// node.send(msg)\n\n\n// msg.payload = {\n//     gadgetsList:[{\n//         gadgetName: \"menu\",\n//         gadgetType: \"Menu\",\n//         gadgetId: \"menu\",\n//         gadgetData : {\n//             parent: msg.RevotioData.PostData.gadgetData,\n//             childs : Childs\n//         }\n//     }]\n// }\n\nreturn msg;","outputs":1,"noerr":0,"x":4270,"y":1100,"wires":[["b8cba8eb.07bea8"]]},{"id":"386024ac.f579bc","type":"function","z":"d8703926.e2eca","name":"Create response obj","func":"// Get libraries\nconst Moment = global.get('moment');\nconst MomentRange = global.get('momentrange');\nconst moment = MomentRange.extendMoment(Moment);\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting'); \nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\n\n\n// filter work_package items\n\n\n\n\nvar Childs = [ ]\n\n\n\n// _.each(lodash.orderBy(msg.payload, [\"UserAccountData.first_name\", \"UserAccountData.last_name\"], [\"asc\", \"asc\"]), function(Item, index){\n    \n//     UserAccountData = Item.UserAccountData[0]\n//     // projectData = Item.projectData\n    \n\n    \n    \n//     Childs.push(  {\n//             name:  Item.UserAccountData[0].first_name + \" \" +  Item.UserAccountData[0].last_name,\n//             label: Item.UserAccountData[0].first_name + \" \" +  Item.UserAccountData[0].last_name,\n//             group : false,\n//             button: false,\n//             Type: \"Admin_Users\",\n//             buttonType: \"warning\",\n//             iconUrl: Item.UserAccountData[0].avatar,\n//             iconState: true,\n//             redirect : true,\n//             Page : \"users overview\",\n//             organization_id:new ObjectID(global.get(\"MasterOrganizationData._id\")),\n//             Appuser_id : Item.user,\n//             inner:[]\n//             })\n            \n// })\n\n  \n\n    \n\n\n\n\n              \n\n// msg.payload = {\n//     gadgetsList:[{\n//         gadgetName: \"menu\",\n//         gadgetType: \"Menu\",\n//         gadgetId: \"menu\",\n//         gadgetData : \n//             Childs\n        \n//     }]\n// }\n// node.send(msg)\n\n\nmsg.payload = {\n    gadgetsList:[{\n        gadgetName: \"menu\",\n        gadgetType: \"Menu\",\n        gadgetId: \"menu\",\n        gadgetData : {\n                parent :msg.RevotioData.PostData.gadgetData,\n                 child : Childs}\n                 \n                  \n        // {\n        //     parent: msg.RevotioData.PostData.gadgetData,\n        //     childs : Childs\n        // }\n    }]\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":1580,"y":820,"wires":[["b8cba8eb.07bea8"]]},{"id":"fe6bd026.750e2","type":"function","z":"d8703926.e2eca","name":"Prepair msg.menu && route based on UserType","func":"// Get libraries\nconst Moment = global.get('moment');\nconst MomentRange = global.get('momentrange');\nconst moment = MomentRange.extendMoment(Moment)\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting'); \nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\n\n\n\nmsg.menu = []           ;\nmsg.BreadCrumbData = {\n    Org : [],\n    Pro : [],\n    WP  : [],\n} ;\n\n\n\nvar OrgIds = [];\n\nindex = -1\n_.each(msg.RevotioData.session.UserData.AppUserPermissionInfo, function(Item, Index ){\n    // if (Item.type_id === global.get(\"MasterOrganizationData._id\")){\n  if (String(Item.type_id) === String(global.get(\"MasterOrganizationData._id\")) ){\n//   if (new ObjectID(Item.type_id) === new ObjectID(global.get(\"MasterOrganizationData._id\")) ){\n       index =  Index\n    }\n})\nif (index > -1 || msg.RevotioData.session.UserData.UserAccountData.user_type === \"Admin_Users\" ){\n   match = {parent_id: { $exists: false} ,\"_id\": {\"$ne\": new ObjectID(global.get(\"MasterOrganizationData._id\"))}};\n    // msg.operation = \"find.toArray\";\n    \n} else {\n    // get organization ID's\n    \n    var ids = [];\n    \n    _.each(msg.RevotioData.session.UserData.AppUserPermissionInfo, function(Item, Index){\n        if (Item.type === \"organization\"){\n            ids.push(new ObjectID(Item.type_id))\n        }\n       \n       \n    })\n    match = {  _id: {\"$in\": ids}}; // parent_id: { $exists: false} ,\n    \n}\nmsg.time = {start : new Date()}\n// find \n            // findObj = {\n            //         query : {\n            //                 query :match, \n            //                 },\n            //         connection:global.get(\"DB_data.connection\"),\n            //         database:global.get(\"DB_data.appDB\"),\n            //         collection:'organizations',\n            //         operation:'find',\n            //         }\n\n// aggregate\n            aggregateObj = {\n                    query : { query : [{\n                                $match: match\n                              },\n                              {\n                                $lookup: {\n                                  \"from\": \"organizations\",\n                                  \"localField\": \"_id\",\n                                  \"foreignField\": \"parent_id\",\n                                  \"as\": \"childOrganizations\"\n                                }\n                              },\n                            //   {\n                            //     $project: {\n                            //       \"permission\": 1.0,\n                            //       \"projectData.name\": 1.0\n                            //     }\n                            //   },\n                            //   {\n                            //     $unwind: {\n                            //       \"path\": \"$projectData\",\n                            //       \"includeArrayIndex\": \"arrayIndex\",\n                            //       \"preserveNullAndEmptyArrays\": false\n                            //     }\n                            //   }\n                            ],},\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'organizations',\n                    operation:'aggregate',\n                    }\n\n            mongodbTools.resolveAsync(aggregateObj, node, function(res){\n                    msg.payload = res\n                    node.send(msg) \n            })   \n            \n            \n\n\n\n\n\n// return msg;","outputs":1,"noerr":0,"x":1660,"y":860,"wires":[["586b1b7b.fd31c4"]],"outputLabels":["PNO, "]},{"id":"586b1b7b.fd31c4","type":"function","z":"d8703926.e2eca","name":"Create response object - users","func":"// Get libraries\nconst Moment = global.get('moment');\nconst MomentRange = global.get('momentrange');\nconst moment = MomentRange.extendMoment(Moment);\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting'); \nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\n\n\nvar Childs = [ ]\n\n\n\n_.each(lodash.orderBy(msg.payload, [\"name\"], [\"asc\"]), function(Item, index){\n    \n    projects    = 0\n    employee    = 0\n    user        = 0\n    \n    // if (Item.hasOwnProperty(\"participants\")){\n        \n    //     if (lodash.groupBy(Item.participants, \"type\").hasOwnProperty(\"project\")){\n    //          projects = lodash.groupBy(Item.participants, \"type\").project.length ;\n    //     }   else {\n    //          projects = 0 ;\n    //     }\n       \n    // }\n    // if (Item.hasOwnProperty(\"employee\")){\n    //     employee = Item.employee.length\n    // }\n    // if (Item.hasOwnProperty(\"user\")){\n    //     user = Item.user.length\n    // }\n        \n        OrgObj = {    \n                name: Item.name,\n                label: Item.name,\n                group : true,\n                \n                // iconUrl: 'https://revotio.nl/api/app/images/menu/icon_organization.svg',\n                iconState: true,\n                organization_id : Item._id,\n                bubble: 0,\n                inner:[{\n                  \n                    name: \"Projects\",\n                    label: \"Projects\",\n                    button: true,\n                    lazyload : \"projects\",\n                    buttonType: \"success\",\n                    group : true,\n                    organization_id : Item._id,\n                    // iconName: global.get(\"icons.images.project\"),\n                    iconUrl: global.get(\"DomainProperties.prodUrl\") + \"/files/SystemFiles/icons/icon_rocket.svg\", // global.get(\"icons.images.user\"),\n                    filePath :global.get(\"icons.images.project\") ,\n                    // iconUrl: 'https://revotio.nl/api/app/images/menu/icon_rocket.svg',\n                    iconState: true,\n                    bubble : projects,\n                    inner:[]\n                        },\n                        {\n                   \n                    name: \"Employees\",\n                    label: \"Employees\",\n                    button: true,\n                    lazyload : \"employees\",\n                    organization_id : Item._id,\n                    buttonType: \"success\",\n                    group : true,\n                    // iconName: global.get(\"icons.images.employee\"),\n                    iconUrl: global.get(\"DomainProperties.prodUrl\") + \"/files/SystemFiles/icons/icon_user.svg\", // global.get(\"icons.images.user\"),\n                    filePath :global.get(\"icons.images.user\") ,\n                    bubble : employee, \n                    // iconUrl: 'https://revotio.nl/api/app/images/menu/icon_rocket.svg',\n                    iconState: true,\n                    inner:[]\n                        },\n                        {               \n                   \n                    name: 'Organization',\n                    label: 'Organization',\n                    group : true, \n                    iconName: global.get(\"icons.fas.organization\"),\n                    // iconUrl: 'https://revotio.com/webpages/Icons/Airplane.svg', \n                    iconState: true,\n                    bubble: '',\n                      organization_id : Item._id,\n                    redirect : false,\n                    inner: [\n                        {               \n                            name: 'Overview',\n                            label: 'Overview',\n                            group : false,\n                            iconName: global.get(\"icons.fas.organization\"),\n                            iconState: true,\n                            bubble: '',\n                            Page : 'organization overview',\n                              organization_id : Item._id,\n                            redirect : true,\n                            inner: []\n                        },\n                        \n                        // {               \n                        //     name: 'Cost',\n                        //     label: 'Cost',\n                        //     group : false,\n                        //     iconName: global.get(\"icons.fas.organization\"),\n                        //     iconState: true,\n                        //       organization_id : Item._id,\n                        //     bubble: '',\n                        //     Page : 'organization cost',\n                        //     redirect : true,\n                        //     inner: []\n                        // },\n                        \n                        {               \n                            name: 'University contribution',\n                            label: 'University contribution',\n                            group : false,\n                            iconName: global.get(\"icons.fas.organization\"),\n                            iconState: true,\n                              organization_id : Item._id,\n                            bubble: '',\n                            Page : 'organization university contribution',\n                            redirect : true,\n                            inner: []\n                        },\n                        {               \n                            name: 'Finances',\n                            label: 'Finances',\n                            group : false,\n                            iconName: global.get(\"icons.fas.organization\"),\n                            iconState: true,\n                            bubble: '',\n                              organization_id : Item._id,\n                            Page : 'organization finances',\n                            redirect : true,\n                            inner: []\n                        },\n                        // {               \n                        //     name: 'Result',\n                        //     label: 'Result',\n                        //     group : false,\n                        //     iconName: global.get(\"icons.fas.organization\"),\n                        //     iconState: true,\n                        //       organization_id : Item._id,\n                        //     bubble: '',\n                        //     Page : \"organization result\",\n                        //     redirect : true,\n                        //     inner: []\n                        // },\n                        ] },\n                        {\n                   \n                    name: \"Users\",\n                    label: \"Users\",\n                    button: true,\n                    lazyload : \"organization_users\",\n                    organization_id : Item._id,\n                    buttonType: \"success\",\n                    group : true,\n                    // iconName: global.get(\"icons.images.user\"),\n                    iconUrl: global.get(\"DomainProperties.prodUrl\") + \"/files/SystemFiles/icons/icon_user.svg\", // global.get(\"icons.images.user\"),\n                     filePath :global.get(\"icons.images.user\") ,\n                    // iconUrl: 'https://revotio.nl/api/app/images/menu/icon_rocket.svg',\n                    iconState: true,\n                    bubble : user, \n                    inner:[]\n                        },\n                    {\n                    name: \"Dashboards\",\n                    label: \"Dashboards\",\n                    button: true,\n                    organization_id : Item._id,\n                    buttonType: \"success\",\n                    group : true,\n                    bubble : 4, \n                    iconName: global.get(\"icons.fas.dashboard\"),\n                    // iconUrl: 'https://revotio.nl/api/app/images/menu/icon_rocket.svg',\n                    iconState: true,\n                    inner:[ {    \n                            name: \"Involvement dashboard\",\n                            label: \"Involvement dashboard\",\n                            group : true,\n                            iconName: global.get(\"icons.fas.dashboard\"),\n                            // iconUrl: 'https://revotio.nl/webpages/Icons/Checklist.svg', \n                            iconState: true,\n                            bubble: '',\n                            redirect : true,\n                            Page: 'dashboard - involvement',\n                            organization_id : Item._id,\n                            scope: '',\n                            inner: [],\n                        },{    \n                            name: \"Time reporting dashboard\",\n                            label: \"Time reporting dashboard\",\n                            group : true,\n                            iconName: global.get(\"icons.fas.dashboard\"),\n                            // iconUrl: 'https://revotio.nl/webpages/Icons/Checklist.svg', \n                            iconState: true,\n                            bubble: '',\n                            redirect : true,\n                            Page: 'dashboard - time reporting',\n                            organization_id : Item._id,\n                            scope: '',\n                            inner: [],\n                        },\n                                                {    \n                            name: \"PM vs TM\",\n                            label: \"PM vs TM\",\n                            group : true,\n                            iconName: global.get(\"icons.fas.dashboard\"),\n                            // iconUrl: 'https://revotio.nl/webpages/Icons/Checklist.svg', \n                            iconState: true,\n                            bubble: '',\n                            redirect : true,\n                            Page: 'dashboard - pf vs tm ',\n                            organization_id : Item._id,\n                            scope: '',\n                            inner: [],\n                        },\n                        \n                        \n                        {    \n                            name: \"organization cockpit dashboard\",\n                            label: \"Organization cockpit dashboard\",\n                            group : true,\n                            iconName: global.get(\"icons.fas.dashboard\"),\n                            // iconUrl: 'https://revotio.nl/webpages/Icons/Checklist.svg', \n                            iconState: true,\n                            bubble: '',\n                            redirect : true,\n                            Page: 'organization cockpit dashboard',\n                            organization_id : Item._id,\n                            scope: '',\n                            inner: [],\n                        },\n                        {    \n                            name: \"Transactions dashboard\",\n                            label: \"Transactions dashboard\",\n                            group : true,\n                            iconName: global.get(\"icons.fas.dashboard\"),\n                            // iconUrl: 'https://revotio.nl/webpages/Icons/Checklist.svg', \n                            iconState: true,\n                            bubble: '',\n                            redirect : true,\n                            Page: 'Transactions dashboard',\n                            organization_id : Item._id,\n                            scope: '',\n                            inner: [],\n                        },\n                        \n                        ]\n                    },\n                     {\n                    name: \"Settings\",\n                    label: \"Settings\",\n                    button: false,\n                    buttonType: \"success\",\n                    group : true,\n                    // iconUrl: 'https://revotio.com/api/app/images/menu/icon_settings.svg',\n                    iconName: global.get(\"icons.fas.settings\"),\n                     organization_id : Item._id,\n                    iconState: true,\n                    redirect : false,\n                    inner:[\n                            {\n                            name: 'Project management',\n                            label: 'Project management',\n                            group : true,\n                            Page : 'setting project management',\n                            // iconName:  global.get(\"DomainProperties.prodUrl\") + \"/icons/icon_rocket.svg\", // global.get(\"icons.fas.project\"),\n                            iconName: global.get(\"icons.fas.settings\"),\n                            iconState: true,\n                            bubble: '',\n                             organization_id : Item._id,\n                            // organization_id : msg.loopData.OrgData._id,\n                            redirect : true,\n                            inner: []\n                            },\n                            {               \n                            name: \"Employee management\",\n                            label: \"Employee management\",\n                            group : false,\n                            iconName: global.get(\"icons.fas.settings\"),\n                            Page : \"settings - employee management\",\n                            // iconUrl: 'https://revotio.com/webpages/Icons/Airplane.svg', \n                            iconState: true,\n                             organization_id : Item._id,\n                            bubble: '',\n                            // organization_id : msg.loopData.OrgData._id,\n                            redirect : true,\n                            inner: []\n                            },\n                            {               \n                            name: 'Financials management',\n                            label: 'Financials management',\n                            group : false,\n                            iconName: global.get(\"icons.fas.settings\"),\n                            iconState: true,\n                             organization_id : Item._id,\n                            bubble: '',\n                            Page : 'settings - financials management',\n                            redirect : true,\n                            inner: []\n                            },\n                            {               \n                            name: 'File import',\n                            label: 'File import',\n                            group : false,\n                             organization_id : Item._id,\n                            iconName: global.get(\"icons.fas.settings\"),\n                            iconState: true,\n                            Page : \"settings - file import\", // \n                            bubble: '',\n                            redirect : true,\n                            inner: []\n                            },\n                                                        {               \n                            name: 'File export',\n                            label: 'File export',\n                            group : false,\n                            organization_id : Item._id,\n                            iconName: global.get(\"icons.fas.settings\"),\n                            iconState: true,\n                            Page : \"settings - export\", // \n                            bubble: '',\n                            redirect : true,\n                            inner: []\n                            },\n                            ]\n},\n                        {    \n                            name: \"file management\",\n                            label: \"File management\",\n                            group : true,\n                            iconName: global.get(\"icons.fas.file_management\"),\n                            // iconUrl: 'https://revotio.nl/webpages/Icons/Checklist.svg', \n                            iconState: true,\n                            bubble: '',\n                            redirect : true,\n                            Page: 'file management',\n                            organization_id : Item._id,\n                            level : 'organization',\n                            scope: '',\n                            inner: [],\n},  {    \n                            name: \"Calendar\",\n                            label: \"Calendar\",\n                            group : true,\n                            iconName: global.get(\"icons.fas.calendar\"),\n                            // iconUrl: 'https://revotio.nl/webpages/Icons/Checklist.svg', \n                            iconState: true,\n                            bubble: '',\n                            redirect : true,\n                            Page: 'calendar',\n                            organization_id : Item._id,\n                            level : 'organization',\n                            scope: '',\n                            inner: [],\n}]\n            }\n    if (Item.hasOwnProperty(\"logo\")){\n            OrgObj.iconUrl =   global.get(\"functions.fileManagement\")(  Item.logo.url, Item.logo.url ,msg.RevotioData.session._id, \"copySync\"), \n            OrgObj.filePath = Item.logo.url;\n        } else {\n            OrgObj.iconName =  global.get(\"icons.fas.organization\");\n        }\n    if (Item.hasOwnProperty(\"childOrganizations\") && Item.childOrganizations.length > 0){\n        \n        OrgObj.inner.unshift({\n                    name: \"Sub organizations\",\n                    label: \"Sub organizations\",\n                    button: true,\n                    lazyload : \"sub_organizations\",\n                    buttonType: \"success\",\n                    group : true,\n                    organization_id : Item._id,\n                    // iconName: global.get(\"icons.images.project\"),\n                    iconUrl: global.get(\"DomainProperties.prodUrl\") + \"/files/SystemFiles/icons/icon_organization.svg\", // global.get(\"icons.images.user\"),\n                    filePath :global.get(\"icons.images.organization\") ,\n                    // iconUrl: 'https://revotio.nl/api/app/images/menu/icon_rocket.svg',\n                    iconState: true,\n                    bubble : Item.childOrganizations.length ,\n                    inner:[]\n                        })\n     \n    }\n    \n    // if (Item.hasOwnProperty(\"parent_id\") === true){\n    //     OrgObj.ParentId = new ObjectID(Item.parent_id );\n    // }\n        Childs.push(OrgObj)\n})\n\n\n\n\n// filter work_package items\n\ngroup = lodash.groupBy(Childs, \"ParentId\");\ngroupedPayload= []\n\n_.each(group.undefined, function(parentValue, parentIndex){\n    if (group.hasOwnProperty(parentValue.organization_id)){\n        \n        // check if childs are active\n        _.each(group[parentValue.organization_id], function(Item, Index){\n            if (Item.State === \"Active\"){\n                parentValue.State = Item.State;\n            }\n        });\n        parentValue.inner.unshift({\n            State : parentValue.State,\n            name: \"sub_organizations\",\n            label: \"Sub organizations\",\n            group: true,\n            iconUrl : global.get(\"DomainProperties.prodUrl\") + \"/files/SystemFiles/icons/icon_organization.svg\", // global.get(\"icons.fas.organization\"),\n             filePath :global.get(\"icons.images.organization\") ,\n            inner:lodash.orderBy(group[parentValue.organization_id], ['name','bubble' ], ['asc', 'desc'])\n            })\n    }\n    groupedPayload.push(parentValue)\n})\n\n    \n\n\n\n\n              \n\n// msg.payload = {\n//     gadgetsList:[{\n//         gadgetName: \"menu\",\n//         gadgetType: \"Menu\",\n//         gadgetId: \"menu\",\n//         gadgetData : \n//             groupedPayload\n        \n//     }]\n// }\n// node.send(msg)\n\n\nmsg.payload = {\n    gadgetsList:[{\n        gadgetName: \"menu\",\n        gadgetType: \"Menu\",\n        gadgetId: \"menu\",\n        gadgetData : {\n                parent :msg.RevotioData.PostData.gadgetData,\n                 child : groupedPayload}\n                  \n        // {\n        //     parent: msg.RevotioData.PostData.gadgetData,\n        //     childs : Childs\n        // }\n    }]\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":2310,"y":940,"wires":[["b8cba8eb.07bea8"]]},{"id":"8c0473e0.6063c8","type":"function","z":"d8703926.e2eca","name":"Create response obj","func":"// Get libraries\nconst Moment = global.get('moment');\nconst MomentRange = global.get('momentrange');\nconst moment = MomentRange.extendMoment(Moment);\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting'); \nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\n\n\n// filter work_package items\n\n\n\n\nvar Childs = [ ]\n\n\n\n// _.each(lodash.orderBy(msg.payload, [\"UserAccountData.first_name\", \"UserAccountData.last_name\"], [\"asc\", \"asc\"]), function(Item, index){\n    \n//     UserAccountData = Item.UserAccountData[0]\n//     // projectData = Item.projectData\n    \n\n    \n    \n//     Childs.push(  {\n//             name:  Item.UserAccountData[0].first_name + \" \" +  Item.UserAccountData[0].last_name,\n//             label: Item.UserAccountData[0].first_name + \" \" +  Item.UserAccountData[0].last_name,\n//             group : false,\n//             button: true,\n//             Type: \"Users\",\n//             buttonType: \"warning\",\n//             iconUrl: global.get(\"functions.fileManagement\")( global.get(\"DomainProperties.rootPath\") + \"/organization/\"+ Item.organization_id +\"/\"+ Item.UserAccountData[0].avatar, Item.UserAccountData[0].avatar ,msg.RevotioData.session._id, \"copySync\"), \n     \n//             iconState: true,\n//             redirect : true,\n//             Page : \"users global\",\n//             organization_id:msg.RevotioData.PostData.gadgetData.organization_id,\n//             Appuser_id : Item.user,\n//             inner:[]\n//             })\n            \n// })\n\ndata = [{\n            name: \"Create user\",\n            label: \"Create user\",\n            UserType: \"Admin_Users\",\n            button: true,\n            buttonType: \"success\",\n            iconName: global.get(\"icons.fas.create\"),\n            // iconUrl: 'https://revotio.nl/webpages/Icons/Plus.svg', \n            iconState: true,\n            organization_id:msg.RevotioData.PostData.gadgetData.organization_id,\n            // Page: 'users overview',\n            inner:[]\n},{\n            name: \"Open user management\",\n            label: \"Open user management\",\n            Type: \"Admin_Users\",\n            button: true,\n            buttonType: \"success\",\n            iconName: global.get(\"icons.fas.open\"),\n            // iconUrl: 'https://revotio.nl/webpages/Icons/Airplane.svg', \n            iconState: true,\n            redirect : true,\n            Page : \"users global\",\n            organization_id:msg.RevotioData.PostData.gadgetData.organization_id,\n            // page: 'users overview',\n            inner:[]\n},\n// {\n//             name: \"Users\",\n//             label: \"users\",\n//             Type: \"Users\",\n//             button: true,\n//             buttonType: \"success\",\n//             iconName: global.get(\"icons.fas.users\"),\n//             // iconUrl: 'https://revotio.nl/webpages/Icons/Airplane.svg', \n//             iconState: true,\n//             group : true,\n//             redirect : false,\n//             // Page : \"users global\",\n//             // lazyload: \"admin_users\",\n//             organization_id:msg.RevotioData.PostData.gadgetData.organization_id,\n//             // page: 'users overview',\n//             inner:Childs\n// }\n]\n\n    \n\n\n\n\n              \n\n// msg.payload = {\n//     gadgetsList:[{\n//         gadgetName: \"menu\",\n//         gadgetType: \"Menu\",\n//         gadgetId: \"menu\",\n//         gadgetData : \n//             Childs\n        \n//     }]\n// }\n// node.send(msg)\n\n\nmsg.payload = {\n    gadgetsList:[{\n        gadgetName: \"menu\",\n        gadgetType: \"Menu\",\n        gadgetId: \"menu\",\n        gadgetData : {\n                parent :msg.RevotioData.PostData.gadgetData,\n                 child : data}\n                 \n                  \n        // {\n        //     parent: msg.RevotioData.PostData.gadgetData,\n        //     childs : Childs\n        // }\n    }]\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":1580,"y":900,"wires":[["b8cba8eb.07bea8"]]},{"id":"61572008.dbf89","type":"function","z":"d8703926.e2eca","name":"Create settings and formalize menu gadget payload","func":"var _ = global.get('underscore');\n\nmsg.menu.push({\n                    name: \"Settings\",\n                    label: \"Settings\",\n                    button: false,\n                    buttonType: \"success\",\n                    group : true,\n                    // iconUrl: 'https://revotio.com/api/app/images/menu/icon_settings.svg',\n                    iconName: global.get(\"icons.fas.settings\"),\n                    //  organization_id : Item._id,\n                    iconState: true,\n                    redirect : false,\n                    inner:[\n                        // {               \n                        //     name: 'Stats',\n                        //     label: 'Stats',\n                        //     group : false,\n                        //     iconName: global.get(\"icons.fas.settings\"),\n                        //     iconState: true,\n                        //     bubble: '',\n                        //     //  organization_id : Item._id,\n                        //     Page : 'settings',\n                        //     redirect : true,\n                        //     inner: []\n                        //     },\n          \n                            {\n                            name: 'Project management',\n                            label: 'Project management',\n                            group : true,\n                            Page : 'setting project management',\n                            // iconName:  global.get(\"DomainProperties.prodUrl\") + \"/icons/icon_rocket.svg\", // global.get(\"icons.fas.project\"),\n                            iconName: global.get(\"icons.fas.settings\"),\n                            iconState: true,\n                            bubble: '',\n                            //  organization_id : Item._id,\n                            // organization_id : msg.loopData.OrgData._id,\n                            redirect : true,\n                            inner: []\n                            },\n                            {               \n                            name: \"Form settings\",\n                            label: \"Form settings\",\n                            group : false,\n                            iconName: global.get(\"icons.fas.settings\"),\n                            Page : \"settings form management\",\n                            // iconUrl: 'https://revotio.com/webpages/Icons/Airplane.svg', \n                            iconState: true,\n                            //  organization_id : Item._id,\n                            bubble: '',\n                            // organization_id : msg.loopData.OrgData._id,\n                            redirect : true,\n                            inner: []\n                            },\n                            // {               \n                            // name: 'Financials management',\n                            // label: 'Financials management',\n                            // group : false,\n                            // iconName: global.get(\"icons.fas.settings\"),\n                            // iconState: true,\n                            // //  organization_id : Item._id,\n                            // bubble: '',\n                            // Page : 'settings - financials management',\n                            // redirect : true,\n                            // inner: []\n                            // },\n                            \n                            ]\n})\n\nmsg.menu.push({\n            name: \"time registration\",\n            label: \"time registration \" + msg.RevotioData.session.UserData.UserAccountData.first_name + \" \" +msg.RevotioData.session.UserData.UserAccountData.last_name,\n            button: true,\n            buttonType: \"success\",\n            userId : msg.RevotioData.session.UserData._id,\n            Page : \"time registration\",\n            // iconUrl: 'https://revotio.com/api/app/images/menu/icon_settings.svg',\n            iconName: global.get(\"icons.fas.clock\"),\n            iconState: true,\n            redirect : true,\n            inner:[]\n});\n\nmsg.menu.push({\n            name: \"Log out\",\n            label: \"Log out \" + msg.RevotioData.session.UserData.UserAccountData.first_name + \" \" +msg.RevotioData.session.UserData.UserAccountData.last_name,\n            button: false,\n            buttonType: \"success\",\n            // iconUrl: 'https://revotio.com/api/app/images/menu/icon_settings.svg',\n            iconName: global.get(\"icons.fas.logout\"),\n            iconState: true,\n            redirect : true,\n            inner:[]\n});\n\n\n// msg.menu.push({\n//             name: \"demo page\",\n//             label: \"demo page \",\n//             button: false,\n//             buttonType: \"success\",\n//             Page: \"demo page\",\n//             // iconUrl: 'https://revotio.com/api/app/images/menu/icon_settings.svg',\n//             iconName: global.get(\"icons.fas.logout\"),\n//             iconState: true,\n//             redirect : true,\n//             inner:[]\n// });\n\n\n\n\n\nmsg.payload = {\n            \n            gadgetsList:[{\n            gadgetName: 'menu',\n            gadgetId: 'menu',\n             gadgetData: {\n                 parent :{},\n                 child : msg.menu}\n            }]\n};\n\n// msg.payload = {\n            \n//             gadgetsList:[{\n//             gadgetName: 'menu',\n//             gadgetId: 'menu',\n//              gadgetData:  msg.menu\n//             }]\n// };\n\n\nreturn msg;","outputs":1,"noerr":0,"x":2710,"y":640,"wires":[["b8cba8eb.07bea8"]]},{"id":"e3d3db19.0f4c1","type":"function","z":"d8703926.e2eca","name":"Add users","func":"// Get libraries\nconst Moment = global.get('moment');\nconst MomentRange = global.get('momentrange');\nconst moment = MomentRange.extendMoment(Moment);\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\n\nmsg.menu.push({\n            name: \"Admin users\",\n            label: \"Admin users\",\n            group : true,\n            button: false,\n            buttonType: \"warning\",\n            // iconName: global.get(\"icons.fas.users\"),\n            iconUrl: global.get(\"DomainProperties.prodUrl\") + \"/files/SystemFiles/icons/icon_user.svg\", // global.get(\"icons.images.user\"),\n             filePath :global.get(\"icons.images.user\") ,\n            iconState: true,\n            redirect : false,\n            lazyload: \"admin_users\",\n            inner:[]\n});\n\nUsersIndex = lodash.findIndex(msg.menu, ['name', \"Admin users\"]);\n\n\n// _.each(msg.payload, function(userItem, userIndex){\n    \n//     if (userItem.UserAccountData.length > 0){\n    \n//             State = \"Inactive\";\n\n//             if (String(userItem.user) === String(msg.RevotioData.FlowData.Appuser_id)){\n//                 State = \"Active\";\n                \n//                 msg.menu[UsersIndex].inner.State = State;\n//             }\n    \n    \n    \n//     // msg.permissionIndex = lodash.findIndex(userItem.AppUserPermissionInfo, ['organization_id', String(msg.loopData.OrgData._id)]);\n//     // if (msg.permissionIndex > 0 ){\n//         msg.menu[UsersIndex].inner.push({\n//             State:State,\n//             name:  userItem.UserAccountData[0].first_name + \" \" +  userItem.UserAccountData[0].last_name,\n//             label: userItem.UserAccountData[0].first_name + \" \" +  userItem.UserAccountData[0].last_name,\n//             group : false,\n//             button: false,\n//             Type: \"Admin_Users\",\n//             buttonType: \"warning\",\n//             iconUrl: userItem.UserAccountData[0].avatar,\n//             iconState: true,\n//             redirect : true,\n//             Page : \"users overview\",\n//             organization_id:new ObjectID(global.get(\"MasterOrganizationData._id\")),\n//             Appuser_id : userItem.user,\n//             inner:[]\n//             });\n//     // }\n//     }\n// });\n\n msg.menu[UsersIndex].inner.unshift({\n            name: \"Create user\",\n            label: \"Create user\",\n            UserType: \"Admin_Users\",\n            button: true,\n            buttonType: \"success\",\n            iconName: global.get(\"icons.fas.create\"),\n            // iconUrl: 'https://revotio.nl/webpages/Icons/Plus.svg', \n            iconState: true,\n            organization_id:new ObjectID(global.get(\"MasterOrganizationData._id\")),\n            // Page: 'users overview',\n            inner:[]\n});\n\n msg.menu[UsersIndex].inner.unshift({\n            name: \"Open user management\",\n            label: \"Open user management\",\n            Type: \"Admin_Users\",\n            button: true,\n            buttonType: \"success\",\n            iconName: global.get(\"icons.fas.open\"),\n            // iconUrl: 'https://revotio.nl/webpages/Icons/Airplane.svg', \n            iconState: true,\n            redirect : true,\n            Page : \"users global\",\n            \"level\": \"admin\",\n            organization_id:new ObjectID(global.get(\"MasterOrganizationData._id\")),\n            // page: 'users overview',\n            inner:[]\n});\n\n//  msg.menu[UsersIndex].inner.push({\n//             name: \"Users\",\n//             label: \"Users\",\n//             Type: \"Admin_Users\",\n//             button: true,\n//             buttonType: \"success\",\n//             iconName:  global.get(\"DomainProperties.prodUrl\") + \"/files/SystemFiles/icons/icon_user.svg\", // global.get(\"icons.fas.users\"),\n//             // iconUrl: 'https://revotio.nl/webpages/Icons/Airplane.svg', \n//             iconState: true,\n//             group : true,\n//             redirect : false,\n//             // Page : \"users global\",\n//             lazyload: \"admin_users\",\n//             organization_id:new ObjectID(global.get(\"MasterOrganizationData._id\")),\n//             // page: 'users overview',\n//             inner:[]\n// });\n\n\n\nreturn msg;","outputs":1,"noerr":0,"x":2450,"y":640,"wires":[["61572008.dbf89"]]},{"id":"38a3c6ce.de92ca","type":"function","z":"d8703926.e2eca","name":"Add organization to msg.menu","func":"// Get libraries\nconst Moment = global.get('moment');\nconst MomentRange = global.get('momentrange');\nconst moment = MomentRange.extendMoment(Moment);\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\n\n\nnewArr = []\n\nmsg.menu.push({\n            State: \"Inactive\",\n            name: \"Organizations\",\n            label: \"Organizations\",\n            button: true,\n            group : true,\n            buttonType: \"success\",\n            iconUrl: global.get(\"DomainProperties.prodUrl\") + \"/files/SystemFiles/icons/icon_organization.svg\",// global.get(\"icons.images.organization\"),  \n            filePath :global.get(\"icons.images.organization\") ,\n            iconState: true,\n            inner:[\n                {\n            name: \"Create organization\",\n            label: \"Create organization\",\n            button: true,\n            buttonType: \"success\",\n            iconName: global.get(\"icons.fas.create\"),\n            // iconUrl: 'https://revotio.nl/webpages/images/icons/Add.svg',\n            iconState: true,\n            inner:[]\n},{\n            name: \"Organizations overview\",\n            label:  \"Organizations overview\",\n            button: true,\n            buttonType: \"success\",\n            iconName: global.get(\"icons.fas.open\"),\n            // iconUrl: 'https://revotio.nl/webpages/images/icons/Open.svg',\n            iconState: true,\n            redirect : true,\n            Page: 'organizations global',\n            inner:[],\n           \n},\n\n{\n            name: \"Organizations\",\n            label: \"Organizations\",\n            button: true,\n            buttonType: \"success\",\n            lazyload : \"organizations\",\n            // iconName: global.get(\"DomainProperties.prodUrl\") + \"/icons/icon_organization.svg\", // global.get(\"icons.fas.organization\"),\n            iconUrl:  global.get(\"DomainProperties.prodUrl\") + \"/files/SystemFiles/icons/icon_organization.svg\",\n            filePath :global.get(\"icons.images.organization\") ,\n            iconState: true,\n            // redirect : true,\n            // Page: 'organizations global',\n            inner:[],\n             bubble: msg.payload,\n}]\n});\n\n\n\n\n// msg.menu[0].inner = newArr ;\n\n\nreturn msg;","outputs":1,"noerr":0,"x":2250,"y":640,"wires":[["e3d3db19.0f4c1"]]},{"id":"e8586971.9e6628","type":"function","z":"d8703926.e2eca","name":"Prepair msg.menu && route based on UserType","func":"var request = global.get('request');\nvar Moment = global.get('moment');var MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar crypto = global.get('crypto');\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\nmsg.menu = []           ;\nmsg.BreadCrumbData = {\n    Org : [],\n    Pro : [],\n    WP  : [],\n} ;\n\n// Create organizations group\n\n\ngadgetsDir = \"../../../var/www/pagePublisher/src/components/gadgets\"\n\n\nfs.readdir(gadgetsDir, (err, files) => { \n  if (err) \n    console.log(err); \n  else { \n      \n      node.warn({\"files\":files})\n      \n//     console.log(\"\\nCurrent directory filenames:\"); \n//     files.forEach(file => { \n//       console.log(file); \n//     }) \n  } \n}) \n\n\nindex = -1\n_.each(msg.RevotioData.session.UserData.AppUserPermissionInfo, function(Item, Index ){\n    // if (Item.type_id === global.get(\"MasterOrganizationData._id\")){\n  if (String(Item.type_id) === String(global.get(\"MasterOrganizationData._id\")) ){\n//   if (new ObjectID(Item.type_id) === new ObjectID(global.get(\"MasterOrganizationData._id\")) ){\n       index =  Index\n    }\n})\nif (index > -1 || msg.RevotioData.session.UserData.UserAccountData.user_type === \"Admin_Users\" ){\n   match = {parent_id: { $exists: false} , \"_id\": {\"$ne\": new ObjectID(global.get(\"MasterOrganizationData._id\"))}};\n    // msg.operation = \"find.toArray\";\n    \n} else {\n    \n    Obj = lodash.find(msg.RevotioData.session.UserData.AppUserPermissionInfo, { \"type\": \"organization\"});\n    match = {\"_id\": new ObjectID(Obj.type_id)};\n    \n}\n\n\nmsg.time = {start : new Date()}\n\nfindManyObj = {\n                    query : {\n                            query :match, \n                            projection: {_id:1}\n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'organizations',\n                    operation:'find',\n                    }\n\n            mongodbTools.resolveAsync(findManyObj, node, function(res){\n                    msg.payload = res.length\n                    node.send(msg) \n            }) \n\n\n\n// return msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1640,"y":660,"wires":[["38a3c6ce.de92ca","896a8494.419aa8"]],"outputLabels":["PNO, "]},{"id":"185b7877.16f478","type":"inject","z":"d8703926.e2eca","name":"","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":1760,"y":520,"wires":[["e8bc643c.5b91f"]]},{"id":"e8bc643c.5b91f","type":"function","z":"d8703926.e2eca","name":"Libs","func":"// Get libraries\nconst Moment = global.get('moment');\nconst MomentRange = global.get('momentrange');\nconst moment = MomentRange.extendMoment(Moment)\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting'); \nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\n\n\n\nfindObj = {\n                query : {\n                        query :{\"$or\" : [{Type : \"ProjectType\"}, {Type : \"JobTitle\"},{Type : \"Department\"} ]}, \n                        },\n                connection:\"mongodb://admin:lADOodCgW0vDAKbE@proddb-shard-00-00-mkgff.mongodb.net:27017,proddb-shard-00-01-mkgff.mongodb.net:27017,proddb-shard-00-02-mkgff.mongodb.net:27017/admin?ssl=true&replicaSet=ProdDB-shard-0\",\n                database:\"test\",\n                collection:'devices',\n                operation:'find',\n                }\n\n        mongodbTools.resolveAsync(findObj, node, function(res){\n                msg.result = res\n                node.send(msg) \n        })   \n\n","outputs":1,"noerr":0,"x":1870,"y":520,"wires":[[]]},{"id":"679d95fb.063114","type":"function","z":"d8703926.e2eca","name":"Remove user sessions","func":"var request = global.get('request');\nvar Moment = global.get('moment');var MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar crypto = global.get('crypto');\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\n// remove \n            removeObj = {\n                    query : {\n                            query :{\n                                        deviceId : msg.RevotioData.session.deviceId ,\n                                        revotioSessionId: msg.RevotioData.session.revotioSessionId\n                                    }, \n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'sessions',\n                    operation:'remove',\n                    }\n\n            mongodbTools.resolveAsync(removeObj, node, function(res){\n                    // msg.payload = res\n                    node.send(msg) \n            })   ","outputs":1,"noerr":0,"x":720,"y":1120,"wires":[["73743298.29765c"]]},{"id":"73743298.29765c","type":"function","z":"d8703926.e2eca","name":"remove global comntext sessions","func":"global.set(\"gadgetGroups.\"+ msg.RevotioData.session.deviceId)\n\nmsg.payload = {\n    RevotioData:{\n    logout : true,},\n    deviceId: msg.RevotioData.session.deviceId,\n    // revotioSessionId : msg.RevotioData.session.revotioSessionId\n}\n\nmsg.headers = {\n    'Access-Control-Allow-Origin': '*',\n    'Access-Control-Allow-Methods': 'PUT,GET,POST,DELETE,OPTIONS',\n    'Access-Control-Allow-Headers': 'Content-Type',\n    'content-type': 'application/json',\n};\nreturn msg;","outputs":1,"noerr":0,"x":960,"y":1120,"wires":[["45f70413.21ab2c"]]},{"id":"45f70413.21ab2c","type":"http response","z":"d8703926.e2eca","name":"","statusCode":"","headers":{},"x":1170,"y":1120,"wires":[]},{"id":"16e26d9e.c0ac62","type":"http in","z":"d8703926.e2eca","name":"Menu","url":"/Menu","method":"post","upload":false,"swaggerDoc":"","x":190,"y":840,"wires":[["9728bf20.e6f3d"]]},{"id":"d95079f7.8dc1d8","type":"subflow:5e9b9c1d.bbe4a4","z":"d8703926.e2eca","name":"","env":[],"x":660,"y":720,"wires":[]},{"id":"9728bf20.e6f3d","type":"function","z":"d8703926.e2eca","name":"Prepair flow","func":"// Get libraries\nconst Moment = global.get('moment');\nconst MomentRange = global.get('momentrange');\nconst moment = MomentRange.extendMoment(Moment)\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting'); \nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\n\n\npayload = msg.payload\n_.each(payload, function(item, key){\n    msg[key] = item\n})\n\nreturn msg;","outputs":1,"noerr":0,"x":310,"y":840,"wires":[["5b7fb22f.8de844","4314eee4.f4e7f"]]},{"id":"b8cba8eb.07bea8","type":"http response","z":"d8703926.e2eca","name":"","statusCode":"","headers":{},"x":2390,"y":780,"wires":[]},{"id":"94ef6924.94c9","type":"subflow:3170c4ab.fadb9c","z":"d8703926.e2eca","name":"","env":[],"x":880,"y":760,"wires":[["71636367.1aba4c"]]},{"id":"71636367.1aba4c","type":"function","z":"d8703926.e2eca","name":"Set RevotioData","func":"\npayload = {\n    payload : msg.payload,\n    RevotioData: msg.RevotioData\n}\n\nmsg.payload = payload\nreturn msg;","outputs":1,"noerr":0,"x":1020,"y":760,"wires":[["e74b4e81.9065d8"]]},{"id":"e74b4e81.9065d8","type":"http response","z":"d8703926.e2eca","name":"","statusCode":"","headers":{},"x":1130,"y":760,"wires":[]},{"id":"c43cd37b.1268","type":"debug","z":"d8703926.e2eca","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":3740,"y":1080,"wires":[]},{"id":"1dfc0e60.c5afa2","type":"function","z":"d8703926.e2eca","name":"Prepair msg.menu && sub_organizations","func":"// Get libraries\nconst Moment = global.get('moment');\nconst MomentRange = global.get('momentrange');\nconst moment = MomentRange.extendMoment(Moment)\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting'); \nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\n\n\n\nmsg.menu = []           ;\nmsg.BreadCrumbData = {\n    Org : [],\n    Pro : [],\n    WP  : [],\n} ;\n\n\n// \n\n\n// aggregate\n            aggregateObj = {\n                    query : { query : [{\n                                $match: {parent_id : new ObjectID(msg.RevotioData.PostData.gadgetData.organization_id)}\n                              },\n                              {\n                                $lookup: {\n                                  \"from\": \"organizations\",\n                                  \"localField\": \"_id\",\n                                  \"foreignField\": \"parent_id\",\n                                  \"as\": \"childOrganizations\"\n                                }\n                              },\n                            //   {\n                            //     $project: {\n                            //       \"permission\": 1.0,\n                            //       \"projectData.name\": 1.0\n                            //     }\n                            //   },\n                            //   {\n                            //     $unwind: {\n                            //       \"path\": \"$projectData\",\n                            //       \"includeArrayIndex\": \"arrayIndex\",\n                            //       \"preserveNullAndEmptyArrays\": false\n                            //     }\n                            //   }\n                            ],},\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'organizations',\n                    operation:'aggregate',\n                    }\n\n            mongodbTools.resolveAsync(aggregateObj, node, function(res){\n                    msg.payload = res\n                    node.send(msg) \n            })   \n            \n            \n\n\n\n\n\n// return msg;","outputs":1,"noerr":0,"x":1640,"y":940,"wires":[["586b1b7b.fd31c4"]],"outputLabels":["PNO, "]},{"id":"47fdbeb5.4211e","type":"comment","z":"aec22158.fe4e38","name":"Global context data","info":"","x":410,"y":20,"wires":[]},{"id":"bec51817.848ff8","type":"subflow:e25f5e2d.45871","z":"aec22158.fe4e38","name":"","env":[],"x":180,"y":80,"wires":[[]]},{"id":"4809e15c.231538","type":"link in","z":"aec22158.fe4e38","name":"Push gadgets to frontend","links":["22600218.5f17ce","237dc0d6.55ce58","2d570acc.402cee","4d2f5f49.74d588","4f069602.986148","54156eec.b14a88","6b7d9d4c.4f7de4","6b8fb4fa.663c8c","7bd715c1.48678c","7d81d17c.aaecb8","881d9107.af00e","98c425c5.4b0328","a9e514e2.43afa8","ad59d764.8f538","af92a9f3.f2eab","b62f16e5.5c7998","ba29073e.8adb","bdf7ba4.ba0e548","fb679d51.f23358"],"x":55,"y":80,"wires":[["bec51817.848ff8"]]},{"id":"192fce41.a964e2","type":"comment","z":"2294209a.0c95b","name":"Global context data","info":"","x":350,"y":40,"wires":[]},{"id":"d98d965c.e5c518","type":"subflow:e25f5e2d.45871","z":"2294209a.0c95b","name":"","env":[],"x":420,"y":100,"wires":[[]]},{"id":"480dae32.8a339","type":"link in","z":"2294209a.0c95b","name":"Push gadgets to frontend","links":["1bc869a3.7eb996","1c021baa.41b07c","2a3f6b04.a7f3bc","56a2b4a6.6d588c","5d648f99.e116b8","b742db6e.8148f","d6f75efd.0ef05","da96270c.50aa4","df9e1699.b208d8","e5361ca5.ccabf","f19484dd.a1fe48","f438ead1.51c198"],"x":295,"y":100,"wires":[["d98d965c.e5c518"]]},{"id":"c91bfeb6.105ee8","type":"comment","z":"e5822137.be45d","name":"Global context data","info":"","x":490,"y":20,"wires":[]},{"id":"195b9b9c.a972dc","type":"subflow:e25f5e2d.45871","z":"e5822137.be45d","name":"","env":[],"x":740,"y":120,"wires":[[]]},{"id":"a6ee6331.070228","type":"link in","z":"e5822137.be45d","name":"Push Gadget to Frontend","links":["1414db5.9477225","332fcebf.47e5ea","402f0b1e.b2f10c","473575ea.f2ca9c","4e30d34a.94d17c","5a1bf7f9.3cce7","5d9d62c1.c97ae4","63f480be.65ed78","6c372d2d.56f66c","726136cc.ee23e","72f5dc66.d27994","887ec7cf.104c1","950e082d.458a48","9a43c1cc.c7e6a8","9ab04a2a.f2bec","a64310c4.2429c8","b0cd1861.02c32","b5b81ae2.4e6f3","c16d9a0c.c46d58","cc93af00.839ed","d17b5e28.efa078","e7a48cc8.cc60d8","ec6b9f6a.c0a41","f0a7f951.ad708","33287b30.e85ea4","b51910ff.83ca18","6c9f0870.13af78","324de421.bf1f2c","6f9cee85.74eff8","1da04cb0.06c6d3","56a732b2.20accc","6a9882ea.91bdbc","960027a2.514268","e539d89b.9f3b08"],"x":395,"y":80,"wires":[["e5f1ee6f.1b3268"]]},{"id":"42ee5df0.7ac9b4","type":"link in","z":"e5822137.be45d","name":"Push gadget to frontend","links":["6c1fc1e4.18153","71a75c31.72c3c4","8915c09f.764ff","2c7cb1db.77396e","a46f6b54.9146e8","9380426d.7e2f8","dd17eedc.661de","b6af783.489bb88","bcf32a29.9d22c8","e49f3be7.3f3e98","17bd5710.330e29","b54de25e.224c9","c8128f27.83f0c","5b8d4cf6.ca32a4","8e11c1d1.ada8b","d4ed1cc8.5a11f","34e3a2a7.c7936e","aa4a5c67.21ed7","671679df.f85b58","ba7265f.9e92f98","34d8dd6f.00fb92","17630ade.28bd95","f0aa4719.022068","f5c57219.73ea9","1c3a6655.a06b7a","5b59ec64.44982c","18c9fe9e.5f6899"],"x":435,"y":80,"wires":[["e5f1ee6f.1b3268"]]},{"id":"4fe5a76.5bcfd58","type":"link in","z":"e5822137.be45d","name":"Push Gadgets to frontend","links":["13bcb907.ca42ef","286a4834.8ee44","6800f9d5.3dff58","7e394d6c.c2831c","9906fb19.b9b47","9bc60dce.db6568","c62e0e45.48a2c8"],"x":375,"y":120,"wires":[["e5f1ee6f.1b3268"]]},{"id":"eefe6ecb.492078","type":"link in","z":"e5822137.be45d","name":"Return to Frontend","links":["2ef1becf.7da1b2","a65bd864.ee1828","23e4ed49.681a62","52cac6c8.8f6018","878ed43d.f6c348","16d8ff69.d71e71","4ae71785.1c5fc","5002c494.80c03c","5dba0abb.3b9dbc","fb03028f.7d0f4","44b32d37.175e74","f94c825a.6795a","47f74ceb.d79b1c","32d5e9f1.b935f6","1f8e3f90.84a298","5f1a385c.edb14","37562fb5.4313a","b4a3b5aa.487f6","f10a8582.df74b","f70e748a.df179","30650656.001a8a","b9d6160.16eb6e8","e995ed62.c5e138","4e3d365f.e1d8f","4d639347.c27a34","c2c17e7a.3ca688","69c8a744.a0827","55f4828f.4fb3b4","d4c53ab.5c3e3c8","4c49a90c.d02c48","9e47ec67.076808","ba6eeef0.503198","47b5eaad.ade484","7766b2b7.7570dc","33d4041f.3ee46c","cf5ee563.e9a7","c1f9d0b7.2a065","57c5062c.523b38","56f4c565.9de3f4","66f48d18.a2d8fc","7ea38e7d.370328","76a831f8.cf2bc8","b300552.bc2f128","244b0842.7f8878","fa510cbe.abfd88","ad6f24d.a8f1758","1bc37531.9d52bb","b2731052.a9087","ce0aa294.a809d","8f3ccf44.4192a","d57bc5e4.c556c8","bdcbb946.3f6a78"],"x":375,"y":80,"wires":[["e5f1ee6f.1b3268"]]},{"id":"656ec53c.6bb344","type":"link in","z":"e5822137.be45d","name":"organization global ==> Push gadget frontend","links":["d0895998.b221d8","9198d989.635538","589647d4.40b338","4b07fc0a.2f3c64","243bd25a.1dddce","a79d9a84.9e87e8","44496033.f380b","89e07cb5.9ceff","3dfbfbc5.ae5004","c1bbd831.582ba8","62127a31.57f32c","774bc9c9.58a1c","9ecfa92f.c28c9","2eca442d.4fc91c","9909108a.a8f2b8","41e59027.48e72","aafa8726.1d31f8","f786d66a.a9421","aa7b16f6.fea1b","f8555133.f61438","99aa8f9e.07ed8","4b702acd.895cf4","214f3437.be9504","c28406bc.ba45","a42b3aa1.c42c48","164a8d01.4eb1c3","8b0c5b93.fa7688","96028ac8.026ff8","2272d450.d6f004","1d19be79.2f946a","a3794f83.51c8d8","8d6a210f.640ba","57277aec.3334fc","1c35b137.b4b267","3406b068.d2d0c8","ebd47a0c.f53a88","72785794.bda1c8"],"x":395,"y":120,"wires":[["e5f1ee6f.1b3268"]]},{"id":"d95f4281.738d6","type":"link in","z":"e5822137.be45d","name":"organization global ==> Push gadget frontend","links":["9cb9a896.aa1d68","c78a9002.ce20e","767d4c28.0d0bf4","1effa21b.e3429e","30cb18ad.79a6d8","92084dab.74935","9b1164dc.d1ac98","e8ba36c6.b04a48","5573b262.5cb4ac","17ad68.49713299","8462b834.d9dd78","3646efc7.b16e08","66a93ca.a947544","446825fb.8b9704","c0822dfb.e6597","6e3e8606.38dd4","c75c9dc0.0e26c"],"x":395,"y":100,"wires":[["e5f1ee6f.1b3268"]]},{"id":"e5f1ee6f.1b3268","type":"function","z":"e5822137.be45d","name":"","func":"\nreturn msg;","outputs":1,"noerr":0,"x":570,"y":120,"wires":[["195b9b9c.a972dc"]]},{"id":"d746445.12ff338","type":"comment","z":"d8703926.e2eca","name":"Global context data","info":"","x":1450,"y":120,"wires":[]},{"id":"b2b8b6e9.e3583","type":"subflow:e25f5e2d.45871","z":"d8703926.e2eca","name":"","env":[],"x":1780,"y":220,"wires":[[]]},{"id":"85ce669.6b97d18","type":"link in","z":"d8703926.e2eca","name":"Push Gadget to Frontend","links":["192ccb9.8f0e834","2daf070a.78ed98","31cfbc66.cc8804","50d2a4eb.931acc","55f75812.d4147","6e19fdf0.93f8ac","7e5248cb.e2b4e8","b8d4d51b.d27168","ca0414d.a9c7a68"],"x":1315,"y":180,"wires":[["232c062f.9308ca"]]},{"id":"411df713.b9876","type":"link in","z":"d8703926.e2eca","name":"Push Gadget To Frontend","links":["1442a4d5.9c0f33","249bc257.6a40be","32936bf1.d4c834","3eb8b197.0a27fe","44f19a87.24091c","4e7dc4ba.e53dec","5bdc7bec.cdb68c","6aabdce9.91cf04","70af7f8.2d8678","7771fa3b.ba2dd4","7bf09f51.39e638","7f170c1b.2dff24","830d2d5c.7649a8","970a5c89.9998d8","a1ac9bfe.4be8f","ab0b0518.41d1f","bf81f94.908f988","cb71ddc7.f86018","d29ab08b.41594","d5af710b.e3f5f8","e4e5817c.d95f98","e7db9cb8.a3f61","f79ed97a.685ca"],"x":1315,"y":220,"wires":[["232c062f.9308ca"]]},{"id":"232c062f.9308ca","type":"function","z":"d8703926.e2eca","name":"","func":"\nreturn msg;","outputs":1,"noerr":0,"x":1610,"y":220,"wires":[["b2b8b6e9.e3583"]]},{"id":"71332273.c1870c","type":"debug","z":"aec22158.fe4e38","name":"debug - Reset password INIT","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1070,"y":2160,"wires":[]},{"id":"3199acdc.5d559c","type":"debug","z":"508957a1.dd5398","name":"TOKEN post","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":670,"y":1540,"wires":[]},{"id":"a16ff674.24bb78","type":"function","z":"39834eee.0dd5a2","name":"Update session","func":"var request = global.get('request');\nvar Moment = global.get('moment');var MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar crypto = global.get('crypto');\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\n// update    \n\nupdateObj = {\n                    query : {\n                            query :{\n                                    deviceId:msg.payload.deviceId,\n                                    revotioSessionId:msg.payload.revotioSessionId\n                            }, \n                            update : { \"$set\" : {\n                                                    timestamp : new Date(),\n                                                    token: msg.payload.token,\n                                                    Gadgets: [],\n                                                    Page: msg.payload.Page,\n                                                    groupedObject: msg.payload.presentationLayer.groupedObject}},\n                            options : {upsert: true}\n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'sessions',\n                    operation:'update', // updateMany , updateOne\n                    }\n\n            mongodbTools.resolveAsync(updateObj, node, function(res){\n                    // msg.payload = res\n                    node.send(msg) \n            }) ","outputs":1,"noerr":0,"x":140,"y":80,"wires":[[]]},{"id":"e343bb91.2fe0a8","type":"function","z":"e25f5e2d.45871","name":"Update && Get session","func":"var request = global.get('request');\nvar Moment = global.get('moment');var MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar crypto = global.get('crypto');\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\n\nif (msg.payload.gadgetsList){\n\nupdateObj = {\n                    query : {\n                            query :{_id:new ObjectID(msg.RevotioData.session._id)}, \n                            update : { \"$push\": { Gadgets: { \"$each\": msg.payload.gadgetsList } }},\n                            options : {upsert: true, returnOriginal: false}\n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'sessions',\n                    operation:'findOneAndUpdate', // updateMany , updateOne\n                    }\n\n            mongodbTools.resolveAsync(updateObj, node, function(res){\n                \n                if (typeof res === 'object' && res.hasOwnProperty(\"value\")){\n                     msg.session = res.value\n              \n               \n                \n                        //     findOneObj = {\n                        //         query : {\n                        //                 query :{\n                        //                       _id:new ObjectID(msg.RevotioData.session._id)\n                        //                 } \n                        //                 },\n                        //         connection:global.get(\"DB_data.connection\"),\n                        //         database:global.get(\"DB_data.appDB\"),\n                        //         collection:'sessions',\n                        //         operation:'find',\n                        //         }\n            \n                        // mongodbTools.resolveAsync(findOneObj, node, function(res){\n                        //     if (res.length > 0){\n                        //         msg.session = res[0]\n                        //     } else {\n                        //         msg.session = {}\n                        //     }\n                                \n                                node.send(msg) \n                        // })  \n                } \n                else {\n                    \n                    msg.session = msg.RevotioData.session\n                    msg.response = res\n                    node.send(msg) \n                }\n            \n            \n            }) \n            \n} else {\n    console.log({\n        error : \"no msg.payload.gadgetsList present\",\n        RevotioData : msg.RevotioData,\n        payload : msg.payload\n    })\n    // msg.error = \"no msg.payload.gadgetsList present\"\n     node.send(msg) \n}\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":170,"y":220,"wires":[["242f58f1.b6c22"]]},{"id":"6c4dc95f.5f22c","type":"function","z":"e25f5e2d.45871","name":"Get session","func":"var request = global.get('request');\nvar Moment = global.get('moment');var MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar crypto = global.get('crypto');\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\n\n   delete msg.sessionNew\n   \nfindOneObj = {\n                    query : {\n                            query :{\n                                        _id:new ObjectID(msg.RevotioData.session._id)\n                            } \n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'sessions',\n                    operation:'find',\n                    }\n\n            mongodbTools.resolveAsync(findOneObj, node, function(res){\n                if (res.length > 0){\n                    msg.sessionNew = res[0]\n                } else {\n                    msg.sessionNew = {}\n                }\n                    \n                    if (    msg.sessionNew.hasOwnProperty(\"Gadgets\") &&\n                            msg.sessionNew.Gadgets.length ===  msg.session.Gadgets.length \n                    ){\n                        node.send(msg) \n                    }\n            })  ","outputs":1,"noerr":0,"x":470,"y":380,"wires":[["6267a6f2.146138"]]},{"id":"7934527d.c7f0ec","type":"debug","z":"e25f5e2d.45871","name":"1-B","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":530,"y":500,"wires":[]},{"id":"4bcaefa7.bd4c7","type":"debug","z":"e25f5e2d.45871","name":"2-A","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":730,"y":280,"wires":[]},{"id":"9ca782e7.f308b8","type":"debug","z":"e25f5e2d.45871","name":"1-C","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":750,"y":240,"wires":[]},{"id":"260e7564.997072","type":"debug","z":"e25f5e2d.45871","name":"2-B","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":630,"y":440,"wires":[]},{"id":"7e4884c3.ec091c","type":"debug","z":"e25f5e2d.45871","name":"2-C","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":990,"y":440,"wires":[]},{"id":"de21f442.f2c1e","type":"debug","z":"e25f5e2d.45871","name":"2-D","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1110,"y":360,"wires":[]},{"id":"54a1b615.985f98","type":"function","z":"e25f5e2d.45871","name":"get && check response","func":"var request = global.get('request');\nvar Moment = global.get('moment');var MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar crypto = global.get('crypto');\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\n\n\n\n// check if its dev env\n// if (env.get(\"PREFORMANCE_CHECK\") && env.get(\"PREFORMANCE_CHECK\") === true){\n    msg.payload.endtime         = new Date() \n    msg.payload.starttime       = msg.payload.starttime\n    msg.payload.timediff        = moment(msg.payload.endtime).diff(moment(msg.payload.starttime))\n    \n    gadgetsList = lodash.orderBy(msg.payload.gadgetsList, [\"endtime\"], [\"desc\"]);\n    \n    \n    msg.payload.gadgetsList = gadgetsList;\n    msg.payload.included = []\n    _.each(gadgetsList, function(item, index){\n        msg.payload.included.push(item.gadgetName)\n    })\n\n\n\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":930,"y":120,"wires":[["2dee3212.2703a6"]]},{"id":"c54784cc.a6c3a8","type":"inject","z":"a2b40f09.d18fd8","name":"","repeat":"","crontab":"00 00 * * *","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":190,"y":200,"wires":[["e2b8eccb.0397b8"]]},{"id":"e2b8eccb.0397b8","type":"function","z":"a2b40f09.d18fd8","name":"Get all emplyee","func":"// Get libraries\nconst Moment = global.get('moment');\nconst MomentRange = global.get('momentrange');\nconst moment = MomentRange.extendMoment(Moment);\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar fs = global.get('fsextra');\n      \n// distinct\n\n            aggregateObj = {\n                    query : { query : [{\n                                $match: {}\n                              },\n                                 { \n                                        \"$group\" : { \n                                            \"_id\" : \"$_id\"\n                                        }\n                                    }\n                            ],},\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'employee',\n                    operation:'aggregate',\n                    }\n                    \n            mongodbTools.resolveAsync(aggregateObj, node, function(res){\n                     msg.employee_id = [] ; \n                    \n                    _.each(res, function(Item, Index ){\n                         msg.employee_id.push(new ObjectID(Item._id))\n                    })\n                    node.send(msg) \n            }) \n                   \n\n            ","outputs":1,"noerr":0,"x":340,"y":200,"wires":[[]]},{"id":"7d81ff72.bad3e","type":"comment","z":"a2b40f09.d18fd8","name":"Recalc all employee's","info":"","x":140,"y":160,"wires":[]},{"id":"7232508b.9067a","type":"inject","z":"a2b40f09.d18fd8","name":"","repeat":"","crontab":"00 00 * * *","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":170,"y":340,"wires":[["5fceb272.c1085c"]]},{"id":"5fceb272.c1085c","type":"function","z":"a2b40f09.d18fd8","name":"Get all emplyee","func":"// Get libraries\nconst Moment = global.get('moment');\nconst MomentRange = global.get('momentrange');\nconst moment = MomentRange.extendMoment(Moment);\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar fs = global.get('fsextra');\n      \n// distinct\n\n            aggregateObj = {\n                    query : { query : [{\n                                $match: {}\n                              },\n                                 { \n                                        \"$group\" : { \n                                            \"_id\" : \"$_id\"\n                                        }\n                                    }\n                            ],},\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'employee',\n                    operation:'aggregate',\n                    }\n                    \n            mongodbTools.resolveAsync(aggregateObj, node, function(res){\n                     msg.employee_id = [] ; \n                    \n                    _.each(res, function(Item, Index ){\n                         msg.employee_id.push(new ObjectID(Item._id))\n                    })\n                    node.send(msg) \n            }) \n                   \n\n            ","outputs":1,"noerr":0,"x":340,"y":340,"wires":[[]]},{"id":"85bbaefb.c8db08","type":"comment","z":"a2b40f09.d18fd8","name":"Session management","info":"","x":120,"y":300,"wires":[]},{"id":"59fb872e.5902f8","type":"function","z":"508957a1.dd5398","name":"Add session to session_stats","func":"var request = global.get('request');\nvar Moment = global.get('moment');var MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar crypto = global.get('crypto');\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\n// _id management\nObj = msg.current_session;\nObj.session_id = new ObjectID(msg.current_session._id)\nmsg.current_session._id = new ObjectID();\n\n// Add redirect data\n\nObj.destination_page =  msg.responseObj.Page\nObj.redirect_time =  new Date()\n\n// remove current session flowData\n\ndelete Obj.FlowData\nObj.redirect_revotio_data =  msg.responseObj.RevotioData\n\n// update    \n\n    updateObj = {\n                    query : {\n                            query :Obj, \n                            update : { \"$set\" : Obj},\n                            options : {upsert: true}\n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'session_stats',\n                    operation:'update', // updateMany , updateOne\n                    }\n\n            mongodbTools.resolveAsync(updateObj, node, function(res){\n                    // msg.payload = res\n                    // node.send(msg) \n            })  ","outputs":1,"noerr":0,"x":1020,"y":1500,"wires":[[]]},{"id":"af5c8a5f.64c24","type":"function","z":"508957a1.dd5398","name":"Get session","func":"var request = global.get('request');\nvar Moment = global.get('moment');var MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar crypto = global.get('crypto');\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\n// findOne \nfindOneObj = {\n                    query : {\n                            query :{revotioSessionId: msg.responseObj.revotioSessionId, deviceId:msg.responseObj.deviceId} \n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'sessions',\n                    operation:'find',\n                    }\n\n            mongodbTools.resolveAsync(findOneObj, node, function(res){\n                if (res.length > 0){\n                    msg.current_session = res[0]\n                } else {\n                    msg.current_session = {}\n                }\n                    \n                    node.send(msg) \n            })  ","outputs":1,"noerr":0,"x":770,"y":1020,"wires":[["59fb872e.5902f8","1a7afd51.7ed1e3"]]},{"id":"e8e83204.ecdd18","type":"subflow:5e9b9c1d.bbe4a4","z":"19457c3b.7f3ba4","name":"","env":[],"x":420,"y":60,"wires":[]},{"id":"75a214b5.1247dc","type":"function","z":"19457c3b.7f3ba4","name":"Prepair redirect (breadcrumbs)","func":"msg.payload = {\n    Page : msg.RevotioData.PostData.gadgetData.selected.Page,\n    RevotioData : msg.RevotioData.PostData.gadgetData.selected.RevotioData,\n}\nreturn msg;","outputs":1,"noerr":0,"x":190,"y":80,"wires":[["e8e83204.ecdd18"]]},{"id":"9c1da85e.48053","type":"function","z":"508957a1.dd5398","name":"Get all org's applications ","func":"var request = global.get('request');\nvar Moment = global.get('moment');var MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\nvar query = {organization_id : new ObjectID(msg.organization_id)}\nmsg.done = false\n // find  \nfindObj = {\n                    query : {\n                            query :query, \n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'applications',\n                    operation:'find',\n                    }\n\n            mongodbTools.resolveAsync(findObj, node, function(res){\n\n                    _.each(res, function(AppItem,AppItemIndex ){\n                        node.send({application_id :AppItem._id })\n                    })\n                   \n                    msg.done = true\n                    node.send(msg) \n            }) \n","outputs":1,"noerr":0,"x":1510,"y":2060,"wires":[["9548cd04.dd18","b964d4be.164298"]]},{"id":"b964d4be.164298","type":"function","z":"508957a1.dd5398","name":"Send response","func":"// Get libraries\nconst Moment = global.get('moment');\nconst MomentRange = global.get('momentrange');\nconst moment = MomentRange.extendMoment(Moment);\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\n\nif (msg.done === true ){\n    node.send(msg)\n}\n","outputs":1,"noerr":0,"x":1820,"y":2060,"wires":[["2e59826a.d8a256"]]},{"id":"2e59826a.d8a256","type":"http response","z":"508957a1.dd5398","name":"","statusCode":"","headers":{},"x":2130,"y":2060,"wires":[]},{"id":"7af2cd05.9b0044","type":"debug","z":"508957a1.dd5398","name":"Remove page","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":530,"y":2420,"wires":[]},{"id":"1ea0e68c.3991f9","type":"debug","z":"508957a1.dd5398","name":"Remove app","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":550,"y":2160,"wires":[]},{"id":"92f7b82b.753758","type":"debug","z":"508957a1.dd5398","name":"Remove org","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":550,"y":1980,"wires":[]},{"id":"820eb5ef.100fd8","type":"function","z":"73dff3ad.4e7f84","name":"convert IDs","func":"var request = global.get('request');\nvar Moment = global.get('moment');var MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar crypto = global.get('crypto');\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\nif (msg.payload.organizationId){\n    msg.payload.organization_id =new ObjectID(msg.payload.organizationId)\n}\n\nif (msg.payload.applicationId){\n    msg.payload.application_id = new ObjectID(msg.payload.applicationId)\n}\nif (msg.payload.pageId){\n    msg.payload.page_id = new ObjectID(msg.payload.pageId)\n}\nif (msg.payload.itemId){\n    msg.payload.item_id = new ObjectID(msg.payload.itemId)\n}\nif (msg.payload.userId){\n    msg.payload.user_id = new ObjectID(msg.payload.userId)\n}\nreturn msg;","outputs":1,"noerr":0,"x":190,"y":80,"wires":[[]]},{"id":"c456991.34d5368","type":"function","z":"5c6b8786.2f63d","name":"Init org level","func":"var request = global.get('request');\nvar Moment = global.get('moment');var MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar crypto = global.get('crypto');\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\n// makesure FlowData.Data exists\n\nif (!msg.RevotioData.FlowData ){\n    msg.RevotioData.FlowData  = {}\n}\n\nif (!msg.RevotioData.FlowData.Data ){\n    msg.RevotioData.FlowData.Data  = {}\n}\n\n\n findOneObj = {\n                    query : {\n                            query :{_id:new ObjectID(msg.RevotioData.FlowData.organization_id)} \n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'organizations',\n                    operation:'find',\n                    }\n\n            mongodbTools.resolveAsync(findOneObj, node, function(res){\n               if (res.length > 0){\n                    msg.RevotioData.FlowData.Data.OrganizationData = res[0]\n                } else {\n                    msg.RevotioData.FlowData.Data.OrganizationData  = {}\n                }\n                    \n                    node.send(msg) \n            })  ","outputs":1,"noerr":0,"x":190,"y":80,"wires":[[]]},{"id":"12877cee.3216e3","type":"subflow:5c6b8786.2f63d","z":"2294209a.0c95b","name":"","env":[],"x":1070,"y":620,"wires":[["aea25a8a.fa4a58"]]},{"id":"91d23ba1.ffd018","type":"debug","z":"e25f5e2d.45871","name":"IN Gen. Response","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":170,"y":180,"wires":[]},{"id":"d9a31cb4.de7588","type":"debug","z":"508957a1.dd5398","name":"ACTION post A","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":700,"y":680,"wires":[]},{"id":"e4b702f8.2026a","type":"function","z":"8db3b81a.693fd","name":"Route BreadCrumb action","func":"var redirect, newEntity , formAction;\nif (msg.RevotioData.PostData.gadgetData.type &&\n    msg.RevotioData.PostData.gadgetData.type === \"button\" &&\n    msg.RevotioData.PostData.gadgetData.selected){\n    \n     msg.RevotioData.FlowData.Form = msg.RevotioData.PostData.gadgetData.selected;\n    \n  formAction = msg;  \n}\nelse if (msg.RevotioData.PostData.gadgetData.selected){\n     msg.payload = {\n        Page : msg.RevotioData.PostData.gadgetData.selected.Page,\n        RevotioData : {\n            organization_id : msg.RevotioData.PostData.gadgetData.selected.organization_id,\n            page_id : msg.RevotioData.PostData.gadgetData.selected.page_id,\n            application_id : msg.RevotioData.PostData.gadgetData.selected.application_id,\n            item_id : msg.RevotioData.PostData.gadgetData.selected.item_id,\n        }\n    }\n    \n    redirect= msg\n} else if (msg.RevotioData.PostData.gadgetData.Page) {\n    \n     msg.payload = {\n        Page : msg.RevotioData.PostData.gadgetData.Page,\n        RevotioData : {\n            organization_id : msg.RevotioData.PostData.gadgetData.data[0].organization_id,\n            page_id : msg.RevotioData.PostData.gadgetData.data[0].page_id,\n            application_id : msg.RevotioData.PostData.gadgetData.data[0].application_id,\n            item_id : msg.RevotioData.PostData.gadgetData.data[0].item_id,\n            // employee_id : msg.RevotioData.PostData.gadgetData.data[0].employee_id,\n        }\n    }\n    \n    \n   redirect= msg\n} else {\n     newEntity = msg;\n}\n\n\nreturn [redirect, newEntity, formAction];","outputs":3,"noerr":0,"x":200,"y":80,"wires":[[],["f2f17cd0.7f59a8"],[]],"outputLabels":["redirect","newEntity","formAction"]},{"id":"f2f17cd0.7f59a8","type":"function","z":"8db3b81a.693fd","name":"Prepair form","func":"// Get libraries\nconst Moment = global.get('moment');\nconst MomentRange = global.get('momentrange');\nconst moment = MomentRange.extendMoment(Moment);\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting'); \nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\n\n\nmsg.RevotioData.FlowData.Form = {\n        FormType  :  msg.RevotioData.PostData.gadgetData.FormType,\n        FormActionType: \"Create\"\n    }\n    \n    if (msg.RevotioData.PostData.gadgetData.organization_id){\n       msg.RevotioData.FlowData.Form.organization_id = new ObjectID(msg.RevotioData.PostData.gadgetData.organization_id)\n    }else if (msg.RevotioData.FlowData.organization_id){\n       msg.RevotioData.FlowData.Form.organization_id = new ObjectID(msg.RevotioData.FlowData.organization_id)\n    }\n    \n    if (msg.RevotioData.PostData.gadgetData.project_id){\n       msg.RevotioData.FlowData.Form.project_id = new ObjectID(msg.RevotioData.PostData.gadgetData.project_id)\n    }else if (msg.RevotioData.FlowData.project_id){\n       msg.RevotioData.FlowData.Form.project_id = new ObjectID(msg.RevotioData.FlowData.project_id)\n    }    \n    \n    if (msg.RevotioData.PostData.gadgetData.work_package_id){\n       msg.RevotioData.FlowData.Form.work_package_id = new ObjectID(msg.RevotioData.PostData.gadgetData.work_package_id)\n    }else if (msg.RevotioData.FlowData.work_package_id){\n       msg.RevotioData.FlowData.Form.work_package_id = new ObjectID(msg.RevotioData.FlowData.work_package_id)\n    }  \n    \n    if (msg.RevotioData.PostData.gadgetData.participant_id){\n       msg.RevotioData.FlowData.Form.participant_id = new ObjectID(msg.RevotioData.PostData.gadgetData.participant_id)\n    }else if (msg.RevotioData.FlowData.participant_id){\n       msg.RevotioData.FlowData.Form.participant_id = new ObjectID(msg.RevotioData.FlowData.participant_id)\n    } \n    \n    \n    // organization_id : \n    //      : new ObjectID(msg.RevotioData.FlowData.project_id),\n    //      : new ObjectID(msg.RevotioData.FlowData.work_package_id),\n    //      : new ObjectID(msg.RevotioData.FlowData.participant_id),\n     \n\n\n// if (msg.RevotioData.session.Page === \"project overview\"){\n//     msg.RevotioData.FlowData.Form = {\n//         organization_id : new ObjectID(msg.RevotioData.FlowData.organization_id),\n//         project_id : new ObjectID(msg.RevotioData.FlowData.project_id),\n//         FormType  :  \"WorkPackage\",\n//         FormActionType: \"Create\"\n//     }\n// } else if (msg.RevotioData.session.Page === \"organization overview\"){\n//     msg.RevotioData.FlowData.Form = {\n//         organization_id : new ObjectID(msg.RevotioData.FlowData.organization_id),\n//         FormType  :  \"Project\",\n//         FormActionType: \"Create\"\n//     }\n// } else if (msg.RevotioData.session.Page === \"organization global\"){\n//     msg.RevotioData.FlowData.Form = {\n//         FormType  :  \"Organization\",\n//         FormActionType: \"Create\"\n//     }\n// } else if (msg.RevotioData.session.Page === \"work package overview\"){\n//     msg.RevotioData.FlowData.Form = {\n//         FormType  :  \"Organization\",\n//         FormActionType: \"Create\"\n//     }\n// }\n\nreturn msg;","outputs":1,"noerr":0,"x":510,"y":80,"wires":[[]]},{"id":"860d2caf.36873","type":"subflow:8db3b81a.693fd","z":"e5822137.be45d","name":"BreadCrumbsAction","env":[],"x":3680,"y":440,"wires":[["6e95417b.0deff"],["bcb372ba.8288e8"]]},{"id":"6bfbfd2b.204aec","type":"subflow:5e9b9c1d.bbe4a4","z":"2294209a.0c95b","name":"","env":[],"x":3220,"y":640,"wires":[]},{"id":"42bc1f60.995e2","type":"subflow:3170c4ab.fadb9c","z":"2294209a.0c95b","name":"","x":3220,"y":680,"wires":[["6f9cee85.74eff8"]]},{"id":"6f9cee85.74eff8","type":"link out","z":"2294209a.0c95b","name":"Topbar  frontend post","links":["23272508.4d696a","2475f18f.18f84e","f85b9845.a955d","8b4ff2ec.3247b","bfe4a65b.e868c","68a613e1.7d23cc","a8407940.280928","cd2e935f.5b6348","c6ab18b6.cf792","915fe08d.d804b","839882ba.4c8cf8","4248f1d.8cffc1","fa74879d.d6538","dfb2e790.ced988","5152dc4f.eabc94","271f0775.5ac628","7b149429.0d56fc","7a011268.2223d4","26dc0660.b1e4ba","59afb9fb.3ba0c8","9c32caf9.c7e008","8be6a719.2a64e","a6ee6331.070228","6a41100.61cc07","c76409e8.f61b3"],"x":3295,"y":680,"wires":[]},{"id":"de0a486c.213f5","type":"subflow:8db3b81a.693fd","z":"2294209a.0c95b","name":"BreadCrumbsAction","env":[],"x":3020,"y":660,"wires":[["6bfbfd2b.204aec"],["42bc1f60.995e2"]]},{"id":"b5530b8c.66e958","type":"debug","z":"508957a1.dd5398","name":"EXIT post post","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":260,"y":1240,"wires":[]},{"id":"728e249.bd3ca5c","type":"json","z":"508957a1.dd5398","name":"","property":"payload","action":"","pretty":false,"x":210,"y":1300,"wires":[["920da7ee.18772","b5530b8c.66e958"]]},{"id":"9c6fb265.83a68","type":"inject","z":"a2b40f09.d18fd8","name":"","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":620,"y":500,"wires":[["894b9def.6e6e08"]]},{"id":"894b9def.6e6e08","type":"function","z":"a2b40f09.d18fd8","name":"get pages","func":"var request = global.get('request');\nvar Moment = global.get('moment');var MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar crypto = global.get('crypto');\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\n// findMany\n\nfindManyObj = {\n                    query : {\n                            query :{application_id: new ObjectID(\"5f22ab9e5c29cbe8cc52540c\")},\n                            // query :{application_id: \"test styles\"},\n                           \n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'pages',\n                    operation:'find',\n                    }\n\n            mongodbTools.resolveAsync(findManyObj, node, function(res){\n                \n                \n                    msg.payload = res\n                    node.send(msg) \n            }) \n\n// return msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":740,"y":500,"wires":[["2740f15f.cbea9e","93a104c5.6d253"]]},{"id":"7445b821.81b84","type":"debug","z":"a2b40f09.d18fd8","name":"B","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":890,"y":460,"wires":[]},{"id":"2740f15f.cbea9e","type":"function","z":"a2b40f09.d18fd8","name":"CLEAR styles","func":"var request = global.get('request');\nvar Moment = global.get('moment');var MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar crypto = global.get('crypto');\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\nstylesUpdate = function(array) {\n\n   _.each(array, function(arrayItem, arrayIndex){\n       if (arrayItem.hasOwnProperty(\"styles\") &&\n       typeof arrayItem.styles === 'object'\n       ){\n           array[arrayIndex].styles_old = arrayItem.styles\n           oldWidth = array[arrayIndex].styles.width\n           delete  array[arrayIndex].styles\n           array[arrayIndex].styles = {\n               width : oldWidth\n           }\n       }\n       \n       if ( arrayItem.hasOwnProperty(\"columns\") &&\n            Array.isArray(arrayItem.columns)  &&\n            arrayItem.columns.length >  0)\n            {\n               array[arrayIndex].columns =   stylesUpdate( array[arrayIndex].columns)\n            }\n        \n        if ( arrayItem.hasOwnProperty(\"container\") &&\n            Array.isArray(arrayItem.container)  &&\n            arrayItem.container.length >  0)\n            {\n               array[arrayIndex].container =   stylesUpdate( array[arrayIndex].container)\n            }\n        if ( arrayItem.hasOwnProperty(\"content\") &&\n            Array.isArray(arrayItem.content)  &&\n            arrayItem.content.length >  0)\n            {\n               array[arrayIndex].content =   stylesUpdate( array[arrayIndex].content)\n            }\n        if ( arrayItem.hasOwnProperty(\"content\") &&\n            typeof arrayItem.content === \"object\"  &&\n            arrayItem.content.hasOwnProperty(\"container\") &&\n            Array.isArray(arrayItem.content.container)  &&\n            arrayItem.content.container.length >  0\n            )\n            {\n               array[arrayIndex].content.container =   stylesUpdate( array[arrayIndex].content.container)\n            }\n            \n            if ( arrayItem.hasOwnProperty(\"customContent\") &&\n            Array.isArray(arrayItem.customContent)  &&\n            arrayItem.customContent.length >  0)\n            {\n               array[arrayIndex].customContent =   stylesUpdate( array[arrayIndex].customContent)\n            }\n            \n             if ( arrayItem.hasOwnProperty(\"screenProfiles\") &&\n            typeof arrayItem.screenProfiles === \"object\" ){\n                _.each(Object.keys(arrayItem.screenProfiles), function(key, index){\n                    if (arrayItem.screenProfiles[key].hasOwnProperty(\"content\") &&\n                        arrayItem.screenProfiles[key].content.hasOwnProperty(\"container\") &&\n                        Array.isArray(arrayItem.screenProfiles[key].content.container)  &&\n                        arrayItem.screenProfiles[key].content.container.length >  0 )\n                        {\n                           array[arrayIndex].screenProfiles[key].content.container =   stylesUpdate( array[arrayIndex].screenProfiles[key].content.container)\n                        }\n                })\n                \n            }  \n   })\n   \n   \n   \n   return array\n};\n\nmsg.oldPayload = msg.payload\n\nmsg.payload = stylesUpdate(msg.oldPayload)\n\n\n\nreturn msg\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":880,"y":500,"wires":[["7445b821.81b84","d006d01c.64c73"]]},{"id":"93a104c5.6d253","type":"debug","z":"a2b40f09.d18fd8","name":"A","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":710,"y":460,"wires":[]},{"id":"d786c21a.7337e","type":"function","z":"a2b40f09.d18fd8","name":"Update page","func":"var request = global.get('request');\nvar Moment = global.get('moment');var MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar crypto = global.get('crypto');\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\n\n    // updateObj = {\n    //                 query : {\n    //                         query :{name:\"Guam\"}, \n    //                         update : { \"$set\" : {newName : new Date()}},\n    //                         options : {upsert: true}\n    //                         },\n    //                 connection:global.get(\"DB_data.connection\"),\n    //                 database:global.get(\"DB_data.appDB\"),\n    //                 collection:'countries',\n    //                 operation:'update', // updateMany , updateOne\n    //                 }\n\n    //         mongodbTools.resolveAsync(updateObj, node, function(res){\n    //                 msg.payload = res\n    //                 node.send(msg) \n    //         }) \n            \nif (msg.payload.hasOwnProperty(\"content\") && \n    msg.payload.hasOwnProperty(\"_id\")\n    ){\n// update    \n\n    updateObj = {\n                    query : {\n                            query :{_id:new ObjectID(msg.payload._id)}, \n                            update : {\"$set\":{content: msg.payload.content}}, \n                            options :{upsert:true}\n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'pages',\n                    operation:'update', // updateMany , updateOne\n                    }\n            \n            mongodbTools.resolveAsync(updateObj, node, function(res){\n                    // msg.payload = res\n                    node.send(msg) \n            })  \n            \n} else {\n    return msg\n}\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1110,"y":460,"wires":[["d006d01c.64c73"]]},{"id":"d006d01c.64c73","type":"function","z":"a2b40f09.d18fd8","name":"Loop through page records ","func":"//Node has 2 outputs - 1 for itteration and 1 for completion\nvar nextObj, out;\nvar itt = msg.iterationInfo;\n\n\n//If the iterating has not yet begun set up the iteration metadata in the msg\nif (typeof itt === 'undefined') {\n    //Make sure payload is an array\n    if( Object.prototype.toString.call(msg.payload) !== '[object Array]' ) {\n       msg.payload = [msg.payload];\n    }\n\n    msg.iterationInfo = itt = {};\n    itt.index = -1;\n    itt.inArray = msg.payload;\n    itt.outArray = [];\n\n//Otherwise just push the input to the output array\n} else {\n    itt.outArray.push(msg.payload)\n}\n\n//Goto next object\nitt.index ++;\n\n//If there are stil objects left to iterate goto the next one in the original array\nif (itt.index < itt.inArray.length) {\n    nextObj = msg;\n    msg.payload = itt.inArray[itt.index];\n\n//otherwise pass the out array as the payload\n} else {\n    out = msg;\n    msg.payload = itt.outArray;\n    delete msg.iterationInfo;\n}\n\nreturn [nextObj, out];","outputs":"2","noerr":0,"x":1120,"y":500,"wires":[["d786c21a.7337e"],["45e2cc70.b316ec","da1a8b28.ae983"]]},{"id":"45e2cc70.b316ec","type":"debug","z":"a2b40f09.d18fd8","name":"C","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1470,"y":580,"wires":[]},{"id":"2bca907.ccc3ff","type":"function","z":"a2b40f09.d18fd8","name":"Update old_page","func":"var request = global.get('request');\nvar Moment = global.get('moment');var MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar crypto = global.get('crypto');\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\n\n    // updateObj = {\n    //                 query : {\n    //                         query :{name:\"Guam\"}, \n    //                         update : { \"$set\" : {newName : new Date()}},\n    //                         options : {upsert: true}\n    //                         },\n    //                 connection:global.get(\"DB_data.connection\"),\n    //                 database:global.get(\"DB_data.appDB\"),\n    //                 collection:'countries',\n    //                 operation:'update', // updateMany , updateOne\n    //                 }\n\n    //         mongodbTools.resolveAsync(updateObj, node, function(res){\n    //                 msg.payload = res\n    //                 node.send(msg) \n    //         }) \n            \nif (msg.payload.hasOwnProperty(\"content\") && \n    msg.payload.hasOwnProperty(\"_id\")\n    ){\n// update    \n\n    updateObj = {\n                    query : {\n                            query :{_id:new ObjectID(msg.payload._id)}, \n                            update : {\"$set\": msg.payload}, \n                            options :{upsert:true}\n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'pages_old',\n                    operation:'update', // updateMany , updateOne\n                    }\n            \n            mongodbTools.resolveAsync(updateObj, node, function(res){\n                    // msg.payload = res\n                    node.send(msg) \n            })  \n            \n} else {\n    return msg\n}\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1630,"y":460,"wires":[["16fc021f.6e6ae6"]]},{"id":"16fc021f.6e6ae6","type":"function","z":"a2b40f09.d18fd8","name":"Loop through page records ","func":"//Node has 2 outputs - 1 for itteration and 1 for completion\nvar nextObj, out;\nvar itt = msg.iterationInfo;\n\n\n//If the iterating has not yet begun set up the iteration metadata in the msg\nif (typeof itt === 'undefined') {\n    //Make sure payload is an array\n    if( Object.prototype.toString.call(msg.payload) !== '[object Array]' ) {\n       msg.payload = [msg.payload];\n    }\n\n    msg.iterationInfo = itt = {};\n    itt.index = -1;\n    itt.inArray = msg.payload;\n    itt.outArray = [];\n\n//Otherwise just push the input to the output array\n} else {\n    itt.outArray.push(msg.payload)\n}\n\n//Goto next object\nitt.index ++;\n\n//If there are stil objects left to iterate goto the next one in the original array\nif (itt.index < itt.inArray.length) {\n    nextObj = msg;\n    msg.payload = itt.inArray[itt.index];\n\n//otherwise pass the out array as the payload\n} else {\n    out = msg;\n    msg.payload = itt.outArray;\n    delete msg.iterationInfo;\n}\n\nreturn [nextObj, out];","outputs":"2","noerr":0,"x":1640,"y":500,"wires":[["2bca907.ccc3ff"],["bd6c6da6.ff5d58"]]},{"id":"da1a8b28.ae983","type":"function","z":"a2b40f09.d18fd8","name":"Set oldPayload to msg.payload","func":"msg.payload = msg.oldPayload\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1390,"y":500,"wires":[["16fc021f.6e6ae6"]]},{"id":"bd6c6da6.ff5d58","type":"debug","z":"a2b40f09.d18fd8","name":"DONE CRON","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1910,"y":440,"wires":[]},{"id":"daa9a8e9.835f08","type":"inject","z":"a2b40f09.d18fd8","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":680,"y":680,"wires":[["eb57492b.32a1f8"]]},{"id":"eb57492b.32a1f8","type":"function","z":"a2b40f09.d18fd8","name":"get pages ","func":"var request = global.get('request');\nvar Moment = global.get('moment');\nvar MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar crypto = global.get('crypto');\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\nfindManyObj = {\n                    query : {\n                            query :{application_id: new ObjectID(\"5f22ab9e5c29cbe8cc52540c\")}, \n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'pages',\n                    operation:'find',\n                    }\n\n            mongodbTools.resolveAsync(findManyObj, node, function(res){\n                \n                \n                    msg.payload = res\n                    node.send(msg) \n            }) \n// return msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":870,"y":680,"wires":[["44b48788.999c48"]]},{"id":"c9ea9e0e.2daa3","type":"function","z":"a2b40f09.d18fd8","name":"Update page","func":"var request = global.get('request');\nvar Moment = global.get('moment');var MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar crypto = global.get('crypto');\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\n\n// check if gouped object key exists\n    var key = \"aa41fd57-1b4d-22d6-3065-a7023676903a\"\n    var newKey = \"8e6ecdb0-ca21-8847-0de3-ae9352d8bd2a\"\n    if (msg.payload.hasOwnPropery(\"groupedObject\") && \n        msg.payload.groupedObject.hasOwnProperty(key)\n            ){\n                msg.payload.groupedObject[newKey] = msg.payload.groupedObject[key]\n                  updateObj = {\n                        query : {\n                                query :{_id:new ObjectID(msg.payload._id)}, \n                                update : {\"$set\":{groupedObject: msg.payload.groupedObject}}, \n                                options :{upsert:true}\n                                },\n                        connection:global.get(\"DB_data.connection\"),\n                        database:global.get(\"DB_data.appDB\"),\n                        collection:'pages',\n                        operation:'update', // updateMany , updateOne\n                        }\n                \n                mongodbTools.resolveAsync(updateObj, node, function(res){\n                        // msg.payload = res\n                        node.send(msg) \n                })  \n            } else {\n         node.send(msg) \n    }\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1150,"y":660,"wires":[["44b48788.999c48"]]},{"id":"44b48788.999c48","type":"function","z":"a2b40f09.d18fd8","name":"Loop through page records ","func":"//Node has 2 outputs - 1 for itteration and 1 for completion\nvar nextObj, out;\nvar itt = msg.iterationInfo;\n\n\n//If the iterating has not yet begun set up the iteration metadata in the msg\nif (typeof itt === 'undefined') {\n    //Make sure payload is an array\n    if( Object.prototype.toString.call(msg.payload) !== '[object Array]' ) {\n       msg.payload = [msg.payload];\n    }\n\n    msg.iterationInfo = itt = {};\n    itt.index = -1;\n    itt.inArray = msg.payload;\n    itt.outArray = [];\n\n//Otherwise just push the input to the output array\n} else {\n    itt.outArray.push(msg.payload)\n}\n\n//Goto next object\nitt.index ++;\n\n//If there are stil objects left to iterate goto the next one in the original array\nif (itt.index < itt.inArray.length) {\n    nextObj = msg;\n    msg.payload = itt.inArray[itt.index];\n\n//otherwise pass the out array as the payload\n} else {\n    out = msg;\n    msg.payload = itt.outArray;\n    delete msg.iterationInfo;\n}\n\nreturn [nextObj, out];","outputs":"2","noerr":0,"x":1160,"y":700,"wires":[["c9ea9e0e.2daa3"],["51132278.37cdec"]]},{"id":"51132278.37cdec","type":"debug","z":"a2b40f09.d18fd8","name":"C DONE","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1420,"y":760,"wires":[]},{"id":"3eaaac4f.be9de4","type":"function","z":"53926ffd.c5a74","name":"Validate","func":"var request = global.get('request');\nvar Moment = global.get('moment');\nvar MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar crypto = global.get('crypto');\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n        \ntokenState = \"invalid\"\nTokenContent = {};\n// verify a token symmetric\n    jsonwebtoken.verify(msg.token, global.get(\"SystemVars.secret\"), function(err, decoded) {\n      if (decoded !== undefined){\n          \n          TokenContent = decoded\n      }\n    });\n    \n    if (TokenContent.hasOwnProperty(\"key\")){\n       tokenState = \"valid\" \n    }\n    \n    msg.tokenResult = {\n        \n        token : msg.token  ,\n        tokenState : tokenState,\n        key: TokenContent.key, \n        TokenContent:TokenContent\n    }\n    return msg;\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":200,"y":80,"wires":[[]]},{"id":"41552a5.922cdd4","type":"function","z":"508957a1.dd5398","name":"Generate","func":"var request = global.get('request');\nvar Moment = global.get('moment');\nvar MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar crypto = global.get('crypto');\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\n            msg.PostPayload.content.type = \"unauthorized\"\n            msg.PostPayload.content.key  = new ObjectID()\n            \n            payload = {type : msg.PostPayload.type, token : jsonwebtoken.sign(msg.PostPayload.content, global.get(\"SystemVars.secret\"))};\n            \n            msg.PostPayload.content.token = payload.token\n            \n            msg.payload = payload\n            \n            // update     \n            \n            msg.payload.key =  msg.PostPayload.content.key\n           \nreturn msg;\n    // updateObj = {\n    //                 query : {\n    //                         query :{\n    //                                 revotioSessionId:msg.PostPayload.content.revotioSessionId, \n    //                                 deviceId : msg.PostPayload.content.deviceId\n    //                         }, \n    //                         update : { \"$set\" : msg.PostPayload.content},\n    //                         options : {upsert: true}\n    //                         },\n    //                 connection:global.get(\"DB_data.connection\"),\n    //                 database:global.get(\"DB_data.appDB\"),\n    //                 collection:'sessions',\n    //                 operation:'update', // updateMany , updateOne\n    //                 }\n\n    //         mongodbTools.resolveAsync(updateObj, node, function(res){\n    //               findOneObj = {\n    //                             query : {\n    //                                     query :{revotioSessionId:msg.PostPayload.content.revotioSessionId, \n    //                                             deviceId : msg.PostPayload.content.deviceId} \n    //                                     },\n    //                             connection:global.get(\"DB_data.connection\"),\n    //                             database:global.get(\"DB_data.appDB\"),\n    //                             collection:'sessions',\n    //                             operation:'find',\n    //                             }\n            \n    //                     mongodbTools.resolveAsync(findOneObj, node, function(res){\n    //                         if (res.length > 0){\n    //                             msg.payload.key = res[0]._id\n    //                         } \n                                \n    //                             node.send(msg) \n    //                     })  \n    //         })  \n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":460,"y":1080,"wires":[["ed8a39bb.178cb8","de8d58b0.db8028"]]},{"id":"8cd256fa.8b7098","type":"http response","z":"508957a1.dd5398","name":"","statusCode":"","headers":{},"x":990,"y":1140,"wires":[]},{"id":"ed8a39bb.178cb8","type":"debug","z":"508957a1.dd5398","name":"TOKEN post GENERATE","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":670,"y":1040,"wires":[]},{"id":"de8d58b0.db8028","type":"function","z":"508957a1.dd5398","name":"Get /Set key","func":"var request = global.get('request');\nvar Moment = global.get('moment');\nvar MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar crypto = global.get('crypto');\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\n\n\nreturn msg;\n// Get key\n\n// if ( typeof msg.payload.TokenContent === \"object\" && \n//     msg.payload.TokenContent.deviceId   && \n//     msg.payload.TokenContent.revotioSessionId\n//     ){\n    \n    \n    \n\n//     findOneObj = {\n//                         query : {\n//                                 query :{\n//                                     revotioSessionId:msg.payload.TokenContent.revotioSessionId,\n//                                     deviceId:msg.payload.TokenContent.deviceId\n//                                 } \n//                                 },\n//                         connection:global.get(\"DB_data.connection\"),\n//                         database:global.get(\"DB_data.appDB\"),\n//                         collection:'sessions',\n//                         operation:'find',\n//                         }\n    \n//                 mongodbTools.resolveAsync(findOneObj, node, function(res){\n//                     if (res.length > 0){\n//                         msg.payload.key = res[0]._id\n//                     } \n    \n//                         node.send(msg) \n//                 })  \n\n// } else {\n//     node.send(msg)\n// }\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":750,"y":1140,"wires":[["8cd256fa.8b7098","4ce2ca4d.4241f4"]]},{"id":"4ce2ca4d.4241f4","type":"debug","z":"508957a1.dd5398","name":"TOKEN post 11","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":860,"y":1080,"wires":[]},{"id":"996a3cfa.05bf8","type":"function","z":"508957a1.dd5398","name":"Token API","func":"var BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\n\nvar jsonwebtoken = global.get('jsonwebtoken');\n\nvar generate, validate, key, error;\n\nif (typeof msg.payload === 'string'){\n    payload = JSON.parse(msg.payload)\n    msg.payload = payload;\n} \nif (typeof msg.payload === 'string'){\n    payload = JSON.parse(msg.payload)\n    msg.payload = payload;\n} \nif (typeof msg.payload.content === 'string'){\n    var content = JSON.parse(msg.payload.content)\n    msg.payload.content = content;\n} \n\nmsg.PostPayload  = msg.payload;\n\nmsg.token = msg.PostPayload.token\n\nmsg.headers = {\n    'Access-Control-Allow-Origin': '*',\n    'Access-Control-Allow-Methods': 'PUT,GET,POST,DELETE,OPTIONS',\n    'Access-Control-Allow-Headers': 'Content-Type',\n    'content-type': 'application/json',\n};\n\n        if (msg.PostPayload.type === \"generate\"  && msg.PostPayload.content && msg.PostPayload.content.deviceId){\n\n            generate = msg;\n        } else if (msg.PostPayload.type === \"validate\" &&  msg.PostPayload.token){\n            validate = msg;\n            \n        } else if (msg.PostPayload.type === \"key\" &&  msg.PostPayload.token ){\n            key = msg;\n            \n        } else {\n          error = msg\n        }\n\nreturn [generate, validate, key, error];","outputs":4,"noerr":0,"initialize":"","finalize":"","x":240,"y":1140,"wires":[["41552a5.922cdd4"],["f8b44c33.0e10e8"],["226f35a1.a26af2"],["1d43c493.374b03"]],"outputLabels":["generate","validate","key","error"]},{"id":"379f923d.b717b6","type":"function","z":"508957a1.dd5398","name":"KEY","func":"var request = global.get('request');\nvar Moment = global.get('moment');\nvar MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar crypto = global.get('crypto');\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\ntokenState = \"invalid\"\nTokenContent = {};\n// verify a token symmetric\n    jsonwebtoken.verify(msg.PostPayload.token, global.get(\"SystemVars.secret\"), function(err, decoded) {\n      if (decoded !== undefined){\n          tokenState = \"valid\"\n          TokenContent = decoded\n      }\n    });\n    \n    payload = { type:msg.PostPayload.type, token : msg.PostPayload.token  , tokenState : tokenState,key: TokenContent.key }; //, TokenContent:TokenContent\n    \n    msg.payload = payload ;\n    return msg;\n    // findOneObj = {\n    //                             query : {\n    //                                     query :{revotioSessionId:msg.PostPayload.content.revotioSessionId, \n    //                                             deviceId : msg.PostPayload.content.deviceId} \n    //                                     },\n    //                             connection:global.get(\"DB_data.connection\"),\n    //                             database:global.get(\"DB_data.appDB\"),\n    //                             collection:'sessions',\n    //                             operation:'find',\n    //                             }\n            \n    //                     mongodbTools.resolveAsync(findOneObj, node, function(res){\n    //                         if (res.length > 0){\n    //                             msg.payload.key = res[0]._id\n    //                         } \n                        //   node.send(msg)  \n                        // })\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":570,"y":1160,"wires":[["de8d58b0.db8028","362e9b63.4d47e4"]]},{"id":"1d43c493.374b03","type":"function","z":"508957a1.dd5398","name":"error","func":"var request = global.get('request');\nvar Moment = global.get('moment');\nvar MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar crypto = global.get('crypto');\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\nmsg.payload = \"invalid post request - type\";\n\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":530,"y":1200,"wires":[["8cd256fa.8b7098"]]},{"id":"981105c.76618f8","type":"debug","z":"508957a1.dd5398","name":"TOKEN post Validate","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":660,"y":1080,"wires":[]},{"id":"362e9b63.4d47e4","type":"debug","z":"508957a1.dd5398","name":"TOKEN post KEY","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":750,"y":1180,"wires":[]},{"id":"f8b44c33.0e10e8","type":"subflow:53926ffd.c5a74","z":"508957a1.dd5398","name":"","env":[],"x":400,"y":1120,"wires":[["981105c.76618f8","14c396a8.50ea69"]]},{"id":"14c396a8.50ea69","type":"function","z":"508957a1.dd5398","name":"Validate","func":"var request = global.get('request');\nvar Moment = global.get('moment');\nvar MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar crypto = global.get('crypto');\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n    \n    msg.payload = { type:msg.PostPayload.type, token : msg.tokenResult.token  , tokenState : msg.tokenResult.tokenState,key: msg.tokenResult.key }; // TokenContent:TokenContent\n    \n   \n    return msg;\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":560,"y":1120,"wires":[["de8d58b0.db8028"]]},{"id":"226f35a1.a26af2","type":"subflow:53926ffd.c5a74","z":"508957a1.dd5398","name":"","env":[],"x":400,"y":1160,"wires":[["379f923d.b717b6"]]},{"id":"7eafc839.978f28","type":"http response","z":"508957a1.dd5398","name":"","statusCode":"","headers":{},"x":450,"y":1040,"wires":[]},{"id":"f17c765e.408ab8","type":"function","z":"508957a1.dd5398","name":"Token API","func":"var BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\n\nvar jsonwebtoken = global.get('jsonwebtoken');\n\n\n\nif (typeof msg.payload === 'string'){\n    var payload = JSON.parse(msg.payload)\n    msg.payload = payload;\n} \nif (typeof msg.payload === 'string'){\n    payload = JSON.parse(msg.payload)\n    msg.payload = payload;\n} \nif (typeof msg.payload.content === 'string'){\n    var content = JSON.parse(msg.payload.content)\n    msg.payload.content = content;\n} \n\nPostPayload = msg.payload;\n\n        if (PostPayload.type === \"generate\"  && PostPayload.content && PostPayload.content.deviceId){\n          \n            PostPayload.content.type = \"unauthorized\"\n            payload = {token : jsonwebtoken.sign(PostPayload.content, global.get(\"SystemVars.secret\"))};\n            \n            msg.payload = payload\n        } else if (PostPayload.type === \"validate\" &&  PostPayload.token){\n        \n            tokenState = \"invalid\"\n            TokenContent = {};\n            // verify a token symmetric\n                jsonwebtoken.verify(PostPayload.token, global.get(\"SystemVars.secret\"), function(err, decoded) {\n                  if (decoded !== undefined){\n                      tokenState = \"valid\"\n                      TokenContent = decoded\n                  }\n                });\n                \n                payload = { token : PostPayload.token  , tokenState : tokenState, TokenContent:TokenContent };\n                \n                msg.payload = payload ;\n        } else {\n            msg.payload = \"invalid post request - type\";\n        }\n\n\nmsg.headers = {\n    'Access-Control-Allow-Origin': '*',\n    'Access-Control-Allow-Methods': 'PUT,GET,POST,DELETE,OPTIONS',\n    'Access-Control-Allow-Headers': 'Content-Type',\n    'content-type': 'application/json',\n};\n\n   msg.PostPayload = PostPayload \n    \n\n\nreturn msg;","outputs":1,"noerr":0,"x":320,"y":1040,"wires":[["7eafc839.978f28"]]},{"id":"f6b3771f.d41548","type":"function","z":"508957a1.dd5398","name":"Set msg.token","func":"\nmsg.token = msg.payload.token\n\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":620,"y":200,"wires":[["64e3cabd.69b9a4"]]},{"id":"c56320d9.082008","type":"function","z":"508957a1.dd5398","name":"Decrypt","func":"var request = global.get('request');\nvar Moment = global.get('moment');\nvar MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar crypto = global.get('crypto');\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n        \ndataState = \"invalid\"\ndataContent = {};\n// verify a token symmetric\n    jsonwebtoken.verify(msg.payload.data, msg.tokenResult.key, function(err, decoded) {\n      if (decoded !== undefined){\n          dataState = \"valid\"\n          dataContent = decoded\n      }\n    });\n    \n    msg.dataResult = {\n        \n        data : msg.payload.data  ,\n        dataState : dataState,\n        key: msg.tokenResult.key, \n        dataContent:dataContent\n    }\n    return msg;\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":980,"y":200,"wires":[["bbdc3383.cf54c8","eed30f49.b6e39"]]},{"id":"64e3cabd.69b9a4","type":"subflow:53926ffd.c5a74","z":"508957a1.dd5398","name":"","env":[],"x":800,"y":200,"wires":[["c56320d9.082008"]]},{"id":"13c4294b.23613f","type":"function","z":"508957a1.dd5398","name":"Set msg.token","func":"\nmsg.token = msg.payload.token\n\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":320,"y":520,"wires":[["e9fecf9f.d34c5"]]},{"id":"de8fb949.f20788","type":"function","z":"508957a1.dd5398","name":"Decrypt","func":"var request = global.get('request');\nvar Moment = global.get('moment');\nvar MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar crypto = global.get('crypto');\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n        \ndataState = \"invalid\"\ndataContent = {};\n// verify a token symmetric\n    jsonwebtoken.verify(msg.payload.data, msg.tokenResult.key, function(err, decoded) {\n      if (decoded !== undefined){\n          dataState = \"valid\"\n          dataContent = decoded\n      }\n    });\n    \n    msg.dataResult = {\n        \n        data : msg.payload.data  ,\n        dataState : dataState,\n        key: msg.tokenResult.key, \n        dataContent:dataContent\n    }\n    return msg;\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":680,"y":520,"wires":[["8cd48535.9010d8","12a86303.f876ed"]]},{"id":"e9fecf9f.d34c5","type":"subflow:53926ffd.c5a74","z":"508957a1.dd5398","name":"","env":[],"x":500,"y":520,"wires":[["de8fb949.f20788"]]},{"id":"1d0b4bad.c78bcc","type":"function","z":"508957a1.dd5398","name":"Set msg.token","func":"\nmsg.token = msg.payload.token\n\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":310,"y":720,"wires":[["89178cce.64905"]]},{"id":"7f2dce42.419168","type":"function","z":"508957a1.dd5398","name":"Decrypt","func":"var request = global.get('request');\nvar Moment = global.get('moment');\nvar MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar crypto = global.get('crypto');\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n        \ndataState = \"invalid\"\ndataContent = {};\n// verify a token symmetric\n    jsonwebtoken.verify(msg.payload.data, msg.tokenResult.key, function(err, decoded) {\n      if (decoded !== undefined){\n          dataState = \"valid\"\n          dataContent = decoded\n      }\n    });\n    \n    msg.dataResult = {\n        \n        data : msg.payload.data  ,\n        dataState : dataState,\n        key: msg.tokenResult.key, \n        dataContent:dataContent\n    }\n    return msg;\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":670,"y":720,"wires":[["bb744419.3b4b","d9a31cb4.de7588"]]},{"id":"89178cce.64905","type":"subflow:53926ffd.c5a74","z":"508957a1.dd5398","name":"","env":[],"x":490,"y":720,"wires":[["7f2dce42.419168"]]},{"id":"843a9ad4.9424b8","type":"function","z":"508957a1.dd5398","name":"Encrypt data","func":"var request = global.get('request');\nvar Moment = global.get('moment');var MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar crypto = global.get('crypto');\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\n\npayload = {\n    data : jsonwebtoken.sign(msg.payload, msg.tokenResult.key),\n    token:msg.payload.token,\n    // revotioSessionId:msg.payload.revotioSessionId ,\n    // deviceId: msg.payload.deviceId\n}\n\nmsg.payload = payload\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":2210,"y":1100,"wires":[["cf8d96f9.9c98d"]]},{"id":"4c1b020f.633964","type":"function","z":"508957a1.dd5398","name":"Set msg.token","func":"msg.token = msg.payload.token\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1920,"y":1100,"wires":[["eb4d6343.533e18"]]},{"id":"eb4d6343.533e18","type":"subflow:53926ffd.c5a74","z":"508957a1.dd5398","name":"","env":[],"x":2080,"y":1100,"wires":[["843a9ad4.9424b8"]]},{"id":"2dee3212.2703a6","type":"function","z":"e25f5e2d.45871","name":"Set msg.token","func":"msg.token = msg.payload.token\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1120,"y":120,"wires":[["6d7694a6.cb54cc"]]},{"id":"b991d80a.80afa","type":"function","z":"e25f5e2d.45871","name":"Encrypt data","func":"var request = global.get('request');\nvar Moment = global.get('moment');var MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar crypto = global.get('crypto');\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\npayload = {\n    \n    data : jsonwebtoken.sign(msg.payload, msg.tokenResult.key),\n    token:msg.payload.token,\n    // revotioSessionId:msg.payload.revotioSessionId ,\n    // deviceId: msg.payload.deviceId\n}\n// msg.payload.data = payload.data\n\nmsg.payload = payload\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1430,"y":120,"wires":[["9690ddef.823e3"]]},{"id":"6d7694a6.cb54cc","type":"subflow:53926ffd.c5a74","z":"e25f5e2d.45871","name":"","x":1280,"y":120,"wires":[["b991d80a.80afa"]]},{"id":"eed30f49.b6e39","type":"debug","z":"508957a1.dd5398","name":"ENTERANCE post","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1230,"y":180,"wires":[]},{"id":"3fabef5c.663f88","type":"inject","z":"508957a1.dd5398","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":780,"y":1900,"wires":[["89d60b53.ef9038"]]},{"id":"89d60b53.ef9038","type":"function","z":"508957a1.dd5398","name":"Libs","func":"var request = global.get('request');\nvar Moment = global.get('moment');\nvar MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar crypto = global.get('crypto');\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\nvar unzipper =  global.get('unzipper')","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1040,"y":1860,"wires":[[]]},{"id":"f271110d.9e9e4","type":"comment","z":"e25f5e2d.45871","name":"Push Gadgets to frontend","info":"","x":430,"y":780,"wires":[]},{"id":"219babd.a507d54","type":"function","z":"e25f5e2d.45871","name":"Get gadgetContainers Object","func":"var request = global.get('request');\nvar Moment = global.get('moment');var MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar crypto = global.get('crypto');\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\nvar response, sessionUpdate , timer ;\nvar totalNumberOfGadgets, currentNumberOfGadgets;\nvar deviceId = msg.session.deviceId ; \nvar revotioSessionId = msg.session.revotioSessionId ;\nvar token = msg.session.token ;\n\nmsg.test = []\n\nmsg.page =  msg.session.Page\n\nmsg.endtime = new Date()\n\nglobal.set(\"communication.lastMessage\",new Date())\nif (global.get(\"communication\").hasOwnProperty(msg.session._id) === false\n){\n    if (msg.timer === false){\n        global.set(\"communication.lastIDSet\",new Date())\n        global.set(\"communication.\"+msg.session._id,{date: new Date(), diff :0, counter : 0})\n        msg.first = true\n    }\n    \n} else {\n    if (msg.hasOwnProperty(\"first\") === false){\n        msg.first = false\n    }\n    diff = moment(new Date()).diff(moment(global.get(\"communication.\"+msg.session._id+\".date\")))\n    global.set(\"communication.\"+msg.session._id +\".diff\",diff)\n    global.set(\"communication.\"+msg.session._id +\".counter\", global.get(\"communication.\"+msg.session._id+\".counter\")+ 1)\n   \n}\n\n\n// msg.test.push({level:2})\nif (msg.session.groupedObject.hasOwnProperty(msg.RevotioData.entity) === true){\n    msg.test.push({level:3.1})\n    totalNumberOfGadgets = msg.session.groupedObject[msg.RevotioData.entity].length\n    msg.test.push({level:3.2})\n} else {\n    msg.test.push({level:4.1})\n    totalNumberOfGadgets = msg.session.groupedObject.INIT.length\n    totalNumberOfGadgets = global.get('gadgetGroups.' + deviceId + \".\" + revotioSessionId+\".groupedObject.INIT\").length\n    msg.test.push({level:4.2})\n}\n\ncurrentNumberOfGadgets = msg.session.Gadgets.length\n\nif (    global.get(\"communication\").hasOwnProperty(msg.session._id) === true &&\n        ( totalNumberOfGadgets <= currentNumberOfGadgets  || \n        global.get(\"communication.\"+msg.session._id+\".diff\" )> global.get(\"SystemVars.responseTimeout\"))\n){\n  \n    global.set(\"communication.\"+msg.session._id)\n    msg.payload = {\n        deviceId: deviceId,\n        revotioSessionId: revotioSessionId,\n        token: token,\n        starttime: msg.starttime,\n        gadgetsList : msg.session.Gadgets,\n        Type: \"Update\"\n    }\n    \n    msg.headers = {\n    'Access-Control-Allow-Origin': '*',\n    'Access-Control-Allow-Methods': 'PUT,GET,POST,DELETE,OPTIONS',\n    'Access-Control-Allow-Headers': 'Content-Type',\n    'content-type': 'application/json',\n    };\n\n    response = msg; \n    updateObj = {\n                    query : {\n                            query :{_id:new ObjectID(msg.session._id)}, \n                            update : { \"$set\" : {Gadgets : [],\n                                                timestamp: new Date(),\n                                                responseSend : false\n                            }},\n                            options : {upsert: true}\n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'sessions',\n                    operation:'update', // updateMany , updateOne\n                    }\n\n            mongodbTools.resolveAsync(updateObj, node, function(res){\n            })  \n   \n\nresponse = {\n    pageName: msg.RevotioData.FlowData.pageName,\n    req : msg.req,\n    res : msg.res,\n    payload : msg.payload,\n    headers : msg.headers,\n    page:msg.page,\n    session_id : msg.session._id,\n    page_session_id : msg.page_session_id\n}\nsessionUpdate = msg;\n\nreturn [response, sessionUpdate] } \n\nelse if (global.get(\"communication\").hasOwnProperty(msg.session._id) === true && msg.first === true){ \n    \n        msg.timer = true\n        timer = msg;\n    return [response, sessionUpdate,timer];\n}\n\n","outputs":3,"noerr":0,"initialize":"","finalize":"","x":950,"y":860,"wires":[["ef1059a8.d05948"],["dbf0599f.517e68"],["a1856f5c.b3ab5"]],"outputLabels":["response","sessionUpdate","timer"]},{"id":"908c12c2.38f67","type":"http response","z":"e25f5e2d.45871","name":"","statusCode":"","headers":{},"x":1790,"y":780,"wires":[]},{"id":"84eaf62d.794378","type":"comment","z":"e25f5e2d.45871","name":"Generate response Object","info":"","x":450,"y":700,"wires":[]},{"id":"dbf0599f.517e68","type":"function","z":"e25f5e2d.45871","name":"Update DB Session object","func":"var request = global.get('request');\nvar Moment = global.get('moment');var MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\nObj =  {FlowData: msg.RevotioData.FlowData, timestamp : new Date(), Gadgets:[], \n};\n\n if (msg.session.groupedObject.hasOwnProperty(msg.RevotioData.entity)){\n                                     grouped_object_gadgets =  msg.session.groupedObject[msg.RevotioData.entity].length\n                                } else {\n                                    grouped_object_gadgets = -1\n                                }\n\nstats_obj = {\n                                page : msg.RevotioData.session.Page,\n                                application_id : global.get(\"applicationId\"), \n                                entity : msg.RevotioData.entity,\n                                gadgets: msg.payload.gadgetsList.length,\n                                grouped_object_gadgets:grouped_object_gadgets,\n                                starttime : new Date(msg.starttime),\n                                reponse_send_at : new Date(),\n                                reponse_send : true,\n                                time_needed_ms :  moment().diff(moment(msg.starttime)),\n                                session : new ObjectID(msg.session._id),\n                            }\n                            \nif (msg.session.user_id && msg.session.user_id){\n    stats_obj.user  =  new ObjectID(msg.session.user_id)\n}\n// msg.payload = [{deviceId: msg.RevotioData.session.deviceId, revotioSessionId: msg.RevotioData.session.revotioSessionId},{\"$set\" : Obj},{upsert : true}];\n\n// msg.operation = 'updateOne';\n\n// update    \n    updateObj = {\n                    query : {\n                            query :{deviceId: msg.RevotioData.session.deviceId, revotioSessionId: msg.RevotioData.session.revotioSessionId}, \n                            update : {\"$set\" : Obj,\n                                     \"$unset\": {last_gadgets_update :''}\n                            },\n                            options : {upsert: true}\n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'sessions',\n                    operation:'update', // updateMany , updateOne\n                    }\n\n                     \n                        mongodbTools.resolveAsync(updateObj, node, function(res){\n                            \n                              \n                        \n               \n                           updateObj = {\n                                query : {\n                                        query : stats_obj , \n                                        update : {\"$set\" : stats_obj\n                                                \n                                        },\n                                        options : {upsert: true}\n                                        },\n                                connection:global.get(\"DB_data.connection\"),\n                                database:global.get(\"DB_data.appDB\"),\n                                collection:'system_stats',\n                                operation:'update', // updateMany , updateOne\n                                }\n            \n                        mongodbTools.resolveAsync(updateObj, node, function(res){\n                                // msg.result = res\n                                // node.send(msg) \n                        })  \n            })  \n            \n            \n// return msg;","outputs":1,"noerr":0,"x":1580,"y":860,"wires":[[]]},{"id":"e0bfa97f.699338","type":"function","z":"e25f5e2d.45871","name":"Update && Get session","func":"var request = global.get('request');\nvar Moment = global.get('moment');var MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar crypto = global.get('crypto');\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\n\n// reset msg object\n\nRevotioData = msg.RevotioData\npayload = msg.payload\nres = msg.res\nreq = msg.req\nstarttime = msg.starttime\nstarttime2 = msg.starttime2\nstarttime3= msg.starttime3\ncommunicationData = msg.communicationData\n\nmsg = {\n    payload:payload,\n    RevotioData:RevotioData,\n    res : res,\n    req : req,\n    starttime : starttime,\n    starttime2:starttime2,\n    starttime3:msg.starttime3,\n    communicationData : communicationData\n}\n\n// check if its dev env\n// if (env.get(\"PREFORMANCE_CHECK\") && env.get(\"PREFORMANCE_CHECK\") === true){\n    _.each(msg.payload.gadgetsList, function(item,index){\n        item.starttime      = msg.starttime \n        item.starttime2      = msg.starttime2 \n        item.starttime3      = msg.starttime3\n        item.starttime_2_diff       = moment(item.starttime2).diff(moment(msg.starttime))\n         item.starttime2_3_diff       = moment(item.starttime3).diff(moment(msg.starttime2))\n        item.endtime        = new Date() \n        // item.endtimeMS      = item.endtime.getTime()\n        \n        // if (msg.starttime && typeof  msg.starttime === \"date\"){\n        item.timediff       = moment(item.endtime).diff(moment(msg.starttime))\n        // }\n    })\n\n// }\n\nmsg.timer = false\n\nupdateObj = {\n                    query : {\n                            query :{_id:new ObjectID(msg.RevotioData.session._id)}, \n                            update : { \"$set\": {last_gadgets_update : new Date()}, \"$push\": { Gadgets: { \"$each\": msg.payload.gadgetsList } }},\n                            options : {upsert: true, returnOriginal: false}\n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'sessions',\n                    operation:'findOneAndUpdate', // updateMany , updateOne\n                    }\n\n            mongodbTools.resolveAsync(updateObj, node, function(res){\n                \n                if (typeof res === 'object' && res.hasOwnProperty(\"value\")){\n                     msg.session = res.value\n \n                    node.send(msg) \n                   \n                }\n            \n            \n            }) \n            \n            \n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":430,"y":840,"wires":[["2c50c9cd.f23216"]]},{"id":"ef1059a8.d05948","type":"function","z":"e25f5e2d.45871","name":"Set response","func":"var request = global.get('request');\nvar Moment = global.get('moment');var MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar crypto = global.get('crypto');\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\n\n\n\n// check if its dev env\n// if (env.get(\"PREFORMANCE_CHECK\") && env.get(\"PREFORMANCE_CHECK\") === true){\n    msg.payload.endtime         = new Date() \n    msg.payload.starttime       = msg.payload.starttime\n    msg.payload.timediff        = moment(msg.payload.endtime).diff(moment(msg.payload.starttime))\n    \n    gadgetsList = lodash.orderBy(msg.payload.gadgetsList, [\"endtime\"], [\"desc\"]);\n    \n    \n    msg.payload.gadgetsList = gadgetsList;\n    msg.payload.included = []\n    _.each(gadgetsList, function(item, index){\n        msg.payload.included.push(item.gadgetName)\n    })\n\n\n\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":950,"y":780,"wires":[["42e145ce.35792c"]]},{"id":"a1856f5c.b3ab5","type":"delay","z":"e25f5e2d.45871","name":"","pauseType":"delayv","timeout":"1000","timeoutUnits":"milliseconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":640,"y":940,"wires":[["e867f54d.fd61b8"]]},{"id":"e867f54d.fd61b8","type":"function","z":"e25f5e2d.45871","name":"Get session","func":"var request = global.get('request');\nvar Moment = global.get('moment');var MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar crypto = global.get('crypto');\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\nfindOneObj = {\n                    query : {\n                            query :{\n                                        _id:new ObjectID(msg.RevotioData.session._id)\n                            } \n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'sessions',\n                    operation:'find',\n                    }\n\n            mongodbTools.resolveAsync(findOneObj, node, function(res){\n                if (res.length > 0){\n                    msg.session = res[0]\n                } else {\n                    msg.session = {}\n                }\n                    \n                    // if (    msg.sessionNew.hasOwnProperty(\"Gadgets\") &&\n                    //         msg.sessionNew.Gadgets.length ===  msg.session.Gadgets.length \n                    // ){\n                        node.send(msg) \n                    // }\n            })  ","outputs":1,"noerr":0,"x":970,"y":940,"wires":[["219babd.a507d54"]]},{"id":"70b60a73.38b344","type":"function","z":"e25f5e2d.45871","name":"Encrypt data","func":"var request = global.get('request');\nvar Moment = global.get('moment');var MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar crypto = global.get('crypto');\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\nvar a,b \ntime = new Date()\npayload = {\n    pageName : msg.pageName,\n    data : jsonwebtoken.sign(msg.payload, msg.tokenResult.key),\n    token:msg.payload.token,\n    // revotioSessionId:msg.payload.revotioSessionId ,\n    // deviceId: msg.payload.deviceId\n}\nb =  {payload : msg.payload, pageName : msg.pageName ,time:time,page:msg.page, page_session_id:msg.page_session_id}\n\nmsg.payload = payload\na = msg\nreturn [a,b];","outputs":2,"noerr":0,"initialize":"","finalize":"","x":1510,"y":780,"wires":[["908c12c2.38f67"],["883ea83c.e0ee48"]]},{"id":"42e145ce.35792c","type":"function","z":"e25f5e2d.45871","name":"Set msg.token && Remove sessin","func":"msg.token = msg.payload.token\n global.set(\"userData.\"+msg.session_id)\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1220,"y":780,"wires":[["16db64b2.5ab03b"]]},{"id":"883ea83c.e0ee48","type":"function","z":"e25f5e2d.45871","name":"save payload to fs","func":"var request = global.get('request');\nvar Moment = global.get('moment');\nvar MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar crypto = global.get('crypto');\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\n// generate json title\nfs.ensureDirSync('/files/renderFiles/')\n\nfs.removeSync('/files/renderFiles/'+msg.page+'.json')\n\ntimeDiffs = {timediff: msg.payload.timediff}\n\n_.each(msg.payload.gadgetsList, function(gadget, index){\n   timeDiffs[gadget.gadgetName] = {\n       type: gadget.gadgetType,\n       starttime : gadget.starttime,\n       starttime2 : gadget.starttime2,\n       starttime3 : gadget.starttime3,\n       starttime_2_diff : gadget.starttime_2_diff,\n       starttime2_3_diff : gadget.starttime2_3_diff,\n       endtime : gadget.endtime,\n       timediff : gadget.timediff,\n   }\n})\n\nfs.writeJsonSync('/files/renderFiles/'+msg.page+'.json', {timeDiffs:timeDiffs,\n                                                            payload: msg.payload,\n                                                            startEnc : msg.time,\n                                                            writefile : new Date()\n})\n\n// update    \n\n    updateObj = {\n                    query : {\n                            query :{page:msg.page,date:new Date()}, \n                            update : { \"$set\" : timeDiffs},\n                            options : {upsert: true}\n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'preformance',\n                    operation:'update', // updateMany , updateOne\n                    }\n\n            mongodbTools.resolveAsync(updateObj, node, function(res){\n                    // msg.payload = res\n                    // node.send(msg) \n            })  \n\n\n\n\n// update    \n\n    updateObj = {\n                    query : {\n                            query :{_id :new ObjectID(msg.page_session_id)}, \n                            update : { \"$set\" : {pageName : msg.pageName , gadgetsList : msg.payload.gadgetsList}},\n                            options : {upsert: true}\n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'page_load_sessions',\n                    operation:'update', // updateMany , updateOne\n                    }\n\n            mongodbTools.resolveAsync(updateObj, node, function(res){\n                //   msg.payload = payload\n                //     node.send(msg) \n            })  \n            \n// return msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1830,"y":820,"wires":[[]]},{"id":"2c50c9cd.f23216","type":"function","z":"e25f5e2d.45871","name":"Get page_load_session_id","func":"var request = global.get('request');\nvar Moment = global.get('moment');var MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\n   \n   if (msg.RevotioData.FlowData.hasOwnProperty(\"page_session_id\")){\n        msg.page_session_id = msg.RevotioData.FlowData.page_session_id\n        node.send(msg) \n   } else {\n       \n       // aggregate\n\n            aggregateObj = {\n                    query : { query : [{\n                                $match: {deviceId: msg.RevotioData.session.deviceId, revotioSessionId: msg.RevotioData.session.revotioSessionId} ,\n                                },\n                                 { \n                                    \"$sort\" : { \n                                        \"date\" : 1.0\n                                    }\n                                },\n                                 { \n                                    \"$limit\" : 1.0\n                                }\n                            ],},\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'page_load_sessions',\n                    operation:'aggregate',\n                    }\n                    \n            mongodbTools.resolveAsync(aggregateObj, node, function(res){\n                    if (res.length > 0){\n                         msg.page_session_id = res[0]._id\n                    } else {\n                         msg.page_session_id = \"\"\n                    }\n                   \n                    node.send(msg) \n            })  \n            \n   }     \n \n         ","outputs":1,"noerr":0,"initialize":"","finalize":"","x":640,"y":840,"wires":[["219babd.a507d54"]]},{"id":"2968cd86.c7a2e2","type":"function","z":"8e853889.7b4f78","name":"prepair redirect","func":"\n\nmsg.payload = {\n    Page : msg.RevotioData.session.Page,\n    RevotioData :{\n        organization_id: msg.RevotioData.FlowData.organization_id,\n        application_id : msg.RevotioData.FlowData.application_id,\n        page_id : msg.RevotioData.FlowData.page_id,\n        item_id : msg.RevotioData.FlowData.item_id,\n    }\n}\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":200,"y":80,"wires":[[]]},{"id":"929d18e2.fbc3d8","type":"http request","z":"5e9b9c1d.bbe4a4","name":"","method":"POST","ret":"txt","paytoqs":false,"url":"","tls":"","proxy":"","authType":"basic","x":870,"y":320,"wires":[["51296018.a353e"]]},{"id":"c84e6b09.3e90f8","type":"function","z":"5e9b9c1d.bbe4a4","name":"Prepair redirect (subflow)","func":"var request = global.get('request');\nvar Moment = global.get('moment');var MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\n\nmsg.payload = {\n    RevotioData : msg.RevotioData,\n    payload : msg.payload\n}\n\nif (!msg.payload.payload.Page ){\n    msg.payload.payload.Page = global.get(\"DomainProperties.DefaultPage\")\n    msg.test123 = new Date()\n}\n\n msg.url = global.get(\"DomainProperties.url\") + \"/redirect\"\n \n\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":670,"y":320,"wires":[["929d18e2.fbc3d8","a8ff24ce.78ef88"]]},{"id":"51296018.a353e","type":"json","z":"5e9b9c1d.bbe4a4","name":"","property":"payload","action":"","pretty":false,"x":1030,"y":320,"wires":[["63d247bf.b18858"]]},{"id":"ed71d4e8.3fb4c8","type":"function","z":"5e9b9c1d.bbe4a4","name":"Encrypt data","func":"var request = global.get('request');\nvar Moment = global.get('moment');var MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar crypto = global.get('crypto');\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\n\npayload = {\n    data : jsonwebtoken.sign(msg.payload, msg.tokenResult.key),\n    token:msg.payload.token,\n    pageSessionId:msg.page_session_id,\n    pageName :global.get(\"env.TYPE\")\n};\n\n\n// update    \n\n    updateObj = {\n                    query : {\n                            query :{_id :new ObjectID(msg.page_session_id)}, \n                            update : { \"$set\" : {pageObject : msg.payload,}},\n                            options : {upsert: true}\n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'page_load_sessions',\n                    operation:'update', // updateMany , updateOne\n                    }\n\n            mongodbTools.resolveAsync(updateObj, node, function(res){\n                  msg.payload = payload\n                    node.send(msg) \n            })  \n            \n            \n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1350,"y":560,"wires":[["fbd33a95.d055b8"]]},{"id":"63d247bf.b18858","type":"function","z":"5e9b9c1d.bbe4a4","name":"Set msg.token","func":"msg.token = msg.payload.token\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":780,"y":480,"wires":[["b56ba393.ca4dc"]]},{"id":"3df42567.71eeca","type":"function","z":"5e9b9c1d.bbe4a4","name":"Get page_load_session_id","func":"var request = global.get('request');\nvar Moment = global.get('moment');var MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\n   \n   if (msg.payload.hasOwnProperty(\"RevotioData\") && \n        msg.payload.RevotioData.hasOwnProperty(\"page_session_id\")){\n        msg.page_session_id = msg.payload.RevotioData.page_session_id \n        node.send(msg) \n   } else {\n       \n       // aggregate\n\n            aggregateObj = {\n                    query : { query : [{\n                                $match: {deviceId: msg.payload.deviceId, revotioSessionId: msg.payload.revotioSessionId} ,\n                                },\n                                 { \n                                    \"$sort\" : { \n                                        \"date\" : 1.0\n                                    }\n                                },\n                                 { \n                                    \"$limit\" : 1.0\n                                }\n                            ],},\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'page_load_sessions',\n                    operation:'aggregate',\n                    }\n                    \n            mongodbTools.resolveAsync(aggregateObj, node, function(res){\n                    if (res.length > 0){\n                         msg.page_session_id = res[0]._id\n                    } else {\n                         msg.page_session_id = \"\"\n                    }\n                   \n                    node.send(msg) \n            })  \n            \n   }     \n \n         ","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1127,"y":595,"wires":[["ed71d4e8.3fb4c8"]]},{"id":"b56ba393.ca4dc","type":"subflow:53926ffd.c5a74","z":"5e9b9c1d.bbe4a4","name":"","env":[],"x":970,"y":500,"wires":[["3df42567.71eeca"]]},{"id":"fbd33a95.d055b8","type":"http response","z":"5e9b9c1d.bbe4a4","name":"","statusCode":"","headers":{},"x":1570,"y":560,"wires":[]},{"id":"4d81e47d.d8780c","type":"function","z":"d237f7f5.48aae8","name":"google translate","func":"var request = global.get('request');\nvar Moment = global.get('moment');\nvar MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar crypto = global.get('crypto');\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\nvar Translate = global.get('google_translate.v2.Translate')\nCREDENTIALS= fs.readJsonSync(global.get(\"DomainProperties.rootBackendFolder\")+\"googleFiles/pno-pmt-credentials.json\");\n\n// Configuration for the client\ntranslate = new Translate({\n    credentials: CREDENTIALS,\n    projectId: CREDENTIALS.project_id\n});\n\n// check && set globalContext object\n\nif (global.get(\"translateArrays\") === false){\n  global.set(\"translateArrays\", {})  \n}\n\narray = msg.payload\n\nvar contextID = new ObjectID()\n\nvar contextObject = {\n    input:msg.payload,\n    output:[],\n    counter:0,\n    started:new Date(),\n    errors:[]\n}\n\nmsg.contextID = contextID\n\nglobal.set(\"translateArrays.\"+contextID, contextObject)\n\n\n_.each(global.get(\"translateArrays.\"+contextID+\".input\"), function(item, index){\n              \n                const detectLanguage = async (text) => {\n                \n                    try {\n                        let response = await translate.detect(text);\n                        return response[0].language;\n                    } catch (error) {\n                        console.log(`Error at detectLanguage --> ${error}`);\n                        return 0;\n                    }\n                }\n                var textVar = item.key\n                var targetLanguageVar = \"nl\"\n                \n                \n                // detectLanguage(textVar)\n                //     .then((res) => {\n                //         global.set(\"translateArrays.\"+contextID+'.input['+index+'].keyLang', res)\n                //         global.set(\"translateArrays.\"+contextID+'.input['+index+'].keyLangState', \"success\")\n                //     })\n                //     .catch((err) => {\n                //         global.set(\"translateArrays.\"+contextID+'.errors['+index+']', item)\n                //         global.set(\"translateArrays.\"+contextID+'.errors['+index+'].keyLang', \"unknown\")\n                //         global.set(\"translateArrays.\"+contextID+'.errors['+index+'].keyLangState', err)\n                //         global.set(\"translateArrays.\"+contextID+\".[\"+index+\"]\", \"error\")\n                //     });\n                \n                const translateText = async (text, targetLanguage) => {\n                \n                    try {\n                        let [response] = await translate.translate(text, targetLanguage);\n                        return response;\n                    } catch (error) {\n                        console.log(`Error at translateText --> ${error}`);\n                        return 0;\n                    }\n                };\n\n              translateText(textVar, targetLanguageVar)\n                              .then((res) => {\n                                  item.value = res;\n                                  item.valueState = \"success\";\n                                  item.ended = new Date();\n                                  global.set(\"translateArrays.\"+contextID+'.output['+Number(global.get(\"translateArrays.\"+contextID+'.output').length)+']',item);\n                                    // global.set(\"translateArrays.\"+contextID+'.output['+index+'].', ) \n                                    // global.set(\"translateArrays.\"+contextID+'.output['+index+'].valueState', \"success\")\n                                    // global.set(\"translateArrays.\"+contextID+'.output['+index+'].ended', new Date())\n                                    // global.set(\"translateArrays.\"+contextID+'.counter', Number(global.get(\"translateArrays.\"+contextID+'.counter') + 1))\n                                         })\n                                .catch((err) => {\n                                    item.value =  \"unknown\";\n                                    item.valueState =err;\n                                    item.ended = new Date();\n                                    global.set(\"translateArrays.\"+contextID+'.errors['+ Number(global.set(\"translateArrays.\"+contextID+'.errors').length)+']',  item);\n                                    // global.set(\"translateArrays.\"+contextID+'.errors['+index+']',  global.get(\"translateArrays.\"+contextID+'.output['+index+']'))\n                                    // global.get(\"translateArrays.\"+contextID+'.output['+index+']')\n                                    // global.set(\"translateArrays.\"+contextID+'.errors['+index+'].value', \"unknown\")\n                                    // global.set(\"translateArrays.\"+contextID+'.errors['+index+'].valueState', err)\n                    });\n         \n})\n\n// global.set(\"translateArrays.\"+contextID)\n\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":200,"y":100,"wires":[["fc945726.b18378"]]},{"id":"fc945726.b18378","type":"delay","z":"d237f7f5.48aae8","name":"","pauseType":"delay","timeout":"5","timeoutUnits":"milliseconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":430,"y":140,"wires":[["7a7fc4.02c9e03c"]]},{"id":"7a7fc4.02c9e03c","type":"function","z":"d237f7f5.48aae8","name":"check if done","func":"var done, notDone;\nif (global.get(\"translateArrays.\"+msg.contextID+\".input\").length ===( global.get(\"translateArrays.\"+msg.contextID+\".output\").length + global.get(\"translateArrays.\"+msg.contextID+\".errors\").length)){\n    payload = global.get(\"translateArrays.\"+msg.contextID)\n    msg.payload = {\n        input:payload.input,\n        output:payload.output,\n        errors: payload.errors,\n        counter: payload.counter,\n    }\n    global.set(\"translateArrays.\"+msg.contextID)\n    delete msg.contextID\n    done = msg\n}else {\n     notDone = msg\n}\n\nreturn [ done, notDone];","outputs":2,"noerr":0,"initialize":"","finalize":"","x":440,"y":80,"wires":[[],["fc945726.b18378","79caccb8.54f4b4"]],"outputLabels":[" done,","notDone"]},{"id":"79caccb8.54f4b4","type":"debug","z":"d237f7f5.48aae8","name":"Delay","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":600,"y":220,"wires":[]},{"id":"cc51476b.f74068","type":"function","z":"ab79407.ded3ec","name":"Remove user sessions","func":"var request = global.get('request');\nvar Moment = global.get('moment');var MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar crypto = global.get('crypto');\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\n// remove \n            removeObj = {\n                    query : {\n                            query :{\n                                        deviceId : msg.RevotioData.session.deviceId ,\n                                        revotioSessionId: msg.RevotioData.session.revotioSessionId\n                                    }, \n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'sessions',\n                    operation:'remove',\n                    }\n\n            mongodbTools.resolveAsync(removeObj, node, function(res){\n                    // msg.payload = res\n                    node.send(msg) \n            })   ","outputs":1,"noerr":0,"x":200,"y":80,"wires":[["8079266c.457568"]]},{"id":"8079266c.457568","type":"function","z":"ab79407.ded3ec","name":"remove global comntext sessions","func":"global.set(\"gadgetGroups.\"+ msg.RevotioData.session.deviceId)\n\nmsg.payload = {\n    RevotioData:{\n    logout : true,},\n    deviceId: msg.RevotioData.session.deviceId,\n    // revotioSessionId : msg.RevotioData.session.revotioSessionId\n}\n\nmsg.headers = {\n    'Access-Control-Allow-Origin': '*',\n    'Access-Control-Allow-Methods': 'PUT,GET,POST,DELETE,OPTIONS',\n    'Access-Control-Allow-Headers': 'Content-Type',\n    'content-type': 'application/json',\n};\nreturn msg;","outputs":1,"noerr":0,"x":440,"y":80,"wires":[["fffbd167.a730d"]]},{"id":"fffbd167.a730d","type":"http response","z":"ab79407.ded3ec","name":"","statusCode":"","headers":{},"x":650,"y":80,"wires":[]},{"id":"c2d92f7a.f4f5e","type":"function","z":"be61da9a.8b3cd8","name":"save error in error collection","func":"// Get libraries\nconst Moment = global.get('moment');\nconst MomentRange = global.get('momentrange');\nconst moment = MomentRange.extendMoment(Moment)\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting'); \nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar fs = global.get('fsextra');\nvar mime = global.get('mime');\n\nObj = {\n        data:{\n            payload:msg.payload,\n            RevotioData:msg.RevotioData,\n            error : msg.error,\n            statusCode:msg.statusCode,\n            url:msg.url,\n            starttime : msg.starttime,\n            \n        },\n        date  :new Date(),\n        app : global.get(\"applicationId\"),\n        type:\"backend_error\"\n}\n\n// update    \n\n    updateObj = {\n                    query : {\n                            query :Obj, \n                            update : { \"$set\" : Obj},\n                            options : {upsert: true}\n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'errors',\n                    operation:'update', // updateMany , updateOne\n                    }\n\n            mongodbTools.resolveAsync(updateObj, node, function(res){\n                    // msg.payload = res\n                    // msg.payload =   {\n                    //                     msg: payload,\n                    //                     state:  \"error processed\"\n                    //                 }\n                       \n                    node.send(msg) \n            })  ","outputs":1,"noerr":0,"x":680,"y":60,"wires":[[]]},{"id":"e3d59bbe.0b2068","type":"function","z":"be61da9a.8b3cd8","name":"Create ERROR json file ","func":"var request = global.get('request');\nvar Moment = global.get('moment');var MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar crypto = global.get('crypto');\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\n\n// ensure error dir\nfs.ensureDirSync(global.get(\"DomainProperties.rootPath\")+\"errors\")\n\nerrorFileName = new Date()\n\nfs.writeJsonSync(global.get(\"DomainProperties.rootPath\")+\"errors/\" + errorFileName +\".json\", JSON.stringify({error : msg.error, RevotioData: msg.RevotioData, payload: msg.payload}))\n\n\nreturn msg;","outputs":1,"noerr":0,"x":380,"y":260,"wires":[[]]},{"id":"dd5ad5f8.cf8828","type":"function","z":"be61da9a.8b3cd8","name":"Route error","func":"var logout , other;\n\nif (msg.error.source.name === \"Get session data\"){\n    msg.RevotioData = {session : {\n        deviceId:msg.tokenResult.TokenContent.deviceId,\n        revotioSessionId:msg.tokenResult.TokenContent.revotioSessionId\n    }}\n    logout = msg\n} else {\n    other = msg\n}\nreturn [logout , other];","outputs":2,"noerr":0,"initialize":"","finalize":"","x":270,"y":180,"wires":[["c698c66.c151138"],["e3d59bbe.0b2068"]],"outputLabels":["logout","other"]},{"id":"c698c66.c151138","type":"subflow:ab79407.ded3ec","z":"be61da9a.8b3cd8","name":"","env":[],"x":450,"y":120,"wires":[]},{"id":"5abccab0.40a034","type":"function","z":"22428f45.8ab","name":"Get Page object","func":"// Get libraries\nconst Moment = global.get('moment');\nconst MomentRange = global.get('momentrange');\nconst moment = MomentRange.extendMoment(Moment)\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting'); \nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\n\n\n\n// set all response data\nmsg.responseObj                     = msg.payload;\nmsg.responseObj.deviceId            = msg.RevotioData.session.deviceId ;\nmsg.responseObj.revotioSessionId    = msg.RevotioData.session.revotioSessionId ;\nmsg.responseObj.user_id             = msg.RevotioData.session.user_id ;\nmsg.responseObj.applicationId       = new ObjectID(global.get(\"applicationId\"));\nmsg.responseObj.token               = msg.RevotioData.session.token;\nmsg.responseObj.Page                = msg.payload.Page.toLowerCase().trim();//.replace(/^\\s*|\\s*$/g, '');\n// msg.payload.Page                    = msg.responseObj.Page;\n\nmsg.headers = {};\nmsg.rejectUnauthorized =  false;\n\n\n\nreturn msg;\n\n// if (    msg.responseObj.Page === \"project overview\" && \n//         msg.responseObj.hasOwnProperty(\"RevotioData\") &&\n//         msg.responseObj.RevotioData.hasOwnProperty(\"project_id\") ){\n    \n//     // get funding_scheme object\n    \n//     // aggregate\n//             aggregateObj = {\n//                     query : { query : [{\n//                                 $match: {\n//                                   \"_id\": new ObjectID(msg.responseObj.RevotioData.project_id),\n                                \n//                                 }\n//                               },\n//                               {\n//                                 $lookup: {\n//                                   \"from\": \"settings\",\n//                                   \"localField\": \"funding_scheme\",\n//                                   \"foreignField\": \"_id\",\n//                                   \"as\": \"funding_scheme_data\"\n//                                 }\n//                               },\n                 \n//                               {\n//                                 $unwind: {\n//                                   \"path\": \"$funding_scheme_data\",\n//                                   \"includeArrayIndex\": \"arrayIndex\",\n//                                   \"preserveNullAndEmptyArrays\": false\n//                                 }\n//                               }\n//                             ],},\n//                     connection:global.get(\"DB_data.connection\"),\n//                     database:global.get(\"DB_data.appDB\"),\n//                     collection:'projects',\n//                     operation:'aggregate',\n//                     }\n                    \n//             mongodbTools.resolveAsync(aggregateObj, node, function(res){\n//                     // if (Array.isArray(res)=== true && res.length>0 && res[0].funding_scheme_data.hasOwnProperty(\"project_template\")){\n                \n               \n                        \n//                     //     msg.responseObj.Page = res[0].funding_scheme_data.project_template + \" \" + msg.responseObj.Page\n//                     //     url = \"https://new-services.revotio.com/pages?\" +  \"applicationId=\"  + msg.responseObj.applicationId + \"&pageName=\"+  msg.responseObj.Page ;\n                        \n//                     // } else {\n//                          msg.responseObj.Page = \"default \" + msg.responseObj.Page.trim()\n//                         url = \"https://new-services.revotio.com/pages?\" +  \"applicationId=\"  + msg.responseObj.applicationId + \"&pageName=\"+  msg.responseObj.Page.trim() ;\n                     \n//                     // }\n                   \n//                     // url = \"https://new-services.revotio.com/pages?\" +  \"applicationId=\"  + msg.responseObj.applicationId + \"&pageName=\"+  msg.responseObj.Page ;\n//                     res = encodeURI(url);\n                    \n//                     msg.url = res\n\n//                     node.send(msg) \n//             })\n    \n       \n        \n        \n// } else {\n  \n//         url = global.get(\"page_api\")+ \"/pages?\" +  \"applicationId=\"  + msg.responseObj.applicationId + \"&pageName=\"+  msg.responseObj.Page ;\n//         res = encodeURI(url);\n        \n//         msg.url = res\n//         node.send(msg)\n\n// }\n\n\n\n\n\n\n// return msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":460,"y":920,"wires":[["bd6bfd6d.c939b"]]},{"id":"3609d434.3284bc","type":"comment","z":"22428f45.8ab","name":"Redirect","info":"Expected object :\n\n msg.payload = {\n        DeviceId: ** From publised app **,\n        RevotioSessionId : ** From publised app **,\n        Page:  ** defigned in the Node-Red API **,\n        timestamp :  ** Last update of DB session object **,\n        user_id:  ** suplied by publeshed app **,\n        applicationId : ** applicationId Defigned in global context of the server **,\n    }","x":100,"y":880,"wires":[]},{"id":"d25f097e.01e458","type":"function","z":"22428f45.8ab","name":"Setup msg.RevotioData obj","func":"var request = global.get('request');\nvar Moment = global.get('moment');var MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar crypto = global.get('crypto');\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\nvar unauth, auth,activate, reset,pageSession,   error; \nmsg.RevotioData =\n{\n    session : JSON.parse(msg.dataResult.dataContent.SessionData),\n    type : msg.dataResult.dataContent.payload,\n    BrowserFP : JSON.parse(msg.dataResult.dataContent.PostData)\n}\n\n\n\n        \nif (msg.RevotioData.session.entranceType === \"activate\"){\n    activate = msg;\n} else if (msg.RevotioData.session.entranceType === \"reset\"){\n    reset = msg;\n} else if (msg.RevotioData.session.entranceType === \"pageSession\"){\n    pageSession = msg;\n} \n\nelse {\n    \n \n  \n    if (typeof msg.tokenResult.TokenContent  === \"object\" &&  msg.tokenResult.TokenContent.type === \"authorized\"){\n        msg.RevotioData.tokenInfo ={\n            deviceId: msg.tokenResult.TokenContent.deviceId,\n            revotioSessionId: msg.tokenResult.TokenContent.revotioSessionId,\n            tokenCreated:  moment.unix(msg.tokenResult.TokenContent.iat),\n            tokenDateNow: moment(),\n            tokenCreatedDiffDays : moment().diff(moment.unix(msg.tokenResult.TokenContent.iat), 'days'),// (msg.RevotioData.tokenCreatedDiff / (1000 * 60 * 60)).toFixed(1);\n            currentTimeZone: msg.RevotioData.session.timezone,\n            tokenData:msg.tokenResult.TokenContent\n        }\n        \n        \n        auth = msg;\n    } else if (typeof msg.tokenResult.TokenContent  === \"object\" && msg.tokenResult.TokenContent.type === \"unauthorized\") {\n        \n        unauth = msg;\n    } \n    else {\n        \n        // msg.tokenData = tokenData;\n        error = msg;\n    }\n    \n}\n\nreturn [unauth, auth , activate ,reset,pageSession,  error];","outputs":6,"noerr":0,"initialize":"","finalize":"","x":600,"y":340,"wires":[["be00a65c.28f788"],["8258e7f0.7010b8","346559fb.3bd3e6"],["414fbb78.f981c4"],["e450621c.319d"],["3330057.39240fa"],[]],"outputLabels":["unauth","auth","activate","reset","pageSession","error"]},{"id":"884ebcd8.a7d85","type":"function","z":"22428f45.8ab","name":"Check if session exists and is valid or create new one & INIT FS","func":"var request = global.get('request');\nvar Moment = global.get('moment');var MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\n\n// Decide twoStepState\n\nvar threshold \n\nif (global.get(\"DomainProperties.twoStepThreshold\")){\n    threshold = global.get(\"DomainProperties.twoStepThreshold\")\n    \n} else {\n    threshold = 7\n}\n    \n\nif ( msg.payload && msg.payload.hasOwnProperty(\"UserData\") ){\n    \n    msg.SessionObj = msg.payload ;\n\n    Obj =  {\n        \n        _id: new ObjectID(msg.SessionObj._id),\n        token: msg.SessionObj.token,\n        deviceId: msg.SessionObj.deviceId,\n        revotioSessionId :msg.SessionObj.revotioSessionId,\n        Page: msg.SessionObj.Page,\n        timestamp : new Date(),\n        user_id: new ObjectID(msg.RevotioData.session.user_id),\n        applicationId : new ObjectID(global.get(\"applicationId\")),\n        UserData : msg.RevotioData.userData,\n        timezone: msg.RevotioData.session.timezone,\n        currentUserTime: msg.RevotioData.session.currentUserTime ,\n        gmtTime: msg.RevotioData.session.gmtTime,\n        \n    }\n\n    operation = 'update'\n    \n} else {\n    \n    Obj = {\n         _id: new ObjectID(),\n        token: msg.RevotioData.session.token,\n        deviceId: msg.RevotioData.session.deviceId,\n        revotioSessionId :msg.RevotioData.session.revotioSessionId,\n        timestamp : new Date(),\n        user_id: new ObjectID(msg.RevotioData.session.user_id),\n        applicationId : new ObjectID(global.get(\"applicationId\")),\n        UserData : msg.RevotioData.session.UserData,\n        timezone: msg.RevotioData.session.timezone,\n        currentUserTime: msg.RevotioData.session.currentUserTime ,\n        gmtTime: msg.RevotioData.session.gmtTime\n    };\n\n\n    operation = 'update'\n\n}\n\n// check if token age is within boundries\nif (    msg.RevotioData.tokenInfo.tokenCreatedDiffDays ||\n        msg.RevotioData.tokenInfo.tokenCreatedDiffDays > 7\n        ){\n      Obj.Page = global.get(\"DomainProperties.NonAuthDefaultPage\")\n} else {\n        Obj.Page =  global.get(\"DomainProperties.ClientDefaultPage\");\n}\n      \n        Obj.RevotioData = {organization_id : new ObjectID(msg.RevotioData.session.permission.organizationData._id)}\n\n    msg.payload = Obj ; \n// update    \n    updateObj = {\n                    query : {\n                            query :{_id:new ObjectID(Obj._id)}, \n                            update : { \"$set\" : Obj},\n                            options : {upsert: true}\n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'sessions',\n                    operation:'update', // updateMany , updateOne\n                    }\n\n            mongodbTools.resolveAsync(updateObj, node, function(res){\n                    msg.result = res\n                    node.send(msg) \n            })  \n\n\n\n// return msg;","outputs":1,"noerr":0,"x":3070,"y":320,"wires":[["beee4a6.d97e5b8","ed062582.39fc48"]]},{"id":"28c05ee6.7acc72","type":"function","z":"22428f45.8ab","name":"Prepair msg.RevotioData Obj","func":"\nif (typeof msg.payload.FlowData === 'object' ){\n    FlowData = msg.payload.FlowData\n    delete msg.payload.FlowData\n} else {\n     FlowData = {Data : {}}\n}\n\n\nmsg.RevotioData = {\n    init:msg.INIT,\n    entity: \"INIT\",\n    session : msg.payload,\n    FlowData: FlowData\n    };\nreturn msg;","outputs":1,"noerr":0,"x":620,"y":600,"wires":[["d4600974.fefad8"]]},{"id":"98133071.a2f0d","type":"function","z":"22428f45.8ab","name":"Prepair session lookup","func":"var request = global.get('request');\nvar Moment = global.get('moment');var MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\n//  get session\n\nvar query = {\n    deviceId: msg.RevotioData.session.deviceId,\n    revotioSessionId :msg.RevotioData.session.revotioSessionId,\n};\n\nmsg.query = query\n// find  \nfindObj = {\n                    query : {\n                            query :query, \n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'sessions',\n                    operation:'find',\n                    }\n\n            mongodbTools.resolveAsync(findObj, node, function(res){\n                if (res.length > 0){\n                    msg.payload = lodash.orderBy(res,[\"timestamp\"],[\"desc\"])[0]\n                } else {\n                    msg.resultSessionQuery = res\n                    msg.payload = {}\n                }\n                    \n                    node.send(msg) \n            })   \n\n// return msg;","outputs":1,"noerr":0,"x":2700,"y":320,"wires":[["884ebcd8.a7d85","35b6d281.c3180e"]]},{"id":"8f0ae280.249e6","type":"catch","z":"22428f45.8ab","name":"","scope":null,"x":100,"y":40,"wires":[["370f35d5.83dd6a"]]},{"id":"8653bb23.0e7148","type":"debug","z":"22428f45.8ab","name":"ERROR","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":600,"y":40,"wires":[]},{"id":"4310a895.50d9d8","type":"function","z":"22428f45.8ab","name":"Update Session to match location user && gen page_session_id -- Redirect --","func":"var request = global.get('request');\nvar Moment = global.get('moment');var MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\nresponseObj = msg.responseObj;\n\nObj =  {timestamp : new Date(),\n        applicationId: new ObjectID(global.get(\"applicationId\")),\n        // session : msg.RevotioData.session\n}\n\nif (responseObj.deviceId){\n    Obj.deviceId =  responseObj.deviceId;\n}\n\nif (responseObj.revotioSessionId){\n    Obj.revotioSessionId =  responseObj.revotioSessionId;\n}\n\nif (responseObj.user_id){\n    Obj.user_id =  responseObj.user_id;\n}\n\nif (msg.RevotioData.userData){\n    Obj.userData =  msg.RevotioData.userData;\n}\n\nif (responseObj.Page){\n    Obj.Page =  responseObj.Page;\n}\n\nif (typeof msg.responseObj.RevotioData === 'object'){\n    Obj.FlowData = msg.responseObj.RevotioData\n    Obj.FlowData.Data  = {}\n} else {\n     Obj.FlowData = {Data:{}}\n}\nObj.FlowData.page_session_id = new ObjectID()\n\n\n\nif (responseObj.presentationLayer && responseObj.presentationLayer.container && responseObj.presentationLayer.container !== null){\n    Obj.container =  responseObj.presentationLayer.container;\n}\n\nupdateObj = {\n                    query : {\n                            query :{deviceId: responseObj.deviceId, revotioSessionId: responseObj.revotioSessionId}, \n                            update : {\"$set\" : Obj},\n                            options : {upsert: true, returnOriginal: false}\n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'sessions',\n                    operation:'findOneAndUpdate', // updateMany , updateOne\n                    }\n\n            mongodbTools.resolveAsync(updateObj, node, function(res){\n                \n                if (typeof res === 'object' && res.hasOwnProperty(\"value\")){\n                    \n                     msg.payload = res.value\n                     \n                } else {\n                    msg.payload = {};\n                }\n                \n                // update    \n\n    updateObj = {\n                    query : {\n                            query :{_id:new ObjectID(Obj.FlowData.page_session_id)}, \n                            update : { \"$set\" : {date : new Date(), token :responseObj.token,  deviceId: responseObj.deviceId, revotioSessionId: responseObj.revotioSessionId}},\n                            options : {upsert: true}\n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'page_load_sessions',\n                    operation:'update', // updateMany , updateOne\n                    }\n\n            mongodbTools.resolveAsync(updateObj, node, function(res){\n                    // msg.payload = res\n                    node.send(msg) \n            })  \n            \n            \n            })\n                    ","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1920,"y":860,"wires":[["c2121202.789ff"]]},{"id":"c319320c.f16ce","type":"comment","z":"22428f45.8ab","name":"Initialize post","info":"Expected object :\n\n msg.payload = {\n        DeviceId: ** From publised app **,\n        RevotioSessionId : ** From publised app **,\n   }","x":130,"y":560,"wires":[]},{"id":"50eaa1a2.760b7","type":"function","z":"22428f45.8ab","name":"Prepair msg.RevotioData Obj","func":"\n\nmsg.RevotioData.session = msg.payload \nmsg.RevotioData.entity = msg.RevotioData.PostData.gadgetId\n\nif (typeof msg.payload.FlowData === 'object' ){\n    msg.RevotioData.FlowData = msg.payload.FlowData\n    delete msg.payload.FlowData\n} else {\n     msg.RevotioData.FlowData = {Data : {}}\n}\n\nmsg.RevotioData.session = msg.payload \n    \nreturn msg;","outputs":1,"noerr":0,"x":800,"y":760,"wires":[["822e5f6e.662b"]]},{"id":"be00a65c.28f788","type":"function","z":"22428f45.8ab","name":"prepair redirect to user authentication && update session object","func":"var request = global.get('request');\nvar Moment = global.get('moment');var MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar crypto = global.get('crypto');\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\nmsg.payload  = {\n    Page :global.get(\"DomainProperties.NonAuthDefaultPage\")\n}\n\n// update    \n\n    updateObj = {\n                    query : {\n                            query :{\n                                    revotioSessionId:msg.RevotioData.session.revotioSessionId, \n                                    deviceId : msg.RevotioData.session.deviceId\n                            }, \n                            update : { \"$set\" : msg.RevotioData.session},\n                            options : {upsert: true}\n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'sessions',\n                    operation:'update', // updateMany , updateOne\n                    }\n\n            mongodbTools.resolveAsync(updateObj, node, function(res){\n                   \n                    node.send(msg) \n            })  \n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1930,"y":260,"wires":[["45278fd1.18e39"]]},{"id":"43520b5c.2da5e4","type":"function","z":"22428f45.8ab","name":"Set msg.token","func":"\nmsg.token = msg.payload.token\n\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":260,"y":260,"wires":[["358ba198.43c70e"]]},{"id":"414fbb78.f981c4","type":"function","z":"22428f45.8ab","name":"prepair redirect to user authentication","func":"msg.payload  = {\n    Page :\"user account activation\",\n    RevotioData: {\n        activationToken :  msg.RevotioData.session.activationToken\n    }\n}\nreturn msg;","outputs":1,"noerr":0,"x":1050,"y":360,"wires":[["d890936b.19c77"]]},{"id":"e28da19.5cad66","type":"function","z":"22428f45.8ab","name":"Check if token is valid - Action","func":"var jsonwebtoken = global.get('jsonwebtoken');\nvar secret = global.get(\"SystemVars.secret\");\n\nvar valid,  invalid, validNoSession;\n\n\n// verify a token symmetric\njsonwebtoken.verify(msg.RevotioData.session.token, global.get(\"SystemVars.secret\"), function(err, decoded) {\n      if (decoded !== undefined){\n          if (msg.payload.hasOwnProperty(\"_id\")){\n                valid = msg;\n          }else{\n                validNoSession = msg;\n          }\n          \n      } else {\n          invalid = msg;\n      }\n    });\n    \n  \n    \n    \nreturn [valid, invalid, validNoSession];","outputs":3,"noerr":0,"x":530,"y":780,"wires":[["50eaa1a2.760b7"],["7bab6a6a.1cae04"],["8873bf3d.db5de"]],"outputLabels":["valid","invalid","validNoSession"]},{"id":"7bab6a6a.1cae04","type":"function","z":"22428f45.8ab","name":"Redirect to user authentication","func":"msg.payload  = {\n    Page :\"user authentication\"\n}\nreturn msg;","outputs":1,"noerr":0,"x":810,"y":800,"wires":[["534fed46.ceb0f4"]]},{"id":"91f18bc9.521138","type":"function","z":"22428f45.8ab","name":"Check if token is valid - INIT","func":"var jsonwebtoken = global.get('jsonwebtoken');\nvar secret = global.get(\"SystemVars.secret\");\nvar request = global.get('request');\nvar Moment = global.get('moment');var MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\nvar valid, invalid;\n//  get session\nmsg.starttime = new Date()\n\n\nmsg.INIT = JSON.parse(msg.dataResult.dataContent.RevotioData);\nvar query =\n    {deviceId : msg.payload.deviceId, \n    revotioSessionId:msg.payload.revotioSessionId}\n\n// msg.operation = 'findOne'\n\n// find  \nfindObj = {\n                    query : {\n                            query :query, \n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'sessions',\n                    operation:'find',\n                    }\n\n            mongodbTools.resolveAsync(findObj, node, function(res){\n                if (res.length > 0){\n                     msg.payload = res[0]\n                } else {\n                    msg.payload  = {}\n                }\n                    node.send(msg) \n            })   \n\n\n\n// // verify a token symmetric\n// jsonwebtoken.verify(msg.INIT.token, global.get(\"SystemVars.secret\"), function(err, decoded) {\n//       if (decoded !== undefined){\n//         valid = msg;\n//       } else {\n//           invalid = msg;\n//       }\n//     });\n    \n  \n    \n    \n// return [valid, invalid];","outputs":1,"noerr":0,"initialize":"","finalize":"","x":380,"y":600,"wires":[["28c05ee6.7acc72"]],"outputLabels":["valid"]},{"id":"e450621c.319d","type":"function","z":"22428f45.8ab","name":"prepair redirect to reset ","func":"msg.payload  = {\n    Page :'reset password',\n    RevotioData:{\n        resetToken : msg.RevotioData.session.resetToken\n    }\n}\nreturn msg;","outputs":1,"noerr":0,"x":1010,"y":400,"wires":[["d890936b.19c77"]]},{"id":"8258e7f0.7010b8","type":"function","z":"22428f45.8ab","name":"Decrypt token","func":"var request = global.get('request');\nvar Moment = global.get('moment');var MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar crypto = global.get('crypto');\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\nvar tokenState\n\n// Decrypt token\n    jsonwebtoken.verify(msg.RevotioData.session.token, global.get(\"SystemVars.secret\"), function(err, decoded) {\n      if (decoded !== undefined){\n          tokenState = \"valid\"\n          TokenContent = decoded\n      }\n    });\n                \nmsg.RevotioData.session.user_id = new ObjectID(TokenContent.user_id);\n\nmsg.RevotioData.applicationId = new ObjectID(global.get(\"applicationId\"));\n\nmsg.payload = {\n    deviceId: msg.RevotioData.session.deviceId,\n    revotioSessionId :msg.RevotioData.session.revotioSessionId,\n};\n\nmsg.operation = 'findOne'\n\n// get last session\nfindOneObj = {\n                    query : {\n                            query :{\"UserData._id\": new ObjectID(msg.RevotioData.session.user_id)} \n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'sessions',\n                    operation:'find',\n                    }\n\n            mongodbTools.resolveAsync(findOneObj, node, function(res){\n                if (res.length > 0){\n                    msg.RevotioData.userSession = res[0]\n                } \n                \n                else {\n                     msg.RevotioData.userSession = res\n                }\n                    \n                    node.send(msg) \n            })  \n\n\n// return msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":980,"y":320,"wires":[["7e246bb3.a4bdc4"]]},{"id":"a568dd87.1b6dc","type":"function","z":"22428f45.8ab","name":"Prepair redirect","func":"// Get libraries\nconst Moment = global.get('moment');\nconst MomentRange = global.get('momentrange');\nconst moment = MomentRange.extendMoment(Moment)\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting'); \nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\n\nvar client , partner, prospect, error;\n\n\nif (msg.RevotioData.session &&\n    msg.RevotioData.session.permission &&\n    msg.RevotioData.session.permission.organizationData &&\n    msg.RevotioData.session.permission.organizationData.type){\n\n        if ( msg.RevotioData.session.permission.organizationData.type === \"client\"){\n        \n        client = msg;\n        \n        } else if ( msg.RevotioData.session.permission.organizationData.type === \"partner\"){\n        \n        partner = msg;\n        \n        \n        } else if ( msg.RevotioData.session.permission.organizationData.type === \"Master\"){\n        \n        client = msg;\n        \n        } else {\n        \n            prospect = msg;\n            \n        } \n}else {\n    error = msg\n}\n\n   \n\n\n\nreturn [client , partner, prospect, error];","outputs":4,"noerr":0,"x":1500,"y":320,"wires":[["98133071.a2f0d","22a7057b.fcb6ba"],["dd649bf4.cbffb8"],["be00a65c.28f788"],["62109c28.38f404"]],"outputLabels":["client","partner","prospect","error"]},{"id":"dd649bf4.cbffb8","type":"function","z":"22428f45.8ab","name":"Check user inv","func":"var request = global.get('request');\nvar Moment = global.get('moment');var MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\n\n\nreturn msg;","outputs":1,"noerr":0,"x":1820,"y":360,"wires":[["4324a1f8.df305"]],"outputLabels":["resume, "]},{"id":"39e92084.90cc6","type":"function","z":"22428f45.8ab","name":"Permission check 2/3","func":"var request = global.get('request');\nvar Moment = global.get('moment');var MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\nif (!msg.RevotioData.session.UserData){\n    msg.RevotioData.session.UserData = {}\n}\n\nmsg.RevotioData.session.UserData.OrgRepresentativeProjects = msg.payload;\n\nprojects = []\n_.each(msg.RevotioData.session.UserData.OrgRepresentativeProjects, function(projectItem,projectItemIndex ){\n    projects.push(new ObjectID(projectItem.project_id))\n})\n\nvar query = { _id :{\"$in\":projects}} ;\n\nfindObj = {\n                    query : {\n                            query :query, \n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'projects',\n                    operation:'find',\n                    }\n\n            mongodbTools.resolveAsync(findObj, node, function(res){\n                    msg.payload = res\n                    node.send(msg) \n            })   \n\n// return msg;","outputs":1,"noerr":0,"x":2240,"y":360,"wires":[["fae60a3c.dc9ff8"]]},{"id":"fae60a3c.dc9ff8","type":"function","z":"22428f45.8ab","name":"Permission check 3/3","func":"// Get libraries\nconst Moment = global.get('moment');\nconst MomentRange = global.get('momentrange');\nconst moment = MomentRange.extendMoment(Moment);\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\n\nif (!msg.RevotioData.FlowData){\n    msg.RevotioData.FlowData = {}\n}\n        \n    msg.RevotioData.FlowData.Page = global.get(\"DomainProperties.ClientDefaultPage\")\n    msg.RevotioData.FlowData.organization_id =  msg.RevotioData.session.permission.organizationData._id;\n\n         \n\n\n\n            msg.payload = {\n                    Page :msg.RevotioData.FlowData.Page ,\n                    RevotioData         : {\n                        organization_id :  msg.RevotioData.session.permission.organizationData._id\n                    }\n                }\n\n\nreturn msg;","outputs":1,"noerr":0,"x":2460,"y":360,"wires":[["98133071.a2f0d","22a7057b.fcb6ba"]]},{"id":"c2121202.789ff","type":"function","z":"22428f45.8ab","name":"manage file system - Manage FS","func":"if (msg.payload.hasOwnProperty(\"value\") && msg.payload.value !== null){\n\nmsg.RevotioData.session._id = msg.payload.value._id\nmsg.RevotioData.session.container = msg.payload.value.container\n\nresult = global.get(\"functions.fileManagement\")( '', '',msg.RevotioData.session._id, \"initSessionFolder\") // source, destination, operation\n\nresult = global.get(\"functions.fileManagement\")( '', '',msg.RevotioData.session._id, \"emptyDirSync\") // source, destination, operation\n\n\nif (result.state === \"success\"){\n    \n} else {\n    \n}\n}\n\nmsg.payload = msg.responseObj;\nmsg.payload.Type = \"Redirect\";\nmsg.headers = {\n    'Access-Control-Allow-Origin': '*',\n    'Access-Control-Allow-Methods': 'PUT,GET,POST,DELETE,OPTIONS',\n    'Access-Control-Allow-Headers': 'Content-Type',\n    'content-type': 'application/json',\n};\n\nreturn msg;","outputs":1,"noerr":0,"x":2080,"y":920,"wires":[["41ffde50.902ca"]]},{"id":"ac1b812a.32ef3","type":"comment","z":"22428f45.8ab","name":"Action post","info":"Expected object :\n\n msg.payload = {\n        DeviceId: ** From publised app **,\n        RevotioSessionId : ** From publised app **,\n   }","x":110,"y":740,"wires":[]},{"id":"d4600974.fefad8","type":"function","z":"22428f45.8ab","name":"create request ****TEMP FIX**** INIT","func":"// Get libraries\nconst Moment = global.get('moment');\nconst MomentRange = global.get('momentrange');\nconst moment = MomentRange.extendMoment(Moment)\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting'); \nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\n\nmessage = {\n    \n    RevotioData: msg.RevotioData,\n    payload : msg.payload,\n    starttime : msg.starttime\n}\nid = new ObjectID()\n// msg = {}\n\nmsg.payload = [{ _id: id},\n    {requestData : message},\n    {upsert : true}\n]\n\nmsg.operation = \"updateOne\"\n\n\nfunction capitalizeFirstLetter(str) {\n  return str.charAt(0).toUpperCase() + str.slice(1);\n}\n\n\nif (msg.RevotioData.session.container && msg.RevotioData.session.container !== null && global.get(\"DomainProperties.routing\") &&  global.get(\"DomainProperties.routing\") !== \"local\"){\n// ******************************************************************\n    msg.url =  msg.RevotioData.session.container + \"/\"\n   \n// ******************************************************************\n} else {\n    msg.url = global.get(\"DomainProperties.url\") +\"/\"\n}\nif (message.RevotioData.session.hasOwnProperty(\"Page\")){\n   _.each(message.RevotioData.session.Page.replace(/[^\\w\\s]/gi,\"\").split(\" \"), function(value, index){\n    msg.url = msg.url + capitalizeFirstLetter(value);\n}) \n} else if (message.RevotioData.hasOwnProperty(\"init\") && \n        message.RevotioData.init.hasOwnProperty(\"Page\") ){\n       _.each( message.RevotioData.init.Page.replace(/[^\\w\\s]/gi,\"\").split(\" \"), function(value, index){\n            msg.url = msg.url + capitalizeFirstLetter(value);\n        })\n} \n        \n        \n\n\n// msg.url = message.RevotioData.session.Page.replace(/ /g, '');\n\n\n\n\nmsg.requestPayload = {id:id, type :\"init\", data :message}\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":890,"y":600,"wires":[["89fafe6e.d4c59"]]},{"id":"6ab5c826.324318","type":"http request","z":"22428f45.8ab","name":"","method":"POST","ret":"txt","paytoqs":false,"url":"","tls":"","proxy":"","authType":"basic","x":1270,"y":600,"wires":[["3ed9f7bb.ee86e8"]]},{"id":"89fafe6e.d4c59","type":"function","z":"22428f45.8ab","name":"create request","func":"// Get libraries\nconst Moment = global.get('moment');\nconst MomentRange = global.get('momentrange');\nconst moment = MomentRange.extendMoment(Moment)\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting'); \nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\n\n\nmsg.payload = msg.requestPayload\n\n\nreturn msg;","outputs":1,"noerr":0,"x":1100,"y":600,"wires":[["6ab5c826.324318","8eb478dc.adf1e8"]]},{"id":"3ed9f7bb.ee86e8","type":"json","z":"22428f45.8ab","name":"Post INIT request","property":"payload","action":"","pretty":false,"x":1430,"y":600,"wires":[["99986e5d.dcdfb"]]},{"id":"99986e5d.dcdfb","type":"http response","z":"22428f45.8ab","name":"","statusCode":"","headers":{},"x":1570,"y":600,"wires":[]},{"id":"586893fe.fa4a9c","type":"http request","z":"22428f45.8ab","name":"","method":"POST","ret":"txt","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"basic","x":2790,"y":920,"wires":[["1ea620e9.25d94f"]]},{"id":"32ecb9e7.055c96","type":"function","z":"22428f45.8ab","name":"create request","func":"// Get libraries\nconst Moment = global.get('moment');\nconst MomentRange = global.get('momentrange');\nconst moment = MomentRange.extendMoment(Moment)\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting'); \nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\n\n\nmsg.payload = msg.requestPayload\n\n\nreturn msg;","outputs":1,"noerr":0,"x":2640,"y":920,"wires":[["586893fe.fa4a9c","eeabaf73.14d32"]]},{"id":"1ea620e9.25d94f","type":"json","z":"22428f45.8ab","name":"Post redirect request","property":"payload","action":"","pretty":false,"x":3060,"y":900,"wires":[["ac2bdb01.167c78","639c54a7.45bdac"]]},{"id":"ac2bdb01.167c78","type":"http response","z":"22428f45.8ab","name":"","statusCode":"","headers":{},"x":3090,"y":1080,"wires":[]},{"id":"22e61321.b47d2c","type":"http request","z":"22428f45.8ab","name":"","method":"POST","ret":"txt","paytoqs":false,"url":"","tls":"","proxy":"","authType":"basic","x":1510,"y":760,"wires":[["d0e2cdc0.f2986"]]},{"id":"12657b3a.3f8365","type":"function","z":"22428f45.8ab","name":"create request","func":"// Get libraries\nconst Moment = global.get('moment');\nconst MomentRange = global.get('momentrange');\nconst moment = MomentRange.extendMoment(Moment)\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting'); \nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\n\n\nmsg.payload = msg.requestPayload\n\n\nreturn msg;","outputs":1,"noerr":0,"x":1320,"y":760,"wires":[["22e61321.b47d2c","4bb16b7e.2206a4"]]},{"id":"d0e2cdc0.f2986","type":"json","z":"22428f45.8ab","name":"Post action request","property":"payload","action":"","pretty":false,"x":1670,"y":760,"wires":[["e438a44d.9aaed8"]]},{"id":"e438a44d.9aaed8","type":"http response","z":"22428f45.8ab","name":"","statusCode":"","headers":{},"x":1810,"y":760,"wires":[]},{"id":"822e5f6e.662b","type":"function","z":"22428f45.8ab","name":"create request ****TEMP FIX**** ACTION","func":"// Get libraries\nconst Moment = global.get('moment');\nconst MomentRange = global.get('momentrange');\nconst moment = MomentRange.extendMoment(Moment)\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting'); \nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\n\nmessage = {\n    RevotioData: msg.RevotioData,\n    payload : msg.payload,\n    starttime : msg.starttime\n}\nid = new ObjectID()\n// msg = {}\n\nmsg.payload = [{ _id: id},\n    {requestData : message},\n    {upsert : true}\n]\n\nmsg.operation = \"updateOne\"\n\n\nfunction capitalizeFirstLetter(str) {\n  return str.charAt(0).toUpperCase() + str.slice(1);\n}\n\n\nif (msg.RevotioData.session.container && msg.RevotioData.session.container !== null && global.get(\"DomainProperties.routing\") &&  global.get(\"DomainProperties.routing\") !== \"local\"){\n// ******************************************************************\n    msg.url = msg.RevotioData.session.container + \"/\"\n\n// ******************************************************************\n} else {\n    msg.url = global.get(\"DomainProperties.url\") +\"/\"\n}\n\n_.each(message.payload.Page.replace(/[^\\w\\s]/gi,\"\").split(\" \"), function(value, index){\n    msg.url = msg.url + capitalizeFirstLetter(value);\n})\n\n\n// msg.url = message.RevotioData.session.Page.replace(/ /g, '');\n\n\n\n\nmsg.requestPayload = {id:id, type :\"action\", data :message}\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1080,"y":760,"wires":[["12657b3a.3f8365"]]},{"id":"41ffde50.902ca","type":"function","z":"22428f45.8ab","name":"create request ****TEMP FIX**** REDIRECT","func":"// Get libraries\nconst Moment = global.get('moment');\nconst MomentRange = global.get('momentrange');\nconst moment = MomentRange.extendMoment(Moment)\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting'); \nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\n\n\nmessage = {\n    // RevotioData: msg.RevotioData,\n    payload : msg.payload\n}\n\n// _.each(msg.payload, function(Item, key){\n    \n//     if (typeof Item === \"object\"){\n//         message[key] = {}\n//     } else {\n//         message[key] = Item\n//     }\n// })\nid = new ObjectID()\n// msg = {}\n\n// msg.payload = [{ _id: id},\n//     {requestData : message},\n//     {upsert : true}\n// ]\n\n// msg.operation = \"updateOne\"\n\n\nfunction capitalizeFirstLetter(str) {\n  return str.charAt(0).toUpperCase() + str.slice(1);\n}\n\nif (msg.payload.hasOwnProperty(\"presentationLayer\") === true && msg.payload.presentationLayer.hasOwnProperty(\"container\") === true && msg.RevotioData.session.container !== null  && global.get(\"DomainProperties.routing\") &&  global.get(\"DomainProperties.routing\") !== \"local\"){\n  msg.url =message.payload.presentationLayer.container + \"/\"\n\n} else {\n    msg.url = global.get(\"DomainProperties.url\") +\"/\"\n}\n\n\n_.each(message.payload.Page.replace(/[^\\w\\s]/gi,\"\").split(\" \"), function(value, index){\n    msg.url = msg.url + capitalizeFirstLetter(value);\n})\n\n//  msg.url.replace(/-/, \"\")\n\n// msg.url = message.RevotioData.session.Page.replace(/ /g, '');\n\n\n\n\nmsg.requestPayload = {id:id, type :\"design\", data : message}\n\nreturn msg;","outputs":1,"noerr":0,"x":2390,"y":920,"wires":[["32ecb9e7.055c96"]]},{"id":"64af574f.98bfc8","type":"http in","z":"22428f45.8ab","name":"redirect","url":"/redirect","method":"post","upload":false,"swaggerDoc":"","x":90,"y":920,"wires":[["68c3fc9b.be0a54"]]},{"id":"68c3fc9b.be0a54","type":"function","z":"22428f45.8ab","name":"Setup msg object","func":"// Get libraries\nconst Moment = global.get('moment');\nconst MomentRange = global.get('momentrange');\nconst moment = MomentRange.extendMoment(Moment)\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting'); \nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\n\n\npayload = msg.payload ;\n\ndelete msg.payload ;\n\n_.each(payload, function(value, key){\n    // if (typeof value ===  'string'){\n    //     msg[key] = value.trim()\n    // } else {\n        msg[key] = value\n    // }\n})\nreturn msg;","outputs":1,"noerr":0,"x":230,"y":920,"wires":[["5abccab0.40a034"]]},{"id":"6e4ddf7c.7028e","type":"comment","z":"22428f45.8ab","name":"Global gadgets","info":"","x":100,"y":1600,"wires":[]},{"id":"c3c61d5b.a60c1","type":"function","z":"22428f45.8ab","name":"Trigger remove actions per entity","func":"// Get libraries\nconst Moment = global.get('moment');\nconst MomentRange = global.get('momentrange');\nconst moment = MomentRange.extendMoment(Moment);\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\n\n\n// delete all sub entities first\n_.each(msg.payload,function(SubItem, SubIndex){\n    msg.organization_id = new ObjectID(SubItem._id)\n    node.send(msg)\n} )\n\n// continue with main entity removal\n\n// return msg;","outputs":1,"noerr":0,"x":1160,"y":1660,"wires":[["9cc33062.f4863","b8db24fd.dacbe8","a158228d.87d82","b2174cdf.41a82","7efed04a.a697c"]]},{"id":"9cc33062.f4863","type":"function","z":"22428f45.8ab","name":"Get all org's participants ","func":"var request = global.get('request');\nvar Moment = global.get('moment');var MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\nvar query = {organization_id : new ObjectID(msg.organization_id)}\nmsg.done = false\n // find  \nfindObj = {\n                    query : {\n                            query :query, \n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'participants',\n                    operation:'find',\n                    }\n\n            mongodbTools.resolveAsync(findObj, node, function(res){\n\n                    GroupedByProjects = lodash.groupBy(res, 'project_id')\n\n                    _.each(GroupedByProjects, function(ProjectArray, project_id){\n                            // find  \n                            findObj = {\n                                        query : {\n                                                query :{project_id :new ObjectID(project_id), type : \"project\"}, \n                                                },\n                                        connection:global.get(\"DB_data.connection\"),\n                                        database:global.get(\"DB_data.appDB\"),\n                                        collection:'participants',\n                                        operation:'find',\n                                        }\n                            \n                                        mongodbTools.resolveAsync(findObj, node, function(res){\n                                            \n                                                if (res.length > 0 ){\n                                                    state = false\n                                                    _.each(res, function(participantItem, participantItemIndex){\n                                                        if (participantItem.hasOwnProperty(organization_id) &&\n                                                           String(participantItem.organization_id) !== String(msg.organization_id)){\n                                                                    state = true\n                                                                }\n                                                    })\n                                                    \n                                                    if (state === false ){\n                                                         msg.payload = {project_id : project_id}\n                                                         node.send(msg)\n                                                    }\n                                                } else {\n                                                    msg.payload = {project_id : project_id}\n                                                    node.send(msg)\n                                                }\n                                        })   \n                        })\n                    msg.done = true\n                    node.send(msg) \n            }) \n","outputs":1,"noerr":0,"x":1450,"y":1660,"wires":[["49f94e2e.aea01","57016505.1fe21c"]]},{"id":"49f94e2e.aea01","type":"function","z":"22428f45.8ab","name":"Trigger delete project data","func":"// Get libraries\nconst Moment = global.get('moment');\nconst MomentRange = global.get('momentrange');\nconst moment = MomentRange.extendMoment(Moment);\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\n\nif (msg.done === false ){\n    node.send(msg)\n}\n","outputs":1,"noerr":0,"x":1800,"y":1620,"wires":[["149fd266.f5eb8e"]]},{"id":"57016505.1fe21c","type":"function","z":"22428f45.8ab","name":"Remove all participants records","func":"var request = global.get('request');\nvar Moment = global.get('moment');var MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\nif (msg.done === true){\n// remove \n            removeObj = {\n                    query : {\n                            query :{organization_id:new ObjectID(msg.organization_id)}, \n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'participants',\n                    operation:'remove',\n                    }\n\n            mongodbTools.resolveAsync(removeObj, node, function(res){\n                    msg.result = res\n                    node.send(msg) \n            }) \n}\n// return msg;","outputs":1,"noerr":0,"x":1810,"y":1660,"wires":[[]]},{"id":"dffc6582.288718","type":"function","z":"22428f45.8ab","name":"check if msg.organization_id is present and prepair child lookup","func":"var BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\n\n\nvar valid, invalid\nif (msg.payload.hasOwnProperty(\"organization_id\")){\n\n    payload = {\"$or\": [{parent_id : new ObjectID(msg.payload.organization_id)}, {_id : new ObjectID(msg.payload.organization_id)} ] }\n    msg.operation = 'find.toArray'\n    msg.payload = payload\n    valid = msg\n} else {\n    invalid = msg\n}\n\nreturn [valid, invalid]","outputs":2,"noerr":0,"x":590,"y":1680,"wires":[["f6eefc54.fc37c"],["365a5f20.a86b5"]],"outputLabels":["valid, ","invalid"]},{"id":"50304bb2.49eea4","type":"comment","z":"22428f45.8ab","name":"Delete all organization Data","info":"","x":220,"y":1640,"wires":[]},{"id":"bf3bde62.30336","type":"link in","z":"22428f45.8ab","name":"Delete all organization Data","links":["755fb71d.d2028","bfc74af8.6937b"],"x":355,"y":1640,"wires":[["dffc6582.288718"]]},{"id":"12193ffb.13a1c","type":"function","z":"22428f45.8ab","name":"Get all project WP's","func":"var request = global.get('request');\nvar Moment = global.get('moment');var MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\n\n// find  \nfindObj = {\n                    query : {\n                            query : {\tproject_id : new ObjectID(msg.payload.project_id)},\n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'work_packages',\n                    operation:'find',\n                    }\n\n            mongodbTools.resolveAsync(findObj, node, function(res){\n                    msg.payload = res\n                    node.send(msg) \n            })  \n// return msg;","outputs":1,"noerr":0,"x":940,"y":1740,"wires":[["d28d462b.e1b878"]]},{"id":"77df955.b71eb6c","type":"comment","z":"22428f45.8ab","name":"Delete all project data","info":"","x":240,"y":1760,"wires":[]},{"id":"c797a7a6.1f3fc8","type":"link in","z":"22428f45.8ab","name":"Delete all project data","links":["149fd266.f5eb8e","b298aff4.badb78","e9fb6492.5b068"],"x":335,"y":1760,"wires":[["9355e507.c564b8"]]},{"id":"a50c82cc.286c7","type":"function","z":"22428f45.8ab","name":"Libs","func":"// Get libraries\nconst Moment = global.get('moment');\nconst MomentRange = global.get('momentrange');\nconst moment = MomentRange.extendMoment(Moment);\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\n\nif ( Array.isArray(msg.payload)){\n   _.each(msg.payload, function(Item, Index){\n    \n    msg.work_package_id = Item._id\n    node.send(msg);\n    \n    \n}); \n} else if (msg.payload.hasOwnProperty(\"work_package_id\")) {\n    msg.work_package_id = msg.payload.work_package_id\n    node.send(msg);\n} else{\n      msg.work_package_id = msg.payload._id\n    node.send(msg);\n}\n\n\n\n// return msg;","outputs":1,"noerr":0,"x":390,"y":1880,"wires":[["cfe71090.7a22d"]]},{"id":"f452512d.9e37f","type":"comment","z":"22428f45.8ab","name":"Remove all wp data","info":"","x":210,"y":1840,"wires":[]},{"id":"d3c8d505.589408","type":"link in","z":"22428f45.8ab","name":"Remove all wp data","links":["d28d462b.e1b878","5bc91a39.2b348c","cf312f50.45a118","148a291d.254577"],"x":315,"y":1840,"wires":[["a50c82cc.286c7"]]},{"id":"149fd266.f5eb8e","type":"link out","z":"22428f45.8ab","name":"","links":["c797a7a6.1f3fc8"],"x":1935,"y":1620,"wires":[]},{"id":"d28d462b.e1b878","type":"link out","z":"22428f45.8ab","name":"","links":["d3c8d505.589408"],"x":1055,"y":1740,"wires":[]},{"id":"b8db24fd.dacbe8","type":"function","z":"22428f45.8ab","name":"Remove all with organization_id","func":"var request = global.get('request');\nvar Moment = global.get('moment');var MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\nvar query= {organization_id : new ObjectID(msg.organization_id)}\n \n // removequery\n            settings = {\n                    query : {\n                            query :query, \n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'settings',\n                    operation:'remove',\n                    }\n\n            mongodbTools.resolveAsync(settings, node, function(res){\n                   \n            })  \n            \n // removetime_sheet_records\n            time_sheet_records = {\n                    query : {\n                            query :query, \n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'time_sheet_records',\n                    operation:'remove',\n                    }\n\n            mongodbTools.resolveAsync(time_sheet_records, node, function(res){\n                   \n            })  \n            \n // removequery\n            salary_data = {\n                    query : {\n                            query :query, \n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'salary_data',\n                    operation:'remove',\n                    }\n\n            mongodbTools.resolveAsync(salary_data, node, function(res){\n                   \n            })  \n            \n            \n // removequery\n            organization_records = {\n                    query : {\n                            query :query, \n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'organization_records',\n                    operation:'remove',\n                    }\n\n            mongodbTools.resolveAsync(organization_records, node, function(res){\n                   \n            })  \n            \n            \n // removequery\n            file_import_records = {\n                    query : {\n                            query :query, \n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'file_import_records',\n                    operation:'remove',\n                    }\n\n            mongodbTools.resolveAsync(file_import_records, node, function(res){\n                   \n            })  \n            \n            \n // removequery\n            events = {\n                    query : {\n                            query :query, \n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'events',\n                    operation:'remove',\n                    }\n\n            mongodbTools.resolveAsync(events, node, function(res){\n                   \n            })  \n","outputs":1,"noerr":0,"x":1470,"y":1700,"wires":[[]]},{"id":"1eb336ea.ac0f39","type":"function","z":"22428f45.8ab","name":"Remove all employee records","func":"var request = global.get('request');\nvar Moment = global.get('moment');var MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n \n\n\nquery = {employee_id: new ObjectID(msg.payload.employee_id)}\n\n\n // removequery\n            employee_cost_cal = {\n                    query : {\n                            query :query, \n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'employee_cost_cal',\n                    operation:'remove',\n                    }\n\n            mongodbTools.resolveAsync(employee_cost_cal, node, function(res){\n                // removequery\n                                    employee_cost = {\n                                            query : {\n                                                    query :query, \n                                                    },\n                                            connection:global.get(\"DB_data.connection\"),\n                                            database:global.get(\"DB_data.appDB\"),\n                                            collection:'employee_cost',\n                                            operation:'remove',\n                                            }\n                            \n                                        mongodbTools.resolveAsync(employee_cost, node, function(res){\n                                         // removequery\n                                                    employee_department_involvement = {\n                                                            query : {\n                                                                    query :query, \n                                                                    },\n                                                            connection:global.get(\"DB_data.connection\"),\n                                                            database:global.get(\"DB_data.appDB\"),\n                                                            collection:'employee_department_involvement',\n                                                            operation:'remove',\n                                                            }\n                                        \n                                                    mongodbTools.resolveAsync(employee_department_involvement, node, function(res){\n                                                        // removequery\n                                                            employee_involvement = {\n                                                                    query : {\n                                                                            query :query, \n                                                                            },\n                                                                    connection:global.get(\"DB_data.connection\"),\n                                                                    database:global.get(\"DB_data.appDB\"),\n                                                                    collection:'employee_involvement',\n                                                                    operation:'remove',\n                                                                    }\n                                                \n                                                            mongodbTools.resolveAsync(employee_involvement, node, function(res){\n                                                         // removequery\n                                                            members = {\n                                                                    query : {\n                                                                            query :query, \n                                                                            },\n                                                                    connection:global.get(\"DB_data.connection\"),\n                                                                    database:global.get(\"DB_data.appDB\"),\n                                                                    collection:'members',\n                                                                    operation:'remove',\n                                                                    }\n                                                \n                                                            mongodbTools.resolveAsync(members, node, function(res){\n                                                                // removequery\n                                                                    employee = {\n                                                                            query : {\n                                                                                    query :{_id : new ObjectID(query.employee_id)}, \n                                                                                    },\n                                                                            connection:global.get(\"DB_data.connection\"),\n                                                                            database:global.get(\"DB_data.appDB\"),\n                                                                            collection:'employee',\n                                                                            operation:'remove',\n                                                                            }\n                                                        \n                                                                    mongodbTools.resolveAsync(employee, node, function(res){\n                                                                           node.send(msg)\n                                                                    })   \n                                                            }) \n                                                    })\n                                        }) \n                            })  \n            })  \n  \n                    \n\n\n            \n\n\n\n\n            \n","outputs":1,"noerr":0,"x":470,"y":1960,"wires":[["9f168e2b.14869"]]},{"id":"fa3bdcb8.acff5","type":"comment","z":"22428f45.8ab","name":"Remove all employee data","info":"","x":190,"y":1920,"wires":[]},{"id":"1df715f3.e1249a","type":"link in","z":"22428f45.8ab","name":"Remove all employee data","links":["ebc5286.2020ad8","ec0700d4.b0391"],"x":315,"y":1920,"wires":[["1eb336ea.ac0f39"]]},{"id":"a158228d.87d82","type":"function","z":"22428f45.8ab","name":"Get all employee","func":"var request = global.get('request');\nvar Moment = global.get('moment');var MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\n // find  \nfindObj = {\n                    query : {\n                            query :{organization_id : new ObjectID(msg.organization_id)}, \n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'employee',\n                    operation:'find',\n                    }\n\n            mongodbTools.resolveAsync(findObj, node, function(res){\n                    msg.payload  = res\n                    node.send(msg) \n            }) \n// return msg;","outputs":1,"noerr":0,"x":1430,"y":1740,"wires":[["ed7338a3.cb3008"]]},{"id":"ed7338a3.cb3008","type":"function","z":"22428f45.8ab","name":"check if employee exists","func":"var request = global.get('request');\nvar Moment = global.get('moment');var MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\n\n\nif (msg.payload.length > 0){\n    _.each(msg.payload, function(Item, Index){\n        node.send({payload: {employee_id : Item._id}})\n    })\n} \n\n// return msg;","outputs":1,"noerr":0,"x":1630,"y":1740,"wires":[["ebc5286.2020ad8"]]},{"id":"ebc5286.2020ad8","type":"link out","z":"22428f45.8ab","name":"","links":["1df715f3.e1249a"],"x":1755,"y":1740,"wires":[]},{"id":"ef2e1e19.d2dd9","type":"http in","z":"22428f45.8ab","name":"removeOrganization","url":"/removeOrganization","method":"post","upload":false,"swaggerDoc":"","x":270,"y":1680,"wires":[["dffc6582.288718"]]},{"id":"5f3bcf7d.f4aa5","type":"http in","z":"22428f45.8ab","name":"removeProject","url":"/removeProject","method":"post","upload":false,"swaggerDoc":"","x":270,"y":1800,"wires":[["9355e507.c564b8"]]},{"id":"ac771839.18ab68","type":"http in","z":"22428f45.8ab","name":"removeWorkPackage","url":"/removeWorkPackage","method":"post","upload":false,"swaggerDoc":"","x":240,"y":1880,"wires":[["a50c82cc.286c7"]]},{"id":"26381dab.c32ea2","type":"http in","z":"22428f45.8ab","name":"removeEmployee","url":"/removeEmployee","method":"post","upload":false,"swaggerDoc":"","x":260,"y":1960,"wires":[["1eb336ea.ac0f39"]]},{"id":"9f168e2b.14869","type":"http response","z":"22428f45.8ab","name":"","statusCode":"","headers":{},"x":650,"y":1960,"wires":[]},{"id":"26a3ef3f.f39c2","type":"http response","z":"22428f45.8ab","name":"","statusCode":"","headers":{},"x":710,"y":1880,"wires":[]},{"id":"365a5f20.a86b5","type":"http response","z":"22428f45.8ab","name":"","statusCode":"","headers":{},"x":890,"y":1700,"wires":[]},{"id":"9355e507.c564b8","type":"function","z":"22428f45.8ab","name":"check if msg.project_id is present and prepair child lookup","func":"var BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\n\nvar valid, invalid\nif (msg.payload.hasOwnProperty(\"project_id\")){\n\n    // payload = {parent_id : new ObjectID(msg.payload.project_id)}\n    // msg.operation = 'find.toArray'\n    // msg.payload = payload\n    valid = msg\n} else {\n    invalid = msg\n}\n\nreturn [valid, invalid]","outputs":2,"noerr":0,"x":580,"y":1800,"wires":[["12193ffb.13a1c","b425a878.b75b38"],["1b89457d.f1d23b"]],"outputLabels":["valid, ","invalid"]},{"id":"1b89457d.f1d23b","type":"http response","z":"22428f45.8ab","name":"","statusCode":"","headers":{},"x":890,"y":1820,"wires":[]},{"id":"c6e7b89c.afd158","type":"http response","z":"22428f45.8ab","name":"","statusCode":"","headers":{},"x":1590,"y":1580,"wires":[]},{"id":"b2174cdf.41a82","type":"function","z":"22428f45.8ab","name":"Remove Organization","func":"var request = global.get('request');\nvar Moment = global.get('moment');var MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\n// remove \n            removeObj = {\n                    query : {\n                            query :{_id : new ObjectID(msg.organization_id)}, \n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'organizations',\n                    operation:'remove',\n                    }\n\n            mongodbTools.resolveAsync(removeObj, node, function(res){\n                    msg.result = res\n                    node.send(msg) \n            }) ","outputs":1,"noerr":0,"x":1440,"y":1580,"wires":[["c6e7b89c.afd158"]]},{"id":"e5326123.a02c","type":"link out","z":"22428f45.8ab","name":"","links":["dc664b4f.0d82e","561c8154.e2038"],"x":495,"y":400,"wires":[]},{"id":"ff26ef50.08ab1","type":"comment","z":"22428f45.8ab","name":"CHECK GC state","info":"","x":580,"y":400,"wires":[]},{"id":"94ed091e.5e27a8","type":"link out","z":"22428f45.8ab","name":"","links":["dc664b4f.0d82e","561c8154.e2038"],"x":295,"y":640,"wires":[]},{"id":"36ec32bb.18d62e","type":"comment","z":"22428f45.8ab","name":"CHECK GC state","info":"","x":400,"y":640,"wires":[]},{"id":"3ce52d3e.8ba9f2","type":"link out","z":"22428f45.8ab","name":"","links":["dc664b4f.0d82e","561c8154.e2038"],"x":235,"y":820,"wires":[]},{"id":"49adfa88.001214","type":"comment","z":"22428f45.8ab","name":"CHECK GC state","info":"","x":320,"y":820,"wires":[]},{"id":"6e4b6e8.51d319","type":"http in","z":"22428f45.8ab","name":"entrance","url":"/entrance","method":"post","upload":false,"swaggerDoc":"","x":120,"y":340,"wires":[["e5326123.a02c","43520b5c.2da5e4","18300eee.bc13f1"]]},{"id":"905a77be.95de78","type":"http in","z":"22428f45.8ab","name":"initialize","url":"/initialize","method":"post","upload":false,"swaggerDoc":"","x":90,"y":600,"wires":[["94ed091e.5e27a8","16987802.9cc1b8"]]},{"id":"7195cbce.e4ee04","type":"http in","z":"22428f45.8ab","name":"action","url":"/action","method":"post","upload":false,"swaggerDoc":"","x":90,"y":780,"wires":[["3ce52d3e.8ba9f2","95c91e78.e2e0d"]]},{"id":"ad02ca99.ed0958","type":"function","z":"22428f45.8ab","name":"Get session data","func":"var jsonwebtoken = global.get('jsonwebtoken');\nvar secret = global.get(\"SystemVars.secret\");\nvar request = global.get('request');\nvar Moment = global.get('moment');var MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\nvar valid, invalid;\nmsg.starttime = new Date()\n\n\nvar PostData = JSON.parse(msg.dataResult.dataContent.PostData);\n\n\n\nvar SessionData = JSON.parse(msg.dataResult.dataContent.SessionData);\n\nquery = {\n    deviceId : SessionData.deviceId,\n    revotioSessionId : SessionData.revotioSessionId,\n}\nmsg.RevotioData = {\n    SessionData:SessionData,\n    // startTime : new Date(),\n    PostData:PostData,\n    session : SessionData\n};\n// find  \nfindObj = {\n                    query : {\n                            query :query, \n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'sessions',\n                    operation:'find',\n                    }\n\n            mongodbTools.resolveAsync(findObj, node, function(res){\n                \n                if (res.length > 0 ){\n                    msg.payload = res[0]\n                } else {\n                    msg.payload = {}\n                }\n                    \n                    node.send(msg) \n            })  \n\n  \n    \n    \nreturn [valid, invalid];","outputs":1,"noerr":0,"initialize":"","finalize":"","x":290,"y":780,"wires":[["e28da19.5cad66"]]},{"id":"f6eefc54.fc37c","type":"function","z":"22428f45.8ab","name":"get organizations","func":"var request = global.get('request');\nvar Moment = global.get('moment');var MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\n    // query = {\"$or\": [{parent_id : new ObjectID(msg.payload.organization_id)}, {_id : new ObjectID(msg.payload.organization_id)} ] }\n    // msg.operation = 'find.toArray'\n                    \n                // find  \n                findObj = {\n                    query : {\n                            query :msg.payload, \n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'organizations',\n                    operation:'find',\n                    }\n\n            mongodbTools.resolveAsync(findObj, node, function(res){\n                    msg.payload = res\n                    node.send(msg) \n            })   \n\n   ","outputs":1,"noerr":0,"x":930,"y":1660,"wires":[["c3c61d5b.a60c1"]],"outputLabels":["valid, "]},{"id":"7efed04a.a697c","type":"function","z":"22428f45.8ab","name":"Remove all users && users data","func":"var request = global.get('request');\nvar Moment = global.get('moment');var MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\n// find  \nfindObj = {\n                    query : {\n                            query :{organization_id: new ObjectID(msg.organization_id)}, \n                            projection:{_id :1}\n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'user_accounts',\n                    operation:'find',\n                    }\n\n            mongodbTools.resolveAsync(findObj, node, function(res){\n                \n                _.each(res, function(user, index){\n                    \n                    // removeusers \n                        removeusers = {\n                                query : {\n                                        query :{_id:user._id}, \n                                        },\n                                connection:global.get(\"DB_data.connection\"),\n                                database:global.get(\"DB_data.appDB\"),\n                                collection:'users',\n                                operation:'remove',\n                                }\n            \n                        mongodbTools.resolveAsync(removeusers, node, function(res){\n                                \n                        }) \n                        \n                        // removeuser_accounts \n                        removeuser_accounts = {\n                                query : {\n                                        query :{user:user._id}, \n                                        },\n                                connection:global.get(\"DB_data.connection\"),\n                                database:global.get(\"DB_data.appDB\"),\n                                collection:'user_accounts',\n                                operation:'remove',\n                                }\n            \n                        mongodbTools.resolveAsync(removeuser_accounts, node, function(res){\n                                \n                        }) \n                        \n                         // removeuser_permissions\n                        removeuser_permissions = {\n                                query : {\n                                        query :{user:user._id}, \n                                        },\n                                connection:global.get(\"DB_data.connection\"),\n                                database:global.get(\"DB_data.appDB\"),\n                                collection:'user_permissions',\n                                operation:'remove',\n                                }\n            \n                        mongodbTools.resolveAsync(removeuser_permissions, node, function(res){\n                                \n                        }) \n                        \n                        // removeMembers\n                        removeMembers = {\n                                query : {\n                                        query :{user:user._id}, \n                                        },\n                                connection:global.get(\"DB_data.connection\"),\n                                database:global.get(\"DB_data.appDB\"),\n                                collection:'members',\n                                operation:'remove',\n                                }\n            \n                        mongodbTools.resolveAsync(removeMembers, node, function(res){\n                                \n                        }) \n                    \n                })\n                \n                    // msg.payload = res\n                    node.send(msg) \n            }) \n            \n// return msg;\n","outputs":1,"noerr":0,"x":1470,"y":1620,"wires":[[]]},{"id":"b425a878.b75b38","type":"function","z":"22428f45.8ab","name":"Remove all project records","func":"var request = global.get('request');\nvar Moment = global.get('moment');var MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\n // removequery\n            members = {\n                    query : {\n                            query :{project_id : new ObjectID(msg.payload.project_id)}, \n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'members',\n                    operation:'remove',\n                    }\n\n            mongodbTools.resolveAsync(members, node, function(res){\n                   \n            })  \n            \n // removeuser_permissions\n            user_permissions = {\n                    query : {\n                            query :{type_id : new ObjectID(msg.payload.project_id)}, \n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'user_permissions',\n                    operation:'remove',\n                    }\n\n            mongodbTools.resolveAsync(user_permissions, node, function(res){\n                   \n            })  \n            \n // removequery\n            projects = {\n                    query : {\n                            query :{_id : new ObjectID(msg.payload.project_id)}, \n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'projects',\n                    operation:'remove',\n                    }\n\n            mongodbTools.resolveAsync(projects, node, function(res){\n                   \n            })  \n            \n            \n // removequery\n            participants = {\n                    query : {\n                            query :{project_id : new ObjectID(msg.payload.project_id)}, \n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'participants',\n                    operation:'remove',\n                    }\n\n            mongodbTools.resolveAsync(participants, node, function(res){\n                   \n            })  \n            \n            \n // removequery\n            time_sheet_records = {\n                    query : {\n                            query :{project_id : new ObjectID(msg.payload.project_id)}, \n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'time_sheet_records',\n                    operation:'remove',\n                    }\n\n            mongodbTools.resolveAsync(time_sheet_records, node, function(res){\n                   \n            })  \n            \n            \n // removequery\n            events = {\n                    query : {\n                            query :{project_id : new ObjectID(msg.payload.project_id)}, \n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'events',\n                    operation:'remove',\n                    }\n\n            mongodbTools.resolveAsync(events, node, function(res){\n                   \n            })  \n            \n // removequery\n            transactions = {\n                    query : {\n                            query :{project_id : new ObjectID(msg.payload.project_id)}, \n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'transactions',\n                    operation:'remove',\n                    }\n\n            mongodbTools.resolveAsync(transactions, node, function(res){\n                   \n            })  \n // removequery\n            payments = {\n                    query : {\n                            query :{project_id : new ObjectID(msg.payload.project_id)}, \n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'payments',\n                    operation:'remove',\n                    }\n\n            mongodbTools.resolveAsync(payments, node, function(res){\n                   \n            })  \n\n\n\nreturn msg;\n","outputs":1,"noerr":0,"x":960,"y":1780,"wires":[["33e7fff3.45dd"]]},{"id":"33e7fff3.45dd","type":"http response","z":"22428f45.8ab","name":"","statusCode":"","headers":{},"x":1130,"y":1780,"wires":[]},{"id":"cfe71090.7a22d","type":"function","z":"22428f45.8ab","name":"Remove all WP records","func":"var request = global.get('request');\nvar Moment = global.get('moment');var MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n \n\n // removeuser_permissions\n            user_permissions = {\n                    query : {\n                            query :{type_id : new ObjectID(msg.work_package_id)}, \n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'user_permissions',\n                    operation:'remove',\n                    }\n\n            mongodbTools.resolveAsync(user_permissions, node, function(res){\n                   \n            })  \n            \n // removequery\n            work_packages = {\n                    query : {\n                            query :{_id : new ObjectID(msg.work_package_id)},\n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'work_packages',\n                    operation:'remove',\n                    }\n\n            mongodbTools.resolveAsync(work_packages, node, function(res){\n                   \n            })  \n            \n            \n // removequery\n            participants = {\n                    query : {\n                            query :{\twork_package_id : new ObjectID(msg.work_package_id)},\n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'participants',\n                    operation:'remove',\n                    }\n\n            mongodbTools.resolveAsync(participants, node, function(res){\n                   \n            })  \n            \n            \n\n            \n            \n // removequery\n            events = {\n                    query : {\n                            query :{\twork_package_id : new ObjectID(msg.work_package_id)}, \n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'events',\n                    operation:'remove',\n                    }\n\n            mongodbTools.resolveAsync(events, node, function(res){\n                   \n            })  \n            \n // removequery\n            transactions = {\n                    query : {\n                            query :{\twork_package_id : new ObjectID(msg.work_package_id)}, \n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'transactions',\n                    operation:'remove',\n                    }\n\n            mongodbTools.resolveAsync(transactions, node, function(res){\n                   \n            })  \n\n // removequery\n            person_months = {\n                    query : {\n                            query :{\twork_package_id : new ObjectID(msg.work_package_id)}, \n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'person_months',\n                    operation:'remove',\n                    }\n\n            mongodbTools.resolveAsync(person_months, node, function(res){\n                   \n            })  \n            \n            \n\nreturn msg;\n","outputs":1,"noerr":0,"x":550,"y":1880,"wires":[["26a3ef3f.f39c2"]]},{"id":"561c8154.e2038","type":"link in","z":"22428f45.8ab","name":"","links":["f6894ee3.d056c","e5326123.a02c","94ed091e.5e27a8","97b5b868.e751e","3ce52d3e.8ba9f2","100e6adf.f1c21d","884fb8a9.ab74f","171e9659.88660a","d376f67a.c86588"],"x":75,"y":100,"wires":[["5d156f35.b0e81"]]},{"id":"e31df0ab.bcd2c","type":"comment","z":"22428f45.8ab","name":"Entrance post","info":"Expected object :\n\n msg.payload = {\n        DeviceId: ** From publised app **,\n        RevotioSessionId : ** From publised app **,\n   }","x":130,"y":300,"wires":[]},{"id":"18144838.76c328","type":"http in","z":"22428f45.8ab","name":"","url":"/Exit","method":"post","upload":false,"swaggerDoc":"","x":80,"y":1180,"wires":[["d376f67a.c86588","f207746d.fc46e8"]]},{"id":"d836d846.a603d8","type":"comment","z":"22428f45.8ab","name":"Exit ","info":"","x":90,"y":1140,"wires":[]},{"id":"cc7b0818.e77588","type":"http in","z":"22428f45.8ab","name":"","url":"/token","method":"post","upload":false,"swaggerDoc":"","x":90,"y":1080,"wires":[["57ab671a.bbe478"]]},{"id":"5cc34c91.c06a64","type":"function","z":"22428f45.8ab","name":"Generate token","func":"var request = global.get('request');\nvar Moment = global.get('moment');\nvar MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar crypto = global.get('crypto');\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\nif (msg.PostPayload.content.hasOwnProperty(\"pageSessionId\") && ObjectID.isValid(msg.PostPayload.content.pageSessionId)){\n    \n    findOneObj = {\n                    query : {\n                            query :{_id : new ObjectID(msg.PostPayload.content.pageSessionId)} \n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'page_load_sessions',\n                    operation:'find',\n                    }\n\n            mongodbTools.resolveAsync(findOneObj, node, function(res){\n                if (res.length > 0){\n                    page_load_session = res[0]\n                \n                  \n                    TokenContent = {};\n                    // verify a token symmetric\n                        jsonwebtoken.verify(page_load_session.token, global.get(\"SystemVars.secret\"), function(err, decoded) {\n                          if (decoded !== undefined){\n                              \n                              TokenContent = decoded\n                          }\n                        });\n                        \n                       \n                        \n                        msg.PostPayload.content.type = TokenContent.type\n                        \n                        msg.PostPayload.content.key  = new ObjectID()\n                        \n                        payload = {type : msg.PostPayload.type, token : jsonwebtoken.sign(msg.PostPayload.content, global.get(\"SystemVars.secret\"))};\n                        \n                        msg.PostPayload.content.token = payload.token\n                        \n                        msg.payload = payload\n                        \n                        // update     \n                        \n                        msg.payload.key =  msg.PostPayload.content.key\n                    \n                    \n                } else {\n                    \n                    \n                    msg.PostPayload.content.type = \"unauthorized\"\n                    msg.PostPayload.content.key  = new ObjectID()\n                    \n                    payload = {type : msg.PostPayload.type, token : jsonwebtoken.sign(msg.PostPayload.content, global.get(\"SystemVars.secret\"))};\n                    \n                    msg.PostPayload.content.token = payload.token\n                    \n                    msg.payload = payload\n                    \n                    // update     \n                    \n                    msg.payload.key =  msg.PostPayload.content.key\n                   \n                }\n                    \n                    node.send(msg) \n            })  \n            \n} else {\n    \n            msg.PostPayload.content.type = \"unauthorized\"\n            msg.PostPayload.content.key  = new ObjectID()\n            \n            payload = {type : msg.PostPayload.type, token : jsonwebtoken.sign(msg.PostPayload.content, global.get(\"SystemVars.secret\"))};\n            \n            msg.PostPayload.content.token = payload.token\n            \n            msg.payload = payload\n            \n            // update     \n            \n            msg.payload.key =  msg.PostPayload.content.key\n            node.send(msg)\n}\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":480,"y":1020,"wires":[["74c630ff.45ccf","f26cc4af.43ec38"]]},{"id":"21e2fb63.940c44","type":"http response","z":"22428f45.8ab","name":"","statusCode":"","headers":{},"x":990,"y":1080,"wires":[]},{"id":"a11eedb8.ddaab","type":"comment","z":"22428f45.8ab","name":"Token","info":"msg.payload = {\n    type: \n    content: { // start with DeviceId && RevotioSessionId\n        DeviceId: \"123456789\",\n        RevotioSessionId : \"123456789\"\n    }\n}","x":90,"y":1040,"wires":[]},{"id":"3070fb61.e8ead4","type":"http response","z":"22428f45.8ab","name":"","statusCode":"","headers":{},"x":450,"y":1300,"wires":[]},{"id":"c3ac50a5.c0713","type":"http in","z":"22428f45.8ab","name":"","url":"/upload","method":"post","upload":true,"swaggerDoc":"","x":90,"y":1280,"wires":[["2257fda3.f40772"]]},{"id":"2257fda3.f40772","type":"function","z":"22428f45.8ab","name":"","func":"var Remove, Upload; \n\nif (msg.req.uploadData.fields.type === \"create\"){\n    Upload = msg;\n} else {\n    Remove = msg;\n}\nreturn [Remove, Upload];","outputs":2,"noerr":0,"x":230,"y":1280,"wires":[[],["d3495579.2015e8","f78a0942.6bb1d8"]],"outputLabels":["Remove, ","Upload"]},{"id":"d3495579.2015e8","type":"function","z":"22428f45.8ab","name":"","func":"var fs = global.get('fsextra');\nconst Moment = global.get('moment');\nconst MomentRange = global.get('momentrange');\nconst moment = MomentRange.extendMoment(Moment)\n\nfs.ensureDirSync(msg.req.uploadData.fields.appFolder)\nfs.moveSync(msg.req.uploadData.fileData.path, msg.req.uploadData.fields.appFolder + msg.req.uploadData.fields.name , { overwrite: true })\n\nmsg.payload = {\n    path    : msg.req.uploadData.fields.appFolder + msg.req.uploadData.fields.name,\n    size    : msg.req.uploadData.fileData.size,\n    name    : msg.req.uploadData.fileData.name,\n    uploadFileType : msg.req.uploadData.fileData.type,\n    type    : msg.req.uploadData.fileData.type\n}\n\n\n\nreturn msg;","outputs":1,"noerr":0,"x":350,"y":1300,"wires":[["3070fb61.e8ead4"]]},{"id":"6251e115.c02e5","type":"comment","z":"22428f45.8ab","name":"Upload","info":"msg.payload = {\n    type: \n    content: { // start with DeviceId && RevotioSessionId\n        DeviceId: \"123456789\",\n        RevotioSessionId : \"123456789\"\n    }\n}","x":90,"y":1240,"wires":[]},{"id":"2409812a.fed21e","type":"http in","z":"22428f45.8ab","name":"fileToken","url":"/fileToken","method":"post","upload":false,"swaggerDoc":"","x":100,"y":1380,"wires":[["792d587f.710968"]]},{"id":"792d587f.710968","type":"function","z":"22428f45.8ab","name":"","func":"\nreturn msg;","outputs":1,"noerr":0,"x":210,"y":1380,"wires":[["7250dc5f.760624"]]},{"id":"7250dc5f.760624","type":"http response","z":"22428f45.8ab","name":"","statusCode":"","headers":{},"x":310,"y":1380,"wires":[]},{"id":"34064a7f.c391a6","type":"comment","z":"22428f45.8ab","name":"","info":"payload :{\n    fileToken   : STRING\n    RevotioToken: STRING,\n    fileName    : STRING,\n    filePath    : STRING,\n    \n}","x":100,"y":1340,"wires":[]},{"id":"97591da2.87f82","type":"http in","z":"22428f45.8ab","name":"download","url":"/download","method":"get","upload":false,"swaggerDoc":"","x":100,"y":1480,"wires":[["29e81316.44426c"]]},{"id":"29e81316.44426c","type":"function","z":"22428f45.8ab","name":"Get file","func":"// Get libraries\nconst Moment = global.get('moment');\nconst MomentRange = global.get('momentrange');\nconst moment = MomentRange.extendMoment(Moment)\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting'); \nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar fs = global.get('fsextra');\nvar mime = global.get('mime');\n\n\n// msg.payload.token = \"valid token\"\n\n msg.payload.tokenValid = false\n\nTokenContent = {};\n// verify a token symmetric\n    jsonwebtoken.verify(msg.payload[\"token\"], global.get(\"SystemVars.secret\"), function(err, decoded) {\n      if (decoded !== undefined){\n           msg.payload.tokenValid = true\n          TokenContent = decoded\n      }\n    });\n    \nif ( msg.payload.tokenValid === true ){\n\n        // check if file exists\n        var state = false\n        if (msg.payload.hasOwnProperty(\"file\") &&  fs.existsSync(msg.payload.file)) { \n            state = true\n        } \n        \n        if (state === true){\n            // msg.payload.fileExtension = msg.payload.file.split(\".\")[msg.payload.file.split(\".\").length - 1]\n            msg.payload.fileType = mime.getType(msg.payload.file); \n             msg.payload.fileExtension = mime.getExtension(msg.payload.fileType); \n            msg.payload.folder = \"\"\n            \n            _.each(msg.payload.file.split(\"/\"), function(string, index){\n                if (index === 0){\n                     msg.payload.folder = string\n                } else {\n                    if (msg.payload.file.split(\"/\").length > index + 1){\n                        msg.payload.folder = msg.payload.folder +\"/\"+ string\n                    }\n                }\n            })\n        \n                    if (msg.payload.type === \"thumbnail\"){\n                         data = fs.readFileSync(msg.payload.file);\n                            msg.payload.base64 =  data.toString('base64');\n                                  \n                                \n                                  fs.stat(msg.payload.file, function(err, stats) {\n                                     \n                                      msg.payload.stats = stats;\n                                        \n                                            node.send(msg);\n                                  })\n                       \n                    } else {\n                            data = fs.readFileSync(msg.payload.file);\n                            msg.payload.base64 =  data.toString('base64');\n                                  \n                                \n                                  fs.stat(msg.payload.file, function(err, stats) {\n                                     \n                                      msg.payload.stats = stats;\n                                       \n                                            node.send(msg);\n                                  })\n                    }\n        \n        } else {\n            msg.payload.error = \"file does not exists\"\n            node.send(msg)\n        }\n} \nelse {\n       msg.payload.error = \"Invalid token\"\n      node.send(msg) \n}\n\n\n\n// return msg;","outputs":1,"noerr":0,"x":210,"y":1480,"wires":[["3a83d709.2a89f8","8d13220a.064cb","10876916.4d4127"]]},{"id":"3a83d709.2a89f8","type":"http response","z":"22428f45.8ab","name":"","statusCode":"","headers":{},"x":430,"y":1480,"wires":[]},{"id":"ae618d7a.66202","type":"comment","z":"22428f45.8ab","name":"","info":"payload :{\n    fileToken   : STRING\n    RevotioToken: STRING,\n    fileName    : STRING,\n    filePath    : STRING,\n    \n}","x":100,"y":1440,"wires":[]},{"id":"53c36d8e.ef37d4","type":"function","z":"22428f45.8ab","name":"Remove Session","func":"var request = global.get('request');\nvar Moment = global.get('moment');var MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\nvar Data = msg.payload;\n\nmsg.headers = {\n    'Access-Control-Allow-Origin': '*',\n    'Access-Control-Allow-Methods': 'PUT,GET,POST,DELETE,OPTIONS',\n    'Access-Control-Allow-Headers': 'Content-Type',\n    'content-type': 'application/json',\n};\n\nif (Data.revotioSessionId){\n    query= {\n        deviceId : Data.deviceId,\n        revotioSessionId : Data.revotioSessionId,\n    }\n    \n   \n} else {\n    query = {\n        deviceId : Data.deviceId,\n    }\n} \n\n// get session\n\nfindOneObj = {\n                    query : {\n                            query :query\n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'sessions',\n                    operation:'find',\n                    }\n\n            mongodbTools.resolveAsync(findOneObj, node, function(res){\n                if (res.length > 0){\n                    session = res[0]\n                } else {\n                    session = {}\n                }\n                \n                session.closed = new Date()\n                // Save session in closed sessions\n                    updateObj = {\n                                    query : {\n                                            query :query, \n                                            update : { \"$set\" : session},\n                                            options : {upsert: true}\n                                            },\n                                    connection:global.get(\"DB_data.connection\"),\n                                    database:global.get(\"DB_data.appDB\"),\n                                    collection:'sessions_closed',\n                                    operation:'update', // updateMany , updateOne\n                                    }\n                \n                            mongodbTools.resolveAsync(updateObj, node, function(res){\n                                    \n                                    // remove \n                                    removeObj = {\n                                            query : {\n                                                    query :query,\n                                                    },\n                                            connection:global.get(\"DB_data.connection\"),\n                                            database:global.get(\"DB_data.appDB\"),\n                                            collection:'sessions',\n                                            operation:'remove',\n                                            }\n                        \n                                    mongodbTools.resolveAsync(removeObj, node, function(res){\n                                             // remove \n                                            removeObj = {\n                                                    query : {\n                                                            query :query,\n                                                            },\n                                                    connection:global.get(\"DB_data.connection\"),\n                                                    database:global.get(\"DB_data.appDB\"),\n                                                    collection:'page_load_sessions',\n                                                    operation:'remove',\n                                                    }\n                                \n                                            mongodbTools.resolveAsync(removeObj, node, function(res){\n                                                    // msg.payload = {\n                                                    //     state : \"success\"\n                                                    // }\n                                                    node.send(msg) \n                                            })   \n                                    })   \n                            })  \n\n                   \n            })  \n            ","outputs":1,"noerr":0,"initialize":"","finalize":"","x":390,"y":1180,"wires":[["bdf80280.f7416","57f0ceaa.0ac0b"]]},{"id":"bdf80280.f7416","type":"http response","z":"22428f45.8ab","name":"","statusCode":"","headers":{},"x":550,"y":1180,"wires":[]},{"id":"d376f67a.c86588","type":"link out","z":"22428f45.8ab","name":"","links":["dc664b4f.0d82e","561c8154.e2038"],"x":175,"y":1220,"wires":[]},{"id":"845ccdd6.1fbfe","type":"comment","z":"22428f45.8ab","name":"CHECK GC state","info":"","x":260,"y":1220,"wires":[]},{"id":"eeabaf73.14d32","type":"debug","z":"22428f45.8ab","name":"Pre Request","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":2850,"y":780,"wires":[]},{"id":"2051aa96.2da936","type":"debug","z":"22428f45.8ab","name":"INIT post","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":940,"y":500,"wires":[]},{"id":"4e8bb101.951b7","type":"debug","z":"22428f45.8ab","name":"ACTION post","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":650,"y":660,"wires":[]},{"id":"18300eee.bc13f1","type":"debug","z":"22428f45.8ab","name":"ENTERANCE post","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":550,"y":140,"wires":[]},{"id":"f78a0942.6bb1d8","type":"debug","z":"22428f45.8ab","name":"UPLOAD post","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":460,"y":1240,"wires":[]},{"id":"48bfdd4e.c29a24","type":"inject","z":"22428f45.8ab","name":"","repeat":"","crontab":"","once":true,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":130,"y":200,"wires":[["18300eee.bc13f1","5d156f35.b0e81"]]},{"id":"4324a1f8.df305","type":"function","z":"22428f45.8ab","name":"Check user inv","func":"var request = global.get('request');\nvar Moment = global.get('moment');var MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\n\n       \n    var query = {type: \"project\", organization_id:new ObjectID( msg.RevotioData.session.permission.organizationData._id)};\n// find  \nfindObj = {\n                    query : {\n                            query :query, \n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'participants',\n                    operation:'find',\n                    }\n\n            mongodbTools.resolveAsync(findObj, node, function(res){\n                    msg.payload = res\n                    node.send(msg) \n            })   \n// }\n\n\n// return msg;","outputs":1,"noerr":0,"x":2040,"y":360,"wires":[["39e92084.90cc6"]]},{"id":"74c630ff.45ccf","type":"debug","z":"22428f45.8ab","name":"TOKEN post GENERATE","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":670,"y":980,"wires":[]},{"id":"516e0d62.dc0d14","type":"debug","z":"22428f45.8ab","name":"TOKEN post FILE","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1130,"y":900,"wires":[]},{"id":"3566286.33b3cd8","type":"function","z":"22428f45.8ab","name":"Add session to session_stats","func":"var request = global.get('request');\nvar Moment = global.get('moment');var MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar crypto = global.get('crypto');\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\n// _id management\nObj = msg.current_session;\nObj.session_id = new ObjectID(msg.current_session._id)\nmsg.current_session._id = new ObjectID();\n\n// Add redirect data\n\nObj.destination_page =  msg.responseObj.Page\nObj.redirect_time =  new Date()\n\n// remove current session flowData\n\ndelete Obj.FlowData\nObj.redirect_revotio_data =  msg.responseObj.RevotioData\nObj.user_id = new ObjectID(Obj.user_id)\n\n// update    \n\n    updateObj = {\n                    query : {\n                            query :Obj, \n                            update : { \"$set\" : Obj},\n                            options : {upsert: true}\n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'session_stats',\n                    operation:'update', // updateMany , updateOne\n                    }\n\n            mongodbTools.resolveAsync(updateObj, node, function(res){\n                    // msg.payload = res\n                    // node.send(msg) \n            })  ","outputs":1,"noerr":0,"x":1760,"y":960,"wires":[[]]},{"id":"3dbe8cdf.cfd5b4","type":"function","z":"22428f45.8ab","name":"Get session","func":"var request = global.get('request');\nvar Moment = global.get('moment');var MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar crypto = global.get('crypto');\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\n// findOne \nfindOneObj = {\n                    query : {\n                            query :{revotioSessionId: msg.responseObj.revotioSessionId, deviceId:msg.responseObj.deviceId} \n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'sessions',\n                    operation:'find',\n                    }\n\n            mongodbTools.resolveAsync(findOneObj, node, function(res){\n                if (res.length > 0){\n                    msg.current_session = res[0]\n                } else {\n                    msg.current_session = {}\n                }\n                    \n                    node.send(msg) \n            })  ","outputs":1,"noerr":0,"x":1550,"y":940,"wires":[["3566286.33b3cd8","4310a895.50d9d8"]]},{"id":"dab1e7c8.d77be8","type":"http in","z":"22428f45.8ab","name":"error","url":"/error","method":"post","upload":false,"swaggerDoc":"","x":90,"y":1560,"wires":[["46d21342.624c3c"]]},{"id":"7d86d135.960c5","type":"http response","z":"22428f45.8ab","name":"","statusCode":"","headers":{},"x":550,"y":1560,"wires":[]},{"id":"9b803e79.d335c","type":"comment","z":"22428f45.8ab","name":"","info":"payload :{\n    fileToken   : STRING\n    RevotioToken: STRING,\n    fileName    : STRING,\n    filePath    : STRING,\n    \n}","x":100,"y":1520,"wires":[]},{"id":"46d21342.624c3c","type":"function","z":"22428f45.8ab","name":"save error in error collection","func":"// Get libraries\nconst Moment = global.get('moment');\nconst MomentRange = global.get('momentrange');\nconst moment = MomentRange.extendMoment(Moment)\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting'); \nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar fs = global.get('fsextra');\nvar mime = global.get('mime');\n\npayload = msg.payload;\npostData = JSON.parse(msg.payload.postData)\nerror = msg.payload.error\nObj = {\n        data : {\n            postData:postData,\n            error:error,\n        },\n        date  :new Date(),\n        app : global.get(\"applicationId\"),\n        type:\"publisher\"\n}\n\n// update    \n\n    updateObj = {\n                    query : {\n                            query :Obj, \n                            update : { \"$set\" : Obj},\n                            options : {upsert: true}\n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'errors',\n                    operation:'update', // updateMany , updateOne\n                    }\n\n            mongodbTools.resolveAsync(updateObj, node, function(res){\n                    // msg.payload = res\n                    msg.payload =   {\n                                        msg: payload,\n                                        state:  \"error processed\"\n                                    }\n                       \n                    node.send(msg) \n            })  ","outputs":1,"noerr":0,"x":320,"y":1540,"wires":[["7d86d135.960c5"]]},{"id":"370f35d5.83dd6a","type":"subflow:be61da9a.8b3cd8","z":"22428f45.8ab","name":"","env":[],"x":320,"y":40,"wires":[["8653bb23.0e7148"]]},{"id":"62109c28.38f404","type":"function","z":"22428f45.8ab","name":"prepair redirect to user authentication && update session object","func":"var request = global.get('request');\nvar Moment = global.get('moment');var MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar crypto = global.get('crypto');\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\nmsg.payload  = {\n    Page :global.get(\"DomainProperties.NonAuthDefaultPage\")\n}\n\n// update    \n\n    updateObj = {\n                    query : {\n                            query :{\n                                    revotioSessionId:msg.RevotioData.session.revotioSessionId, \n                                    deviceId : msg.RevotioData.session.deviceId\n                            }, \n                            update : { \"$set\" : msg.RevotioData.session},\n                            options : {upsert: true}\n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'sessions',\n                    operation:'update', // updateMany , updateOne\n                    }\n\n            mongodbTools.resolveAsync(updateObj, node, function(res){\n                   \n                    node.send(msg) \n            })  \n\n","outputs":1,"noerr":0,"x":2070,"y":420,"wires":[["4f77ff18.3df8f"]]},{"id":"346559fb.3bd3e6","type":"debug","z":"22428f45.8ab","name":"ENTERANCE post A","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":900,"y":280,"wires":[]},{"id":"22a7057b.fcb6ba","type":"debug","z":"22428f45.8ab","name":"Pre get session","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":2660,"y":220,"wires":[]},{"id":"8873bf3d.db5de","type":"function","z":"22428f45.8ab","name":"Redirect to user landing page","func":"msg.payload  = {\n    Page :global.get(\"DomainProperties.ClientDefaultPage\")\n}\nreturn msg;","outputs":1,"noerr":0,"x":810,"y":840,"wires":[["534fed46.ceb0f4"]]},{"id":"2254455d.8aee2a","type":"function","z":"22428f45.8ab","name":"Load page ","func":"var request = global.get('request');\nvar Moment = global.get('moment');var MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar crypto = global.get('crypto');\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\nvar fileLoad, fileNotLoaded;\n\nmsg.page = msg.responseObj.Page + \".json\"\n\nmsg.pagePublisherBranch = env.get(\"pagePublisherBranch\")\n// get  pagePublisherBranch ENV\n\n        if (env.get(\"pagePublisherBranch\") &&\n            env.get(\"pagePublisherBranch\") === \"master\"){\n              \n              if (fs.existsSync(\"/root/.node-red/projects/PNO_portfolio_management/pages/\" + msg.page)) {\n            msg.rawdata = fs.readFileSync(\"/root/.node-red/projects/PNO_portfolio_management/pages/\" + msg.page);\n            msg.pageObject = JSON.parse(msg.rawdata);\n            fileLoad = msg;\n        } else {\n            msg.headers = {};\n            msg.rejectUnauthorized =  false;\n        \n        \n            url = global.get(\"innonation_api\")+ \"/pages?\" +  \"applicationId=\"  + msg.responseObj.applicationId + \"&pageName=\"+  msg.responseObj.Page ;\n            res = encodeURI(url);\n                \n            msg.url = res\n            fileNotLoaded = msg\n        }\n\n    } else {\n            msg.headers = {};\n            msg.rejectUnauthorized =  false;\n        \n        \n            url = global.get(\"innonation_api\")+ \"/pages?\" +  \"applicationId=\"  + msg.responseObj.applicationId + \"&pageName=\"+  msg.responseObj.Page ;\n            res = encodeURI(url);\n                \n            msg.url = res\n            fileNotLoaded = msg\n    }\n\nreturn [fileLoad, fileNotLoaded];","outputs":2,"noerr":0,"initialize":"","finalize":"","x":890,"y":920,"wires":[["516e0d62.dc0d14","3318562b.47220a"],["983ec1b8.b05dd","27381526.735dfa"]],"outputLabels":["fileLoad","fileNotLoaded"]},{"id":"3318562b.47220a","type":"json","z":"22428f45.8ab","name":"Parse page file","property":"pageObject","action":"","pretty":false,"x":1140,"y":940,"wires":[["18d61a14.1b2d76"]]},{"id":"18d61a14.1b2d76","type":"function","z":"22428f45.8ab","name":"Set ","func":"var request = global.get('request');\nvar Moment = global.get('moment');var MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar crypto = global.get('crypto');\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\nmsg.responseObj.presentationLayer = msg.pageObject\nmsg.appObj =msg.pageObject;\n\n\nreturn msg;","outputs":1,"noerr":0,"x":1270,"y":940,"wires":[["3dbe8cdf.cfd5b4","137eb072.4e54a"]]},{"id":"137eb072.4e54a","type":"debug","z":"22428f45.8ab","name":"TOKEN post","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1450,"y":900,"wires":[]},{"id":"bd6bfd6d.c939b","type":"function","z":"22428f45.8ab","name":"project overview change","func":"var request = global.get('request');\nvar Moment = global.get('moment');var MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar crypto = global.get('crypto');\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\n\nvar found, notFound;\n\nif (msg.responseObj.Page   === \"project overview\"){\n    \n   obj = { time: new Date(),\n            sourcePage : msg.RevotioData.session.Page\n   }\n   \n   if (msg.RevotioData.PostData ){\n       obj.postData = msg.RevotioData.PostData\n   }\n   \n    fs.ensureDirSync(\"/root/.node-red/projects/PNO_portfolio_management/analysis\")\n  \n    fs.writeJsonSync(\"/root/.node-red/projects/PNO_portfolio_management/analysis/\"+new Date()+ \".json\", JSON.stringify(obj))\n\n    msg.responseObj.Page   = \"default project overview\"\n    found = msg;\n}  else {\n    notFound = msg;\n}\nreturn [found, notFound];","outputs":2,"noerr":0,"initialize":"","finalize":"","x":670,"y":920,"wires":[["2254455d.8aee2a"],["2254455d.8aee2a"]],"outputLabels":["found, ","notFound"]},{"id":"f97150ae.cf23d","type":"function","z":"22428f45.8ab","name":"Parse object && save json file","func":"var request = global.get('request');\nvar Moment = global.get('moment');var MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar crypto = global.get('crypto');\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\nmsg.responseObj.presentationLayer = JSON.parse(msg.payload).pages[0];\nmsg.appObj = JSON.parse(msg.payload);\n\nfs.ensureDirSync(\"/root/.node-red/projects/PNO_portfolio_management/pages/\")\n\nfs.writeJsonSync(\"/root/.node-red/projects/PNO_portfolio_management/pages/\"+msg.responseObj.presentationLayer.name.toLowerCase().trim() + \".json\", JSON.stringify(msg.responseObj.presentationLayer))\n\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1310,"y":1000,"wires":[["3dbe8cdf.cfd5b4"]],"outputLabels":["Items, "]},{"id":"983ec1b8.b05dd","type":"http request","z":"22428f45.8ab","name":"","method":"GET","ret":"txt","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":1110,"y":1000,"wires":[["f97150ae.cf23d"]]},{"id":"357858a9.3a7a18","type":"function","z":"22428f45.8ab","name":"Parse object","func":"// Get libraries\nconst Moment = global.get('moment');\nconst MomentRange = global.get('momentrange');\nconst moment = MomentRange.extendMoment(Moment);\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting'); \nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\n\n\nmsg.responseObj.presentationLayer = JSON.parse(msg.payload).pages[0];\nmsg.appObj = JSON.parse(msg.payload);\n\n\n\nreturn msg;","outputs":1,"noerr":0,"x":950,"y":1440,"wires":[[]],"outputLabels":["Items, "]},{"id":"808d5c5c.169a6","type":"http request","z":"22428f45.8ab","name":"","method":"GET","ret":"txt","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":790,"y":1440,"wires":[["357858a9.3a7a18"]]},{"id":"27381526.735dfa","type":"debug","z":"22428f45.8ab","name":"TOKEN post API","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1110,"y":1060,"wires":[]},{"id":"7e246bb3.a4bdc4","type":"function","z":"22428f45.8ab","name":"Get user & organization type data","func":"var request = global.get('request');\nvar Moment = global.get('moment');var MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar crypto = global.get('crypto');\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\n\n            aggregateObj = {\n                    query : { query : [{\n                                $match: {\n                                  user : new ObjectID(msg.RevotioData.session.user_id),\n                                  \"type\": \"organization\",\n                                  \"permission_type\": \"organization\"\n                                }\n                              },\n                         {\n                             \"$lookup\":{\n                                        from: \"organizations\",\n                                        localField: \"type_id\",\n                                        foreignField: \"_id\",\n                                        as: \"organizationData\"\n                                    }\n                         },\n                         {\n                             \"$unwind\":\n                             {\n                                path : \"$organizationData\",\n                                includeArrayIndex : \"arrayIndex\", // optional\n                                preserveNullAndEmptyArrays : true // optional\n                            }\n                         }\n                         \n                            ],},\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'user_permissions',\n                    operation:'aggregate',\n                    }\n                    \n            mongodbTools.resolveAsync(aggregateObj, node, function(res){\n                 if (res.length > 0){\n                    msg.RevotioData.session.permission = res[0]\n                } else {\n                    msg.RevotioData.session.permission = {}\n                }\n                    \n                    node.send(msg) \n            })  \n            \n           \n ","outputs":1,"noerr":0,"x":1240,"y":320,"wires":[["a568dd87.1b6dc","967bc07e.c7f2c"]]},{"id":"beee4a6.d97e5b8","type":"debug","z":"22428f45.8ab","name":"Pre redir4ect 2/2","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":3410,"y":280,"wires":[]},{"id":"35b6d281.c3180e","type":"debug","z":"22428f45.8ab","name":"Pre redir4ect 1/2","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":2930,"y":280,"wires":[]},{"id":"f146e39e.4c4e5","type":"debug","z":"22428f45.8ab","name":"EXIT POST","active":false,"tosidebar":true,"console":false,"tostatus":true,"complete":"true","targetType":"full","statusVal":"payload","statusType":"msg","x":350,"y":1200,"wires":[]},{"id":"f207746d.fc46e8","type":"json","z":"22428f45.8ab","name":"","property":"payload","action":"","pretty":false,"x":230,"y":1180,"wires":[["53c36d8e.ef37d4","f146e39e.4c4e5"]]},{"id":"57f0ceaa.0ac0b","type":"debug","z":"22428f45.8ab","name":"EXIT POST - response","active":false,"tosidebar":true,"console":false,"tostatus":true,"complete":"true","targetType":"full","statusVal":"payload","statusType":"msg","x":600,"y":1220,"wires":[]},{"id":"f26cc4af.43ec38","type":"function","z":"22428f45.8ab","name":"Get /Set key","func":"var request = global.get('request');\nvar Moment = global.get('moment');\nvar MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar crypto = global.get('crypto');\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\n//**********************************************\n// update    \n\n    updateObj = {\n                    query : {\n                            query :{    revotioSessionId:msg.PostPayload.content.revotioSessionId,\n                                        deviceId:msg.PostPayload.content.deviceId}, \n                            update : { \"$set\" : {token : msg.payload.token}},\n                            options : {upsert: true, returnOriginal: false}\n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'sessions',\n                    operation:'findOneAndUpdate', // updateMany , updateOne\n                    }\n\n            mongodbTools.resolveAsync(updateObj, node, function(res){\n                    msg.findOneAndUpdateResponse = res\n                    node.send(msg) \n            })  \n\n// return msg;\n// Get key\n\n// if ( typeof msg.payload.TokenContent === \"object\" && \n//     msg.payload.TokenContent.deviceId   && \n//     msg.payload.TokenContent.revotioSessionId\n//     ){\n    \n    \n    \n\n//     findOneObj = {\n//                         query : {\n//                                 query :{\n//                                     revotioSessionId:msg.payload.TokenContent.revotioSessionId,\n//                                     deviceId:msg.payload.TokenContent.deviceId\n//                                 } \n//                                 },\n//                         connection:global.get(\"DB_data.connection\"),\n//                         database:global.get(\"DB_data.appDB\"),\n//                         collection:'sessions',\n//                         operation:'find',\n//                         }\n    \n//                 mongodbTools.resolveAsync(findOneObj, node, function(res){\n//                     if (res.length > 0){\n//                         msg.payload.key = res[0]._id\n//                     } \n    \n//                         node.send(msg) \n//                 })  \n\n// } else {\n//     node.send(msg)\n// }\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":670,"y":1020,"wires":[["21e2fb63.940c44","28ce091b.7bd5c6"]]},{"id":"28ce091b.7bd5c6","type":"debug","z":"22428f45.8ab","name":"TOKEN post 11","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":900,"y":1020,"wires":[]},{"id":"57ab671a.bbe478","type":"function","z":"22428f45.8ab","name":"Token API","func":"var BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\n\nvar jsonwebtoken = global.get('jsonwebtoken');\n\nvar generate, validate, key, error;\n\nif (typeof msg.payload === 'string'){\n    payload = JSON.parse(msg.payload)\n    msg.payload = payload;\n} \nif (typeof msg.payload === 'string'){\n    payload = JSON.parse(msg.payload)\n    msg.payload = payload;\n} \nif (typeof msg.payload.content === 'string'){\n    var content = JSON.parse(msg.payload.content)\n    msg.payload.content = content;\n} \n\nmsg.PostPayload  = msg.payload;\n\nmsg.token = msg.PostPayload.token\n\nmsg.headers = {\n    'Access-Control-Allow-Origin': '*',\n    'Access-Control-Allow-Methods': 'PUT,GET,POST,DELETE,OPTIONS',\n    'Access-Control-Allow-Headers': 'Content-Type',\n    'content-type': 'application/json',\n};\n\n        if (msg.PostPayload.type === \"generate\"  && msg.PostPayload.content && msg.PostPayload.content.deviceId){\n\n            generate = msg;\n        } else if (msg.PostPayload.type === \"validate\" &&  msg.PostPayload.token){\n            validate = msg;\n            \n        } else if (msg.PostPayload.type === \"key\" &&  msg.PostPayload.token ){\n            key = msg;\n            \n        } else {\n          error = msg\n        }\n\nreturn [generate, validate, key, error];","outputs":4,"noerr":0,"initialize":"","finalize":"","x":240,"y":1080,"wires":[["5cc34c91.c06a64"],["e6839973.216ab8"],["434697e9.1ff3b8"],["cc28556a.cb7078"]],"outputLabels":["generate","validate","key","error"]},{"id":"2ec8c2a4.2c5d3e","type":"function","z":"22428f45.8ab","name":"KEY","func":"var request = global.get('request');\nvar Moment = global.get('moment');\nvar MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar crypto = global.get('crypto');\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\ntokenState = \"invalid\"\nTokenContent = {};\n// verify a token symmetric\n    jsonwebtoken.verify(msg.PostPayload.token, global.get(\"SystemVars.secret\"), function(err, decoded) {\n      if (decoded !== undefined){\n          tokenState = \"valid\"\n          TokenContent = decoded\n      }\n    });\n    \n    payload = { type:msg.PostPayload.type, token : msg.PostPayload.token  , tokenState : tokenState,key: TokenContent.key }; //, TokenContent:TokenContent\n    \n    msg.payload = payload ;\n    return msg;\n    // findOneObj = {\n    //                             query : {\n    //                                     query :{revotioSessionId:msg.PostPayload.content.revotioSessionId, \n    //                                             deviceId : msg.PostPayload.content.deviceId} \n    //                                     },\n    //                             connection:global.get(\"DB_data.connection\"),\n    //                             database:global.get(\"DB_data.appDB\"),\n    //                             collection:'sessions',\n    //                             operation:'find',\n    //                             }\n            \n    //                     mongodbTools.resolveAsync(findOneObj, node, function(res){\n    //                         if (res.length > 0){\n    //                             msg.payload.key = res[0]._id\n    //                         } \n                        //   node.send(msg)  \n                        // })\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":550,"y":1100,"wires":[["7ab2f94f.ec7388","21e2fb63.940c44"]]},{"id":"cc28556a.cb7078","type":"function","z":"22428f45.8ab","name":"error","func":"var request = global.get('request');\nvar Moment = global.get('moment');\nvar MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar crypto = global.get('crypto');\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\nmsg.payload = \"invalid post request - type\";\n\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":530,"y":1140,"wires":[["25b2b89d.2c9908","21e2fb63.940c44"]]},{"id":"112951e8.82457e","type":"debug","z":"22428f45.8ab","name":"TOKEN post Validate","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":520,"y":980,"wires":[]},{"id":"7ab2f94f.ec7388","type":"debug","z":"22428f45.8ab","name":"TOKEN post KEY","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":750,"y":1120,"wires":[]},{"id":"25b2b89d.2c9908","type":"debug","z":"22428f45.8ab","name":"TOKEN post error","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":770,"y":1180,"wires":[]},{"id":"e6839973.216ab8","type":"subflow:53926ffd.c5a74","z":"22428f45.8ab","name":"","env":[],"x":400,"y":1060,"wires":[["112951e8.82457e","bd71e02b.86b74"]]},{"id":"bd71e02b.86b74","type":"function","z":"22428f45.8ab","name":"Validate","func":"var request = global.get('request');\nvar Moment = global.get('moment');\nvar MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar crypto = global.get('crypto');\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n    \n    msg.payload = { type:msg.PostPayload.type, token : msg.tokenResult.token  , tokenState : msg.tokenResult.tokenState,key: msg.tokenResult.key }; // TokenContent:TokenContent\n    \n   \n    return msg;\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":560,"y":1060,"wires":[["21e2fb63.940c44"]]},{"id":"434697e9.1ff3b8","type":"subflow:53926ffd.c5a74","z":"22428f45.8ab","name":"","env":[],"x":400,"y":1100,"wires":[["2ec8c2a4.2c5d3e"]]},{"id":"358ba198.43c70e","type":"subflow:53926ffd.c5a74","z":"22428f45.8ab","name":"","env":[],"x":420,"y":260,"wires":[["18300eee.bc13f1","419c886f.616e68"]]},{"id":"419c886f.616e68","type":"function","z":"22428f45.8ab","name":"Decrypt","func":"var request = global.get('request');\nvar Moment = global.get('moment');\nvar MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar crypto = global.get('crypto');\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n        \ndataState = \"invalid\"\ndataContent = {};\n// verify a token symmetric\n    jsonwebtoken.verify(msg.payload.data, msg.tokenResult.key, function(err, decoded) {\n      if (decoded !== undefined){\n          dataState = \"valid\"\n          dataContent = decoded\n      }\n    });\n    \n    msg.dataResult = {\n        \n        data : msg.payload.data  ,\n        dataState : dataState,\n        key: msg.tokenResult.key, \n        dataContent:dataContent\n    }\n    return msg;\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":620,"y":260,"wires":[["57dd5648.3cade8","d25f097e.01e458"]]},{"id":"57dd5648.3cade8","type":"debug","z":"22428f45.8ab","name":"ENTERANCE post A","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":900,"y":160,"wires":[]},{"id":"16987802.9cc1b8","type":"function","z":"22428f45.8ab","name":"Set msg.token","func":"\nmsg.token = msg.payload.token\n\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":300,"y":480,"wires":[["cd161118.d929e"]]},{"id":"cd161118.d929e","type":"subflow:53926ffd.c5a74","z":"22428f45.8ab","name":"","env":[],"x":480,"y":480,"wires":[["64e30f7f.75341"]]},{"id":"64e30f7f.75341","type":"function","z":"22428f45.8ab","name":"Decrypt","func":"var request = global.get('request');\nvar Moment = global.get('moment');\nvar MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar crypto = global.get('crypto');\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n        \ndataState = \"invalid\"\ndataContent = {};\n// verify a token symmetric\n    jsonwebtoken.verify(msg.payload.data, msg.tokenResult.key, function(err, decoded) {\n      if (decoded !== undefined){\n          dataState = \"valid\"\n          dataContent = decoded\n      }\n    });\n    \n    msg.dataResult = {\n        \n        data : msg.payload.data  ,\n        dataState : dataState,\n        key: msg.tokenResult.key, \n        dataContent:dataContent\n    }\n    return msg;\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":660,"y":480,"wires":[["2051aa96.2da936","91f18bc9.521138"]]},{"id":"95c91e78.e2e0d","type":"function","z":"22428f45.8ab","name":"Set msg.token","func":"\nmsg.token = msg.payload.token\n\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":320,"y":720,"wires":[["a65378af.4bceb8"]]},{"id":"a65378af.4bceb8","type":"subflow:53926ffd.c5a74","z":"22428f45.8ab","name":"","env":[],"x":500,"y":720,"wires":[["969b994a.6d3158"]]},{"id":"969b994a.6d3158","type":"function","z":"22428f45.8ab","name":"Decrypt","func":"var request = global.get('request');\nvar Moment = global.get('moment');\nvar MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar crypto = global.get('crypto');\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n        \ndataState = \"invalid\"\ndataContent = {};\n// verify a token symmetric\n    jsonwebtoken.verify(msg.payload.data, msg.tokenResult.key, function(err, decoded) {\n      if (decoded !== undefined){\n          dataState = \"valid\"\n          dataContent = decoded\n      }\n    });\n    \n    msg.dataResult = {\n        \n        data : msg.payload.data  ,\n        dataState : dataState,\n        key: msg.tokenResult.key, \n        dataContent:dataContent\n    }\n    return msg;\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":680,"y":720,"wires":[["4e8bb101.951b7","ad02ca99.ed0958"]]},{"id":"639c54a7.45bdac","type":"debug","z":"22428f45.8ab","name":"Pre Request With data ","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":3140,"y":1040,"wires":[]},{"id":"4bb16b7e.2206a4","type":"debug","z":"22428f45.8ab","name":"Pre action REQUEST","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1630,"y":700,"wires":[]},{"id":"3330057.39240fa","type":"function","z":"22428f45.8ab","name":"Validate pageSession call","func":"var request = global.get('request');\nvar Moment = global.get('moment');\nvar MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar crypto = global.get('crypto');\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\nvar sessionRequest, logout;\n// validate pageSession call\n\nif (    msg.RevotioData.session.hasOwnProperty(\"pageSessionId\") &&\n        ObjectID.isValid(msg.RevotioData.session.pageSessionId)=== true\n){\n    sessionRequest = msg\n} else {\n    logout = msg\n}\n\n\nreturn [sessionRequest, logout];","outputs":2,"noerr":0,"initialize":"","finalize":"","x":1010,"y":460,"wires":[["6e52c24e.32c77c"],["58fbe66b.db29c8"]],"outputLabels":["sessionRequest, ","logout"]},{"id":"6e52c24e.32c77c","type":"function","z":"22428f45.8ab","name":"Process pageSession call","func":"var request = global.get('request');\nvar Moment = global.get('moment');\nvar MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar crypto = global.get('crypto');\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\n\n// findOne \nfindOneObj = {\n                    query : {\n                            query :{_id : new ObjectID(msg.RevotioData.session.pageSessionId)} \n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'page_load_sessions',\n                    operation:'find',\n                    }\n\n            mongodbTools.resolveAsync(findOneObj, node, function(res){\n                if (res.length > 0){\n                    msg.payload = res[0]\n                } else {\n                   msg.payload = {}\n                }\n                \n                if (    msg.payload.hasOwnProperty(\"pageObject\") && \n                        msg.payload.pageObject.hasOwnProperty(\"revotioSessionId\")\n                ){\n                      msg.payload.pageObject.revotioSessionId = msg.RevotioData.session.revotioSessionId\n                \n                }\n              \n// //          remove gadgets list\n\n// if ( msg.payload.pageObject.Page === \"organization overview\"){\n    delete msg.payload.gadgetsList\n// }\n\n\n                    \n                    node.send(msg) \n            }) \n\n\n// return msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1310,"y":460,"wires":[["b918a2d4.ad163"]]},{"id":"58fbe66b.db29c8","type":"subflow:ab79407.ded3ec","z":"22428f45.8ab","name":"","env":[],"x":1150,"y":540,"wires":[]},{"id":"9ae0c558.f913a8","type":"http response","z":"22428f45.8ab","name":"","statusCode":"","headers":{},"x":2310,"y":540,"wires":[]},{"id":"ffa0b47b.784c08","type":"function","z":"22428f45.8ab","name":"Update Session to match location user && gen page_session_id -- enterance --","func":"var request = global.get('request');\nvar Moment = global.get('moment');var MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\nresponseObj = msg.payload.pageObject;\n\nObj =  {timestamp : new Date(),\n        applicationId: new ObjectID(global.get(\"applicationId\")),\n        // session : msg.RevotioData.session\n}\n\nObj.revotioSessionId =  msg.RevotioData.session.revotioSessionId;\nObj.deviceId =  msg.RevotioData.session.deviceId;\n\n\nif (msg.payload.pageObject.user_id){\n    Obj.user_id =  msg.payload.pageObject.user_id;\n}\n\nif (msg.payload.pageObject.RevotioData.userData){\n    Obj.userData =  msg.payload.pageObject.RevotioData.userData;\n}\n\nif (msg.payload.pageObject.Page){\n    Obj.Page =  msg.payload.pageObject.Page;\n}\n\nif (typeof msg.payload.pageObject.RevotioData === 'object'){\n    Obj.FlowData = msg.payload.pageObject.RevotioData\n    Obj.FlowData.Data  = {}\n} else {\n     Obj.FlowData = {Data:{}}\n}\n\n\nObj.token = msg.token\nObj.pageName  = msg.payload.pageName\n\nif (msg.payload.pageObject.presentationLayer && msg.payload.pageObject.presentationLayer.container && msg.payload.pageObject.presentationLayer.container !== null){\n    Obj.container =  msg.payload.pageObject.presentationLayer.container;\n}\n\n\n{\n             \n                                               \nObj.Gadgets =  [];\nObj.Page= msg.payload.pageObject.presentationLayer.name;\nObj.groupedObject =  msg.payload.pageObject.presentationLayer.groupedObject;\nObj.page_id =  new ObjectID(msg.payload.pageObject.presentationLayer._id);\n                            }\n\nupdateObj = {\n                    query : {\n                            query :{deviceId: responseObj.deviceId, revotioSessionId: responseObj.revotioSessionId}, \n                            update : {\"$set\" : Obj},\n                            options : {upsert: true, returnOriginal: false}\n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'sessions',\n                    operation:'findOneAndUpdate', // updateMany , updateOne\n                    }\n\n            mongodbTools.resolveAsync(updateObj, node, function(res){\n                \n                msg.session = res\n                \n                // if (typeof res === 'object' && res.hasOwnProperty(\"value\")){\n                    \n                //     //  msg.payload = res.value\n                     \n                // } else {\n                //     msg.payload = {};\n                // }\n                \n                // update    \n\n    updateObj = {\n                    query : {\n                            query :{_id:new ObjectID(Obj.FlowData.page_session_id)}, \n                            update : { \"$set\" : {date : new Date(), deviceId: Obj.deviceId, revotioSessionId: Obj.revotioSessionId}},\n                            options : {upsert: true}\n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'page_load_sessions',\n                    operation:'update', // updateMany , updateOne\n                    }\n\n            mongodbTools.resolveAsync(updateObj, node, function(res){\n                    // msg.payload = res\n                    node.send(msg) \n            })  \n            \n            \n            })\n                    ","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1780,"y":520,"wires":[["27e0db6d.5be984","50435091.c9859"]]},{"id":"56ebf668.007fb8","type":"inject","z":"22428f45.8ab","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":1110,"y":1260,"wires":[["c74a80dc.3be26"]]},{"id":"c74a80dc.3be26","type":"function","z":"22428f45.8ab","name":"","func":"var request = global.get('request');\nvar Moment = global.get('moment');\nvar MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar crypto = global.get('crypto');\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\n\nmsg.RevotioData = {\n    session:{\n        pageSessionId:new ObjectID(\"5f840c84c9cb71c19290efc7\")\n    }\n}\n\n\n\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1390,"y":1280,"wires":[["3330057.39240fa"]]},{"id":"27e0db6d.5be984","type":"debug","z":"22428f45.8ab","name":"@@@###@@@##@#","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":2180,"y":580,"wires":[]},{"id":"8eb478dc.adf1e8","type":"debug","z":"22428f45.8ab","name":"PRE INIT REQUEST","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1280,"y":660,"wires":[]},{"id":"967bc07e.c7f2c","type":"debug","z":"22428f45.8ab","name":"Pre redirect dececion","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1890,"y":180,"wires":[]},{"id":"50435091.c9859","type":"function","z":"22428f45.8ab","name":"Encrypt data","func":"var request = global.get('request');\nvar Moment = global.get('moment');var MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar crypto = global.get('crypto');\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\npayload = {\n    data : jsonwebtoken.sign(msg.payload, msg.tokenResult.key),\n    token:msg.RevotioData.session.token,\n    pageSessionId:msg.RevotioData.session.pageSessionId,\n    pageName:msg.payload.pageName\n};\nmsg.payload = payload;\n\nreturn msg;\n            \n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":2150,"y":540,"wires":[["9ae0c558.f913a8"]]},{"id":"426a3309.63179c","type":"debug","z":"22428f45.8ab","name":"POST REDIRECT","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":3570,"y":320,"wires":[]},{"id":"9141ef07.3fc94","type":"subflow:ab79407.ded3ec","z":"22428f45.8ab","name":"","env":[],"x":1910,"y":660,"wires":[]},{"id":"b918a2d4.ad163","type":"function","z":"22428f45.8ab","name":"validate","func":"var valid, logout;\n\nif ( typeof msg.payload === 'object' && msg.payload.hasOwnProperty(\"user_id\")){\n    valid = msg\n} else {\n    logout = msg\n}\nreturn [ valid, logout];","outputs":2,"noerr":0,"initialize":"","finalize":"","x":1340,"y":540,"wires":[["ffa0b47b.784c08"],["9ee02b6d.d40548","4bb16b7e.2206a4"]],"outputLabels":["valid","logout"]},{"id":"9ee02b6d.d40548","type":"subflow:ab79407.ded3ec","z":"22428f45.8ab","name":"","env":[],"x":1570,"y":560,"wires":[]},{"id":"173ae262.6db51e","type":"function","z":"22428f45.8ab","name":"","func":"\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":470,"y":100,"wires":[[]]},{"id":"8d13220a.064cb","type":"debug","z":"22428f45.8ab","name":"Download post","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":480,"y":1420,"wires":[]},{"id":"10876916.4d4127","type":"function","z":"22428f45.8ab","name":"Check if file needs to be removed","func":"var request = global.get('request');\nvar Moment = global.get('moment');\nvar MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar crypto = global.get('crypto');\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\nif (msg.payload.file.startsWith(\"/files/tmp/TMP__exports/\")){\n    fs.removeSync(msg.payload.folder)\n}\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":520,"y":1440,"wires":[[]]},{"id":"c566be41.4720e","type":"inject","z":"a2b40f09.d18fd8","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":210,"y":940,"wires":[["288d2d5b.9a47c2"]]},{"id":"288d2d5b.9a47c2","type":"function","z":"a2b40f09.d18fd8","name":"get source file","func":"var request = global.get('request');\nvar Moment = global.get('moment');\nvar MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar crypto = global.get('crypto');\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\n\n// findOne \nfindOneObj = {\n                    query : {\n                            query :{application_id:new ObjectID(\"5f22ab9e5c29cbe8cc52540c\"), name:\"organization_overview_time_focus\"}\n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'pages',\n                    operation:'find',\n                    }\n\n            mongodbTools.resolveAsync(findOneObj, node, function(res){\n                if (res.length > 0){\n                    msg.payload = res[0]\n                } else {\n                    msg.payload = {}\n                }\n                    \n                    node.send(msg) \n            })  ","outputs":1,"noerr":0,"initialize":"","finalize":"","x":420,"y":940,"wires":[["6f0a612d.c1a26","55b93eb4.ffef7"]]},{"id":"ad1dbf73.d9348","type":"debug","z":"a2b40f09.d18fd8","name":"B","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":750,"y":880,"wires":[]},{"id":"6f0a612d.c1a26","type":"function","z":"a2b40f09.d18fd8","name":"get entity modal and ","func":"var request = global.get('request');\nvar Moment = global.get('moment');\nvar MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar crypto = global.get('crypto');\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\nmsg.modalContainer = msg.payload.content.container[3]\nmsg.groupedObject = {\n    key: \"47975d37-c5e4-bd28-d0b6-e09d2276bb44\",\n    value : msg.payload.groupedObject[\"47975d37-c5e4-bd28-d0b6-e09d2276bb44\"]\n}\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":640,"y":940,"wires":[["ad1dbf73.d9348","874fa2f1.8d53e"]]},{"id":"55b93eb4.ffef7","type":"debug","z":"a2b40f09.d18fd8","name":"A","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":570,"y":880,"wires":[]},{"id":"874fa2f1.8d53e","type":"function","z":"a2b40f09.d18fd8","name":"Get pages","func":"var request = global.get('request');\nvar Moment = global.get('moment');\nvar MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar crypto = global.get('crypto');\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\n\n// findOne \nfindOneObj = {\n                    query : {\n                            query :{application_id:new ObjectID(\"5f22ab9e5c29cbe8cc52540c\"), name:{\"$ne\":\"organization_overview_time_focus\"}}\n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'pages',\n                    operation:'find',\n                    }\n\n            mongodbTools.resolveAsync(findOneObj, node, function(res){\n                    msg.payload = [];\n                   _.each(res, function(pageObj, index){\n                        pageObj.content.container.push(msg.modalContainer)\n                        pageObj.groupedObject[msg.groupedObject.key] = msg.groupedObject.value\n                        msg.payload.push(pageObj)\n                   })\n                    node.send(msg) \n            })  ","outputs":1,"noerr":0,"initialize":"","finalize":"","x":850,"y":940,"wires":[["1355d1a3.a43cae","becfb0df.5ca03"]]},{"id":"1355d1a3.a43cae","type":"debug","z":"a2b40f09.d18fd8","name":"C","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":990,"y":880,"wires":[]},{"id":"15323210.b027ae","type":"function","z":"a2b40f09.d18fd8","name":"Update page","func":"var request = global.get('request');\nvar Moment = global.get('moment');var MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar crypto = global.get('crypto');\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n            \nif (msg.payload.hasOwnProperty(\"content\") && \n    msg.payload.hasOwnProperty(\"_id\")\n    ){\n\n    updateObj = {\n                    query : {\n                            query :{_id:new ObjectID(msg.payload._id)}, \n                            update : {\"$set\":{content: msg.payload.content, groupedObject: msg.payload.groupedObject}}, \n                            options :{upsert:true}\n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'pages',\n                    operation:'update', // updateMany , updateOne\n                    }\n            \n            mongodbTools.resolveAsync(updateObj, node, function(res){\n                    // msg.payload = res\n                    node.send(msg) \n            })  \n            \n} else {\n    return msg\n}\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1130,"y":900,"wires":[["becfb0df.5ca03","fda4bf1d.b2f6b"]]},{"id":"becfb0df.5ca03","type":"function","z":"a2b40f09.d18fd8","name":"Loop through page records ","func":"//Node has 2 outputs - 1 for itteration and 1 for completion\nvar nextObj, out;\nvar itt = msg.iterationInfo;\n\n\n//If the iterating has not yet begun set up the iteration metadata in the msg\nif (typeof itt === 'undefined') {\n    //Make sure payload is an array\n    if( Object.prototype.toString.call(msg.payload) !== '[object Array]' ) {\n       msg.payload = [msg.payload];\n    }\n\n    msg.iterationInfo = itt = {};\n    itt.index = -1;\n    itt.inArray = msg.payload;\n    itt.outArray = [];\n\n//Otherwise just push the input to the output array\n} else {\n    itt.outArray.push(msg.payload)\n}\n\n//Goto next object\nitt.index ++;\n\n//If there are stil objects left to iterate goto the next one in the original array\nif (itt.index < itt.inArray.length) {\n    nextObj = msg;\n    msg.payload = itt.inArray[itt.index];\n\n//otherwise pass the out array as the payload\n} else {\n    out = msg;\n    msg.payload = itt.outArray;\n    delete msg.iterationInfo;\n}\n\nreturn [nextObj, out];","outputs":"2","noerr":0,"x":1140,"y":940,"wires":[["15323210.b027ae"],["dcd10b13.a1f788"]]},{"id":"dcd10b13.a1f788","type":"debug","z":"a2b40f09.d18fd8","name":"E","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1370,"y":1040,"wires":[]},{"id":"fda4bf1d.b2f6b","type":"debug","z":"a2b40f09.d18fd8","name":"D","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1390,"y":860,"wires":[]},{"id":"7b54b6d2.c1bdc8","type":"comment","z":"22428f45.8ab","name":"Global gadgets","info":"","x":260,"y":2160,"wires":[]},{"id":"ae5785c7.0c1788","type":"function","z":"22428f45.8ab","name":"Trigger remove actions per entity","func":"// Get libraries\nconst Moment = global.get('moment');\nconst MomentRange = global.get('momentrange');\nconst moment = MomentRange.extendMoment(Moment);\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\n\n\n// delete all sub entities first\n_.each(msg.payload,function(SubItem, SubIndex){\n    node.send({organization_id:new ObjectID(SubItem._id)})\n} )\n\n// continue with main entity removal\n\nreturn msg;","outputs":1,"noerr":0,"x":1320,"y":2220,"wires":[["e15d5772.0e0df8","995ff8a2.63f6b8","4844d2da.33a67c"]]},{"id":"e53c7860.990738","type":"function","z":"22428f45.8ab","name":"Trigger delete project data","func":"// Get libraries\nconst Moment = global.get('moment');\nconst MomentRange = global.get('momentrange');\nconst moment = MomentRange.extendMoment(Moment);\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\n\nif (msg.done === false ){\n    node.send(msg)\n}\n","outputs":1,"noerr":0,"x":1960,"y":2180,"wires":[["b5f3fdc7.4343c"]]},{"id":"be600bea.594778","type":"function","z":"22428f45.8ab","name":"check if msg.organization_id is present and prepair child lookup","func":"var BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\n\n\nvar valid, invalid\nif (msg.payload.hasOwnProperty(\"organization_id\")){\n\n    payload = {\"$or\": [{parent_id : new ObjectID(msg.payload.organization_id)}, {_id : new ObjectID(msg.payload.organization_id)} ] }\n    msg.operation = 'find.toArray'\n    msg.payload = payload\n    valid = msg\n} else {\n    invalid = msg\n}\n\nreturn [valid, invalid]","outputs":2,"noerr":0,"x":750,"y":2240,"wires":[["28fc6052.64dc2"],["fb27820e.4bb97"]],"outputLabels":["valid, ","invalid"]},{"id":"94966f9f.ffccb","type":"comment","z":"22428f45.8ab","name":"Delete all organization Data","info":"","x":380,"y":2200,"wires":[]},{"id":"1f04146c.c5c66c","type":"link in","z":"22428f45.8ab","name":"Delete all organization Data","links":["755fb71d.d2028","bfc74af8.6937b"],"x":515,"y":2200,"wires":[["be600bea.594778","851e478a.8f9ef8"]]},{"id":"efb566c8.5efc78","type":"function","z":"22428f45.8ab","name":"Get all app pages ","func":"var request = global.get('request');\nvar Moment = global.get('moment');var MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\n\n// find  \nfindObj = {\n                    query : {\n                            query : {\tapplication_id : new ObjectID(msg.payload.application_id)},\n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'pages',\n                    operation:'find',\n                    }\n\n            mongodbTools.resolveAsync(findObj, node, function(res){\n                    msg.payload = res\n                    node.send(msg) \n            })  \n// return msg;","outputs":1,"noerr":0,"x":1090,"y":2300,"wires":[["48d6d059.1ebe2"]]},{"id":"3d51ab9c.83f104","type":"comment","z":"22428f45.8ab","name":"Delete all application data","info":"","x":410,"y":2320,"wires":[]},{"id":"79dc2356.f732cc","type":"link in","z":"22428f45.8ab","name":"Delete all project data","links":["b5f3fdc7.4343c","b298aff4.badb78","e9fb6492.5b068"],"x":495,"y":2320,"wires":[["f9261894.ca8358","7fef60a1.2197d"]]},{"id":"88dfad99.1b2e6","type":"function","z":"22428f45.8ab","name":"Libs","func":"// Get libraries\nconst Moment = global.get('moment');\nconst MomentRange = global.get('momentrange');\nconst moment = MomentRange.extendMoment(Moment);\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\n\nif ( Array.isArray(msg.payload)){\n   _.each(msg.payload, function(Item, Index){\n    \n    msg.page_id = Item._id\n    node.send(msg);\n    \n    \n}); \n} else if (msg.payload.hasOwnProperty(\"page_id\")) {\n    msg.page_id = msg.payload.page_id\n    node.send(msg);\n} else{\n      msg.page_id = msg.payload._id\n    node.send(msg);\n}\n\n\n\n// return msg;","outputs":1,"noerr":0,"x":550,"y":2440,"wires":[["1c10dad8.d6dd35"]]},{"id":"879998ed.ad4368","type":"comment","z":"22428f45.8ab","name":"Remove all page data","info":"","x":380,"y":2400,"wires":[]},{"id":"d116d5bc.d0b7b8","type":"link in","z":"22428f45.8ab","name":"Remove all wp data","links":["48d6d059.1ebe2","5bc91a39.2b348c","cf312f50.45a118","148a291d.254577"],"x":475,"y":2400,"wires":[["88dfad99.1b2e6","3ffb599e.3cfae6"]]},{"id":"b5f3fdc7.4343c","type":"link out","z":"22428f45.8ab","name":"","links":["79dc2356.f732cc"],"x":2095,"y":2180,"wires":[]},{"id":"48d6d059.1ebe2","type":"link out","z":"22428f45.8ab","name":"","links":["d116d5bc.d0b7b8"],"x":1215,"y":2300,"wires":[]},{"id":"7b5b5f0d.80bcc","type":"http in","z":"22428f45.8ab","name":"removeOrganization","url":"/removeOrganization","method":"post","upload":false,"swaggerDoc":"","x":410,"y":2240,"wires":[["be600bea.594778","851e478a.8f9ef8"]]},{"id":"225ad824.8c4278","type":"http in","z":"22428f45.8ab","name":"removeApplication","url":"/removeApplication","method":"post","upload":false,"swaggerDoc":"","x":370,"y":2360,"wires":[["f9261894.ca8358","7fef60a1.2197d"]]},{"id":"b4649bdb.15fc58","type":"http in","z":"22428f45.8ab","name":"removePage","url":"/removePage","method":"post","upload":false,"swaggerDoc":"","x":370,"y":2440,"wires":[["88dfad99.1b2e6","3ffb599e.3cfae6"]]},{"id":"486017bd.73dec8","type":"http response","z":"22428f45.8ab","name":"","statusCode":"","headers":{},"x":870,"y":2440,"wires":[]},{"id":"fb27820e.4bb97","type":"http response","z":"22428f45.8ab","name":"","statusCode":"","headers":{},"x":1050,"y":2260,"wires":[]},{"id":"f9261894.ca8358","type":"function","z":"22428f45.8ab","name":"check if msg.application_id is present and prepair child lookup","func":"var BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\n\nvar valid, invalid\nif (msg.payload.hasOwnProperty(\"application_id\")){\n\n    // payload = {parent_id : new ObjectID(msg.payload.project_id)}\n    // msg.operation = 'find.toArray'\n    // msg.payload = payload\n    valid = msg\n} else {\n    invalid = msg\n}\n\nreturn [valid, invalid]","outputs":2,"noerr":0,"x":750,"y":2360,"wires":[["efb566c8.5efc78","4f0079fd.f87378"],["b8cd1575.e05088"]],"outputLabels":["valid, ","invalid"]},{"id":"b8cd1575.e05088","type":"http response","z":"22428f45.8ab","name":"","statusCode":"","headers":{},"x":1050,"y":2380,"wires":[]},{"id":"e167db41.388518","type":"http response","z":"22428f45.8ab","name":"","statusCode":"","headers":{},"x":1750,"y":2140,"wires":[]},{"id":"e15d5772.0e0df8","type":"function","z":"22428f45.8ab","name":"Remove Organization","func":"var request = global.get('request');\nvar Moment = global.get('moment');var MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\n// remove \n            removeObj = {\n                    query : {\n                            query :{_id : new ObjectID(msg.organization_id)}, \n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'organizations',\n                    operation:'remove',\n                    }\n\n            mongodbTools.resolveAsync(removeObj, node, function(res){\n                    msg.result = res\n                    node.send(msg) \n            }) ","outputs":1,"noerr":0,"x":1600,"y":2140,"wires":[["e167db41.388518"]]},{"id":"28fc6052.64dc2","type":"function","z":"22428f45.8ab","name":"get organizations","func":"var request = global.get('request');\nvar Moment = global.get('moment');var MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\n    // query = {\"$or\": [{parent_id : new ObjectID(msg.payload.organization_id)}, {_id : new ObjectID(msg.payload.organization_id)} ] }\n    // msg.operation = 'find.toArray'\n                    \n                // find  \n                findObj = {\n                    query : {\n                            query :msg.payload, \n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'organizations',\n                    operation:'find',\n                    }\n\n            mongodbTools.resolveAsync(findObj, node, function(res){\n                    msg.payload = res\n                    node.send(msg) \n            })   \n\n   ","outputs":1,"noerr":0,"x":1090,"y":2220,"wires":[["ae5785c7.0c1788"]],"outputLabels":["valid, "]},{"id":"995ff8a2.63f6b8","type":"function","z":"22428f45.8ab","name":"Remove all users && users data","func":"var request = global.get('request');\nvar Moment = global.get('moment');var MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\n// find  \nfindObj = {\n                    query : {\n                            query :{organization_id: new ObjectID(msg.organization_id)}, \n                            projection:{_id :1}\n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'user_accounts',\n                    operation:'find',\n                    }\n\n            mongodbTools.resolveAsync(findObj, node, function(res){\n                \n                _.each(res, function(user, index){\n                    \n                    // removeusers \n                        removeusers = {\n                                query : {\n                                        query :{_id:user._id}, \n                                        },\n                                connection:global.get(\"DB_data.connection\"),\n                                database:global.get(\"DB_data.appDB\"),\n                                collection:'users',\n                                operation:'remove',\n                                }\n            \n                        mongodbTools.resolveAsync(removeusers, node, function(res){\n                                \n                        }) \n                        \n                        // removeuser_accounts \n                        removeuser_accounts = {\n                                query : {\n                                        query :{user:user._id}, \n                                        },\n                                connection:global.get(\"DB_data.connection\"),\n                                database:global.get(\"DB_data.appDB\"),\n                                collection:'user_accounts',\n                                operation:'remove',\n                                }\n            \n                        mongodbTools.resolveAsync(removeuser_accounts, node, function(res){\n                                \n                        }) \n                        \n                         // removeuser_permissions\n                        removeuser_permissions = {\n                                query : {\n                                        query :{user:user._id}, \n                                        },\n                                connection:global.get(\"DB_data.connection\"),\n                                database:global.get(\"DB_data.appDB\"),\n                                collection:'user_permissions',\n                                operation:'remove',\n                                }\n            \n                        mongodbTools.resolveAsync(removeuser_permissions, node, function(res){\n                                \n                        }) \n                        \n                       \n                      \n                })\n                \n                    // msg.payload = res\n                    node.send(msg) \n            }) \n            \n// return msg;\n","outputs":1,"noerr":0,"x":1630,"y":2180,"wires":[[]]},{"id":"4f0079fd.f87378","type":"function","z":"22428f45.8ab","name":"Remove all application records && files","func":"var request = global.get('request');\nvar Moment = global.get('moment');var MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\n // removequery\n            pages = {\n                    query : {\n                            query :{application_id : new ObjectID(msg.payload.application_id)}, \n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'pages',\n                    operation:'remove',\n                    }\n\n            mongodbTools.resolveAsync(pages, node, function(res){\n                   \n            })  \n            \n \n          \n // removequery\n            application = {\n                    query : {\n                            query :{_id : new ObjectID(msg.payload.application_id)}, \n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'applications',\n                    operation:'remove',\n                    }\n\n            mongodbTools.resolveAsync(application, node, function(res){\n                   \n            })  \n            \n            \n            \n    // remove all app files\n    fs.removeSync(global.get(\"DomainProperties.filesFolder\")+ \"applications/\" + msg.payload.application_id)\n\n\nreturn msg;\n","outputs":1,"noerr":0,"x":1150,"y":2340,"wires":[["38e9efde.33218"]]},{"id":"38e9efde.33218","type":"http response","z":"22428f45.8ab","name":"","statusCode":"","headers":{},"x":1330,"y":2340,"wires":[]},{"id":"1c10dad8.d6dd35","type":"function","z":"22428f45.8ab","name":"Remove all page records && files","func":"var request = global.get('request');\nvar Moment = global.get('moment');var MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n \n // get page obj\n  findOneObj = {\n                    query : {\n                            query :{_id : new ObjectID(msg.page_id) }\n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'pages',\n                    operation:'find',\n                    }\n\n            mongodbTools.resolveAsync(findOneObj, node, function(res){\n                if (res.length > 0){\n                    msg.page = res[0]\n                } else {\n                    msg.page = {}\n                }\n                    \n                // remove all app files\n                fs.removeSync(global.get(\"DomainProperties.filesFolder\")+ \"applications/\" + msg.page.application_id+\"/pages/\"+msg.page_id)\n\n                 // removequery\n                            pages = {\n                                    query : {\n                                            query :{_id : new ObjectID(msg.page_id)},\n                                            },\n                                    connection:global.get(\"DB_data.connection\"),\n                                    database:global.get(\"DB_data.appDB\"),\n                                    collection:'pages',\n                                    operation:'remove',\n                                    }\n                \n                            mongodbTools.resolveAsync(pages, node, function(res){\n                                   node.send(msg)\n                            })  \n            })  \n            ","outputs":1,"noerr":0,"x":740,"y":2440,"wires":[["486017bd.73dec8"]]},{"id":"4844d2da.33a67c","type":"function","z":"22428f45.8ab","name":"Get all org's applications ","func":"var request = global.get('request');\nvar Moment = global.get('moment');var MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\nvar query = {organization_id : new ObjectID(msg.organization_id)}\nmsg.done = false\n // find  \nfindObj = {\n                    query : {\n                            query :query, \n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:global.get(\"DB_data.appDB\"),\n                    collection:'applications',\n                    operation:'find',\n                    }\n\n            mongodbTools.resolveAsync(findObj, node, function(res){\n\n                    _.each(res, function(AppItem,AppItemIndex ){\n                        node.send({application_id :AppItem._id })\n                    })\n                   \n                    msg.done = true\n                    node.send(msg) \n            }) \n","outputs":1,"noerr":0,"x":1610,"y":2220,"wires":[["e53c7860.990738","e101b76a.ca28f8"]]},{"id":"e101b76a.ca28f8","type":"function","z":"22428f45.8ab","name":"Send response","func":"// Get libraries\nconst Moment = global.get('moment');\nconst MomentRange = global.get('momentrange');\nconst moment = MomentRange.extendMoment(Moment);\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\n\nif (msg.done === true ){\n    node.send(msg)\n}\n","outputs":1,"noerr":0,"x":1920,"y":2220,"wires":[["1044ed72.f373c3"]]},{"id":"1044ed72.f373c3","type":"http response","z":"22428f45.8ab","name":"","statusCode":"","headers":{},"x":2230,"y":2220,"wires":[]},{"id":"3ffb599e.3cfae6","type":"debug","z":"22428f45.8ab","name":"Remove page","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":630,"y":2580,"wires":[]},{"id":"7fef60a1.2197d","type":"debug","z":"22428f45.8ab","name":"Remove app","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":650,"y":2320,"wires":[]},{"id":"851e478a.8f9ef8","type":"debug","z":"22428f45.8ab","name":"Remove org","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":650,"y":2140,"wires":[]},{"id":"4eea1368.e7a81c","type":"inject","z":"22428f45.8ab","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":880,"y":2060,"wires":[["d4196640.0694f8"]]},{"id":"d4196640.0694f8","type":"function","z":"22428f45.8ab","name":"Libs","func":"var request = global.get('request');\nvar Moment = global.get('moment');\nvar MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar crypto = global.get('crypto');\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\nvar unzipper =  global.get('unzipper')","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1140,"y":2020,"wires":[[]]},{"id":"896a8494.419aa8","type":"function","z":"d8703926.e2eca","name":"Add organization to msg.menu","func":"// Get libraries\nconst Moment = global.get('moment');\nconst MomentRange = global.get('momentrange');\nconst moment = MomentRange.extendMoment(Moment);\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\n\n\nnewArr = []\n\nmsg.menu.push({\n            State: \"Inactive\",\n            name: \"Organizations\",\n            label: \"Organizations\",\n            button: true,\n            group : true,\n            buttonType: \"success\",\n            iconUrl: global.get(\"DomainProperties.prodUrl\") + \"/files/SystemFiles/icons/icon_organization.svg\",// global.get(\"icons.images.organization\"),  \n            filePath :global.get(\"icons.images.organization\") ,\n            iconState: true,\n            inner:[\n                {\n            name: \"Create organization\",\n            label: \"Create organization\",\n            button: true,\n            buttonType: \"success\",\n            iconName: global.get(\"icons.fas.create\"),\n            // iconUrl: 'https://revotio.nl/webpages/images/icons/Add.svg',\n            iconState: true,\n            inner:[]\n},{\n            name: \"Organizations overview\",\n            label:  \"Organizations overview\",\n            button: true,\n            buttonType: \"success\",\n            iconName: global.get(\"icons.fas.open\"),\n            // iconUrl: 'https://revotio.nl/webpages/images/icons/Open.svg',\n            iconState: true,\n            redirect : true,\n            Page: 'organizations global',\n            inner:[],\n           \n},\n\n{\n            name: \"Organizations\",\n            label: \"Organizations\",\n            button: true,\n            buttonType: \"success\",\n            lazyload : \"organizations\",\n            // iconName: global.get(\"DomainProperties.prodUrl\") + \"/icons/icon_organization.svg\", // global.get(\"icons.fas.organization\"),\n            iconUrl:  global.get(\"DomainProperties.prodUrl\") + \"/files/SystemFiles/icons/icon_organization.svg\",\n            filePath :global.get(\"icons.images.organization\") ,\n            iconState: true,\n            // redirect : true,\n            // Page: 'organizations global',\n            inner:[],\n             bubble: msg.payload,\n}]\n});\n\n\n\n\n// msg.menu[0].inner = newArr ;\n\n\nreturn msg;","outputs":1,"noerr":0,"x":2210,"y":720,"wires":[[]]},{"id":"4d6e8aaa.054e84","type":"function","z":"d8703926.e2eca","name":"gadgets menu","func":"var request = global.get('request');\nvar Moment = global.get('moment');var MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar crypto = global.get('crypto');\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\nmsg.menu = []           ;\n\n// Create organizations group\n\ngadgetsDir = \"../../../var/www/pagePublisher/src/components/gadgets\"\n\nfs.readdir(gadgetsDir, (err, files) => { \n          if (err) \n            console.log(err); \n          else { \n              \n              // get pages\n              \n\nfindManyObj = {\n                    query : {\n                            query :{name : {\"$in\":files} , application_id : new ObjectID(global.get(\"applicationId\"))}, \n                            },\n                    connection:global.get(\"DB_data.connection\"),\n                    database:\"revotio\",\n                    collection:'pages',\n                    operation:'find',\n                    }\n\n            mongodbTools.resolveAsync(findManyObj, node, function(res){\n                \n                node.warn({\n                    res:res\n                })\n                 //node.warn({\"files\":files})\n                                res.forEach(page => { \n                                  msg.menu.push(\n                                          {\n                                        name: page.name,\n                                        label: page.name,\n                                        button: true,\n                                        Page : page.name,\n                                        buttonType: \"success\",\n                                        redirect:true,\n                                        iconName: global.get(\"icons.fas.create\"),\n                                        // iconUrl: 'https://revotio.nl/webpages/images/icons/Add.svg',\n                                        iconState: true,\n                                        inner:[]\n                            });\n                    }) \n            \n                     msg.payload = {\n                        \n                        gadgetsList:[{\n                        gadgetName: 'menu',\n                        gadgetId: 'menu',\n                         gadgetData: {\n                             parent :{},\n                             child : msg.menu}\n                        }]\n            };\n\n          node.send(msg)\n            }) \n              \n           \n          } \n          \n          \n     \n}) \n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1540,"y":700,"wires":[["b8cba8eb.07bea8","95883a5d.f23058"]],"outputLabels":["PNO, "]},{"id":"95883a5d.f23058","type":"debug","z":"d8703926.e2eca","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":1840,"y":780,"wires":[]},{"id":"1d5c7c1a.5822e4","type":"comment","z":"9921cbf1.f82328","name":"breadcrumbs","info":"","x":130,"y":280,"wires":[]},{"id":"e52f4da2.66161","type":"comment","z":"9921cbf1.f82328","name":"Organization global gagdet actions","info":"","x":3300,"y":220,"wires":[]},{"id":"3fc109e8.319576","type":"comment","z":"9921cbf1.f82328","name":"***************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************","info":"","x":2450,"y":180,"wires":[]},{"id":"9bf1ce82.a3dda","type":"link in","z":"9921cbf1.f82328","name":"organization global - INIT FLOW","links":["5d57bad4.0cdff4","9a050e9a.e90288","3b858951.2c8d86","febed477.696398","7fa9c732.feefe8"],"x":755,"y":400,"wires":[["193edcb4.56c8e3","9f66f0d8.42673"]]},{"id":"e0e33689.c66468","type":"function","z":"9921cbf1.f82328","name":"Route userAction","func":"var  MenuAction, breadcrumbBasic, breadcrumbSubButtons,breadcrumbForm ,breadcrumbTour, resetPage;\nvar PostData    = msg.RevotioData.PostData;\nvar Page        = msg.RevotioData.session.Page;\n\n if (PostData.gadgetType=== \"Menu\"){\n    MenuAction = msg;\n} else  if (PostData.gadgetName=== \"breadcrumbBasic\"){\n    breadcrumbBasic = msg;\n} else  if (PostData.gadgetName=== \"breadcrumbSubButtons\"){\n    breadcrumbSubButtons = msg;\n} else  if (PostData.gadgetName=== \"breadcrumbForm\"){\n    breadcrumbForm = msg;\n} else  if (PostData.gadgetName=== \"breadcrumbTour\"){\n    breadcrumbTour = msg;\n} else  if (PostData.gadgetName=== \"Reset page\"){\n    resetPage = msg;\n} \n\n\n\n\n\n\nreturn [ MenuAction, breadcrumbBasic,breadcrumbSubButtons,breadcrumbForm, breadcrumbTour, resetPage];","outputs":6,"noerr":0,"initialize":"","finalize":"","x":3210,"y":360,"wires":[["18f8719f.279d1e"],["214539c7.4207b6"],["46c8e8bf.f80d88"],["9f5902f2.ab21b"],["74fbc787.b3cfe8"],["67412f74.5eb71"]],"outputLabels":["MenuAction","breadcrumbBasic","breadcrumbSubButtons","breadcrumbForm","breadcrumbTour","resetPage"]},{"id":"a065c9b7.4db248","type":"debug","z":"9921cbf1.f82328","name":"Organiozation Global Gadget post","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":3260,"y":260,"wires":[]},{"id":"193edcb4.56c8e3","type":"link out","z":"9921cbf1.f82328","name":"Trigger gadgets","links":["1198ab94.12521c","6dd9e005.08317","15313496.c9b06b","6adedbdb.e70694","e714ad41.62fe18","fb2f529a.1efbc","26c29dda.6daf62","cd9f1d1b.bf34","e51d11b2.4634e","9ace7eb.b1eda8","662d87cc.7d0548","c934eefd.40a3","ac2bb9bc.e80f78","a1f71373.9e355","d6d858a.66ff0a8"],"x":1135,"y":400,"wires":[]},{"id":"9e48b64e.89b708","type":"comment","z":"9921cbf1.f82328","name":"INIT FLOW","info":"","x":720,"y":360,"wires":[]},{"id":"9f66f0d8.42673","type":"debug","z":"9921cbf1.f82328","name":"Organiozation Global INIT post","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":930,"y":360,"wires":[]},{"id":"3642fad0.1d3c46","type":"link in","z":"9921cbf1.f82328","name":"organization global - GadgetAction","links":["ca484bde.d6efc8","b636d429.212c48","f6ff6532.fd5c58"],"x":3015,"y":360,"wires":[["a065c9b7.4db248","e0e33689.c66468"]]},{"id":"4945e5f6.e7e4ec","type":"link in","z":"9921cbf1.f82328","name":"organization global - design","links":["c98c548a.95f4b","ead712f3.5bdef8","102cb83c.632cd8"],"x":715,"y":300,"wires":[["c35a03c7.b5996"]]},{"id":"b84da9b.a394e58","type":"http response","z":"9921cbf1.f82328","name":"","statusCode":"","headers":{},"x":1290,"y":300,"wires":[]},{"id":"f6e95f68.59996","type":"function","z":"9921cbf1.f82328","name":"breadcrumbs -  design","func":"msg.topbarContanerId =  \"9e859d4a-16d7-fcf7-9c79-b828bbf1d262\"\n// msg.payload.design = {}\n\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1000,"y":300,"wires":[["98849c46.46fe6"]]},{"id":"40cb437c.0ca4bc","type":"comment","z":"9921cbf1.f82328","name":"DESIGN","info":"","x":720,"y":260,"wires":[]},{"id":"fb2f529a.1efbc","type":"link in","z":"9921cbf1.f82328","name":"** Gadget Name **","links":["193edcb4.56c8e3"],"x":1435,"y":460,"wires":[["2c6b2776.25bf08"]]},{"id":"f6ba409a.c55f2","type":"http in","z":"9921cbf1.f82328","name":"breadcrumbs","url":"/breadcrumbs","method":"post","upload":false,"swaggerDoc":"","x":190,"y":340,"wires":[["ca781c12.a2526"]]},{"id":"102cb83c.632cd8","type":"link out","z":"9921cbf1.f82328","name":"","links":["4945e5f6.e7e4ec"],"x":455,"y":300,"wires":[]},{"id":"7fa9c732.feefe8","type":"link out","z":"9921cbf1.f82328","name":"","links":["9bf1ce82.a3dda"],"x":455,"y":340,"wires":[]},{"id":"f6ff6532.fd5c58","type":"link out","z":"9921cbf1.f82328","name":"","links":["3642fad0.1d3c46"],"x":455,"y":380,"wires":[]},{"id":"c4b4ce9b.ff9b4","type":"comment","z":"9921cbf1.f82328","name":"INIT","info":"","x":530,"y":340,"wires":[]},{"id":"c803c1f4.c8e2d","type":"comment","z":"9921cbf1.f82328","name":"DESIGN","info":"","x":540,"y":300,"wires":[]},{"id":"e8e5abc8.bc5fe8","type":"comment","z":"9921cbf1.f82328","name":"ROUTE","info":"","x":530,"y":380,"wires":[]},{"id":"c35a03c7.b5996","type":"subflow:39834eee.0dd5a2","z":"9921cbf1.f82328","name":"","env":[],"x":820,"y":300,"wires":[["f6e95f68.59996"]]},{"id":"ca781c12.a2526","type":"subflow:a55f7aee.572be","z":"9921cbf1.f82328","name":"","env":[],"x":330,"y":340,"wires":[["102cb83c.632cd8"],["7fa9c732.feefe8"],["f6ff6532.fd5c58"]],"outputLabels":["DESIGN ","INIT","ACTION"]},{"id":"18f8719f.279d1e","type":"subflow:152aab03.7a806d","z":"9921cbf1.f82328","name":"","env":[],"x":3380,"y":300,"wires":[["5d76a2df.6c4dac"]]},{"id":"2c6b2776.25bf08","type":"subflow:152aab03.7a806d","z":"9921cbf1.f82328","name":"","env":[],"x":1600,"y":460,"wires":[["389c2247.4ac34e"]]},{"id":"98849c46.46fe6","type":"subflow:2ef93158.ae5276","z":"9921cbf1.f82328","name":"","env":[],"x":1140,"y":300,"wires":[["b84da9b.a394e58"]]},{"id":"e84386d.f3bdc78","type":"subflow:e25f5e2d.45871","z":"9921cbf1.f82328","name":"","env":[],"x":580,"y":80,"wires":[[]]},{"id":"1f48a4dd.0fb15b","type":"function","z":"9921cbf1.f82328","name":"","func":"\nreturn msg;","outputs":1,"noerr":0,"x":410,"y":80,"wires":[["e84386d.f3bdc78"]]},{"id":"569a0a55.e796d4","type":"link in","z":"9921cbf1.f82328","name":"","links":["1c858e53.87a6a2","c94013d0.c9ec3","1e8d4c5e.75a394","5d76a2df.6c4dac","d613a077.0cfbc","fc9a4475.d1aa48","ff901097.cca1e","ae36fa1c.c58368","f649a36e.fdce4","cb1986fd.810e68","a4b88935.b27c28","6bb20b81.bccea4","eebc68f0.d8a528","389c2247.4ac34e"],"x":235,"y":40,"wires":[["1f48a4dd.0fb15b"]]},{"id":"c94013d0.c9ec3","type":"link out","z":"9921cbf1.f82328","name":"","links":["569a0a55.e796d4"],"x":2295,"y":220,"wires":[]},{"id":"e51d11b2.4634e","type":"link in","z":"9921cbf1.f82328","name":"** Gadget Name **","links":["193edcb4.56c8e3","67412f74.5eb71"],"x":1435,"y":220,"wires":[["58a84c4c.3d95a4"]]},{"id":"5d76a2df.6c4dac","type":"link out","z":"9921cbf1.f82328","name":"","links":["569a0a55.e796d4"],"x":3455,"y":300,"wires":[]},{"id":"58a84c4c.3d95a4","type":"function","z":"9921cbf1.f82328","name":"breadcrumbBasic","func":"msg.payload = {\n    gadgetsList:[\n       {\n  \"gadgetId\": \"a562a518-fb7b-19cc-e9da-e76f288b9074\",\n  \"gadgetName\": \"breadcrumbBasic\",\n  \"gadgetType\": \"breadcrumbs\",\n  \"gadgetData\": [\n    {\n      \"buttonData\": {\n        \"title\": \"Breadcrumb item 1\",\n        \"allowSearch\": true,\n        \"design\": {\n        //   \"color\": \"white\",\n          \"icon\": \"comment_bank\",\n           \"size\":\"small\"\n        },\n        \"actionType\": \"button\",\n       \"options\": [\n          {\n            \"title\": \"Option 1.A\",\n            \"design\": {\n              \"color\": \"green\",\n              \"iconType\": \"icon\",\n              \"icon\": \"info\",\n              \"size\": \"large\"\n            },\n            \"selected\": true,\n            \"action\": {\n                \"option\": \"Option 1.A\",\n                \"type\":\"global\"\n            },\n      \n          },\n               {\n            \"title\": \"Option 1.B\",\n            \"design\": {\n              \"color\": \"orange\",\n              \"iconType\": \"icon\",\n              \"icon\": \"check_circle\"\n            },\n             \"action\": {\n                \"option\": \"Option 1.B\",\n                \"type\":\"global\"\n            },\n          },\n          {\n            \"title\": \"Option 1.C\",\n            \"design\": {\n              \"color\": \"red\",\n              \"iconType\": \"icon\",\n              \"icon\": \"check_circle\"\n            },\n             \"action\": {\n                \"option\": \"Option 1.C\",\n                \"type\":\"global\"\n            },\n          }\n        ],\n       \n      },\n      \"buttonOptions\": {\n        \"dataType\": \"multiple\",\n        \"displayType\": \"text\"\n      }\n    },\n    {\n      \"buttonData\": {\n        \"title\": \"Breadcrumb item 2\",\n        \"allowSearch\": true,\n        \"design\": {\n         \n          \"color\" : \"black\",\n          \"icon\": \"info\",\n          \"size\":\"medium\"\n        },\n        \"actionType\": \"button\",\n       \"options\": [\n          {\n            \"title\": \"Option 2.A\",\n            \"design\": {\n              \"color\": \"green\",\n              \"iconType\": \"icon\",\n              \"icon\": \"info\",\n              \"size\": \"large\"\n            },\n            \"selected\": true,\n            \"action\": {\n                option: \"Option 2.A\",\n                type:\"global\"\n            },\n      \n          },\n          {\n            \"title\": \"Option 2.B\",\n            \"design\": {\n              \"color\": \"red\",\n              \"iconType\": \"icon\",\n              \"icon\": \"check_circle\"\n            },\n             \"action\": {\n                \"option\": \"Option 2.B\",\n                \"type\":\"global\"\n            },\n          }\n        ],\n       \n      },\n      \"buttonOptions\": {\n        \"dataType\": \"multiple\",\n        \"displayType\": \"text\"\n      }\n    },\n     {\n      \"buttonData\": {\n        \"title\": \"Breadcrumb item 3\",\n        \"allowSearch\": true,\n        \"design\": {\n          \"color\": \"orange\",\n          \"icon\": \"code\",\n           \"size\":\"large\"\n        },\n        \"actionType\": \"button\",\n       \"options\": [\n          {\n            \"title\": \"Option 3.A\",\n            \"design\": {\n              \"color\": \"green\",\n              \"iconType\": \"icon\",\n              \"icon\": \"info\",\n              \"size\": \"large\"\n            },\n            \"selected\": true,\n            \"action\": {\n                \"option\": \"Option 3.A\",\n                \"type\":\"global\"\n            },\n      \n          },\n               {\n            \"title\": \"Option 3.B\",\n            \"design\": {\n              \"color\": \"orange\",\n              \"iconType\": \"icon\",\n              \"icon\": \"check_circle\"\n            },\n             \"action\": {\n                \"option\": \"Option 3.B\",\n                \"type\":\"global\"\n            },\n          },\n          {\n            \"title\": \"Option 3.C\",\n            \"design\": {\n              \"color\": \"red\",\n              \"iconType\": \"icon\",\n              \"icon\": \"check_circle\"\n            },\n             \"action\": {\n                \"option\": \"Option 3.C\",\n                \"type\":\"global\"\n            },\n          }\n        ],\n       \n      },\n      \"buttonOptions\": {\n        \"dataType\": \"multiple\",\n        \"displayType\": \"text\"\n      }\n    },\n  ],\n  \"gadgetOptions\": {\n    \"disabled\": false,\n    \"separatorIcon\": \"keyboard_arrow_right\",\n    \"title\": \"Used in breadcrumbs mobile can be null\"\n  }\n}\n      ]\n}\n\n\n\nmsg.payload.gadgetsList.push({\n                              \"gadgetId\": \"4f378c9f-3b11-86a8-2f4f-94b694230500\",\n                              \"gadgetName\": \"breadcrumbBasicText\",\n                              \"gadgetType\": \"wysiwyg\",\n                              \"gadgetData\": {\n                                   \"content\": JSON.stringify(msg.payload.gadgetsList[0])\n                                },\n                              \"gadgetOptions\": {\n                                \"disabled\": false,\n                                \"canEdit\": false,\n                                 \"editor\": \"froala\"\n                              }\n                            })\n                            \n                            \nmsg.payload.gadgetsList.push({\n                              \"gadgetId\": \"5e15dabf-ddbc-c1e6-7b65-cff1e60b1881\",\n                              \"gadgetName\": \"BasicTitle\",\n                              \"gadgetType\": \"divider\",\n                              \"gadgetData\": {\n                                \"borderStyle\": \"solid\",\n                                \"position\": \"left\",\n                                \"icon\": \"bookmark\",\n                                \"iconSize\": \"40\",\n                                \"background\": \"transparent\",\n                                \"title\": \"Breadcrumb Basic\",\n                                \"textTag\": \"h2\",\n                                \"color\": \"primary\"\n                              },\n                              \"gadgetOptions\": {\n                                \"disabled\": false\n                              }\n                            } )\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1630,"y":220,"wires":[["c94013d0.c9ec3"]]},{"id":"fc9a4475.d1aa48","type":"link out","z":"9921cbf1.f82328","name":"","links":["569a0a55.e796d4"],"x":2295,"y":300,"wires":[]},{"id":"9ace7eb.b1eda8","type":"link in","z":"9921cbf1.f82328","name":"** Gadget Name **","links":["193edcb4.56c8e3","67412f74.5eb71"],"x":1435,"y":300,"wires":[["47fe2b66.49e694"]]},{"id":"47fe2b66.49e694","type":"function","z":"9921cbf1.f82328","name":"breadcrumbSubButtons","func":"msg.payload = {\n    gadgetsList:[\n       \n       {\n  \"gadgetId\": \"db2a6c5d-953a-c1a8-d94f-bd2e9b88d5af\",\n  \"gadgetName\": \"breadcrumbSubButtons\",\n  \"gadgetType\": \"breadcrumbs\",\n  \"gadgetData\": [\n    {\n      \"buttonData\": {\n        \"title\": \"Breadcrumb item 1\",\n        \"allowSearch\": true,\n        \"design\": {\n          \"background-color\": \"white\",\n          \"icon\": \"comment_bank\"\n        },\n        \"action\": {\n          \"addAnyAction\": \"dependingOnWhatYouNeed\",\n          \"canBeString\": \"orObjectorArray\"\n        },\n        \"actionType\": \"button\",\n        \"subButton\": [\n          {\n            \"icon\": \"info\",\n            \"action\": \"primary 1\",\n            \"color\":\"primary\",\n            \"tooltip\":\"primary 1\",\n          },\n          {\n            \"icon\": \"thumb_up_alt\",\n            \"action\": \"success 1\",\n           \"color\":\"success\",\n           \"tooltip\": \"success 1\",\n          },\n            {\n            \"icon\": \"warning\",\n            \"action\": \"warning 1\",\n            \"color\":\"warning\",\n           \"tooltip\":\"warning 1\",\n          },\n             {\n            \"icon\": \"alarm\",\n            \"action\": \"danger 1\",\n            \"color\":\"danger\",\n           \"tooltip\":\"danger 1\",\n          }\n        ],\n      \n      },\n      \"buttonOptions\": {\n        \"dataType\": \"multiple\",\n        \"displayType\": \"text\"\n      }\n    },\n    {\n      \"buttonData\": {\n        \"title\": \"Breadcrumb item 2\",\n        \"allowSearch\": true,\n        \"design\": {\n          \"background-color\": \"white\",\n          \"icon\": \"comment_bank\"\n        },\n        \"action\": {\n          \"addAnyAction\": \"dependingOnWhatYouNeed\",\n          \"canBeString\": \"orObjectorArray\"\n        },\n        \"actionType\": \"button\",\n        \"subButton\": [\n          {\n            \"icon\": \"info\",\n            \"action\": \"primary 2\",\n            \"color\":\"primary\",\n           \"tooltip\":\"primary 2\",\n          },\n          {\n            \"icon\": \"thumb_up_alt\",\n            \"action\": \"success 2\",\n           \"color\":\"success\",\n           \"tooltip\":\"success 2\",\n          },\n            {\n            \"icon\": \"warning\",\n            \"action\": \"warning 2\",\n            \"color\":\"warning\",\n           \"tooltip\":\"warning 2\",\n          },\n             {\n            \"icon\": \"alarm\",\n            \"action\": \"danger 2\",\n            \"color\":\"danger\",\n           \"tooltip\":\"danger 2\",\n          }\n        ],\n      \n      },\n      \"buttonOptions\": {\n        \"dataType\": \"multiple\",\n        \"displayType\": \"text\"\n      }\n    },\n  ],\n  \"gadgetOptions\": {\n    \"disabled\": false,\n    \"separatorIcon\": \"keyboard_arrow_right\",\n    \"title\": \"Used in breadcrumbs mobile can be null\"\n  }\n}\n      \n      ]\n}\n\n\n\n\nmsg.payload.gadgetsList.push({\n                              \"gadgetId\": \"ec81a2ae-1fd5-6873-06f6-7feb24694a7a\",\n                              \"gadgetName\": \"breadcrumbSubButtonsText\",\n                              \"gadgetType\": \"wysiwyg\",\n                              \"gadgetData\": {\n                                    \"content\": JSON.stringify(msg.payload.gadgetsList[0])\n                              },\n                              \"gadgetOptions\": {\n                                \"disabled\": false,\n                                \"canEdit\": false,\n                                \"editor\": \"froala\"\n                              }\n                            })\n      \n                                 \nmsg.payload.gadgetsList.push({\n                              \"gadgetId\": \"d0819f5f-51ba-50ef-1fee-593df855236c\",\n                              \"gadgetName\": \"subbuttons\",\n                              \"gadgetType\": \"divider\",\n                              \"gadgetData\": {\n                                \"borderStyle\": \"solid\",\n                                \"position\": \"left-center\",\n                                \"icon\": \"bookmark\",\n                                \"iconSize\": \"40\",\n                                \"background\": \"transparent\",\n                                \"title\": \"Sub buttons\",\n                                \"textTag\": \"h2\",\n                                \"color\": \"primary\"\n                              },\n                              \"gadgetOptions\": {\n                                \"disabled\": false\n                              }\n                            } ) \n      \n      \nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1650,"y":300,"wires":[["fc9a4475.d1aa48"]]},{"id":"783e2299.1db02c","type":"debug","z":"e5822137.be45d","name":"Menu res","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":4000,"y":360,"wires":[]},{"id":"4314eee4.f4e7f","type":"debug","z":"d8703926.e2eca","name":"pre menu routing","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":430,"y":760,"wires":[]},{"id":"8366c6b2.7951b8","type":"debug","z":"152aab03.7a806d","name":"Menu res","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":660,"y":300,"wires":[]},{"id":"582d3ca5.214004","type":"debug","z":"d8703926.e2eca","name":"Menu redirect","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":780,"y":620,"wires":[]},{"id":"a8aa2565.f73818","type":"debug","z":"152aab03.7a806d","name":"Menu res 2","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":850,"y":180,"wires":[]},{"id":"a8ff24ce.78ef88","type":"debug","z":"5e9b9c1d.bbe4a4","name":"redirect subflow 1","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":870,"y":220,"wires":[]},{"id":"671e830e.08d56c","type":"debug","z":"5e9b9c1d.bbe4a4","name":"redirect subflow 1","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1190,"y":440,"wires":[]},{"id":"917c120a.8776e","type":"http response","z":"152aab03.7a806d","name":"","statusCode":"","headers":{},"x":1090,"y":480,"wires":[]},{"id":"f4360e46.6f855","type":"function","z":"152aab03.7a806d","name":"Route response menu","func":"var redirect,logout, other;\n\nif (msg.payload.hasOwnProperty(\"payload\")){\n    payload = msg.payload.payload\n    msg.RevotioData = msg.payload.RevotioData\n    msg.payload = payload\n}\n\n\nif (msg.payload.hasOwnProperty(\"Page\") || msg.payload.hasOwnProperty(\"data\")){\n    redirect = msg;\n} else if (msg.payload.hasOwnProperty(\"RevotioData\")  && msg.payload.RevotioData.hasOwnProperty(\"logout\")  &&msg.payload.RevotioData.logout === true){\n    logout = msg;\n} else {\n    other = msg;\n}\n\nreturn [redirect,logout, other];","outputs":3,"noerr":0,"initialize":"","finalize":"","x":900,"y":480,"wires":[["917c120a.8776e"],["917c120a.8776e"],[]],"outputLabels":["redirect","logout","other"]},{"id":"2abfe6c1.b1ac7a","type":"function","z":"9921cbf1.f82328","name":"Add to confirmation win window","func":"\nvar gadgetsList =[ {\n            \"gadgetId\":  \"1db1d21f-04ee-80fe-c48f-d5bb0d99039b\",\n            \"gadgetName\": \"actionConfirmationModal\",\n            \"gadgetType\": \"dynamic-modal\",\n            \"gadgetData\": {\"modalStatus\":\"show\"}}];\n\n  \ngadgetsList.push(\n       {\n  \"gadgetData\": {\n    \"data\": msg.data,\n    \"options\": {\"number-columns\":1}\n  },\n  \"gadgetId\": \"f37b93a0-4546-8be4-92b8-3c494fdd8f30\",\n  \"gadgetName\": \"actionConfirmationText\",\n  \"gadgetType\": \"dynamic-text-area\"\n}\n      )\n\nmsg.payload = {gadgetsList:gadgetsList};\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":3910,"y":380,"wires":[["ff901097.cca1e"]]},{"id":"ff901097.cca1e","type":"link out","z":"9921cbf1.f82328","name":"","links":["569a0a55.e796d4"],"x":4055,"y":380,"wires":[]},{"id":"46c8e8bf.f80d88","type":"function","z":"9921cbf1.f82328","name":"Set msg.data","func":"msg.data = [ {\n        \"label\": \"Gadget name\",\n        \"value\": msg.RevotioData.PostData.gadgetName\n      },\n      {\n        \"label\": \"Selected\",\n        \"value\": msg.RevotioData.PostData.gadgetData.selected\n      },\n      {\n        \"label\": \"Icon\",\n        \"value\": msg.RevotioData.PostData.gadgetData.icon\n      },\n      {\n        \"label\": \"Title\",\n        \"value\": msg.RevotioData.PostData.gadgetData.title\n      }\n      \n      \n      ]\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":3600,"y":380,"wires":[["2abfe6c1.b1ac7a"]]},{"id":"214539c7.4207b6","type":"function","z":"9921cbf1.f82328","name":"Set msg.data","func":"msg.data = [ {\n        \"label\": \"Gadget name\",\n        \"value\": msg.RevotioData.PostData.gadgetName\n      },\n      {\n        \"label\": \"Selected\",\n        \"value\": msg.RevotioData.PostData.gadgetData.selected.option\n      },\n      {\n        \"label\": \"Icon\",\n        \"value\": msg.RevotioData.PostData.gadgetData.icon\n      },\n      {\n        \"label\": \"Title\",\n        \"value\": msg.RevotioData.PostData.gadgetData.title\n      }\n      \n      \n      ]\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":3600,"y":340,"wires":[["2abfe6c1.b1ac7a"]]},{"id":"cb1986fd.810e68","type":"link out","z":"9921cbf1.f82328","name":"","links":["569a0a55.e796d4"],"x":2295,"y":340,"wires":[]},{"id":"c934eefd.40a3","type":"link in","z":"9921cbf1.f82328","name":"** Gadget Name **","links":["193edcb4.56c8e3","67412f74.5eb71"],"x":1435,"y":340,"wires":[["eaf885d1.c0e158"]]},{"id":"eaf885d1.c0e158","type":"function","z":"9921cbf1.f82328","name":"breadcrumbForm","func":"msg.payload = {\n    gadgetsList:[\n       {\n  \"gadgetId\": \"6f760438-dec6-9415-cb5e-2cf52c7d2e73\",\n  \"gadgetName\": \"breadcrumbForm\",\n  \"gadgetType\": \"breadcrumbs\",\n  \"gadgetData\": [\n    {\n      \"buttonData\": {\n        \"title\": \"Breadcrumb item 1\",\n        \"allowSearch\": true,\n        \"design\": {\n          \"background-color\": \"white\",\n          \"icon\": \"comment_bank\"\n        },\n        \"actionType\": \"button\",\n       \"options\": [\n          {\n            \"title\": \"Form 1.A - empty\",\n            \"design\": {\n              \"color\": \"green\",\n              \"iconType\": \"icon\",\n              \"icon\": \"info\",\n              \"size\": \"large\"\n            },\n            \"selected\": true,\n            \"actionType\": \"form\",\n            \"form\" :{\n              gadget:{\n                  \"gadgetData\": {\n                            \"canceled\": true,\n                            \"submitButtonAction\": true,\n                            \"submitOnInputChange\": true,\n                            \"id\":  \"Form A - empty\",\n                            \"nextButtonText\": \"Next\",\n                            \"showPrevious\": true,\n                         \n                            \"submitButtonText\": \"Submit\",\n                            \"title\":  \"Form A - empty\",\n                            \"steps\": [\n                              {\n                                \"fields\": [\n                                  {\n                                    \"htmlTag\": \"input\",\n                                    \"name\": \"Sample Input\",\n                                    \"options\": {\n                                      \"label\": \"Sample Input\",\n                                      \"placeholder\": \"Sample Inpu\",\n                                      \"required\": false,\n                                      \"type\": \"text\",\n                                      \"value\": \"\",\n                                      \"min\": \"\",\n                                      \"max\": \"\",\n                                      \"preview\": \"\",\n                                      \"disabled\": false,\n                                      \"previewPosition\": \"\"\n                                    }\n                                  },\n                                  {\n                                    \"name\": \"issue_type\",\n                                    \"htmlTag\": \"select\",\n                                    \"optionsGroup\": {\n                                      \"10010\": \"Information request\",\n                                      \"10012\": \"New feature request\",\n                                      \"10013\": \"Report Bug/ issue\"\n                                    },\n                                    \"options\": {\n                                      \"multiple\": false,\n                                      \"value\": \"\",\n                                      \"label\": \"Issue type\",\n                                      \"type\": \"text\",\n                                      \"placeholder\": \"\",\n                                      \"required\": false,\n                                      \"maxlength\": 100,\n                                      \"width\": 100,\n                                      \"info\": \"Choose the type of ticket you would like to create\"\n                                    }\n                                  },\n                                  {\n                                    \"name\": \"summary\",\n                                    \"htmlTag\": \"textarea\",\n                                    \"execActionData\": [\n                                      {\n                                        \"issue_type\": \"10010\"\n                                      },\n                                      {\n                                        \"issue_type\": \"10013\"\n                                      }\n                                    ],\n                                    \"options\": {\n                                      \"value\": \"\",\n                                      \"label\": \"What do you need?\",\n                                      \"type\": \"text\",\n                                      \"placeholder\": \"\",\n                                      \"required\": true,\n                                      \"maxlength\": 50,\n                                      \"width\": 100,\n                                      \"info\": \"Tell us what you're looking for. For example, 'put me on the mailing list'.\"\n                                    },\n                                    \"type\": \"text\"\n                                  }\n                                ]\n                              }\n                            ]\n                            \n                          },\n                        \"gadgetOptions\": {},\n                        //   \"gadgetId\": \"7cb43f66-cc5d-9564-3d51-3b1bf8479812\",\n                        //   \"gadgetName\": \"form\",\n                        //   \"gadgetType\": \"custom-form\"\n                },\n                values:{}\n    \n            }\n                },\n          {\n            \"title\": \"Form 1.B - mapped\",\n            \"design\": {\n              \"color\": \"orange\",\n              \"iconType\": \"icon\",\n              \"icon\": \"check_circle\"\n            },\n             \"actionType\": \"form\",\n            \"form\" :{\n              gadget:{\n                  \"gadgetData\": {\n                            \"canceled\": false,\n                            \"submitButtonAction\": true,\n                            \"submitOnInputChange\": true,\n                            \"id\":  \"Form 1.B - mapped\",\n                            \"nextButtonText\": \"Next\",\n                            \"showPrevious\": true,\n                            \"dismissDisabledSubmit\": false,\n                            \"submitButtonText\": \"Submit\",\n                            \"title\":  \"Form 1.B - mapped\",\n                            \"steps\": [\n                              {\n                                \"fields\": [\n                                  {\n                                    \"htmlTag\": \"input\",\n                                    \"name\": \"Sample Input\",\n                                    \"options\": {\n                                      \"label\": \"Sample Input\",\n                                      \"placeholder\": \"Sample Inpu\",\n                                      \"required\": false,\n                                      \"type\": \"text\",\n                                      \"value\": \"\",\n                                      \"min\": \"\",\n                                      \"max\": \"\",\n                                      \"preview\": \"\",\n                                      \"disabled\": false,\n                                      \"previewPosition\": \"\"\n                                    }\n                                  },\n                                  {\n                                    \"name\": \"issue_type\",\n                                    \"htmlTag\": \"select\",\n                                    \"optionsGroup\": {\n                                      \"10010\": \"Information request\",\n                                      \"10012\": \"New feature request\",\n                                      \"10013\": \"Report Bug/ issue\"\n                                    },\n                                    \"options\": {\n                                      \"multiple\": false,\n                                      \"value\": \"\",\n                                      \"label\": \"Issue type\",\n                                      \"type\": \"text\",\n                                      \"placeholder\": \"\",\n                                      \"required\": false,\n                                      \"maxlength\": 100,\n                                      \"width\": 100,\n                                      \"info\": \"Choose the type of ticket you would like to create\"\n                                    }\n                                  },\n                                  {\n                                    \"name\": \"summary\",\n                                    \"htmlTag\": \"textarea\",\n                                    \"execActionData\": [\n                                      {\n                                        \"issue_type\": \"10010\"\n                                      },\n                                      {\n                                        \"issue_type\": \"10013\"\n                                      }\n                                    ],\n                                    \"options\": {\n                                      \"value\": \"\",\n                                      \"label\": \"What do you need?\",\n                                      \"type\": \"text\",\n                                      \"placeholder\": \"\",\n                                      \"required\": true,\n                                      \"maxlength\": 50,\n                                      \"width\": 100,\n                                      \"info\": \"Tell us what you're looking for. For example, 'put me on the mailing list'.\"\n                                    },\n                                    \"type\": \"text\"\n                                  }\n                                ]\n                              }\n                            ]\n                            \n                          },\n                        \"gadgetOptions\": {},\n                        // //   \"gadgetId\": \"7cb43f66-cc5d-9564-3d51-3b1bf8479812\",\n                        //   \"gadgetName\": \"form\",\n                        //   \"gadgetType\": \"custom-form\"\n                },\n                values:{\n                    \n                    summary:\"A value for the summary field\",\n                    issue_type : \"10010\",\n                    [\"Sample Input\"]:\"Sample Input field value\"\n                }\n    \n            }\n          },\n          {\n             \"title\": \"Form 1.C - no form & values\",\n            \"design\": {\n              \"color\": \"red\",\n              \"iconType\": \"icon\",\n              \"icon\": \"check_circle\"\n            },\n            \"actionType\": \"form\",\n            \"form\" :{\n                gadget:{},\n                values:{}\n            }\n          }\n        ],\n       \n      },\n      \"buttonOptions\": {\n        \"dataType\": \"multiple\",\n        \"displayType\": \"text\"\n      }\n    },\n    {\n      \"buttonData\": {\n        \"title\": \"Breadcrumb item 2\",\n        \"allowSearch\": true,\n        \"design\": {\n          \"background-color\": \"white\",\n          \"icon\": \"comment_bank\"\n        },\n        \"actionType\": \"button\",\n       \"options\": [\n           {\n            \"title\": \"Form 2.A - empty && form gadgetAction\",\n            \"design\": {\n              \"color\": \"green\",\n              \"iconType\": \"icon\",\n              \"icon\": \"info\",\n              \"size\": \"large\"\n            },\n            \"selected\": true,\n            \"actionType\": \"form\",\n            \"form\" :{\n              gadget:{\n                  \"gadgetData\": {\n                            \"canceled\": false,\n                            \"submitButtonAction\": true,\n                            \"submitOnInputChange\": true,\n                            \"id\":  \"Form A - empty\",\n                            \"nextButtonText\": \"Next\",\n                            \"showPrevious\": true,\n                            \"dismissDisabledSubmit\": false,\n                            \"submitButtonText\": \"Submit\",\n                            \"title\":  \"Form A - empty\",\n                            \"steps\": [\n                              {\n                                \"fields\": [\n                                  {\n                                    \"htmlTag\": \"input\",\n                                    \"name\": \"Sample Input\",\n                                    \"options\": {\n                                      \"label\": \"Sample Input\",\n                                      \"placeholder\": \"Sample Inpu\",\n                                      \"required\": false,\n                                      \"type\": \"text\",\n                                      \"value\": \"\",\n                                      \"min\": \"\",\n                                      \"max\": \"\",\n                                      \"preview\": \"\",\n                                   \n                                      \"previewPosition\": \"\"\n                                    }\n                                  },\n                                  {\n                                    \"name\": \"issue_type\",\n                                    \"htmlTag\": \"select\",\n                                    \"optionsGroup\": {\n                                      \"10010\": \"Information request\",\n                                      \"10012\": \"New feature request\",\n                                      \"10013\": \"Report Bug/ issue\"\n                                    },\n                                    \"options\": {\n                                      \"multiple\": false,\n                                      \"value\": \"\",\n                                      \"label\": \"Issue type\",\n                                      \"type\": \"text\",\n                                      \"placeholder\": \"\",\n                                      \"required\": false,\n                                      \"maxlength\": 100,\n                                      \"width\": 100,\n                              \n                                      \"info\": \"Choose the type of ticket you would like to create\"\n                                    }\n                                  },\n                                  {\n                                    \"name\": \"summary\",\n                                    \"htmlTag\": \"textarea\",\n                                    \"execActionData\": [\n                                      {\n                                        \"issue_type\": \"10010\"\n                                      },\n                                      {\n                                        \"issue_type\": \"10013\"\n                                      }\n                                    ],\n                                    \"options\": {\n                                      \"value\": \"\",\n                                      \"label\": \"What do you need?\",\n                                      \"type\": \"text\",\n                                      \"placeholder\": \"\",\n                                      \"required\": true,\n                                      \"maxlength\": 50,\n                                      \"width\": 100,\n                                      \"info\": \"Tell us what you're looking for. For example, 'put me on the mailing list'.\"\n                                    },\n                                    \"type\": \"text\"\n                                  }\n                                ]\n                              }\n                            ]\n                            \n                          },\n                        \"gadgetOptions\": {},\n                        //   \"gadgetId\": \"7cb43f66-cc5d-9564-3d51-3b1bf8479812\",\n                          \"gadgetName\": \"breadcrumbForm\",\n                          \"gadgetType\": \"custom-form\"\n                },\n                values:{}\n    \n            }\n                },\n          {\n            \"title\": \"Form 2.B - mapped && form gadgetAction\",\n            \"design\": {\n              \"color\": \"orange\",\n              \"iconType\": \"icon\",\n              \"icon\": \"check_circle\"\n            },\n             \"actionType\": \"form\",\n            \"form\" :{\n              gadget:{\n                  \"gadgetData\": {\n                            \"canceled\": false,\n                            \"submitButtonAction\": true,\n                            \"submitOnInputChange\": true,\n                            \"id\":  \"Form 2.B - mapped\",\n                            \"nextButtonText\": \"Next\",\n                            \"showPrevious\": true,\n                            \"dismissDisabledSubmit\": false,\n                            \"submitButtonText\": \"Submit\",\n                            \"title\":  \"Form 2.B - mapped\",\n                            \"steps\": [\n                              {\n                                \"fields\": [\n                                  {\n                                    \"htmlTag\": \"input\",\n                                    \"name\": \"Sample Input\",\n                                    \"options\": {\n                                      \"label\": \"Sample Input\",\n                                      \"placeholder\": \"Sample Inpu\",\n                                      \"required\": false,\n                                      \"type\": \"text\",\n                                      \"value\": \"\",\n                                      \"min\": \"\",\n                                      \"max\": \"\",\n                                      \"preview\": \"\",\n                                     \n                                      \"previewPosition\": \"\"\n                                    }\n                                  },\n                                  {\n                                    \"name\": \"issue_type\",\n                                    \"htmlTag\": \"select\",\n                                    \"optionsGroup\": {\n                                      \"10010\": \"Information request\",\n                                      \"10012\": \"New feature request\",\n                                      \"10013\": \"Report Bug/ issue\"\n                                    },\n                                    \"options\": {\n                                      \"multiple\": false,\n                                      \"value\": \"\",\n                                      \"label\": \"Issue type\",\n                                      \"type\": \"text\",\n                                      \"placeholder\": \"\",\n                                      \"required\": false,\n                                      \"maxlength\": 100,\n                                      \"width\": 100,\n                                      \"info\": \"Choose the type of ticket you would like to create\"\n                                    }\n                                  },\n                                  {\n                                    \"name\": \"summary\",\n                                    \"htmlTag\": \"textarea\",\n                                    \"execActionData\": [\n                                      {\n                                        \"issue_type\": \"10010\"\n                                      },\n                                      {\n                                        \"issue_type\": \"10013\"\n                                      }\n                                    ],\n                                    \"options\": {\n                                      \"value\": \"\",\n                                      \"label\": \"What do you need?\",\n                                      \"type\": \"text\",\n                                      \"placeholder\": \"\",\n                                      \"required\": true,\n                                      \"maxlength\": 50,\n                                      \"width\": 100,\n                                      \"info\": \"Tell us what you're looking for. For example, 'put me on the mailing list'.\"\n                                    },\n                                    \"type\": \"text\"\n                                  }\n                                ]\n                              }\n                            ]\n                            \n                          },\n                        \"gadgetOptions\": {},\n                        //   \"gadgetId\": \"7cb43f66-cc5d-9564-3d51-3b1bf8479812\",\n                          \"gadgetName\": \"breadcrumbForm\",\n                          \"gadgetType\": \"custom-form\"\n                },\n                values:{\n                    \n                    summary:\"A value for the summary field\",\n                    issue_type : \"10010\",\n                    [\"Sample Input\"]:\"Sample Input field value\"\n                }\n    \n            }\n          },\n          {\n            \"title\": \"Form 2.C - no form & values\",\n            \"design\": {\n              \"color\": \"red\",\n              \"iconType\": \"icon\",\n              \"icon\": \"check_circle\"\n            },\n            \"actionType\": \"form\",\n            \"form\" :{\n                gadget:{},\n                values:{}\n            }\n          }\n        ],\n      \n      },\n      \"buttonOptions\": {\n        \"dataType\": \"multiple\",\n        \"displayType\": \"text\"\n      }\n    },\n  ],\n  \"gadgetOptions\": {\n    \"disabled\": false,\n    \"separatorIcon\": \"keyboard_arrow_right\",\n    \"title\": \"Used in breadcrumbs mobile can be null\"\n  }\n}\n      ]\n}\n\n\n\nmsg.payload.gadgetsList.push({\n                             \"gadgetId\": \"9cbf20f6-22f2-2152-1bae-bb4b2a72d226\",\n                              \"gadgetName\": \"breadcrumbFormText\",\n                              \"gadgetType\": \"wysiwyg\",\n                              \"gadgetData\": {\n                                \"content\": JSON.stringify(msg.payload.gadgetsList[0])\n                                },\n                              \"gadgetOptions\": {\n                                \"disabled\": false,\n                                \"canEdit\": false,\n                                 \"editor\": \"froala\"\n                              }\n                            })\n                            \nmsg.payload.gadgetsList.push({\n                             \"gadgetId\": \"e0dd5600-7fc3-8f87-2d7e-49647f70da5b\",\n                              \"gadgetName\": \"form\",\n                              \"gadgetType\": \"divider\",\n                              \"gadgetData\": {\n                                \"borderStyle\": \"solid\",\n                                \"position\": \"center\",\n                                \"icon\": \"bookmark\",\n                                \"iconSize\": \"40\",\n                                \"background\": \"transparent\",\n                                \"title\": \"Forms\",\n                                \"textTag\": \"h2\",\n                                \"color\": \"primary\"\n                              },\n                              \"gadgetOptions\": {\n                                \"disabled\": false\n                              }\n                            } ) \nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1630,"y":340,"wires":[["cb1986fd.810e68"]]},{"id":"9f5902f2.ab21b","type":"function","z":"9921cbf1.f82328","name":"Set msg.data","func":"\n\nmsg.data = [ {\n        \"label\": \"Gadget name\",\n        \"value\": msg.RevotioData.PostData.gadgetName\n      },\n      {\n        \"label\": \"Gadget type\",\n        \"value\": msg.RevotioData.PostData.gadgetType\n      },\n            {\n        \"label\": \"actionType\",\n        \"value\": msg.RevotioData.PostData.gadgetData.actionType\n      },\n      {\n        \"label\": \"FormData\",\n        \"value\": JSON.stringify(msg.RevotioData.PostData.gadgetData.formData)\n      },\n\n          {\n        \"label\": \"formObj\",\n        \"value\": JSON.stringify(msg.RevotioData.PostData.gadgetData.formObj)\n      },\n      ]\n      \n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":3600,"y":420,"wires":[["2abfe6c1.b1ac7a"]]},{"id":"a4b88935.b27c28","type":"link out","z":"9921cbf1.f82328","name":"","links":["569a0a55.e796d4"],"x":2295,"y":380,"wires":[]},{"id":"ac2bb9bc.e80f78","type":"link in","z":"9921cbf1.f82328","name":"** Gadget Name **","links":["193edcb4.56c8e3","67412f74.5eb71"],"x":1435,"y":380,"wires":[["6de1fecb.77b24"]]},{"id":"6de1fecb.77b24","type":"function","z":"9921cbf1.f82328","name":"breadcrumbTour","func":"msg.payload = {\n    gadgetsList:[\n       {\n  \"gadgetId\": \"14405e4a-dca8-09f2-8219-5a951580c296\",\n  \"gadgetName\": \"breadcrumbTour\",\n  \"gadgetType\": \"breadcrumbs\",\n  \"gadgetData\": [\n    {\n      \"buttonData\": {\n        \"title\": \"Breadcrumb item 1\",\n        \"allowSearch\": true,\n        \"design\": {\n          \"background-color\": \"white\",\n          \"icon\": \"comment_bank\"\n        },\n        \"actionType\": \"button\",\n       \"options\": [\n          {\n            \"title\": \"Tour 1.A\",\n            \"design\": {\n              \"color\": \"green\",\n              \"iconType\": \"icon\",\n              \"icon\": \"info\",\n              \"size\": \"large\"\n            },\n            \"selected\": true,\n            \"actionType\": \"button\",\n            action:{\n                 \"title\": \"Tour 1.A\",\n                 option : \"Tour 1.A\",\n            }\n            },\n          {\n          \"title\": \"Tour 1.B\",\n            \"design\": {\n              \"color\": \"orange\",\n              \"iconType\": \"icon\",\n              \"icon\": \"check_circle\"\n            },\n             \"actionType\": \"button\",\n             action:{\n                 \"title\": \"Tour 1.B\",\n                 option : \"Tour 1.B\",\n            }\n          },\n         \n        ],\n        \"tour\": {\n          \"content\": \"First tour box ==== placement = bottom\",\n          \"title\": \"First tour box\",\n          \"priority\": 1,\n          \"placement\": \"bottom\"\n        }\n      },\n      \"buttonOptions\": {\n        \"dataType\": \"multiple\",\n        \"displayType\": \"text\"\n      }\n    },\n    {\n      \"buttonData\": {\n        \"title\": \"Breadcrumb item 2\",\n        \"allowSearch\": true,\n        \"design\": {\n          \"background-color\": \"white\",\n          \"icon\": \"comment_bank\"\n        },\n        \"actionType\": \"button\",\n       \"options\": [\n          {\n            \"title\": \"Tour 2.A\",\n            \"design\": {\n              \"color\": \"green\",\n              \"iconType\": \"icon\",\n              \"icon\": \"info\",\n              \"size\": \"large\"\n            },\n            \"selected\": true,\n            \"actionType\": \"button\",\n             action:{\n                 \"title\": \"Tour 2.A\",\n                 option : \"Tour 2.A\",\n            }\n            },\n          {\n          \"title\": \"Tour 2.B\",\n            \"design\": {\n              \"color\": \"orange\",\n              \"iconType\": \"icon\",\n              \"icon\": \"check_circle\"\n            },\n             \"actionType\": \"button\",\n              action:{\n                 \"title\": \"Tour 2.B\",\n                 \"option\" : \"Tour 2.B\",\n            }\n          },\n         \n        ],\n        \"tour\": {\n          \"content\": \"Second tour box ==== placement = left\",\n          \"title\": \"Second tour box\",\n          \"priority\": 2,\n          \"placement\": \"left\"\n        }\n      },\n      \"buttonOptions\": {\n        \"dataType\": \"multiple\",\n        \"displayType\": \"text\"\n      }\n    },\n     {\n      \"buttonData\": {\n        \"title\": \"Breadcrumb item 3\",\n        \"allowSearch\": true,\n        \"design\": {\n          \"background-color\": \"white\",\n          \"icon\": \"comment_bank\"\n        },\n        \"actionType\": \"button\",\n       \"options\": [\n          {\n            \"title\": \"Tour 3.A\",\n            \"design\": {\n              \"color\": \"green\",\n              \"iconType\": \"icon\",\n              \"icon\": \"info\",\n              \"size\": \"large\"\n            },\n            \"selected\": true,\n            \"actionType\": \"button\",\n             action:{\n                 \"title\": \"Tour 3.A\",\n                 option : \"Tour 3.A\",\n            }\n            },\n          {\n          \"title\": \"Tour 3.B\",\n            \"design\": {\n              \"color\": \"orange\",\n              \"iconType\": \"icon\",\n              \"icon\": \"check_circle\"\n            },\n             \"actionType\": \"button\",\n              action:{\n                 \"title\": \"Tour 3.B\",\n                 option : \"Tour 3.B\",\n            }\n          },\n         \n        ],\n        \"tour\": {\n          \"content\": \"Fourth tour box ==== placement = top\",\n          \"title\": \"Fourth tour box\",\n          \"priority\": 4,\n          \"placement\": \"top\"\n        }\n      },\n      \"buttonOptions\": {\n        \"dataType\": \"multiple\",\n        \"displayType\": \"text\"\n      }\n    },\n    {\n      \"buttonData\": {\n        \"title\": \"Breadcrumb item 4\",\n        \"allowSearch\": true,\n        \"design\": {\n          \"background-color\": \"white\",\n          \"icon\": \"comment_bank\"\n        },\n        \"actionType\": \"button\",\n       \"options\": [\n          {\n            \"title\": \"Tour 4.A\",\n            \"design\": {\n              \"color\": \"green\",\n              \"iconType\": \"icon\",\n              \"icon\": \"info\",\n              \"size\": \"large\"\n            },\n            \"selected\": true,\n            \"actionType\": \"button\",\n             action:{\n                 \"title\": \"Tour 4.A\",\n                 option : \"Tour 4.A\",\n            }\n            },\n          {\n          \"title\": \"Tour 4.B\",\n            \"design\": {\n              \"color\": \"orange\",\n              \"iconType\": \"icon\",\n              \"icon\": \"check_circle\"\n            },\n             \"actionType\": \"button\",\n              action:{\n                 \"title\": \"Tour 4.B\",\n                 option : \"Tour 4.B\",\n            }\n          },\n         \n        ],\n        \"tour\": {\n          \"content\": \"Third tour box ==== placement = right\",\n          \"title\": \"Third tour box\",\n          \"priority\": 3,\n          \"placement\": \"right\"\n        }\n      },\n      \"buttonOptions\": {\n        \"dataType\": \"multiple\",\n        \"displayType\": \"text\"\n      }\n    },\n  ],\n  \"gadgetOptions\": {\n    \"disabled\": false,\n    \"separatorIcon\": \"keyboard_arrow_right\",\n    \"title\": \"Used in breadcrumbs mobile can be null\"\n  }\n}\n      ]\n}\n\n\n\nmsg.payload.gadgetsList.push({\n                              \"gadgetId\": \"28f00379-a936-d749-22ad-df46a3c4ae50\",\n                              \"gadgetName\": \"breadcrumbTourText\",\n                              \"gadgetType\": \"wysiwyg\",\n                              \"gadgetData\": {\n                                \"content\": JSON.stringify(msg.payload.gadgetsList[0])\n                                },\n                              \"gadgetOptions\": {\n                                \"disabled\": false,\n                                \"canEdit\": false,\n                                 \"editor\": \"froala\"\n                              }\n                            })\nmsg.payload.gadgetsList.push(\n                               {\n                                      \"gadgetId\": \"726781e0-ce02-633c-e63d-f0b468c34c81\",\n                                      \"gadgetName\": \"manageTourState\",\n                                      \"gadgetType\": \"dynamic-btn\",\n                                        'gadgetData' :{\n                                            switchOffLabel:\"Tour off\",\n                                            switchOnLabel:\"Off\",\n                                            title: \"Tour on\",\n                                            // options:options,\n                                            actionType:\"publisherAction\",\n                                            action:\"tour\",\n                                            design:{\n                                                icon:\"support\",\n                                                iconType:\"icon\",\n                                                size:\"large\",\n                                                switch: false,\n                                            },\n                                        },\n                                        \"gadgetOptions\": {\n                                         \"dataType\":\"single\",\n                                         \"displayType\":\"switch\"\n                                         \n                                            \n                                        },\n                                    })\nmsg.payload.gadgetsList.push({\n                             \"gadgetId\": \"69c75a1f-74fc-7a14-104d-d21ab1865faa\",\n                              \"gadgetName\": \"tourTitle\",\n                              \"gadgetType\": \"divider\",\n                              \"gadgetData\": {\n                                \"borderStyle\": \"solid\",\n                                \"position\": \"right-center\",\n                                \"icon\": \"bookmark\",\n                                \"iconSize\": \"40\",\n                                \"background\": \"transparent\",\n                                \"title\": \"Tour\",\n                                \"textTag\": \"h2\",\n                                \"color\": \"primary\"\n                              },\n                              \"gadgetOptions\": {\n                                \"disabled\": false\n                              }\n                            } ) \nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1620,"y":380,"wires":[["a4b88935.b27c28"]]},{"id":"74fbc787.b3cfe8","type":"function","z":"9921cbf1.f82328","name":"Set msg.data","func":"msg.data = [ {\n        \"label\": \"Gadget name\",\n        \"value\": msg.RevotioData.PostData.gadgetName\n      },\n      {\n        \"label\": \"Selected\",\n        \"value\": msg.RevotioData.PostData.gadgetData.selected.option\n      },\n      {\n        \"label\": \"Icon\",\n        \"value\": msg.RevotioData.PostData.gadgetData.icon\n      },\n      {\n        \"label\": \"Title\",\n        \"value\": msg.RevotioData.PostData.gadgetData.title\n      }\n      \n      \n      ]\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":3600,"y":460,"wires":[["2abfe6c1.b1ac7a"]]},{"id":"16db64b2.5ab03b","type":"subflow:53926ffd.c5a74","z":"e25f5e2d.45871","name":"","x":1380,"y":560,"wires":[["70b60a73.38b344"]]},{"id":"5d156f35.b0e81","type":"subflow:4cbbc60.828563c","z":"22428f45.8ab","name":"","x":310,"y":120,"wires":[]},{"id":"4f77ff18.3df8f","type":"subflow:5e9b9c1d.bbe4a4","z":"22428f45.8ab","name":"","x":2710,"y":460,"wires":[]},{"id":"45278fd1.18e39","type":"subflow:5e9b9c1d.bbe4a4","z":"22428f45.8ab","name":"","x":2380,"y":120,"wires":[]},{"id":"d890936b.19c77","type":"subflow:5e9b9c1d.bbe4a4","z":"22428f45.8ab","name":"","x":1500,"y":400,"wires":[]},{"id":"534fed46.ceb0f4","type":"subflow:5e9b9c1d.bbe4a4","z":"22428f45.8ab","name":"","x":1240,"y":800,"wires":[]},{"id":"ed062582.39fc48","type":"subflow:5e9b9c1d.bbe4a4","z":"22428f45.8ab","name":"","x":3400,"y":320,"wires":[]},{"id":"6bb20b81.bccea4","type":"link out","z":"9921cbf1.f82328","name":"","links":["569a0a55.e796d4"],"x":2295,"y":260,"wires":[]},{"id":"a1f71373.9e355","type":"link in","z":"9921cbf1.f82328","name":"** Gadget Name **","links":["193edcb4.56c8e3","67412f74.5eb71"],"x":1435,"y":260,"wires":[["21f7f7d8.431c58"]]},{"id":"21f7f7d8.431c58","type":"function","z":"9921cbf1.f82328","name":"breadcrumbBasicOptions","func":"msg.payload = {\n    gadgetsList:[\n       {\n  \"gadgetId\": \"2204b9f1-959e-7c87-3e9d-ad121fe37769\",\n  \"gadgetName\": \"basicOptions\",\n  \"gadgetType\": \"breadcrumbs\",\n  \"gadgetData\": [\n    {\n      \"buttonData\": {\n        \"title\": \"Breadcrumb option 'No search' \",\n        \"allowSearch\": false,\n        \"design\": {\n        //   \"color\": \"white\",\n        //   \"icon\": \"comment_bank\",\n        //   \"size\":\"small\"\n        },\n        \"actionType\": \"button\",\n       \"options\": [\n          {\n            \"title\": \"Option 1.A\",\n            \"design\": {\n              \"color\": \"green\",\n              \"iconType\": \"icon\",\n              \"icon\": \"info\",\n              \"size\": \"large\"\n            },\n            \"selected\": true,\n            \"action\": {\n                \"option\": \"Option 1.A\",\n                \"type\":\"global\"\n            },\n      \n          },\n               {\n            \"title\": \"Option 1.B\",\n            \"design\": {\n              \"color\": \"orange\",\n              \"iconType\": \"icon\",\n              \"icon\": \"check_circle\"\n            },\n             \"action\": {\n                \"option\": \"Option 1.B\",\n                \"type\":\"global\"\n            },\n          },\n          {\n            \"title\": \"Option 1.C\",\n            \"design\": {\n              \"color\": \"red\",\n              \"iconType\": \"icon\",\n              \"icon\": \"check_circle\"\n            },\n             \"action\": {\n                \"option\": \"Option 1.C\",\n                \"type\":\"global\"\n            },\n          }\n        ],\n       \n      },\n      \"buttonOptions\": {\n        \"dataType\": \"multiple\",\n        \"displayType\": \"text\"\n      }\n    },\n    {\n      \"buttonData\": {\n        \"title\": \"Breadcrumb option 'style'\",\n        \"allowSearch\": true,\n        \"design\": {\n          \"color\" : \"black\",\n        //   \"icon\": \"info\",\n          \"size\":\"medium\"\n        },\n        \"actionType\": \"button\",\n       \"options\": [\n          {\n            \"title\": \"Option 2.A\",\n            \"design\": {\n              \"color\": \"green\",\n              \"iconType\": \"icon\",\n              \"icon\": \"info\",\n              \"size\": \"large\"\n            },\n            \"selected\": true,\n            \"action\": {\n                option: \"Option 2.A\",\n                type:\"global\"\n            },\n      \n          },\n          {\n            \"title\": \"Option 2.B\",\n            \"design\": {\n              \"color\": \"red\",\n              \"iconType\": \"icon\",\n              \"icon\": \"check_circle\"\n            },\n             \"action\": {\n                \"option\": \"Option 2.B\",\n                \"type\":\"global\"\n            },\n          }\n        ],\n       \n      },\n      \"buttonOptions\": {\n        \"dataType\": \"multiple\",\n        \"displayType\": \"text\"\n      }\n    },\n     {\n      \"buttonData\": {\n        \"title\": \"Breadcrumb item 3\",\n        \"allowSearch\": true,\n        \"design\": {\n          \"color\": \"orange\",\n          \"icon\": \"code\",\n           \"size\":\"large\"\n        },\n        \"actionType\": \"button\",\n       \"options\": [\n          {\n            \"title\": \"Option 3.A\",\n            \"design\": {\n              \"color\": \"green\",\n              \"iconType\": \"icon\",\n              \"icon\": \"info\",\n              \"size\": \"large\"\n            },\n            \"selected\": true,\n            \"action\": {\n                \"option\": \"Option 3.A\",\n                \"type\":\"global\"\n            },\n      \n          },\n               {\n            \"title\": \"Option 3.B\",\n            \"design\": {\n              \"color\": \"orange\",\n              \"iconType\": \"icon\",\n              \"icon\": \"check_circle\"\n            },\n             \"action\": {\n                \"option\": \"Option 3.B\",\n                \"type\":\"global\"\n            },\n          },\n          {\n            \"title\": \"Option 3.C\",\n            \"design\": {\n              \"color\": \"red\",\n              \"iconType\": \"icon\",\n              \"icon\": \"check_circle\"\n            },\n             \"action\": {\n                \"option\": \"Option 3.C\",\n                \"type\":\"global\"\n            },\n          }\n        ],\n       \n      },\n      \"buttonOptions\": {\n        \"dataType\": \"multiple\",\n        \"displayType\": \"text\"\n      }\n    },\n  ],\n  \"gadgetOptions\": {\n    \"disabled\": false,\n    \"separatorIcon\": \"keyboard_arrow_right\",\n    \"title\": \"Used in breadcrumbs mobile can be null\"\n  }\n}\n      ]\n}\n\n\n\nmsg.payload.gadgetsList.push({\n                             \"gadgetId\": \"5dfd8feb-3844-a138-679c-1825ae8fa1e2\",\n                              \"gadgetName\": \"basicOptionsText\",\n                              \"gadgetType\": \"wysiwyg\",\n                              \"gadgetData\": {\n                                   \"content\": JSON.stringify(msg.payload.gadgetsList[0])\n                                },\n                              \"gadgetOptions\": {\n                                \"disabled\": false,\n                                \"canEdit\": false,\n                                 \"editor\": \"froala\"\n                              }\n                            })\n                            \n                            \nmsg.payload.gadgetsList.push({\n                             \"gadgetId\": \"1a6356ca-e51f-308d-1e63-0fc2ecbcec2f\",\n                              \"gadgetName\": \"BasicOptionsDivider\",\n                              \"gadgetType\": \"divider\",\n                              \"gadgetData\": {\n                                \"borderStyle\": \"solid\",\n                                \"position\": \"left-center\",\n                                \"icon\": \"bookmark\",\n                                \"iconSize\": \"40\",\n                                \"background\": \"transparent\",\n                                \"title\": \"Breadcrumb Basic\",\n                                \"textTag\": \"h2\",\n                                \"color\": \"primary\"\n                              },\n                              \"gadgetOptions\": {\n                                \"disabled\": false\n                              }\n                            } )\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1650,"y":260,"wires":[["6bb20b81.bccea4"]]},{"id":"eebc68f0.d8a528","type":"link out","z":"9921cbf1.f82328","name":"","links":["569a0a55.e796d4"],"x":2295,"y":420,"wires":[]},{"id":"d6d858a.66ff0a8","type":"link in","z":"9921cbf1.f82328","name":"** Gadget Name **","links":["193edcb4.56c8e3","67412f74.5eb71"],"x":1435,"y":420,"wires":[["f594ce2c.9510a"]]},{"id":"f594ce2c.9510a","type":"function","z":"9921cbf1.f82328","name":"resetPage","func":"msg.payload = {\n    gadgetsList:[\n      \n       {\n  \"gadgetId\": \"6cc169f8-bc77-cb3f-c5b9-3a2a4f0ad86d\",\n  \"gadgetName\": \"Reset page\",\n  \"gadgetType\": \"dynamic-btn\",\n  \"gadgetOptions\": {\n    \"dataType\": \"single\",\n    \"displayType\": \"button\"\n  },\n  \"gadgetData\": {\n    \"title\": \"Reset page\",\n    \n    \"design\": {\n      \"color\": \"#FFFF\",\n      \"icon\": \"reload\"\n    },\n    \"action\": \"page reset\",\n    \"actionType\": \"button\",\n   \n  }\n}\n      \n      ]\n}\n\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1600,"y":420,"wires":[["eebc68f0.d8a528"]]},{"id":"67412f74.5eb71","type":"link out","z":"9921cbf1.f82328","name":"Trigger gadgets","links":["1198ab94.12521c","6dd9e005.08317","15313496.c9b06b","6adedbdb.e70694","e714ad41.62fe18","26c29dda.6daf62","cd9f1d1b.bf34","e51d11b2.4634e","9ace7eb.b1eda8","662d87cc.7d0548","c934eefd.40a3","ac2bb9bc.e80f78","a1f71373.9e355","d6d858a.66ff0a8"],"x":3535,"y":520,"wires":[]},{"id":"429d9e1d.aa7f8","type":"comment","z":"9921cbf1.f82328","name":"calendar","info":"","x":200,"y":720,"wires":[]},{"id":"daccef55.18be4","type":"comment","z":"9921cbf1.f82328","name":"calendar gagdet actions","info":"","x":3210,"y":660,"wires":[]},{"id":"87d37e3f.7cb35","type":"comment","z":"9921cbf1.f82328","name":"***************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************","info":"","x":2530,"y":620,"wires":[]},{"id":"9c452783.18eb58","type":"link in","z":"9921cbf1.f82328","name":"organization global - INIT FLOW","links":["5d57bad4.0cdff4","9a050e9a.e90288","3b858951.2c8d86","febed477.696398","872892ea.2eac3"],"x":815,"y":800,"wires":[["755ecb09.36daa4","84e8811.9ab3d8"]]},{"id":"ed0dffed.4a497","type":"function","z":"9921cbf1.f82328","name":"Route userAction","func":"var   MenuAction,  resetPage, gadgetAction;\nvar PostData    = msg.RevotioData.PostData;\nvar Page        = msg.RevotioData.session.Page;\n\n if (PostData.gadgetType=== \"Menu\"){\n    MenuAction = msg;\n} else  if (PostData.gadgetName=== \"Reset page\"){\n    resetPage = msg;\n} else {\n    gadgetAction = msg\n}\n\n\n\n\n\n\nreturn [ MenuAction,  resetPage, gadgetAction];","outputs":3,"noerr":0,"initialize":"","finalize":"","x":3150,"y":800,"wires":[["4fc7e265.aeb7cc"],["8c0d6729.31a918"],["5576dbdd.1edac4"]],"outputLabels":[" MenuAction","resetPage","gadgetAction"]},{"id":"1c0550db.7f5aff","type":"debug","z":"9921cbf1.f82328","name":"calendar Gadget post","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":3140,"y":700,"wires":[]},{"id":"755ecb09.36daa4","type":"link out","z":"9921cbf1.f82328","name":"Trigger gadgets","links":["1198ab94.12521c","6dd9e005.08317","15313496.c9b06b","6adedbdb.e70694","e714ad41.62fe18","82d00db3.efde9","26c29dda.6daf62","cd9f1d1b.bf34","512c4306.470f9c","d2469f2a.9e267","662d87cc.7d0548","685e4089.55b23","86bfef5c.25f0a","da08c84b.c322f8","3deae426.0ad89c"],"x":1195,"y":800,"wires":[]},{"id":"7541c238.bf98ec","type":"comment","z":"9921cbf1.f82328","name":"INIT FLOW","info":"","x":780,"y":760,"wires":[]},{"id":"84e8811.9ab3d8","type":"debug","z":"9921cbf1.f82328","name":"calendar INIT post","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":950,"y":760,"wires":[]},{"id":"3969a289.94429e","type":"link in","z":"9921cbf1.f82328","name":"organization global - GadgetAction","links":["ca484bde.d6efc8","b636d429.212c48","a894361d.170a68"],"x":3015,"y":800,"wires":[["1c0550db.7f5aff","ed0dffed.4a497"]]},{"id":"254bd029.b4788","type":"link in","z":"9921cbf1.f82328","name":"organization global - design","links":["c98c548a.95f4b","ead712f3.5bdef8","21e338e3.2265f8"],"x":775,"y":700,"wires":[["86b3b181.36d35"]]},{"id":"49c85cac.8a77c4","type":"http response","z":"9921cbf1.f82328","name":"","statusCode":"","headers":{},"x":1350,"y":700,"wires":[]},{"id":"c55c8753.f91e78","type":"function","z":"9921cbf1.f82328","name":"breadcrumbs -  design","func":"msg.topbarContanerId =  \"9e859d4a-16d7-fcf7-9c79-b828bbf1d262\"\n// msg.payload.design = {}\n\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1060,"y":700,"wires":[["84aff97b.c01808"]]},{"id":"9e35f025.a4a55","type":"comment","z":"9921cbf1.f82328","name":"DESIGN","info":"","x":780,"y":660,"wires":[]},{"id":"82d00db3.efde9","type":"link in","z":"9921cbf1.f82328","name":"** Gadget Name **","links":["755ecb09.36daa4"],"x":1475,"y":900,"wires":[["76ca6384.96482c"]]},{"id":"d211399e.178378","type":"http in","z":"9921cbf1.f82328","name":"calendar","url":"/calendar","method":"post","upload":false,"swaggerDoc":"","x":180,"y":780,"wires":[["fb0b52dc.d5e81"]]},{"id":"21e338e3.2265f8","type":"link out","z":"9921cbf1.f82328","name":"","links":["254bd029.b4788"],"x":455,"y":740,"wires":[]},{"id":"872892ea.2eac3","type":"link out","z":"9921cbf1.f82328","name":"","links":["9c452783.18eb58"],"x":455,"y":780,"wires":[]},{"id":"a894361d.170a68","type":"link out","z":"9921cbf1.f82328","name":"","links":["3969a289.94429e"],"x":455,"y":820,"wires":[]},{"id":"7a06d0ab.fac08","type":"comment","z":"9921cbf1.f82328","name":"INIT","info":"","x":530,"y":780,"wires":[]},{"id":"553d8110.08e05","type":"comment","z":"9921cbf1.f82328","name":"DESIGN","info":"","x":540,"y":740,"wires":[]},{"id":"13d0d07a.c35bd","type":"comment","z":"9921cbf1.f82328","name":"ROUTE","info":"","x":530,"y":820,"wires":[]},{"id":"86b3b181.36d35","type":"subflow:39834eee.0dd5a2","z":"9921cbf1.f82328","name":"","env":[],"x":880,"y":700,"wires":[["c55c8753.f91e78"]]},{"id":"fb0b52dc.d5e81","type":"subflow:a55f7aee.572be","z":"9921cbf1.f82328","name":"","env":[],"x":310,"y":780,"wires":[["21e338e3.2265f8"],["872892ea.2eac3"],["a894361d.170a68"]],"outputLabels":["DESIGN ","INIT","ACTION"]},{"id":"4fc7e265.aeb7cc","type":"subflow:152aab03.7a806d","z":"9921cbf1.f82328","name":"","env":[],"x":3320,"y":740,"wires":[["d6bb8bf3.e689e8"]]},{"id":"76ca6384.96482c","type":"subflow:152aab03.7a806d","z":"9921cbf1.f82328","name":"","env":[],"x":1660,"y":900,"wires":[["745ed7a9.becce8"]]},{"id":"84aff97b.c01808","type":"subflow:2ef93158.ae5276","z":"9921cbf1.f82328","name":"","env":[],"x":1200,"y":700,"wires":[["49c85cac.8a77c4"]]},{"id":"ada94af4.e7ada8","type":"link in","z":"9921cbf1.f82328","name":"","links":["1c858e53.87a6a2","7e497deb.8200f4","1e8d4c5e.75a394","d6bb8bf3.e689e8","d613a077.0cfbc","55138d24.35b394","942e42e6.ea30e","ae36fa1c.c58368","f649a36e.fdce4","79778570.e5825c","2f774e87.4030b2","bdde0f3.e80b0f","2e6e73eb.5e00ac","745ed7a9.becce8","60d84304.bfd8fc","9af1a0bc.c3157","29b426b2.d8fb5a","eb37dced.e1ec9","185823ed.b85f1c","e18ab142.106d1","13f993fc.6d792c","8a377131.93d15","7f5bd638.29da18","e19917ce.3ef4b8","3746c4c3.df73ac","706df857.05e7f8","6b483753.e7d788","dd5a929.a9ac37","16884a4b.4af1f6","629c726c.ece06c","4cfd8f85.c642b","ddcf43e4.c35d7","be0585dc.b51f68","c25545b8.aa7048","76c4ecca.dfc2b4","a0d3cb4f.e5a1d8","b8aa911c.c508d","225e4780.50aac8","f7110a.24b56ef8","74a3505e.17e4f","d7433ee3.b1521","6810e9fb.510c98","3f00881e.57c498","7f002f4a.a63cc","a7afcb02.a54fc8","bb8fce61.6182e","abad270d.f651c8","3a74a888.476928","fc40095b.362128","16217be1.b91384","16e0679e.2abf78","7cba0fb9.d8c44","76d4be18.01317","454d6545.20dafc","51ef73ae.7d6f8c","7451fc36.e00044","16aff964.e989b7","2ae4780f.e39e38","422f5943.2bab28","f1fe052f.3dfbd8","2ee25b21.113a64","4aa125f7.7634ac","3e51f613.71b5fa","a926ca31.0313b8","a4f927df.422a68"],"x":255,"y":100,"wires":[["1f48a4dd.0fb15b"]]},{"id":"7e497deb.8200f4","type":"link out","z":"9921cbf1.f82328","name":"","links":["ada94af4.e7ada8"],"x":2335,"y":660,"wires":[]},{"id":"512c4306.470f9c","type":"link in","z":"9921cbf1.f82328","name":"** Gadget Name **","links":["755ecb09.36daa4","8c0d6729.31a918"],"x":1475,"y":660,"wires":[["126d072c.e2ab39"]]},{"id":"d6bb8bf3.e689e8","type":"link out","z":"9921cbf1.f82328","name":"","links":["ada94af4.e7ada8"],"x":3395,"y":740,"wires":[]},{"id":"126d072c.e2ab39","type":"function","z":"9921cbf1.f82328","name":"basic","func":"\nvar start = new Date();\nvar end = start \n\nend.setHours(end.getHours() + 4);\n\n\nmsg.payload = {\n    gadgetsList:[\n     \n       {\n  \"gadgetId\": \"49083f98-e36b-4a52-0bf7-6f437b06ff27\",\n  \"gadgetName\": \"basic\",\n  \"gadgetType\": \"calendar\",\n  \"gadgetOptions\": {\n    \"startDateRange\":start,\n    \"endDateRange\": end,\n    \"enableWeekEnds\": false,\n    \"weekendOnOffToggle\": false,\n    \"calendarViewToggle\": false,\n    \"startOftheWeek\": \"1\",\n    \"timeLabelFormat\": 12,\n    \"locale\": \"en-gb\",\n    \"selectOverlap\": \"anyEvents\",\n    \"showSideBar\": true,\n    \"sidebarCloseButton\": false,\n    \"calculateHoursADay\": false,\n    \"waitForActionPost\": false,\n    \"popOver\": false,\n    \"reset\": false\n  },\n  \"gadgetData\": {\n    \"events\": [\n      {\n        \"_id\": \"\",\n        \"formData\": {\n          \"end\": end,\n          \"start\": start,\n          \"title\": \"Event 1\",\n        },\n    \"end\": end,\n          \"start\": start,\n        \"title\": \"Event 1\",\n        \"disabled\": true,\n      }\n    ],\n  }\n}\n      \n      ]\n}\n\n\n\nmsg.payload.gadgetsList.push({\n                              \"gadgetId\": \"4f378c9f-3b11-86a8-2f4f-94b694230500\",\n                              \"gadgetName\": \"basicText\",\n                              \"gadgetType\": \"wysiwyg\",\n                              \"gadgetData\": {\n                                   \"content\": JSON.stringify(msg.payload.gadgetsList[0])\n                                },\n                              \"gadgetOptions\": {\n                                \"disabled\": false,\n                                \"canEdit\": false,\n                                 \"editor\": \"froala\"\n                              }\n                            })\n                            \n                            \nmsg.payload.gadgetsList.push({\n                              \"gadgetId\": \"5e15dabf-ddbc-c1e6-7b65-cff1e60b1881\",\n                              \"gadgetName\": \"BasicTitle\",\n                              \"gadgetType\": \"divider\",\n                              \"gadgetData\": {\n                                \"borderStyle\": \"solid\",\n                                \"position\": \"left\",\n                                \"icon\": \"bookmark\",\n                                \"iconSize\": \"40\",\n                                \"background\": \"transparent\",\n                                \"title\": \"Basic\",\n                                \"textTag\": \"h2\",\n                                \"color\": \"primary\"\n                              },\n                              \"gadgetOptions\": {\n                                \"disabled\": false\n                              }\n                            } )\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1650,"y":660,"wires":[["7e497deb.8200f4"]]},{"id":"55138d24.35b394","type":"link out","z":"9921cbf1.f82328","name":"","links":["ada94af4.e7ada8"],"x":2335,"y":740,"wires":[]},{"id":"d2469f2a.9e267","type":"link in","z":"9921cbf1.f82328","name":"** Gadget Name **","links":["755ecb09.36daa4","8c0d6729.31a918"],"x":1475,"y":740,"wires":[["c873f29e.84d22"]]},{"id":"c873f29e.84d22","type":"function","z":"9921cbf1.f82328","name":"range","func":"var start = new Date();\nvar end = start \n\nend.setHours(end.getHours() + 4);\n\nmsg.payload = {\n    gadgetsList:[\n       \n       {\n  \"gadgetId\": \"e3a1d9bf-a199-5885-086a-40947bb88ba4\",\n  \"gadgetName\": \"range\",\n  \"gadgetType\": \"calendar\",\n  \"gadgetOptions\": {\n    \"startDateRange\":start,\n    \"endDateRange\": end,\n    \"enableWeekEnds\": false,\n    \"weekendOnOffToggle\": false,\n    \"calendarViewToggle\": false,\n    \"startOftheWeek\": \"1\",\n    \"businessHours\": {\n      \"start\": \"07:00\",\n      \"end\": \"20:00\",\n      buffer:1\n        },\n    calendarHours:{\n        start:\"05:30\",\n        end:\"23:30\"\n    },\n    \"timeLabelFormat\": 12,\n    \"locale\": \"en-gb\",\n    \"selectOverlap\": \"anyEvents\",\n    \"showSideBar\": true,\n    \"sidebarCloseButton\": false,\n    \"calculateHoursADay\": false,\n    \"waitForActionPost\": false,\n    \"popOver\": false,\n    \"reset\": false\n  },\n  \"gadgetData\": {\n\n    \"events\": [\n      {\n        \"_id\": \"\",\n        \"formData\": {\n          \"end\": end,\n          \"start\": start,\n          \"title\": \"Event 1\",\n        },\n    \"end\": end,\n          \"start\": start,\n        \"title\": \"Event 1\",\n        \"disabled\": true,\n      }\n    ],\n  }\n}\n      \n      ]\n}\n\n\n\n\nmsg.payload.gadgetsList.push({\n                              \"gadgetId\": \"ec81a2ae-1fd5-6873-06f6-7feb24694a7a\",\n                              \"gadgetName\": \"rangeText\",\n                              \"gadgetType\": \"wysiwyg\",\n                              \"gadgetData\": {\n                                    \"content\": JSON.stringify(msg.payload.gadgetsList[0])\n                              },\n                              \"gadgetOptions\": {\n                                \"disabled\": false,\n                                \"canEdit\": false,\n                                \"editor\": \"froala\"\n                              }\n                            })\n      \n                                 \nmsg.payload.gadgetsList.push({\n                              \"gadgetId\": \"d0819f5f-51ba-50ef-1fee-593df855236c\",\n                              \"gadgetName\": \"rangeDivider\",\n                              \"gadgetType\": \"divider\",\n                              \"gadgetData\": {\n                                \"borderStyle\": \"solid\",\n                                \"position\": \"left-center\",\n                                \"icon\": \"bookmark\",\n                                \"iconSize\": \"40\",\n                                \"background\": \"transparent\",\n                                \"title\": \"Range\",\n                                \"textTag\": \"h2\",\n                                \"color\": \"primary\"\n                              },\n                              \"gadgetOptions\": {\n                                \"disabled\": false\n                              }\n                            } ) \n      \n      \nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1650,"y":740,"wires":[["55138d24.35b394"]]},{"id":"2f62ec6b.7fb6f4","type":"function","z":"9921cbf1.f82328","name":"Add to confirmation win window","func":"\nvar gadgetsList =[ {\n            \"gadgetId\":  \"1db1d21f-04ee-80fe-c48f-d5bb0d99039b\",\n            \"gadgetName\": \"actionConfirmationModal\",\n            \"gadgetType\": \"dynamic-modal\",\n            \"gadgetData\": {\"modalStatus\":\"show\"}}];\n\n  \ngadgetsList.push(\n       {\n  \"gadgetData\": {\n    \"data\": msg.data,\n    \"options\": {\"number-columns\":1}\n  },\n  \"gadgetOptions\":{\n       \"options\": {\n            \"label\": {\n              \"textWeight\": \"hairline\",\n              \"italic\": false,\n              \"size\": \"xs\"\n            },\n            \"value\": {\n              \"textWeight\": \"hairline\",\n              \"italic\": false,\n              \"size\": \"xs\"\n            }\n       }\n  },\n  \"gadgetId\": \"f37b93a0-4546-8be4-92b8-3c494fdd8f30\",\n  \"gadgetName\": \"actionConfirmationText\",\n  \"gadgetType\": \"dynamic-text-area\"\n}\n      )\n\nmsg.payload = {gadgetsList:gadgetsList};\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":3850,"y":820,"wires":[["942e42e6.ea30e"]]},{"id":"942e42e6.ea30e","type":"link out","z":"9921cbf1.f82328","name":"","links":["ada94af4.e7ada8"],"x":3995,"y":820,"wires":[]},{"id":"5576dbdd.1edac4","type":"function","z":"9921cbf1.f82328","name":"Set msg.data","func":"var request = global.get('request');\nvar Moment = global.get('moment');\nvar MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar crypto = global.get('crypto');\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\nmsg.data  = []\n\n_.each(msg.RevotioData.PostData.gadgetData, function(value , key){\n    \n    if (typeof value === \"object\"){\n        _.each(value, function(valueValue, valueValueKey){\n            msg.data.push({\n                    \"label\": key +\".\"+valueValueKey,\n                    \"value\": valueValue\n                  })\n    \n        })\n    } else {\n        msg.data.push({\n        \"label\": key,\n        \"value\": value\n      })\n    \n    }\n    \n    \n})\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":3520,"y":860,"wires":[["2f62ec6b.7fb6f4"]]},{"id":"79778570.e5825c","type":"link out","z":"9921cbf1.f82328","name":"","links":["ada94af4.e7ada8"],"x":2335,"y":780,"wires":[]},{"id":"685e4089.55b23","type":"link in","z":"9921cbf1.f82328","name":"** Gadget Name **","links":["755ecb09.36daa4","8c0d6729.31a918"],"x":1475,"y":780,"wires":[["41eec2b.6a23c3c"]]},{"id":"41eec2b.6a23c3c","type":"function","z":"9921cbf1.f82328","name":"events","func":"var start = new Date();\nvar end = start \nend.setHours(end.getHours() + 4);\n\nvar start2 = new Date();\nstart2.setHours(start2.getHours() + 5);\n\nvar end2 = start2 \nend2.setHours(end2.getHours() + 2);\n\nvar start3 = new Date();\nstart3.setHours(start3.getHours() + 8);\nvar end3 = start3\nend3.setHours(end3.getHours() + 1);\n\nvar start4 = new Date();\nstart4.setHours(start4.getHours() + 10);\nvar end4 = start4\nend4.setHours(end4.getHours() + 2);\n\nvar start5 = new Date();\nstart5.setHours(start5.getHours() + 13);\nvar end5= start5 \nend5.setHours(end5.getHours() + 3);\n\nvar start6 = new Date();\nstart6.setHours(start6.getHours() + 17);\nvar end6 = start6\nend6.setHours(end6.getHours() + 3);\n\nvar start7 = new Date();\nstart7.setHours(start7.getHours() + 22);\nvar end7 = start7\nend7.setHours(end7.getHours() + 5);\n\n\nmsg.payload = {\n    gadgetsList:[\n       \n       {\n  \"gadgetId\": \"a6c76368-9974-fe32-2aa6-7a2ad8d22ad6\",\n  \"gadgetName\": \"events\",\n  \"gadgetType\": \"calendar\",\n  \"gadgetOptions\": {\n    \"startDateRange\":start,\n    \"endDateRange\": end,\n    \"enableWeekEnds\": false,\n    \"weekendOnOffToggle\": false,\n    \"calendarViewToggle\": false,\n    \"startOftheWeek\": \"1\",\n    \"timeLabelFormat\": 12,\n    \"locale\": \"en-gb\",\n    \"selectOverlap\": \"anyEvents\",\n    \"showSideBar\": true,\n    \"sidebarCloseButton\": false,\n    \"calculateHoursADay\": false,\n    \"waitForActionPost\": false,\n    \"popOver\": false,\n    \"reset\": false\n  },\n  \"gadgetData\": {\n\n    \"events\": [\n      {\n        \"_id\": \"\",\n        \n         \"end\": end,\n          \"start\": start,\n        \"title\": \"Event 1, not editable\",\n        \"disabled\": true,\n      },\n      {\n        \"_id\": \"\",\n        \n         \"end\": end2,\n          \"start\": start2,\n        \"title\": \"Event 2, Editable\",\n        \"disabled\": false,\n      },\n     {\n        \"_id\": \"\",\n        \n         \"end\": end3,\n          \"start\": start3,\n        \"title\": \"Event 3, Editable & Description\",\n        description:{[\"Title value\"]:'<h2>Hi I am a Title value 1</h2>',[\"Title value\"]:'<h2>Hi I am a <strong>Title value 2<strong/></h2>'},\n        \"disabled\": false,\n      },\n       {\n        \"_id\": \"\",\n        \n         \"end\": end4,\n          \"start\": start4,\n        \"title\": \"Event 4, Editable & backgroundColor\",\n        // description:{[\"Title value\"]:'<h2>Hi I am a Title value 1</h2>',[\"Title value\"]:'<h2>Hi I am a <strong>Title value 2<strong/></h2>'},\n       \"backgroundColor\" : \"green\",\n        \"disabled\": false,\n      },\n          {\n        \"_id\": \"\",\n        \n         \"end\": end5,\n          \"start\": start5,\n        \"title\": \"Event 5, Editable & borderColor = red\",\n        // description:{[\"Title value\"]:'<h2>Hi I am a Title value 1</h2>',[\"Title value\"]:'<h2>Hi I am a <strong>Title value 2<strong/></h2>'},\n       \"borderColor\" : \"red\",\n        \"disabled\": false,\n      },\n       {\n        \"_id\": \"\",\n        \n         \"end\": end6,\n          \"start\": start6,\n        \"title\": \"Event 6, Editable & textColor = brown\",\n        // description:{[\"Title value\"]:'<h2>Hi I am a Title value 1</h2>',[\"Title value\"]:'<h2>Hi I am a <strong>Title value 2<strong/></h2>'},\n       \"textColor\" : \"red\",\n        \"disabled\": false,\n      },\n             {\n        \"_id\": \"\",\n        \n         \"end\": end7,\n          \"start\": start7,\n        \"title\": \"Event 7, Editable & display = background\",\n        // description:{[\"Title value\"]:'<h2>Hi I am a Title value 1</h2>',[\"Title value\"]:'<h2>Hi I am a <strong>Title value 2<strong/></h2>'},\n       \"display\" : \"background\",\n        \"disabled\": false,\n      }\n    ],\n  }\n}\n      \n      ]\n}\n\n\n\nmsg.payload.gadgetsList.push({\n                             \"gadgetId\": \"9cbf20f6-22f2-2152-1bae-bb4b2a72d226\",\n                              \"gadgetName\": \"eventsText\",\n                              \"gadgetType\": \"wysiwyg\",\n                              \"gadgetData\": {\n                                \"content\": JSON.stringify(msg.payload.gadgetsList[0])\n                                },\n                              \"gadgetOptions\": {\n                                \"disabled\": false,\n                                \"canEdit\": false,\n                                 \"editor\": \"froala\"\n                              }\n                            })\n                            \nmsg.payload.gadgetsList.push({\n                             \"gadgetId\": \"e0dd5600-7fc3-8f87-2d7e-49647f70da5b\",\n                              \"gadgetName\": \"eventsDivider\",\n                              \"gadgetType\": \"divider\",\n                              \"gadgetData\": {\n                                \"borderStyle\": \"solid\",\n                                \"position\": \"center\",\n                                \"icon\": \"bookmark\",\n                                \"iconSize\": \"40\",\n                                \"background\": \"transparent\",\n                                \"title\": \"Events\",\n                                \"textTag\": \"h2\",\n                                \"color\": \"primary\"\n                              },\n                              \"gadgetOptions\": {\n                                \"disabled\": false\n                              }\n                            } ) \nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1650,"y":780,"wires":[["79778570.e5825c"]]},{"id":"2f774e87.4030b2","type":"link out","z":"9921cbf1.f82328","name":"","links":["ada94af4.e7ada8"],"x":2335,"y":820,"wires":[]},{"id":"86bfef5c.25f0a","type":"link in","z":"9921cbf1.f82328","name":"** Gadget Name **","links":["755ecb09.36daa4","8c0d6729.31a918"],"x":1475,"y":820,"wires":[["f41bc2bb.b2538"]]},{"id":"f41bc2bb.b2538","type":"function","z":"9921cbf1.f82328","name":"tour","func":"var start = new Date();\nvar end = start \nend.setHours(end.getHours() + 4);\n\nvar start2 = new Date();\nstart2.setHours(start2.getHours() + 5);\n\nvar end2 = start2 \nend2.setHours(end2.getHours() + 2);\n\nvar start3 = new Date();\nstart3.setHours(start3.getHours() + 8);\nvar end3 = start3\nend3.setHours(end3.getHours() + 1);\n\nvar start4 = new Date();\nstart4.setHours(start4.getHours() + 10);\nvar end4 = start4\nend4.setHours(end4.getHours() + 2);\n\nvar start5 = new Date();\nstart5.setHours(start5.getHours() + 13);\nvar end5= start5 \nend5.setHours(end5.getHours() + 3);\n\nvar start6 = new Date();\nstart6.setHours(start6.getHours() + 17);\nvar end6 = start6\nend6.setHours(end6.getHours() + 3);\n\nvar start7 = new Date();\nstart7.setHours(start7.getHours() + 22);\nvar end7 = start7\nend7.setHours(end7.getHours() + 5);\n\n\nmsg.payload = {\n    gadgetsList:[\n       \n       {\n  \"gadgetId\": \"2da712f5-c6ed-7c17-81bf-44d573509068\",\n  \"gadgetName\": \"tour\",\n  \"gadgetType\": \"calendar\",\n  \"gadgetOptions\": {\n    \"startDateRange\":start,\n    \"endDateRange\": end,\n    \"enableWeekEnds\": false,\n    \"weekendOnOffToggle\": false,\n    \"calendarViewToggle\": false,\n    \"startOftheWeek\": \"1\",\n    \"timeLabelFormat\": 12,\n    \"locale\": \"en-gb\",\n    \"selectOverlap\": \"anyEvents\",\n    \"showSideBar\": true,\n    \"sidebarCloseButton\": false,\n    \"calculateHoursADay\": false,\n    \"waitForActionPost\": false,\n    \"popOver\": false,\n    \"reset\": false\n  },\n  \"gadgetData\": {\n            \"tours\": {\n                  \"eventsPicker\": {\n                    \"content\": \"Placement right && priority = 6 \",\n                    \"title\": \"Option == > eventsPicker\",\n                    \"priority\": 6,\n                    \"placement\": \"left\"\n                  },\n                  \"allDay\": {\n                    \"content\": \"Placement right && priority = 5 \",\n                   \"title\": \"Option == > allDay\",\n                    \"priority\": 5,\n                    \"placement\": \"top\"\n                  },\n                  \"calendarViewSwitch\": {\n                    \"content\": \"Placement right && priority = 4 \",\n                    \"title\": \"Option == > calendarViewSwitch\",\n                    \"priority\": 4,\n                    \"placement\": \"right\"\n                  },\n                  \"calendarViews\": {\n                      \"content\": \"Placement top && priority = 3 \",\n                   \"title\": \"Option == > calendarViews\",\n                    \"priority\": 3,\n                    \"placement\": \"top\"\n                  },\n                  \"today\": {\n                      \"content\": \"Placement left && priority = 2 \",\n                   \"title\": \"Option == > today\",\n                    \"priority\": 2,\n                    \"placement\": \"left\"\n                  },\n                  \"navigation\": {\n                   \"content\": \"Placement bottom && priority = 1 \",\n                   \"title\": \"Option == > navigation\",\n                    \"priority\": 1,\n                    \"placement\": \"bottom\"\n      }\n    }\n  }}]}\n\n\n\n\nmsg.payload.gadgetsList.push({\n                              \"gadgetId\": \"28f00379-a936-d749-22ad-df46a3c4ae50\",\n                              \"gadgetName\": \"breadcrumbTourText\",\n                              \"gadgetType\": \"wysiwyg\",\n                              \"gadgetData\": {\n                                \"content\": JSON.stringify(msg.payload.gadgetsList[0])\n                                },\n                              \"gadgetOptions\": {\n                                \"disabled\": false,\n                                \"canEdit\": false,\n                                 \"editor\": \"froala\"\n                              }\n                            })\nmsg.payload.gadgetsList.push(\n                               {\n                                      \"gadgetId\": \"726781e0-ce02-633c-e63d-f0b468c34c81\",\n                                      \"gadgetName\": \"manageTourState\",\n                                      \"gadgetType\": \"dynamic-btn\",\n                                        'gadgetData' :{\n                                            switchOffLabel:\"Tour off\",\n                                            switchOnLabel:\"Off\",\n                                            title: \"Tour on\",\n                                            // options:options,\n                                            actionType:\"publisherAction\",\n                                            action:\"tour\",\n                                            design:{\n                                                icon:\"support\",\n                                                iconType:\"icon\",\n                                                size:\"large\",\n                                                switch: false,\n                                            },\n                                        },\n                                        \"gadgetOptions\": {\n                                         \"dataType\":\"single\",\n                                         \"displayType\":\"switch\"\n                                         \n                                            \n                                        },\n                                    })\nmsg.payload.gadgetsList.push({\n                             \"gadgetId\": \"69c75a1f-74fc-7a14-104d-d21ab1865faa\",\n                              \"gadgetName\": \"tourTitle\",\n                              \"gadgetType\": \"divider\",\n                              \"gadgetData\": {\n                                \"borderStyle\": \"solid\",\n                                \"position\": \"right-center\",\n                                \"icon\": \"bookmark\",\n                                \"iconSize\": \"40\",\n                                \"background\": \"transparent\",\n                                \"title\": \"Tour\",\n                                \"textTag\": \"h2\",\n                                \"color\": \"primary\"\n                              },\n                              \"gadgetOptions\": {\n                                \"disabled\": false\n                              }\n                            } ) \nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1650,"y":820,"wires":[["2f774e87.4030b2"]]},{"id":"bdde0f3.e80b0f","type":"link out","z":"9921cbf1.f82328","name":"","links":["ada94af4.e7ada8"],"x":2335,"y":700,"wires":[]},{"id":"da08c84b.c322f8","type":"link in","z":"9921cbf1.f82328","name":"** Gadget Name **","links":["755ecb09.36daa4","8c0d6729.31a918"],"x":1475,"y":700,"wires":[["120e1a2.ea229e6"]]},{"id":"120e1a2.ea229e6","type":"function","z":"9921cbf1.f82328","name":"drag","func":"\nvar start = new Date();\nvar end = start \n\nend.setHours(end.getHours() + 4);\n\n\n\nmsg.payload = {\n    gadgetsList:[\n       {\n  \"gadgetId\": \"f9632d8f-c705-7775-b366-851ac8d96779\",\n  \"gadgetName\": \"eventsPicker\",\n  \"gadgetType\": \"calendar\",\n  \"gadgetOptions\": {\n    \"startDateRange\":start,\n    \"endDateRange\": end,\n    \"enableWeekEnds\": false,\n    \"weekendOnOffToggle\": false,\n    \"calendarViewToggle\": false,\n    \"startOftheWeek\": \"1\",\n    \"timeLabelFormat\": 12,\n    \"locale\": \"en-gb\",\n    \"selectOverlap\": \"anyEvents\",\n    \"showSideBar\": true,\n    \"sidebarCloseButton\": false,\n    \"calculateHoursADay\": false,\n    \"waitForActionPost\": false,\n    \"popOver\": false,\n    \"reset\": false\n  },\n  \"gadgetData\": {\n    \"eventsPicker\": [\n      {\n        \"label\": \"Morning Tasks\",\n        \"icon\": \"swipe\",\n        \"events\": [\n          {\n            \"title\": \"Cleaning\",\n            \"duration\": \"02:00\",\n            \"backgroundColor\": \"green\",\n            \"icon\": \"analytics\"\n          }\n        ]\n      }\n    ],\n    \"events\": [\n      {\n        \"_id\": \"\",\n        \"formData\": {\n          \"end\": end,\n          \"start\": start,\n          \"title\": \"Event 1\",\n        },\n    \"end\": end,\n          \"start\": start,\n        \"title\": \"Event 1\",\n        \"disabled\": true,\n      }\n    ],\n  }\n}\n      ]\n}\n\n\n\nmsg.payload.gadgetsList.push({\n                             \"gadgetId\": \"5dfd8feb-3844-a138-679c-1825ae8fa1e2\",\n                              \"gadgetName\": \"dragText\",\n                              \"gadgetType\": \"wysiwyg\",\n                              \"gadgetData\": {\n                                   \"content\": JSON.stringify(msg.payload.gadgetsList[0])\n                                },\n                              \"gadgetOptions\": {\n                                \"disabled\": false,\n                                \"canEdit\": false,\n                                 \"editor\": \"froala\"\n                              }\n                            })\n                            \n                            \nmsg.payload.gadgetsList.push({\n                             \"gadgetId\": \"1a6356ca-e51f-308d-1e63-0fc2ecbcec2f\",\n                              \"gadgetName\": \"dragDivider\",\n                              \"gadgetType\": \"divider\",\n                              \"gadgetData\": {\n                                \"borderStyle\": \"solid\",\n                                \"position\": \"left-center\",\n                                \"icon\": \"bookmark\",\n                                \"iconSize\": \"40\",\n                                \"background\": \"transparent\",\n                                \"title\": \"Events\",\n                                \"textTag\": \"h2\",\n                                \"color\": \"primary\"\n                              },\n                              \"gadgetOptions\": {\n                                \"disabled\": false\n                              }\n                            } )\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1650,"y":700,"wires":[["bdde0f3.e80b0f"]]},{"id":"2e6e73eb.5e00ac","type":"link out","z":"9921cbf1.f82328","name":"","links":["ada94af4.e7ada8"],"x":2335,"y":860,"wires":[]},{"id":"3deae426.0ad89c","type":"link in","z":"9921cbf1.f82328","name":"** Gadget Name **","links":["755ecb09.36daa4","8c0d6729.31a918"],"x":1475,"y":860,"wires":[["25b9546d.55db7c"]]},{"id":"25b9546d.55db7c","type":"function","z":"9921cbf1.f82328","name":"resetPage","func":"msg.payload = {\n    gadgetsList:[\n      \n       {\n  \"gadgetId\": \"6cc169f8-bc77-cb3f-c5b9-3a2a4f0ad86d\",\n  \"gadgetName\": \"Reset page\",\n  \"gadgetType\": \"dynamic-btn\",\n  \"gadgetOptions\": {\n    \"dataType\": \"single\",\n    \"displayType\": \"button\"\n  },\n  \"gadgetData\": {\n    \"title\": \"Reset page\",\n    \n    \"design\": {\n      \"color\": \"#FFFF\",\n      \"icon\": \"reload\"\n    },\n    \"action\": \"page reset\",\n    \"actionType\": \"button\",\n   \n  }\n}\n      \n      ]\n}\n\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1660,"y":860,"wires":[["2e6e73eb.5e00ac"]]},{"id":"8c0d6729.31a918","type":"link out","z":"9921cbf1.f82328","name":"Trigger gadgets","links":["1198ab94.12521c","6dd9e005.08317","15313496.c9b06b","6adedbdb.e70694","e714ad41.62fe18","26c29dda.6daf62","cd9f1d1b.bf34","512c4306.470f9c","d2469f2a.9e267","662d87cc.7d0548","685e4089.55b23","86bfef5c.25f0a","da08c84b.c322f8","3deae426.0ad89c"],"x":3375,"y":780,"wires":[]},{"id":"745ed7a9.becce8","type":"link out","z":"9921cbf1.f82328","name":"","links":["ada94af4.e7ada8"],"x":2335,"y":900,"wires":[]},{"id":"8155641f.de6968","type":"comment","z":"9921cbf1.f82328","name":"catalog","info":"","x":210,"y":1160,"wires":[]},{"id":"fb59ac8f.585be","type":"comment","z":"9921cbf1.f82328","name":"catalog gagdet actions","info":"","x":2940,"y":1120,"wires":[]},{"id":"a1f86fb8.473bc","type":"comment","z":"9921cbf1.f82328","name":"***************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************","info":"","x":2550,"y":1060,"wires":[]},{"id":"ef6eb36b.af4ba","type":"link in","z":"9921cbf1.f82328","name":"organization global - INIT FLOW","links":["5d57bad4.0cdff4","9a050e9a.e90288","3b858951.2c8d86","febed477.696398","dc2c6cd4.026f9"],"x":855,"y":1280,"wires":[["ecb2ebb1.a720c8","c5171db1.9e1ca"]]},{"id":"ae0b01c1.8de9d","type":"function","z":"9921cbf1.f82328","name":"Route userAction","func":"var   MenuAction,  resetPage, gadgetAction;\nvar PostData    = msg.RevotioData.PostData;\nvar Page        = msg.RevotioData.session.Page;\n\n if (PostData.gadgetType=== \"Menu\"){\n    MenuAction = msg;\n} else  if (PostData.gadgetName=== \"Reset page\"){\n    resetPage = msg;\n} else {\n    gadgetAction = msg\n}\n\n\n\n\n\n\nreturn [ MenuAction,  resetPage, gadgetAction];","outputs":3,"noerr":0,"initialize":"","finalize":"","x":3210,"y":1200,"wires":[["abf6ffa5.231a5"],["d7552120.ca7fc"],["507d3ba.67b95c4"]],"outputLabels":[" MenuAction","resetPage","gadgetAction"]},{"id":"9a7019b6.90a6e8","type":"debug","z":"9921cbf1.f82328","name":"catalog Gadget post","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":3180,"y":1140,"wires":[]},{"id":"ecb2ebb1.a720c8","type":"link out","z":"9921cbf1.f82328","name":"Trigger gadgets","links":["1198ab94.12521c","6dd9e005.08317","15313496.c9b06b","6adedbdb.e70694","e714ad41.62fe18","3ae2698b.1521a6","26c29dda.6daf62","cd9f1d1b.bf34","a4068274.1987a","9ca5395.6c309c8","662d87cc.7d0548","48dffeab.b720a","3e306bac.f04474","df2eca39.dced78","f4dfb767.07c788"],"x":1235,"y":1280,"wires":[]},{"id":"f114610f.bc3c4","type":"comment","z":"9921cbf1.f82328","name":"INIT FLOW","info":"","x":820,"y":1240,"wires":[]},{"id":"c5171db1.9e1ca","type":"debug","z":"9921cbf1.f82328","name":"catalog INIT post","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":990,"y":1240,"wires":[]},{"id":"b616d704.754c38","type":"link in","z":"9921cbf1.f82328","name":"organization global - GadgetAction","links":["ca484bde.d6efc8","b636d429.212c48","e5c5613e.a1fd2"],"x":3015,"y":1200,"wires":[["9a7019b6.90a6e8","ae0b01c1.8de9d"]]},{"id":"bcf0c7a0.257838","type":"link in","z":"9921cbf1.f82328","name":"organization global - design","links":["c98c548a.95f4b","ead712f3.5bdef8","a6aad1dc.7a4d9"],"x":815,"y":1180,"wires":[["fb8f755a.ec2bd8"]]},{"id":"e9fe39c6.4659c8","type":"http response","z":"9921cbf1.f82328","name":"","statusCode":"","headers":{},"x":1390,"y":1180,"wires":[]},{"id":"60fb726c.8a519c","type":"function","z":"9921cbf1.f82328","name":"breadcrumbs -  design","func":"msg.topbarContanerId =  \"9e859d4a-16d7-fcf7-9c79-b828bbf1d262\"\n// msg.payload.design = {}\n\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1100,"y":1180,"wires":[["fd004892.809e38"]]},{"id":"9f31662c.c9a0c8","type":"comment","z":"9921cbf1.f82328","name":"DESIGN","info":"","x":820,"y":1140,"wires":[]},{"id":"3ae2698b.1521a6","type":"link in","z":"9921cbf1.f82328","name":"** Gadget Name **","links":["ecb2ebb1.a720c8"],"x":1555,"y":1320,"wires":[["1fc8226d.22272e"]]},{"id":"322ceb30.cd3fe4","type":"http in","z":"9921cbf1.f82328","name":"catalog","url":"/catalog","method":"post","upload":false,"swaggerDoc":"","x":190,"y":1220,"wires":[["821e3ebb.a7831"]]},{"id":"a6aad1dc.7a4d9","type":"link out","z":"9921cbf1.f82328","name":"","links":["bcf0c7a0.257838"],"x":455,"y":1180,"wires":[]},{"id":"dc2c6cd4.026f9","type":"link out","z":"9921cbf1.f82328","name":"","links":["ef6eb36b.af4ba"],"x":455,"y":1220,"wires":[]},{"id":"e5c5613e.a1fd2","type":"link out","z":"9921cbf1.f82328","name":"","links":["b616d704.754c38"],"x":455,"y":1260,"wires":[]},{"id":"fa65a6d.8ef0358","type":"comment","z":"9921cbf1.f82328","name":"INIT","info":"","x":530,"y":1220,"wires":[]},{"id":"72f97731.c17928","type":"comment","z":"9921cbf1.f82328","name":"DESIGN","info":"","x":540,"y":1180,"wires":[]},{"id":"2405f4b3.91c8bc","type":"comment","z":"9921cbf1.f82328","name":"ROUTE","info":"","x":530,"y":1260,"wires":[]},{"id":"fb8f755a.ec2bd8","type":"subflow:39834eee.0dd5a2","z":"9921cbf1.f82328","name":"","env":[],"x":920,"y":1180,"wires":[["60fb726c.8a519c"]]},{"id":"821e3ebb.a7831","type":"subflow:a55f7aee.572be","z":"9921cbf1.f82328","name":"","env":[],"x":310,"y":1220,"wires":[["a6aad1dc.7a4d9"],["dc2c6cd4.026f9"],["e5c5613e.a1fd2"]],"outputLabels":["DESIGN ","INIT","ACTION"]},{"id":"abf6ffa5.231a5","type":"subflow:152aab03.7a806d","z":"9921cbf1.f82328","name":"","env":[],"x":3380,"y":1140,"wires":[["9af1a0bc.c3157"]]},{"id":"1fc8226d.22272e","type":"subflow:152aab03.7a806d","z":"9921cbf1.f82328","name":"","env":[],"x":1740,"y":1320,"wires":[["7f5bd638.29da18"]]},{"id":"fd004892.809e38","type":"subflow:2ef93158.ae5276","z":"9921cbf1.f82328","name":"","env":[],"x":1240,"y":1180,"wires":[["e9fe39c6.4659c8"]]},{"id":"60d84304.bfd8fc","type":"link out","z":"9921cbf1.f82328","name":"","links":["ada94af4.e7ada8"],"x":2415,"y":1120,"wires":[]},{"id":"a4068274.1987a","type":"link in","z":"9921cbf1.f82328","name":"** Gadget Name **","links":["ecb2ebb1.a720c8","d7552120.ca7fc"],"x":1555,"y":1120,"wires":[["ea44e9a9.7d6388"]]},{"id":"9af1a0bc.c3157","type":"link out","z":"9921cbf1.f82328","name":"","links":["ada94af4.e7ada8"],"x":3455,"y":1140,"wires":[]},{"id":"ea44e9a9.7d6388","type":"function","z":"9921cbf1.f82328","name":"basic","func":"\nvar start = new Date();\nvar end = start \n\nend.setHours(end.getHours() + 4);\n\n\nmsg.payload = {\n    gadgetsList:[\n     \n          {\n                  \"gadgetId\": \"e4a0b1e8-a9f7-d047-385c-06ead3138685\",\n                  \"gadgetName\": \"basic\",\n                  \"gadgetType\": \"catalog\",\n                  \"gadgetData\": {\n                    \"featuredImage\": \"/files/media/soup.jpg\",\n                    \"title\": \"Soup\",\n                    \"author\": \"Jane Doe\",\n                    \"isFavorite\": false,\n                    \"rating\": 3.4,\n                    \"footerInfo\": [\n                      {\n                        \"icon\": \"schedule\",\n                        \"label\": \"20 min\",\n                        \"color\": \"#d1d2d1\"\n                      },\n                      {\n                        \"icon\": \"/files/media/icons/pepper.svg\",\n                        \"label\": \"3/5\",\n                        \"color\": \"#d1d2d1\"\n                      }\n                    ],\n                    \"callActionType\": \"globalClick\",\n                    \"tooltipContent\": \"<bold> Lorem ipsum dolor sit amet</bold> , consectetuer adipiscing elit. Aenean commodo ligula eget dolor. Aenean massa. Cum sociis natoque penatibus et magnis dis parturient montes, nascetur ridiculus mus. Donec quam felis, ultricies nec, pellentesque eu, pretium quis, sem. Nulla consequat massa quis enim. Donec pede justo, fringilla vel, aliquet nec, vulputate eget, arcu. In enim justo, rhoncus ut, imperdiet a, venenatis vitae, justo. Nullam dictum felis eu pede mollis pretium. Integer tincidunt. Cras dapibus. Vivamus elementum semper nisi. Aenean vulputate eleifend tellus. Aenean leo ligula, porttitor eu, consequat vitae, eleifend ac, enim. Aliquam lorem ante, dapibus in, viverra quis, feugiat a, tellus. Phasellus viverra nulla ut metus varius laoreet. Quisque rutrum. Aenean imperdiet. Etiam ultricies nisi vel augue. Curabitur ullamcorper ultricies nisi. Nam eget dui.\",\n                    \"tooltipButtonLabel\": \"\"\n                  },\n                  \"gadgetOptions\": {\n                    \"disabled\": false,\n                    \"canEditTooltip\": false\n                  }\n                }\n      \n      ]\n}\n\n\n\nmsg.payload.gadgetsList.push({\n                              \"gadgetId\": \"4f378c9f-3b11-86a8-2f4f-94b694230500\",\n                              \"gadgetName\": \"basicText\",\n                              \"gadgetType\": \"wysiwyg\",\n                              \"gadgetData\": {\n                                   \"content\": JSON.stringify(msg.payload.gadgetsList[0])\n                                },\n                              \"gadgetOptions\": {\n                                \"disabled\": false,\n                                \"canEdit\": false,\n                                 \"editor\": \"froala\"\n                              }\n                            })\n                            \n                            \nmsg.payload.gadgetsList.push({\n                              \"gadgetId\": \"5e15dabf-ddbc-c1e6-7b65-cff1e60b1881\",\n                              \"gadgetName\": \"BasicTitle\",\n                              \"gadgetType\": \"divider\",\n                              \"gadgetData\": {\n                                \"borderStyle\": \"solid\",\n                                \"position\": \"left\",\n                                \"icon\": \"bookmark\",\n                                \"iconSize\": \"40\",\n                                \"background\": \"transparent\",\n                                \"title\": \"Basic\",\n                                \"textTag\": \"h2\",\n                                \"color\": \"primary\"\n                              },\n                              \"gadgetOptions\": {\n                                \"disabled\": false\n                              }\n                            } )\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1730,"y":1120,"wires":[["60d84304.bfd8fc"]]},{"id":"29b426b2.d8fb5a","type":"link out","z":"9921cbf1.f82328","name":"","links":["ada94af4.e7ada8"],"x":2415,"y":1200,"wires":[]},{"id":"9ca5395.6c309c8","type":"link in","z":"9921cbf1.f82328","name":"** Gadget Name **","links":["ecb2ebb1.a720c8","d7552120.ca7fc"],"x":1555,"y":1200,"wires":[["af57031e.a375"]]},{"id":"af57031e.a375","type":"function","z":"9921cbf1.f82328","name":"disabled","func":"msg.payload = {\n    gadgetsList:[\n     \n          {\n                \"gadgetId\": \"ac8e520b-212b-1a23-ed72-ecc1fbbaf66f\",\n                 \"gadgetName\": \"disabled\",\n                      \"gadgetType\": \"catalog\",\n                  \"gadgetData\": {\n                    \"featuredImage\": \"/files/media/pancakes.jpg\",\n                    \"title\": \"Pancakes\",\n                    \"author\": \"Mastro Pancakes\",\n                    \"isFavorite\": false,\n                    \"rating\": 2.8,\n                    \"footerInfo\": [\n                      {\n                        \"icon\": \"schedule\",\n                        \"label\": \"30 min\",\n                        \"color\": \"#d1d2d1\"\n                      },\n                      {\n                        \"icon\": \"/files/media/icons/pepper.svg\",\n                        \"label\": \"1/5\",\n                        \"color\": \"#d1d2d1\"\n                      }\n                    ],\n                    \"callActionType\": \"globalClick\",\n                    \"tooltipContent\": \"Lorem ipsum  <bold> Pancakes  </bold> sit amet, consectetuer adipiscing elit. Aenean commodo ligula eget dolor. Aenean massa. Cum sociis natoque penatibus et magnis dis parturient montes, nascetur ridiculus mus. Donec quam felis, ultricies nec, pellentesque eu, pretium quis, sem. Nulla consequat massa quis enim. Donec pede justo, fringilla vel, aliquet nec, vulputate eget, arcu. In enim justo, rhoncus ut, imperdiet a, venenatis vitae, justo. Nullam dictum felis eu pede mollis pretium. Integer tincidunt. Cras dapibus. Vivamus elementum semper nisi. Aenean vulputate eleifend tellus. Aenean leo ligula, porttitor eu, consequat vitae, eleifend ac, enim. Aliquam lorem ante, dapibus in, viverra quis, feugiat a, tellus. Phasellus viverra nulla ut metus varius laoreet. Quisque rutrum. Aenean imperdiet. Etiam ultricies nisi vel augue. Curabitur ullamcorper ultricies nisi. Nam eget dui.\",\n                    \"tooltipButtonLabel\": \"Pancakes label\"\n                  },\n                  \"gadgetOptions\": {\n                    \"disabled\": true,\n                    \"canEditTooltip\": false\n                  }\n                }\n      \n      ]\n}\n\n\nmsg.payload.gadgetsList.push({\n                              \"gadgetId\": \"ec81a2ae-1fd5-6873-06f6-7feb24694a7a\",\n                              \"gadgetName\": \"disabledText\",\n                              \"gadgetType\": \"wysiwyg\",\n                              \"gadgetData\": {\n                                    \"content\": JSON.stringify(msg.payload.gadgetsList[0])\n                              },\n                              \"gadgetOptions\": {\n                                \"disabled\": false,\n                                \"canEdit\": false,\n                                \"editor\": \"froala\"\n                              }\n                            })\n      \n                                 \nmsg.payload.gadgetsList.push({\n                              \"gadgetId\": \"d0819f5f-51ba-50ef-1fee-593df855236c\",\n                              \"gadgetName\": \"disabledDivider\",\n                              \"gadgetType\": \"divider\",\n                              \"gadgetData\": {\n                                \"borderStyle\": \"solid\",\n                                \"position\": \"left-center\",\n                                \"icon\": \"bookmark\",\n                                \"iconSize\": \"40\",\n                                \"background\": \"transparent\",\n                                \"title\": \"Disabled\",\n                                \"textTag\": \"h2\",\n                                \"color\": \"primary\"\n                              },\n                              \"gadgetOptions\": {\n                                \"disabled\": false\n                              }\n                            } ) \n      \n      \nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1740,"y":1200,"wires":[["29b426b2.d8fb5a"]]},{"id":"32860329.037b7c","type":"function","z":"9921cbf1.f82328","name":"Add to confirmation win window","func":"\nvar gadgetsList =[ {\n            \"gadgetId\":  \"1db1d21f-04ee-80fe-c48f-d5bb0d99039b\",\n            \"gadgetName\": \"actionConfirmationModal\",\n            \"gadgetType\": \"dynamic-modal\",\n            \"gadgetData\": {\"modalStatus\":\"show\"}}];\n\n  \ngadgetsList.push(\n       {\n  \"gadgetData\": {\n    \"data\": msg.data,\n    \"options\": {\"number-columns\":1}\n  },\n  \"gadgetOptions\":{\n       \"options\": {\n            \"label\": {\n              \"textWeight\": \"hairline\",\n              \"italic\": false,\n              \"size\": \"xs\"\n            },\n            \"value\": {\n              \"textWeight\": \"hairline\",\n              \"italic\": false,\n              \"size\": \"xs\"\n            }\n       }\n  },\n  \"gadgetId\": \"f37b93a0-4546-8be4-92b8-3c494fdd8f30\",\n  \"gadgetName\": \"actionConfirmationText\",\n  \"gadgetType\": \"dynamic-text-area\"\n}\n      )\n\nmsg.payload = {gadgetsList:gadgetsList};\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":3670,"y":1220,"wires":[["eb37dced.e1ec9"]]},{"id":"eb37dced.e1ec9","type":"link out","z":"9921cbf1.f82328","name":"","links":["ada94af4.e7ada8"],"x":3815,"y":1220,"wires":[]},{"id":"507d3ba.67b95c4","type":"function","z":"9921cbf1.f82328","name":"Set msg.data","func":"var request = global.get('request');\nvar Moment = global.get('moment');\nvar MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar crypto = global.get('crypto');\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\nmsg.data  = []\n\n_.each(msg.RevotioData.PostData.gadgetData, function(value , key){\n    \n    if (typeof value === \"object\"){\n        _.each(value, function(valueValue, valueValueKey){\n            msg.data.push({\n                    \"label\": key +\".\"+valueValueKey,\n                    \"value\": valueValue\n                  })\n    \n        })\n    } else {\n        msg.data.push({\n        \"label\": key,\n        \"value\": value\n      })\n    \n    }\n    \n    \n})\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":3500,"y":1220,"wires":[["32860329.037b7c"]]},{"id":"e18ab142.106d1","type":"link out","z":"9921cbf1.f82328","name":"","links":["ada94af4.e7ada8"],"x":2415,"y":1240,"wires":[]},{"id":"3e306bac.f04474","type":"link in","z":"9921cbf1.f82328","name":"** Gadget Name **","links":["ecb2ebb1.a720c8","d7552120.ca7fc"],"x":1555,"y":1240,"wires":[["d009361f.96fd08"]]},{"id":"d009361f.96fd08","type":"function","z":"9921cbf1.f82328","name":"tour","func":"msg.payload = {\n    gadgetsList:[\n     \n          {\n                  \"gadgetId\": \"862c9cde-3bfb-6ea2-28ff-b72aa556636c\",\n                  \"gadgetName\": \"tour\",\n                  \"gadgetType\": \"catalog\",\n                  \"gadgetData\": {\n                    \"featuredImage\": \"/files/media/ice cream.jpg\",\n                    \"title\": \"Ice cream\",\n                    \"author\": \"Mastro ice cream\",\n                    \"isFavorite\": false,\n                    \"rating\": 2.8,\n                    \"footerInfo\": [\n                      {\n                        \"icon\": \"schedule\",\n                        \"label\": \"30 min\",\n                        \"color\": \"#d1d2d1\"\n                      },\n                      {\n                        \"icon\": \"/files/media/icons/pepper.svg\",\n                        \"label\": \"1/5\",\n                        \"color\": \"#d1d2d1\"\n                      }\n                    ],\n                    \"callActionType\": \"globalClick\",\n                    \"tooltipContent\": \"Lorem ipsum  <bold> ice cream  </bold> sit amet, consectetuer adipiscing elit. Aenean commodo ligula eget dolor. Aenean massa. Cum sociis natoque penatibus et magnis dis parturient montes, nascetur ridiculus mus. Donec quam felis, ultricies nec, pellentesque eu, pretium quis, sem. Nulla consequat massa quis enim. Donec pede justo, fringilla vel, aliquet nec, vulputate eget, arcu. In enim justo, rhoncus ut, imperdiet a, venenatis vitae, justo. Nullam dictum felis eu pede mollis pretium. Integer tincidunt. Cras dapibus. Vivamus elementum semper nisi. Aenean vulputate eleifend tellus. Aenean leo ligula, porttitor eu, consequat vitae, eleifend ac, enim. Aliquam lorem ante, dapibus in, viverra quis, feugiat a, tellus. Phasellus viverra nulla ut metus varius laoreet. Quisque rutrum. Aenean imperdiet. Etiam ultricies nisi vel augue. Curabitur ullamcorper ultricies nisi. Nam eget dui.\",\n                    \"tooltipButtonLabel\": \"Pancakes label\",\n                  tour:{\n                      content:\"Tour content, left placement\",\n                      title :\"Tour title, left placement\",\n                      priority:1,\n                      placement :\"left\"\n                  }\n                      \n                  },\n                  \"gadgetOptions\": {\n                    \"disabled\": false,\n                    \"canEditTooltip\": false\n                  }\n                }\n      \n      ]\n}\n\n\n\nmsg.payload.gadgetsList.push({\n                              \"gadgetId\": \"28f00379-a936-d749-22ad-df46a3c4ae50\",\n                              \"gadgetName\": \"breadcrumbTourText\",\n                              \"gadgetType\": \"wysiwyg\",\n                              \"gadgetData\": {\n                                  \n                                \"content\": JSON.stringify(msg.payload.gadgetsList[0])\n                                },\n                              \"gadgetOptions\": {\n                                \"disabled\": false,\n                                \"canEdit\": false,\n                                 \"editor\": \"froala\"\n                              }\n                            })\nmsg.payload.gadgetsList.push(\n                               {\n                                      \"gadgetId\": \"726781e0-ce02-633c-e63d-f0b468c34c81\",\n                                      \"gadgetName\": \"manageTourState\",\n                                      \"gadgetType\": \"dynamic-btn\",\n                                        'gadgetData' :{\n                                             tour:{\n                      content:\"Tour state, right placement\",\n                      title :\"Tour state, right placement\",\n                      priority:2,\n                      placement :\"right\"\n                  },\n                                            switchOffLabel:\"Tour off\",\n                                            switchOnLabel:\"Off\",\n                                            title: \"Tour on\",\n                                            // options:options,\n                                            actionType:\"publisherAction\",\n                                            action:\"tour\",\n                                            design:{\n                                                icon:\"support\",\n                                                iconType:\"icon\",\n                                                size:\"large\",\n                                                switch: false,\n                                            },\n                                        },\n                                        \"gadgetOptions\": {\n                                         \"dataType\":\"single\",\n                                         \"displayType\":\"switch\"\n                                         \n                                            \n                                        },\n                                    })\nmsg.payload.gadgetsList.push({\n                             \"gadgetId\": \"69c75a1f-74fc-7a14-104d-d21ab1865faa\",\n                              \"gadgetName\": \"tourTitle\",\n                              \"gadgetType\": \"divider\",\n                              \"gadgetData\": {\n                                \"borderStyle\": \"solid\",\n                                \"position\": \"right-center\",\n                                \"icon\": \"bookmark\",\n                                \"iconSize\": \"40\",\n                                \"background\": \"transparent\",\n                                \"title\": \"Tour\",\n                                \"textTag\": \"h2\",\n                                \"color\": \"primary\"\n                              },\n                              \"gadgetOptions\": {\n                                \"disabled\": false\n                              }\n                            } ) \nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1730,"y":1240,"wires":[["e18ab142.106d1"]]},{"id":"13f993fc.6d792c","type":"link out","z":"9921cbf1.f82328","name":"","links":["ada94af4.e7ada8"],"x":2415,"y":1160,"wires":[]},{"id":"df2eca39.dced78","type":"link in","z":"9921cbf1.f82328","name":"** Gadget Name **","links":["ecb2ebb1.a720c8","d7552120.ca7fc"],"x":1555,"y":1160,"wires":[["cd96b602.b57c78"]]},{"id":"cd96b602.b57c78","type":"function","z":"9921cbf1.f82328","name":"tooltip","func":"\n\nmsg.payload = {\n    gadgetsList:[\n     \n          {\n                  \"gadgetId\": \"5dcbadee-aa09-f1c1-6135-312dfefdca6b\",\n                  \"gadgetName\": \"tooltip\",\n                  \"gadgetType\": \"catalog\",\n                  \"gadgetData\": {\n                    \"featuredImage\": \"/files/media/sandwich.jpg\",\n                    \"title\": \"Sandwich\",\n                    \"author\": \"Chef Sandwich\",\n                    \"isFavorite\": false,\n                    \"rating\": 2.8,\n                    \"footerInfo\": [\n                      {\n                        \"icon\": \"schedule\",\n                        \"label\": \"20 min\",\n                        \"color\": \"#d1d2d1\"\n                      },\n                      {\n                        \"icon\": \"/files/media/icons/pepper.svg\",\n                        \"label\": \"1/5\",\n                        \"color\": \"#d1d2d1\"\n                      }\n                    ],\n                    \"callActionType\": \"tooltip\",\n                    \"tooltipContent\": \"Lorem ipsum  <bold> sandwich  </bold> sit amet, consectetuer adipiscing elit. Aenean commodo ligula eget dolor. Aenean massa. Cum sociis natoque penatibus et magnis dis parturient montes, nascetur ridiculus mus. Donec quam felis, ultricies nec, pellentesque eu, pretium quis, sem. Nulla consequat massa quis enim. Donec pede justo, fringilla vel, aliquet nec, vulputate eget, arcu. In enim justo, rhoncus ut, imperdiet a, venenatis vitae, justo. Nullam dictum felis eu pede mollis pretium. Integer tincidunt. Cras dapibus. Vivamus elementum semper nisi. Aenean vulputate eleifend tellus. Aenean leo ligula, porttitor eu, consequat vitae, eleifend ac, enim. Aliquam lorem ante, dapibus in, viverra quis, feugiat a, tellus. Phasellus viverra nulla ut metus varius laoreet. Quisque rutrum. Aenean imperdiet. Etiam ultricies nisi vel augue. Curabitur ullamcorper ultricies nisi. Nam eget dui.\",\n                    \"tooltipButtonLabel\": \"sandwich label\"\n                  },\n                  \"gadgetOptions\": {\n                    \"disabled\": false,\n                    \"canEditTooltip\": true\n                  }\n                }\n      \n      ]\n}\n\n\n\nmsg.payload.gadgetsList.push({\n                             \"gadgetId\": \"5dfd8feb-3844-a138-679c-1825ae8fa1e2\",\n                              \"gadgetName\": \"tooltipText\",\n                              \"gadgetType\": \"wysiwyg\",\n                              \"gadgetData\": {\n                                   \"content\": JSON.stringify(msg.payload.gadgetsList[0])\n                                },\n                              \"gadgetOptions\": {\n                                \"disabled\": false,\n                                \"canEdit\": false,\n                                 \"editor\": \"froala\"\n                              }\n                            })\n                            \n                            \nmsg.payload.gadgetsList.push({\n                             \"gadgetId\": \"1a6356ca-e51f-308d-1e63-0fc2ecbcec2f\",\n                              \"gadgetName\": \"tooltipDivider\",\n                              \"gadgetType\": \"divider\",\n                              \"gadgetData\": {\n                                \"borderStyle\": \"solid\",\n                                \"position\": \"left-center\",\n                                \"icon\": \"bookmark\",\n                                \"iconSize\": \"40\",\n                                \"background\": \"transparent\",\n                                \"title\": \"tooltip\",\n                                \"textTag\": \"h2\",\n                                \"color\": \"primary\"\n                              },\n                              \"gadgetOptions\": {\n                                \"disabled\": false\n                              }\n                            } )\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1730,"y":1160,"wires":[["13f993fc.6d792c"]]},{"id":"8a377131.93d15","type":"link out","z":"9921cbf1.f82328","name":"","links":["ada94af4.e7ada8"],"x":2415,"y":1280,"wires":[]},{"id":"f4dfb767.07c788","type":"link in","z":"9921cbf1.f82328","name":"** Gadget Name **","links":["ecb2ebb1.a720c8","d7552120.ca7fc"],"x":1555,"y":1280,"wires":[["b3da5f9a.b172a"]]},{"id":"b3da5f9a.b172a","type":"function","z":"9921cbf1.f82328","name":"resetPage","func":"msg.payload = {\n    gadgetsList:[\n      \n       {\n  \"gadgetId\": \"6cc169f8-bc77-cb3f-c5b9-3a2a4f0ad86d\",\n  \"gadgetName\": \"Reset page\",\n  \"gadgetType\": \"dynamic-btn\",\n  \"gadgetOptions\": {\n    \"dataType\": \"single\",\n    \"displayType\": \"button\"\n  },\n  \"gadgetData\": {\n    \"title\": \"Reset page\",\n    \n    \"design\": {\n      \"color\": \"#FFFF\",\n      \"icon\": \"reload\"\n    },\n    \"action\": \"page reset\",\n    \"actionType\": \"button\",\n   \n  }\n}\n      \n      ]\n}\n\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1740,"y":1280,"wires":[["8a377131.93d15"]]},{"id":"d7552120.ca7fc","type":"link out","z":"9921cbf1.f82328","name":"Trigger gadgets","links":["1198ab94.12521c","6dd9e005.08317","15313496.c9b06b","6adedbdb.e70694","e714ad41.62fe18","26c29dda.6daf62","cd9f1d1b.bf34","a4068274.1987a","9ca5395.6c309c8","662d87cc.7d0548","48dffeab.b720a","3e306bac.f04474","df2eca39.dced78","f4dfb767.07c788"],"x":3435,"y":1180,"wires":[]},{"id":"7f5bd638.29da18","type":"link out","z":"9921cbf1.f82328","name":"","links":["ada94af4.e7ada8"],"x":2415,"y":1320,"wires":[]},{"id":"776cdf5c.689b4","type":"comment","z":"9921cbf1.f82328","name":"chip","info":"","x":210,"y":1500,"wires":[]},{"id":"94a5d40e.08fe08","type":"comment","z":"9921cbf1.f82328","name":"chip gagdet actions","info":"","x":3270,"y":1460,"wires":[]},{"id":"e4f8300e.7d9d","type":"comment","z":"9921cbf1.f82328","name":"***************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************","info":"","x":2550,"y":1400,"wires":[]},{"id":"4a7dc474.f5b2fc","type":"link in","z":"9921cbf1.f82328","name":"organization global - INIT FLOW","links":["5d57bad4.0cdff4","9a050e9a.e90288","3b858951.2c8d86","febed477.696398","92d030a2.3a705"],"x":855,"y":1620,"wires":[["475cd8f4.85e058","dfd02bd2.e7f9a8"]]},{"id":"4d8d83c6.c2b44c","type":"function","z":"9921cbf1.f82328","name":"Route userAction","func":"var   MenuAction,  resetPage, gadgetAction;\nvar PostData    = msg.RevotioData.PostData;\nvar Page        = msg.RevotioData.session.Page;\n\n if (PostData.gadgetType=== \"Menu\"){\n    MenuAction = msg;\n} else  if (PostData.gadgetName=== \"Reset page\"){\n    resetPage = msg;\n} else {\n    gadgetAction = msg\n}\n\n\n\n\n\n\nreturn [ MenuAction,  resetPage, gadgetAction];","outputs":3,"noerr":0,"initialize":"","finalize":"","x":3230,"y":1600,"wires":[["8cdb299b.d6a578"],["78558b37.8df614"],["f2c61273.60316"]],"outputLabels":[" MenuAction","resetPage","gadgetAction"]},{"id":"7337daea.1c0584","type":"debug","z":"9921cbf1.f82328","name":"chip Gadget post","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":3210,"y":1500,"wires":[]},{"id":"475cd8f4.85e058","type":"link out","z":"9921cbf1.f82328","name":"Trigger gadgets","links":["1198ab94.12521c","6dd9e005.08317","15313496.c9b06b","6adedbdb.e70694","e714ad41.62fe18","2347443c.e8e27c","26c29dda.6daf62","cd9f1d1b.bf34","b754a57d.248d58","5978c4de.8eda9c","662d87cc.7d0548","8fdc3ee2.10182","d8796ce5.52cdd","555e4376.ac3b0c","b41c9647.e2d728"],"x":1235,"y":1620,"wires":[]},{"id":"71ef0c8b.963a54","type":"comment","z":"9921cbf1.f82328","name":"INIT FLOW","info":"","x":820,"y":1580,"wires":[]},{"id":"dfd02bd2.e7f9a8","type":"debug","z":"9921cbf1.f82328","name":"chip INIT post","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":980,"y":1580,"wires":[]},{"id":"36ef5932.696326","type":"link in","z":"9921cbf1.f82328","name":"organization global - GadgetAction","links":["ca484bde.d6efc8","b636d429.212c48","68198337.253a2c"],"x":3035,"y":1600,"wires":[["7337daea.1c0584","4d8d83c6.c2b44c"]]},{"id":"bebabcaf.4cbaf","type":"link in","z":"9921cbf1.f82328","name":"organization global - design","links":["c98c548a.95f4b","ead712f3.5bdef8","618f63c3.825bac"],"x":815,"y":1520,"wires":[["86339cad.767a8"]]},{"id":"3adcc365.d7e92c","type":"http response","z":"9921cbf1.f82328","name":"","statusCode":"","headers":{},"x":1350,"y":1520,"wires":[]},{"id":"afa98057.efd1c","type":"function","z":"9921cbf1.f82328","name":"breadcrumbs -  design","func":"msg.topbarContanerId =  \"9e859d4a-16d7-fcf7-9c79-b828bbf1d262\"\n// msg.payload.design = {}\n\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1100,"y":1520,"wires":[["e8a04714.bbf4b8"]]},{"id":"92e8ce0f.a8a68","type":"comment","z":"9921cbf1.f82328","name":"DESIGN","info":"","x":820,"y":1480,"wires":[]},{"id":"2347443c.e8e27c","type":"link in","z":"9921cbf1.f82328","name":"** Gadget Name **","links":["475cd8f4.85e058"],"x":1535,"y":1700,"wires":[["ee29154b.687088"]]},{"id":"a3b99224.88c8","type":"http in","z":"9921cbf1.f82328","name":"chip","url":"/chip","method":"post","upload":false,"swaggerDoc":"","x":190,"y":1560,"wires":[["c75955e5.904418"]]},{"id":"618f63c3.825bac","type":"link out","z":"9921cbf1.f82328","name":"","links":["bebabcaf.4cbaf"],"x":455,"y":1520,"wires":[]},{"id":"92d030a2.3a705","type":"link out","z":"9921cbf1.f82328","name":"","links":["4a7dc474.f5b2fc"],"x":455,"y":1560,"wires":[]},{"id":"68198337.253a2c","type":"link out","z":"9921cbf1.f82328","name":"","links":["36ef5932.696326"],"x":455,"y":1600,"wires":[]},{"id":"4404cd7e.560254","type":"comment","z":"9921cbf1.f82328","name":"INIT","info":"","x":530,"y":1560,"wires":[]},{"id":"638cbe9f.c040d","type":"comment","z":"9921cbf1.f82328","name":"DESIGN","info":"","x":540,"y":1520,"wires":[]},{"id":"b3c11d28.df39","type":"comment","z":"9921cbf1.f82328","name":"ROUTE","info":"","x":530,"y":1600,"wires":[]},{"id":"86339cad.767a8","type":"subflow:39834eee.0dd5a2","z":"9921cbf1.f82328","name":"","env":[],"x":920,"y":1520,"wires":[["afa98057.efd1c"]]},{"id":"c75955e5.904418","type":"subflow:a55f7aee.572be","z":"9921cbf1.f82328","name":"","env":[],"x":310,"y":1560,"wires":[["618f63c3.825bac"],["92d030a2.3a705"],["68198337.253a2c"]],"outputLabels":["DESIGN ","INIT","ACTION"]},{"id":"8cdb299b.d6a578","type":"subflow:152aab03.7a806d","z":"9921cbf1.f82328","name":"","env":[],"x":3400,"y":1540,"wires":[["3746c4c3.df73ac"]]},{"id":"ee29154b.687088","type":"subflow:152aab03.7a806d","z":"9921cbf1.f82328","name":"","env":[],"x":1720,"y":1700,"wires":[["ddcf43e4.c35d7"]]},{"id":"e8a04714.bbf4b8","type":"subflow:2ef93158.ae5276","z":"9921cbf1.f82328","name":"","env":[],"x":1240,"y":1520,"wires":[["3adcc365.d7e92c"]]},{"id":"e19917ce.3ef4b8","type":"link out","z":"9921cbf1.f82328","name":"","links":["ada94af4.e7ada8"],"x":2395,"y":1460,"wires":[]},{"id":"b754a57d.248d58","type":"link in","z":"9921cbf1.f82328","name":"** Gadget Name **","links":["475cd8f4.85e058","78558b37.8df614"],"x":1535,"y":1460,"wires":[["6c103bd8.982484"]]},{"id":"3746c4c3.df73ac","type":"link out","z":"9921cbf1.f82328","name":"","links":["ada94af4.e7ada8"],"x":3475,"y":1540,"wires":[]},{"id":"6c103bd8.982484","type":"function","z":"9921cbf1.f82328","name":"basic","func":"\nvar start = new Date();\nvar end = start \n\nend.setHours(end.getHours() + 4);\n\n\nmsg.payload = {\n    gadgetsList:[\n     \n   \n       {\n  \"gadgetId\": \"8ebc580c-2724-3aea-3f9b-ff2ccc3909a9\",\n  \"gadgetName\": \"basic\",\n  \"gadgetType\": \"chip\",\n  \"gadgetData\": [\n    {\n      \"title\": \"Chip 1\",\n      \"avatar\": \"\",\n      \"icon\": \"bookmark\",\n      \"iconPack\": \"\",\n      \"transparent\": true,\n      \"color\": \"warning\",\n      \"allowEdit\": false,\n      \"allowDelete\": true,\n      \"src\": \"\"\n    },\n    {\n      \"title\": \"Chip 2\",\n      \"avatar\": \"\",\n      \"icon\": \"bookmark\",\n      \"iconPack\": \"\",\n      \"transparent\": true,\n      \"color\": \"warning\",\n      \"allowEdit\": false,\n      \"allowDelete\": false,\n      \"src\": \"\"\n    },\n    {\n      \"title\": \"Chip 3\",\n      \"avatar\": \"\",\n      \"icon\": \"bookmark\",\n      \"iconPack\": \"\",\n      \"transparent\": true,\n      \"color\": \"warning\",\n      \"allowEdit\": true,\n      \"allowDelete\": false,\n      \"src\": \"\"\n    }\n  ],\n  \"gadgetOptions\": {\n    \"disabled\": false,\n    \"addType\": \"list\",\n    \"allowAdd\": true,\n    \"chipsList\": [\n      {\n        \"title\": \"Suggest 1\",\n        \"avatar\": \"\",\n        \"icon\": \"bookmark\",\n        \"iconPack\": \"\",\n        \"transparent\": true,\n        \"color\": \"warning\",\n        \"allowEdit\": true,\n        \"allowDelete\": true,\n        \"src\": \"\"\n      },\n      {\n        \"title\": \"Suggest 2\",\n        \"avatar\": \"\",\n        \"icon\": \"bookmark\",\n        \"iconPack\": \"\",\n        \"transparent\": true,\n        \"color\": \"warning\",\n        \"allowEdit\": false,\n        \"allowDelete\": true,\n        \"src\": \"\"\n      },\n      {\n        \"title\": \"Suggest 3\",\n        \"avatar\": \"\",\n        \"icon\": \"bookmark\",\n        \"iconPack\": \"\",\n        \"transparent\": true,\n        \"color\": \"warning\",\n        \"allowEdit\": true,\n        \"allowDelete\": false,\n        \"src\": \"\"\n      },\n      {\n        \"title\": \"Suggest 4\",\n        \"avatar\": \"\",\n        \"icon\": \"bookmark\",\n        \"iconPack\": \"\",\n        \"transparent\": true,\n        \"color\": \"warning\",\n        \"allowEdit\": false,\n        \"allowDelete\": false,\n        \"src\": \"\"\n      }\n    ]\n  }\n}\n      \n      \n      ]\n}\n\n\n\nmsg.payload.gadgetsList.push({\n                              \"gadgetId\": \"4f378c9f-3b11-86a8-2f4f-94b694230500\",\n                              \"gadgetName\": \"basicText\",\n                              \"gadgetType\": \"wysiwyg\",\n                              \"gadgetData\": {\n                                   \"content\": JSON.stringify(msg.payload.gadgetsList[0])\n                                },\n                              \"gadgetOptions\": {\n                                \"disabled\": false,\n                                \"canEdit\": false,\n                                 \"editor\": \"froala\"\n                              }\n                            })\n                            \n                            \nmsg.payload.gadgetsList.push({\n                              \"gadgetId\": \"5e15dabf-ddbc-c1e6-7b65-cff1e60b1881\",\n                              \"gadgetName\": \"BasicTitle\",\n                              \"gadgetType\": \"divider\",\n                              \"gadgetData\": {\n                                \"borderStyle\": \"solid\",\n                                \"position\": \"left\",\n                                \"icon\": \"bookmark\",\n                                \"iconSize\": \"40\",\n                                \"background\": \"transparent\",\n                                \"title\": \"Basic\",\n                                \"textTag\": \"h2\",\n                                \"color\": \"primary\"\n                              },\n                              \"gadgetOptions\": {\n                                \"disabled\": false\n                              }\n                            } )\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1710,"y":1460,"wires":[["e19917ce.3ef4b8"]]},{"id":"706df857.05e7f8","type":"link out","z":"9921cbf1.f82328","name":"","links":["ada94af4.e7ada8"],"x":2395,"y":1540,"wires":[]},{"id":"5978c4de.8eda9c","type":"link in","z":"9921cbf1.f82328","name":"** Gadget Name **","links":["475cd8f4.85e058","78558b37.8df614"],"x":1535,"y":1540,"wires":[["62c6e2db.35c36c"]]},{"id":"62c6e2db.35c36c","type":"function","z":"9921cbf1.f82328","name":"crud","func":"\nmsg.payload = {\n    gadgetsList:[\n   \n       {\n  \"gadgetId\": \"c47ca97a-3191-1f14-b3b4-488cd6271ea8\",\n  \"gadgetName\": \"crud\",\n  \"gadgetType\": \"chip\",\n  \"gadgetData\": [\n    {\n      \"title\": \"Chip 1, edit\",\n      \"avatar\": \"\",\n      \"icon\": \"bookmark\",\n      \"iconPack\": \"\",\n      \"transparent\": false,\n      \"color\": \"warning\",\n      \"allowEdit\": true,\n      \"allowDelete\": false,\n      \"src\": \"\"\n    },\n    {\n      \"title\": \"Chip 2, delete\",\n      \"avatar\": \"\",\n      \"icon\": \"code\",\n      \"iconPack\": \"\",\n      \"transparent\": false,\n      \"color\": \"danger\",\n      \"allowEdit\": false,\n      \"allowDelete\": true,\n      \"src\": \"\"\n    },\n\n  ],\n  \"gadgetOptions\": {\n    \"disabled\": false,\n    \"addType\": \"list\",\n    \"allowAdd\": true,\n    \n    \"chipsList\" : [ {\n      \"title\": \"Chip 3, NEW edit\",\n      \"avatar\": \"\",\n      \"icon\": \"bookmark\",\n      \"iconPack\": \"\",\n      \"transparent\": false,\n      \"color\": \"primary\",\n      \"allowEdit\": true,\n      \"allowDelete\": false,\n      \"src\": \"\"\n    },\n    {\n      \"title\": \"Chip 4,NEW  delete\",\n      \"avatar\": \"\",\n      \"icon\": \"code\",\n      \"iconPack\": \"\",\n      \"transparent\": false,\n      \"color\": \"success\",\n      \"allowEdit\": false,\n      \"allowDelete\": true,\n      \"src\": \"\"\n    },\n]\n  }\n}\n      \n      ]\n}\n\n\n\n\nmsg.payload.gadgetsList.push({\n                              \"gadgetId\": \"ec81a2ae-1fd5-6873-06f6-7feb24694a7a\",\n                              \"gadgetName\": \"crudText\",\n                              \"gadgetType\": \"wysiwyg\",\n                              \"gadgetData\": {\n                                    \"content\": JSON.stringify(msg.payload.gadgetsList[0])\n                              },\n                              \"gadgetOptions\": {\n                                \"disabled\": false,\n                                \"canEdit\": false,\n                                \"editor\": \"froala\"\n                              }\n                            })\n      \n                                 \nmsg.payload.gadgetsList.push({\n                              \"gadgetId\": \"d0819f5f-51ba-50ef-1fee-593df855236c\",\n                              \"gadgetName\": \"crudDivider\",\n                              \"gadgetType\": \"divider\",\n                              \"gadgetData\": {\n                                \"borderStyle\": \"solid\",\n                                \"position\": \"left-center\",\n                                \"icon\": \"bookmark\",\n                                \"iconSize\": \"40\",\n                                \"background\": \"transparent\",\n                                \"title\": \"CRUD\",\n                                \"textTag\": \"h2\",\n                                \"color\": \"primary\"\n                              },\n                              \"gadgetOptions\": {\n                                \"disabled\": false\n                              }\n                            } ) \n      \n      \nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1710,"y":1540,"wires":[["706df857.05e7f8"]]},{"id":"a0273b37.91daa8","type":"function","z":"9921cbf1.f82328","name":"Add to confirmation win window","func":"\nvar gadgetsList =[ {\n            \"gadgetId\":  \"1db1d21f-04ee-80fe-c48f-d5bb0d99039b\",\n            \"gadgetName\": \"actionConfirmationModal\",\n            \"gadgetType\": \"dynamic-modal\",\n            \"gadgetData\": {\"modalStatus\":\"show\"}}];\n\n  \ngadgetsList.push(\n       {\n  \"gadgetData\": {\n    \"data\": msg.data,\n    \"options\": {\"number-columns\":1}\n  },\n  \"gadgetOptions\":{\n       \"options\": {\n            \"label\": {\n              \"textWeight\": \"hairline\",\n              \"italic\": false,\n              \"size\": \"xs\"\n            },\n            \"value\": {\n              \"textWeight\": \"hairline\",\n              \"italic\": false,\n              \"size\": \"xs\"\n            }\n       }\n  },\n  \"gadgetId\": \"f37b93a0-4546-8be4-92b8-3c494fdd8f30\",\n  \"gadgetName\": \"actionConfirmationText\",\n  \"gadgetType\": \"dynamic-text-area\"\n}\n      )\n\nmsg.payload = {gadgetsList:gadgetsList};\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":3750,"y":1620,"wires":[["6b483753.e7d788"]]},{"id":"6b483753.e7d788","type":"link out","z":"9921cbf1.f82328","name":"","links":["ada94af4.e7ada8"],"x":3895,"y":1620,"wires":[]},{"id":"f2c61273.60316","type":"function","z":"9921cbf1.f82328","name":"Set msg.data","func":"var request = global.get('request');\nvar Moment = global.get('moment');\nvar MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar crypto = global.get('crypto');\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\nmsg.data  = []\n\n_.each(msg.RevotioData.PostData.gadgetData, function(value , key){\n    \n    if (typeof value === \"object\"){\n        _.each(value, function(valueValue, valueValueKey){\n            msg.data.push({\n                    \"label\": key +\".\"+valueValueKey,\n                    \"value\": valueValue\n                  })\n    \n        })\n    } else {\n        msg.data.push({\n        \"label\": key,\n        \"value\": value\n      })\n    \n    }\n    \n    \n})\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":3540,"y":1620,"wires":[["a0273b37.91daa8"]]},{"id":"dd5a929.a9ac37","type":"link out","z":"9921cbf1.f82328","name":"","links":["ada94af4.e7ada8"],"x":2395,"y":1580,"wires":[]},{"id":"8fdc3ee2.10182","type":"link in","z":"9921cbf1.f82328","name":"** Gadget Name **","links":["475cd8f4.85e058","78558b37.8df614"],"x":1535,"y":1580,"wires":[[]]},{"id":"16884a4b.4af1f6","type":"link out","z":"9921cbf1.f82328","name":"","links":["ada94af4.e7ada8"],"x":2395,"y":1620,"wires":[]},{"id":"d8796ce5.52cdd","type":"link in","z":"9921cbf1.f82328","name":"** Gadget Name **","links":["475cd8f4.85e058","78558b37.8df614"],"x":1535,"y":1620,"wires":[["8cc28a84.dad438"]]},{"id":"8cc28a84.dad438","type":"function","z":"9921cbf1.f82328","name":"tour","func":"msg.payload = {\n    gadgetsList:[\n   \n\n       {\n  \"gadgetId\": \"3b9c3645-2864-7cf9-b320-c34147d303b9\",\n  \"gadgetName\": \"tour\",\n  \"gadgetType\": \"chip\",\n  \"gadgetData\": [\n    {\n      \"title\": \"Chip 1\",\n      \"avatar\": \"\",\n      \"icon\": \"bookmark\",\n      \"iconPack\": \"\",\n      \"transparent\": true,\n      \"color\": \"warning\",\n      \"allowEdit\": false,\n      \"allowDelete\": true,\n      \"src\": \"\"\n    },\n    {\n      \"title\": \"Chip 2\",\n      \"avatar\": \"\",\n      \"icon\": \"bookmark\",\n      \"iconPack\": \"\",\n      \"transparent\": true,\n      \"color\": \"warning\",\n      \"allowEdit\": false,\n      \"allowDelete\": false,\n      \"src\": \"\",\n       tour:{\n                      content:\"Tour on a chip itself, left placement\",\n                      title :\"Tour on a chip itself, left placement\",\n                      priority:3,\n                      placement :\"left\"\n                  },\n    },\n    {\n      \"title\": \"Chip 3\",\n      \"avatar\": \"\",\n      \"icon\": \"bookmark\",\n      \"iconPack\": \"\",\n      \"transparent\": true,\n      \"color\": \"warning\",\n      \"allowEdit\": true,\n      \"allowDelete\": false,\n      \"src\": \"\"\n    }\n  ],\n  \"gadgetOptions\": {\n    \"disabled\": false,\n    \"addType\": \"list\",\n    \"allowAdd\": true,\n     tour:{\n                      content:\"Tour chips, right placement\",\n                      title :\"Tour chips, right placement\",\n                      priority:1,\n                      placement :\"left\"\n                  },\n    \"chipsList\": [\n      {\n        \"title\": \"Suggest 1\",\n        \"avatar\": \"\",\n        \"icon\": \"bookmark\",\n        \"iconPack\": \"\",\n        \"transparent\": true,\n        \"color\": \"warning\",\n        \"allowEdit\": true,\n        \"allowDelete\": true,\n        \"src\": \"\"\n      },\n      {\n        \"title\": \"Suggest 2\",\n        \"avatar\": \"\",\n        \"icon\": \"bookmark\",\n        \"iconPack\": \"\",\n        \"transparent\": true,\n        \"color\": \"warning\",\n        \"allowEdit\": false,\n        \"allowDelete\": true,\n        \"src\": \"\"\n      },\n      {\n        \"title\": \"Suggest 3\",\n        \"avatar\": \"\",\n        \"icon\": \"bookmark\",\n        \"iconPack\": \"\",\n        \"transparent\": true,\n        \"color\": \"warning\",\n        \"allowEdit\": true,\n        \"allowDelete\": false,\n        \"src\": \"\"\n      },\n      {\n        \"title\": \"Suggest 4\",\n        \"avatar\": \"\",\n        \"icon\": \"bookmark\",\n        \"iconPack\": \"\",\n        \"transparent\": true,\n        \"color\": \"warning\",\n        \"allowEdit\": false,\n        \"allowDelete\": false,\n        \"src\": \"\"\n      }\n    ]\n  }\n}\n      \n      \n      ]\n}\n\n\n\nmsg.payload.gadgetsList.push({\n                              \"gadgetId\": \"28f00379-a936-d749-22ad-df46a3c4ae50\",\n                              \"gadgetName\": \"breadcrumbTourText\",\n                              \"gadgetType\": \"wysiwyg\",\n                              \"gadgetData\": {\n                                \"content\": JSON.stringify(msg.payload.gadgetsList[0])\n                                },\n                              \"gadgetOptions\": {\n                                \"disabled\": false,\n                                \"canEdit\": false,\n                                 \"editor\": \"froala\"\n                              }\n                            })\nmsg.payload.gadgetsList.push(\n                               {\n                                      \"gadgetId\": \"726781e0-ce02-633c-e63d-f0b468c34c81\",\n                                      \"gadgetName\": \"manageTourState\",\n                                      \"gadgetType\": \"dynamic-btn\",\n                                        'gadgetData' :{\n                                                                  tour:{\n                      content:\"Tour state, right placement\",\n                      title :\"Tour state, right placement\",\n                      priority:2,\n                      placement :\"right\"\n                  },\n                                            switchOffLabel:\"Tour off\",\n                                            switchOnLabel:\"Off\",\n                                            title: \"Tour on\",\n                                            // options:options,\n                                            actionType:\"publisherAction\",\n                                            action:\"tour\",\n                                            design:{\n                                                icon:\"support\",\n                                                iconType:\"icon\",\n                                                size:\"large\",\n                                                switch: false,\n                                            },\n                                        },\n                                        \"gadgetOptions\": {\n                                         \"dataType\":\"single\",\n                                         \"displayType\":\"switch\"\n                                         \n                                            \n                                        },\n                                    })\nmsg.payload.gadgetsList.push({\n                             \"gadgetId\": \"69c75a1f-74fc-7a14-104d-d21ab1865faa\",\n                              \"gadgetName\": \"tourTitle\",\n                              \"gadgetType\": \"divider\",\n                              \"gadgetData\": {\n                                \"borderStyle\": \"solid\",\n                                \"position\": \"right-center\",\n                                \"icon\": \"bookmark\",\n                                \"iconSize\": \"40\",\n                                \"background\": \"transparent\",\n                                \"title\": \"Tour\",\n                                \"textTag\": \"h2\",\n                                \"color\": \"primary\"\n                              },\n                              \"gadgetOptions\": {\n                                \"disabled\": false\n                              }\n                            } ) \nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1710,"y":1620,"wires":[["16884a4b.4af1f6"]]},{"id":"629c726c.ece06c","type":"link out","z":"9921cbf1.f82328","name":"","links":["ada94af4.e7ada8"],"x":2395,"y":1500,"wires":[]},{"id":"555e4376.ac3b0c","type":"link in","z":"9921cbf1.f82328","name":"** Gadget Name **","links":["475cd8f4.85e058","78558b37.8df614"],"x":1535,"y":1500,"wires":[["db2a2bd9.f4d838"]]},{"id":"db2a2bd9.f4d838","type":"function","z":"9921cbf1.f82328","name":"design","func":"\nmsg.payload = {\n    gadgetsList:[\n   \n       {\n  \"gadgetId\": \"b321f2f0-af3b-598a-4034-f6b8d02cae7e\",\n  \"gadgetName\": \"design\",\n  \"gadgetType\": \"chip\",\n  \"gadgetData\": [\n    {\n      \"title\": \"Chip 1, transparent & materials icon & color = primary\",\n      \"avatar\": \"\",\n      \"icon\": \"bookmark\",\n      \"iconPack\": \"\",\n      \"transparent\": true,\n      \"color\": \"primary\",\n      \"allowEdit\": false,\n      \"allowDelete\": false,\n      \"src\": \"\"\n    },\n    {\n      \"title\": \"Chip 2, solid & materials icon & color = success\",\n      \"avatar\": \"\",\n      \"icon\": \"code\",\n      \"iconPack\": \"\",\n      \"transparent\": false,\n      \"color\": \"success\",\n      \"allowEdit\": false,\n      \"allowDelete\": false,\n      \"src\": \"\"\n    },\n    {\n      \"title\": \"Chip 3 transparent, image icon & color = warning\",\n      \"avatar\": \"\",\n    //   \"icon\": \"design\",\n    //   \"iconPack\": \"\",\n      \"transparent\": true,\n      \"color\": \"warning\",\n      \"allowEdit\": false,\n      \"allowDelete\": false,\n      \"src\": \"/files/logo/factory/logo.jpg\"\n    },\n      {\n      \"title\": \"Chip 4 solid & jpg icon & color = danger\",\n      \"avatar\": \"\",\n    //   \"icon\": \"design\",\n    //   \"iconPack\": \"\",\n      \"transparent\": false,\n      \"color\": \"danger\",\n      \"allowEdit\": false,\n      \"allowDelete\": false,\n      \"src\": \"/files/logo/factory/logo.jpg\"\n    }\n  ],\n  \"gadgetOptions\": {\n    \"disabled\": false,\n    \"addType\": \"list\",\n    \"allowAdd\": false,\n\n  }\n}\n      \n      ]\n}\n\n\n\nmsg.payload.gadgetsList.push({\n                             \"gadgetId\": \"5dfd8feb-3844-a138-679c-1825ae8fa1e2\",\n                              \"gadgetName\": \"designText\",\n                              \"gadgetType\": \"wysiwyg\",\n                              \"gadgetData\": {\n                                   \"content\": JSON.stringify(msg.payload.gadgetsList[0])\n                                },\n                              \"gadgetOptions\": {\n                                \"disabled\": false,\n                                \"canEdit\": false,\n                                 \"editor\": \"froala\"\n                              }\n                            })\n                            \n                            \nmsg.payload.gadgetsList.push({\n                             \"gadgetId\": \"1a6356ca-e51f-308d-1e63-0fc2ecbcec2f\",\n                              \"gadgetName\": \"designDivider\",\n                              \"gadgetType\": \"divider\",\n                              \"gadgetData\": {\n                                \"borderStyle\": \"solid\",\n                                \"position\": \"left-center\",\n                                \"icon\": \"bookmark\",\n                                \"iconSize\": \"40\",\n                                \"background\": \"transparent\",\n                                \"title\": \"Design\",\n                                \"textTag\": \"h2\",\n                                \"color\": \"primary\"\n                              },\n                              \"gadgetOptions\": {\n                                \"disabled\": false\n                              }\n                            } )\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1710,"y":1500,"wires":[["629c726c.ece06c"]]},{"id":"4cfd8f85.c642b","type":"link out","z":"9921cbf1.f82328","name":"","links":["ada94af4.e7ada8"],"x":2395,"y":1660,"wires":[]},{"id":"b41c9647.e2d728","type":"link in","z":"9921cbf1.f82328","name":"** Gadget Name **","links":["475cd8f4.85e058","78558b37.8df614"],"x":1535,"y":1660,"wires":[["57ca495e.fe8f38"]]},{"id":"57ca495e.fe8f38","type":"function","z":"9921cbf1.f82328","name":"resetPage","func":"msg.payload = {\n    gadgetsList:[\n      \n       {\n  \"gadgetId\": \"6cc169f8-bc77-cb3f-c5b9-3a2a4f0ad86d\",\n  \"gadgetName\": \"Reset page\",\n  \"gadgetType\": \"dynamic-btn\",\n  \"gadgetOptions\": {\n    \"dataType\": \"single\",\n    \"displayType\": \"button\"\n  },\n  \"gadgetData\": {\n    \"title\": \"Reset page\",\n    \n    \"design\": {\n      \"color\": \"#FFFF\",\n      \"icon\": \"reload\"\n    },\n    \"action\": \"page reset\",\n    \"actionType\": \"button\",\n   \n  }\n}\n      \n      ]\n}\n\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1720,"y":1660,"wires":[["4cfd8f85.c642b"]]},{"id":"78558b37.8df614","type":"link out","z":"9921cbf1.f82328","name":"Trigger gadgets","links":["1198ab94.12521c","6dd9e005.08317","15313496.c9b06b","6adedbdb.e70694","e714ad41.62fe18","26c29dda.6daf62","cd9f1d1b.bf34","b754a57d.248d58","5978c4de.8eda9c","662d87cc.7d0548","8fdc3ee2.10182","d8796ce5.52cdd","555e4376.ac3b0c","b41c9647.e2d728"],"x":3475,"y":1580,"wires":[]},{"id":"ddcf43e4.c35d7","type":"link out","z":"9921cbf1.f82328","name":"","links":["ada94af4.e7ada8"],"x":2395,"y":1700,"wires":[]},{"id":"389c2247.4ac34e","type":"link out","z":"9921cbf1.f82328","name":"","links":["569a0a55.e796d4"],"x":2295,"y":460,"wires":[]},{"id":"cf537f9f.2c296","type":"comment","z":"9921cbf1.f82328","name":"data-card","info":"","x":220,"y":1920,"wires":[]},{"id":"f73d19ed.a29148","type":"comment","z":"9921cbf1.f82328","name":"data-card gagdet actions","info":"","x":3290,"y":1880,"wires":[]},{"id":"87d5e61.1dcad18","type":"comment","z":"9921cbf1.f82328","name":"***************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************","info":"","x":2550,"y":1820,"wires":[]},{"id":"6ecc1b23.a979f4","type":"link in","z":"9921cbf1.f82328","name":"organization global - INIT FLOW","links":["5d57bad4.0cdff4","9a050e9a.e90288","3b858951.2c8d86","febed477.696398","24cd7a58.457436"],"x":855,"y":2040,"wires":[["e55b29ea.f07798","714dd3d1.2a482c"]]},{"id":"58d3f27d.6c34fc","type":"function","z":"9921cbf1.f82328","name":"Route userAction","func":"var   MenuAction,  resetPage, gadgetAction;\nvar PostData    = msg.RevotioData.PostData;\nvar Page        = msg.RevotioData.session.Page;\n\n if (PostData.gadgetType=== \"Menu\"){\n    MenuAction = msg;\n} else  if (PostData.gadgetName=== \"Reset page\"){\n    resetPage = msg;\n} else {\n    gadgetAction = msg\n}\n\n\n\n\n\n\nreturn [ MenuAction,  resetPage, gadgetAction];","outputs":3,"noerr":0,"initialize":"","finalize":"","x":3230,"y":2020,"wires":[["574b8f54.626ba"],["ec40ce65.830ec"],["96479889.f12c98"]],"outputLabels":[" MenuAction","resetPage","gadgetAction"]},{"id":"48e23afe.b2af34","type":"debug","z":"9921cbf1.f82328","name":"data-card Gadget post","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":3220,"y":1920,"wires":[]},{"id":"e55b29ea.f07798","type":"link out","z":"9921cbf1.f82328","name":"Trigger gadgets","links":["1198ab94.12521c","6dd9e005.08317","15313496.c9b06b","6adedbdb.e70694","e714ad41.62fe18","44190308.4c3d2c","26c29dda.6daf62","cd9f1d1b.bf34","a066adb7.f58c8","5ccefbf8.0480f4","662d87cc.7d0548","254d1c18.1ab894","f0cac11.30dd44","726d7ff4.73977","9430ef91.a37d7"],"x":1235,"y":2040,"wires":[]},{"id":"7c5b7da4.481524","type":"comment","z":"9921cbf1.f82328","name":"INIT FLOW","info":"","x":820,"y":2000,"wires":[]},{"id":"714dd3d1.2a482c","type":"debug","z":"9921cbf1.f82328","name":"data-card INIT post","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":990,"y":2000,"wires":[]},{"id":"62e818e0.9a7858","type":"link in","z":"9921cbf1.f82328","name":"organization global - GadgetAction","links":["ca484bde.d6efc8","b636d429.212c48","ce07f5bf.fa7d58"],"x":3035,"y":2020,"wires":[["48e23afe.b2af34","58d3f27d.6c34fc"]]},{"id":"c5ec0bac.cda6c8","type":"link in","z":"9921cbf1.f82328","name":"organization global - design","links":["c98c548a.95f4b","ead712f3.5bdef8","352ec5bc.bce17a"],"x":815,"y":1940,"wires":[["ff070b83.892e68"]]},{"id":"d26048ea.f5b008","type":"http response","z":"9921cbf1.f82328","name":"","statusCode":"","headers":{},"x":1350,"y":1940,"wires":[]},{"id":"fe03add3.21c71","type":"function","z":"9921cbf1.f82328","name":"breadcrumbs -  design","func":"msg.topbarContanerId =  \"9e859d4a-16d7-fcf7-9c79-b828bbf1d262\"\n// msg.payload.design = {}\n\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1100,"y":1940,"wires":[["c5a9ec0f.29f93"]]},{"id":"39d2e62c.28574a","type":"comment","z":"9921cbf1.f82328","name":"DESIGN","info":"","x":820,"y":1900,"wires":[]},{"id":"44190308.4c3d2c","type":"link in","z":"9921cbf1.f82328","name":"** Gadget Name **","links":["e55b29ea.f07798"],"x":1535,"y":2000,"wires":[["9595d387.07198"]]},{"id":"3a569881.13cf58","type":"http in","z":"9921cbf1.f82328","name":"Datacard","url":"/Datacard","method":"post","upload":false,"swaggerDoc":"","x":180,"y":1980,"wires":[["1902003.905f"]]},{"id":"352ec5bc.bce17a","type":"link out","z":"9921cbf1.f82328","name":"","links":["c5ec0bac.cda6c8"],"x":455,"y":1940,"wires":[]},{"id":"24cd7a58.457436","type":"link out","z":"9921cbf1.f82328","name":"","links":["6ecc1b23.a979f4"],"x":455,"y":1980,"wires":[]},{"id":"ce07f5bf.fa7d58","type":"link out","z":"9921cbf1.f82328","name":"","links":["62e818e0.9a7858"],"x":455,"y":2020,"wires":[]},{"id":"1ed1c9e9.1794d6","type":"comment","z":"9921cbf1.f82328","name":"INIT","info":"","x":530,"y":1980,"wires":[]},{"id":"c11cd223.d3ef6","type":"comment","z":"9921cbf1.f82328","name":"DESIGN","info":"","x":540,"y":1940,"wires":[]},{"id":"ffdfdc40.2570d","type":"comment","z":"9921cbf1.f82328","name":"ROUTE","info":"","x":530,"y":2020,"wires":[]},{"id":"ff070b83.892e68","type":"subflow:39834eee.0dd5a2","z":"9921cbf1.f82328","name":"","env":[],"x":920,"y":1940,"wires":[["fe03add3.21c71"]]},{"id":"1902003.905f","type":"subflow:a55f7aee.572be","z":"9921cbf1.f82328","name":"","env":[],"x":310,"y":1980,"wires":[["352ec5bc.bce17a"],["24cd7a58.457436"],["ce07f5bf.fa7d58"]],"outputLabels":["DESIGN ","INIT","ACTION"]},{"id":"574b8f54.626ba","type":"subflow:152aab03.7a806d","z":"9921cbf1.f82328","name":"","env":[],"x":3400,"y":1960,"wires":[["c25545b8.aa7048"]]},{"id":"9595d387.07198","type":"subflow:152aab03.7a806d","z":"9921cbf1.f82328","name":"","env":[],"x":1720,"y":2000,"wires":[["d7433ee3.b1521"]]},{"id":"c5a9ec0f.29f93","type":"subflow:2ef93158.ae5276","z":"9921cbf1.f82328","name":"","env":[],"x":1240,"y":1940,"wires":[["d26048ea.f5b008"]]},{"id":"be0585dc.b51f68","type":"link out","z":"9921cbf1.f82328","name":"","links":["ada94af4.e7ada8"],"x":2395,"y":1880,"wires":[]},{"id":"a066adb7.f58c8","type":"link in","z":"9921cbf1.f82328","name":"** Gadget Name **","links":["e55b29ea.f07798","ec40ce65.830ec"],"x":1535,"y":1880,"wires":[["d1bae367.40b9a"]]},{"id":"c25545b8.aa7048","type":"link out","z":"9921cbf1.f82328","name":"","links":["ada94af4.e7ada8"],"x":3475,"y":1960,"wires":[]},{"id":"d1bae367.40b9a","type":"function","z":"9921cbf1.f82328","name":"basic","func":"\nmsg.payload = {\n    gadgetsList:[\n       {\n                  \"gadgetId\": \"c85c8da9-bda5-239f-4999-9c789e9e48d5\",\n                  \"gadgetName\": \"basic\",\n                  \"gadgetType\": \"data-card\",\n                  \"gadgetData\": {\n                    \"cardTitle\": \"Title\",\n                    \"cardType\": \"success\",\n                    \"cardContentValue\": \"cardContentValue\",\n                    \"cardBottonValue\": \"cardBottonValue\",\n                    \"cardIcon\": \"code\"\n                  },\n                  \"gadgetOptions\": {\n                    \"disabled\": false\n                  }\n                }\n      \n      \n      \n      ]\n}\n\n\n\nmsg.payload.gadgetsList.push({\n                              \"gadgetId\": \"4f378c9f-3b11-86a8-2f4f-94b694230500\",\n                              \"gadgetName\": \"basicText\",\n                              \"gadgetType\": \"wysiwyg\",\n                              \"gadgetData\": {\n                                   \"content\": JSON.stringify(msg.payload.gadgetsList[0])\n                                },\n                              \"gadgetOptions\": {\n                                \"disabled\": false,\n                                \"canEdit\": false,\n                                 \"editor\": \"froala\"\n                              }\n                            })\n                            \n                            \nmsg.payload.gadgetsList.push({\n                              \"gadgetId\": \"5e15dabf-ddbc-c1e6-7b65-cff1e60b1881\",\n                              \"gadgetName\": \"BasicTitle\",\n                              \"gadgetType\": \"divider\",\n                              \"gadgetData\": {\n                                \"borderStyle\": \"solid\",\n                                \"position\": \"left\",\n                                \"icon\": \"bookmark\",\n                                \"iconSize\": \"40\",\n                                \"background\": \"transparent\",\n                                \"title\": \"Basic\",\n                                \"textTag\": \"h2\",\n                                \"color\": \"primary\"\n                              },\n                              \"gadgetOptions\": {\n                                \"disabled\": false\n                              }\n                            } )\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1710,"y":1880,"wires":[["be0585dc.b51f68"]]},{"id":"725780b8.49e2c","type":"function","z":"9921cbf1.f82328","name":"Add to confirmation win window","func":"\nvar gadgetsList =[ {\n            \"gadgetId\":  \"1db1d21f-04ee-80fe-c48f-d5bb0d99039b\",\n            \"gadgetName\": \"actionConfirmationModal\",\n            \"gadgetType\": \"dynamic-modal\",\n            \"gadgetData\": {\"modalStatus\":\"show\"}}];\n\n  \ngadgetsList.push(\n       {\n  \"gadgetData\": {\n    \"data\": msg.data,\n    \"options\": {\"number-columns\":1}\n  },\n  \"gadgetOptions\":{\n       \"options\": {\n            \"label\": {\n              \"textWeight\": \"hairline\",\n              \"italic\": false,\n              \"size\": \"xs\"\n            },\n            \"value\": {\n              \"textWeight\": \"hairline\",\n              \"italic\": false,\n              \"size\": \"xs\"\n            }\n       }\n  },\n  \"gadgetId\": \"f37b93a0-4546-8be4-92b8-3c494fdd8f30\",\n  \"gadgetName\": \"actionConfirmationText\",\n  \"gadgetType\": \"dynamic-text-area\"\n}\n      )\n\nmsg.payload = {gadgetsList:gadgetsList};\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":3750,"y":2040,"wires":[["a0d3cb4f.e5a1d8"]]},{"id":"a0d3cb4f.e5a1d8","type":"link out","z":"9921cbf1.f82328","name":"","links":["ada94af4.e7ada8"],"x":3895,"y":2040,"wires":[]},{"id":"96479889.f12c98","type":"function","z":"9921cbf1.f82328","name":"Set msg.data","func":"var request = global.get('request');\nvar Moment = global.get('moment');\nvar MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar crypto = global.get('crypto');\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\nmsg.data  = []\n\n_.each(msg.RevotioData.PostData.gadgetData, function(value , key){\n    \n    if (typeof value === \"object\"){\n        _.each(value, function(valueValue, valueValueKey){\n            msg.data.push({\n                    \"label\": key +\".\"+valueValueKey,\n                    \"value\": valueValue\n                  })\n    \n        })\n    } else {\n        msg.data.push({\n        \"label\": key,\n        \"value\": value\n      })\n    \n    }\n    \n    \n})\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":3540,"y":2040,"wires":[["725780b8.49e2c"]]},{"id":"225e4780.50aac8","type":"link out","z":"9921cbf1.f82328","name":"","links":["ada94af4.e7ada8"],"x":2395,"y":1920,"wires":[]},{"id":"f0cac11.30dd44","type":"link in","z":"9921cbf1.f82328","name":"** Gadget Name **","links":["e55b29ea.f07798","ec40ce65.830ec"],"x":1535,"y":1920,"wires":[["8b69294c.ec3fe8"]]},{"id":"8b69294c.ec3fe8","type":"function","z":"9921cbf1.f82328","name":"tour","func":"\n\nmsg.payload = {\n    gadgetsList:[\n       {\n                  \"gadgetId\": \"fafe3cbd-9234-f0ab-cd8d-894a5c699207\",\n                  \"gadgetName\": \"tour\",\n                  \"gadgetType\": \"data-card\",\n                  \"gadgetData\": {\n                       tour:{\n                      content:\"Tour data-card, left placement\",\n                      title :\"Tour data-card, left placement\",\n                      priority:1,\n                      placement :\"left\"\n                  },\n                    \"cardTitle\": \"Tour title \",\n                    \"cardType\": \"warning\",\n                    \"cardContentValue\": \"cardContentValue\",\n                    \"cardBottonValue\": \"cardBottonValue\",\n                    \"cardIcon\": \"tour\"\n                  },\n                  \"gadgetOptions\": {\n                    \"disabled\": false\n                  }\n                }\n      \n      \n      \n      ]\n}\n\nmsg.payload.gadgetsList.push({\n                              \"gadgetId\": \"28f00379-a936-d749-22ad-df46a3c4ae50\",\n                              \"gadgetName\": \"tourText\",\n                              \"gadgetType\": \"wysiwyg\",\n                              \"gadgetData\": {\n                                \"content\": JSON.stringify(msg.payload.gadgetsList[0])\n                                },\n                              \"gadgetOptions\": {\n                                \"disabled\": false,\n                                \"canEdit\": false,\n                                 \"editor\": \"froala\"\n                              }\n                            })\nmsg.payload.gadgetsList.push(\n                               {\n                                      \"gadgetId\": \"726781e0-ce02-633c-e63d-f0b468c34c81\",\n                                      \"gadgetName\": \"manageTourState\",\n                                      \"gadgetType\": \"dynamic-btn\",\n                                        'gadgetData' :{\n                                                                  tour:{\n                      content:\"Tour state, right placement\",\n                      title :\"Tour state, right placement\",\n                      priority:2,\n                      placement :\"right\"\n                  },\n                                            switchOffLabel:\"Tour off\",\n                                            switchOnLabel:\"Off\",\n                                            title: \"Tour on\",\n                                            // options:options,\n                                            actionType:\"publisherAction\",\n                                            action:\"tour\",\n                                            design:{\n                                                icon:\"support\",\n                                                iconType:\"icon\",\n                                                size:\"large\",\n                                                switch: false,\n                                            },\n                                        },\n                                        \"gadgetOptions\": {\n                                         \"dataType\":\"single\",\n                                         \"displayType\":\"switch\"\n                                         \n                                            \n                                        },\n                                    })\nmsg.payload.gadgetsList.push({\n                             \"gadgetId\": \"69c75a1f-74fc-7a14-104d-d21ab1865faa\",\n                              \"gadgetName\": \"tourTitle\",\n                              \"gadgetType\": \"divider\",\n                              \"gadgetData\": {\n                                \"borderStyle\": \"solid\",\n                                \"position\": \"right-center\",\n                                \"icon\": \"bookmark\",\n                                \"iconSize\": \"40\",\n                                \"background\": \"transparent\",\n                                \"title\": \"Tour\",\n                                \"textTag\": \"h2\",\n                                \"color\": \"primary\"\n                              },\n                              \"gadgetOptions\": {\n                                \"disabled\": false\n                              }\n                            } ) \nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1710,"y":1920,"wires":[["225e4780.50aac8"]]},{"id":"74a3505e.17e4f","type":"link out","z":"9921cbf1.f82328","name":"","links":["ada94af4.e7ada8"],"x":2395,"y":1960,"wires":[]},{"id":"9430ef91.a37d7","type":"link in","z":"9921cbf1.f82328","name":"** Gadget Name **","links":["e55b29ea.f07798","ec40ce65.830ec"],"x":1535,"y":1960,"wires":[["4ac7e955.5d85f8"]]},{"id":"4ac7e955.5d85f8","type":"function","z":"9921cbf1.f82328","name":"resetPage","func":"msg.payload = {\n    gadgetsList:[\n      \n       {\n  \"gadgetId\": \"6cc169f8-bc77-cb3f-c5b9-3a2a4f0ad86d\",\n  \"gadgetName\": \"Reset page\",\n  \"gadgetType\": \"dynamic-btn\",\n  \"gadgetOptions\": {\n    \"dataType\": \"single\",\n    \"displayType\": \"button\"\n  },\n  \"gadgetData\": {\n    \"title\": \"Reset page\",\n    \n    \"design\": {\n      \"color\": \"#FFFF\",\n      \"icon\": \"reload\"\n    },\n    \"action\": \"page reset\",\n    \"actionType\": \"button\",\n   \n  }\n}\n      \n      ]\n}\n\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1720,"y":1960,"wires":[["74a3505e.17e4f"]]},{"id":"ec40ce65.830ec","type":"link out","z":"9921cbf1.f82328","name":"Trigger gadgets","links":["1198ab94.12521c","6dd9e005.08317","15313496.c9b06b","6adedbdb.e70694","e714ad41.62fe18","26c29dda.6daf62","cd9f1d1b.bf34","a066adb7.f58c8","5ccefbf8.0480f4","662d87cc.7d0548","254d1c18.1ab894","f0cac11.30dd44","726d7ff4.73977","9430ef91.a37d7"],"x":3475,"y":2000,"wires":[]},{"id":"d7433ee3.b1521","type":"link out","z":"9921cbf1.f82328","name":"","links":["ada94af4.e7ada8"],"x":2395,"y":2000,"wires":[]},{"id":"53b22a5e.feefc4","type":"comment","z":"9921cbf1.f82328","name":"divider","info":"","x":210,"y":2220,"wires":[]},{"id":"7e63a916.fd5508","type":"comment","z":"9921cbf1.f82328","name":"divider gagdet actions","info":"","x":2940,"y":2180,"wires":[]},{"id":"dcad03e3.1c7fb","type":"comment","z":"9921cbf1.f82328","name":"***************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************","info":"","x":2550,"y":2120,"wires":[]},{"id":"d40378ed.c70318","type":"link in","z":"9921cbf1.f82328","name":"organization global - INIT FLOW","links":["5d57bad4.0cdff4","9a050e9a.e90288","3b858951.2c8d86","febed477.696398","c0229117.e7f26"],"x":855,"y":2340,"wires":[["4a0e13.afe011ec","d83bbae3.3a6708"]]},{"id":"11179e34.62ab12","type":"function","z":"9921cbf1.f82328","name":"Route userAction","func":"var   MenuAction,  resetPage, gadgetAction;\nvar PostData    = msg.RevotioData.PostData;\nvar Page        = msg.RevotioData.session.Page;\n\n if (PostData.gadgetType=== \"Menu\"){\n    MenuAction = msg;\n} else  if (PostData.gadgetName=== \"Reset page\"){\n    resetPage = msg;\n} else {\n    gadgetAction = msg\n}\n\n\n\n\n\n\nreturn [ MenuAction,  resetPage, gadgetAction];","outputs":3,"noerr":0,"initialize":"","finalize":"","x":3210,"y":2260,"wires":[["90fc2b04.5f3118"],["828b4955.b29758"],["b6f0872e.dc9ad8"]],"outputLabels":[" MenuAction","resetPage","gadgetAction"]},{"id":"180581bb.0a064e","type":"debug","z":"9921cbf1.f82328","name":"divider Gadget post","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":3180,"y":2200,"wires":[]},{"id":"4a0e13.afe011ec","type":"link out","z":"9921cbf1.f82328","name":"Trigger gadgets","links":["1198ab94.12521c","6dd9e005.08317","15313496.c9b06b","6adedbdb.e70694","e714ad41.62fe18","8f94175e.2b7158","26c29dda.6daf62","cd9f1d1b.bf34","6badb9b2.9b85b8","37ab8877.e131a8","662d87cc.7d0548","48dffeab.b720a","19fbfda8.482412","e50ae9ee.b53698","2d921ad6.29dc56","d5bf56b2.445d18"],"x":1235,"y":2340,"wires":[]},{"id":"a9f8b163.c46d2","type":"comment","z":"9921cbf1.f82328","name":"INIT FLOW","info":"","x":820,"y":2300,"wires":[]},{"id":"d83bbae3.3a6708","type":"debug","z":"9921cbf1.f82328","name":"divider INIT post","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":980,"y":2300,"wires":[]},{"id":"4f83b27d.317e9c","type":"link in","z":"9921cbf1.f82328","name":"organization global - GadgetAction","links":["ca484bde.d6efc8","b636d429.212c48","6c749af5.fea1d4"],"x":3015,"y":2260,"wires":[["180581bb.0a064e","11179e34.62ab12"]]},{"id":"37537142.9f10ae","type":"link in","z":"9921cbf1.f82328","name":"organization global - design","links":["c98c548a.95f4b","ead712f3.5bdef8","d6e38b88.ee5da8"],"x":815,"y":2240,"wires":[["a427d608.1e5328"]]},{"id":"42467475.eacfdc","type":"http response","z":"9921cbf1.f82328","name":"","statusCode":"","headers":{},"x":1390,"y":2240,"wires":[]},{"id":"a5b0a3a1.a5877","type":"function","z":"9921cbf1.f82328","name":"breadcrumbs -  design","func":"msg.topbarContanerId =  \"9e859d4a-16d7-fcf7-9c79-b828bbf1d262\"\n// msg.payload.design = {}\n\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1100,"y":2240,"wires":[["88dad1d3.07e7f"]]},{"id":"84f926c6.9a0c58","type":"comment","z":"9921cbf1.f82328","name":"DESIGN","info":"","x":820,"y":2200,"wires":[]},{"id":"8f94175e.2b7158","type":"link in","z":"9921cbf1.f82328","name":"** Gadget Name **","links":["4a0e13.afe011ec"],"x":1555,"y":2380,"wires":[["f16eab41.52afd8"]]},{"id":"9d15352d.52ed08","type":"http in","z":"9921cbf1.f82328","name":"divider","url":"/divider","method":"post","upload":false,"swaggerDoc":"","x":190,"y":2280,"wires":[["6ed4ad3b.84ce94"]]},{"id":"d6e38b88.ee5da8","type":"link out","z":"9921cbf1.f82328","name":"","links":["37537142.9f10ae"],"x":455,"y":2240,"wires":[]},{"id":"c0229117.e7f26","type":"link out","z":"9921cbf1.f82328","name":"","links":["d40378ed.c70318"],"x":455,"y":2280,"wires":[]},{"id":"6c749af5.fea1d4","type":"link out","z":"9921cbf1.f82328","name":"","links":["4f83b27d.317e9c"],"x":455,"y":2320,"wires":[]},{"id":"17963b78.693705","type":"comment","z":"9921cbf1.f82328","name":"INIT","info":"","x":530,"y":2280,"wires":[]},{"id":"f04c6b17.6da258","type":"comment","z":"9921cbf1.f82328","name":"DESIGN","info":"","x":540,"y":2240,"wires":[]},{"id":"578ad361.4a56cc","type":"comment","z":"9921cbf1.f82328","name":"ROUTE","info":"","x":530,"y":2320,"wires":[]},{"id":"a427d608.1e5328","type":"subflow:39834eee.0dd5a2","z":"9921cbf1.f82328","name":"","env":[],"x":920,"y":2240,"wires":[["a5b0a3a1.a5877"]]},{"id":"6ed4ad3b.84ce94","type":"subflow:a55f7aee.572be","z":"9921cbf1.f82328","name":"","env":[],"x":310,"y":2280,"wires":[["d6e38b88.ee5da8"],["c0229117.e7f26"],["6c749af5.fea1d4"]],"outputLabels":["DESIGN ","INIT","ACTION"]},{"id":"90fc2b04.5f3118","type":"subflow:152aab03.7a806d","z":"9921cbf1.f82328","name":"","env":[],"x":3380,"y":2200,"wires":[["fc40095b.362128"]]},{"id":"f16eab41.52afd8","type":"subflow:152aab03.7a806d","z":"9921cbf1.f82328","name":"","env":[],"x":1740,"y":2380,"wires":[["51ef73ae.7d6f8c"]]},{"id":"88dad1d3.07e7f","type":"subflow:2ef93158.ae5276","z":"9921cbf1.f82328","name":"","env":[],"x":1240,"y":2240,"wires":[["42467475.eacfdc"]]},{"id":"3a74a888.476928","type":"link out","z":"9921cbf1.f82328","name":"","links":["ada94af4.e7ada8"],"x":2415,"y":2180,"wires":[]},{"id":"6badb9b2.9b85b8","type":"link in","z":"9921cbf1.f82328","name":"** Gadget Name **","links":["4a0e13.afe011ec","828b4955.b29758"],"x":1555,"y":2180,"wires":[["1a069b1c.bcb9d5"]]},{"id":"fc40095b.362128","type":"link out","z":"9921cbf1.f82328","name":"","links":["ada94af4.e7ada8"],"x":3455,"y":2200,"wires":[]},{"id":"1a069b1c.bcb9d5","type":"function","z":"9921cbf1.f82328","name":"basic","func":"\nvar start = new Date();\nvar end = start \n\nend.setHours(end.getHours() + 4);\n\n\nmsg.payload = {\n    gadgetsList:[\n               \n      {\n                              \"gadgetId\": \"5e15dabf-ddbc-c1e6-7b65-cff1e60b1881\",\n                              \"gadgetName\": \"BasicTitle\",\n                              \"gadgetType\": \"divider\",\n                              \"gadgetData\": {\n                                \"title\": \"Basic\",\n                              },\n                              \"gadgetOptions\": {\n                                \"disabled\": false\n                              }\n                            } ]}\n\n\nmsg.payload.gadgetsList.push({\n                              \"gadgetId\": \"4f378c9f-3b11-86a8-2f4f-94b694230500\",\n                              \"gadgetName\": \"basicText\",\n                              \"gadgetType\": \"wysiwyg\",\n                              \"gadgetData\": {\n                                   \"content\": JSON.stringify(msg.payload.gadgetsList[0])\n                                },\n                              \"gadgetOptions\": {\n                                \"disabled\": false,\n                                \"canEdit\": false,\n                                 \"editor\": \"froala\"\n                              }\n                            })\n                            \n                            \n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1730,"y":2180,"wires":[["3a74a888.476928"]]},{"id":"16217be1.b91384","type":"link out","z":"9921cbf1.f82328","name":"","links":["ada94af4.e7ada8"],"x":2415,"y":2260,"wires":[]},{"id":"37ab8877.e131a8","type":"link in","z":"9921cbf1.f82328","name":"** Gadget Name **","links":["4a0e13.afe011ec","828b4955.b29758"],"x":1555,"y":2260,"wires":[["ef19f19d.370b9"]]},{"id":"ef19f19d.370b9","type":"function","z":"9921cbf1.f82328","name":"position","func":"msg.payload = {\n    gadgetsList:[\n     \n         {\n                              \"gadgetId\": \"d0819f5f-51ba-50ef-1fee-593df855236c\",\n                              \"gadgetName\": \"positionDivider\",\n                              \"gadgetType\": \"divider\",\n                              \"gadgetData\": {\n                                \"borderStyle\": \"dashed\",\n                                \"position\": \"right-center\",\n                              \n                                \"background\": \"transparent\",\n                                \"title\": \"Position\",\n                        \n                              },\n                              \"gadgetOptions\": {\n                                \"disabled\": false\n                              }\n                            } \n      \n      ]\n}\n\n\nmsg.payload.gadgetsList.push({\n                              \"gadgetId\": \"ec81a2ae-1fd5-6873-06f6-7feb24694a7a\",\n                              \"gadgetName\": \"disabledText\",\n                              \"gadgetType\": \"wysiwyg\",\n                              \"gadgetData\": {\n                                    \"content\": JSON.stringify(msg.payload.gadgetsList[0])\n                              },\n                              \"gadgetOptions\": {\n                                \"disabled\": false,\n                                \"canEdit\": false,\n                                \"editor\": \"froala\"\n                              }\n                            })\n      \n      \n      \nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1740,"y":2260,"wires":[["16217be1.b91384"]]},{"id":"375935e0.9ee76a","type":"function","z":"9921cbf1.f82328","name":"Add to confirmation win window","func":"\nvar gadgetsList =[ {\n            \"gadgetId\":  \"1db1d21f-04ee-80fe-c48f-d5bb0d99039b\",\n            \"gadgetName\": \"actionConfirmationModal\",\n            \"gadgetType\": \"dynamic-modal\",\n            \"gadgetData\": {\"modalStatus\":\"show\"}}];\n\n  \ngadgetsList.push(\n       {\n  \"gadgetData\": {\n    \"data\": msg.data,\n    \"options\": {\"number-columns\":1}\n  },\n  \"gadgetOptions\":{\n       \"options\": {\n            \"label\": {\n              \"textWeight\": \"hairline\",\n              \"italic\": false,\n              \"size\": \"xs\"\n            },\n            \"value\": {\n              \"textWeight\": \"hairline\",\n              \"italic\": false,\n              \"size\": \"xs\"\n            }\n       }\n  },\n  \"gadgetId\": \"f37b93a0-4546-8be4-92b8-3c494fdd8f30\",\n  \"gadgetName\": \"actionConfirmationText\",\n  \"gadgetType\": \"dynamic-text-area\"\n}\n      )\n\nmsg.payload = {gadgetsList:gadgetsList};\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":3670,"y":2280,"wires":[["16e0679e.2abf78"]]},{"id":"16e0679e.2abf78","type":"link out","z":"9921cbf1.f82328","name":"","links":["ada94af4.e7ada8"],"x":3815,"y":2280,"wires":[]},{"id":"b6f0872e.dc9ad8","type":"function","z":"9921cbf1.f82328","name":"Set msg.data","func":"var request = global.get('request');\nvar Moment = global.get('moment');\nvar MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar crypto = global.get('crypto');\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\nmsg.data  = []\n\n_.each(msg.RevotioData.PostData.gadgetData, function(value , key){\n    \n    if (typeof value === \"object\"){\n        _.each(value, function(valueValue, valueValueKey){\n            msg.data.push({\n                    \"label\": key +\".\"+valueValueKey,\n                    \"value\": valueValue\n                  })\n    \n        })\n    } else {\n        msg.data.push({\n        \"label\": key,\n        \"value\": value\n      })\n    \n    }\n    \n    \n})\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":3500,"y":2280,"wires":[["375935e0.9ee76a"]]},{"id":"7cba0fb9.d8c44","type":"link out","z":"9921cbf1.f82328","name":"","links":["ada94af4.e7ada8"],"x":2415,"y":2300,"wires":[]},{"id":"19fbfda8.482412","type":"link in","z":"9921cbf1.f82328","name":"** Gadget Name **","links":["4a0e13.afe011ec","828b4955.b29758"],"x":1555,"y":2300,"wires":[["64937e04.40e9f"]]},{"id":"64937e04.40e9f","type":"function","z":"9921cbf1.f82328","name":"tour","func":"msg.payload = {\n    gadgetsList:[\n     \n          {\n                             \"gadgetId\": \"69c75a1f-74fc-7a14-104d-d21ab1865faa\",\n                              \"gadgetName\": \"tourTitle\",\n                              \"gadgetType\": \"divider\",\n                              \"gadgetData\": {\n                                tour:{\n                                      content:\"Tour state, right placement\",\n                                      title :\"Tour state, right placement\",\n                                      priority:1,\n                                      placement :\"right\"\n                                  },\n                                \"title\": \"Tour\",\n                              },\n                              \"gadgetOptions\": {\n                                \"disabled\": false\n                              }\n                            } \n      \n      ]\n}\n\n\n\nmsg.payload.gadgetsList.push({\n                              \"gadgetId\": \"28f00379-a936-d749-22ad-df46a3c4ae50\",\n                              \"gadgetName\": \"breadcrumbTourText\",\n                              \"gadgetType\": \"wysiwyg\",\n                              \"gadgetData\": {\n                                  \n                                \"content\": JSON.stringify(msg.payload.gadgetsList[0])\n                                },\n                              \"gadgetOptions\": {\n                                \"disabled\": false,\n                                \"canEdit\": false,\n                                 \"editor\": \"froala\"\n                              }\n                            })\nmsg.payload.gadgetsList.push(\n                               {\n                                      \"gadgetId\": \"726781e0-ce02-633c-e63d-f0b468c34c81\",\n                                      \"gadgetName\": \"manageTourState\",\n                                      \"gadgetType\": \"dynamic-btn\",\n                                        'gadgetData' :{\n                                             tour:{\n                      content:\"Tour state, right placement\",\n                      title :\"Tour state, right placement\",\n                      priority:2,\n                      placement :\"right\"\n                  },\n                                            switchOffLabel:\"Tour off\",\n                                            switchOnLabel:\"Off\",\n                                            title: \"Tour on\",\n                                            // options:options,\n                                            actionType:\"publisherAction\",\n                                            action:\"tour\",\n                                            design:{\n                                                icon:\"support\",\n                                                iconType:\"icon\",\n                                                size:\"large\",\n                                                switch: false,\n                                            },\n                                        },\n                                        \"gadgetOptions\": {\n                                         \"dataType\":\"single\",\n                                         \"displayType\":\"switch\"\n                                         \n                                            \n                                        },\n                                    })\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1730,"y":2300,"wires":[["7cba0fb9.d8c44"]]},{"id":"76d4be18.01317","type":"link out","z":"9921cbf1.f82328","name":"","links":["ada94af4.e7ada8"],"x":2415,"y":2220,"wires":[]},{"id":"e50ae9ee.b53698","type":"link in","z":"9921cbf1.f82328","name":"** Gadget Name **","links":["4a0e13.afe011ec","828b4955.b29758"],"x":1555,"y":2220,"wires":[["274eb24.537524e"]]},{"id":"274eb24.537524e","type":"function","z":"9921cbf1.f82328","name":"tooltip","func":"\nmsg.payload = {\n    gadgetsList:[\n               \n      {\n                             \"gadgetId\": \"1a6356ca-e51f-308d-1e63-0fc2ecbcec2f\",\n                              \"gadgetName\": \"borderStyleDivider\",\n                              \"gadgetType\": \"divider\",\n                              \"gadgetData\": {\n                                \"borderStyle\": \"dotted\",\n                                \"title\": \"borderStyle\",\n                              },\n                              \"gadgetOptions\": {\n                                \"disabled\": false\n                              }\n                            } ]}\n\n\nmsg.payload.gadgetsList.push({\n                             \"gadgetId\": \"5dfd8feb-3844-a138-679c-1825ae8fa1e2\",\n                              \"gadgetName\": \"tooltipText\",\n                              \"gadgetType\": \"wysiwyg\",\n                              \"gadgetData\": {\n                                   \"content\": JSON.stringify(msg.payload.gadgetsList[0])\n                                },\n                              \"gadgetOptions\": {\n                                \"disabled\": false,\n                                \"canEdit\": false,\n                                 \"editor\": \"froala\"\n                              }\n                            })\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1730,"y":2220,"wires":[["76d4be18.01317"]]},{"id":"454d6545.20dafc","type":"link out","z":"9921cbf1.f82328","name":"","links":["ada94af4.e7ada8"],"x":2415,"y":2340,"wires":[]},{"id":"2d921ad6.29dc56","type":"link in","z":"9921cbf1.f82328","name":"** Gadget Name **","links":["4a0e13.afe011ec","828b4955.b29758"],"x":1555,"y":2340,"wires":[["583d6db.b3b6794"]]},{"id":"583d6db.b3b6794","type":"function","z":"9921cbf1.f82328","name":"resetPage","func":"msg.payload = {\n    gadgetsList:[\n      \n       {\n  \"gadgetId\": \"6cc169f8-bc77-cb3f-c5b9-3a2a4f0ad86d\",\n  \"gadgetName\": \"Reset page\",\n  \"gadgetType\": \"dynamic-btn\",\n  \"gadgetOptions\": {\n    \"dataType\": \"single\",\n    \"displayType\": \"button\"\n  },\n  \"gadgetData\": {\n    \"title\": \"Reset page\",\n    \n    \"design\": {\n      \"color\": \"#FFFF\",\n      \"icon\": \"reload\"\n    },\n    \"action\": \"page reset\",\n    \"actionType\": \"button\",\n   \n  }\n}\n      \n      ]\n}\n\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1740,"y":2340,"wires":[["454d6545.20dafc"]]},{"id":"828b4955.b29758","type":"link out","z":"9921cbf1.f82328","name":"Trigger gadgets","links":["1198ab94.12521c","6dd9e005.08317","15313496.c9b06b","6adedbdb.e70694","e714ad41.62fe18","26c29dda.6daf62","cd9f1d1b.bf34","6badb9b2.9b85b8","37ab8877.e131a8","662d87cc.7d0548","48dffeab.b720a","19fbfda8.482412","e50ae9ee.b53698","2d921ad6.29dc56","d5bf56b2.445d18"],"x":3435,"y":2240,"wires":[]},{"id":"51ef73ae.7d6f8c","type":"link out","z":"9921cbf1.f82328","name":"","links":["ada94af4.e7ada8"],"x":2415,"y":2380,"wires":[]},{"id":"7451fc36.e00044","type":"link out","z":"9921cbf1.f82328","name":"","links":["ada94af4.e7ada8"],"x":2415,"y":2420,"wires":[]},{"id":"d5bf56b2.445d18","type":"link in","z":"9921cbf1.f82328","name":"** Gadget Name **","links":["4a0e13.afe011ec","828b4955.b29758"],"x":1555,"y":2420,"wires":[["ac0d261c.1bab88"]]},{"id":"ac0d261c.1bab88","type":"function","z":"9921cbf1.f82328","name":"design","func":"\nmsg.payload = {\n    gadgetsList:[\n               \n      {\n                              \"gadgetId\": \"4a0e983c-71d9-2af7-8301-a3712804edb5\",\n                              \"gadgetName\": \"design\",\n                              \"gadgetType\": \"divider\",\n                             \"gadgetData\": {\n                                  \"borderStyle\": \"solid\",\n                                  \"position\": \"center\",\n                                  \"icon\": \"\",\n                                  \"color\": \"success\",\n                                  \"background\": \"warning\",\n                                  \"title\": \"Design\",\n                                  \"textTag\": \"h5\"\n                                },\n                                \"gadgetOptions\": {\n                                  \"disabled\": false,\n                                  \"style\": {}\n                                }\n                              \n                            } ]}\n\n\nmsg.payload.gadgetsList.push({\n                              \"gadgetId\": \"e6c58383-a20e-c1e2-19ea-20260eb8f36a\",\n                              \"gadgetName\": \"basicText\",\n                              \"gadgetType\": \"wysiwyg\",\n                              \"gadgetData\": {\n                                   \"content\": JSON.stringify(msg.payload.gadgetsList[0])\n                                },\n                              \"gadgetOptions\": {\n                                \"disabled\": false,\n                                \"canEdit\": false,\n                                 \"editor\": \"froala\"\n                              }\n                            })\n                            \n                            \n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1730,"y":2420,"wires":[["7451fc36.e00044"]]},{"id":"c147f88c.9e6288","type":"comment","z":"9921cbf1.f82328","name":"dynamic-btn","info":"","x":230,"y":2580,"wires":[]},{"id":"21b769ff.bb0086","type":"comment","z":"9921cbf1.f82328","name":"dynamic-btn gagdet actions","info":"","x":2960,"y":2540,"wires":[]},{"id":"f3df4226.6b67","type":"comment","z":"9921cbf1.f82328","name":"***************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************","info":"","x":2550,"y":2480,"wires":[]},{"id":"fc20665c.9428a8","type":"link in","z":"9921cbf1.f82328","name":"organization global - INIT FLOW","links":["5d57bad4.0cdff4","9a050e9a.e90288","3b858951.2c8d86","febed477.696398","881da9b8.e5ab38"],"x":855,"y":2700,"wires":[["20d13e87.861f02","2efaeac9.d0a736"]]},{"id":"29c6064d.4885da","type":"function","z":"9921cbf1.f82328","name":"Route userAction","func":"var   MenuAction,  resetPage, gadgetAction;\nvar PostData    = msg.RevotioData.PostData;\nvar Page        = msg.RevotioData.session.Page;\n\n if (PostData.gadgetType=== \"Menu\"){\n    MenuAction = msg;\n} else  if (PostData.gadgetName=== \"Reset page\"){\n    resetPage = msg;\n} else {\n    gadgetAction = msg\n}\n\n\n\n\n\n\nreturn [ MenuAction,  resetPage, gadgetAction];","outputs":3,"noerr":0,"initialize":"","finalize":"","x":3210,"y":2620,"wires":[["64507fa2.18767"],["c212c8e1.b2cdc8"],["4f3c0f19.be887"]],"outputLabels":[" MenuAction","resetPage","gadgetAction"]},{"id":"4a44713f.fab33","type":"debug","z":"9921cbf1.f82328","name":"dynamic-btn Gadget post","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":3190,"y":2560,"wires":[]},{"id":"20d13e87.861f02","type":"link out","z":"9921cbf1.f82328","name":"Trigger gadgets","links":["1198ab94.12521c","6dd9e005.08317","15313496.c9b06b","6adedbdb.e70694","e714ad41.62fe18","e9e748d6.190dc8","26c29dda.6daf62","cd9f1d1b.bf34","3bccd68b.99d99a","ad167e4d.dca8","662d87cc.7d0548","48dffeab.b720a","177474ee.3cabeb","b50edab2.80c5e8","c1caa6fb.76a9b8","70edf3e.7bfb10c"],"x":1235,"y":2700,"wires":[]},{"id":"6a542002.1861d","type":"comment","z":"9921cbf1.f82328","name":"INIT FLOW","info":"","x":820,"y":2660,"wires":[]},{"id":"2efaeac9.d0a736","type":"debug","z":"9921cbf1.f82328","name":"dynamic-btn INIT post","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1000,"y":2660,"wires":[]},{"id":"e29b5b4c.88cc58","type":"link in","z":"9921cbf1.f82328","name":"organization global - GadgetAction","links":["ca484bde.d6efc8","b636d429.212c48","b9ff1b52.0fef58"],"x":3015,"y":2620,"wires":[["4a44713f.fab33","29c6064d.4885da"]]},{"id":"fcb81fe0.5782c","type":"link in","z":"9921cbf1.f82328","name":"organization global - design","links":["c98c548a.95f4b","ead712f3.5bdef8","99064d7b.ff74a"],"x":815,"y":2600,"wires":[["246960a2.19802"]]},{"id":"a2e93547.555c18","type":"http response","z":"9921cbf1.f82328","name":"","statusCode":"","headers":{},"x":1390,"y":2600,"wires":[]},{"id":"e6f1b571.5a6fe8","type":"function","z":"9921cbf1.f82328","name":"breadcrumbs -  design","func":"msg.topbarContanerId =  \"9e859d4a-16d7-fcf7-9c79-b828bbf1d262\"\n// msg.payload.design = {}\n\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1100,"y":2600,"wires":[["6809c382.972e6c"]]},{"id":"6417c640.bab0b8","type":"comment","z":"9921cbf1.f82328","name":"DESIGN","info":"","x":820,"y":2560,"wires":[]},{"id":"e9e748d6.190dc8","type":"link in","z":"9921cbf1.f82328","name":"** Gadget Name **","links":["20d13e87.861f02"],"x":1555,"y":2740,"wires":[["cca67471.160898"]]},{"id":"cd2d2a81.ee9878","type":"http in","z":"9921cbf1.f82328","name":"dynamicBtn","url":"/dynamicBtn","method":"post","upload":false,"swaggerDoc":"","x":150,"y":2640,"wires":[["90872629.4f8458"]]},{"id":"99064d7b.ff74a","type":"link out","z":"9921cbf1.f82328","name":"","links":["fcb81fe0.5782c"],"x":455,"y":2600,"wires":[]},{"id":"881da9b8.e5ab38","type":"link out","z":"9921cbf1.f82328","name":"","links":["fc20665c.9428a8"],"x":455,"y":2640,"wires":[]},{"id":"b9ff1b52.0fef58","type":"link out","z":"9921cbf1.f82328","name":"","links":["e29b5b4c.88cc58"],"x":455,"y":2680,"wires":[]},{"id":"e85417b3.8526e8","type":"comment","z":"9921cbf1.f82328","name":"INIT","info":"","x":530,"y":2640,"wires":[]},{"id":"d469af0b.b0ac5","type":"comment","z":"9921cbf1.f82328","name":"DESIGN","info":"","x":540,"y":2600,"wires":[]},{"id":"a09e0139.a6b15","type":"comment","z":"9921cbf1.f82328","name":"ROUTE","info":"","x":530,"y":2680,"wires":[]},{"id":"246960a2.19802","type":"subflow:39834eee.0dd5a2","z":"9921cbf1.f82328","name":"","env":[],"x":920,"y":2600,"wires":[["e6f1b571.5a6fe8"]]},{"id":"90872629.4f8458","type":"subflow:a55f7aee.572be","z":"9921cbf1.f82328","name":"","env":[],"x":310,"y":2640,"wires":[["99064d7b.ff74a"],["881da9b8.e5ab38"],["b9ff1b52.0fef58"]],"outputLabels":["DESIGN ","INIT","ACTION"]},{"id":"64507fa2.18767","type":"subflow:152aab03.7a806d","z":"9921cbf1.f82328","name":"","env":[],"x":3380,"y":2560,"wires":[["2ae4780f.e39e38"]]},{"id":"cca67471.160898","type":"subflow:152aab03.7a806d","z":"9921cbf1.f82328","name":"","env":[],"x":1740,"y":2740,"wires":[["a926ca31.0313b8"]]},{"id":"6809c382.972e6c","type":"subflow:2ef93158.ae5276","z":"9921cbf1.f82328","name":"","env":[],"x":1240,"y":2600,"wires":[["a2e93547.555c18"]]},{"id":"16aff964.e989b7","type":"link out","z":"9921cbf1.f82328","name":"","links":["ada94af4.e7ada8"],"x":2415,"y":2540,"wires":[]},{"id":"3bccd68b.99d99a","type":"link in","z":"9921cbf1.f82328","name":"** Gadget Name **","links":["20d13e87.861f02","c212c8e1.b2cdc8"],"x":1555,"y":2540,"wires":[["c9fdbdb1.e0399"]]},{"id":"2ae4780f.e39e38","type":"link out","z":"9921cbf1.f82328","name":"","links":["ada94af4.e7ada8"],"x":3455,"y":2560,"wires":[]},{"id":"c9fdbdb1.e0399","type":"function","z":"9921cbf1.f82328","name":"basic","func":"\nvar start = new Date();\nvar end = start \n\nend.setHours(end.getHours() + 4);\n\n\nmsg.payload = {\n    gadgetsList:[\n     \n       \n       {\n  \"gadgetId\": \"59957aa2-4058-5b4a-3f9c-8a4c147672d7\",\n  \"gadgetName\": \"basic\",\n  \"gadgetType\": \"dynamic-btn\",\n  \"gadgetOptions\": {\n    \"dataType\": \"single\",\n    \"displayType\": \"button\"\n  },\n  \"gadgetData\": {\n    \"title\": \"Basic\",\n  \"action\": {\n      btnAction:\"basic\",\n        }\n  }\n}\n      \n      \n      ]\n}\n\n\n\nmsg.payload.gadgetsList.push({\n                              \"gadgetId\": \"4f378c9f-3b11-86a8-2f4f-94b694230500\",\n                              \"gadgetName\": \"basicText\",\n                              \"gadgetType\": \"wysiwyg\",\n                              \"gadgetData\": {\n                                   \"content\": JSON.stringify(msg.payload.gadgetsList[0])\n                                },\n                              \"gadgetOptions\": {\n                                \"disabled\": false,\n                                \"canEdit\": false,\n                                 \"editor\": \"froala\"\n                              }\n                            })\n                            \n                            \nmsg.payload.gadgetsList.push({\n                              \"gadgetId\": \"5e15dabf-ddbc-c1e6-7b65-cff1e60b1881\",\n                              \"gadgetName\": \"BasicTitle\",\n                              \"gadgetType\": \"divider\",\n                              \"gadgetData\": {\n                                \"borderStyle\": \"solid\",\n                                \"position\": \"left\",\n                                \"icon\": \"bookmark\",\n                                \"iconSize\": \"40\",\n                                \"background\": \"transparent\",\n                                \"title\": \"Basic\",\n                                \"textTag\": \"h2\",\n                                \"color\": \"primary\"\n                              },\n                              \"gadgetOptions\": {\n                                \"disabled\": false\n                              }\n                            } )\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1730,"y":2540,"wires":[["16aff964.e989b7"]]},{"id":"422f5943.2bab28","type":"link out","z":"9921cbf1.f82328","name":"","links":["ada94af4.e7ada8"],"x":2415,"y":2620,"wires":[]},{"id":"ad167e4d.dca8","type":"link in","z":"9921cbf1.f82328","name":"** Gadget Name **","links":["20d13e87.861f02","c212c8e1.b2cdc8"],"x":1555,"y":2620,"wires":[["542d4376.d3fa4c"]]},{"id":"542d4376.d3fa4c","type":"function","z":"9921cbf1.f82328","name":"form","func":"msg.payload = {\n    gadgetsList:[\n     \n         \n       {\n  \"gadgetId\": \"bdd4a401-474c-01e1-5065-77559a0d8b1a\",\n  \"gadgetName\": \"form\",\n  \"gadgetType\": \"dynamic-btn\",\n  \"gadgetOptions\": {\n    \"dataType\": \"single\",\n    \"displayType\": \"button\"\n  },\n  \"gadgetData\": {\n    \"title\": \"Form\",\n    \"actionType\": \"form\",\n    \"form\": {\n      \"gadget\": {\n        \"gadgetData\": {\n          \"canceled\": false,\n          \"id\": \"mockdataFOrm10\",\n          \"nextButtonText\": \"Submit\",\n          \"showPrevious\": \"\",\n          \"submitButtonText\": \"Submit\",\n          \"title\": \"\",\n          \"organization_id\": \"\",\n          \"steps\": [\n            {\n              \"fields\": [\n                {\n                  \"htmlTag\": \"input\",\n                  \"name\": \"input2\",\n                  \"options\": {\n                    \"label\": \"Sample Input\",\n                    \"placeholder\": \"Sample Inpu\",\n                    \"required\": true,\n                    \"type\": \"text\",\n                    \"value\": \"\",\n                    \"min\": \"\",\n                    \"max\": \"\",\n                    \"preview\": \"\",\n                    \"disabled\": false,\n                    \"previewPosition\": \"\",\n                    \"info\": \"Hello info\"\n                  }\n                }\n              ]\n            }\n          ]\n        },\n       \n      },\n      \"values\": {\n        \"input2\": \"Mapped input value\"\n      }\n    },\n\n  }\n}\n      \n      \n      ]\n}\n\n\nmsg.payload.gadgetsList.push({\n                              \"gadgetId\": \"ec81a2ae-1fd5-6873-06f6-7feb24694a7a\",\n                              \"gadgetName\": \"formText\",\n                              \"gadgetType\": \"wysiwyg\",\n                              \"gadgetData\": {\n                                    \"content\": JSON.stringify(msg.payload.gadgetsList[0])\n                              },\n                              \"gadgetOptions\": {\n                                \"disabled\": false,\n                                \"canEdit\": false,\n                                \"editor\": \"froala\"\n                              }\n                            })\n      \n                                 \nmsg.payload.gadgetsList.push({\n                              \"gadgetId\": \"d0819f5f-51ba-50ef-1fee-593df855236c\",\n                              \"gadgetName\": \"formDivider\",\n                              \"gadgetType\": \"divider\",\n                              \"gadgetData\": {\n                                \"borderStyle\": \"solid\",\n                                \"position\": \"left-center\",\n                                \"icon\": \"bookmark\",\n                                \"iconSize\": \"40\",\n                                \"background\": \"transparent\",\n                                \"title\": \"Form\",\n                                \"textTag\": \"h2\",\n                                \"color\": \"primary\"\n                              },\n                              \"gadgetOptions\": {\n                                \"disabled\": false\n                              }\n                            } ) \n      \n      \nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1730,"y":2620,"wires":[["422f5943.2bab28"]]},{"id":"32448997.cd4bb6","type":"function","z":"9921cbf1.f82328","name":"Add to confirmation win window","func":"\nvar gadgetsList =[ {\n            \"gadgetId\":  \"1db1d21f-04ee-80fe-c48f-d5bb0d99039b\",\n            \"gadgetName\": \"actionConfirmationModal\",\n            \"gadgetType\": \"dynamic-modal\",\n            \"gadgetData\": {\"modalStatus\":\"show\"}}];\n\n  \ngadgetsList.push(\n       {\n  \"gadgetData\": {\n    \"data\": msg.data,\n    \"options\": {\"number-columns\":1}\n  },\n  \"gadgetOptions\":{\n       \"options\": {\n            \"label\": {\n              \"textWeight\": \"hairline\",\n              \"italic\": false,\n              \"size\": \"xs\"\n            },\n            \"value\": {\n              \"textWeight\": \"hairline\",\n              \"italic\": false,\n              \"size\": \"xs\"\n            }\n       }\n  },\n  \"gadgetId\": \"f37b93a0-4546-8be4-92b8-3c494fdd8f30\",\n  \"gadgetName\": \"actionConfirmationText\",\n  \"gadgetType\": \"dynamic-text-area\"\n}\n      )\n\nmsg.payload = {gadgetsList:gadgetsList};\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":3670,"y":2640,"wires":[["f1fe052f.3dfbd8"]]},{"id":"f1fe052f.3dfbd8","type":"link out","z":"9921cbf1.f82328","name":"","links":["ada94af4.e7ada8"],"x":3815,"y":2640,"wires":[]},{"id":"4f3c0f19.be887","type":"function","z":"9921cbf1.f82328","name":"Set msg.data","func":"var request = global.get('request');\nvar Moment = global.get('moment');\nvar MomentRange = global.get('momentrange');\nvar moment = MomentRange.extendMoment(Moment)\nvar crypto = global.get('crypto');\nvar momentTimezone = global.get('moment_timezone');\nvar lodash = global.get('lodash');\nvar _ = global.get('underscore');\nvar BSON = global.get('bson');\nvar ObjectID = BSON.ObjectID;\nvar accounting = global.get('accounting');\nvar accountingoptions = {\tsymbol : \"€\",\tdecimal : \".\", \tthousand: \" \", \tprecision : 0, \tformat: \"%s %v\"}; // example = Output = accounting.formatMoney(Number, accountingoptions );\nvar jsonwebtoken = global.get('jsonwebtoken');\nvar mongodbTools = global.get('mongodbTools');\nvar excelToJson = global.get('excelToJson');\nvar Excel = global.get('exceljs');\nvar fs = global.get('fsextra');\nvar xml2js = global.get('xml2js');\nvar json2xls = global.get('json2xls');\nvar nodemailer = global.get('nodemailer');\nvar mg = global.get('nodemailer_mailgun_transport');\n\nmsg.data  = []\n\n_.each(msg.RevotioData.PostData.gadgetData, function(value , key){\n    \n    if (typeof value === \"object\"){\n        _.each(value, function(valueValue, valueValueKey){\n            msg.data.push({\n                    \"label\": key +\".\"+valueValueKey,\n                    \"value\": valueValue\n                  })\n    \n        })\n    } else {\n        msg.data.push({\n        \"label\": key,\n        \"value\": value\n      })\n    \n    }\n    \n    \n})\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":3500,"y":2640,"wires":[["32448997.cd4bb6"]]},{"id":"2ee25b21.113a64","type":"link out","z":"9921cbf1.f82328","name":"","links":["ada94af4.e7ada8"],"x":2415,"y":2660,"wires":[]},{"id":"177474ee.3cabeb","type":"link in","z":"9921cbf1.f82328","name":"** Gadget Name **","links":["20d13e87.861f02","c212c8e1.b2cdc8"],"x":1555,"y":2660,"wires":[["a6b5633e.9feb1"]]},{"id":"a6b5633e.9feb1","type":"function","z":"9921cbf1.f82328","name":"tour","func":"msg.payload = {\n    gadgetsList:[\n     \n       {\n  \"gadgetId\": \"5fb2860b-6cef-fab5-9df4-395d70e54d03\",\n  \"gadgetName\": \"tour\",\n  \"gadgetType\": \"dynamic-btn\",\n  \"gadgetOptions\": {\n    \"dataType\": \"single\",\n    \"displayType\": \"button\"\n  },\n  \"gadgetData\": {\n      \n        title: \"Tour\",\n    \n        actionType:\"publisherAction\",\n        action:\"tour\",\n        design:{\n            icon:\"support\",\n            iconType:\"icon\",\n            size:\"large\",\n            switch: false,\n        },\n    \"tour\": {\n      \"content\": \"Body Content\",\n      \"title\": \"Tour Title\",\n      \"priority\": 1,\n      \"placement\": \"bottom\"\n    }\n  }\n}\n\n      \n      ]\n}\n\n\n\nmsg.payload.gadgetsList.push({\n                              \"gadgetId\": \"28f00379-a936-d749-22ad-df46a3c4ae50\",\n                              \"gadgetName\": \"breadcrumbTourText\",\n                              \"gadgetType\": \"wysiwyg\",\n                              \"gadgetData\": {\n                                  \n                                \"content\": JSON.stringify(msg.payload.gadgetsList[0])\n                                },\n                              \"gadgetOptions\": {\n                                \"disabled\": false,\n                                \"canEdit\": false,\n                                 \"editor\": \"froala\"\n                              }\n                            })\nmsg.payload.gadgetsList.push(\n                               {\n                                      \"gadgetId\": \"726781e0-ce02-633c-e63d-f0b468c34c81\",\n                                      \"gadgetName\": \"manageTourState\",\n                                      \"gadgetType\": \"dynamic-btn\",\n                                        'gadgetData' :{\n                                             tour:{\n                                                      content:\"Tour state, right placement\",\n                                                      title :\"Tour state, right placement\",\n                                                      priority:2,\n                                                      placement :\"right\"\n                                                  },\n                                            switchOffLabel:\"Tour off\",\n                                            switchOnLabel:\"Off\",\n                                            title: \"Tour on\",\n                                            // options:options,\n                                            actionType:\"publisherAction\",\n                                            action:\"tour\",\n                                            design:{\n                                                icon:\"support\",\n                                                iconType:\"icon\",\n                                                size:\"large\",\n                                                switch: false,\n                                            },\n                                        },\n                                        \"gadgetOptions\": {\n                                         \"dataType\":\"single\",\n                                         \"displayType\":\"switch\"\n                                         \n                                            \n                                        },\n                                    })\nmsg.payload.gadgetsList.push({\n                             \"gadgetId\": \"69c75a1f-74fc-7a14-104d-d21ab1865faa\",\n                              \"gadgetName\": \"tourTitle\",\n                              \"gadgetType\": \"divider\",\n                              \"gadgetData\": {\n                                \"borderStyle\": \"solid\",\n                                \"position\": \"right-center\",\n                                \"icon\": \"bookmark\",\n                                \"iconSize\": \"40\",\n                                \"background\": \"transparent\",\n                                \"title\": \"Tour\",\n                                \"textTag\": \"h2\",\n                                \"color\": \"primary\"\n                              },\n                              \"gadgetOptions\": {\n                                \"disabled\": false\n                              }\n                            } ) \nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1730,"y":2660,"wires":[["2ee25b21.113a64"]]},{"id":"4aa125f7.7634ac","type":"link out","z":"9921cbf1.f82328","name":"","links":["ada94af4.e7ada8"],"x":2415,"y":2580,"wires":[]},{"id":"b50edab2.80c5e8","type":"link in","z":"9921cbf1.f82328","name":"** Gadget Name **","links":["20d13e87.861f02","c212c8e1.b2cdc8"],"x":1555,"y":2580,"wires":[["820734fb.cf6148"]]},{"id":"820734fb.cf6148","type":"function","z":"9921cbf1.f82328","name":"List & list_2","func":"\n\nmsg.payload = {\n    gadgetsList:[\n     \n\n       {\n  \"gadgetId\": \"60887001-a89c-bd93-6262-38b50759c590\",\n  \"gadgetName\": \"list\",\n  \"gadgetType\": \"dynamic-btn\",\n  \"gadgetOptions\": {\n    \"dataType\": \"multiple\",\n    \"displayType\": \"button\"\n  },\n  \"gadgetData\": {\n    \"title\": \"List\",\n    \"options\": [\n      {\n        \"title\": \"Option 1\",\n        \"action\": {btnAction:\"list - Option 1\"},\n       \n        \"design\": {\n          \"icon\": \"code\"\n        }\n      },\n       {\n        \"title\": \"Option 2\",\n        \"action\": {btnAction:\"list - Option 2\"},\n       \n        \"design\": {\n          \"icon\": \"dashboard\"\n        }\n      },\n    ],\n\n  }\n} ,       {\n  \"gadgetId\": \"d1d82231-a2ff-8a45-9b12-d9d0942c2d5b\",\n  \"gadgetName\": \"list_2\",\n  \"gadgetType\": \"dynamic-btn\",\n  \"gadgetOptions\": {\n    \"dataType\": \"multiple\",\n    \"displayType\": \"button\"\n  },\n  \"gadgetData\": {\n    \"title\": \"List 2\",\n    \"options\": [\n      {\n        \"title\": \"Option 2.1 == publisherAction && switch\",\n        \"action\": {btnAction:\"list - publisherAction 2.1\"},\n       \n        \"design\": {\n          \"icon\": \"create\",\n          \"action\": \"theme\",\n          \"actionType\": \"publisherAction\",\n          \"switch\": true\n        }\n      },\n            {\n        \"title\": \"Option 2.2  switch\",\n        \"action\": {btnAction:\"list -  2.2 Switch\"},\n       \n        \"design\": {\n          \"icon\": \"create\",\n          \"action\": {btnAction:\"list - Option 2.2 switch\"},\n         \"switch\": true\n        }\n      },\n      \n                  {\n        \"title\": \"Option 2.3  colour\",\n        \"action\": {btnAction:\"list -  2.3 colour\"},\n        \"design\": {\n          \"icon\": \"create\",\n          \"action\": {btnAction:\"list - Option 2.3 colour\"},\n            color: \"warning\",\n  \n        }\n      },\n    ],\n\n  }\n}\n      \n      ]\n}\n\n\n\nmsg.payload.gadgetsList.push({\n                             \"gadgetId\": \"5dfd8feb-3844-a138-679c-1825ae8fa1e2\",\n                              \"gadgetName\": \"listText\",\n                              \"gadgetType\": \"wysiwyg\",\n                              \"gadgetData\": {\n                                   \"content\": JSON.stringify(msg.payload.gadgetsList)\n                                },\n                              \"gadgetOptions\": {\n                                \"disabled\": false,\n                                \"canEdit\": false,\n                                 \"editor\": \"froala\"\n                              }\n                            })\n                            \n                            \nmsg.payload.gadgetsList.push({\n                             \"gadgetId\": \"1a6356ca-e51f-308d-1e63-0fc2ecbcec2f\",\n                              \"gadgetName\": \"listDivider\",\n                              \"gadgetType\": \"divider\",\n                              \"gadgetData\": {\n                                \"borderStyle\": \"solid\",\n                                \"position\": \"left-center\",\n                                \"icon\": \"bookmark\",\n                                \"iconSize\": \"40\",\n                                \"background\": \"transparent\",\n                                \"title\": \"List\",\n                                \"textTag\": \"h2\",\n                                \"color\": \"primary\"\n                              },\n                              \"gadgetOptions\": {\n                                \"disabled\": false\n                              }\n                            } )\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1750,"y":2580,"wires":[["4aa125f7.7634ac"]]},{"id":"3e51f613.71b5fa","type":"link out","z":"9921cbf1.f82328","name":"","links":["ada94af4.e7ada8"],"x":2415,"y":2700,"wires":[]},{"id":"c1caa6fb.76a9b8","type":"link in","z":"9921cbf1.f82328","name":"** Gadget Name **","links":["20d13e87.861f02","c212c8e1.b2cdc8"],"x":1555,"y":2700,"wires":[["7362471a.7f6dc8"]]},{"id":"7362471a.7f6dc8","type":"function","z":"9921cbf1.f82328","name":"resetPage","func":"msg.payload = {\n    gadgetsList:[\n      \n       {\n  \"gadgetId\": \"6cc169f8-bc77-cb3f-c5b9-3a2a4f0ad86d\",\n  \"gadgetName\": \"Reset page\",\n  \"gadgetType\": \"dynamic-btn\",\n  \"gadgetOptions\": {\n    \"dataType\": \"single\",\n    \"displayType\": \"button\"\n  },\n  \"gadgetData\": {\n    \"title\": \"Reset page\",\n    \n    \"design\": {\n      \"color\": \"#FFFF\",\n      \"icon\": \"reload\"\n    },\n    \"action\": \"page reset\",\n    \"actionType\": \"button\",\n   \n  }\n}\n      \n      ]\n}\n\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1740,"y":2700,"wires":[["3e51f613.71b5fa"]]},{"id":"c212c8e1.b2cdc8","type":"link out","z":"9921cbf1.f82328","name":"Trigger gadgets","links":["1198ab94.12521c","6dd9e005.08317","15313496.c9b06b","6adedbdb.e70694","e714ad41.62fe18","26c29dda.6daf62","cd9f1d1b.bf34","3bccd68b.99d99a","ad167e4d.dca8","662d87cc.7d0548","48dffeab.b720a","177474ee.3cabeb","b50edab2.80c5e8","c1caa6fb.76a9b8","70edf3e.7bfb10c"],"x":3435,"y":2600,"wires":[]},{"id":"a926ca31.0313b8","type":"link out","z":"9921cbf1.f82328","name":"","links":["ada94af4.e7ada8"],"x":2415,"y":2740,"wires":[]},{"id":"a4f927df.422a68","type":"link out","z":"9921cbf1.f82328","name":"","links":["ada94af4.e7ada8"],"x":2415,"y":2800,"wires":[]},{"id":"70edf3e.7bfb10c","type":"link in","z":"9921cbf1.f82328","name":"** Gadget Name **","links":["20d13e87.861f02","c212c8e1.b2cdc8"],"x":1555,"y":2800,"wires":[["6bb46191.1bdcb"]]},{"id":"6bb46191.1bdcb","type":"function","z":"9921cbf1.f82328","name":"design","func":"\nvar start = new Date();\nvar end = start \n\nend.setHours(end.getHours() + 4);\n\n\nmsg.payload = {\n    gadgetsList:[\n     \n       \n\n       {\n  \"gadgetId\": \"6c79b112-2060-850e-7b5d-f66e2a7c42e2\",\n  \"gadgetName\": \"design_1\",\n  \"gadgetType\": \"dynamic-btn\",\n  \"gadgetOptions\": {\n    \"dataType\": \"single\",\n    \"displayType\": \"button\"\n  },\n  \"gadgetData\": {\n    \"title\": \"Design 1\",\n    \"design\": {\n        \"color\": \"success\",\n        \"iconType\": \"icon\",\n        \"size\":\"small\",\n        \"icon\": \"code\"\n    },\n    \"action\": {\n      \"data\": \"design\",\n      \"type\": \"userClick\"\n    },\n    \"actionType\": \"button\",\n\n  }\n},\n {\n  \"gadgetId\": \"e9ee6c46-e05f-b608-0201-44176771530a\",\n  \"gadgetName\": \"design_2\",\n  \"gadgetType\": \"dynamic-btn\",\n  \"gadgetOptions\": {\n    \"dataType\": \"single\",\n    \"displayType\": \"button\"\n  },\n  \"gadgetData\": {\n    \"title\": \"Design 2 - image\",\n    \"design\": {\n        \"color\": \"danger\",\n        \"iconType\": \"image\",\n        \"size\":\"medium\",\n        \"icon\": \"/files/logo/factory/logo.jpg\"\n    },\n    \"action\": {\n      \"data\":  \"Design 2 - image\",\n      \"type\": \"userClick\"\n    },\n    \"actionType\": \"button\",\n\n  }\n},\n {\n  \"gadgetId\": \"e9ee6c46-e05f-b608-0201-44176771530a\",\n  \"gadgetName\": \"design_3\",\n  \"gadgetType\": \"dynamic-btn\",\n  \"gadgetOptions\": {\n    \"dataType\": \"single\",\n    \"displayType\": \"button\"\n  },\n  \"gadgetData\": {\n    \"title\": \"Design 3 - color code #E2E515\",\n    \"design\": {\n        \"color\": \"#E2E515\",\n\n        \"size\":\"large\",\n     \n    },\n    \"action\": {\n      \"data\": \"Design 3 - color code #E2E515\",\n      \"type\": \"userClick\"\n    },\n    \"actionType\": \"button\",\n\n  }\n}\n      \n      \n      \n      ]\n}\n\n\n\nmsg.payload.gadgetsList.push({\n                              \"gadgetId\": \"4f378c9f-3b11-86a8-2f4f-94b694230500\",\n                              \"gadgetName\": \"basicText\",\n                              \"gadgetType\": \"wysiwyg\",\n                              \"gadgetData\": {\n                                   \"content\": JSON.stringify(msg.payload.gadgetsList[0])\n                                },\n                              \"gadgetOptions\": {\n                                \"disabled\": false,\n                                \"canEdit\": false,\n                                 \"editor\": \"froala\"\n                              }\n                            })\n                            \n                            \nmsg.payload.gadgetsList.push({\n                              \"gadgetId\": \"5e15dabf-ddbc-c1e6-7b65-cff1e60b1881\",\n                              \"gadgetName\": \"BasicTitle\",\n                              \"gadgetType\": \"divider\",\n                              \"gadgetData\": {\n                                \"borderStyle\": \"solid\",\n                                \"position\": \"left\",\n                                \"icon\": \"bookmark\",\n                                \"iconSize\": \"40\",\n                                \"background\": \"transparent\",\n                                \"title\": \"Basic\",\n                                \"textTag\": \"h2\",\n                                \"color\": \"primary\"\n                              },\n                              \"gadgetOptions\": {\n                                \"disabled\": false\n                              }\n                            } )\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1730,"y":2800,"wires":[["a4f927df.422a68"]]}]